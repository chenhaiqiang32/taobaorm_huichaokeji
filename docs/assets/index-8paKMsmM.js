var Bl=Object.defineProperty;var Ir=n=>{throw TypeError(n)};var ml=(n,e,t)=>e in n?Bl(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var O=(n,e,t)=>ml(n,typeof e!="symbol"?e+"":e,t),oi=(n,e,t)=>e.has(n)||Ir("Cannot "+t);var P=(n,e,t)=>(oi(n,e,"read from private field"),t?t.call(n):e.get(n)),Y=(n,e,t)=>e.has(n)?Ir("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),q=(n,e,t,s)=>(oi(n,e,"write to private field"),s?s.call(n,t):e.set(n,t),t),Q=(n,e,t)=>(oi(n,e,"access private method"),t);import{E as Wn,V as M,M as Wt,T as Xt,S as Lr,Q as Ws,a as N,R as ea,P as sr,b as nr,U as ut,c as j,D as gl,d as Cl,e as El,f as Dl,W as Ke,L as Ft,C as Z,g as Ln,h as Oi,N as ta,B as zt,i as _,j as Ve,k as Vt,l as sa,m as K,n as ls,o as Me,p as Be,F as Pn,q as vl,r as Hn,s as ft,t as Pr,u as bs,v as Je,w as na,x as ia,y as hs,z as Es,A as xt,G as ie,H as yl,I as bl,J as wl,K as Sl,O as Ml,X as It,Y as Ae,Z as Oe,_ as ir,$ as ct,a0 as oe,a1 as ra,a2 as Tl,a3 as Fl,a4 as xl,a5 as rr,a6 as us,a7 as or,a8 as Rn,a9 as oa,aa,ab as Il,ac as la,ad as Gn,ae as et,af as _s,ag as ws,ah as ce,ai as Ll,aj as ee,ak as ar,al as On,am as Pl,an as Hr,ao as Ni,ap as Nt,aq as Hl,ar as wn,as as ca,at as Sn,au as lr,av as Xn,aw as Rl,ax as _i,ay as ha,az as ua,aA as Ui,aB as Nn,aC as pt,aD as Gl,aE as da,aF as fa,aG as Ol,aH as Nl,aI as _l,aJ as pa,aK as Ul,aL as kl,aM as Kl,aN as Jl,aO as zl,aP as Vl,aQ as jl,aR as Xs,aS as Wl,aT as Xl,aU as Yl,aV as ql,aW as Zl,aX as Ql,aY as $l,aZ as ec,a_ as tc,a$ as sc,b0 as nc,b1 as Aa,b2 as Rr,b3 as Gr,b4 as Or,b5 as Nr,b6 as ic,b7 as rc,b8 as oc,b9 as ac,ba as Us,bb as _r,bc as Ur,bd as tn,be as lc,bf as cc,bg as hc,bh as uc,bi as sn,bj as ds,bk as nn,bl as dc,bm as Yn,bn as fc,bo as Ba,bp as pc,bq as Ac,br as Bc,bs as Pt,bt as mc,bu as gc,bv as Cc,bw as Ec,bx as Dc,by as fs,bz as vc,bA as ks,bB as yc,bC as bc,bD as rn,bE as wc,bF as ai,bG as kr,bH as Sc,bI as Mc}from"./weather-B_bFHu6y.js";import"./main-CsvnUrRN.js";import{sceneChange as Tc}from"./dataProgress-BLVwYCQV.js";var Ks=function(){var n=0,e=document.createElement("div");e.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",e.addEventListener("click",function(d){d.preventDefault(),s(++n%e.children.length)},!1);function t(d){return e.appendChild(d.dom),d}function s(d){for(var u=0;u<e.children.length;u++)e.children[u].style.display=u===d?"block":"none";n=d}var i=(performance||Date).now(),r=i,o=0,a=t(new Ks.Panel("FPS","#0ff","#002")),l=t(new Ks.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var h=t(new Ks.Panel("MB","#f08","#201"));return s(0),{REVISION:16,dom:e,addPanel:t,showPanel:s,begin:function(){i=(performance||Date).now()},end:function(){o++;var d=(performance||Date).now();if(l.update(d-i,200),d>=r+1e3&&(a.update(o*1e3/(d-r),100),r=d,o=0,h)){var u=performance.memory;h.update(u.usedJSHeapSize/1048576,u.jsHeapSizeLimit/1048576)}return d},update:function(){i=this.end()},domElement:e,setMode:s}};Ks.Panel=function(n,e,t){var s=1/0,i=0,r=Math.round,o=r(window.devicePixelRatio||1),a=80*o,l=48*o,h=3*o,d=2*o,u=3*o,c=15*o,f=74*o,p=30*o,B=document.createElement("canvas");B.width=a,B.height=l,B.style.cssText="width:80px;height:48px";var A=B.getContext("2d");return A.font="bold "+9*o+"px Helvetica,Arial,sans-serif",A.textBaseline="top",A.fillStyle=t,A.fillRect(0,0,a,l),A.fillStyle=e,A.fillText(n,h,d),A.fillRect(u,c,f,p),A.fillStyle=t,A.globalAlpha=.9,A.fillRect(u,c,f,p),{dom:B,update:function(m,g){s=Math.min(s,m),i=Math.max(i,m),A.fillStyle=t,A.globalAlpha=1,A.fillRect(0,0,a,c),A.fillStyle=e,A.fillText(r(m)+" "+n+" ("+r(s)+"-"+r(i)+")",h,d),A.drawImage(B,u+o,c,f-o,p,u,c,f-o,p),A.fillRect(u+f-o,c,o,p),A.fillStyle=t,A.globalAlpha=.9,A.fillRect(u+f-o,c,o,r((1-m/g)*p))}}};const Kr={type:"change"},li={type:"start"},Jr={type:"end"},on=new ea,zr=new sr,Fc=Math.cos(70*nr.DEG2RAD);class xc extends Wn{constructor(e,t){super(),this.object=e,this.domElement=t,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new M,this.cursor=new M,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableDolly=!0,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:Wt.ROTATE,MIDDLE:Wt.DOLLY,RIGHT:Wt.PAN},this.touches={ONE:Xt.ROTATE,TWO:Xt.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return a.phi},this.getAzimuthalAngle=function(){return a.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(v){v.addEventListener("keydown",ri),this._domElementKeyEvents=v},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",ri),this._domElementKeyEvents=null},this.saveState=function(){s.target0.copy(s.target),s.position0.copy(s.object.position),s.zoom0=s.object.zoom},this.reset=function(){s.target.copy(s.target0),s.object.position.copy(s.position0),s.object.zoom=s.zoom0,s.object.updateProjectionMatrix(),s.dispatchEvent(Kr),s.update(),r=i.NONE},this.update=function(){const v=new M,G=new Ws().setFromUnitVectors(e.up,new M(0,1,0)),J=G.clone().invert(),$=new M,Ee=new Ws,Bt=new M,Pe=2*Math.PI;return function(Al=null){const Fr=s.object.position;v.copy(Fr).sub(s.target),v.applyQuaternion(G),a.setFromVector3(v),s.autoRotate&&r===i.NONE&&T(F(Al)),s.enableDamping?(a.theta+=l.theta*s.dampingFactor,a.phi+=l.phi*s.dampingFactor):(a.theta+=l.theta,a.phi+=l.phi);let nt=s.minAzimuthAngle,it=s.maxAzimuthAngle;isFinite(nt)&&isFinite(it)&&(nt<-Math.PI?nt+=Pe:nt>Math.PI&&(nt-=Pe),it<-Math.PI?it+=Pe:it>Math.PI&&(it-=Pe),nt<=it?a.theta=Math.max(nt,Math.min(it,a.theta)):a.theta=a.theta>(nt+it)/2?Math.max(nt,a.theta):Math.min(it,a.theta)),a.phi=Math.max(s.minPolarAngle,Math.min(s.maxPolarAngle,a.phi)),a.makeSafe(),s.enableDamping===!0?s.target.addScaledVector(d,s.dampingFactor):s.target.add(d),s.target.sub(s.cursor),s.target.clampLength(s.minTargetRadius,s.maxTargetRadius),s.target.add(s.cursor);let xs=!1;if(s.zoomToCursor&&b||s.object.isOrthographicCamera)a.radius=k(a.radius);else{const rt=a.radius;a.radius=k(a.radius*h),xs=rt!=a.radius}if(v.setFromSpherical(a),v.applyQuaternion(J),Fr.copy(s.target).add(v),s.object.lookAt(s.target),s.enableDamping===!0?(l.theta*=1-s.dampingFactor,l.phi*=1-s.dampingFactor,d.multiplyScalar(1-s.dampingFactor)):(l.set(0,0,0),d.set(0,0,0)),s.zoomToCursor&&b){let rt=null;if(s.object.isPerspectiveCamera){const Is=v.length();rt=k(Is*h);const en=Is-rt;s.object.position.addScaledVector(E,en),s.object.updateMatrixWorld(),xs=!!en}else if(s.object.isOrthographicCamera){const Is=new M(D.x,D.y,0);Is.unproject(s.object);const en=s.object.zoom;s.object.zoom=Math.max(s.minZoom,Math.min(s.maxZoom,s.object.zoom/h)),s.object.updateProjectionMatrix(),xs=en!==s.object.zoom;const xr=new M(D.x,D.y,0);xr.unproject(s.object),s.object.position.sub(xr).add(Is),s.object.updateMatrixWorld(),rt=v.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),s.zoomToCursor=!1;rt!==null&&(this.screenSpacePanning?s.target.set(0,0,-1).transformDirection(s.object.matrix).multiplyScalar(rt).add(s.object.position):(on.origin.copy(s.object.position),on.direction.set(0,0,-1).transformDirection(s.object.matrix),Math.abs(s.object.up.dot(on.direction))<Fc?e.lookAt(s.target):(zr.setFromNormalAndCoplanarPoint(s.object.up,s.target),on.intersectPlane(zr,s.target))))}else if(s.object.isOrthographicCamera){const rt=s.object.zoom;s.object.zoom=Math.max(s.minZoom,Math.min(s.maxZoom,s.object.zoom/h)),rt!==s.object.zoom&&(s.object.updateProjectionMatrix(),xs=!0)}return h=1,b=!1,xs||$.distanceToSquared(s.object.position)>o||8*(1-Ee.dot(s.object.quaternion))>o||Bt.distanceToSquared(s.target)>o?(s.dispatchEvent(Kr),$.copy(s.object.position),Ee.copy(s.object.quaternion),Bt.copy(s.target),!0):!1}}(),this.dispose=function(){s.domElement.removeEventListener("contextmenu",Mr),s.domElement.removeEventListener("pointerdown",vr),s.domElement.removeEventListener("pointercancel",Fs),s.domElement.removeEventListener("wheel",yr),s.domElement.removeEventListener("pointermove",ii),s.domElement.removeEventListener("pointerup",Fs),s.domElement.getRootNode().removeEventListener("keydown",br,{capture:!0}),s._domElementKeyEvents!==null&&(s._domElementKeyEvents.removeEventListener("keydown",ri),s._domElementKeyEvents=null)};const s=this,i={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let r=i.NONE;const o=1e-6,a=new Lr,l=new Lr;let h=1;const d=new M,u=new N,c=new N,f=new N,p=new N,B=new N,A=new N,m=new N,g=new N,C=new N,E=new M,D=new N;let b=!1;const S=[],y={};let w=!1;function F(v){return v!==null?2*Math.PI/60*s.autoRotateSpeed*v:2*Math.PI/60/60*s.autoRotateSpeed}function I(v){const G=Math.abs(v*.01);return Math.pow(.95,s.zoomSpeed*G)}function T(v){l.theta-=v}function L(v){l.phi-=v}const x=function(){const v=new M;return function(J,$){v.setFromMatrixColumn($,0),v.multiplyScalar(-J),d.add(v)}}(),R=function(){const v=new M;return function(J,$){s.screenSpacePanning===!0?v.setFromMatrixColumn($,1):(v.setFromMatrixColumn($,0),v.crossVectors(s.object.up,v)),v.multiplyScalar(J),d.add(v)}}(),H=function(){const v=new M;return function(J,$){const Ee=s.domElement;if(s.object.isPerspectiveCamera){const Bt=s.object.position;v.copy(Bt).sub(s.target);let Pe=v.length();Pe*=Math.tan(s.object.fov/2*Math.PI/180),x(2*J*Pe/Ee.clientHeight,s.object.matrix),R(2*$*Pe/Ee.clientHeight,s.object.matrix)}else s.object.isOrthographicCamera?(x(J*(s.object.right-s.object.left)/s.object.zoom/Ee.clientWidth,s.object.matrix),R($*(s.object.top-s.object.bottom)/s.object.zoom/Ee.clientHeight,s.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),s.enablePan=!1)}}();function W(v){s.object.isPerspectiveCamera||s.object.isOrthographicCamera?h/=v:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),s.enableZoom=!1)}function se(v){s.object.isPerspectiveCamera||s.object.isOrthographicCamera?h*=v:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),s.enableZoom=!1)}function ae(v,G){if(!s.zoomToCursor)return;b=!0;const J=s.domElement.getBoundingClientRect(),$=v-J.left,Ee=G-J.top,Bt=J.width,Pe=J.height;D.x=$/Bt*2-1,D.y=-(Ee/Pe)*2+1,E.set(D.x,D.y,1).unproject(s.object).sub(s.object.position).normalize()}function k(v){return Math.max(s.minDistance,Math.min(s.maxDistance,v))}function Ht(v){u.set(v.clientX,v.clientY)}function Fe(v){ae(v.clientX,v.clientX),m.set(v.clientX,v.clientY)}function we(v){p.set(v.clientX,v.clientY)}function At(v){c.set(v.clientX,v.clientY),f.subVectors(c,u).multiplyScalar(s.rotateSpeed);const G=s.domElement;T(2*Math.PI*f.x/G.clientHeight),L(2*Math.PI*f.y/G.clientHeight),u.copy(c),s.update()}function Ts(v){g.set(v.clientX,v.clientY),C.subVectors(g,m),C.y>0?W(I(C.y)):C.y<0&&se(I(C.y)),m.copy(g),s.update()}function Rt(v){B.set(v.clientX,v.clientY),A.subVectors(B,p).multiplyScalar(s.panSpeed),H(A.x,A.y),p.copy(B),s.update()}function si(v){ae(v.clientX,v.clientY),v.deltaY<0?se(I(v.deltaY)):v.deltaY>0&&W(I(v.deltaY)),s.update()}function ni(v){let G=!1;switch(v.code){case s.keys.UP:v.ctrlKey||v.metaKey||v.shiftKey?L(2*Math.PI*s.rotateSpeed/s.domElement.clientHeight):H(0,s.keyPanSpeed),G=!0;break;case s.keys.BOTTOM:v.ctrlKey||v.metaKey||v.shiftKey?L(-2*Math.PI*s.rotateSpeed/s.domElement.clientHeight):H(0,-s.keyPanSpeed),G=!0;break;case s.keys.LEFT:v.ctrlKey||v.metaKey||v.shiftKey?T(2*Math.PI*s.rotateSpeed/s.domElement.clientHeight):H(s.keyPanSpeed,0),G=!0;break;case s.keys.RIGHT:v.ctrlKey||v.metaKey||v.shiftKey?T(-2*Math.PI*s.rotateSpeed/s.domElement.clientHeight):H(-s.keyPanSpeed,0),G=!0;break}G&&(v.preventDefault(),s.update())}function $s(v){if(S.length===1)u.set(v.pageX,v.pageY);else{const G=jt(v),J=.5*(v.pageX+G.x),$=.5*(v.pageY+G.y);u.set(J,$)}}function mr(v){if(S.length===1)p.set(v.pageX,v.pageY);else{const G=jt(v),J=.5*(v.pageX+G.x),$=.5*(v.pageY+G.y);p.set(J,$)}}function gr(v){const G=jt(v),J=v.pageX-G.x,$=v.pageY-G.y,Ee=Math.sqrt(J*J+$*$);m.set(0,Ee)}function il(v){s.enableZoom&&gr(v),s.enablePan&&mr(v)}function rl(v){s.enableZoom&&gr(v),s.enableRotate&&$s(v)}function Cr(v){if(S.length==1)c.set(v.pageX,v.pageY);else{const J=jt(v),$=.5*(v.pageX+J.x),Ee=.5*(v.pageY+J.y);c.set($,Ee)}f.subVectors(c,u).multiplyScalar(s.rotateSpeed);const G=s.domElement;T(2*Math.PI*f.x/G.clientHeight),L(2*Math.PI*f.y/G.clientHeight),u.copy(c)}function Er(v){if(S.length===1)B.set(v.pageX,v.pageY);else{const G=jt(v),J=.5*(v.pageX+G.x),$=.5*(v.pageY+G.y);B.set(J,$)}A.subVectors(B,p).multiplyScalar(s.panSpeed),H(A.x,A.y),p.copy(B)}function Dr(v){const G=jt(v),J=v.pageX-G.x,$=v.pageY-G.y,Ee=Math.sqrt(J*J+$*$);g.set(0,Ee),C.set(0,Math.pow(g.y/m.y,s.zoomSpeed)),W(C.y),m.copy(g);const Bt=(v.pageX+G.x)*.5,Pe=(v.pageY+G.y)*.5;ae(Bt,Pe)}function ol(v){s.enableZoom&&Dr(v),s.enablePan&&Er(v)}function al(v){s.enableZoom&&Dr(v),s.enableRotate&&Cr(v)}function vr(v){s.enabled!==!1&&(S.length===0&&(s.domElement.setPointerCapture(v.pointerId),s.domElement.addEventListener("pointermove",ii),s.domElement.addEventListener("pointerup",Fs)),!pl(v)&&(dl(v),v.pointerType==="touch"?Sr(v):ll(v)))}function ii(v){s.enabled!==!1&&(v.pointerType==="touch"?ul(v):cl(v))}function Fs(v){switch(fl(v),S.length){case 0:s.domElement.releasePointerCapture(v.pointerId),s.domElement.removeEventListener("pointermove",ii),s.domElement.removeEventListener("pointerup",Fs),s.dispatchEvent(Jr),r=i.NONE;break;case 1:const G=S[0],J=y[G];Sr({pointerId:G,pageX:J.x,pageY:J.y});break}}function ll(v){let G;switch(v.button){case 0:G=s.mouseButtons.LEFT;break;case 1:G=s.mouseButtons.MIDDLE;break;case 2:G=s.mouseButtons.RIGHT;break;default:G=-1}switch(G){case Wt.DOLLY:if(s.enableZoom===!1)return;Fe(v),r=i.DOLLY;break;case Wt.ROTATE:if(v.ctrlKey||v.metaKey||v.shiftKey){if(s.enablePan===!1)return;we(v),r=i.PAN}else{if(s.enableRotate===!1)return;Ht(v),r=i.ROTATE}break;case Wt.PAN:if(v.ctrlKey||v.metaKey||v.shiftKey){if(s.enableRotate===!1)return;Ht(v),r=i.ROTATE}else{if(s.enablePan===!1)return;we(v),r=i.PAN}break;default:r=i.NONE}r!==i.NONE&&s.dispatchEvent(li)}function cl(v){switch(r){case i.ROTATE:if(s.enableRotate===!1)return;At(v);break;case i.DOLLY:if(s.enableDolly===!1)return;Ts(v);break;case i.PAN:if(s.enablePan===!1)return;Rt(v);break}}function yr(v){s.enabled===!1||s.enableZoom===!1||r!==i.NONE||(v.preventDefault(),s.dispatchEvent(li),si(hl(v)),s.dispatchEvent(Jr))}function hl(v){const G=v.deltaMode,J={clientX:v.clientX,clientY:v.clientY,deltaY:v.deltaY};switch(G){case 1:J.deltaY*=16;break;case 2:J.deltaY*=100;break}return v.ctrlKey&&!w&&(J.deltaY*=10),J}function br(v){v.key==="Control"&&(w=!0,s.domElement.getRootNode().addEventListener("keyup",wr,{passive:!0,capture:!0}))}function wr(v){v.key==="Control"&&(w=!1,s.domElement.getRootNode().removeEventListener("keyup",wr,{passive:!0,capture:!0}))}function ri(v){s.enabled===!1||s.enablePan===!1||ni(v)}function Sr(v){switch(Tr(v),S.length){case 1:switch(s.touches.ONE){case Xt.ROTATE:if(s.enableRotate===!1)return;$s(v),r=i.TOUCH_ROTATE;break;case Xt.PAN:if(s.enablePan===!1)return;mr(v),r=i.TOUCH_PAN;break;default:r=i.NONE}break;case 2:switch(s.touches.TWO){case Xt.DOLLY_PAN:if(s.enableZoom===!1&&s.enablePan===!1)return;il(v),r=i.TOUCH_DOLLY_PAN;break;case Xt.DOLLY_ROTATE:if(s.enableZoom===!1&&s.enableRotate===!1)return;rl(v),r=i.TOUCH_DOLLY_ROTATE;break;default:r=i.NONE}break;default:r=i.NONE}r!==i.NONE&&s.dispatchEvent(li)}function ul(v){switch(Tr(v),r){case i.TOUCH_ROTATE:if(s.enableRotate===!1)return;Cr(v),s.update();break;case i.TOUCH_PAN:if(s.enablePan===!1)return;Er(v),s.update();break;case i.TOUCH_DOLLY_PAN:if(s.enableZoom===!1&&s.enablePan===!1)return;ol(v),s.update();break;case i.TOUCH_DOLLY_ROTATE:if(s.enableZoom===!1&&s.enableRotate===!1)return;al(v),s.update();break;default:r=i.NONE}}function Mr(v){s.enabled!==!1&&v.preventDefault()}function dl(v){S.push(v.pointerId)}function fl(v){delete y[v.pointerId];for(let G=0;G<S.length;G++)if(S[G]==v.pointerId){S.splice(G,1);return}}function pl(v){for(let G=0;G<S.length;G++)if(S[G]==v.pointerId)return!0;return!1}function Tr(v){let G=y[v.pointerId];G===void 0&&(G=new N,y[v.pointerId]=G),G.set(v.pageX,v.pageY)}function jt(v){const G=v.pointerId===S[0]?S[1]:S[0];return y[G]}s.domElement.addEventListener("contextmenu",Mr),s.domElement.addEventListener("pointerdown",vr),s.domElement.addEventListener("pointercancel",Fs),s.domElement.addEventListener("wheel",yr,{passive:!1}),s.domElement.getRootNode().addEventListener("keydown",br,{passive:!0,capture:!0}),this.update()}}/**
 * postprocessing v6.37.2 build Fri Mar 28 2025
 * https://github.com/pmndrs/postprocessing
 * Copyright 2015-2025 Raoul van Rüschen
 * @license Zlib
 */var ci=1/1e3,Ic=1e3,Lc=class{constructor(){this.startTime=performance.now(),this.previousTime=0,this.currentTime=0,this._delta=0,this._elapsed=0,this._fixedDelta=1e3/60,this.timescale=1,this.useFixedDelta=!1,this._autoReset=!1}get autoReset(){return this._autoReset}set autoReset(n){typeof document<"u"&&document.hidden!==void 0&&(n?document.addEventListener("visibilitychange",this):document.removeEventListener("visibilitychange",this),this._autoReset=n)}get delta(){return this._delta*ci}get fixedDelta(){return this._fixedDelta*ci}set fixedDelta(n){this._fixedDelta=n*Ic}get elapsed(){return this._elapsed*ci}update(n){this.useFixedDelta?this._delta=this.fixedDelta:(this.previousTime=this.currentTime,this.currentTime=(n!==void 0?n:performance.now())-this.startTime,this._delta=this.currentTime-this.previousTime),this._delta*=this.timescale,this._elapsed+=this._delta}reset(){this._delta=0,this._elapsed=0,this.currentTime=performance.now()-this.startTime}getDelta(){return this.delta}getElapsed(){return this.elapsed}handleEvent(n){document.hidden||(this.currentTime=performance.now()-this.startTime)}dispose(){this.autoReset=!1}},Pc=(()=>{const n=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),e=new Float32Array([0,0,2,0,0,2]),t=new xt;return t.setAttribute("position",new ie(n,3)),t.setAttribute("uv",new ie(e,2)),t})(),Le=class ki{static get fullscreenGeometry(){return Pc}constructor(e="Pass",t=new Vt,s=new sa){this.name=e,this.renderer=null,this.scene=t,this.camera=s,this.screen=null,this.rtt=!0,this.needsSwap=!0,this.needsDepthTexture=!1,this.enabled=!0}get renderToScreen(){return!this.rtt}set renderToScreen(e){if(this.rtt===e){const t=this.fullscreenMaterial;t!==null&&(t.needsUpdate=!0),this.rtt=!e}}set mainScene(e){}set mainCamera(e){}setRenderer(e){this.renderer=e}isEnabled(){return this.enabled}setEnabled(e){this.enabled=e}get fullscreenMaterial(){return this.screen!==null?this.screen.material:null}set fullscreenMaterial(e){let t=this.screen;t!==null?t.material=e:(t=new K(ki.fullscreenGeometry,e),t.frustumCulled=!1,this.scene===null&&(this.scene=new Vt),this.scene.add(t),this.screen=t)}getFullscreenMaterial(){return this.fullscreenMaterial}setFullscreenMaterial(e){this.fullscreenMaterial=e}getDepthTexture(){return null}setDepthTexture(e,t=zt){}render(e,t,s,i,r){throw new Error("Render method not implemented!")}setSize(e,t){}initialize(e,t,s){}dispose(){for(const e of Object.keys(this)){const t=this[e];(t instanceof Ke||t instanceof hs||t instanceof Es||t instanceof ki)&&this[e].dispose()}this.fullscreenMaterial!==null&&this.fullscreenMaterial.dispose()}},Hc=class extends Le{constructor(){super("ClearMaskPass",null,null),this.needsSwap=!1}render(n,e,t,s,i){const r=n.state.buffers.stencil;r.setLocked(!1),r.setTest(!1)}},Rc=`#include <common>
#include <dithering_pars_fragment>
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
uniform float opacity;varying vec2 vUv;void main(){vec4 texel=texture2D(inputBuffer,vUv);gl_FragColor=opacity*texel;
#include <colorspace_fragment>
#include <dithering_fragment>
}`,cr="varying vec2 vUv;void main(){vUv=position.xy*0.5+0.5;gl_Position=vec4(position.xy,1.0,1.0);}",ma=class extends Be{constructor(){super({name:"CopyMaterial",uniforms:{inputBuffer:new _(null),opacity:new _(1)},blending:ft,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:Rc,vertexShader:cr})}set inputBuffer(n){this.uniforms.inputBuffer.value=n}setInputBuffer(n){this.uniforms.inputBuffer.value=n}getOpacity(n){return this.uniforms.opacity.value}setOpacity(n){this.uniforms.opacity.value=n}},Gc=class extends Le{constructor(n,e=!0){super("CopyPass"),this.fullscreenMaterial=new ma,this.needsSwap=!1,this.renderTarget=n,n===void 0&&(this.renderTarget=new Ke(1,1,{minFilter:Ft,magFilter:Ft,stencilBuffer:!1,depthBuffer:!1}),this.renderTarget.texture.name="CopyPass.Target"),this.autoResize=e}get resize(){return this.autoResize}set resize(n){this.autoResize=n}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}setAutoResizeEnabled(n){this.autoResize=n}render(n,e,t,s,i){this.fullscreenMaterial.inputBuffer=e.texture,n.setRenderTarget(this.renderToScreen?null:this.renderTarget),n.render(this.scene,this.camera)}setSize(n,e){this.autoResize&&this.renderTarget.setSize(n,e)}initialize(n,e,t){t!==void 0&&(this.renderTarget.texture.type=t,t!==ut?this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1":n!==null&&n.outputColorSpace===j&&(this.renderTarget.texture.colorSpace=j))}},Vr=new Z,qn=class extends Le{constructor(n=!0,e=!0,t=!1){super("ClearPass",null,null),this.needsSwap=!1,this.color=n,this.depth=e,this.stencil=t,this.overrideClearColor=null,this.overrideClearAlpha=-1}setClearFlags(n,e,t){this.color=n,this.depth=e,this.stencil=t}getOverrideClearColor(){return this.overrideClearColor}setOverrideClearColor(n){this.overrideClearColor=n}getOverrideClearAlpha(){return this.overrideClearAlpha}setOverrideClearAlpha(n){this.overrideClearAlpha=n}render(n,e,t,s,i){const r=this.overrideClearColor,o=this.overrideClearAlpha,a=n.getClearAlpha(),l=r!==null,h=o>=0;l?(n.getClearColor(Vr),n.setClearColor(r,h?o:a)):h&&n.setClearAlpha(o),n.setRenderTarget(this.renderToScreen?null:e),n.clear(this.color,this.depth,this.stencil),l?n.setClearColor(Vr,a):h&&n.setClearAlpha(a)}},Oc=class extends Le{constructor(n,e){super("MaskPass",n,e),this.needsSwap=!1,this.clearPass=new qn(!1,!1,!0),this.inverse=!1}set mainScene(n){this.scene=n}set mainCamera(n){this.camera=n}get inverted(){return this.inverse}set inverted(n){this.inverse=n}get clear(){return this.clearPass.enabled}set clear(n){this.clearPass.enabled=n}getClearPass(){return this.clearPass}isInverted(){return this.inverted}setInverted(n){this.inverted=n}render(n,e,t,s,i){const r=n.getContext(),o=n.state.buffers,a=this.scene,l=this.camera,h=this.clearPass,d=this.inverted?0:1,u=1-d;o.color.setMask(!1),o.depth.setMask(!1),o.color.setLocked(!0),o.depth.setLocked(!0),o.stencil.setTest(!0),o.stencil.setOp(r.REPLACE,r.REPLACE,r.REPLACE),o.stencil.setFunc(r.ALWAYS,d,4294967295),o.stencil.setClear(u),o.stencil.setLocked(!0),this.clearPass.enabled&&(this.renderToScreen?h.render(n,null):(h.render(n,e),h.render(n,t))),this.renderToScreen?(n.setRenderTarget(null),n.render(a,l)):(n.setRenderTarget(e),n.render(a,l),n.setRenderTarget(t),n.render(a,l)),o.color.setLocked(!1),o.depth.setLocked(!1),o.stencil.setLocked(!1),o.stencil.setFunc(r.EQUAL,1,4294967295),o.stencil.setOp(r.KEEP,r.KEEP,r.KEEP),o.stencil.setLocked(!0)}},Nc=class{constructor(n=null,{depthBuffer:e=!0,stencilBuffer:t=!1,multisampling:s=0,frameBufferType:i}={}){this.renderer=null,this.inputBuffer=this.createBuffer(e,t,i,s),this.outputBuffer=this.inputBuffer.clone(),this.copyPass=new Gc,this.depthTexture=null,this.passes=[],this.timer=new Lc,this.autoRenderToScreen=!0,this.setRenderer(n)}get multisampling(){return this.inputBuffer.samples||0}set multisampling(n){const e=this.inputBuffer,t=this.multisampling;t>0&&n>0?(this.inputBuffer.samples=n,this.outputBuffer.samples=n,this.inputBuffer.dispose(),this.outputBuffer.dispose()):t!==n&&(this.inputBuffer.dispose(),this.outputBuffer.dispose(),this.inputBuffer=this.createBuffer(e.depthBuffer,e.stencilBuffer,e.texture.type,n),this.inputBuffer.depthTexture=this.depthTexture,this.outputBuffer=this.inputBuffer.clone())}getTimer(){return this.timer}getRenderer(){return this.renderer}setRenderer(n){if(this.renderer=n,n!==null){const e=n.getSize(new N),t=n.getContext().getContextAttributes().alpha,s=this.inputBuffer.texture.type;s===ut&&n.outputColorSpace===j&&(this.inputBuffer.texture.colorSpace=j,this.outputBuffer.texture.colorSpace=j,this.inputBuffer.dispose(),this.outputBuffer.dispose()),n.autoClear=!1,this.setSize(e.width,e.height);for(const i of this.passes)i.initialize(n,t,s)}}replaceRenderer(n,e=!0){const t=this.renderer,s=t.domElement.parentNode;return this.setRenderer(n),e&&s!==null&&(s.removeChild(t.domElement),s.appendChild(n.domElement)),t}createDepthTexture(){const n=this.depthTexture=new gl;return this.inputBuffer.depthTexture=n,this.inputBuffer.dispose(),this.inputBuffer.stencilBuffer?(n.format=Cl,n.type=El):n.type=Dl,n}deleteDepthTexture(){if(this.depthTexture!==null){this.depthTexture.dispose(),this.depthTexture=null,this.inputBuffer.depthTexture=null,this.inputBuffer.dispose();for(const n of this.passes)n.setDepthTexture(null)}}createBuffer(n,e,t,s){const i=this.renderer,r=i===null?new N:i.getDrawingBufferSize(new N),o={minFilter:Ft,magFilter:Ft,stencilBuffer:e,depthBuffer:n,type:t},a=new Ke(r.width,r.height,o);return s>0&&(a.ignoreDepthForMultisampleCopy=!1,a.samples=s),t===ut&&i!==null&&i.outputColorSpace===j&&(a.texture.colorSpace=j),a.texture.name="EffectComposer.Buffer",a.texture.generateMipmaps=!1,a}setMainScene(n){for(const e of this.passes)e.mainScene=n}setMainCamera(n){for(const e of this.passes)e.mainCamera=n}addPass(n,e){const t=this.passes,s=this.renderer,i=s.getDrawingBufferSize(new N),r=s.getContext().getContextAttributes().alpha,o=this.inputBuffer.texture.type;if(n.setRenderer(s),n.setSize(i.width,i.height),n.initialize(s,r,o),this.autoRenderToScreen&&(t.length>0&&(t[t.length-1].renderToScreen=!1),n.renderToScreen&&(this.autoRenderToScreen=!1)),e!==void 0?t.splice(e,0,n):t.push(n),this.autoRenderToScreen&&(t[t.length-1].renderToScreen=!0),n.needsDepthTexture||this.depthTexture!==null)if(this.depthTexture===null){const a=this.createDepthTexture();for(n of t)n.setDepthTexture(a)}else n.setDepthTexture(this.depthTexture)}removePass(n){const e=this.passes,t=e.indexOf(n);if(t!==-1&&e.splice(t,1).length>0){if(this.depthTexture!==null){const r=(a,l)=>a||l.needsDepthTexture;e.reduce(r,!1)||(n.getDepthTexture()===this.depthTexture&&n.setDepthTexture(null),this.deleteDepthTexture())}this.autoRenderToScreen&&t===e.length&&(n.renderToScreen=!1,e.length>0&&(e[e.length-1].renderToScreen=!0))}}removeAllPasses(){const n=this.passes;this.deleteDepthTexture(),n.length>0&&(this.autoRenderToScreen&&(n[n.length-1].renderToScreen=!1),this.passes=[])}render(n){const e=this.renderer,t=this.copyPass;let s=this.inputBuffer,i=this.outputBuffer,r=!1,o,a,l;n===void 0&&(this.timer.update(),n=this.timer.getDelta());for(const h of this.passes)h.enabled&&(h.render(e,s,i,n,r),h.needsSwap&&(r&&(t.renderToScreen=h.renderToScreen,o=e.getContext(),a=e.state.buffers.stencil,a.setFunc(o.NOTEQUAL,1,4294967295),t.render(e,s,i,n,r),a.setFunc(o.EQUAL,1,4294967295)),l=s,s=i,i=l),h instanceof Oc?r=!0:h instanceof Hc&&(r=!1))}setSize(n,e,t){const s=this.renderer,i=s.getSize(new N);(n===void 0||e===void 0)&&(n=i.width,e=i.height),(i.width!==n||i.height!==e)&&s.setSize(n,e,t);const r=s.getDrawingBufferSize(new N);this.inputBuffer.setSize(r.width,r.height),this.outputBuffer.setSize(r.width,r.height);for(const o of this.passes)o.setSize(r.width,r.height)}reset(){this.dispose(),this.autoRenderToScreen=!0}dispose(){for(const n of this.passes)n.dispose();this.passes=[],this.inputBuffer!==null&&this.inputBuffer.dispose(),this.outputBuffer!==null&&this.outputBuffer.dispose(),this.deleteDepthTexture(),this.copyPass.dispose(),this.timer.dispose(),Le.fullscreenGeometry.dispose()}},Tt={NONE:0,DEPTH:1,CONVOLUTION:2},X={FRAGMENT_HEAD:"FRAGMENT_HEAD",FRAGMENT_MAIN_UV:"FRAGMENT_MAIN_UV",FRAGMENT_MAIN_IMAGE:"FRAGMENT_MAIN_IMAGE",VERTEX_HEAD:"VERTEX_HEAD",VERTEX_MAIN_SUPPORT:"VERTEX_MAIN_SUPPORT"},_c=class{constructor(){this.shaderParts=new Map([[X.FRAGMENT_HEAD,null],[X.FRAGMENT_MAIN_UV,null],[X.FRAGMENT_MAIN_IMAGE,null],[X.VERTEX_HEAD,null],[X.VERTEX_MAIN_SUPPORT,null]]),this.defines=new Map,this.uniforms=new Map,this.blendModes=new Map,this.extensions=new Set,this.attributes=Tt.NONE,this.varyings=new Set,this.uvTransformation=!1,this.readDepth=!1,this.colorSpace=Je}},hi=!1,jr=class{constructor(n=null){this.originalMaterials=new Map,this.material=null,this.materials=null,this.materialsBackSide=null,this.materialsDoubleSide=null,this.materialsFlatShaded=null,this.materialsFlatShadedBackSide=null,this.materialsFlatShadedDoubleSide=null,this.setMaterial(n),this.meshCount=0,this.replaceMaterial=e=>{if(e.isMesh){let t;if(e.material.flatShading)switch(e.material.side){case Me:t=this.materialsFlatShadedDoubleSide;break;case ls:t=this.materialsFlatShadedBackSide;break;default:t=this.materialsFlatShaded;break}else switch(e.material.side){case Me:t=this.materialsDoubleSide;break;case ls:t=this.materialsBackSide;break;default:t=this.materials;break}this.originalMaterials.set(e,e.material),e.isSkinnedMesh?e.material=t[2]:e.isInstancedMesh?e.material=t[1]:e.material=t[0],++this.meshCount}}}cloneMaterial(n){if(!(n instanceof Be))return n.clone();const e=n.uniforms,t=new Map;for(const i in e){const r=e[i].value;r.isRenderTargetTexture&&(e[i].value=null,t.set(i,r))}const s=n.clone();for(const i of t)e[i[0]].value=i[1],s.uniforms[i[0]].value=i[1];return s}setMaterial(n){if(this.disposeMaterials(),this.material=n,n!==null){const e=this.materials=[this.cloneMaterial(n),this.cloneMaterial(n),this.cloneMaterial(n)];for(const t of e)t.uniforms=Object.assign({},n.uniforms),t.side=Pn;e[2].skinning=!0,this.materialsBackSide=e.map(t=>{const s=this.cloneMaterial(t);return s.uniforms=Object.assign({},n.uniforms),s.side=ls,s}),this.materialsDoubleSide=e.map(t=>{const s=this.cloneMaterial(t);return s.uniforms=Object.assign({},n.uniforms),s.side=Me,s}),this.materialsFlatShaded=e.map(t=>{const s=this.cloneMaterial(t);return s.uniforms=Object.assign({},n.uniforms),s.flatShading=!0,s}),this.materialsFlatShadedBackSide=e.map(t=>{const s=this.cloneMaterial(t);return s.uniforms=Object.assign({},n.uniforms),s.flatShading=!0,s.side=ls,s}),this.materialsFlatShadedDoubleSide=e.map(t=>{const s=this.cloneMaterial(t);return s.uniforms=Object.assign({},n.uniforms),s.flatShading=!0,s.side=Me,s})}}render(n,e,t){const s=n.shadowMap.enabled;if(n.shadowMap.enabled=!1,hi){const i=this.originalMaterials;this.meshCount=0,e.traverse(this.replaceMaterial),n.render(e,t);for(const r of i)r[0].material=r[1];this.meshCount!==i.size&&i.clear()}else{const i=e.overrideMaterial;e.overrideMaterial=this.material,n.render(e,t),e.overrideMaterial=i}n.shadowMap.enabled=s}disposeMaterials(){if(this.material!==null){const n=this.materials.concat(this.materialsBackSide).concat(this.materialsDoubleSide).concat(this.materialsFlatShaded).concat(this.materialsFlatShadedBackSide).concat(this.materialsFlatShadedDoubleSide);for(const e of n)e.dispose()}}dispose(){this.originalMaterials.clear(),this.disposeMaterials()}static get workaroundEnabled(){return hi}static set workaroundEnabled(n){hi=n}},mt=-1,ye=class extends Wn{constructor(n,e=mt,t=mt,s=1){super(),this.resizable=n,this.baseSize=new N(1,1),this.preferredSize=new N(e,t),this.target=this.preferredSize,this.s=s,this.effectiveSize=new N,this.addEventListener("change",()=>this.updateEffectiveSize()),this.updateEffectiveSize()}updateEffectiveSize(){const n=this.baseSize,e=this.preferredSize,t=this.effectiveSize,s=this.scale;e.width!==mt?t.width=e.width:e.height!==mt?t.width=Math.round(e.height*(n.width/Math.max(n.height,1))):t.width=Math.round(n.width*s),e.height!==mt?t.height=e.height:e.width!==mt?t.height=Math.round(e.width/Math.max(n.width/Math.max(n.height,1),1)):t.height=Math.round(n.height*s)}get width(){return this.effectiveSize.width}set width(n){this.preferredWidth=n}get height(){return this.effectiveSize.height}set height(n){this.preferredHeight=n}getWidth(){return this.width}getHeight(){return this.height}get scale(){return this.s}set scale(n){this.s!==n&&(this.s=n,this.preferredSize.setScalar(mt),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getScale(){return this.scale}setScale(n){this.scale=n}get baseWidth(){return this.baseSize.width}set baseWidth(n){this.baseSize.width!==n&&(this.baseSize.width=n,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getBaseWidth(){return this.baseWidth}setBaseWidth(n){this.baseWidth=n}get baseHeight(){return this.baseSize.height}set baseHeight(n){this.baseSize.height!==n&&(this.baseSize.height=n,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getBaseHeight(){return this.baseHeight}setBaseHeight(n){this.baseHeight=n}setBaseSize(n,e){(this.baseSize.width!==n||this.baseSize.height!==e)&&(this.baseSize.set(n,e),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}get preferredWidth(){return this.preferredSize.width}set preferredWidth(n){this.preferredSize.width!==n&&(this.preferredSize.width=n,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getPreferredWidth(){return this.preferredWidth}setPreferredWidth(n){this.preferredWidth=n}get preferredHeight(){return this.preferredSize.height}set preferredHeight(n){this.preferredSize.height!==n&&(this.preferredSize.height=n,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getPreferredHeight(){return this.preferredHeight}setPreferredHeight(n){this.preferredHeight=n}setPreferredSize(n,e){(this.preferredSize.width!==n||this.preferredSize.height!==e)&&(this.preferredSize.set(n,e),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}copy(n){this.s=n.scale,this.baseSize.set(n.baseWidth,n.baseHeight),this.preferredSize.set(n.preferredWidth,n.preferredHeight),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height)}static get AUTO_SIZE(){return mt}},Uc=class{constructor(n=0){this.nextId=n}getNextId(){return this.nextId++}reset(n=0){return this.nextId=n,this}},ui=new Uc(2),ga=class extends Set{constructor(n,e=ui.getNextId()){super(),this.exclusive=!1,this._layer=e,(this._layer<1||this._layer>31)&&(console.warn("Layer out of range, resetting to 2"),ui.reset(2),this._layer=ui.getNextId()),n!==void 0&&this.set(n)}get layer(){return this._layer}set layer(n){const e=this._layer;for(const t of this)t.layers.disable(e),t.layers.enable(n);this._layer=n}getLayer(){return this.layer}setLayer(n){this.layer=n}isExclusive(){return this.exclusive}setExclusive(n){this.exclusive=n}clear(){const n=this.layer;for(const e of this)e.layers.disable(n);return super.clear()}set(n){this.clear();for(const e of n)this.add(e);return this}indexOf(n){return this.has(n)?0:-1}add(n){return this.exclusive?n.layers.set(this.layer):n.layers.enable(this.layer),super.add(n)}delete(n){return this.has(n)&&n.layers.disable(this.layer),super.delete(n)}toggle(n){let e;return this.has(n)?(this.delete(n),e=!1):(this.add(n),e=!0),e}setVisible(n){for(const e of this)n?e.layers.enable(0):e.layers.disable(0);return this}},U={ADD:0,ALPHA:1,AVERAGE:2,COLOR:3,COLOR_BURN:4,COLOR_DODGE:5,DARKEN:6,DIFFERENCE:7,DIVIDE:8,DST:9,EXCLUSION:10,HARD_LIGHT:11,HARD_MIX:12,HUE:13,INVERT:14,INVERT_RGB:15,LIGHTEN:16,LINEAR_BURN:17,LINEAR_DODGE:18,LINEAR_LIGHT:19,LUMINOSITY:20,MULTIPLY:21,NEGATION:22,NORMAL:23,OVERLAY:24,PIN_LIGHT:25,REFLECT:26,SATURATION:27,SCREEN:28,SOFT_LIGHT:29,SRC:30,SUBTRACT:31,VIVID_LIGHT:32},kc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,x+y,opacity);}",Kc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,y,min(y.a,opacity));}",Jc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,(x+y)*0.5,opacity);}",zc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(yHSL.rg,xHSL.b));return vec4(mix(x.rgb,z,opacity),y.a);}",Vc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=mix(step(0.0,y)*(1.0-min(vec4(1.0),(1.0-x)/y)),vec4(1.0),step(1.0,x));return mix(x,z,opacity);}",jc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=step(0.0,x)*mix(min(vec4(1.0),x/max(1.0-y,1e-9)),vec4(1.0),step(1.0,y));return mix(x,z,opacity);}",Wc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,min(x,y),opacity);}",Xc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,abs(x-y),opacity);}",Yc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,x/max(y,1e-12),opacity);}",qc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,(x+y-2.0*x*y),opacity);}",Zc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 a=min(x,1.0),b=min(y,1.0);vec4 z=mix(2.0*a*b,1.0-2.0*(1.0-a)*(1.0-b),step(0.5,y));return mix(x,z,opacity);}",Qc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,step(1.0,x+y),opacity);}",$c="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(yHSL.r,xHSL.gb));return vec4(mix(x.rgb,z,opacity),y.a);}",eh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,1.0-y,opacity);}",th="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,y*(1.0-x),opacity);}",sh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,max(x,y),opacity);}",nh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,clamp(y+x-1.0,0.0,1.0),opacity);}",ih="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,min(x+y,1.0),opacity);}",rh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,clamp(2.0*y+x-1.0,0.0,1.0),opacity);}",oh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(xHSL.rg,yHSL.b));return vec4(mix(x.rgb,z,opacity),y.a);}",ah="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,x*y,opacity);}",lh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,1.0-abs(1.0-x-y),opacity);}",ch="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,y,opacity);}",hh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=mix(2.0*y*x,1.0-2.0*(1.0-y)*(1.0-x),step(0.5,x));return mix(x,z,opacity);}",uh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 y2=2.0*y;vec4 z=mix(mix(y2,x,step(0.5*x,y)),max(vec4(0.0),y2-1.0),step(x,(y2-1.0)));return mix(x,z,opacity);}",dh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=mix(min(x*x/max(1.0-y,1e-12),1.0),y,step(1.0,y));return mix(x,z,opacity);}",fh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(xHSL.r,yHSL.g,xHSL.b));return vec4(mix(x.rgb,z,opacity),y.a);}",ph="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,x+y-min(x*y,1.0),opacity);}",Ah="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 y2=2.0*y;vec4 w=step(0.5,y);vec4 z=mix(x-(1.0-y2)*x*(1.0-x),mix(x+(y2-1.0)*(sqrt(x)-x),x+(y2-1.0)*x*((16.0*x-12.0)*x+3.0),w*(1.0-step(0.25,x))),w);return mix(x,z,opacity);}",Bh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return y;}",mh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,max(x+y-1.0,0.0),opacity);}",gh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=mix(max(1.0-min((1.0-x)/(2.0*y),1.0),0.0),min(x/(2.0*(1.0-y)),1.0),step(0.5,y));return mix(x,z,opacity);}",Ch=new Map([[U.ADD,kc],[U.ALPHA,Kc],[U.AVERAGE,Jc],[U.COLOR,zc],[U.COLOR_BURN,Vc],[U.COLOR_DODGE,jc],[U.DARKEN,Wc],[U.DIFFERENCE,Xc],[U.DIVIDE,Yc],[U.DST,null],[U.EXCLUSION,qc],[U.HARD_LIGHT,Zc],[U.HARD_MIX,Qc],[U.HUE,$c],[U.INVERT,eh],[U.INVERT_RGB,th],[U.LIGHTEN,sh],[U.LINEAR_BURN,nh],[U.LINEAR_DODGE,ih],[U.LINEAR_LIGHT,rh],[U.LUMINOSITY,oh],[U.MULTIPLY,ah],[U.NEGATION,lh],[U.NORMAL,ch],[U.OVERLAY,hh],[U.PIN_LIGHT,uh],[U.REFLECT,dh],[U.SATURATION,fh],[U.SCREEN,ph],[U.SOFT_LIGHT,Ah],[U.SRC,Bh],[U.SUBTRACT,mh],[U.VIVID_LIGHT,gh]]),Eh=class extends Wn{constructor(n,e=1){super(),this._blendFunction=n,this.opacity=new _(e)}getOpacity(){return this.opacity.value}setOpacity(n){this.opacity.value=n}get blendFunction(){return this._blendFunction}set blendFunction(n){this._blendFunction=n,this.dispatchEvent({type:"change"})}getBlendFunction(){return this.blendFunction}setBlendFunction(n){this.blendFunction=n}getShaderCode(){return Ch.get(this.blendFunction)}},Zn=class extends Wn{constructor(n,e,{attributes:t=Tt.NONE,blendFunction:s=U.NORMAL,defines:i=new Map,uniforms:r=new Map,extensions:o=null,vertexShader:a=null}={}){super(),this.name=n,this.renderer=null,this.attributes=t,this.fragmentShader=e,this.vertexShader=a,this.defines=i,this.uniforms=r,this.extensions=o,this.blendMode=new Eh(s),this.blendMode.addEventListener("change",l=>this.setChanged()),this._inputColorSpace=Je,this._outputColorSpace=na}get inputColorSpace(){return this._inputColorSpace}set inputColorSpace(n){this._inputColorSpace=n,this.setChanged()}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(n){this._outputColorSpace=n,this.setChanged()}set mainScene(n){}set mainCamera(n){}getName(){return this.name}setRenderer(n){this.renderer=n}getDefines(){return this.defines}getUniforms(){return this.uniforms}getExtensions(){return this.extensions}getBlendMode(){return this.blendMode}getAttributes(){return this.attributes}setAttributes(n){this.attributes=n,this.setChanged()}getFragmentShader(){return this.fragmentShader}setFragmentShader(n){this.fragmentShader=n,this.setChanged()}getVertexShader(){return this.vertexShader}setVertexShader(n){this.vertexShader=n,this.setChanged()}setChanged(){this.dispatchEvent({type:"change"})}setDepthTexture(n,e=zt){}update(n,e,t){}setSize(n,e){}initialize(n,e,t){}dispose(){for(const n of Object.keys(this)){const e=this[n];(e instanceof Ke||e instanceof hs||e instanceof Es||e instanceof Le)&&this[n].dispose()}}},Qn={VERY_SMALL:0,MEDIUM:2,LARGE:3},Dh=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec4 sum=texture2D(inputBuffer,vUv0);sum+=texture2D(inputBuffer,vUv1);sum+=texture2D(inputBuffer,vUv2);sum+=texture2D(inputBuffer,vUv3);gl_FragColor=sum*0.25;
#include <colorspace_fragment>
}`,vh="uniform vec4 texelSize;uniform float kernel;uniform float scale;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vec2 dUv=(texelSize.xy*vec2(kernel)+texelSize.zw)*scale;vUv0=vec2(uv.x-dUv.x,uv.y+dUv.y);vUv1=vec2(uv.x+dUv.x,uv.y+dUv.y);vUv2=vec2(uv.x+dUv.x,uv.y-dUv.y);vUv3=vec2(uv.x-dUv.x,uv.y-dUv.y);gl_Position=vec4(position.xy,1.0,1.0);}",yh=[new Float32Array([0,0]),new Float32Array([0,1,1]),new Float32Array([0,1,1,2]),new Float32Array([0,1,2,2,3]),new Float32Array([0,1,2,3,4,4,5]),new Float32Array([0,1,2,3,4,5,7,8,9,10])],bh=class extends Be{constructor(n=new It){super({name:"KawaseBlurMaterial",uniforms:{inputBuffer:new _(null),texelSize:new _(new It),scale:new _(1),kernel:new _(0)},blending:ft,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:Dh,vertexShader:vh}),this.setTexelSize(n.x,n.y),this.kernelSize=Qn.MEDIUM}set inputBuffer(n){this.uniforms.inputBuffer.value=n}setInputBuffer(n){this.inputBuffer=n}get kernelSequence(){return yh[this.kernelSize]}get scale(){return this.uniforms.scale.value}set scale(n){this.uniforms.scale.value=n}getScale(){return this.uniforms.scale.value}setScale(n){this.uniforms.scale.value=n}getKernel(){return null}get kernel(){return this.uniforms.kernel.value}set kernel(n){this.uniforms.kernel.value=n}setKernel(n){this.kernel=n}setTexelSize(n,e){this.uniforms.texelSize.value.set(n,e,n*.5,e*.5)}setSize(n,e){const t=1/n,s=1/e;this.uniforms.texelSize.value.set(t,s,t*.5,s*.5)}},Ca=class extends Le{constructor({kernelSize:n=Qn.MEDIUM,resolutionScale:e=.5,width:t=ye.AUTO_SIZE,height:s=ye.AUTO_SIZE,resolutionX:i=t,resolutionY:r=s}={}){super("KawaseBlurPass"),this.renderTargetA=new Ke(1,1,{depthBuffer:!1}),this.renderTargetA.texture.name="Blur.Target.A",this.renderTargetB=this.renderTargetA.clone(),this.renderTargetB.texture.name="Blur.Target.B";const o=this.resolution=new ye(this,i,r,e);o.addEventListener("change",a=>this.setSize(o.baseWidth,o.baseHeight)),this._blurMaterial=new bh,this._blurMaterial.kernelSize=n,this.copyMaterial=new ma}getResolution(){return this.resolution}get blurMaterial(){return this._blurMaterial}set blurMaterial(n){this._blurMaterial=n}get dithering(){return this.copyMaterial.dithering}set dithering(n){this.copyMaterial.dithering=n}get kernelSize(){return this.blurMaterial.kernelSize}set kernelSize(n){this.blurMaterial.kernelSize=n}get width(){return this.resolution.width}set width(n){this.resolution.preferredWidth=n}get height(){return this.resolution.height}set height(n){this.resolution.preferredHeight=n}get scale(){return this.blurMaterial.scale}set scale(n){this.blurMaterial.scale=n}getScale(){return this.blurMaterial.scale}setScale(n){this.blurMaterial.scale=n}getKernelSize(){return this.kernelSize}setKernelSize(n){this.kernelSize=n}getResolutionScale(){return this.resolution.scale}setResolutionScale(n){this.resolution.scale=n}render(n,e,t,s,i){const r=this.scene,o=this.camera,a=this.renderTargetA,l=this.renderTargetB,h=this.blurMaterial,d=h.kernelSequence;let u=e;this.fullscreenMaterial=h;for(let c=0,f=d.length;c<f;++c){const p=c&1?l:a;h.kernel=d[c],h.inputBuffer=u.texture,n.setRenderTarget(p),n.render(r,o),u=p}this.fullscreenMaterial=this.copyMaterial,this.copyMaterial.inputBuffer=u.texture,n.setRenderTarget(this.renderToScreen?null:t),n.render(r,o)}setSize(n,e){const t=this.resolution;t.setBaseSize(n,e);const s=t.width,i=t.height;this.renderTargetA.setSize(s,i),this.renderTargetB.setSize(s,i),this.blurMaterial.setSize(n,e)}initialize(n,e,t){t!==void 0&&(this.renderTargetA.texture.type=t,this.renderTargetB.texture.type=t,t!==ut?(this.blurMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1",this.copyMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1"):n!==null&&n.outputColorSpace===j&&(this.renderTargetA.texture.colorSpace=j,this.renderTargetB.texture.colorSpace=j))}static get AUTO_SIZE(){return ye.AUTO_SIZE}},wh=`#include <common>
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#ifdef RANGE
uniform vec2 range;
#elif defined(THRESHOLD)
uniform float threshold;uniform float smoothing;
#endif
varying vec2 vUv;void main(){vec4 texel=texture2D(inputBuffer,vUv);float l=luminance(texel.rgb);
#ifdef RANGE
float low=step(range.x,l);float high=step(l,range.y);l*=low*high;
#elif defined(THRESHOLD)
l=smoothstep(threshold,threshold+smoothing,l)*l;
#endif
#ifdef COLOR
gl_FragColor=vec4(texel.rgb*clamp(l,0.0,1.0),l);
#else
gl_FragColor=vec4(l);
#endif
}`,Sh=class extends Be{constructor(n=!1,e=null){super({name:"LuminanceMaterial",defines:{THREE_REVISION:ia.replace(/\D+/g,"")},uniforms:{inputBuffer:new _(null),threshold:new _(0),smoothing:new _(1),range:new _(null)},blending:ft,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:wh,vertexShader:cr}),this.colorOutput=n,this.luminanceRange=e}set inputBuffer(n){this.uniforms.inputBuffer.value=n}setInputBuffer(n){this.uniforms.inputBuffer.value=n}get threshold(){return this.uniforms.threshold.value}set threshold(n){this.smoothing>0||n>0?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.uniforms.threshold.value=n}getThreshold(){return this.threshold}setThreshold(n){this.threshold=n}get smoothing(){return this.uniforms.smoothing.value}set smoothing(n){this.threshold>0||n>0?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.uniforms.smoothing.value=n}getSmoothingFactor(){return this.smoothing}setSmoothingFactor(n){this.smoothing=n}get useThreshold(){return this.threshold>0||this.smoothing>0}set useThreshold(n){}get colorOutput(){return this.defines.COLOR!==void 0}set colorOutput(n){n?this.defines.COLOR="1":delete this.defines.COLOR,this.needsUpdate=!0}isColorOutputEnabled(n){return this.colorOutput}setColorOutputEnabled(n){this.colorOutput=n}get useRange(){return this.luminanceRange!==null}set useRange(n){this.luminanceRange=null}get luminanceRange(){return this.uniforms.range.value}set luminanceRange(n){n!==null?this.defines.RANGE="1":delete this.defines.RANGE,this.uniforms.range.value=n,this.needsUpdate=!0}getLuminanceRange(){return this.luminanceRange}setLuminanceRange(n){this.luminanceRange=n}},Mh=class extends Le{constructor({renderTarget:n,luminanceRange:e,colorOutput:t,resolutionScale:s=1,width:i=ye.AUTO_SIZE,height:r=ye.AUTO_SIZE,resolutionX:o=i,resolutionY:a=r}={}){super("LuminancePass"),this.fullscreenMaterial=new Sh(t,e),this.needsSwap=!1,this.renderTarget=n,this.renderTarget===void 0&&(this.renderTarget=new Ke(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="LuminancePass.Target");const l=this.resolution=new ye(this,o,a,s);l.addEventListener("change",h=>this.setSize(l.baseWidth,l.baseHeight))}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}render(n,e,t,s,i){const r=this.fullscreenMaterial;r.inputBuffer=e.texture,n.setRenderTarget(this.renderToScreen?null:this.renderTarget),n.render(this.scene,this.camera)}setSize(n,e){const t=this.resolution;t.setBaseSize(n,e),this.renderTarget.setSize(t.width,t.height)}initialize(n,e,t){t!==void 0&&t!==ut&&(this.renderTarget.texture.type=t,this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}},Th=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#define WEIGHT_INNER 0.125
#define WEIGHT_OUTER 0.0555555
varying vec2 vUv;varying vec2 vUv00;varying vec2 vUv01;varying vec2 vUv02;varying vec2 vUv03;varying vec2 vUv04;varying vec2 vUv05;varying vec2 vUv06;varying vec2 vUv07;varying vec2 vUv08;varying vec2 vUv09;varying vec2 vUv10;varying vec2 vUv11;float clampToBorder(const in vec2 uv){return float(uv.s>=0.0&&uv.s<=1.0&&uv.t>=0.0&&uv.t<=1.0);}void main(){vec4 c=vec4(0.0);vec4 w=WEIGHT_INNER*vec4(clampToBorder(vUv00),clampToBorder(vUv01),clampToBorder(vUv02),clampToBorder(vUv03));c+=w.x*texture2D(inputBuffer,vUv00);c+=w.y*texture2D(inputBuffer,vUv01);c+=w.z*texture2D(inputBuffer,vUv02);c+=w.w*texture2D(inputBuffer,vUv03);w=WEIGHT_OUTER*vec4(clampToBorder(vUv04),clampToBorder(vUv05),clampToBorder(vUv06),clampToBorder(vUv07));c+=w.x*texture2D(inputBuffer,vUv04);c+=w.y*texture2D(inputBuffer,vUv05);c+=w.z*texture2D(inputBuffer,vUv06);c+=w.w*texture2D(inputBuffer,vUv07);w=WEIGHT_OUTER*vec4(clampToBorder(vUv08),clampToBorder(vUv09),clampToBorder(vUv10),clampToBorder(vUv11));c+=w.x*texture2D(inputBuffer,vUv08);c+=w.y*texture2D(inputBuffer,vUv09);c+=w.z*texture2D(inputBuffer,vUv10);c+=w.w*texture2D(inputBuffer,vUv11);c+=WEIGHT_OUTER*texture2D(inputBuffer,vUv);gl_FragColor=c;
#include <colorspace_fragment>
}`,Fh="uniform vec2 texelSize;varying vec2 vUv;varying vec2 vUv00;varying vec2 vUv01;varying vec2 vUv02;varying vec2 vUv03;varying vec2 vUv04;varying vec2 vUv05;varying vec2 vUv06;varying vec2 vUv07;varying vec2 vUv08;varying vec2 vUv09;varying vec2 vUv10;varying vec2 vUv11;void main(){vUv=position.xy*0.5+0.5;vUv00=vUv+texelSize*vec2(-1.0,1.0);vUv01=vUv+texelSize*vec2(1.0,1.0);vUv02=vUv+texelSize*vec2(-1.0,-1.0);vUv03=vUv+texelSize*vec2(1.0,-1.0);vUv04=vUv+texelSize*vec2(-2.0,2.0);vUv05=vUv+texelSize*vec2(0.0,2.0);vUv06=vUv+texelSize*vec2(2.0,2.0);vUv07=vUv+texelSize*vec2(-2.0,0.0);vUv08=vUv+texelSize*vec2(2.0,0.0);vUv09=vUv+texelSize*vec2(-2.0,-2.0);vUv10=vUv+texelSize*vec2(0.0,-2.0);vUv11=vUv+texelSize*vec2(2.0,-2.0);gl_Position=vec4(position.xy,1.0,1.0);}",xh=class extends Be{constructor(){super({name:"DownsamplingMaterial",uniforms:{inputBuffer:new _(null),texelSize:new _(new N)},blending:ft,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:Th,vertexShader:Fh})}set inputBuffer(n){this.uniforms.inputBuffer.value=n}setSize(n,e){this.uniforms.texelSize.value.set(1/n,1/e)}},Ih=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;uniform mediump sampler2D supportBuffer;
#else
uniform lowp sampler2D inputBuffer;uniform lowp sampler2D supportBuffer;
#endif
uniform float radius;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;varying vec2 vUv6;varying vec2 vUv7;void main(){vec4 c=vec4(0.0);c+=texture2D(inputBuffer,vUv0)*0.0625;c+=texture2D(inputBuffer,vUv1)*0.125;c+=texture2D(inputBuffer,vUv2)*0.0625;c+=texture2D(inputBuffer,vUv3)*0.125;c+=texture2D(inputBuffer,vUv)*0.25;c+=texture2D(inputBuffer,vUv4)*0.125;c+=texture2D(inputBuffer,vUv5)*0.0625;c+=texture2D(inputBuffer,vUv6)*0.125;c+=texture2D(inputBuffer,vUv7)*0.0625;vec4 baseColor=texture2D(supportBuffer,vUv);gl_FragColor=mix(baseColor,c,radius);
#include <colorspace_fragment>
}`,Lh="uniform vec2 texelSize;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;varying vec2 vUv6;varying vec2 vUv7;void main(){vUv=position.xy*0.5+0.5;vUv0=vUv+texelSize*vec2(-1.0,1.0);vUv1=vUv+texelSize*vec2(0.0,1.0);vUv2=vUv+texelSize*vec2(1.0,1.0);vUv3=vUv+texelSize*vec2(-1.0,0.0);vUv4=vUv+texelSize*vec2(1.0,0.0);vUv5=vUv+texelSize*vec2(-1.0,-1.0);vUv6=vUv+texelSize*vec2(0.0,-1.0);vUv7=vUv+texelSize*vec2(1.0,-1.0);gl_Position=vec4(position.xy,1.0,1.0);}",Ph=class extends Be{constructor(){super({name:"UpsamplingMaterial",uniforms:{inputBuffer:new _(null),supportBuffer:new _(null),texelSize:new _(new N),radius:new _(.85)},blending:ft,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:Ih,vertexShader:Lh})}set inputBuffer(n){this.uniforms.inputBuffer.value=n}set supportBuffer(n){this.uniforms.supportBuffer.value=n}get radius(){return this.uniforms.radius.value}set radius(n){this.uniforms.radius.value=n}setSize(n,e){this.uniforms.texelSize.value.set(1/n,1/e)}},Hh=class extends Le{constructor(){super("MipmapBlurPass"),this.needsSwap=!1,this.renderTarget=new Ke(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="Upsampling.Mipmap0",this.downsamplingMipmaps=[],this.upsamplingMipmaps=[],this.downsamplingMaterial=new xh,this.upsamplingMaterial=new Ph,this.resolution=new N}get texture(){return this.renderTarget.texture}get levels(){return this.downsamplingMipmaps.length}set levels(n){if(this.levels!==n){const e=this.renderTarget;this.dispose(),this.downsamplingMipmaps=[],this.upsamplingMipmaps=[];for(let t=0;t<n;++t){const s=e.clone();s.texture.name="Downsampling.Mipmap"+t,this.downsamplingMipmaps.push(s)}this.upsamplingMipmaps.push(e);for(let t=1,s=n-1;t<s;++t){const i=e.clone();i.texture.name="Upsampling.Mipmap"+t,this.upsamplingMipmaps.push(i)}this.setSize(this.resolution.x,this.resolution.y)}}get radius(){return this.upsamplingMaterial.radius}set radius(n){this.upsamplingMaterial.radius=n}render(n,e,t,s,i){const{scene:r,camera:o}=this,{downsamplingMaterial:a,upsamplingMaterial:l}=this,{downsamplingMipmaps:h,upsamplingMipmaps:d}=this;let u=e;this.fullscreenMaterial=a;for(let c=0,f=h.length;c<f;++c){const p=h[c];a.setSize(u.width,u.height),a.inputBuffer=u.texture,n.setRenderTarget(p),n.render(r,o),u=p}this.fullscreenMaterial=l;for(let c=d.length-1;c>=0;--c){const f=d[c];l.setSize(u.width,u.height),l.inputBuffer=u.texture,l.supportBuffer=h[c].texture,n.setRenderTarget(f),n.render(r,o),u=f}}setSize(n,e){const t=this.resolution;t.set(n,e);let s=t.width,i=t.height;for(let r=0,o=this.downsamplingMipmaps.length;r<o;++r)s=Math.round(s*.5),i=Math.round(i*.5),this.downsamplingMipmaps[r].setSize(s,i),r<this.upsamplingMipmaps.length&&this.upsamplingMipmaps[r].setSize(s,i)}initialize(n,e,t){if(t!==void 0){const s=this.downsamplingMipmaps.concat(this.upsamplingMipmaps);for(const i of s)i.texture.type=t;if(t!==ut)this.downsamplingMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1",this.upsamplingMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1";else if(n!==null&&n.outputColorSpace===j)for(const i of s)i.texture.colorSpace=j}}dispose(){super.dispose();for(const n of this.downsamplingMipmaps.concat(this.upsamplingMipmaps))n.dispose()}},Rh=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D map;
#else
uniform lowp sampler2D map;
#endif
uniform float intensity;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec4 texel=texture2D(map,uv);outputColor=vec4(texel.rgb*intensity,texel.a);}`,Gh=class extends Zn{constructor({blendFunction:n=U.SCREEN,luminanceThreshold:e=.9,luminanceSmoothing:t=.025,mipmapBlur:s=!1,intensity:i=1,radius:r=.85,levels:o=8,kernelSize:a=Qn.LARGE,resolutionScale:l=.5,width:h=ye.AUTO_SIZE,height:d=ye.AUTO_SIZE,resolutionX:u=h,resolutionY:c=d}={}){super("BloomEffect",Rh,{blendFunction:n,uniforms:new Map([["map",new _(null)],["intensity",new _(i)]])}),this.renderTarget=new Ke(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="Bloom.Target",this.blurPass=new Ca({kernelSize:a}),this.luminancePass=new Mh({colorOutput:!0}),this.luminanceMaterial.threshold=e,this.luminanceMaterial.smoothing=t,this.mipmapBlurPass=new Hh,this.mipmapBlurPass.enabled=s,this.mipmapBlurPass.radius=r,this.mipmapBlurPass.levels=o,this.uniforms.get("map").value=s?this.mipmapBlurPass.texture:this.renderTarget.texture;const f=this.resolution=new ye(this,u,c,l);f.addEventListener("change",p=>this.setSize(f.baseWidth,f.baseHeight))}get texture(){return this.mipmapBlurPass.enabled?this.mipmapBlurPass.texture:this.renderTarget.texture}getTexture(){return this.texture}getResolution(){return this.resolution}getBlurPass(){return this.blurPass}getLuminancePass(){return this.luminancePass}get luminanceMaterial(){return this.luminancePass.fullscreenMaterial}getLuminanceMaterial(){return this.luminancePass.fullscreenMaterial}get width(){return this.resolution.width}set width(n){this.resolution.preferredWidth=n}get height(){return this.resolution.height}set height(n){this.resolution.preferredHeight=n}get dithering(){return this.blurPass.dithering}set dithering(n){this.blurPass.dithering=n}get kernelSize(){return this.blurPass.kernelSize}set kernelSize(n){this.blurPass.kernelSize=n}get distinction(){return console.warn(this.name,"distinction was removed"),1}set distinction(n){console.warn(this.name,"distinction was removed")}get intensity(){return this.uniforms.get("intensity").value}set intensity(n){this.uniforms.get("intensity").value=n}getIntensity(){return this.intensity}setIntensity(n){this.intensity=n}getResolutionScale(){return this.resolution.scale}setResolutionScale(n){this.resolution.scale=n}update(n,e,t){const s=this.renderTarget,i=this.luminancePass;i.enabled?(i.render(n,e),this.mipmapBlurPass.enabled?this.mipmapBlurPass.render(n,i.renderTarget):this.blurPass.render(n,i.renderTarget,s)):this.mipmapBlurPass.enabled?this.mipmapBlurPass.render(n,e):this.blurPass.render(n,e,s)}setSize(n,e){const t=this.resolution;t.setBaseSize(n,e),this.renderTarget.setSize(t.width,t.height),this.blurPass.resolution.copy(t),this.luminancePass.setSize(n,e),this.mipmapBlurPass.setSize(n,e)}initialize(n,e,t){this.blurPass.initialize(n,e,t),this.luminancePass.initialize(n,e,t),this.mipmapBlurPass.initialize(n,e,t),t!==void 0&&(this.renderTarget.texture.type=t,n!==null&&n.outputColorSpace===j&&(this.renderTarget.texture.colorSpace=j))}},Oh="uniform float brightness;uniform float contrast;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec3 color=inputColor.rgb+vec3(brightness-0.5);if(contrast>0.0){color/=vec3(1.0-contrast);}else{color*=vec3(1.0+contrast);}outputColor=vec4(color+vec3(0.5),inputColor.a);}",Nh=class extends Zn{constructor({blendFunction:n=U.SRC,brightness:e=0,contrast:t=0}={}){super("BrightnessContrastEffect",Oh,{blendFunction:n,uniforms:new Map([["brightness",new _(e)],["contrast",new _(t)]])}),this.inputColorSpace=j}get brightness(){return this.uniforms.get("brightness").value}set brightness(n){this.uniforms.get("brightness").value=n}getBrightness(){return this.brightness}setBrightness(n){this.brightness=n}get contrast(){return this.uniforms.get("contrast").value}set contrast(n){this.uniforms.get("contrast").value=n}getContrast(){return this.contrast}setContrast(n){this.contrast=n}},Ea=class extends Le{constructor(n,e="inputBuffer"){super("ShaderPass"),this.fullscreenMaterial=n,this.input=e}setInput(n){this.input=n}render(n,e,t,s,i){const r=this.fullscreenMaterial.uniforms;e!==null&&r!==void 0&&r[this.input]!==void 0&&(r[this.input].value=e.texture),n.setRenderTarget(this.renderToScreen?null:t),n.render(this.scene,this.camera)}initialize(n,e,t){t!==void 0&&t!==ut&&(this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}},Js={KEEP_MAX_DEPTH:1,DISCARD_MAX_DEPTH:2},_h=`#include <common>
#include <packing>
#ifdef GL_FRAGMENT_PRECISION_HIGH
uniform highp sampler2D depthBuffer0;uniform highp sampler2D depthBuffer1;
#else
uniform mediump sampler2D depthBuffer0;uniform mediump sampler2D depthBuffer1;
#endif
uniform sampler2D inputBuffer;uniform vec2 cameraNearFar;float getViewZ(const in float depth){
#ifdef PERSPECTIVE_CAMERA
return perspectiveDepthToViewZ(depth,cameraNearFar.x,cameraNearFar.y);
#else
return orthographicDepthToViewZ(depth,cameraNearFar.x,cameraNearFar.y);
#endif
}varying vec2 vUv;void main(){vec2 depth;
#if DEPTH_PACKING_0 == 3201
depth.x=unpackRGBAToDepth(texture2D(depthBuffer0,vUv));
#else
depth.x=texture2D(depthBuffer0,vUv).r;
#ifdef LOG_DEPTH
float d=pow(2.0,depth.x*log2(cameraNearFar.y+1.0))-1.0;float a=cameraNearFar.y/(cameraNearFar.y-cameraNearFar.x);float b=cameraNearFar.y*cameraNearFar.x/(cameraNearFar.x-cameraNearFar.y);depth.x=a+b/d;
#endif
#endif
#if DEPTH_PACKING_1 == 3201
depth.y=unpackRGBAToDepth(texture2D(depthBuffer1,vUv));
#else
depth.y=texture2D(depthBuffer1,vUv).r;
#ifdef LOG_DEPTH
float d=pow(2.0,depth.y*log2(cameraNearFar.y+1.0))-1.0;float a=cameraNearFar.y/(cameraNearFar.y-cameraNearFar.x);float b=cameraNearFar.y*cameraNearFar.x/(cameraNearFar.x-cameraNearFar.y);depth.y=a+b/d;
#endif
#endif
bool isMaxDepth=(depth.x==1.0);
#ifdef PERSPECTIVE_CAMERA
depth.x=viewZToOrthographicDepth(getViewZ(depth.x),cameraNearFar.x,cameraNearFar.y);depth.y=viewZToOrthographicDepth(getViewZ(depth.y),cameraNearFar.x,cameraNearFar.y);
#endif
#if DEPTH_TEST_STRATEGY == 0
bool keep=depthTest(depth.x,depth.y);
#elif DEPTH_TEST_STRATEGY == 1
bool keep=isMaxDepth||depthTest(depth.x,depth.y);
#else
bool keep=!isMaxDepth&&depthTest(depth.x,depth.y);
#endif
if(keep){gl_FragColor=texture2D(inputBuffer,vUv);}else{discard;}}`,Uh=class extends Be{constructor(){super({name:"DepthMaskMaterial",defines:{DEPTH_EPSILON:"0.0001",DEPTH_PACKING_0:"0",DEPTH_PACKING_1:"0",DEPTH_TEST_STRATEGY:Js.KEEP_MAX_DEPTH},uniforms:{inputBuffer:new _(null),depthBuffer0:new _(null),depthBuffer1:new _(null),cameraNearFar:new _(new N(1,1))},blending:ft,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:_h,vertexShader:cr}),this.depthMode=Pr}set depthBuffer0(n){this.uniforms.depthBuffer0.value=n}set depthPacking0(n){this.defines.DEPTH_PACKING_0=n.toFixed(0),this.needsUpdate=!0}setDepthBuffer0(n,e=zt){this.depthBuffer0=n,this.depthPacking0=e}set depthBuffer1(n){this.uniforms.depthBuffer1.value=n}set depthPacking1(n){this.defines.DEPTH_PACKING_1=n.toFixed(0),this.needsUpdate=!0}setDepthBuffer1(n,e=zt){this.depthBuffer1=n,this.depthPacking1=e}get maxDepthStrategy(){return Number(this.defines.DEPTH_TEST_STRATEGY)}set maxDepthStrategy(n){this.defines.DEPTH_TEST_STRATEGY=n.toFixed(0),this.needsUpdate=!0}get keepFar(){return this.maxDepthStrategy}set keepFar(n){this.maxDepthStrategy=n?Js.KEEP_MAX_DEPTH:Js.DISCARD_MAX_DEPTH}getMaxDepthStrategy(){return this.maxDepthStrategy}setMaxDepthStrategy(n){this.maxDepthStrategy=n}get epsilon(){return Number(this.defines.DEPTH_EPSILON)}set epsilon(n){this.defines.DEPTH_EPSILON=n.toFixed(16),this.needsUpdate=!0}getEpsilon(){return this.epsilon}setEpsilon(n){this.epsilon=n}get depthMode(){return Number(this.defines.DEPTH_MODE)}set depthMode(n){let e;switch(n){case Ml:e="false";break;case Sl:e="true";break;case Oi:e="abs(d1 - d0) <= DEPTH_EPSILON";break;case ta:e="abs(d1 - d0) > DEPTH_EPSILON";break;case Pr:e="d0 > d1";break;case wl:e="d0 >= d1";break;case bl:e="d0 <= d1";break;case yl:default:e="d0 < d1";break}this.defines.DEPTH_MODE=n.toFixed(0),this.defines["depthTest(d0, d1)"]=e,this.needsUpdate=!0}getDepthMode(){return this.depthMode}setDepthMode(n){this.depthMode=n}adoptCameraSettings(n){this.copyCameraSettings(n)}copyCameraSettings(n){n&&(this.uniforms.cameraNearFar.value.set(n.near,n.far),n instanceof bs?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}},hr=class extends Le{constructor(n,e,t=null){super("RenderPass",n,e),this.needsSwap=!1,this.clearPass=new qn,this.overrideMaterialManager=t===null?null:new jr(t),this.ignoreBackground=!1,this.skipShadowMapUpdate=!1,this.selection=null}set mainScene(n){this.scene=n}set mainCamera(n){this.camera=n}get renderToScreen(){return super.renderToScreen}set renderToScreen(n){super.renderToScreen=n,this.clearPass.renderToScreen=n}get overrideMaterial(){const n=this.overrideMaterialManager;return n!==null?n.material:null}set overrideMaterial(n){const e=this.overrideMaterialManager;n!==null?e!==null?e.setMaterial(n):this.overrideMaterialManager=new jr(n):e!==null&&(e.dispose(),this.overrideMaterialManager=null)}getOverrideMaterial(){return this.overrideMaterial}setOverrideMaterial(n){this.overrideMaterial=n}get clear(){return this.clearPass.enabled}set clear(n){this.clearPass.enabled=n}getSelection(){return this.selection}setSelection(n){this.selection=n}isBackgroundDisabled(){return this.ignoreBackground}setBackgroundDisabled(n){this.ignoreBackground=n}isShadowMapDisabled(){return this.skipShadowMapUpdate}setShadowMapDisabled(n){this.skipShadowMapUpdate=n}getClearPass(){return this.clearPass}render(n,e,t,s,i){const r=this.scene,o=this.camera,a=this.selection,l=o.layers.mask,h=r.background,d=n.shadowMap.autoUpdate,u=this.renderToScreen?null:e;a!==null&&o.layers.set(a.getLayer()),this.skipShadowMapUpdate&&(n.shadowMap.autoUpdate=!1),(this.ignoreBackground||this.clearPass.overrideClearColor!==null)&&(r.background=null),this.clearPass.enabled&&this.clearPass.render(n,e),n.setRenderTarget(u),this.overrideMaterialManager!==null?this.overrideMaterialManager.render(n,r,o):n.render(r,o),o.layers.mask=l,r.background=h,n.shadowMap.autoUpdate=d}},kh="uniform vec3 hue;uniform float saturation;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec3 color=vec3(dot(inputColor.rgb,hue.xyz),dot(inputColor.rgb,hue.zxy),dot(inputColor.rgb,hue.yzx));float average=(color.r+color.g+color.b)/3.0;vec3 diff=average-color;if(saturation>0.0){color+=diff*(1.0-1.0/(1.001-saturation));}else{color+=diff*-saturation;}outputColor=vec4(min(color,1.0),inputColor.a);}",Kh=class extends Zn{constructor({blendFunction:n=U.SRC,hue:e=0,saturation:t=0}={}){super("HueSaturationEffect",kh,{blendFunction:n,uniforms:new Map([["hue",new _(new M)],["saturation",new _(t)]])}),this.hue=e}get saturation(){return this.uniforms.get("saturation").value}set saturation(n){this.uniforms.get("saturation").value=n}getSaturation(){return this.saturation}setSaturation(n){this.saturation=n}get hue(){const n=this.uniforms.get("hue").value;return Math.acos((n.x*3-1)/2)}set hue(n){const e=Math.sin(n),t=Math.cos(n);this.uniforms.get("hue").value.set((2*t+1)/3,(-Math.sqrt(3)*e-t+1)/3,(Math.sqrt(3)*e-t+1)/3)}getHue(){return this.hue}setHue(n){this.hue=n}},Jh=`#include <packing>
#include <clipping_planes_pars_fragment>
#ifdef GL_FRAGMENT_PRECISION_HIGH
uniform highp sampler2D depthBuffer;
#else
uniform mediump sampler2D depthBuffer;
#endif
uniform float cameraNear;uniform float cameraFar;centroid varying float vViewZ;centroid varying vec4 vProjTexCoord;void main(){
#include <clipping_planes_fragment>
vec2 projTexCoord=(vProjTexCoord.xy/vProjTexCoord.w)*0.5+0.5;projTexCoord=clamp(projTexCoord,0.002,0.998);
#if DEPTH_PACKING == 3201
float fragCoordZ=unpackRGBAToDepth(texture2D(depthBuffer,projTexCoord));
#else
float fragCoordZ=texture2D(depthBuffer,projTexCoord).r;
#endif
#ifdef PERSPECTIVE_CAMERA
float viewZ=perspectiveDepthToViewZ(fragCoordZ,cameraNear,cameraFar);
#else
float viewZ=orthographicDepthToViewZ(fragCoordZ,cameraNear,cameraFar);
#endif
float depthTest=(-vViewZ>-viewZ)?1.0:0.0;gl_FragColor.rg=vec2(0.0,depthTest);}`,zh=`#include <common>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <clipping_planes_pars_vertex>
varying float vViewZ;varying vec4 vProjTexCoord;void main(){
#include <skinbase_vertex>
#include <begin_vertex>
#include <morphtarget_vertex>
#include <skinning_vertex>
#include <project_vertex>
vViewZ=mvPosition.z;vProjTexCoord=gl_Position;
#include <clipping_planes_vertex>
}`,Vh=class extends Be{constructor(n=null,e){super({name:"DepthComparisonMaterial",defines:{DEPTH_PACKING:"0"},uniforms:{depthBuffer:new _(null),cameraNear:new _(.3),cameraFar:new _(1e3)},blending:ft,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:Jh,vertexShader:zh}),this.depthBuffer=n,this.depthPacking=Ln,this.copyCameraSettings(e)}set depthBuffer(n){this.uniforms.depthBuffer.value=n}set depthPacking(n){this.defines.DEPTH_PACKING=n.toFixed(0),this.needsUpdate=!0}setDepthBuffer(n,e=Ln){this.depthBuffer=n,this.depthPacking=e}adoptCameraSettings(n){this.copyCameraSettings(n)}copyCameraSettings(n){n&&(this.uniforms.cameraNear.value=n.near,this.uniforms.cameraFar.value=n.far,n instanceof bs?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}},jh="uniform lowp sampler2D inputBuffer;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 c0=texture2D(inputBuffer,vUv0).rg;vec2 c1=texture2D(inputBuffer,vUv1).rg;vec2 c2=texture2D(inputBuffer,vUv2).rg;vec2 c3=texture2D(inputBuffer,vUv3).rg;float d0=(c0.x-c1.x)*0.5;float d1=(c2.x-c3.x)*0.5;float d=length(vec2(d0,d1));float a0=min(c0.y,c1.y);float a1=min(c2.y,c3.y);float visibilityFactor=min(a0,a1);gl_FragColor.rg=(1.0-visibilityFactor>0.001)?vec2(d,0.0):vec2(0.0,d);}",Wh="uniform vec2 texelSize;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vUv0=vec2(uv.x+texelSize.x,uv.y);vUv1=vec2(uv.x-texelSize.x,uv.y);vUv2=vec2(uv.x,uv.y+texelSize.y);vUv3=vec2(uv.x,uv.y-texelSize.y);gl_Position=vec4(position.xy,1.0,1.0);}",Xh=class extends Be{constructor(n=new N){super({name:"OutlineMaterial",uniforms:{inputBuffer:new _(null),texelSize:new _(new N)},blending:ft,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:jh,vertexShader:Wh}),this.uniforms.texelSize.value.set(n.x,n.y),this.uniforms.maskTexture=this.uniforms.inputBuffer}set inputBuffer(n){this.uniforms.inputBuffer.value=n}setInputBuffer(n){this.uniforms.inputBuffer.value=n}setTexelSize(n,e){this.uniforms.texelSize.value.set(n,e)}setSize(n,e){this.uniforms.texelSize.value.set(1/n,1/e)}},Da=class extends Le{constructor(n,e,{renderTarget:t,resolutionScale:s=1,width:i=ye.AUTO_SIZE,height:r=ye.AUTO_SIZE,resolutionX:o=i,resolutionY:a=r}={}){super("DepthPass"),this.needsSwap=!1,this.renderPass=new hr(n,e,new vl({depthPacking:Ln}));const l=this.renderPass;l.skipShadowMapUpdate=!0,l.ignoreBackground=!0;const h=l.clearPass;h.overrideClearColor=new Z(16777215),h.overrideClearAlpha=1,this.renderTarget=t,this.renderTarget===void 0&&(this.renderTarget=new Ke(1,1,{minFilter:Hn,magFilter:Hn}),this.renderTarget.texture.name="DepthPass.Target");const d=this.resolution=new ye(this,o,a,s);d.addEventListener("change",u=>this.setSize(d.baseWidth,d.baseHeight))}set mainScene(n){this.renderPass.mainScene=n}set mainCamera(n){this.renderPass.mainCamera=n}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}getResolutionScale(){return this.resolution.scale}setResolutionScale(n){this.resolution.scale=n}render(n,e,t,s,i){const r=this.renderToScreen?null:this.renderTarget;this.renderPass.render(n,r)}setSize(n,e){const t=this.resolution;t.setBaseSize(n,e),this.renderTarget.setSize(t.width,t.height)}},Yh=`uniform lowp sampler2D edgeTexture;uniform lowp sampler2D maskTexture;uniform vec3 visibleEdgeColor;uniform vec3 hiddenEdgeColor;uniform float pulse;uniform float edgeStrength;
#ifdef USE_PATTERN
uniform lowp sampler2D patternTexture;varying vec2 vUvPattern;
#endif
void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec2 edge=texture2D(edgeTexture,uv).rg;vec2 mask=texture2D(maskTexture,uv).rg;
#ifndef X_RAY
edge.y=0.0;
#endif
edge*=(edgeStrength*mask.x*pulse);vec3 color=edge.x*visibleEdgeColor+edge.y*hiddenEdgeColor;float visibilityFactor=0.0;
#ifdef USE_PATTERN
vec4 patternColor=texture2D(patternTexture,vUvPattern);
#ifdef X_RAY
float hiddenFactor=0.5;
#else
float hiddenFactor=0.0;
#endif
visibilityFactor=(1.0-mask.y>0.0)?1.0:hiddenFactor;visibilityFactor*=(1.0-mask.x)*patternColor.a;color+=visibilityFactor*patternColor.rgb;
#endif
float alpha=max(max(edge.x,edge.y),visibilityFactor);
#ifdef ALPHA
outputColor=vec4(color,alpha);
#else
outputColor=vec4(color,max(alpha,inputColor.a));
#endif
}`,qh="uniform float patternScale;varying vec2 vUvPattern;void mainSupport(const in vec2 uv){vUvPattern=uv*vec2(aspect,1.0)*patternScale;}",Wr=class extends Zn{constructor(n,e,{blendFunction:t=U.SCREEN,patternTexture:s=null,patternScale:i=1,edgeStrength:r=1,pulseSpeed:o=0,visibleEdgeColor:a=16777215,hiddenEdgeColor:l=2230538,kernelSize:h=Qn.VERY_SMALL,blur:d=!1,xRay:u=!0,multisampling:c=0,resolutionScale:f=.5,width:p=ye.AUTO_SIZE,height:B=ye.AUTO_SIZE,resolutionX:A=p,resolutionY:m=B}={}){super("OutlineEffect",Yh,{uniforms:new Map([["maskTexture",new _(null)],["edgeTexture",new _(null)],["edgeStrength",new _(r)],["visibleEdgeColor",new _(new Z(a))],["hiddenEdgeColor",new _(new Z(l))],["pulse",new _(1)],["patternScale",new _(i)],["patternTexture",new _(null)]])}),this.blendMode.addEventListener("change",D=>{this.blendMode.blendFunction===U.ALPHA?this.defines.set("ALPHA","1"):this.defines.delete("ALPHA"),this.setChanged()}),this.blendMode.blendFunction=t,this.patternTexture=s,this.xRay=u,this.scene=n,this.camera=e,this.renderTargetMask=new Ke(1,1),this.renderTargetMask.samples=c,this.renderTargetMask.texture.name="Outline.Mask",this.uniforms.get("maskTexture").value=this.renderTargetMask.texture,this.renderTargetOutline=new Ke(1,1,{depthBuffer:!1}),this.renderTargetOutline.texture.name="Outline.Edges",this.uniforms.get("edgeTexture").value=this.renderTargetOutline.texture,this.clearPass=new qn,this.clearPass.overrideClearColor=new Z(0),this.clearPass.overrideClearAlpha=1,this.depthPass=new Da(n,e),this.maskPass=new hr(n,e,new Vh(this.depthPass.texture,e));const g=this.maskPass.clearPass;g.overrideClearColor=new Z(16777215),g.overrideClearAlpha=1,this.blurPass=new Ca({resolutionScale:f,resolutionX:A,resolutionY:m,kernelSize:h}),this.blurPass.enabled=d;const C=this.blurPass.resolution;C.addEventListener("change",D=>this.setSize(C.baseWidth,C.baseHeight)),this.outlinePass=new Ea(new Xh);const E=this.outlinePass.fullscreenMaterial;E.inputBuffer=this.renderTargetMask.texture,this.time=0,this.forceUpdate=!0,this.selection=new ga,this.pulseSpeed=o}set mainScene(n){this.scene=n,this.depthPass.mainScene=n,this.maskPass.mainScene=n}set mainCamera(n){this.camera=n,this.depthPass.mainCamera=n,this.maskPass.mainCamera=n,this.maskPass.overrideMaterial.copyCameraSettings(n)}get resolution(){return this.blurPass.resolution}getResolution(){return this.blurPass.getResolution()}get multisampling(){return this.renderTargetMask.samples}set multisampling(n){this.renderTargetMask.samples=n,this.renderTargetMask.dispose()}get patternScale(){return this.uniforms.get("patternScale").value}set patternScale(n){this.uniforms.get("patternScale").value=n}get edgeStrength(){return this.uniforms.get("edgeStrength").value}set edgeStrength(n){this.uniforms.get("edgeStrength").value=n}get visibleEdgeColor(){return this.uniforms.get("visibleEdgeColor").value}set visibleEdgeColor(n){this.uniforms.get("visibleEdgeColor").value=n}get hiddenEdgeColor(){return this.uniforms.get("hiddenEdgeColor").value}set hiddenEdgeColor(n){this.uniforms.get("hiddenEdgeColor").value=n}getBlurPass(){return this.blurPass}getSelection(){return this.selection}getPulseSpeed(){return this.pulseSpeed}setPulseSpeed(n){this.pulseSpeed=n}get width(){return this.resolution.width}set width(n){this.resolution.preferredWidth=n}get height(){return this.resolution.height}set height(n){this.resolution.preferredHeight=n}get selectionLayer(){return this.selection.layer}set selectionLayer(n){this.selection.layer=n}get dithering(){return this.blurPass.dithering}set dithering(n){this.blurPass.dithering=n}get kernelSize(){return this.blurPass.kernelSize}set kernelSize(n){this.blurPass.kernelSize=n}get blur(){return this.blurPass.enabled}set blur(n){this.blurPass.enabled=n}get xRay(){return this.defines.has("X_RAY")}set xRay(n){this.xRay!==n&&(n?this.defines.set("X_RAY","1"):this.defines.delete("X_RAY"),this.setChanged())}isXRayEnabled(){return this.xRay}setXRayEnabled(n){this.xRay=n}get patternTexture(){return this.uniforms.get("patternTexture").value}set patternTexture(n){n!==null?(n.wrapS=n.wrapT=Ve,this.defines.set("USE_PATTERN","1"),this.setVertexShader(qh)):(this.defines.delete("USE_PATTERN"),this.setVertexShader(null)),this.uniforms.get("patternTexture").value=n,this.setChanged()}setPatternTexture(n){this.patternTexture=n}getResolutionScale(){return this.resolution.scale}setResolutionScale(n){this.resolution.scale=n}setSelection(n){return this.selection.set(n),this}clearSelection(){return this.selection.clear(),this}selectObject(n){return this.selection.add(n),this}deselectObject(n){return this.selection.delete(n),this}update(n,e,t){const s=this.scene,i=this.camera,r=this.selection,a=this.uniforms.get("pulse"),l=s.background,h=i.layers.mask;(this.forceUpdate||r.size>0)&&(s.background=null,a.value=1,this.pulseSpeed>0&&(a.value=Math.cos(this.time*this.pulseSpeed*10)*.375+.625),this.time+=t,r.setVisible(!1),this.depthPass.render(n),r.setVisible(!0),i.layers.set(r.layer),this.maskPass.render(n,this.renderTargetMask),i.layers.mask=h,s.background=l,this.outlinePass.render(n,null,this.renderTargetOutline),this.blurPass.enabled&&this.blurPass.render(n,this.renderTargetOutline,this.renderTargetOutline)),this.forceUpdate=r.size>0}setSize(n,e){this.blurPass.setSize(n,e),this.renderTargetMask.setSize(n,e);const t=this.resolution;t.setBaseSize(n,e);const s=t.width,i=t.height;this.depthPass.setSize(s,i),this.renderTargetOutline.setSize(s,i),this.outlinePass.fullscreenMaterial.setSize(s,i)}initialize(n,e,t){this.blurPass.initialize(n,e,ut),t!==void 0&&(this.depthPass.initialize(n,e,t),this.maskPass.initialize(n,e,t),this.outlinePass.initialize(n,e,t))}},Zh=class extends Gh{constructor(n,e,t){super(t),this.setAttributes(this.getAttributes()|Tt.DEPTH),this.camera=e,this.depthPass=new Da(n,e),this.clearPass=new qn(!0,!1,!1),this.clearPass.overrideClearColor=new Z(0),this.depthMaskPass=new Ea(new Uh);const s=this.depthMaskMaterial;s.copyCameraSettings(e),s.depthBuffer1=this.depthPass.texture,s.depthPacking1=Ln,s.depthMode=Oi,this.renderTargetMasked=new Ke(1,1,{depthBuffer:!1}),this.renderTargetMasked.texture.name="Bloom.Masked",this.selection=new ga,this._inverted=!1,this._ignoreBackground=!1}set mainScene(n){this.depthPass.mainScene=n}set mainCamera(n){this.camera=n,this.depthPass.mainCamera=n,this.depthMaskMaterial.copyCameraSettings(n)}getSelection(){return this.selection}get depthMaskMaterial(){return this.depthMaskPass.fullscreenMaterial}get inverted(){return this._inverted}set inverted(n){this._inverted=n,this.depthMaskMaterial.depthMode=n?ta:Oi}isInverted(){return this.inverted}setInverted(n){this.inverted=n}get ignoreBackground(){return this._ignoreBackground}set ignoreBackground(n){this._ignoreBackground=n,this.depthMaskMaterial.maxDepthStrategy=n?Js.DISCARD_MAX_DEPTH:Js.KEEP_MAX_DEPTH}isBackgroundDisabled(){return this.ignoreBackground}setBackgroundDisabled(n){this.ignoreBackground=n}setDepthTexture(n,e=zt){this.depthMaskMaterial.depthBuffer0=n,this.depthMaskMaterial.depthPacking0=e}update(n,e,t){const s=this.camera,i=this.selection,r=this.inverted;let o=e;if(this.ignoreBackground||!r||i.size>0){const a=s.layers.mask;s.layers.set(i.layer),this.depthPass.render(n),s.layers.mask=a,o=this.renderTargetMasked,this.clearPass.render(n,o),this.depthMaskPass.render(n,e,o)}super.update(n,o,t)}setSize(n,e){super.setSize(n,e),this.renderTargetMasked.setSize(n,e),this.depthPass.setSize(n,e)}initialize(n,e,t){super.initialize(n,e,t),this.clearPass.initialize(n,e,t),this.depthPass.initialize(n,e,t),this.depthMaskPass.initialize(n,e,t),n!==null&&n.capabilities.logarithmicDepthBuffer&&(this.depthMaskPass.fullscreenMaterial.defines.LOG_DEPTH="1"),t!==void 0&&(this.renderTargetMasked.texture.type=t,n!==null&&n.outputColorSpace===j&&(this.renderTargetMasked.texture.colorSpace=j))}},Qh=`#include <common>
#include <packing>
#include <dithering_pars_fragment>
#define packFloatToRGBA(v) packDepthToRGBA(v)
#define unpackRGBAToFloat(v) unpackRGBAToDepth(v)
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#if DEPTH_PACKING == 3201
uniform lowp sampler2D depthBuffer;
#elif defined(GL_FRAGMENT_PRECISION_HIGH)
uniform highp sampler2D depthBuffer;
#else
uniform mediump sampler2D depthBuffer;
#endif
uniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;vec4 sRGBToLinear(const in vec4 value){return vec4(mix(pow(value.rgb*0.9478672986+vec3(0.0521327014),vec3(2.4)),value.rgb*0.0773993808,vec3(lessThanEqual(value.rgb,vec3(0.04045)))),value.a);}float readDepth(const in vec2 uv){
#if DEPTH_PACKING == 3201
return unpackRGBAToDepth(texture2D(depthBuffer,uv));
#else
return texture2D(depthBuffer,uv).r;
#endif
}float getViewZ(const in float depth){
#ifdef PERSPECTIVE_CAMERA
return perspectiveDepthToViewZ(depth,cameraNear,cameraFar);
#else
return orthographicDepthToViewZ(depth,cameraNear,cameraFar);
#endif
}vec3 RGBToHCV(const in vec3 RGB){vec4 P=mix(vec4(RGB.bg,-1.0,2.0/3.0),vec4(RGB.gb,0.0,-1.0/3.0),step(RGB.b,RGB.g));vec4 Q=mix(vec4(P.xyw,RGB.r),vec4(RGB.r,P.yzx),step(P.x,RGB.r));float C=Q.x-min(Q.w,Q.y);float H=abs((Q.w-Q.y)/(6.0*C+EPSILON)+Q.z);return vec3(H,C,Q.x);}vec3 RGBToHSL(const in vec3 RGB){vec3 HCV=RGBToHCV(RGB);float L=HCV.z-HCV.y*0.5;float S=HCV.y/(1.0-abs(L*2.0-1.0)+EPSILON);return vec3(HCV.x,S,L);}vec3 HueToRGB(const in float H){float R=abs(H*6.0-3.0)-1.0;float G=2.0-abs(H*6.0-2.0);float B=2.0-abs(H*6.0-4.0);return clamp(vec3(R,G,B),0.0,1.0);}vec3 HSLToRGB(const in vec3 HSL){vec3 RGB=HueToRGB(HSL.x);float C=(1.0-abs(2.0*HSL.z-1.0))*HSL.y;return(RGB-0.5)*C+HSL.z;}FRAGMENT_HEAD void main(){FRAGMENT_MAIN_UV vec4 color0=texture2D(inputBuffer,UV);vec4 color1=vec4(0.0);FRAGMENT_MAIN_IMAGE color0.a=clamp(color0.a,0.0,1.0);gl_FragColor=color0;
#ifdef ENCODE_OUTPUT
#include <colorspace_fragment>
#endif
#include <dithering_fragment>
}`,$h="uniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;VERTEX_HEAD void main(){vUv=position.xy*0.5+0.5;VERTEX_MAIN_SUPPORT gl_Position=vec4(position.xy,1.0,1.0);}",eu=class extends Be{constructor(n,e,t,s,i=!1){super({name:"EffectMaterial",defines:{THREE_REVISION:ia.replace(/\D+/g,""),DEPTH_PACKING:"0",ENCODE_OUTPUT:"1"},uniforms:{inputBuffer:new _(null),depthBuffer:new _(null),resolution:new _(new N),texelSize:new _(new N),cameraNear:new _(.3),cameraFar:new _(1e3),aspect:new _(1),time:new _(0)},blending:ft,toneMapped:!1,depthWrite:!1,depthTest:!1,dithering:i}),n&&this.setShaderParts(n),e&&this.setDefines(e),t&&this.setUniforms(t),this.copyCameraSettings(s)}set inputBuffer(n){this.uniforms.inputBuffer.value=n}setInputBuffer(n){this.uniforms.inputBuffer.value=n}get depthBuffer(){return this.uniforms.depthBuffer.value}set depthBuffer(n){this.uniforms.depthBuffer.value=n}get depthPacking(){return Number(this.defines.DEPTH_PACKING)}set depthPacking(n){this.defines.DEPTH_PACKING=n.toFixed(0),this.needsUpdate=!0}setDepthBuffer(n,e=zt){this.depthBuffer=n,this.depthPacking=e}setShaderData(n){this.setShaderParts(n.shaderParts),this.setDefines(n.defines),this.setUniforms(n.uniforms),this.setExtensions(n.extensions)}setShaderParts(n){return this.fragmentShader=Qh.replace(X.FRAGMENT_HEAD,n.get(X.FRAGMENT_HEAD)||"").replace(X.FRAGMENT_MAIN_UV,n.get(X.FRAGMENT_MAIN_UV)||"").replace(X.FRAGMENT_MAIN_IMAGE,n.get(X.FRAGMENT_MAIN_IMAGE)||""),this.vertexShader=$h.replace(X.VERTEX_HEAD,n.get(X.VERTEX_HEAD)||"").replace(X.VERTEX_MAIN_SUPPORT,n.get(X.VERTEX_MAIN_SUPPORT)||""),this.needsUpdate=!0,this}setDefines(n){for(const e of n.entries())this.defines[e[0]]=e[1];return this.needsUpdate=!0,this}setUniforms(n){for(const e of n.entries())this.uniforms[e[0]]=e[1];return this}setExtensions(n){this.extensions={};for(const e of n)this.extensions[e]=!0;return this}get encodeOutput(){return this.defines.ENCODE_OUTPUT!==void 0}set encodeOutput(n){this.encodeOutput!==n&&(n?this.defines.ENCODE_OUTPUT="1":delete this.defines.ENCODE_OUTPUT,this.needsUpdate=!0)}isOutputEncodingEnabled(n){return this.encodeOutput}setOutputEncodingEnabled(n){this.encodeOutput=n}get time(){return this.uniforms.time.value}set time(n){this.uniforms.time.value=n}setDeltaTime(n){this.uniforms.time.value+=n}adoptCameraSettings(n){this.copyCameraSettings(n)}copyCameraSettings(n){n&&(this.uniforms.cameraNear.value=n.near,this.uniforms.cameraFar.value=n.far,n instanceof bs?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}setSize(n,e){const t=this.uniforms;t.resolution.value.set(n,e),t.texelSize.value.set(1/n,1/e),t.aspect.value=n/e}static get Section(){return X}};function Xr(n,e,t){for(const s of e){const i="$1"+n+s.charAt(0).toUpperCase()+s.slice(1),r=new RegExp("([^\\.])(\\b"+s+"\\b)","g");for(const o of t.entries())o[1]!==null&&t.set(o[0],o[1].replace(r,i))}}function tu(n,e,t){let s=e.getFragmentShader(),i=e.getVertexShader();const r=s!==void 0&&/mainImage/.test(s),o=s!==void 0&&/mainUv/.test(s);if(t.attributes|=e.getAttributes(),s===void 0)throw new Error(`Missing fragment shader (${e.name})`);if(o&&t.attributes&Tt.CONVOLUTION)throw new Error(`Effects that transform UVs are incompatible with convolution effects (${e.name})`);if(!r&&!o)throw new Error(`Could not find mainImage or mainUv function (${e.name})`);{const a=/\w+\s+(\w+)\([\w\s,]*\)\s*{/g,l=t.shaderParts;let h=l.get(X.FRAGMENT_HEAD)||"",d=l.get(X.FRAGMENT_MAIN_UV)||"",u=l.get(X.FRAGMENT_MAIN_IMAGE)||"",c=l.get(X.VERTEX_HEAD)||"",f=l.get(X.VERTEX_MAIN_SUPPORT)||"";const p=new Set,B=new Set;if(o&&(d+=`	${n}MainUv(UV);
`,t.uvTransformation=!0),i!==null&&/mainSupport/.test(i)){const g=/mainSupport *\([\w\s]*?uv\s*?\)/.test(i);f+=`	${n}MainSupport(`,f+=g?`vUv);
`:`);
`;for(const C of i.matchAll(/(?:varying\s+\w+\s+([\S\s]*?);)/g))for(const E of C[1].split(/\s*,\s*/))t.varyings.add(E),p.add(E),B.add(E);for(const C of i.matchAll(a))B.add(C[1])}for(const g of s.matchAll(a))B.add(g[1]);for(const g of e.defines.keys())B.add(g.replace(/\([\w\s,]*\)/g,""));for(const g of e.uniforms.keys())B.add(g);B.delete("while"),B.delete("for"),B.delete("if"),e.uniforms.forEach((g,C)=>t.uniforms.set(n+C.charAt(0).toUpperCase()+C.slice(1),g)),e.defines.forEach((g,C)=>t.defines.set(n+C.charAt(0).toUpperCase()+C.slice(1),g));const A=new Map([["fragment",s],["vertex",i]]);Xr(n,B,t.defines),Xr(n,B,A),s=A.get("fragment"),i=A.get("vertex");const m=e.blendMode;if(t.blendModes.set(m.blendFunction,m),r){e.inputColorSpace!==null&&e.inputColorSpace!==t.colorSpace&&(u+=e.inputColorSpace===j?`color0 = sRGBTransferOETF(color0);
	`:`color0 = sRGBToLinear(color0);
	`),e.outputColorSpace!==na?t.colorSpace=e.outputColorSpace:e.inputColorSpace!==null&&(t.colorSpace=e.inputColorSpace);const g=/MainImage *\([\w\s,]*?depth[\w\s,]*?\)/;u+=`${n}MainImage(color0, UV, `,t.attributes&Tt.DEPTH&&g.test(s)&&(u+="depth, ",t.readDepth=!0),u+=`color1);
	`;const C=n+"BlendOpacity";t.uniforms.set(C,m.opacity),u+=`color0 = blend${m.blendFunction}(color0, color1, ${C});

	`,h+=`uniform float ${C};

`}if(h+=s+`
`,i!==null&&(c+=i+`
`),l.set(X.FRAGMENT_HEAD,h),l.set(X.FRAGMENT_MAIN_UV,d),l.set(X.FRAGMENT_MAIN_IMAGE,u),l.set(X.VERTEX_HEAD,c),l.set(X.VERTEX_MAIN_SUPPORT,f),e.extensions!==null)for(const g of e.extensions)t.extensions.add(g)}}var su=class extends Le{constructor(n,...e){super("EffectPass"),this.fullscreenMaterial=new eu(null,null,null,n),this.listener=t=>this.handleEvent(t),this.effects=[],this.setEffects(e),this.skipRendering=!1,this.minTime=1,this.maxTime=Number.POSITIVE_INFINITY,this.timeScale=1}set mainScene(n){for(const e of this.effects)e.mainScene=n}set mainCamera(n){this.fullscreenMaterial.copyCameraSettings(n);for(const e of this.effects)e.mainCamera=n}get encodeOutput(){return this.fullscreenMaterial.encodeOutput}set encodeOutput(n){this.fullscreenMaterial.encodeOutput=n}get dithering(){return this.fullscreenMaterial.dithering}set dithering(n){const e=this.fullscreenMaterial;e.dithering=n,e.needsUpdate=!0}setEffects(n){for(const e of this.effects)e.removeEventListener("change",this.listener);this.effects=n.sort((e,t)=>t.attributes-e.attributes);for(const e of this.effects)e.addEventListener("change",this.listener)}updateMaterial(){const n=new _c;let e=0;for(const o of this.effects)if(o.blendMode.blendFunction===U.DST)n.attributes|=o.getAttributes()&Tt.DEPTH;else{if(n.attributes&o.getAttributes()&Tt.CONVOLUTION)throw new Error(`Convolution effects cannot be merged (${o.name})`);tu("e"+e++,o,n)}let t=n.shaderParts.get(X.FRAGMENT_HEAD),s=n.shaderParts.get(X.FRAGMENT_MAIN_IMAGE),i=n.shaderParts.get(X.FRAGMENT_MAIN_UV);const r=/\bblend\b/g;for(const o of n.blendModes.values())t+=o.getShaderCode().replace(r,`blend${o.blendFunction}`)+`
`;n.attributes&Tt.DEPTH?(n.readDepth&&(s=`float depth = readDepth(UV);

	`+s),this.needsDepthTexture=this.getDepthTexture()===null):this.needsDepthTexture=!1,n.colorSpace===j&&(s+=`color0 = sRGBToLinear(color0);
	`),n.uvTransformation?(i=`vec2 transformedUv = vUv;
`+i,n.defines.set("UV","transformedUv")):n.defines.set("UV","vUv"),n.shaderParts.set(X.FRAGMENT_HEAD,t),n.shaderParts.set(X.FRAGMENT_MAIN_IMAGE,s),n.shaderParts.set(X.FRAGMENT_MAIN_UV,i);for(const[o,a]of n.shaderParts)a!==null&&n.shaderParts.set(o,a.trim().replace(/^#/,`
#`));this.skipRendering=e===0,this.needsSwap=!this.skipRendering,this.fullscreenMaterial.setShaderData(n)}recompile(){this.updateMaterial()}getDepthTexture(){return this.fullscreenMaterial.depthBuffer}setDepthTexture(n,e=zt){this.fullscreenMaterial.depthBuffer=n,this.fullscreenMaterial.depthPacking=e;for(const t of this.effects)t.setDepthTexture(n,e)}render(n,e,t,s,i){for(const r of this.effects)r.update(n,e,s);if(!this.skipRendering||this.renderToScreen){const r=this.fullscreenMaterial;r.inputBuffer=e.texture,r.time+=s*this.timeScale,n.setRenderTarget(this.renderToScreen?null:t),n.render(this.scene,this.camera)}}setSize(n,e){this.fullscreenMaterial.setSize(n,e);for(const t of this.effects)t.setSize(n,e)}initialize(n,e,t){this.renderer=n;for(const s of this.effects)s.initialize(n,e,t);this.updateMaterial(),t!==void 0&&t!==ut&&(this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}dispose(){super.dispose();for(const n of this.effects)n.removeEventListener("change",this.listener),n.dispose()}handleEvent(n){switch(n.type){case"change":this.recompile();break}}},As,vt,lt,Ce,va,ya,ba,wa,Sa,Ma,Ta;class nu{constructor(e,t,s){Y(this,Ce);Y(this,As);Y(this,vt);Y(this,lt);O(this,"resize",(e,t)=>{this.composer.setSize(e,t,!0)});O(this,"addBloom",e=>{const t=this.bloomEffect.selection;e instanceof Ae?t.add(e):Array.isArray(e)&&e.forEach(this.addBloom)});O(this,"clearBloom",e=>{const t=this.bloomEffect.selection;e instanceof Ae?t.delete(e):Array.isArray(e)&&e.forEach(this.clearBloom)});O(this,"addOutline",(e,t=1)=>{let s=t===1?this.outlineEffect1:this.outlineEffect2;e instanceof Ae?e.traverse(i=>{i.isMesh&&s.selection.add(i)}):Array.isArray(e)&&e.forEach(i=>this.addOutline(i,t))});O(this,"clearOutline",(e,t=1)=>{let s=t===1?this.outlineEffect1:this.outlineEffect2;e instanceof Ae?e.traverse(i=>{i.isMesh&&s.selection.delete(i)}):Array.isArray(e)&&e.forEach(i=>this.clearOutline(i,t))});O(this,"setNoSelection",e=>{this.noSelection.push(e)});O(this,"clearNoSelection",()=>{this.noSelection=[]});q(this,As,e),q(this,vt,t),q(this,lt,s),this.noSelection=[],Q(this,Ce,va).call(this)}clearOutlineAll(e){(e===1?this.outlineEffect1:this.outlineEffect2).selection.set([]),this.noSelection.forEach(s=>{this.addOutline(s)})}}As=new WeakMap,vt=new WeakMap,lt=new WeakMap,Ce=new WeakSet,va=function(){Q(this,Ce,ya).call(this),Q(this,Ce,ba).call(this),Q(this,Ce,wa).call(this),Q(this,Ce,Sa).call(this),Q(this,Ce,Ma).call(this),Q(this,Ce,Ta).call(this)},ya=function(){const e=P(this,As).capabilities.maxSamples;this.composer=new Nc(P(this,As),{multisampling:e})},ba=function(){this.renderPass=new hr(P(this,vt),P(this,lt)),this.composer.addPass(this.renderPass)},wa=function(){this.bloomEffect=new Zh(P(this,vt),P(this,lt),{blendFunction:U.ADD,luminanceThreshold:.01,luminanceSmoothing:.6,intensity:.9}),this.bloomEffect.inverted=!1,this.bloomEffect.ignoreBackground=!0,this.bloomEffect.selection.set([])},Sa=function(){this.outlineEffect1=new Wr(P(this,vt),P(this,lt),{blendFunction:U.ADD,edgeStrength:3,pulseSpeed:0,visibleEdgeColor:52945,hiddenEdgeColor:52945,blur:!1,xRay:!0,usePatternTexture:!1})},Ma=function(){this.outlineEffect2=new Wr(P(this,vt),P(this,lt),{blendFunction:U.ADD,edgeStrength:3,patternScale:5,visibleEdgeColor:52945,hiddenEdgeColor:52945,blur:!1,xRay:!0,usePatternTexture:!1})},Ta=function(){this.hueSaturationEffect=new Kh({saturation:.08}),this.brightnessContrastEffect=new Nh({contrast:.2});const e=new su(P(this,lt),this.bloomEffect,this.outlineEffect1,this.outlineEffect2);this.composer.addPass(e)};const Vs=class Vs{constructor(){O(this,"resources");O(this,"track",e=>{if(!e)return e;if(Array.isArray(e))return e.forEach(this.track),e;if((ru(e,"dispose")||e instanceof Ae)&&this.resources.add(e),e instanceof Ae)e.traverse(t=>{this.resources.add(t),t.material&&this.track(t.material),t.geometry&&this.track(t.geometry),t.skeleton&&this.track(t.skeleton)});else if(e instanceof hs){for(const t of Object.values(e))t instanceof Es&&this.track(t);if("uniforms"in e){for(const t of Object.values(e.uniforms))if(t){const s=t.value;s instanceof Es&&this.track(s)}}}return e});this.resources=new Set}untrack(e){this.resources.delete(e)}dispose(e=!0){for(const t of this.resources)t instanceof Ae&&e&&t.parent&&t.parent.remove(t),"dispose"in t&&t.dispose();this.clear()}clear(){this.resources.clear()}static dispose(e,t=!0){const s=Vs.memory;return s.track(e),s.dispose(t),s.clear(),!0}};O(Vs,"memory",new Vs);let le=Vs;function iu(n,e){return Reflect.has(n,e)}function ru(n,e){return iu(n,e)&&typeof n[e]=="function"}const Yr=new oe;var Bs;class ou{constructor(e){Y(this,Bs);O(this,"resize",(e,t)=>{const s=this.radius;this.upViewport.set(e*.65,t*.94-s,s,s),this.saveViewport.set(0,0,e,t)});this.renderer=e.renderer;const t=new Oe().load("./textures/compass.png");t.colorSpace=j;const s=new ir(10,10),i=new ct({transparent:!0,side:Me,map:t}),r=new K(s,i);r.rotateX(-Math.PI/2),q(this,Bs,r);const o=new bs(45,1,1,20);o.updateProjectionMatrix(),this.camera=o;const a=new Vt;a.add(r),this.scene=a;const l=this.radius=120,h=window.innerWidth,d=window.innerHeight;this.upViewport=new It(h*.65,d*.94-l,l,l),this.saveViewport=new It(0,0,h,d)}get theta(){return P(this,Bs).rotation.z}set theta(e){P(this,Bs).rotation.z=-e/180*Math.PI}update(e){const t=e.renderer,s=e.camera,i=this.camera,{upViewport:r,saveViewport:o}=this;i.position.set(0,0,12),Yr.extractRotation(s.matrix),i.position.applyMatrix4(Yr),i.lookAt(0,0,0),i.updateProjectionMatrix(),t.setViewport(r),t.setScissor(r),t.render(this.scene,i),t.setViewport(o),t.setScissor(o)}}Bs=new WeakMap;const qr=new le;Ae.prototype.deleteSelf=function(n){qr.track(this),qr.dispose(n)};const di=new M;M.prototype.clampSphere=function(n){this.distanceTo(n.center)>n.radius&&(di.subVectors(this,n.center).normalize(),di.setLength(n.radius),this.addVectors(n.center,di))};const{innerWidth:Zr,innerHeight:Qr,devicePixelRatio:au}=window;var ve,ne,Se,Zs,qe,_t,Re,yt,Ut,kt,ms,bt,wt,Kt,zn,gs,Vn,Fa;class lu{constructor(e){Y(this,Vn);Y(this,ve);Y(this,ne);Y(this,Se);Y(this,Zs);Y(this,qe);Y(this,_t);Y(this,Re);O(this,"clock");Y(this,yt);Y(this,Ut);Y(this,kt);Y(this,ms);Y(this,bt);Y(this,wt);Y(this,Kt);Y(this,zn,{textures:new Map,addTexture:function(e,t){if(this.textures.has(e)){const s=this.textures.get(e);s&&s!==t&&s.dispose()}this.textures.set(e,t)},removeTexture:function(e){const t=this.textures.get(e);t&&(t.dispose(),this.textures.delete(e))},clearAll:function(){this.textures.forEach(e=>{e.dispose()}),this.textures.clear()}});Y(this,gs);q(this,gs,null),this.clock=new ra,this.delta=0,this.elapsedTime=0,q(this,bt,new Map),q(this,wt,new Map),q(this,_t,e),q(this,yt,!1),q(this,ve,new Vt),this.baseScene=P(this,ve),q(this,Se,new bs(50,Zr/Qr,.01,2e4)),q(this,Zs,P(this,Se)),P(this,Se).position.set(0,100,100),P(this,Se).lookAt(0,0,0),q(this,Kt,new ou(this)),P(this,Kt).theta=27.6,P(this,bt).set("compass",P(this,Kt).resize);const t={logarithmicDepthBuffer:!0,powerPreference:"high-performance"};if(e instanceof HTMLCanvasElement)t.canvas=e;else if(e instanceof HTMLElement){const s=document.createElement("canvas");t.canvas=s,e.appendChild(this.renderer.domElement)}else{const s=document.createElement("canvas");t.canvas=s,document.body.appendChild(s),console.log("create canvas")}q(this,_t,t.canvas),P(this,_t).oncontextmenu=s=>!1,q(this,ne,new Tl(t)),P(this,ne).setSize(Zr,Qr),P(this,ne).outputColorSpace=j,P(this,ne).toneMapping=Fl,P(this,ne).shadowMap.enabled=!0,P(this,ne).shadowMap.type=xl,P(this,ne).setPixelRatio(au),P(this,ne).domElement.removeAttribute("data-engine"),P(this,ne).info.autoReset=!1,q(this,qe,new xc(P(this,Se),P(this,ne).domElement)),P(this,qe).target.set(0,0,0),P(this,qe).enableDamping=!0,P(this,qe).enableDolly=!1,P(this,qe).dampingFactor=.2,P(this,qe).data={},P(this,wt).set(Symbol(),s=>s.controls.update()),Q(this,Vn,Fa).call(this),document.oncontextmenu=()=>!1,window.addEventListener("resize",()=>{const{innerWidth:s,innerHeight:i}=window;P(this,Se).aspect=s/i,P(this,Se).updateProjectionMatrix(),P(this,ne).setSize(s,i),P(this,ne).setPixelRatio(window.devicePixelRatio),P(this,bt).forEach(r=>r(s,i))})}get onresizeQueue(){return P(this,bt)}get onRenderQueue(){return P(this,wt)}get scene(){return P(this,ve)}set scene(e){e instanceof Vt&&(P(this,ve).dispose&&P(this,ve).dispose(),q(this,ve,e),P(this,Re)&&P(this,Re).composer.setMainScene(e))}get camera(){return P(this,Se)}get baseCamera(){return P(this,Zs)}set camera(e){e instanceof sa&&(q(this,Se,e),P(this,Re)&&P(this,Re).composer.setMainCamera(e))}get renderer(){return P(this,ne)}get controls(){return P(this,qe)}get domElement(){return P(this,_t)}get ambientLight(){return P(this,Ut)}get directionLight(){return P(this,kt)}get postprocessing(){return P(this,Re)}set cache(e){Il.enabled=e}get textureManager(){return P(this,zn)}get renderEnabled(){return P(this,yt)}setDefaultLight(e){e._add(P(this,Ut).clone(),P(this,kt).clone())}initComposer(){q(this,Re,new nu(P(this,ne),P(this,ve),P(this,Se))),this.postprocessing.hueSaturationEffect.saturation=.25,this.postprocessing.brightnessContrastEffect.contrast=.25,P(this,bt).set(Symbol(),P(this,Re).resize)}initStats(){q(this,ms,new Ks),document.body.appendChild(P(this,ms).dom),P(this,wt).set(Symbol(),e=>P(e,ms).update())}initGridHelper(){const e=new oa(100);P(this,ve).add(e)}initAxesHelper(){const e=new aa(100);P(this,ve).add(e)}animate(){q(this,gs,requestAnimationFrame(this.animate.bind(this))),this.delta=this.clock.getDelta(),this.elapsedTime=this.clock.getElapsedTime(),P(this,wt).forEach(e=>e(this)),P(this,ne).info.reset(),this.render()}logMemory(){console.log(P(this,ne).info.memory.geometries,P(this,ne).info.memory.textures)}logWebGLResources(){var t;const e=P(this,ne).info;console.log("=== WebGL资源使用情况 ==="),console.log("几何体数量:",e.memory.geometries),console.log("纹理数量:",e.memory.textures),console.log("着色器程序数量:",((t=e.programs)==null?void 0:t.length)||0),console.log("渲染调用次数:",e.render.calls),console.log("三角形数量:",e.render.triangles),console.log("点数量:",e.render.points),console.log("线数量:",e.render.lines),console.log("========================")}forceCleanupWebGLResources(){console.log("=== 开始强制清理WebGL资源 ==="),this.textureManager&&this.textureManager.clearAll(),this.scene&&this.scene.traverse(e=>{e.isMesh&&(e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>{this.disposeMaterial(t)}):this.disposeMaterial(e.material))),e.isLight&&(this.scene.remove(e),e.dispose&&e.dispose())}),P(this,ne).info.reset(),window.gc&&window.gc(),console.log("=== WebGL资源强制清理完成 ==="),this.logWebGLResources()}disposeMaterial(e){if(!e)return;["map","normalMap","emissiveMap","specularMap","roughnessMap","metalnessMap","alphaMap","envMap","lightMap","aoMap","displacementMap","bumpMap"].forEach(s=>{e[s]&&(e[s].dispose(),e[s]=null)}),e.dispose()}render(){P(this,Re)?P(this,Re).composer.render():(P(this,ne).autoClear=!0,P(this,ne).render(P(this,ve),P(this,Se))),P(this,Kt).update(this)}stopRender(){cancelAnimationFrame(P(this,gs)),q(this,yt,!1),this.controls.enabled=!1}beginRender(){P(this,yt)||(this.animate(),this.controls.enabled=!0,q(this,yt,!0))}}ve=new WeakMap,ne=new WeakMap,Se=new WeakMap,Zs=new WeakMap,qe=new WeakMap,_t=new WeakMap,Re=new WeakMap,yt=new WeakMap,Ut=new WeakMap,kt=new WeakMap,ms=new WeakMap,bt=new WeakMap,wt=new WeakMap,Kt=new WeakMap,zn=new WeakMap,gs=new WeakMap,Vn=new WeakSet,Fa=function(){const e=new rr(16777215,.55),t=new us(16777215,3);t.shadow.camera.near=1,t.shadow.camera.far=1500,t.shadow.camera.right=500,t.shadow.camera.left=-500,t.shadow.camera.top=500,t.shadow.camera.bottom=-500,t.shadow.mapSize.width=Math.pow(2,13),t.shadow.mapSize.height=Math.pow(2,13),t.shadow.blurSamples=16,t.shadow.bias=-25e-5,t.position.set(30,385,585),t.castShadow=!0,q(this,Ut,e),P(this,ve).add(P(this,Ut)),new or(t.shadow.camera),new Rn(t),q(this,kt,t),P(this,ve).add(P(this,kt))};var St;class cu extends lu{constructor(t){super(t);Y(this,St);q(this,St,new Map)}addEventListener(t){const s=P(this,St).get(t)||[],i=a=>{la().length>0||s.forEach(l=>l(a,this))},r=()=>{window.removeEventListener(t,i),s.length=0,P(this,St).delete(t)},o=a=>s.indexOf(a)!==-1?()=>{const h=s.indexOf(a);s.splice(h,1)}:(s.push(a),()=>{const h=s.indexOf(a);s.splice(h,1),s.length===0&&r()});return P(this,St).has(t)||(P(this,St).set(t,s),window.addEventListener(t,i)),{add:o,clear:r}}}St=new WeakMap;class ur extends Ae{constructor(e=document.createElement("div")){super(),this.isCSS2DObject=!0,this.element=e,this.element.style.position="absolute",this.element.style.userSelect="none",this.element.setAttribute("draggable",!1),this.center=new N(.5,.5),this.addEventListener("removed",function(){this.traverse(function(t){t.element instanceof Element&&t.element.parentNode!==null&&t.element.parentNode.removeChild(t.element)})})}copy(e,t){return super.copy(e,t),this.element=e.element.cloneNode(!0),this.center=e.center,this}}const Yt=new M,$r=new oe,eo=new oe,to=new M,so=new M;class hu{constructor(e={}){const t=this;let s,i,r,o;const a={objects:new WeakMap},l=e.element!==void 0?e.element:document.createElement("div");l.style.overflow="hidden",this.domElement=l,this.getSize=function(){return{width:s,height:i}},this.render=function(f,p){f.matrixWorldAutoUpdate===!0&&f.updateMatrixWorld(),p.parent===null&&p.matrixWorldAutoUpdate===!0&&p.updateMatrixWorld(),$r.copy(p.matrixWorldInverse),eo.multiplyMatrices(p.projectionMatrix,$r),h(f,f,p),c(f)},this.setSize=function(f,p){s=f,i=p,r=s/2,o=i/2,l.style.width=f+"px",l.style.height=p+"px"};function h(f,p,B){if(f.isCSS2DObject){Yt.setFromMatrixPosition(f.matrixWorld),Yt.applyMatrix4(eo);const A=f.visible===!0&&Yt.z>=-1&&Yt.z<=1&&f.layers.test(B.layers)===!0;if(f.element.style.display=A===!0?"":"none",A===!0){f.onBeforeRender(t,p,B);const g=f.element;g.style.transform="translate("+-100*f.center.x+"%,"+-100*f.center.y+"%)translate("+(Yt.x*r+r)+"px,"+(-Yt.y*o+o)+"px)",g.parentNode!==l&&l.appendChild(g),f.onAfterRender(t,p,B)}const m={distanceToCameraSquared:d(B,f)};a.objects.set(f,m)}for(let A=0,m=f.children.length;A<m;A++)h(f.children[A],p,B)}function d(f,p){return to.setFromMatrixPosition(f.matrixWorld),so.setFromMatrixPosition(p.matrixWorld),to.distanceToSquared(so)}function u(f){const p=[];return f.traverse(function(B){B.isCSS2DObject&&p.push(B)}),p}function c(f){const p=u(f).sort(function(A,m){if(A.renderOrder!==m.renderOrder)return m.renderOrder-A.renderOrder;const g=a.objects.get(A).distanceToCameraSquared,C=a.objects.get(m).distanceToCameraSquared;return g-C}),B=p.length;for(let A=0,m=p.length;A<m;A++)p[A].element.style.zIndex=B-A}}}const no=new M,uu=new Ws,io=new M,We=new oe,du=new oe;class fu{constructor(e={}){const t=this;let s,i,r,o;const a={camera:{style:""},objects:new WeakMap},l=e.element!==void 0?e.element:document.createElement("div");l.style.overflow="hidden",this.domElement=l;const h=document.createElement("div");h.style.transformOrigin="0 0",h.style.pointerEvents="none",l.appendChild(h);const d=document.createElement("div");d.style.transformStyle="preserve-3d",h.appendChild(d),this.getSize=function(){return{width:s,height:i}},this.render=function(B,A){const m=A.projectionMatrix.elements[5]*o;A.view&&A.view.enabled?(h.style.transform=`translate( ${-A.view.offsetX*(s/A.view.width)}px, ${-A.view.offsetY*(i/A.view.height)}px )`,h.style.transform+=`scale( ${A.view.fullWidth/A.view.width}, ${A.view.fullHeight/A.view.height} )`):h.style.transform="",B.matrixWorldAutoUpdate===!0&&B.updateMatrixWorld(),A.parent===null&&A.matrixWorldAutoUpdate===!0&&A.updateMatrixWorld();let g,C;A.isOrthographicCamera&&(g=-(A.right+A.left)/2,C=(A.top+A.bottom)/2);const E=A.view&&A.view.enabled?A.view.height/A.view.fullHeight:1,D=A.isOrthographicCamera?`scale( ${E} )scale(`+m+")translate("+u(g)+"px,"+u(C)+"px)"+c(A.matrixWorldInverse):`scale( ${E} )translateZ(`+m+"px)"+c(A.matrixWorldInverse),S=(A.isPerspectiveCamera?"perspective("+m+"px) ":"")+D+"translate("+r+"px,"+o+"px)";a.camera.style!==S&&(d.style.transform=S,a.camera.style=S),p(B,B,A)},this.setSize=function(B,A){s=B,i=A,r=s/2,o=i/2,l.style.width=B+"px",l.style.height=A+"px",h.style.width=B+"px",h.style.height=A+"px",d.style.width=B+"px",d.style.height=A+"px"};function u(B){return Math.abs(B)<1e-10?0:B}function c(B){const A=B.elements;return"matrix3d("+u(A[0])+","+u(-A[1])+","+u(A[2])+","+u(A[3])+","+u(A[4])+","+u(-A[5])+","+u(A[6])+","+u(A[7])+","+u(A[8])+","+u(-A[9])+","+u(A[10])+","+u(A[11])+","+u(A[12])+","+u(-A[13])+","+u(A[14])+","+u(A[15])+")"}function f(B){const A=B.elements;return"translate(-50%,-50%)"+("matrix3d("+u(A[0])+","+u(A[1])+","+u(A[2])+","+u(A[3])+","+u(-A[4])+","+u(-A[5])+","+u(-A[6])+","+u(-A[7])+","+u(A[8])+","+u(A[9])+","+u(A[10])+","+u(A[11])+","+u(A[12])+","+u(A[13])+","+u(A[14])+","+u(A[15])+")")}function p(B,A,m,g){if(B.isCSS3DObject){const C=B.visible===!0&&B.layers.test(m.layers)===!0;if(B.element.style.display=C===!0?"":"none",C===!0){B.onBeforeRender(t,A,m);let E;B.isCSS3DSprite?(We.copy(m.matrixWorldInverse),We.transpose(),B.rotation2D!==0&&We.multiply(du.makeRotationZ(B.rotation2D)),B.matrixWorld.decompose(no,uu,io),We.setPosition(no),We.scale(io),We.elements[3]=0,We.elements[7]=0,We.elements[11]=0,We.elements[15]=1,E=f(We)):E=f(B.matrixWorld);const D=B.element,b=a.objects.get(B);if(b===void 0||b.style!==E){D.style.transform=E;const S={style:E};a.objects.set(B,S)}D.parentNode!==d&&d.appendChild(D),B.onAfterRender(t,A,m)}}for(let C=0,E=B.children.length;C<E;C++)p(B.children[C],A,m)}}}class pu{constructor(e,t){O(this,"raycaster");O(this,"camera");O(this,"element");O(this,"mouse");O(this,"intersects");O(this,"callbackMap");O(this,"getIntersects",(e,t,s)=>{if(la().length>0||!this.getState(s))return;this.intersects.length=0;const{left:i,top:r,width:o,height:a}=this.element.getBoundingClientRect();this.mouse.x=(e.clientX-i)/o*2-1,this.mouse.y=-((e.clientY-r)/a)*2+1,this.raycaster.setFromCamera(this.mouse,this.camera),Array.isArray(t)?this.raycaster.intersectObjects(t,!0,this.intersects):this.raycaster.intersectObject(t,!0,this.intersects);const l=this.intersects.filter(h=>h.object.visible);this.callbackMap.get(t)[s].forEach(h=>h(l,e))});this.raycaster=new Gn,this.mouse=new N,this.camera=e,this.element=t,this.intersects=[],this.callbackMap=new Map,this._eventListeners=new Map,this.stateMap=new Map}set(e,t){this.camera=e,this.element=t}raycast(e,t,s){if(s){if(this.exist(t,e)){const i=this.callbackMap.get(t)[e];i.indexOf(s)===-1&&i.push(s)}else if(this.handleEvent(t,e,s),this.callbackMap.has(t)){const i=this.callbackMap.get(t);i[e]=i[e]||[],i[e].push(s)}else this.callbackMap.set(t,{[e]:[s]});return{clear:()=>this.clear(t,e,s),intersects:this.intersects}}}exist(e,t){return!!(this.callbackMap.has(e)&&this.callbackMap.get(e)[t])}handleEvent(e,t){const s=r=>this.getIntersects(r,e,t),i=()=>{this.element.removeEventListener(t,s)};if(this._eventListeners.has(e)){const r=this._eventListeners.get(e);r[t]=i}else this._eventListeners.set(e,{[t]:i});this.element.addEventListener(t,s)}clear(e,t,s){if(this.callbackMap.has(e)){const r=this.callbackMap.get(e),o=r[t],a=o.indexOf(s);if(a===-1)return;o.splice(a,1),o.length===0&&delete r[t],Reflect.ownKeys(r).length===0&&this.callbackMap.delete(e),this.intersects.length=0}const i=this._eventListeners.get(e);this.exist(e,t)||(i[t](),delete i[t]),Reflect.ownKeys(i).length===0&&this._eventListeners.delete(e)}setState(e,t){this.stateMap.set(e,t)}getState(e){return this.stateMap.has(e)?this.stateMap.get(e):!0}}const xa=0,Au=1,Bu=2,ro=2,fi=1.25,oo=1,Mn=6*4+4+4,$n=65535,mu=Math.pow(2,-24),pi=Symbol("SKIP_GENERATION");function gu(n){return n.index?n.index.count:n.attributes.position.count}function Ss(n){return gu(n)/3}function Cu(n,e=ArrayBuffer){return n>65535?new Uint32Array(new e(4*n)):new Uint16Array(new e(2*n))}function Eu(n,e){if(!n.index){const t=n.attributes.position.count,s=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,i=Cu(t,s);n.setIndex(new ie(i,1));for(let r=0;r<t;r++)i[r]=r}}function Ia(n){const e=Ss(n),t=n.drawRange,s=t.start/3,i=(t.start+t.count)/3,r=Math.max(0,s),o=Math.min(e,i)-r;return[{offset:Math.floor(r),count:Math.floor(o)}]}function La(n){if(!n.groups||!n.groups.length)return Ia(n);const e=[],t=new Set,s=n.drawRange,i=s.start/3,r=(s.start+s.count)/3;for(const a of n.groups){const l=a.start/3,h=(a.start+a.count)/3;t.add(Math.max(i,l)),t.add(Math.min(r,h))}const o=Array.from(t.values()).sort((a,l)=>a-l);for(let a=0;a<o.length-1;a++){const l=o[a],h=o[a+1];e.push({offset:Math.floor(l),count:Math.floor(h-l)})}return e}function Du(n){if(n.groups.length===0)return!1;const e=Ss(n),t=La(n).sort((r,o)=>r.offset-o.offset),s=t[t.length-1];s.count=Math.min(e-s.offset,s.count);let i=0;return t.forEach(({count:r})=>i+=r),e!==i}function re(n,e,t){return t.min.x=e[n],t.min.y=e[n+1],t.min.z=e[n+2],t.max.x=e[n+3],t.max.y=e[n+4],t.max.z=e[n+5],t}function vu(n){n[0]=n[1]=n[2]=1/0,n[3]=n[4]=n[5]=-1/0}function ao(n){let e=-1,t=-1/0;for(let s=0;s<3;s++){const i=n[s+3]-n[s];i>t&&(t=i,e=s)}return e}function lo(n,e){e.set(n)}function co(n,e,t){let s,i;for(let r=0;r<3;r++){const o=r+3;s=n[r],i=e[r],t[r]=s<i?s:i,s=n[o],i=e[o],t[o]=s>i?s:i}}function an(n,e,t){for(let s=0;s<3;s++){const i=e[n+2*s],r=e[n+2*s+1],o=i-r,a=i+r;o<t[s]&&(t[s]=o),a>t[s+3]&&(t[s+3]=a)}}function Ls(n){const e=n[3]-n[0],t=n[4]-n[1],s=n[5]-n[2];return 2*(e*t+t*s+s*e)}function Ai(n,e,t,s,i=null){let r=1/0,o=1/0,a=1/0,l=-1/0,h=-1/0,d=-1/0,u=1/0,c=1/0,f=1/0,p=-1/0,B=-1/0,A=-1/0;const m=i!==null;for(let g=e*6,C=(e+t)*6;g<C;g+=6){const E=n[g+0],D=n[g+1],b=E-D,S=E+D;b<r&&(r=b),S>l&&(l=S),m&&E<u&&(u=E),m&&E>p&&(p=E);const y=n[g+2],w=n[g+3],F=y-w,I=y+w;F<o&&(o=F),I>h&&(h=I),m&&y<c&&(c=y),m&&y>B&&(B=y);const T=n[g+4],L=n[g+5],x=T-L,R=T+L;x<a&&(a=x),R>d&&(d=R),m&&T<f&&(f=T),m&&T>A&&(A=T)}s[0]=r,s[1]=o,s[2]=a,s[3]=l,s[4]=h,s[5]=d,m&&(i[0]=u,i[1]=c,i[2]=f,i[3]=p,i[4]=B,i[5]=A)}function yu(n,e,t,s){let i=1/0,r=1/0,o=1/0,a=-1/0,l=-1/0,h=-1/0;for(let d=e*6,u=(e+t)*6;d<u;d+=6){const c=n[d+0];c<i&&(i=c),c>a&&(a=c);const f=n[d+2];f<r&&(r=f),f>l&&(l=f);const p=n[d+4];p<o&&(o=p),p>h&&(h=p)}s[0]=i,s[1]=r,s[2]=o,s[3]=a,s[4]=l,s[5]=h}function bu(n,e){vu(e);const t=n.attributes.position,s=n.index?n.index.array:null,i=Ss(n),r=new Float32Array(i*6),o=t.normalized,a=t.array,l=t.offset||0;let h=3;t.isInterleavedBufferAttribute&&(h=t.data.stride);const d=["getX","getY","getZ"];for(let u=0;u<i;u++){const c=u*3,f=u*6;let p=c+0,B=c+1,A=c+2;s&&(p=s[p],B=s[B],A=s[A]),o||(p=p*h+l,B=B*h+l,A=A*h+l);for(let m=0;m<3;m++){let g,C,E;o?(g=t[d[m]](p),C=t[d[m]](B),E=t[d[m]](A)):(g=a[p+m],C=a[B+m],E=a[A+m]);let D=g;C<D&&(D=C),E<D&&(D=E);let b=g;C>b&&(b=C),E>b&&(b=E);const S=(b-D)/2,y=m*2;r[f+y+0]=D+S,r[f+y+1]=S+(Math.abs(D)+S)*mu,D<e[m]&&(e[m]=D),b>e[m+3]&&(e[m+3]=b)}}return r}const ot=32,wu=(n,e)=>n.candidate-e.candidate,gt=new Array(ot).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),ln=new Float32Array(6);function Su(n,e,t,s,i,r){let o=-1,a=0;if(r===xa)o=ao(e),o!==-1&&(a=(e[o]+e[o+3])/2);else if(r===Au)o=ao(n),o!==-1&&(a=Mu(t,s,i,o));else if(r===Bu){const l=Ls(n);let h=fi*i;const d=s*6,u=(s+i)*6;for(let c=0;c<3;c++){const f=e[c],A=(e[c+3]-f)/ot;if(i<ot/4){const m=[...gt];m.length=i;let g=0;for(let E=d;E<u;E+=6,g++){const D=m[g];D.candidate=t[E+2*c],D.count=0;const{bounds:b,leftCacheBounds:S,rightCacheBounds:y}=D;for(let w=0;w<3;w++)y[w]=1/0,y[w+3]=-1/0,S[w]=1/0,S[w+3]=-1/0,b[w]=1/0,b[w+3]=-1/0;an(E,t,b)}m.sort(wu);let C=i;for(let E=0;E<C;E++){const D=m[E];for(;E+1<C&&m[E+1].candidate===D.candidate;)m.splice(E+1,1),C--}for(let E=d;E<u;E+=6){const D=t[E+2*c];for(let b=0;b<C;b++){const S=m[b];D>=S.candidate?an(E,t,S.rightCacheBounds):(an(E,t,S.leftCacheBounds),S.count++)}}for(let E=0;E<C;E++){const D=m[E],b=D.count,S=i-D.count,y=D.leftCacheBounds,w=D.rightCacheBounds;let F=0;b!==0&&(F=Ls(y)/l);let I=0;S!==0&&(I=Ls(w)/l);const T=oo+fi*(F*b+I*S);T<h&&(o=c,h=T,a=D.candidate)}}else{for(let C=0;C<ot;C++){const E=gt[C];E.count=0,E.candidate=f+A+C*A;const D=E.bounds;for(let b=0;b<3;b++)D[b]=1/0,D[b+3]=-1/0}for(let C=d;C<u;C+=6){let b=~~((t[C+2*c]-f)/A);b>=ot&&(b=ot-1);const S=gt[b];S.count++,an(C,t,S.bounds)}const m=gt[ot-1];lo(m.bounds,m.rightCacheBounds);for(let C=ot-2;C>=0;C--){const E=gt[C],D=gt[C+1];co(E.bounds,D.rightCacheBounds,E.rightCacheBounds)}let g=0;for(let C=0;C<ot-1;C++){const E=gt[C],D=E.count,b=E.bounds,y=gt[C+1].rightCacheBounds;D!==0&&(g===0?lo(b,ln):co(b,ln,ln)),g+=D;let w=0,F=0;g!==0&&(w=Ls(ln)/l);const I=i-g;I!==0&&(F=Ls(y)/l);const T=oo+fi*(w*g+F*I);T<h&&(o=c,h=T,a=E.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${r} used.`);return{axis:o,pos:a}}function Mu(n,e,t,s){let i=0;for(let r=e,o=e+t;r<o;r++)i+=n[r*6+s*2];return i/t}class cn{constructor(){}}function Tu(n,e,t,s,i,r){let o=s,a=s+i-1;const l=r.pos,h=r.axis*2;for(;;){for(;o<=a&&t[o*6+h]<l;)o++;for(;o<=a&&t[a*6+h]>=l;)a--;if(o<a){for(let d=0;d<3;d++){let u=e[o*3+d];e[o*3+d]=e[a*3+d],e[a*3+d]=u}for(let d=0;d<6;d++){let u=t[o*6+d];t[o*6+d]=t[a*6+d],t[a*6+d]=u}o++,a--}else return o}}function Fu(n,e,t,s,i,r){let o=s,a=s+i-1;const l=r.pos,h=r.axis*2;for(;;){for(;o<=a&&t[o*6+h]<l;)o++;for(;o<=a&&t[a*6+h]>=l;)a--;if(o<a){let d=n[o];n[o]=n[a],n[a]=d;for(let u=0;u<6;u++){let c=t[o*6+u];t[o*6+u]=t[a*6+u],t[a*6+u]=c}o++,a--}else return o}}function xu(n,e){const t=(n.index?n.index.count:n.attributes.position.count)/3,s=t>2**16,i=s?4:2,r=e?new SharedArrayBuffer(t*i):new ArrayBuffer(t*i),o=s?new Uint32Array(r):new Uint16Array(r);for(let a=0,l=o.length;a<l;a++)o[a]=a;return o}function Iu(n,e){const t=n.geometry,s=t.index?t.index.array:null,i=e.maxDepth,r=e.verbose,o=e.maxLeafTris,a=e.strategy,l=e.onProgress,h=Ss(t),d=n._indirectBuffer;let u=!1;const c=new Float32Array(6),f=new Float32Array(6),p=bu(t,c),B=e.indirect?Fu:Tu,A=[],m=e.indirect?Ia(t):La(t);if(m.length===1){const E=m[0],D=new cn;D.boundingData=c,yu(p,E.offset,E.count,f),C(D,E.offset,E.count,f),A.push(D)}else for(let E of m){const D=new cn;D.boundingData=new Float32Array(6),Ai(p,E.offset,E.count,D.boundingData,f),C(D,E.offset,E.count,f),A.push(D)}return A;function g(E){l&&l(E/h)}function C(E,D,b,S=null,y=0){if(!u&&y>=i&&(u=!0,r&&(console.warn(`MeshBVH: Max depth of ${i} reached when generating BVH. Consider increasing maxDepth.`),console.warn(t))),b<=o||y>=i)return g(D+b),E.offset=D,E.count=b,E;const w=Su(E.boundingData,S,p,D,b,a);if(w.axis===-1)return g(D+b),E.offset=D,E.count=b,E;const F=B(d,s,p,D,b,w);if(F===D||F===D+b)g(D+b),E.offset=D,E.count=b;else{E.splitAxis=w.axis;const I=new cn,T=D,L=F-D;E.left=I,I.boundingData=new Float32Array(6),Ai(p,T,L,I.boundingData,f),C(I,T,L,f,y+1);const x=new cn,R=F,H=b-L;E.right=x,x.boundingData=new Float32Array(6),Ai(p,R,H,x.boundingData,f),C(x,R,H,f,y+1)}return E}}function Lu(n,e){const t=n.geometry;e.indirect&&(n._indirectBuffer=xu(t,e.useSharedArrayBuffer),Du(t)&&!e.verbose&&console.warn('MeshBVH: Provided geometry contains groups that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),n._indirectBuffer||Eu(t,e);const s=Iu(n,e);let i,r,o;const a=[],l=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;for(let u=0;u<s.length;u++){const c=s[u];let f=h(c);const p=new l(Mn*f);i=new Float32Array(p),r=new Uint32Array(p),o=new Uint16Array(p),d(0,c),a.push(p)}n._roots=a;return;function h(u){return u.count?1:1+h(u.left)+h(u.right)}function d(u,c){const f=u/4,p=u/2,B=!!c.count,A=c.boundingData;for(let m=0;m<6;m++)i[f+m]=A[m];if(B){const m=c.offset,g=c.count;return r[f+6]=m,o[p+14]=g,o[p+15]=$n,u+Mn}else{const m=c.left,g=c.right,C=c.splitAxis;let E;if(E=d(u+Mn,m),E/4>Math.pow(2,32))throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return r[f+6]=E/4,E=d(E,g),r[f+7]=C,E}}}class dt{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,t){let s=1/0,i=-1/0;for(let r=0,o=e.length;r<o;r++){const l=e[r][t];s=l<s?l:s,i=l>i?l:i}this.min=s,this.max=i}setFromPoints(e,t){let s=1/0,i=-1/0;for(let r=0,o=t.length;r<o;r++){const a=t[r],l=e.dot(a);s=l<s?l:s,i=l>i?l:i}this.min=s,this.max=i}isSeparated(e){return this.min>e.max||e.min>this.max}}dt.prototype.setFromBox=function(){const n=new M;return function(t,s){const i=s.min,r=s.max;let o=1/0,a=-1/0;for(let l=0;l<=1;l++)for(let h=0;h<=1;h++)for(let d=0;d<=1;d++){n.x=i.x*l+r.x*(1-l),n.y=i.y*h+r.y*(1-h),n.z=i.z*d+r.z*(1-d);const u=t.dot(n);o=Math.min(u,o),a=Math.max(u,a)}this.min=o,this.max=a}}();const Pu=function(){const n=new M,e=new M,t=new M;return function(i,r,o){const a=i.start,l=n,h=r.start,d=e;t.subVectors(a,h),n.subVectors(i.end,i.start),e.subVectors(r.end,r.start);const u=t.dot(d),c=d.dot(l),f=d.dot(d),p=t.dot(l),A=l.dot(l)*f-c*c;let m,g;A!==0?m=(u*c-p*f)/A:m=0,g=(u+m*c)/f,o.x=m,o.y=g}}(),dr=function(){const n=new N,e=new M,t=new M;return function(i,r,o,a){Pu(i,r,n);let l=n.x,h=n.y;if(l>=0&&l<=1&&h>=0&&h<=1){i.at(l,o),r.at(h,a);return}else if(l>=0&&l<=1){h<0?r.at(0,a):r.at(1,a),i.closestPointToPoint(a,!0,o);return}else if(h>=0&&h<=1){l<0?i.at(0,o):i.at(1,o),r.closestPointToPoint(o,!0,a);return}else{let d;l<0?d=i.start:d=i.end;let u;h<0?u=r.start:u=r.end;const c=e,f=t;if(i.closestPointToPoint(u,!0,e),r.closestPointToPoint(d,!0,t),c.distanceToSquared(u)<=f.distanceToSquared(d)){o.copy(c),a.copy(u);return}else{o.copy(d),a.copy(f);return}}}}(),Hu=function(){const n=new M,e=new M,t=new sr,s=new et;return function(r,o){const{radius:a,center:l}=r,{a:h,b:d,c:u}=o;if(s.start=h,s.end=d,s.closestPointToPoint(l,!0,n).distanceTo(l)<=a||(s.start=h,s.end=u,s.closestPointToPoint(l,!0,n).distanceTo(l)<=a)||(s.start=d,s.end=u,s.closestPointToPoint(l,!0,n).distanceTo(l)<=a))return!0;const B=o.getPlane(t);if(Math.abs(B.distanceToPoint(l))<=a){const m=B.projectPoint(l,e);if(o.containsPoint(m))return!0}return!1}}(),Ru=1e-15;function Bi(n){return Math.abs(n)<Ru}class je extends _s{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new M),this.satBounds=new Array(4).fill().map(()=>new dt),this.points=[this.a,this.b,this.c],this.sphere=new ws,this.plane=new sr,this.needsUpdate=!0}intersectsSphere(e){return Hu(e,this)}update(){const e=this.a,t=this.b,s=this.c,i=this.points,r=this.satAxes,o=this.satBounds,a=r[0],l=o[0];this.getNormal(a),l.setFromPoints(a,i);const h=r[1],d=o[1];h.subVectors(e,t),d.setFromPoints(h,i);const u=r[2],c=o[2];u.subVectors(t,s),c.setFromPoints(u,i);const f=r[3],p=o[3];f.subVectors(s,e),p.setFromPoints(f,i),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(a,e),this.needsUpdate=!1}}je.prototype.closestPointToSegment=function(){const n=new M,e=new M,t=new et;return function(i,r=null,o=null){const{start:a,end:l}=i,h=this.points;let d,u=1/0;for(let c=0;c<3;c++){const f=(c+1)%3;t.start.copy(h[c]),t.end.copy(h[f]),dr(t,i,n,e),d=n.distanceToSquared(e),d<u&&(u=d,r&&r.copy(n),o&&o.copy(e))}return this.closestPointToPoint(a,n),d=a.distanceToSquared(n),d<u&&(u=d,r&&r.copy(n),o&&o.copy(a)),this.closestPointToPoint(l,n),d=l.distanceToSquared(n),d<u&&(u=d,r&&r.copy(n),o&&o.copy(l)),Math.sqrt(u)}}();je.prototype.intersectsTriangle=function(){const n=new je,e=new Array(3),t=new Array(3),s=new dt,i=new dt,r=new M,o=new M,a=new M,l=new M,h=new M,d=new et,u=new et,c=new et,f=new M;function p(B,A,m){const g=B.points;let C=0,E=-1;for(let D=0;D<3;D++){const{start:b,end:S}=d;b.copy(g[D]),S.copy(g[(D+1)%3]),d.delta(o);const y=Bi(A.distanceToPoint(b));if(Bi(A.normal.dot(o))&&y){m.copy(d),C=2;break}const w=A.intersectLine(d,f);if(!w&&y&&f.copy(b),(w||y)&&!Bi(f.distanceTo(S))){if(C<=1)(C===1?m.start:m.end).copy(f),y&&(E=C);else if(C>=2){(E===1?m.start:m.end).copy(f),C=2;break}if(C++,C===2&&E===-1)break}}return C}return function(A,m=null,g=!1){this.needsUpdate&&this.update(),A.isExtendedTriangle?A.needsUpdate&&A.update():(n.copy(A),n.update(),A=n);const C=this.plane,E=A.plane;if(Math.abs(C.normal.dot(E.normal))>1-1e-10){const D=this.satBounds,b=this.satAxes;t[0]=A.a,t[1]=A.b,t[2]=A.c;for(let w=0;w<4;w++){const F=D[w],I=b[w];if(s.setFromPoints(I,t),F.isSeparated(s))return!1}const S=A.satBounds,y=A.satAxes;e[0]=this.a,e[1]=this.b,e[2]=this.c;for(let w=0;w<4;w++){const F=S[w],I=y[w];if(s.setFromPoints(I,e),F.isSeparated(s))return!1}for(let w=0;w<4;w++){const F=b[w];for(let I=0;I<4;I++){const T=y[I];if(r.crossVectors(F,T),s.setFromPoints(r,e),i.setFromPoints(r,t),s.isSeparated(i))return!1}}return m&&(g||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),m.start.set(0,0,0),m.end.set(0,0,0)),!0}else{const D=p(this,E,u);if(D===1&&A.containsPoint(u.end))return m&&(m.start.copy(u.end),m.end.copy(u.end)),!0;if(D!==2)return!1;const b=p(A,C,c);if(b===1&&this.containsPoint(c.end))return m&&(m.start.copy(c.end),m.end.copy(c.end)),!0;if(b!==2)return!1;if(u.delta(a),c.delta(l),a.dot(l)<0){let L=c.start;c.start=c.end,c.end=L}const S=u.start.dot(a),y=u.end.dot(a),w=c.start.dot(a),F=c.end.dot(a),I=y<w,T=S<F;return S!==F&&w!==y&&I===T?!1:(m&&(h.subVectors(u.start,c.start),h.dot(a)>0?m.start.copy(u.start):m.start.copy(c.start),h.subVectors(u.end,c.end),h.dot(a)<0?m.end.copy(u.end):m.end.copy(c.end)),!0)}}}();je.prototype.distanceToPoint=function(){const n=new M;return function(t){return this.closestPointToPoint(t,n),t.distanceTo(n)}}();je.prototype.distanceToTriangle=function(){const n=new M,e=new M,t=["a","b","c"],s=new et,i=new et;return function(o,a=null,l=null){const h=a||l?s:null;if(this.intersectsTriangle(o,h))return(a||l)&&(a&&h.getCenter(a),l&&h.getCenter(l)),0;let d=1/0;for(let u=0;u<3;u++){let c;const f=t[u],p=o[f];this.closestPointToPoint(p,n),c=p.distanceToSquared(n),c<d&&(d=c,a&&a.copy(n),l&&l.copy(p));const B=this[f];o.closestPointToPoint(B,n),c=B.distanceToSquared(n),c<d&&(d=c,a&&a.copy(B),l&&l.copy(n))}for(let u=0;u<3;u++){const c=t[u],f=t[(u+1)%3];s.set(this[c],this[f]);for(let p=0;p<3;p++){const B=t[p],A=t[(p+1)%3];i.set(o[B],o[A]),dr(s,i,n,e);const m=n.distanceToSquared(e);m<d&&(d=m,a&&a.copy(n),l&&l.copy(e))}}return Math.sqrt(d)}}();class be{constructor(e,t,s){this.isOrientedBox=!0,this.min=new M,this.max=new M,this.matrix=new oe,this.invMatrix=new oe,this.points=new Array(8).fill().map(()=>new M),this.satAxes=new Array(3).fill().map(()=>new M),this.satBounds=new Array(3).fill().map(()=>new dt),this.alignedSatBounds=new Array(3).fill().map(()=>new dt),this.needsUpdate=!1,e&&this.min.copy(e),t&&this.max.copy(t),s&&this.matrix.copy(s)}set(e,t,s){this.min.copy(e),this.max.copy(t),this.matrix.copy(s),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}}be.prototype.update=function(){return function(){const e=this.matrix,t=this.min,s=this.max,i=this.points;for(let h=0;h<=1;h++)for(let d=0;d<=1;d++)for(let u=0;u<=1;u++){const c=1*h|2*d|4*u,f=i[c];f.x=h?s.x:t.x,f.y=d?s.y:t.y,f.z=u?s.z:t.z,f.applyMatrix4(e)}const r=this.satBounds,o=this.satAxes,a=i[0];for(let h=0;h<3;h++){const d=o[h],u=r[h],c=1<<h,f=i[c];d.subVectors(a,f),u.setFromPoints(d,i)}const l=this.alignedSatBounds;l[0].setFromPointsField(i,"x"),l[1].setFromPointsField(i,"y"),l[2].setFromPointsField(i,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}}();be.prototype.intersectsBox=function(){const n=new dt;return function(t){this.needsUpdate&&this.update();const s=t.min,i=t.max,r=this.satBounds,o=this.satAxes,a=this.alignedSatBounds;if(n.min=s.x,n.max=i.x,a[0].isSeparated(n)||(n.min=s.y,n.max=i.y,a[1].isSeparated(n))||(n.min=s.z,n.max=i.z,a[2].isSeparated(n)))return!1;for(let l=0;l<3;l++){const h=o[l],d=r[l];if(n.setFromBox(h,t),d.isSeparated(n))return!1}return!0}}();be.prototype.intersectsTriangle=function(){const n=new je,e=new Array(3),t=new dt,s=new dt,i=new M;return function(o){this.needsUpdate&&this.update(),o.isExtendedTriangle?o.needsUpdate&&o.update():(n.copy(o),n.update(),o=n);const a=this.satBounds,l=this.satAxes;e[0]=o.a,e[1]=o.b,e[2]=o.c;for(let c=0;c<3;c++){const f=a[c],p=l[c];if(t.setFromPoints(p,e),f.isSeparated(t))return!1}const h=o.satBounds,d=o.satAxes,u=this.points;for(let c=0;c<3;c++){const f=h[c],p=d[c];if(t.setFromPoints(p,u),f.isSeparated(t))return!1}for(let c=0;c<3;c++){const f=l[c];for(let p=0;p<4;p++){const B=d[p];if(i.crossVectors(f,B),t.setFromPoints(i,e),s.setFromPoints(i,u),t.isSeparated(s))return!1}}return!0}}();be.prototype.closestPointToPoint=function(){return function(e,t){return this.needsUpdate&&this.update(),t.copy(e).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),t}}();be.prototype.distanceToPoint=function(){const n=new M;return function(t){return this.closestPointToPoint(t,n),t.distanceTo(n)}}();be.prototype.distanceToBox=function(){const n=["x","y","z"],e=new Array(12).fill().map(()=>new et),t=new Array(12).fill().map(()=>new et),s=new M,i=new M;return function(o,a=0,l=null,h=null){if(this.needsUpdate&&this.update(),this.intersectsBox(o))return(l||h)&&(o.getCenter(i),this.closestPointToPoint(i,s),o.closestPointToPoint(s,i),l&&l.copy(s),h&&h.copy(i)),0;const d=a*a,u=o.min,c=o.max,f=this.points;let p=1/0;for(let A=0;A<8;A++){const m=f[A];i.copy(m).clamp(u,c);const g=m.distanceToSquared(i);if(g<p&&(p=g,l&&l.copy(m),h&&h.copy(i),g<d))return Math.sqrt(g)}let B=0;for(let A=0;A<3;A++)for(let m=0;m<=1;m++)for(let g=0;g<=1;g++){const C=(A+1)%3,E=(A+2)%3,D=m<<C|g<<E,b=1<<A|m<<C|g<<E,S=f[D],y=f[b];e[B].set(S,y);const F=n[A],I=n[C],T=n[E],L=t[B],x=L.start,R=L.end;x[F]=u[F],x[I]=m?u[I]:c[I],x[T]=g?u[T]:c[I],R[F]=c[F],R[I]=m?u[I]:c[I],R[T]=g?u[T]:c[I],B++}for(let A=0;A<=1;A++)for(let m=0;m<=1;m++)for(let g=0;g<=1;g++){i.x=A?c.x:u.x,i.y=m?c.y:u.y,i.z=g?c.z:u.z,this.closestPointToPoint(i,s);const C=i.distanceToSquared(s);if(C<p&&(p=C,l&&l.copy(s),h&&h.copy(i),C<d))return Math.sqrt(C)}for(let A=0;A<12;A++){const m=e[A];for(let g=0;g<12;g++){const C=t[g];dr(m,C,s,i);const E=s.distanceToSquared(i);if(E<p&&(p=E,l&&l.copy(s),h&&h.copy(i),E<d))return Math.sqrt(E)}}return Math.sqrt(p)}}();class fr{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){const e=this._primitives;return e.length===0?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}class Gu extends fr{constructor(){super(()=>new je)}}const Ne=new Gu;function xe(n,e){return e[n+15]===65535}function Ie(n,e){return e[n+6]}function _e(n,e){return e[n+14]}function Ue(n){return n+8}function ke(n,e){return e[n+6]}function Pa(n,e){return e[n+7]}class Ou{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const e=[];let t=null;this.setBuffer=s=>{t&&e.push(t),t=s,this.float32Array=new Float32Array(s),this.uint16Array=new Uint16Array(s),this.uint32Array=new Uint32Array(s)},this.clearBuffer=()=>{t=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,e.length!==0&&this.setBuffer(e.pop())}}}const te=new Ou;let Mt,cs;const qt=[],hn=new fr(()=>new ce);function Nu(n,e,t,s,i,r){Mt=hn.getPrimitive(),cs=hn.getPrimitive(),qt.push(Mt,cs),te.setBuffer(n._roots[e]);const o=Ki(0,n.geometry,t,s,i,r);te.clearBuffer(),hn.releasePrimitive(Mt),hn.releasePrimitive(cs),qt.pop(),qt.pop();const a=qt.length;return a>0&&(cs=qt[a-1],Mt=qt[a-2]),o}function Ki(n,e,t,s,i=null,r=0,o=0){const{float32Array:a,uint16Array:l,uint32Array:h}=te;let d=n*2;if(xe(d,l)){const c=Ie(n,h),f=_e(d,l);return re(n,a,Mt),s(c,f,!1,o,r+n,Mt)}else{let F=function(T){const{uint16Array:L,uint32Array:x}=te;let R=T*2;for(;!xe(R,L);)T=Ue(T),R=T*2;return Ie(T,x)},I=function(T){const{uint16Array:L,uint32Array:x}=te;let R=T*2;for(;!xe(R,L);)T=ke(T,x),R=T*2;return Ie(T,x)+_e(R,L)};const c=Ue(n),f=ke(n,h);let p=c,B=f,A,m,g,C;if(i&&(g=Mt,C=cs,re(p,a,g),re(B,a,C),A=i(g),m=i(C),m<A)){p=f,B=c;const T=A;A=m,m=T,g=C}g||(g=Mt,re(p,a,g));const E=xe(p*2,l),D=t(g,E,A,o+1,r+p);let b;if(D===ro){const T=F(p),x=I(p)-T;b=s(T,x,!0,o+1,r+p,g)}else b=D&&Ki(p,e,t,s,i,r,o+1);if(b)return!0;C=cs,re(B,a,C);const S=xe(B*2,l),y=t(C,S,m,o+1,r+B);let w;if(y===ro){const T=F(B),x=I(B)-T;w=s(T,x,!0,o+1,r+B,C)}else w=y&&Ki(B,e,t,s,i,r,o+1);return!!w}}const Ps=new M,mi=new M;function _u(n,e,t={},s=0,i=1/0){const r=s*s,o=i*i;let a=1/0,l=null;if(n.shapecast({boundsTraverseOrder:d=>(Ps.copy(e).clamp(d.min,d.max),Ps.distanceToSquared(e)),intersectsBounds:(d,u,c)=>c<a&&c<o,intersectsTriangle:(d,u)=>{d.closestPointToPoint(e,Ps);const c=e.distanceToSquared(Ps);return c<a&&(mi.copy(Ps),a=c,l=u),c<r}}),a===1/0)return null;const h=Math.sqrt(a);return t.point?t.point.copy(mi):t.point=mi.clone(),t.distance=h,t.faceIndex=l,t}const Zt=new M,Qt=new M,$t=new M,un=new N,dn=new N,fn=new N,ho=new M,uo=new M,fo=new M,pn=new M;function Uu(n,e,t,s,i,r){let o;return r===ls?o=n.intersectTriangle(s,t,e,!0,i):o=n.intersectTriangle(e,t,s,r!==Me,i),o===null?null:{distance:n.origin.distanceTo(i),point:i.clone()}}function ku(n,e,t,s,i,r,o,a,l){Zt.fromBufferAttribute(e,r),Qt.fromBufferAttribute(e,o),$t.fromBufferAttribute(e,a);const h=Uu(n,Zt,Qt,$t,pn,l);if(h){s&&(un.fromBufferAttribute(s,r),dn.fromBufferAttribute(s,o),fn.fromBufferAttribute(s,a),h.uv=_s.getInterpolation(pn,Zt,Qt,$t,un,dn,fn,new N)),i&&(un.fromBufferAttribute(i,r),dn.fromBufferAttribute(i,o),fn.fromBufferAttribute(i,a),h.uv1=_s.getInterpolation(pn,Zt,Qt,$t,un,dn,fn,new N)),t&&(ho.fromBufferAttribute(t,r),uo.fromBufferAttribute(t,o),fo.fromBufferAttribute(t,a),h.normal=_s.getInterpolation(pn,Zt,Qt,$t,ho,uo,fo,new M),h.normal.dot(n.direction)>0&&h.normal.multiplyScalar(-1));const d={a:r,b:o,c:a,normal:new M,materialIndex:0};_s.getNormal(Zt,Qt,$t,d.normal),h.face=d,h.faceIndex=r}return h}function ei(n,e,t,s,i){const r=s*3;let o=r+0,a=r+1,l=r+2;const h=n.index;n.index&&(o=h.getX(o),a=h.getX(a),l=h.getX(l));const{position:d,normal:u,uv:c,uv1:f}=n.attributes,p=ku(t,d,u,c,f,o,a,l,e);return p?(p.faceIndex=s,i&&i.push(p),p):null}function he(n,e,t,s){const i=n.a,r=n.b,o=n.c;let a=e,l=e+1,h=e+2;t&&(a=t.getX(a),l=t.getX(l),h=t.getX(h)),i.x=s.getX(a),i.y=s.getY(a),i.z=s.getZ(a),r.x=s.getX(l),r.y=s.getY(l),r.z=s.getZ(l),o.x=s.getX(h),o.y=s.getY(h),o.z=s.getZ(h)}function Ku(n,e,t,s,i,r){const{geometry:o,_indirectBuffer:a}=n;for(let l=s,h=s+i;l<h;l++)ei(o,e,t,l,r)}function Ju(n,e,t,s,i){const{geometry:r,_indirectBuffer:o}=n;let a=1/0,l=null;for(let h=s,d=s+i;h<d;h++){let u;u=ei(r,e,t,h),u&&u.distance<a&&(l=u,a=u.distance)}return l}function zu(n,e,t,s,i,r,o){const{geometry:a}=t,{index:l}=a,h=a.attributes.position;for(let d=n,u=e+n;d<u;d++){let c;if(c=d,he(o,c*3,l,h),o.needsUpdate=!0,s(o,c,i,r))return!0}return!1}function Vu(n,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=n.geometry,s=t.index?t.index.array:null,i=t.attributes.position;let r,o,a,l,h=0;const d=n._roots;for(let c=0,f=d.length;c<f;c++)r=d[c],o=new Uint32Array(r),a=new Uint16Array(r),l=new Float32Array(r),u(0,h),h+=r.byteLength;function u(c,f,p=!1){const B=c*2;if(a[B+15]===$n){const m=o[c+6],g=a[B+14];let C=1/0,E=1/0,D=1/0,b=-1/0,S=-1/0,y=-1/0;for(let w=3*m,F=3*(m+g);w<F;w++){let I=s[w];const T=i.getX(I),L=i.getY(I),x=i.getZ(I);T<C&&(C=T),T>b&&(b=T),L<E&&(E=L),L>S&&(S=L),x<D&&(D=x),x>y&&(y=x)}return l[c+0]!==C||l[c+1]!==E||l[c+2]!==D||l[c+3]!==b||l[c+4]!==S||l[c+5]!==y?(l[c+0]=C,l[c+1]=E,l[c+2]=D,l[c+3]=b,l[c+4]=S,l[c+5]=y,!0):!1}else{const m=c+8,g=o[c+6],C=m+f,E=g+f;let D=p,b=!1,S=!1;e?D||(b=e.has(C),S=e.has(E),D=!b&&!S):(b=!0,S=!0);const y=D||b,w=D||S;let F=!1;y&&(F=u(m,f,D));let I=!1;w&&(I=u(g,f,D));const T=F||I;if(T)for(let L=0;L<3;L++){const x=m+L,R=g+L,H=l[x],W=l[x+3],se=l[R],ae=l[R+3];l[c+L]=H<se?H:se,l[c+L+3]=W>ae?W:ae}return T}}}const po=new ce;function Lt(n,e,t,s){return re(n,e,po),t.intersectBox(po,s)}function ju(n,e,t,s,i,r){const{geometry:o,_indirectBuffer:a}=n;for(let l=s,h=s+i;l<h;l++){let d=a?a[l]:l;ei(o,e,t,d,r)}}function Wu(n,e,t,s,i){const{geometry:r,_indirectBuffer:o}=n;let a=1/0,l=null;for(let h=s,d=s+i;h<d;h++){let u;u=ei(r,e,t,o?o[h]:h),u&&u.distance<a&&(l=u,a=u.distance)}return l}function Xu(n,e,t,s,i,r,o){const{geometry:a}=t,{index:l}=a,h=a.attributes.position;for(let d=n,u=e+n;d<u;d++){let c;if(c=t.resolveTriangleIndex(d),he(o,c*3,l,h),o.needsUpdate=!0,s(o,c,i,r))return!0}return!1}const Ao=new M;function Yu(n,e,t,s,i){te.setBuffer(n._roots[e]),Ji(0,n,t,s,i),te.clearBuffer()}function Ji(n,e,t,s,i){const{float32Array:r,uint16Array:o,uint32Array:a}=te,l=n*2;if(xe(l,o)){const d=Ie(n,a),u=_e(l,o);Ku(e,t,s,d,u,i)}else{const d=Ue(n);Lt(d,r,s,Ao)&&Ji(d,e,t,s,i);const u=ke(n,a);Lt(u,r,s,Ao)&&Ji(u,e,t,s,i)}}const Bo=new M,qu=["x","y","z"];function Zu(n,e,t,s){te.setBuffer(n._roots[e]);const i=zi(0,n,t,s);return te.clearBuffer(),i}function zi(n,e,t,s){const{float32Array:i,uint16Array:r,uint32Array:o}=te;let a=n*2;if(xe(a,r)){const h=Ie(n,o),d=_e(a,r);return Ju(e,t,s,h,d)}else{const h=Pa(n,o),d=qu[h],c=s.direction[d]>=0;let f,p;c?(f=Ue(n),p=ke(n,o)):(f=ke(n,o),p=Ue(n));const A=Lt(f,i,s,Bo)?zi(f,e,t,s):null;if(A){const C=A.point[d];if(c?C<=i[p+h]:C>=i[p+h+3])return A}const g=Lt(p,i,s,Bo)?zi(p,e,t,s):null;return A&&g?A.distance<=g.distance?A:g:A||g||null}}const An=new ce,es=new je,ts=new je,Hs=new oe,mo=new be,Bn=new be;function Qu(n,e,t,s){te.setBuffer(n._roots[e]);const i=Vi(0,n,t,s);return te.clearBuffer(),i}function Vi(n,e,t,s,i=null){const{float32Array:r,uint16Array:o,uint32Array:a}=te;let l=n*2;if(i===null&&(t.boundingBox||t.computeBoundingBox(),mo.set(t.boundingBox.min,t.boundingBox.max,s),i=mo),xe(l,o)){const d=e.geometry,u=d.index,c=d.attributes.position,f=t.index,p=t.attributes.position,B=Ie(n,a),A=_e(l,o);if(Hs.copy(s).invert(),t.boundsTree)return re(n,r,Bn),Bn.matrix.copy(Hs),Bn.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:g=>Bn.intersectsBox(g),intersectsTriangle:g=>{g.a.applyMatrix4(s),g.b.applyMatrix4(s),g.c.applyMatrix4(s),g.needsUpdate=!0;for(let C=B*3,E=(A+B)*3;C<E;C+=3)if(he(ts,C,u,c),ts.needsUpdate=!0,g.intersectsTriangle(ts))return!0;return!1}});for(let m=B*3,g=(A+B)*3;m<g;m+=3){he(es,m,u,c),es.a.applyMatrix4(Hs),es.b.applyMatrix4(Hs),es.c.applyMatrix4(Hs),es.needsUpdate=!0;for(let C=0,E=f.count;C<E;C+=3)if(he(ts,C,f,p),ts.needsUpdate=!0,es.intersectsTriangle(ts))return!0}}else{const d=n+8,u=a[n+6];return re(d,r,An),!!(i.intersectsBox(An)&&Vi(d,e,t,s,i)||(re(u,r,An),i.intersectsBox(An)&&Vi(u,e,t,s,i)))}}const mn=new oe,gi=new be,Rs=new be,$u=new M,ed=new M,td=new M,sd=new M;function nd(n,e,t,s={},i={},r=0,o=1/0){e.boundingBox||e.computeBoundingBox(),gi.set(e.boundingBox.min,e.boundingBox.max,t),gi.needsUpdate=!0;const a=n.geometry,l=a.attributes.position,h=a.index,d=e.attributes.position,u=e.index,c=Ne.getPrimitive(),f=Ne.getPrimitive();let p=$u,B=ed,A=null,m=null;i&&(A=td,m=sd);let g=1/0,C=null,E=null;return mn.copy(t).invert(),Rs.matrix.copy(mn),n.shapecast({boundsTraverseOrder:D=>gi.distanceToBox(D),intersectsBounds:(D,b,S)=>S<g&&S<o?(b&&(Rs.min.copy(D.min),Rs.max.copy(D.max),Rs.needsUpdate=!0),!0):!1,intersectsRange:(D,b)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:y=>Rs.distanceToBox(y),intersectsBounds:(y,w,F)=>F<g&&F<o,intersectsRange:(y,w)=>{for(let F=y,I=y+w;F<I;F++){he(f,3*F,u,d),f.a.applyMatrix4(t),f.b.applyMatrix4(t),f.c.applyMatrix4(t),f.needsUpdate=!0;for(let T=D,L=D+b;T<L;T++){he(c,3*T,h,l),c.needsUpdate=!0;const x=c.distanceToTriangle(f,p,A);if(x<g&&(B.copy(p),m&&m.copy(A),g=x,C=T,E=F),x<r)return!0}}}});{const S=Ss(e);for(let y=0,w=S;y<w;y++){he(f,3*y,u,d),f.a.applyMatrix4(t),f.b.applyMatrix4(t),f.c.applyMatrix4(t),f.needsUpdate=!0;for(let F=D,I=D+b;F<I;F++){he(c,3*F,h,l),c.needsUpdate=!0;const T=c.distanceToTriangle(f,p,A);if(T<g&&(B.copy(p),m&&m.copy(A),g=T,C=F,E=y),T<r)return!0}}}}}),Ne.releasePrimitive(c),Ne.releasePrimitive(f),g===1/0?null:(s.point?s.point.copy(B):s.point=B.clone(),s.distance=g,s.faceIndex=C,i&&(i.point?i.point.copy(m):i.point=m.clone(),i.point.applyMatrix4(mn),B.applyMatrix4(mn),i.distance=B.sub(i.point).length(),i.faceIndex=E),s)}function id(n,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=n.geometry,s=t.index?t.index.array:null,i=t.attributes.position;let r,o,a,l,h=0;const d=n._roots;for(let c=0,f=d.length;c<f;c++)r=d[c],o=new Uint32Array(r),a=new Uint16Array(r),l=new Float32Array(r),u(0,h),h+=r.byteLength;function u(c,f,p=!1){const B=c*2;if(a[B+15]===$n){const m=o[c+6],g=a[B+14];let C=1/0,E=1/0,D=1/0,b=-1/0,S=-1/0,y=-1/0;for(let w=m,F=m+g;w<F;w++){const I=3*n.resolveTriangleIndex(w);for(let T=0;T<3;T++){let L=I+T;L=s?s[L]:L;const x=i.getX(L),R=i.getY(L),H=i.getZ(L);x<C&&(C=x),x>b&&(b=x),R<E&&(E=R),R>S&&(S=R),H<D&&(D=H),H>y&&(y=H)}}return l[c+0]!==C||l[c+1]!==E||l[c+2]!==D||l[c+3]!==b||l[c+4]!==S||l[c+5]!==y?(l[c+0]=C,l[c+1]=E,l[c+2]=D,l[c+3]=b,l[c+4]=S,l[c+5]=y,!0):!1}else{const m=c+8,g=o[c+6],C=m+f,E=g+f;let D=p,b=!1,S=!1;e?D||(b=e.has(C),S=e.has(E),D=!b&&!S):(b=!0,S=!0);const y=D||b,w=D||S;let F=!1;y&&(F=u(m,f,D));let I=!1;w&&(I=u(g,f,D));const T=F||I;if(T)for(let L=0;L<3;L++){const x=m+L,R=g+L,H=l[x],W=l[x+3],se=l[R],ae=l[R+3];l[c+L]=H<se?H:se,l[c+L+3]=W>ae?W:ae}return T}}}const go=new M;function rd(n,e,t,s,i){te.setBuffer(n._roots[e]),ji(0,n,t,s,i),te.clearBuffer()}function ji(n,e,t,s,i){const{float32Array:r,uint16Array:o,uint32Array:a}=te,l=n*2;if(xe(l,o)){const d=Ie(n,a),u=_e(l,o);ju(e,t,s,d,u,i)}else{const d=Ue(n);Lt(d,r,s,go)&&ji(d,e,t,s,i);const u=ke(n,a);Lt(u,r,s,go)&&ji(u,e,t,s,i)}}const Co=new M,od=["x","y","z"];function ad(n,e,t,s){te.setBuffer(n._roots[e]);const i=Wi(0,n,t,s);return te.clearBuffer(),i}function Wi(n,e,t,s){const{float32Array:i,uint16Array:r,uint32Array:o}=te;let a=n*2;if(xe(a,r)){const h=Ie(n,o),d=_e(a,r);return Wu(e,t,s,h,d)}else{const h=Pa(n,o),d=od[h],c=s.direction[d]>=0;let f,p;c?(f=Ue(n),p=ke(n,o)):(f=ke(n,o),p=Ue(n));const A=Lt(f,i,s,Co)?Wi(f,e,t,s):null;if(A){const C=A.point[d];if(c?C<=i[p+h]:C>=i[p+h+3])return A}const g=Lt(p,i,s,Co)?Wi(p,e,t,s):null;return A&&g?A.distance<=g.distance?A:g:A||g||null}}const gn=new ce,ss=new je,ns=new je,Gs=new oe,Eo=new be,Cn=new be;function ld(n,e,t,s){te.setBuffer(n._roots[e]);const i=Xi(0,n,t,s);return te.clearBuffer(),i}function Xi(n,e,t,s,i=null){const{float32Array:r,uint16Array:o,uint32Array:a}=te;let l=n*2;if(i===null&&(t.boundingBox||t.computeBoundingBox(),Eo.set(t.boundingBox.min,t.boundingBox.max,s),i=Eo),xe(l,o)){const d=e.geometry,u=d.index,c=d.attributes.position,f=t.index,p=t.attributes.position,B=Ie(n,a),A=_e(l,o);if(Gs.copy(s).invert(),t.boundsTree)return re(n,r,Cn),Cn.matrix.copy(Gs),Cn.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:g=>Cn.intersectsBox(g),intersectsTriangle:g=>{g.a.applyMatrix4(s),g.b.applyMatrix4(s),g.c.applyMatrix4(s),g.needsUpdate=!0;for(let C=B,E=A+B;C<E;C++)if(he(ns,3*e.resolveTriangleIndex(C),u,c),ns.needsUpdate=!0,g.intersectsTriangle(ns))return!0;return!1}});for(let m=B,g=A+B;m<g;m++){const C=e.resolveTriangleIndex(m);he(ss,3*C,u,c),ss.a.applyMatrix4(Gs),ss.b.applyMatrix4(Gs),ss.c.applyMatrix4(Gs),ss.needsUpdate=!0;for(let E=0,D=f.count;E<D;E+=3)if(he(ns,E,f,p),ns.needsUpdate=!0,ss.intersectsTriangle(ns))return!0}}else{const d=n+8,u=a[n+6];return re(d,r,gn),!!(i.intersectsBox(gn)&&Xi(d,e,t,s,i)||(re(u,r,gn),i.intersectsBox(gn)&&Xi(u,e,t,s,i)))}}const En=new oe,Ci=new be,Os=new be,cd=new M,hd=new M,ud=new M,dd=new M;function fd(n,e,t,s={},i={},r=0,o=1/0){e.boundingBox||e.computeBoundingBox(),Ci.set(e.boundingBox.min,e.boundingBox.max,t),Ci.needsUpdate=!0;const a=n.geometry,l=a.attributes.position,h=a.index,d=e.attributes.position,u=e.index,c=Ne.getPrimitive(),f=Ne.getPrimitive();let p=cd,B=hd,A=null,m=null;i&&(A=ud,m=dd);let g=1/0,C=null,E=null;return En.copy(t).invert(),Os.matrix.copy(En),n.shapecast({boundsTraverseOrder:D=>Ci.distanceToBox(D),intersectsBounds:(D,b,S)=>S<g&&S<o?(b&&(Os.min.copy(D.min),Os.max.copy(D.max),Os.needsUpdate=!0),!0):!1,intersectsRange:(D,b)=>{if(e.boundsTree){const S=e.boundsTree;return S.shapecast({boundsTraverseOrder:y=>Os.distanceToBox(y),intersectsBounds:(y,w,F)=>F<g&&F<o,intersectsRange:(y,w)=>{for(let F=y,I=y+w;F<I;F++){const T=S.resolveTriangleIndex(F);he(f,3*T,u,d),f.a.applyMatrix4(t),f.b.applyMatrix4(t),f.c.applyMatrix4(t),f.needsUpdate=!0;for(let L=D,x=D+b;L<x;L++){const R=n.resolveTriangleIndex(L);he(c,3*R,h,l),c.needsUpdate=!0;const H=c.distanceToTriangle(f,p,A);if(H<g&&(B.copy(p),m&&m.copy(A),g=H,C=L,E=F),H<r)return!0}}}})}else{const S=Ss(e);for(let y=0,w=S;y<w;y++){he(f,3*y,u,d),f.a.applyMatrix4(t),f.b.applyMatrix4(t),f.c.applyMatrix4(t),f.needsUpdate=!0;for(let F=D,I=D+b;F<I;F++){const T=n.resolveTriangleIndex(F);he(c,3*T,h,l),c.needsUpdate=!0;const L=c.distanceToTriangle(f,p,A);if(L<g&&(B.copy(p),m&&m.copy(A),g=L,C=F,E=y),L<r)return!0}}}}}),Ne.releasePrimitive(c),Ne.releasePrimitive(f),g===1/0?null:(s.point?s.point.copy(B):s.point=B.clone(),s.distance=g,s.faceIndex=C,i&&(i.point?i.point.copy(m):i.point=m.clone(),i.point.applyMatrix4(En),B.applyMatrix4(En),i.distance=B.sub(i.point).length(),i.faceIndex=E),s)}function pd(){return typeof SharedArrayBuffer<"u"}const zs=new te.constructor,_n=new te.constructor,Et=new fr(()=>new ce),is=new ce,rs=new ce,Ei=new ce,Di=new ce;let vi=!1;function Ad(n,e,t,s){if(vi)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");vi=!0;const i=n._roots,r=e._roots;let o,a=0,l=0;const h=new oe().copy(t).invert();for(let d=0,u=i.length;d<u;d++){zs.setBuffer(i[d]),l=0;const c=Et.getPrimitive();re(0,zs.float32Array,c),c.applyMatrix4(h);for(let f=0,p=r.length;f<p&&(_n.setBuffer(r[d]),o=ze(0,0,t,h,s,a,l,0,0,c),_n.clearBuffer(),l+=r[f].length,!o);f++);if(Et.releasePrimitive(c),zs.clearBuffer(),a+=i[d].length,o)break}return vi=!1,o}function ze(n,e,t,s,i,r=0,o=0,a=0,l=0,h=null,d=!1){let u,c;d?(u=_n,c=zs):(u=zs,c=_n);const f=u.float32Array,p=u.uint32Array,B=u.uint16Array,A=c.float32Array,m=c.uint32Array,g=c.uint16Array,C=n*2,E=e*2,D=xe(C,B),b=xe(E,g);let S=!1;if(b&&D)d?S=i(Ie(e,m),_e(e*2,g),Ie(n,p),_e(n*2,B),l,o+e,a,r+n):S=i(Ie(n,p),_e(n*2,B),Ie(e,m),_e(e*2,g),a,r+n,l,o+e);else if(b){const y=Et.getPrimitive();re(e,A,y),y.applyMatrix4(t);const w=Ue(n),F=ke(n,p);re(w,f,is),re(F,f,rs);const I=y.intersectsBox(is),T=y.intersectsBox(rs);S=I&&ze(e,w,s,t,i,o,r,l,a+1,y,!d)||T&&ze(e,F,s,t,i,o,r,l,a+1,y,!d),Et.releasePrimitive(y)}else{const y=Ue(e),w=ke(e,m);re(y,A,Ei),re(w,A,Di);const F=h.intersectsBox(Ei),I=h.intersectsBox(Di);if(F&&I)S=ze(n,y,t,s,i,r,o,a,l+1,h,d)||ze(n,w,t,s,i,r,o,a,l+1,h,d);else if(F)if(D)S=ze(n,y,t,s,i,r,o,a,l+1,h,d);else{const T=Et.getPrimitive();T.copy(Ei).applyMatrix4(t);const L=Ue(n),x=ke(n,p);re(L,f,is),re(x,f,rs);const R=T.intersectsBox(is),H=T.intersectsBox(rs);S=R&&ze(y,L,s,t,i,o,r,l,a+1,T,!d)||H&&ze(y,x,s,t,i,o,r,l,a+1,T,!d),Et.releasePrimitive(T)}else if(I)if(D)S=ze(n,w,t,s,i,r,o,a,l+1,h,d);else{const T=Et.getPrimitive();T.copy(Di).applyMatrix4(t);const L=Ue(n),x=ke(n,p);re(L,f,is),re(x,f,rs);const R=T.intersectsBox(is),H=T.intersectsBox(rs);S=R&&ze(w,L,s,t,i,o,r,l,a+1,T,!d)||H&&ze(w,x,s,t,i,o,r,l,a+1,T,!d),Et.releasePrimitive(T)}}return S}const Dn=new be,Do=new ce;class pr{static serialize(e,t={}){t={cloneBuffers:!0,...t};const s=e.geometry,i=e._roots,r=e._indirectBuffer,o=s.getIndex();let a;return t.cloneBuffers?a={roots:i.map(l=>l.slice()),index:o.array.slice(),indirectBuffer:r?r.slice():null}:a={roots:i,index:o.array,indirectBuffer:r},a}static deserialize(e,t,s={}){s={setIndex:!0,indirect:!!e.indirectBuffer,...s};const{index:i,roots:r,indirectBuffer:o}=e,a=new pr(t,{...s,[pi]:!0});if(a._roots=r,a._indirectBuffer=o||null,s.setIndex){const l=t.getIndex();if(l===null){const h=new ie(e.index,1,!1);t.setIndex(h)}else l.array!==i&&(l.array.set(i),l.needsUpdate=!0)}return a}get indirect(){return!!this._indirectBuffer}constructor(e,t={}){if(e.isBufferGeometry){if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("MeshBVH: Only BufferGeometries are supported.");if(t=Object.assign({strategy:xa,maxDepth:40,maxLeafTris:10,verbose:!0,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,[pi]:!1},t),t.useSharedArrayBuffer&&!pd())throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=e,this._roots=null,this._indirectBuffer=null,t[pi]||(Lu(this,t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new ce)));const{_indirectBuffer:s}=this;this.resolveTriangleIndex=t.indirect?i=>s[i]:i=>i}refit(e=null){return(this.indirect?id:Vu)(this,e)}traverse(e,t=0){const s=this._roots[t],i=new Uint32Array(s),r=new Uint16Array(s);o(0);function o(a,l=0){const h=a*2,d=r[h+15]===$n;if(d){const u=i[a+6],c=r[h+14];e(l,d,new Float32Array(s,a*4,6),u,c)}else{const u=a+Mn/4,c=i[a+6],f=i[a+7];e(l,d,new Float32Array(s,a*4,6),f)||(o(u,l+1),o(c,l+1))}}}raycast(e,t=Pn){const s=this._roots,i=this.geometry,r=[],o=t.isMaterial,a=Array.isArray(t),l=i.groups,h=o?t.side:t,d=this.indirect?rd:Yu;for(let u=0,c=s.length;u<c;u++){const f=a?t[l[u].materialIndex].side:h,p=r.length;if(d(this,u,f,e,r),a){const B=l[u].materialIndex;for(let A=p,m=r.length;A<m;A++)r[A].face.materialIndex=B}}return r}raycastFirst(e,t=Pn){const s=this._roots,i=this.geometry,r=t.isMaterial,o=Array.isArray(t);let a=null;const l=i.groups,h=r?t.side:t,d=this.indirect?ad:Zu;for(let u=0,c=s.length;u<c;u++){const f=o?t[l[u].materialIndex].side:h,p=d(this,u,f,e);p!=null&&(a==null||p.distance<a.distance)&&(a=p,o&&(p.face.materialIndex=l[u].materialIndex))}return a}intersectsGeometry(e,t){let s=!1;const i=this._roots,r=this.indirect?ld:Qu;for(let o=0,a=i.length;o<a&&(s=r(this,o,e,t),!s);o++);return s}shapecast(e){const t=Ne.getPrimitive(),s=this.indirect?Xu:zu;let{boundsTraverseOrder:i,intersectsBounds:r,intersectsRange:o,intersectsTriangle:a}=e;if(o&&a){const u=o;o=(c,f,p,B,A)=>u(c,f,p,B,A)?!0:s(c,f,this,a,p,B,t)}else o||(a?o=(u,c,f,p)=>s(u,c,this,a,f,p,t):o=(u,c,f)=>f);let l=!1,h=0;const d=this._roots;for(let u=0,c=d.length;u<c;u++){const f=d[u];if(l=Nu(this,u,r,o,i,h),l)break;h+=f.byteLength}return Ne.releasePrimitive(t),l}bvhcast(e,t,s){let{intersectsRanges:i,intersectsTriangles:r}=s;const o=Ne.getPrimitive(),a=this.geometry.index,l=this.geometry.attributes.position,h=this.indirect?p=>{const B=this.resolveTriangleIndex(p);he(o,B*3,a,l)}:p=>{he(o,p*3,a,l)},d=Ne.getPrimitive(),u=e.geometry.index,c=e.geometry.attributes.position,f=e.indirect?p=>{const B=e.resolveTriangleIndex(p);he(d,B*3,u,c)}:p=>{he(d,p*3,u,c)};if(r){const p=(B,A,m,g,C,E,D,b)=>{for(let S=m,y=m+g;S<y;S++){f(S),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let w=B,F=B+A;w<F;w++)if(h(w),o.needsUpdate=!0,r(o,d,w,S,C,E,D,b))return!0}return!1};if(i){const B=i;i=function(A,m,g,C,E,D,b,S){return B(A,m,g,C,E,D,b,S)?!0:p(A,m,g,C,E,D,b,S)}}else i=p}return Ad(this,e,t,i)}intersectsBox(e,t){return Dn.set(e.min,e.max,t),Dn.needsUpdate=!0,this.shapecast({intersectsBounds:s=>Dn.intersectsBox(s),intersectsTriangle:s=>Dn.intersectsTriangle(s)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,s={},i={},r=0,o=1/0){return(this.indirect?fd:nd)(this,e,t,s,i,r,o)}closestPointToPoint(e,t={},s=0,i=1/0){return _u(this,e,t,s,i)}getBoundingBox(e){return e.makeEmpty(),this._roots.forEach(s=>{re(0,new Float32Array(s),Do),e.union(Do)}),e}}function vo(n,e,t){return n===null||(n.point.applyMatrix4(e.matrixWorld),n.distance=n.point.distanceTo(t.ray.origin),n.object=e,n.distance<t.near||n.distance>t.far)?null:n}const yi=new ea,yo=new oe,Bd=K.prototype.raycast;function md(n,e){if(this.geometry.boundsTree){if(this.material===void 0)return;yo.copy(this.matrixWorld).invert(),yi.copy(n.ray).applyMatrix4(yo);const t=this.geometry.boundsTree;if(n.firstHitOnly===!0){const s=vo(t.raycastFirst(yi,this.material),this,n);s&&e.push(s)}else{const s=t.raycast(yi,this.material);for(let i=0,r=s.length;i<r;i++){const o=vo(s[i],this,n);o&&e.push(o)}}}else Bd.call(this,n,e)}function gd(n){return this.boundsTree=new pr(this,n),this.boundsTree}function Cd(){this.boundsTree=null}class Ed extends cu{constructor(t){super(t);O(this,"raycaster");this.initMeshBVH(),this.initTWEEN()}use(t){return t.register(this),t}memoryTrack(t){return t}initCSS2DRenderer(){const t=Symbol(),s=new hu;s.setSize(window.innerWidth,window.innerHeight),s.domElement.id="css2dRenderer",this.onRenderQueue.set(t,()=>s.render(this.scene,this.camera)),this.onresizeQueue.set(t,s.setSize),document.body.appendChild(s.domElement),this.initCSS2DRenderer=()=>{}}initCSS3DRenderer(){const t=Symbol(),s=new fu;s.setSize(window.innerWidth,window.innerHeight),s.domElement.id="css3dRenderer",this.onRenderQueue.set(t,()=>s.render(this.scene,this.camera)),this.onresizeQueue.set(t,s.setSize),document.body.appendChild(s.domElement),this.initCSS3DRenderer=()=>{}}initTWEEN(){this.onRenderQueue.set(Symbol(),()=>Ll())}initMeshBVH(){xt.prototype.computeBoundsTree=gd,xt.prototype.disposeBoundsTree=Cd,K.prototype.raycast=md,Gn.prototype.firstHitOnly=!0}initRaycaster(){this.raycaster=new pu(this.camera,this.domElement),this.initRaycaster=()=>{}}raycast(t,s,i){return this.raycaster||this.initRaycaster(),this.raycaster.raycast(t,s,i)}setRaycasterState(t,s){this.raycaster||this.initRaycaster(),this.raycaster.setState(t,s)}}class Dd extends Vt{constructor(){super();const e=new ee;e.name="extra",this._add(e),this.extra=e}_add(e){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this._add(arguments[t]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(e.parent!==null&&e.parent.remove(e),e.parent=this,this.children.push(e)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}add(e){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(e.parent!==null&&e.parent.remove(e),e.parent=this.extra,this.extra.children.push(e)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}dispose(){for(;this.extra.children.length;)this.extra.children.pop().deleteSelf()}}class vd{constructor(e){this.core=e,this.scene=new Dd}init(){}onEnter(){}onLeave(){}onLoaded(){}update(){}updateOrientation(){this.core.orientation.updateModules()}addEventListener(){}removeEventListener(){}changeWeather(){console.log("当前子系统未调用天气模块")}changeLighting(){console.log("当前子系统未调用天气模块")}setCameraState(){console.log("当前子系统没有相机漫游功能")}beginWander(){console.log("当前子系统没有第一人称漫游功能")}endWander(){console.log("当前子系统没有第一人称漫游功能")}initGridHelper(e=100){const t=new oa(e);this.scene.add(t)}initAxesHelper(e=100){const t=new aa(e);this.scene.add(t)}add(){this.scene.add(...arguments)}_add(){this.scene._add(...arguments)}dispose(){this.scene.dispose()}}function tt(n={},e,t){const{innerText:s,className:i,id:r,children:o=[]}=n,a=document.createElement("div");return s&&(a.innerText=s),i&&(a.className=i),r&&(a.id=r),a.title=s||"",o.forEach(l=>{a.appendChild(l)}),a.oncontextmenu=()=>!1,a}function Te(n,e){const t=new ur(n);return t.name=e,t}const yd=()=>{window.parent.postMessage({cmd:"onLoading"},"*")},bd=()=>{window.parent.postMessage({cmd:"onLoaded"},"*")},wd=n=>{window.parent.postMessage({cmd:"inspectionId",param:n},"*")},Sd=n=>{window.parent.postMessage({cmd:"personDetail",param:n},"*")},Ha=()=>{window.parent.postMessage({cmd:"closeDomDialog"},"*")},Md=n=>{window.parent.postMessage({cmd:"gatherCallBack",param:n},"*")},Ra=n=>{window.parent.postMessage({cmd:"web3dChangeIndoor",param:n},"*")},Td=n=>{window.parent.postMessage({cmd:"buildingDetail",param:{id:n}},"*")},Fd=n=>{window.parent.postMessage({cmd:"dbClickBuilding",param:n},"*")},xd=n=>{window.parent.postMessage({cmd:"cameraVideoId",param:n},"*")},Id=n=>{window.parent.postMessage({cmd:"switchByBuildingId",param:n},"*")},Ld=n=>{window.parent.postMessage({cmd:"clickUnion",param:n},"*")},Pd=n=>{window.parent.postMessage({cmd:"web3dModelsGroup",param:n},"*")},Hd=n=>{console.log("web3dSelectCode",n),window.parent.postMessage({cmd:"web3dSelectCode",param:n},"*")};class Rd{constructor(){this.scene=null,this.core=null,this.main=null,this.camera=null,this.controls=null,this.searchCameraId=null,this.cameraEquipSprite=null,this.inspectionEquipSprite=null,this.beaconEquipSprite=null,this.inspectionSystemEquipSprite=null,this.searchInspection=null,this.searchCameraIdNeed=null,this.searchInspectionSystemNeed=null,this.cherryArray=[]}onLoad(e,t){this.controls=e.controls,this.camera=e.camera,this.core=e,this.main=t,this.scene=e.scene,this.tweenControl=e.tweenControl,this.equipGroup=new ee,this.equipGroup.name="equip",this.scene.add(this.equipGroup),this.equip={camera:{},inspection:{},beacon:{},inspectionSystem:{}},this.cameraEquipSprite=this.generateLabel("/equip/camera.png"),this.inspectionEquipSprite=this.generateLabel("/equip/inspection.png"),this.beaconEquipSprite=this.generateLabel("/equip/beacon.png",.018),this.inspectionSystemEquipSprite=this.generateLabel("/equip/xunjianListOff.png",.04),this.chooseEquip={camera:this.cameraEquipSprite,inspection:this.inspectionEquipSprite,beacon:this.beaconEquipSprite,inspectionSystem:this.inspectionSystemEquipSprite}}has(e,t){return this.equip[t][e]}get(e,t){return this.equip[t][e]}del(e,t){this.get(e,t).deleteSelf(),delete this.equip[t][e]}searchEquip(e,t){if(!this.has(e,t))return!1;let s=this.has(e,t).position;if(this.core.tweenControl.lerpTo(s,50,1e3,new M(0,10,0)),t==="camera"&&(xd(e),this.searchCameraId=e),t==="inspectionSystem"){let i=new Oe().load("/equip/xunjianListOff.png"),r=new Oe().load("/equip/xunjianListOn.png");Object.entries(this.equip[t]).forEach(([o,a])=>{o==e?(a.children[0].material.map=r,a.children[0].visible=!0):a.children[0].material.map=i}),wd(e)}t!=="inspectionSystem"&&this.boardVisibleSingle(e,!0,t)}hideInspectionSystemIcon(e){const{visible:t,id:s}=e;if(this.has(s,"inspectionSystem")){let i=new Oe().load("/equip/xunjianListOff.png");this.get(s,"inspectionSystem").children[0].material.map=i,this.get(s,"inspectionSystem").children[0].visible=t,this.core.core.resetCamera()}}setSearchInspection(e){const{id:t,name:s,position:i}=e;this.searchInspection={id:t,name:s,position:i}}boardVisibleSingle(e,t,s){Object.entries(this.equip[s]).forEach(([i,r])=>{i==e?(r.children[0].visible=t,r.children[1].visible=t):r.children[1].visible=!t})}closeCameraDialog(e){this.equip.camera[e].children[1].visible=!1,this.searchCameraId=null}setCherryArray(e){this.cherryArray=e}cherryPick(){Object.values(this.equip.camera).map(e=>{this.cherryArray.includes("camera")?e.children[0].visible=!0:(e.children[0].visible=!1,e.children[1].visible=!1)}),Object.values(this.equip.beacon).map(e=>{this.cherryArray.includes("beacon")?e.children[0].visible=!0:(e.children[0].visible=!1,e.children[1].visible=!1)}),Object.values(this.equip.inspectionSystem).map(e=>{this.cherryArray.includes("inspectionSystem")?e.children[0].visible=!0:(e.children[0].visible=!1,e.children[1].visible=!1)})}clearEquipType(e){e.forEach(t=>{this.dispose(t)})}dataProcess(e,t){return new Promise(s=>{this.dispose(t),e.map((i,r)=>{const{position:o,id:a,name:l,originId:h,sceneType:d}=i;let u=new Ae,c=this.chooseEquip[t].clone();t==="inspectionSystem"&&(c=this.generateLabel("/equip/xunjianListOff.png")),c.typeName=t,c.name=a;let f=this.setPersonBoard({name:l,id:a},!1,this.boardClick());u.add(c),u.add(f),u.position.set(o.x,o.y,o.z),this.equipGroup.add(u),this.core.orientation.orientation3D.pointerArr.push(u),this.equip[t][a]=u,r===e.length-1&&(this.cherryPick(),s(i))})})}setPersonBoard(e,t=!1,s){let i=document.createElement("div"),r=document.createElement("div"),o=document.createElement("div"),a=document.createElement("div"),l=document.createElement("div");l.append(i),l.append(r),l.append(o),l.append(a),l.draggable=!1,r.className="beilu_three_Board_text_person_top",o.className="beilu_three_Board_text_person_bottom",l.className="beilu_three_Board_text_person",a.className="beilu_three_Board_text_person_bottom_down",i.append(e.name),s&&(i.onclick=()=>{s()});let h=Te(l,"board"+e.id);return h.visible=t,h}boardClick(){}generateLabel(e,t=.028){const s=new Oe().load(e),i=new ar({map:s,sizeAttenuation:!1,depthTest:!1,depthWrite:!1}),r=new On(i);return r.renderOrder=4,r.scale.set(t,t,t),r.center=new N(.5,0),r}hideCameraById(e){this.equip.camera[e].children[0].visible=!1,this.equip.camera[e].children[1].visible=!1}dispose(e){e==="camera"&&(this.searchCameraId=null);const t=Object.keys(this.equip[e]);for(let s=t.length-1;s>=0;s--)this.equip[e][t[s]].deleteSelf();this.equip[e]={}}disposeAll(){Object.values(this.equip.camera).forEach(e=>{e.deleteSelf()}),this.equip.camera={},Object.values(this.equip.inspection).forEach(e=>{e.deleteSelf()}),this.equip.inspection={},Object.values(this.equip.beacon).forEach(e=>{e.deleteSelf()}),this.equip.beacon={},Object.values(this.equip.inspectionSystem).forEach(e=>{e.deleteSelf()}),this.equip.inspectionSystem={}}}const V=new Rd;function Gd(n){let e=n.length,t=0;for(let s=0;s<e;s++)t+=n[s].cross(n[(s+1)%e]);return Math.abs(t/2)}function Od(n,e,t,s){const i=e.clone().sub(n),r=t.clone().sub(n),o=s.clone().sub(n),a=s.clone().sub(t),l=n.clone().sub(t),h=e.clone().sub(t),d=i.cross(r),u=i.cross(o),c=a.cross(l),f=a.cross(h),p=d*u,B=c*f;return p<0&&B<0?!0:d===0&&u===0&&c===0&&f===0?!(t.x>=n.x&&t.x>=e.x&&s.x>=n.x&&s.y>=e.x||t.x<=n.x&&t.x<=e.x&&s.x<=n.x&&s.y<=e.x):!1}function Nd(n,e){let t=n.length;if(t===0)return!1;if(t===1)return n[0].equals(e);for(let s=0;s<t-1;s++)if(Od(n[s],n[s+1],n[t-1],e))return!0;return!1}function _d(n){const e=[];for(let t=0;t<n.length;t++)e.push(n[t].x,n[t].y,n[t].z);return e}function Tn(n,e="x",t="y"){if(Array.isArray(n)){const s=[];return n.forEach(i=>s.push(Tn(i,e,t))),s}else{const s=new N;return s.x=n[e],s.y=n[t],s}}function bo(n){let e=0;for(let t=1;t<n.length;t++)e+=n[t].distanceTo(n[t-1]);return e}function Ud(n){let e=null;const t=new Proxy(n,{construct(s,i,r){return e||(e=Reflect.construct(s,i,r)),e}});return n.prototype.constructor=t,t}function bi(n,e=new M(1,1,1),t=new N(.5,.5)){const s=new Oe().load(n),i=new ar({map:s,sizeAttenuation:!1}),r=new On(i);return r.scale.copy(e),r.center.copy(t),r}class kd extends ur{constructor(){let e=document.createElement("div"),t=document.createElement("div"),s=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div");r.append(e),r.append(t),r.append(s),r.append(i),r.draggable=!1,t.className="beilu_three_Board_text_person_top",s.className="beilu_three_Board_text_person_bottom",r.className="red_three_Board_text_person",i.className="beilu_three_Board_text_person_bottom_down",super(r)}setInnerText(e){this.element.innerText=e}}class Kd extends ur{constructor(e,t){let s=document.createElement("div");s.className="ellipse-container",s.style.cursor="pointer",s.style.background="#3F35F2",s.draggable=!1,s.innerText=e.name,t&&(s.onclick=()=>{t(e.cluster)}),super(s),this.name="board"+e.id}}const Jd=Ud(kd);class Ms{constructor(){O(this,"order",2)}update(){console.log("构造函数缺少 update 方法")}}class zd{constructor(e){this.person=null,this.object3d=new Ae,this.object3d.name="personDanger",this.label=e.clone(),this.board=new Jd,this.dangerPersonInfo=null,this.object3d.add(this.label,this.board)}setAlarm(e){this.person=e,this.board.setInnerText(e.name);const t=e.position;this.object3d.position.copy(t),this.object3d.add(this.label,this.board)}clearAlarm(){this.object3d.removeFromParent(),this.board.element.parentNode.removeChild(this.board.element)}}const wi=new M(.03,.03,.03),wo={externalPerson:bi("/person/externalPerson.png",wi),insidePerson:bi("/person/insidePerson.png",wi),laborPerson:bi("/person/laborPerson.png",wi)};class Vd extends Ms{constructor(t){super();O(this,"gatherClick",t=>{this.core.ground.boxSelectStatus!==!0&&Md(t.map(s=>s.id)),this.clusterModule.disperseClusterOnEvent(t),this.update(this.orientation)});O(this,"disposeClusterGroup",()=>{le.dispose(this.clusterGroup.children),[...this.singleGroup.children].forEach(t=>{t.removeFromParent(),t.traverse(s=>{s.element&&s.element.parentNode&&s.element.parentNode.removeChild(s.element)})})});this.order=10,this.orientation=t,this.core=t.core,this.camera=t.core.camera,this.controls=t.core.controls,this.orientationLabels=new ee,this.orientationLabels.name="PersonLabel",this.labelSprite=null,this.warningPerson=null,this.personGroup={[$e.SCENE_TYPE.INDOOR]:{},[$e.SCENE_TYPE.OUTDOOR]:new ee},this.clusterModule=t.clusterModule,this.clusterGroup=new ee,this.clusterGroup.name="clusterGroup",this.singleGroup=new ee,this.singleGroup.name="singleGroup",this.pointerArr=[],this.personAlarm=new zd(wo.insidePerson),this.orientation.addUpdatable(this),this.personDangerData=null,this.hiddenAllPerson=!1}add(t){const s=this.personGroup[t.sceneType];if(t.sceneType===$e.SCENE_TYPE.INDOOR){const i=t.originId.slice(0,-3);s[i]||(s[i]={}),s[i][t.originId]||(s[i][t.originId]=new ee),s[i][t.originId].add(t.object3d)}else s.add(t.object3d)}create(t,s){const i=new Ae;i.name=t.id;const r=wo[t.typeName].clone();r.center.set(.5,0),r.name=t.id,r.renderOrder=10,i.add(r);const o=tt({innerText:t.name,className:`person-sprite-${t.typeName}`}),a=tt({className:"person-sprite-container",children:[o]}),l=Te(a);return l.classTypeName=`person-sprite-${t.typeName}`,l.position.y=0,l.center.set(.5,.2),i.add(l),t.id===this.orientation.followId?(s?i.position.copy(t.position):i.position.copy(this.orientation.followModule.from),this.orientation.followModule.to.copy(t.position),l.position.y=1.8):i.position.copy(t.position),i}delete(t){const s=this.orientation.get(t.id);le.dispose(s.object3d,!0)}updateData(t){if(this.orientation.followId!==t.id)return t.object3d.position.copy(t.position);t.object3d.position.equals(t.position)||this.orientation.followModule.createPath(t)}update(t){const s=t.clusterModule.clusterMap,i=t.clusterModule.singleData;if([...this.clusterGroup.children].forEach(o=>le.dispose(o,!0)),[...this.singleGroup.children].forEach(o=>{o.removeFromParent()}),this.pointerArr.length=0,i.map(o=>{this.singleGroup.add(o.object3d)}),s.forEach((o,a)=>{if(o.length===1&&this.singleGroup.add(o[0].object3d),o.length>1){const l=new Kd({name:o.length,id:a,cluster:o},this.gatherClick);l.position.copy(o.position),this.clusterGroup.add(l),this.pointerArr.push(l)}}),this.singleGroup.traverse(o=>{o.isPass||(o.visible=!0,o.element&&(o.element.style.display="block"))}),this.orientation.searchId){let o=this.orientation.get(this.orientation.searchId);const{originId:a,sceneType:l}=o,{sceneType:h,originId:d}=this.core.getCurrentOriginId();if(l!==h||l===0&&a!==d){if(this.orientation.followId)return this.orientation.search();this.orientation.clearSearch(),Ha()}else this.orientation.search()}this.setPointerArr(),this.hiddenAllPerson===!0&&this.setAllPersonVisible(!1),this.core.scene.add(this.singleGroup),this.core.scene.add(this.clusterGroup)}setPointerArr(){this.singleGroup&&this.singleGroup.children.forEach(t=>{this.pointerArr.push(t)}),V.equipGroup&&V.equipGroup.children.forEach(t=>{this.pointerArr.push(t)}),this.core.sceneType===1&&this.core.ground.pointerArr.forEach(t=>{this.pointerArr.push(t)})}setAllPersonVisible(t){this.singleGroup.traverse(s=>{s.visible=t}),this.clusterGroup.traverse(s=>{s.visible=t})}disposeAlarm(){le.dispose(this.personAlarm.object3d)}onCameraChange(){this.clusterModule.onCameraChange()}getCurrentPersonGroup(t,s=""){if(t===$e.SCENE_TYPE.OUTDOOR)return this.personGroup[t];{const i=s.slice(0,-3),r=this.personGroup[t][i];return r&&r[s]||null}}openDialog(t){}setDialogVisible(t){}closeDialog(){}setAlarmPerson(t){this.personDangerData=t}searchAlarmPerson(){this.personAlarm.setAlarm(this.personDangerData),this.core.scene._add(this.personAlarm.object3d),this.core.tweenControl.lerpTo(this.personAlarm.person.position,50,1e3,new M(0,10,0))}clearAlarmPerson(){this.personAlarm.clearAlarm(),this.personDangerData=null}}let So=3;const jd={S:80,M:160,L:240,XL:320,XXL:400};var Cs,vs,Ga,Oa;class Wd extends Ms{constructor(t){super();Y(this,vs);Y(this,Cs,!1);O(this,"pullFromCluster",t=>{t.isSingle=!0;const s=t.clusterId;if(!this.clusterMap.has(s))return;const i=this.clusterMap.get(s);for(let r=0;r<i.length;r++)if(i[r].id===t.id){i.splice(r,1);break}return this.singleData.push(t),t});O(this,"pushToCluster",t=>{t.isSingle=!1;const s=Q(this,vs,Oa).call(this,t.position,jd[this.level]/Math.sqrt(So));let i=[];this.clusterMap.has(s)?i=this.clusterMap.get(s):this.clusterMap.set(s,i),i.push(t),t.clusterId=s;for(let r=0;r<this.singleData.length;r++)if(this.singleData[r]===t){this.singleData.splice(r,1);break}return t.object3d.traverse(r=>{r.element&&(r.element.style.display="none")}),t});this.order=1,this.level="X",this.nearestDistance=100,this.orientation=t,this.orientation.addUpdatable(this),this.core=t.core,this.clusterMap=new Map,this.singleData=[],this.core.controls.addEventListener("change",s=>{this.onCameraChange(this.core.camera),this.update(this.orientation),this.orientation.orientation3D.update(this.orientation)})}get isActive(){return P(this,Cs)}setActive(t){q(this,Cs,t),this.orientation.updateModules()}setLevel(t){So=t,this.orientation.updateModules()}update(t){this.clear();const{sceneType:s,originId:i}=this.core.getCurrentOriginId(),r=t.getCurrentSceneData(s,i);if(P(this,Cs)){let o=[];r.forEach(a=>{a.isSingle?this.singleData.push(a):o.push(a)}),Q(this,vs,Ga).call(this,o)}else this.singleData=r;this.onCameraChange(this.core.camera)}onCameraChange(t){const s=t.position,i=s.y;let r;i<30?r="S":i<60?r="M":i<120?r="L":i<240?r="XL":r="XXL",this.level=r,this.clusterMap.forEach(a=>{s.distanceTo(a.position)<this.nearestDistance&&this.disperseClusterOnEvent(a)})}disperseClusterOnEvent(t){this.singleData.push(...t),t.length=0,t.position.set(0,0,0)}clear(){this.clusterMap.forEach(t=>{t.forEach(s=>s.clusterId=void 0)}),this.clusterMap.clear(),this.singleData=[]}}Cs=new WeakMap,vs=new WeakSet,Ga=function(t){t.forEach(this.pushToCluster),this.clusterMap.forEach(s=>{const i=new M;s.position=i,s.forEach(r=>i.add(r.position)),i.divideScalar(s.length)})},Oa=function(t,s){const i=o(t.x),r=o(t.z);function o(a){let l=parseInt(a/s),h=a%s;return h<0&&(h=-1),h>0&&(h=1),l+=h,l}return`${i}_${r}`};const ht=11102230246251565e-32,me=134217729,Xd=(3+8*ht)*ht;function Si(n,e,t,s,i){let r,o,a,l,h=e[0],d=s[0],u=0,c=0;d>h==d>-h?(r=h,h=e[++u]):(r=d,d=s[++c]);let f=0;if(u<n&&c<t)for(d>h==d>-h?(o=h+r,a=r-(o-h),h=e[++u]):(o=d+r,a=r-(o-d),d=s[++c]),r=o,a!==0&&(i[f++]=a);u<n&&c<t;)d>h==d>-h?(o=r+h,l=o-r,a=r-(o-l)+(h-l),h=e[++u]):(o=r+d,l=o-r,a=r-(o-l)+(d-l),d=s[++c]),r=o,a!==0&&(i[f++]=a);for(;u<n;)o=r+h,l=o-r,a=r-(o-l)+(h-l),h=e[++u],r=o,a!==0&&(i[f++]=a);for(;c<t;)o=r+d,l=o-r,a=r-(o-l)+(d-l),d=s[++c],r=o,a!==0&&(i[f++]=a);return(r!==0||f===0)&&(i[f++]=r),f}function Yd(n,e){let t=e[0];for(let s=1;s<n;s++)t+=e[s];return t}function Qs(n){return new Float64Array(n)}const qd=(3+16*ht)*ht,Zd=(2+12*ht)*ht,Qd=(9+64*ht)*ht*ht,os=Qs(4),Mo=Qs(8),To=Qs(12),Fo=Qs(16),De=Qs(4);function $d(n,e,t,s,i,r,o){let a,l,h,d,u,c,f,p,B,A,m,g,C,E,D,b,S,y;const w=n-i,F=t-i,I=e-r,T=s-r;E=w*T,c=me*w,f=c-(c-w),p=w-f,c=me*T,B=c-(c-T),A=T-B,D=p*A-(E-f*B-p*B-f*A),b=I*F,c=me*I,f=c-(c-I),p=I-f,c=me*F,B=c-(c-F),A=F-B,S=p*A-(b-f*B-p*B-f*A),m=D-S,u=D-m,os[0]=D-(m+u)+(u-S),g=E+m,u=g-E,C=E-(g-u)+(m-u),m=C-b,u=C-m,os[1]=C-(m+u)+(u-b),y=g+m,u=y-g,os[2]=g-(y-u)+(m-u),os[3]=y;let L=Yd(4,os),x=Zd*o;if(L>=x||-L>=x||(u=n-w,a=n-(w+u)+(u-i),u=t-F,h=t-(F+u)+(u-i),u=e-I,l=e-(I+u)+(u-r),u=s-T,d=s-(T+u)+(u-r),a===0&&l===0&&h===0&&d===0)||(x=Qd*o+Xd*Math.abs(L),L+=w*d+T*a-(I*h+F*l),L>=x||-L>=x))return L;E=a*T,c=me*a,f=c-(c-a),p=a-f,c=me*T,B=c-(c-T),A=T-B,D=p*A-(E-f*B-p*B-f*A),b=l*F,c=me*l,f=c-(c-l),p=l-f,c=me*F,B=c-(c-F),A=F-B,S=p*A-(b-f*B-p*B-f*A),m=D-S,u=D-m,De[0]=D-(m+u)+(u-S),g=E+m,u=g-E,C=E-(g-u)+(m-u),m=C-b,u=C-m,De[1]=C-(m+u)+(u-b),y=g+m,u=y-g,De[2]=g-(y-u)+(m-u),De[3]=y;const R=Si(4,os,4,De,Mo);E=w*d,c=me*w,f=c-(c-w),p=w-f,c=me*d,B=c-(c-d),A=d-B,D=p*A-(E-f*B-p*B-f*A),b=I*h,c=me*I,f=c-(c-I),p=I-f,c=me*h,B=c-(c-h),A=h-B,S=p*A-(b-f*B-p*B-f*A),m=D-S,u=D-m,De[0]=D-(m+u)+(u-S),g=E+m,u=g-E,C=E-(g-u)+(m-u),m=C-b,u=C-m,De[1]=C-(m+u)+(u-b),y=g+m,u=y-g,De[2]=g-(y-u)+(m-u),De[3]=y;const H=Si(R,Mo,4,De,To);E=a*d,c=me*a,f=c-(c-a),p=a-f,c=me*d,B=c-(c-d),A=d-B,D=p*A-(E-f*B-p*B-f*A),b=l*h,c=me*l,f=c-(c-l),p=l-f,c=me*h,B=c-(c-h),A=h-B,S=p*A-(b-f*B-p*B-f*A),m=D-S,u=D-m,De[0]=D-(m+u)+(u-S),g=E+m,u=g-E,C=E-(g-u)+(m-u),m=C-b,u=C-m,De[1]=C-(m+u)+(u-b),y=g+m,u=y-g,De[2]=g-(y-u)+(m-u),De[3]=y;const W=Si(H,To,4,De,Fo);return Fo[W-1]}function ef(n,e,t,s,i,r){const o=(e-r)*(t-i),a=(n-i)*(s-r),l=o-a,h=Math.abs(o+a);return Math.abs(l)>=qd*h?l:-$d(n,e,t,s,i,r,h)}function tf(n,e){var t,s,i=0,r,o,a,l,h,d,u,c=n[0],f=n[1],p=e.length;for(t=0;t<p;t++){s=0;var B=e[t],A=B.length-1;if(d=B[0],d[0]!==B[A][0]&&d[1]!==B[A][1])throw new Error("First and last coordinates in a ring must be the same");for(o=d[0]-c,a=d[1]-f,s;s<A;s++){if(u=B[s+1],l=u[0]-c,h=u[1]-f,a===0&&h===0){if(l<=0&&o>=0||o<=0&&l>=0)return 0}else if(h>=0&&a<=0||h<=0&&a>=0){if(r=ef(o,l,a,h,0,0),r===0)return 0;(r>0&&h>0&&a<=0||r<0&&h<=0&&a>0)&&i++}d=u,a=h,o=l}}return i%2!==0}const xo=new ce,vn=new M;class Na extends Pl{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";const e=[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],t=[-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],s=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(s),this.setAttribute("position",new Hr(e,3)),this.setAttribute("uv",new Hr(t,2))}applyMatrix4(e){const t=this.attributes.instanceStart,s=this.attributes.instanceEnd;return t!==void 0&&(t.applyMatrix4(e),s.applyMatrix4(e),t.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}setPositions(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const s=new Ni(t,6,1);return this.setAttribute("instanceStart",new Nt(s,3,0)),this.setAttribute("instanceEnd",new Nt(s,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const s=new Ni(t,6,1);return this.setAttribute("instanceColorStart",new Nt(s,3,0)),this.setAttribute("instanceColorEnd",new Nt(s,3,3)),this}fromWireframeGeometry(e){return this.setPositions(e.attributes.position.array),this}fromEdgesGeometry(e){return this.setPositions(e.attributes.position.array),this}fromMesh(e){return this.fromWireframeGeometry(new Hl(e.geometry)),this}fromLineSegments(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new ce);const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;e!==void 0&&t!==void 0&&(this.boundingBox.setFromBufferAttribute(e),xo.setFromBufferAttribute(t),this.boundingBox.union(xo))}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new ws),this.boundingBox===null&&this.computeBoundingBox();const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;if(e!==void 0&&t!==void 0){const s=this.boundingSphere.center;this.boundingBox.getCenter(s);let i=0;for(let r=0,o=e.count;r<o;r++)vn.fromBufferAttribute(e,r),i=Math.max(i,s.distanceToSquared(vn)),vn.fromBufferAttribute(t,r),i=Math.max(i,s.distanceToSquared(vn));this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}applyMatrix(e){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(e)}}Sn.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new N(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}};wn.line={uniforms:ca.merge([Sn.common,Sn.fog,Sn.line]),vertexShader:`
		#include <common>
		#include <color_pars_vertex>
		#include <fog_pars_vertex>
		#include <logdepthbuf_pars_vertex>
		#include <clipping_planes_pars_vertex>

		uniform float linewidth;
		uniform vec2 resolution;

		attribute vec3 instanceStart;
		attribute vec3 instanceEnd;

		attribute vec3 instanceColorStart;
		attribute vec3 instanceColorEnd;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#ifdef USE_DASH

			uniform float dashScale;
			attribute float instanceDistanceStart;
			attribute float instanceDistanceEnd;
			varying float vLineDistance;

		#endif

		void trimSegment( const in vec4 start, inout vec4 end ) {

			// trim end segment so it terminates between the camera plane and the near plane

			// conservative estimate of the near plane
			float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
			float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
			float nearEstimate = - 0.5 * b / a;

			float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

			end.xyz = mix( start.xyz, end.xyz, alpha );

		}

		void main() {

			#ifdef USE_COLOR

				vColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

			#endif

			#ifdef USE_DASH

				vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
				vUv = uv;

			#endif

			float aspect = resolution.x / resolution.y;

			// camera space
			vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
			vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

			#ifdef WORLD_UNITS

				worldStart = start.xyz;
				worldEnd = end.xyz;

			#else

				vUv = uv;

			#endif

			// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
			// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
			// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
			// perhaps there is a more elegant solution -- WestLangley

			bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

			if ( perspective ) {

				if ( start.z < 0.0 && end.z >= 0.0 ) {

					trimSegment( start, end );

				} else if ( end.z < 0.0 && start.z >= 0.0 ) {

					trimSegment( end, start );

				}

			}

			// clip space
			vec4 clipStart = projectionMatrix * start;
			vec4 clipEnd = projectionMatrix * end;

			// ndc space
			vec3 ndcStart = clipStart.xyz / clipStart.w;
			vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

			// direction
			vec2 dir = ndcEnd.xy - ndcStart.xy;

			// account for clip-space aspect ratio
			dir.x *= aspect;
			dir = normalize( dir );

			#ifdef WORLD_UNITS

				vec3 worldDir = normalize( end.xyz - start.xyz );
				vec3 tmpFwd = normalize( mix( start.xyz, end.xyz, 0.5 ) );
				vec3 worldUp = normalize( cross( worldDir, tmpFwd ) );
				vec3 worldFwd = cross( worldDir, worldUp );
				worldPos = position.y < 0.5 ? start: end;

				// height offset
				float hw = linewidth * 0.5;
				worldPos.xyz += position.x < 0.0 ? hw * worldUp : - hw * worldUp;

				// don't extend the line if we're rendering dashes because we
				// won't be rendering the endcaps
				#ifndef USE_DASH

					// cap extension
					worldPos.xyz += position.y < 0.5 ? - hw * worldDir : hw * worldDir;

					// add width to the box
					worldPos.xyz += worldFwd * hw;

					// endcaps
					if ( position.y > 1.0 || position.y < 0.0 ) {

						worldPos.xyz -= worldFwd * 2.0 * hw;

					}

				#endif

				// project the worldpos
				vec4 clip = projectionMatrix * worldPos;

				// shift the depth of the projected points so the line
				// segments overlap neatly
				vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
				clip.z = clipPose.z * clip.w;

			#else

				vec2 offset = vec2( dir.y, - dir.x );
				// undo aspect ratio adjustment
				dir.x /= aspect;
				offset.x /= aspect;

				// sign flip
				if ( position.x < 0.0 ) offset *= - 1.0;

				// endcaps
				if ( position.y < 0.0 ) {

					offset += - dir;

				} else if ( position.y > 1.0 ) {

					offset += dir;

				}

				// adjust for linewidth
				offset *= linewidth;

				// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
				offset /= resolution.y;

				// select end
				vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

				// back to clip space
				offset *= clip.w;

				clip.xy += offset;

			#endif

			gl_Position = clip;

			vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

			#include <logdepthbuf_vertex>
			#include <clipping_planes_vertex>
			#include <fog_vertex>

		}
		`,fragmentShader:`
		uniform vec3 diffuse;
		uniform float opacity;
		uniform float linewidth;

		#ifdef USE_DASH

			uniform float dashOffset;
			uniform float dashSize;
			uniform float gapSize;

		#endif

		varying float vLineDistance;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#include <common>
		#include <color_pars_fragment>
		#include <fog_pars_fragment>
		#include <logdepthbuf_pars_fragment>
		#include <clipping_planes_pars_fragment>

		vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

			float mua;
			float mub;

			vec3 p13 = p1 - p3;
			vec3 p43 = p4 - p3;

			vec3 p21 = p2 - p1;

			float d1343 = dot( p13, p43 );
			float d4321 = dot( p43, p21 );
			float d1321 = dot( p13, p21 );
			float d4343 = dot( p43, p43 );
			float d2121 = dot( p21, p21 );

			float denom = d2121 * d4343 - d4321 * d4321;

			float numer = d1343 * d4321 - d1321 * d4343;

			mua = numer / denom;
			mua = clamp( mua, 0.0, 1.0 );
			mub = ( d1343 + d4321 * ( mua ) ) / d4343;
			mub = clamp( mub, 0.0, 1.0 );

			return vec2( mua, mub );

		}

		void main() {

			#include <clipping_planes_fragment>

			#ifdef USE_DASH

				if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

				if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

			#endif

			float alpha = opacity;

			#ifdef WORLD_UNITS

				// Find the closest points on the view ray and the line segment
				vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
				vec3 lineDir = worldEnd - worldStart;
				vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

				vec3 p1 = worldStart + lineDir * params.x;
				vec3 p2 = rayEnd * params.y;
				vec3 delta = p1 - p2;
				float len = length( delta );
				float norm = len / linewidth;

				#ifndef USE_DASH

					#ifdef USE_ALPHA_TO_COVERAGE

						float dnorm = fwidth( norm );
						alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

					#else

						if ( norm > 0.5 ) {

							discard;

						}

					#endif

				#endif

			#else

				#ifdef USE_ALPHA_TO_COVERAGE

					// artifacts appear on some hardware if a derivative is taken within a conditional
					float a = vUv.x;
					float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
					float len2 = a * a + b * b;
					float dlen = fwidth( len2 );

					if ( abs( vUv.y ) > 1.0 ) {

						alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

					}

				#else

					if ( abs( vUv.y ) > 1.0 ) {

						float a = vUv.x;
						float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
						float len2 = a * a + b * b;

						if ( len2 > 1.0 ) discard;

					}

				#endif

			#endif

			vec4 diffuseColor = vec4( diffuse, alpha );

			#include <logdepthbuf_fragment>
			#include <color_fragment>

			gl_FragColor = vec4( diffuseColor.rgb, alpha );

			#include <tonemapping_fragment>
			#include <colorspace_fragment>
			#include <fog_fragment>
			#include <premultiplied_alpha_fragment>

		}
		`};class ti extends Be{constructor(e){super({type:"LineMaterial",uniforms:ca.clone(wn.line.uniforms),vertexShader:wn.line.vertexShader,fragmentShader:wn.line.fragmentShader,clipping:!0}),this.isLineMaterial=!0,this.setValues(e)}get color(){return this.uniforms.diffuse.value}set color(e){this.uniforms.diffuse.value=e}get worldUnits(){return"WORLD_UNITS"in this.defines}set worldUnits(e){e===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}get linewidth(){return this.uniforms.linewidth.value}set linewidth(e){this.uniforms.linewidth&&(this.uniforms.linewidth.value=e)}get dashed(){return"USE_DASH"in this.defines}set dashed(e){e===!0!==this.dashed&&(this.needsUpdate=!0),e===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}get dashScale(){return this.uniforms.dashScale.value}set dashScale(e){this.uniforms.dashScale.value=e}get dashSize(){return this.uniforms.dashSize.value}set dashSize(e){this.uniforms.dashSize.value=e}get dashOffset(){return this.uniforms.dashOffset.value}set dashOffset(e){this.uniforms.dashOffset.value=e}get gapSize(){return this.uniforms.gapSize.value}set gapSize(e){this.uniforms.gapSize.value=e}get opacity(){return this.uniforms.opacity.value}set opacity(e){this.uniforms&&(this.uniforms.opacity.value=e)}get resolution(){return this.uniforms.resolution.value}set resolution(e){this.uniforms.resolution.value.copy(e)}get alphaToCoverage(){return"USE_ALPHA_TO_COVERAGE"in this.defines}set alphaToCoverage(e){this.defines&&(e===!0!==this.alphaToCoverage&&(this.needsUpdate=!0),e===!0?this.defines.USE_ALPHA_TO_COVERAGE="":delete this.defines.USE_ALPHA_TO_COVERAGE)}}const Io=new M,Lo=new M,de=new It,fe=new It,Xe=new It,Mi=new M,Ti=new oe,pe=new et,Po=new M,yn=new ce,bn=new ws,Ye=new It;let Ze,Jt;function Ho(n,e,t){return Ye.set(0,0,-e,1).applyMatrix4(n.projectionMatrix),Ye.multiplyScalar(1/Ye.w),Ye.x=Jt/t.width,Ye.y=Jt/t.height,Ye.applyMatrix4(n.projectionMatrixInverse),Ye.multiplyScalar(1/Ye.w),Math.abs(Math.max(Ye.x,Ye.y))}function sf(n,e){const t=n.matrixWorld,s=n.geometry,i=s.attributes.instanceStart,r=s.attributes.instanceEnd,o=Math.min(s.instanceCount,i.count);for(let a=0,l=o;a<l;a++){pe.start.fromBufferAttribute(i,a),pe.end.fromBufferAttribute(r,a),pe.applyMatrix4(t);const h=new M,d=new M;Ze.distanceSqToSegment(pe.start,pe.end,d,h),d.distanceTo(h)<Jt*.5&&e.push({point:d,pointOnLine:h,distance:Ze.origin.distanceTo(d),object:n,face:null,faceIndex:a,uv:null,uv1:null})}}function nf(n,e,t){const s=e.projectionMatrix,r=n.material.resolution,o=n.matrixWorld,a=n.geometry,l=a.attributes.instanceStart,h=a.attributes.instanceEnd,d=Math.min(a.instanceCount,l.count),u=-e.near;Ze.at(1,Xe),Xe.w=1,Xe.applyMatrix4(e.matrixWorldInverse),Xe.applyMatrix4(s),Xe.multiplyScalar(1/Xe.w),Xe.x*=r.x/2,Xe.y*=r.y/2,Xe.z=0,Mi.copy(Xe),Ti.multiplyMatrices(e.matrixWorldInverse,o);for(let c=0,f=d;c<f;c++){if(de.fromBufferAttribute(l,c),fe.fromBufferAttribute(h,c),de.w=1,fe.w=1,de.applyMatrix4(Ti),fe.applyMatrix4(Ti),de.z>u&&fe.z>u)continue;if(de.z>u){const C=de.z-fe.z,E=(de.z-u)/C;de.lerp(fe,E)}else if(fe.z>u){const C=fe.z-de.z,E=(fe.z-u)/C;fe.lerp(de,E)}de.applyMatrix4(s),fe.applyMatrix4(s),de.multiplyScalar(1/de.w),fe.multiplyScalar(1/fe.w),de.x*=r.x/2,de.y*=r.y/2,fe.x*=r.x/2,fe.y*=r.y/2,pe.start.copy(de),pe.start.z=0,pe.end.copy(fe),pe.end.z=0;const B=pe.closestPointToPointParameter(Mi,!0);pe.at(B,Po);const A=nr.lerp(de.z,fe.z,B),m=A>=-1&&A<=1,g=Mi.distanceTo(Po)<Jt*.5;if(m&&g){pe.start.fromBufferAttribute(l,c),pe.end.fromBufferAttribute(h,c),pe.start.applyMatrix4(o),pe.end.applyMatrix4(o);const C=new M,E=new M;Ze.distanceSqToSegment(pe.start,pe.end,E,C),t.push({point:E,pointOnLine:C,distance:Ze.origin.distanceTo(E),object:n,face:null,faceIndex:c,uv:null,uv1:null})}}}class rf extends K{constructor(e=new Na,t=new ti({color:Math.random()*16777215})){super(e,t),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const e=this.geometry,t=e.attributes.instanceStart,s=e.attributes.instanceEnd,i=new Float32Array(2*t.count);for(let o=0,a=0,l=t.count;o<l;o++,a+=2)Io.fromBufferAttribute(t,o),Lo.fromBufferAttribute(s,o),i[a]=a===0?0:i[a-1],i[a+1]=i[a]+Io.distanceTo(Lo);const r=new Ni(i,2,1);return e.setAttribute("instanceDistanceStart",new Nt(r,1,0)),e.setAttribute("instanceDistanceEnd",new Nt(r,1,1)),this}raycast(e,t){const s=this.material.worldUnits,i=e.camera;i===null&&!s&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const r=e.params.Line2!==void 0&&e.params.Line2.threshold||0;Ze=e.ray;const o=this.matrixWorld,a=this.geometry,l=this.material;Jt=l.linewidth+r,a.boundingSphere===null&&a.computeBoundingSphere(),bn.copy(a.boundingSphere).applyMatrix4(o);let h;if(s)h=Jt*.5;else{const u=Math.max(i.near,bn.distanceToPoint(Ze.origin));h=Ho(i,u,l.resolution)}if(bn.radius+=h,Ze.intersectsSphere(bn)===!1)return;a.boundingBox===null&&a.computeBoundingBox(),yn.copy(a.boundingBox).applyMatrix4(o);let d;if(s)d=Jt*.5;else{const u=Math.max(i.near,yn.distanceToPoint(Ze.origin));d=Ho(i,u,l.resolution)}yn.expandByScalar(d),Ze.intersectsBox(yn)!==!1&&(s?sf(this,t):nf(this,i,t))}}class Ys extends Na{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}setPositions(e){const t=e.length-3,s=new Float32Array(2*t);for(let i=0;i<t;i+=3)s[2*i]=e[i],s[2*i+1]=e[i+1],s[2*i+2]=e[i+2],s[2*i+3]=e[i+3],s[2*i+4]=e[i+4],s[2*i+5]=e[i+5];return super.setPositions(s),this}setColors(e){const t=e.length-3,s=new Float32Array(2*t);for(let i=0;i<t;i+=3)s[2*i]=e[i],s[2*i+1]=e[i+1],s[2*i+2]=e[i+2],s[2*i+3]=e[i+3],s[2*i+4]=e[i+4],s[2*i+5]=e[i+5];return super.setColors(s),this}fromLine(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}}class Yi extends rf{constructor(e=new Ys,t=new ti({color:Math.random()*16777215})){super(e,t),this.isLine2=!0,this.type="Line2"}}const of=new Ys,Fn=new ti({color:16711935,linewidth:4,depthTest:!1,transparent:!0});Fn.resolution.set(window.innerWidth,window.innerHeight);var Ge;class Ar{constructor(e){Y(this,Ge);O(this,"points");O(this,"line");O(this,"moveLine");O(this,"count");O(this,"needToAdhereToFirstPoint");O(this,"closestDistanceToAdhere");O(this,"needCheckLinesCross");O(this,"isClosed");O(this,"movePoint");this.scene=e,this.needToAdhereToFirstPoint=!0,this.needCheckLinesCross=!1,this.closestDistanceToAdhere=0,this.points=[],this.count=0,this.isClosed=!1,q(this,Ge,!1),this.movePoint=new M,this._create(),this.moveLine.visible=!1,this.group=new ee,this.group.name="绘制组",this.group.add(this.line,this.moveLine),this.scene._add(this.group)}set active(e){P(this,Ge)!==e&&(q(this,Ge,e),e?this._create():this.end())}get active(){return P(this,Ge)}addPoint(e){if(P(this,Ge)){if(this.needCheckLinesCross&&Nd(Tn(this.points,"x","z"),Tn(e,"x","z"))){setTimeout(()=>{alert("相交了,操作无效")},0),console.log("相交了,操作无效");return}this.needToAdhereToFirstPoint&&this.count>1&&e.equals(this.points[0])&&(this.isClosed=!0),this.points.push(e),this.count++,this.updateLine(),this.updateMoveLine(e),this.line.parent||this.group.add(this.line,this.moveLine)}}end(){this.moveLine&&(this.moveLine.deleteSelf(),this.moveLine=null)}deletePoint(){P(this,Ge)&&this.points.length&&(this.points.pop(),this.count--,this.updateLine(),this.updateMoveLine())}_create(){this.line=new Yi(void 0,Fn),this.moveLine=new Yi(new Ys().setPositions([0,0,0,0,0,0]),Fn)}getLength(e=2){return parseFloat(bo(this.points).toFixed(e))}getTotalLength(e=2){return parseFloat(bo([...this.points,this.movePoint]).toFixed(e))}getArea(e=2){return this.isClosed?parseFloat(Gd(Tn(this.points,"x","z")).toFixed(e)):0}getCenter(e=new M){const t=e;return this.points.forEach(s=>{t.addScaledVector(s,1/this.points.length)}),t}onresize(e,t){Fn.resolution.set(e,t)}updateMoveLine(e){if(P(this,Ge))if(this.count){const{x:t,y:s,z:i}=this.points[this.count-1];if(e===void 0){const r=this.moveLine.geometry.attributes.instanceStart.data.array;this.moveLine.geometry.setPositions([t,s,i,r[3],r[4],r[5]])}else{if(this.movePoint.copy(e),this.needToAdhereToFirstPoint){const r=this.points[0];e.distanceTo(r)<this.closestDistanceToAdhere&&e.copy(r)}this.moveLine.geometry.setPositions([t,s,i,e.x,e.y,e.z]),this.moveLine.visible=!0}}else this.moveLine.visible=!1}updateLine(){if(P(this,Ge))if(this.line.geometry.dispose(),this.count>=2){const e=new Ys().setPositions(_d(this.points));this.line.geometry=e}else this.line.geometry=of}dispose(){this.line&&this.line.deleteSelf(),this.moveLine&&this.moveLine.deleteSelf(),this.line=null,this.moveLine=null,this.count=0,this.points.length=0,this.isClosed=!1,q(this,Ge,!1)}}Ge=new WeakMap;const Ro=new N,Go=new N;class af extends Ms{constructor(t){super();O(this,"onmousedown",t=>{this.getMouse(t,Ro)});O(this,"onmouseup",t=>{if(this.getMouse(t,Go),!!Ro.equals(Go)&&this.hitPoint&&(this.helper.addPoint(this.hitPoint),this.label&&(this.label.visible=this.helper.count!==0),this.helper.isClosed)){this.removeListener(),this.createLabel(),this.setLabelPosition(this.helper.getCenter()),this.core.enableControlsRotate(!0);let s=[];this.helper.points.forEach(i=>{s.push([i.x,i.z])}),this.polygon=[s],this.selectInsideObj(),this.orientation.updateModules()}});O(this,"hasObj",t=>tf(t,this.polygon));O(this,"selectInsideObj",()=>{let t={person:[],camera:[],buildings:[]},s=V.equip.camera,i=[];this.orientation.getCurrentSceneData().forEach(o=>{o.object3d.visible&&i.push(o)});let r=this.subsystem.buildingNameLabelMap;Object.entries(s).forEach(([o,a])=>{let l=[a.position.x,a.position.z];this.hasObj(l)&&(t.camera.includes(o)||t.camera.push(o))}),i.forEach(o=>{let a=[o.position.x,o.position.z];this.hasObj(a)&&(t.person.includes(o.id)||(t.person.push(o.id),this.orientation.clusterModule.pullFromCluster(o)))}),Object.entries(r).forEach(([o,a])=>{let l=[a.position.x,a.position.z];this.hasObj(l)&&(t.buildings.includes(o)||t.buildings.push(o))}),window.parent.postMessage({cmd:"selectBack",param:t},"*")});O(this,"onkeyup",t=>{t.key==="Escape"&&(this.helper.deletePoint(),this.label.visible=this.helper.count!==0,this.updateLabel())});O(this,"getMouse",(t,s)=>{const{left:i,top:r,width:o,height:a}=this.core.domElement.getBoundingClientRect();s.x=(t.clientX-i)/o*2-1,s.y=-((t.clientY-r)/a)*2+1});O(this,"raycastOnmousemove",t=>{t.length?(this.hitPoint=t[0].point,this.helper.updateMoveLine(this.hitPoint)):this.hitPoint=null});this.core=null,this.scene=null,this.subsystem=null,this.order=2,this.raycastObject=null,this.hitPoint=null,this.orientation=t,this.orientation.addUpdatable(this)}onLoad(t){this.core=t.core,this.scene=t.scene,this.subsystem=t,this.helper=new Ar(this.scene),this.helper.needToAdhereToFirstPoint=!0,this.helper.closestDistanceToAdhere=10,this.helper.needCheckLinesCross=!0}setRaycastObject(t){this.raycastObject=t}start(){this.helper.active=!0,this.mousedownControls=this.core.addEventListener("mousedown"),this.mouseupControls=this.core.addEventListener("mouseup"),this.keyupControls=this.core.addEventListener("keyup"),this.mousedownControls.add(this.onmousedown),this.mouseupControls.add(this.onmouseup),this.keyupControls.add(this.onkeyup),this.raycastControls=this.core.raycast("mousemove",this.raycastObject,this.raycastOnmousemove)}removeListener(){this.helper.active===!0&&(this.helper.active=!1,this.mousedownControls.clear(),this.mouseupControls.clear(),this.keyupControls.clear(),this.raycastControls.clear())}end(){this.removeListener(),this.helper.dispose(),this.label&&this.label.deleteSelf(),this.label=null}createLabel(){const t=tt({innerText:"精确监控",className:"beiLuBoxSelect"});this.label=Te(t)}updateLabel(){this.label.element&&this.setLabelPosition(this.hitPoint)}setLabelPosition(t,s=10){this.label.position.set(t.x,t.y+s,t.z)}update(t){this.helper.isClosed&&this.selectInsideObj()}}class lf extends Ms{constructor(t){super();O(this,"updateVisible",t=>{const s=this.rules;if(!s)return;const i=s[t.typeName];t.object3d.traverse(r=>{r.visible=i,r.isPass=!i}),t.id!==this.orientation.searchId&&t.id!==this.orientation.followId&&(t.isSingle=!i),t.isPass=!i});this.order=0,this.orientation=t,this.rules=null,t.addUpdatable(this)}filter(t){this.rules=t}update(){if(!this.rules)return;this.orientation.map.forEach(this.updateVisible)}}var jn,_a;class cf extends K{constructor(t,s){super();Y(this,jn);const i=this.createHeatmap(t,s);this.geometry=i.geometry,this.material=i.material}createHeatmap(t,s){const{width:i,height:r}=Q(this,jn,_a).call(this,t,s.radius);this.initData(t,i,r);const o=s.container;o.style.width=`${i*2}px`,o.style.height=`${r*2}px`,document.body.appendChild(o);var a=h337.create(s);a.setData({max:2,data:t});const l=new lr(a._config.container.children[0]);l.needUpdate=!0;const h=new ir(i*2,r*2,500,500);h.applyMatrix4(new oe().makeRotationX(-Math.PI/2));const d=new Be({transparent:!0,depthTest:!1,uniforms:{heatmap:{value:l}},vertexShader:`
      uniform sampler2D heatmap;
      varying vec2 vUv;
      varying vec4 heatTexture;

      void main() {
          vUv = uv;
          heatTexture = texture2D(heatmap,vUv);
          vec3 pos = position;
          pos.y = heatTexture.r * 10.0;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(pos,1.0);
      }
      `,fragmentShader:`
      uniform sampler2D heatmap;
      varying vec2 vUv;
      varying vec4 heatTexture;
      void main() {
          vec4 color = heatTexture;
          gl_FragColor = color;
      }
      `});return document.body.removeChild(o),new K(h,d)}createHeightMap(t){}initData(t,s,i){for(let r=0;r<t.length;r++)t[r].x=t[r].x+s,t[r].y=t[r].y+i}}jn=new WeakSet,_a=function(t,s){let i=-1/0,r=-1/0;for(let o=0;o<t.length;o++){const{x:a,y:l}=t[o];i=Math.max(i,Math.abs(a)),r=Math.max(r,Math.abs(l))}return{width:i+s,height:r+s}};var ys,Ua,ka;class hf extends Ms{constructor(t){super();Y(this,ys);this.orientation=t}update(t){const s=t.getCurrentSceneData();this.dispose(),s.length!==0&&(Q(this,ys,Ua).call(this,s),t.core.scene.add(this.heatmap))}openHeatmap(){this.orientation.addUpdatable(this),this.update(this.orientation)}clearHeatmap(){this.dispose(),this.orientation.removeUpdatable(this)}dispose(){this.heatmap&&this.heatmap.deleteSelf()}}ys=new WeakSet,Ua=function(t){this.heatmap=new cf(Q(this,ys,ka).call(this,t),{container:document.createElement("div"),maxOpacity:1,radius:5,blur:1,backgroundColor:"rgba(0, 255, 255, 1)"}),this.heatmap.name="heatmap"},ka=function(t){const s=[];for(let i=0;i<t.length;i++){const r=t[i].position;s.push({x:Math.floor(r.x),y:Math.floor(r.z),value:1})}return s};class uf extends Ms{constructor(e){super(),this.id=null,this.orientation=e,this.core=e.core,e.addUpdatable(this)}search(){const e=this.orientation;if(!e.has(this.id))return;const t=e.get(this.id);t.isSingle=!0,e.clusterModule.pullFromCluster(t),t.object3d.traverse(s=>{s.visible=!0}),this.core.controls.enablePan=!1,this.update(e),this.setSearchIcon("big",t)}setSearchIcon(e,t){if(!e)return!1;let s=.03,i="translate(0, -200%) scale(0.75)";e==="big"&&(s=.05,i="translate(0, -320%) scale(1.2)"),t.object3d.traverse(r=>{if(r.isSprite&&r.scale.set(s,s,s),r.isCSS2DObject&&r.classTypeName){let a=r.element.childNodes[0];a.style.transform=i}})}setPosition(){const e=this.id,s=this.orientation.get(e).position;this.core.tweenControl.lerpTo(s,50,1e3)}clearSearch(){const e=this.id;if(!e)return;const t=this.orientation;if(!t.has(e))return;const s=t.get(e);s.isSingle=!1,this.core.controls.enablePan=!0,this.id=null,t.updateModules(),this.setSearchIcon("small",s)}update(e){if(this.id&&!this.orientation.followId){let t=this.orientation.get(this.id);const{originId:s,sceneType:i}=t,{sceneType:r,originId:o}=this.core.getCurrentOriginId();if(i!==r||i===0&&s!==o)return!1}}}const xn={0:"externalPerson",1:"insidePerson",2:"laborPerson",externalPerson:0,insidePerson:1,laborPerson:2};var ue,Ka,Ja,qi,za,Va,Zi,ja;const at=class at{constructor(e){Y(this,ue);this.core=e,this.map=new Map,this.updateMap=new Map,this.updatable=[],this.sceneData={[at.SCENE_TYPE.INDOOR]:{},[at.SCENE_TYPE.OUTDOOR]:[]},this.clusterModule=new Wd(this),this.boxSelect=new af(this),this.personSearchModule=new uf(this),this.personFilter=new lf(this),this.orientation3D=new Vd(this),this.heatmapModule=new hf(this)}get searchId(){return this.personSearchModule.id}set searchId(e){this.has(e)&&(this.personSearchModule.id=e)}init(e){const{add:t,remove:s,update:i}=e;t.forEach(r=>Q(this,ue,qi).call(this,r)),s.forEach(r=>Q(this,ue,Va).call(this,r)),i.forEach(r=>Q(this,ue,za).call(this,r)),this.getBuildingDataCount(),this.updateModules()}getBuildingDataCount(){const e=this.sceneData[at.SCENE_TYPE.INDOOR];Reflect.ownKeys(e).forEach(s=>{let i=0;const r=e[s];Reflect.ownKeys(r).forEach(a=>{const l=r[a];i+=l.length})})}has(e){return this.map.has(e)}get(e){return this.map.get(e)}filterByRule(e){this.personFilter.filter(e),this.clearSearch(),this.updateModules()}getCurrentSceneData(e,t=""){if(!e&&!t){const s=this.core.getCurrentOriginId();e=s.sceneType,t=s.originId}if(e===at.SCENE_TYPE.OUTDOOR)return this.sceneData[e];{let s;t.indexOf("F")!==-1?s=t.slice(0,-3):s=t;const i=this.sceneData[e][s];return i?i[t]||[]:[]}}setSearchId(e){this.searchId=e,Sd(e)}setFollowId(e){this.followId=e}search(){this.personSearchModule.search()}clearSearch(){this.personSearchModule.clearSearch()}setHeatmap(e){e?this.heatmapModule.openHeatmap():this.heatmapModule.clearHeatmap()}addUpdatable(e){this.updatable.indexOf(e)===-1&&this.updatable.push(e)}removeUpdatable(e){const t=this.updatable.indexOf(e);t!==-1&&this.updatable.splice(t,1)}updateModules(){this.updatable.sort((e,t)=>e.order-t.order),this.updatable.forEach(e=>e.update(this))}};ue=new WeakSet,Ka=function(e,t){this.map.set(e,t)},Ja=function(e){this.map.delete(e)},qi=function(e,t){if(Q(this,ue,ja).call(this,e,t),Q(this,ue,Ka).call(this,e.id,e),e.sceneType===at.SCENE_TYPE.INDOOR){const s=this.sceneData[at.SCENE_TYPE.INDOOR];let i;e.originId.indexOf("F")!==-1?i=e.originId.slice(0,-3):i=e.originId,s[i]||(s[i]={}),s[i][e.originId]||(s[i][e.originId]=[]),s[i][e.originId].push(e)}else this.sceneData[e.sceneType].push(e);e.id===this.followId&&(e.isSingle=!0),e.id===this.searchId&&(e.isSingle=!0),this.orientation3D.add(e)},za=function(e){const t=this.get(e.id);if(!t)return;const s=t.originId!=e.originId;Q(this,ue,Zi).call(this,t),Q(this,ue,qi).call(this,e,s),this.orientation3D.updateData(e)},Va=function(e){if(!this.has(e.id))return;let t=e.id;this.searchId===t&&(this.clearSearch(t),Ha()),this.followId===t&&this.cancelFollow(t),Q(this,ue,Zi).call(this,e)},Zi=function(e){this.orientation3D.delete(e),Q(this,ue,Ja).call(this,e.id);const{sceneType:t,originId:s}=e;let i=this.getCurrentSceneData(t,s);for(let r=0;r<i.length;r++)if(e.id===i[r].id){i.splice(r,1);break}},ja=function(e,t){const{coordinate:s,sceneType:i,type:r,originId:o}=e;e.position=Xn({coordinate:s,originId:o,sceneType:i}),e.buildingId=o.slice(0,-3),e.typeName=xn[r],e.object3d=this.orientation3D.create(e,t)},O(at,"SCENE_TYPE",{INDOOR:0,OUTDOOR:1});let $e=at;class Wa extends vd{constructor(e){super(e),this.orientation=e.orientation,this.core=e}clearPerson(){this.orientation.orientation3D.disposeClusterGroup()}startFollowPerson(e){this.orientation.setFollowId(e),this.orientation.startFollow()}processingEquipData(e,t){V.dataProcess(e,t).then(s=>{t==="camera"&&V.searchCameraIdNeed&&(V.searchEquip(V.searchCameraIdNeed,"camera"),V.searchCameraIdNeed=null),t==="inspectionSystem"&&V.searchInspectionSystemNeed&&(V.searchEquip(V.searchInspectionSystemNeed,"inspectionSystem"),V.searchInspectionSystemNeed=null)})}hideInspectionSystemIcon(e){V.hideInspectionSystemIcon(e)}searchPerson(e){this.orientation.search(e)}cancelFollowPerson(){this.orientation.cancelFollow()}clearSelected(){this.orientation.followId&&this.orientation.cancelFollow(),this.orientation.searchId&&this.orientation.clearSearch()}clearCameraVideo(e){V.closeCameraDialog(e),V.cherryPick()}cherryPick(e){const t={[xn[0]]:!1,[xn[1]]:!1,[xn[2]]:!1};e.forEach(s=>{t[s]=!0}),V.setCherryArray(e),this.orientation.filterByRule(t),V.cherryPick(e),this.core.ground.meetingPoint.setCherryArray(e),this.core.ground.meetingPoint.cherryPick(),this.core.ground.escapeRoute.setCherryArray(e),this.core.ground.escapeRoute.cherryPick(),this.core.ground.setFilterBuilding(e),this.core.ground.filterBuildingNum()}setSearchInspection(e){V.setSearchInspection(e)}setFollowPersonIdNeed(e){}searchCamera(e){V.searchEquip(e,"camera")}searchInspectionSystem(e){V.searchEquip(e,"inspectionSystem")}searchInspection(){const e=V.searchInspection;V.dataProcess([e],"inspection"),V.searchEquip(e.id,"inspection"),V.searchInspection=null}getSearchPersonId(){return this.orientation.searchPersonId}getSearchEquipId(){return V.searchCameraId}setSearchCameraId(e){V.searchCameraIdNeed=e}setSearchInspectionSystemId(e){V.searchInspectionSystemNeed=e}setDangerPerson(e){this.orientation.orientation3D.setAlarmPerson(e)}searchAlarmPerson(){this.orientation.orientation3D.searchAlarmPerson()}clearDangerPerson(){this.orientation.orientation3D.clearAlarmPerson()}clearEquipType(e){V.clearEquipType(e)}hideCameraById(e){V.hideCameraById(e)}}function Oo(n,e){if(e===Rl)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),n;if(e===_i||e===ha){let t=n.getIndex();if(t===null){const o=[],a=n.getAttribute("position");if(a!==void 0){for(let l=0;l<a.count;l++)o.push(l);n.setIndex(o),t=n.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),n}const s=t.count-2,i=[];if(e===_i)for(let o=1;o<=s;o++)i.push(t.getX(0)),i.push(t.getX(o)),i.push(t.getX(o+1));else for(let o=0;o<s;o++)o%2===0?(i.push(t.getX(o)),i.push(t.getX(o+1)),i.push(t.getX(o+2))):(i.push(t.getX(o+2)),i.push(t.getX(o+1)),i.push(t.getX(o)));i.length/3!==s&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const r=n.clone();return r.setIndex(i),r.clearGroups(),r}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),n}class df extends ua{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new Vf(t)}),this.register(function(t){return new mf(t)}),this.register(function(t){return new wf(t)}),this.register(function(t){return new Sf(t)}),this.register(function(t){return new Mf(t)}),this.register(function(t){return new Cf(t)}),this.register(function(t){return new Ef(t)}),this.register(function(t){return new Df(t)}),this.register(function(t){return new vf(t)}),this.register(function(t){return new Bf(t)}),this.register(function(t){return new yf(t)}),this.register(function(t){return new gf(t)}),this.register(function(t){return new bf(t)}),this.register(function(t){return new pf(t)}),this.register(function(t){return new Tf(t)}),this.register(function(t){return new Ff(t)})}load(e,t,s,i){const r=this;let o;this.resourcePath!==""?o=this.resourcePath:this.path!==""?o=this.path:o=Ui.extractUrlBase(e),this.manager.itemStart(e);const a=function(h){i?i(h):console.error(h),r.manager.itemError(e),r.manager.itemEnd(e)},l=new Nn(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,function(h){try{r.parse(h,o,function(d){t(d),r.manager.itemEnd(e)},a)}catch(d){a(d)}},s,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,i){let r;const o={},a={},l=new TextDecoder;if(typeof e=="string")r=JSON.parse(e);else if(e instanceof ArrayBuffer)if(l.decode(new Uint8Array(e,0,4))===Xa){try{o[z.KHR_BINARY_GLTF]=new xf(e)}catch(u){i&&i(u);return}r=JSON.parse(o[z.KHR_BINARY_GLTF].content)}else r=JSON.parse(l.decode(e));else r=e;if(r.asset===void 0||r.asset.version[0]<2){i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const h=new Jf(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});h.fileLoader.setRequestHeader(this.requestHeader);for(let d=0;d<this.pluginCallbacks.length;d++){const u=this.pluginCallbacks[d](h);u.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[u.name]=u,o[u.name]=!0}if(r.extensionsUsed)for(let d=0;d<r.extensionsUsed.length;++d){const u=r.extensionsUsed[d],c=r.extensionsRequired||[];switch(u){case z.KHR_MATERIALS_UNLIT:o[u]=new Af;break;case z.KHR_DRACO_MESH_COMPRESSION:o[u]=new If(r,this.dracoLoader);break;case z.KHR_TEXTURE_TRANSFORM:o[u]=new Lf;break;case z.KHR_MESH_QUANTIZATION:o[u]=new Pf;break;default:c.indexOf(u)>=0&&a[u]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+u+'".')}}h.setExtensions(o),h.setPlugins(a),h.parse(s,i)}parseAsync(e,t){const s=this;return new Promise(function(i,r){s.parse(e,t,i,r)})}}function ff(){let n={};return{get:function(e){return n[e]},add:function(e,t){n[e]=t},remove:function(e){delete n[e]},removeAll:function(){n={}}}}const z={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class pf{constructor(e){this.parser=e,this.name=z.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,i=t.length;s<i;s++){const r=t[s];r.extensions&&r.extensions[this.name]&&r.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let i=t.cache.get(s);if(i)return i;const r=t.json,l=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let h;const d=new Z(16777215);l.color!==void 0&&d.setRGB(l.color[0],l.color[1],l.color[2],Je);const u=l.range!==void 0?l.range:0;switch(l.type){case"directional":h=new us(d),h.target.position.set(0,0,-1),h.add(h.target);break;case"point":h=new da(d),h.distance=u;break;case"spot":h=new Gl(d),h.distance=u,l.spot=l.spot||{},l.spot.innerConeAngle=l.spot.innerConeAngle!==void 0?l.spot.innerConeAngle:0,l.spot.outerConeAngle=l.spot.outerConeAngle!==void 0?l.spot.outerConeAngle:Math.PI/4,h.angle=l.spot.outerConeAngle,h.penumbra=1-l.spot.innerConeAngle/l.spot.outerConeAngle,h.target.position.set(0,0,-1),h.add(h.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+l.type)}return h.position.set(0,0,0),h.decay=2,Dt(h,l),l.intensity!==void 0&&(h.intensity=l.intensity),h.name=t.createUniqueName(l.name||"light_"+e),i=Promise.resolve(h),t.cache.add(s,i),i}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,r=s.json.nodes[e],a=(r.extensions&&r.extensions[this.name]||{}).light;return a===void 0?null:this._loadLight(a).then(function(l){return s._getNodeRef(t.cache,a,l)})}}class Af{constructor(){this.name=z.KHR_MATERIALS_UNLIT}getMaterialType(){return ct}extendParams(e,t,s){const i=[];e.color=new Z(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const o=r.baseColorFactor;e.color.setRGB(o[0],o[1],o[2],Je),e.opacity=o[3]}r.baseColorTexture!==void 0&&i.push(s.assignTexture(e,"map",r.baseColorTexture,j))}return Promise.all(i)}}class Bf{constructor(e){this.parser=e,this.name=z.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=i.extensions[this.name].emissiveStrength;return r!==void 0&&(t.emissiveIntensity=r),Promise.resolve()}}class mf{constructor(e){this.parser=e,this.name=z.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:pt}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],o=i.extensions[this.name];if(o.clearcoatFactor!==void 0&&(t.clearcoat=o.clearcoatFactor),o.clearcoatTexture!==void 0&&r.push(s.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),o.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),o.clearcoatRoughnessTexture!==void 0&&r.push(s.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),o.clearcoatNormalTexture!==void 0&&(r.push(s.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),o.clearcoatNormalTexture.scale!==void 0)){const a=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new N(a,a)}return Promise.all(r)}}class gf{constructor(e){this.parser=e,this.name=z.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:pt}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],o=i.extensions[this.name];return o.iridescenceFactor!==void 0&&(t.iridescence=o.iridescenceFactor),o.iridescenceTexture!==void 0&&r.push(s.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),o.iridescenceIor!==void 0&&(t.iridescenceIOR=o.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),o.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),o.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),o.iridescenceThicknessTexture!==void 0&&r.push(s.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(r)}}class Cf{constructor(e){this.parser=e,this.name=z.KHR_MATERIALS_SHEEN}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:pt}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[];t.sheenColor=new Z(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=i.extensions[this.name];if(o.sheenColorFactor!==void 0){const a=o.sheenColorFactor;t.sheenColor.setRGB(a[0],a[1],a[2],Je)}return o.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=o.sheenRoughnessFactor),o.sheenColorTexture!==void 0&&r.push(s.assignTexture(t,"sheenColorMap",o.sheenColorTexture,j)),o.sheenRoughnessTexture!==void 0&&r.push(s.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(r)}}class Ef{constructor(e){this.parser=e,this.name=z.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:pt}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],o=i.extensions[this.name];return o.transmissionFactor!==void 0&&(t.transmission=o.transmissionFactor),o.transmissionTexture!==void 0&&r.push(s.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(r)}}class Df{constructor(e){this.parser=e,this.name=z.KHR_MATERIALS_VOLUME}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:pt}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],o=i.extensions[this.name];t.thickness=o.thicknessFactor!==void 0?o.thicknessFactor:0,o.thicknessTexture!==void 0&&r.push(s.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const a=o.attenuationColor||[1,1,1];return t.attenuationColor=new Z().setRGB(a[0],a[1],a[2],Je),Promise.all(r)}}class vf{constructor(e){this.parser=e,this.name=z.KHR_MATERIALS_IOR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:pt}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=i.extensions[this.name];return t.ior=r.ior!==void 0?r.ior:1.5,Promise.resolve()}}class yf{constructor(e){this.parser=e,this.name=z.KHR_MATERIALS_SPECULAR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:pt}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],o=i.extensions[this.name];t.specularIntensity=o.specularFactor!==void 0?o.specularFactor:1,o.specularTexture!==void 0&&r.push(s.assignTexture(t,"specularIntensityMap",o.specularTexture));const a=o.specularColorFactor||[1,1,1];return t.specularColor=new Z().setRGB(a[0],a[1],a[2],Je),o.specularColorTexture!==void 0&&r.push(s.assignTexture(t,"specularColorMap",o.specularColorTexture,j)),Promise.all(r)}}class bf{constructor(e){this.parser=e,this.name=z.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:pt}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],o=i.extensions[this.name];return o.anisotropyStrength!==void 0&&(t.anisotropy=o.anisotropyStrength),o.anisotropyRotation!==void 0&&(t.anisotropyRotation=o.anisotropyRotation),o.anisotropyTexture!==void 0&&r.push(s.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(r)}}class wf{constructor(e){this.parser=e,this.name=z.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,i=s.textures[e];if(!i.extensions||!i.extensions[this.name])return null;const r=i.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r.source,o)}}class Sf{constructor(e){this.parser=e,this.name=z.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,i=s.json,r=i.textures[e];if(!r.extensions||!r.extensions[t])return null;const o=r.extensions[t],a=i.images[o.source];let l=s.textureLoader;if(a.uri){const h=s.options.manager.getHandler(a.uri);h!==null&&(l=h)}return this.detectSupport().then(function(h){if(h)return s.loadTextureImage(e,o.source,l);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Mf{constructor(e){this.parser=e,this.name=z.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,i=s.json,r=i.textures[e];if(!r.extensions||!r.extensions[t])return null;const o=r.extensions[t],a=i.images[o.source];let l=s.textureLoader;if(a.uri){const h=s.options.manager.getHandler(a.uri);h!==null&&(l=h)}return this.detectSupport().then(function(h){if(h)return s.loadTextureImage(e,o.source,l);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Tf{constructor(e){this.name=z.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const i=s.extensions[this.name],r=this.parser.getDependency("buffer",i.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return r.then(function(a){const l=i.byteOffset||0,h=i.byteLength||0,d=i.count,u=i.byteStride,c=new Uint8Array(a,l,h);return o.decodeGltfBufferAsync?o.decodeGltfBufferAsync(d,u,c,i.mode,i.filter).then(function(f){return f.buffer}):o.ready.then(function(){const f=new ArrayBuffer(d*u);return o.decodeGltfBuffer(new Uint8Array(f),d,u,c,i.mode,i.filter),f})})}else return null}}class Ff{constructor(e){this.name=z.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||s.mesh===void 0)return null;const i=t.meshes[s.mesh];for(const h of i.primitives)if(h.mode!==He.TRIANGLES&&h.mode!==He.TRIANGLE_STRIP&&h.mode!==He.TRIANGLE_FAN&&h.mode!==void 0)return null;const o=s.extensions[this.name].attributes,a=[],l={};for(const h in o)a.push(this.parser.getDependency("accessor",o[h]).then(d=>(l[h]=d,l[h])));return a.length<1?null:(a.push(this.parser.createNodeMesh(e)),Promise.all(a).then(h=>{const d=h.pop(),u=d.isGroup?d.children:[d],c=h[0].count,f=[];for(const p of u){const B=new oe,A=new M,m=new Ws,g=new M(1,1,1),C=new fa(p.geometry,p.material,c);for(let E=0;E<c;E++)l.TRANSLATION&&A.fromBufferAttribute(l.TRANSLATION,E),l.ROTATION&&m.fromBufferAttribute(l.ROTATION,E),l.SCALE&&g.fromBufferAttribute(l.SCALE,E),C.setMatrixAt(E,B.compose(A,m,g));for(const E in l)if(E==="_COLOR_0"){const D=l[E];C.instanceColor=new Ol(D.array,D.itemSize,D.normalized)}else E!=="TRANSLATION"&&E!=="ROTATION"&&E!=="SCALE"&&p.geometry.setAttribute(E,l[E]);Ae.prototype.copy.call(C,p),this.parser.assignFinalMaterial(C),f.push(C)}return d.isGroup?(d.clear(),d.add(...f),d):f[0]}))}}const Xa="glTF",Ns=12,No={JSON:1313821514,BIN:5130562};class xf{constructor(e){this.name=z.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,Ns),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Xa)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-Ns,r=new DataView(e,Ns);let o=0;for(;o<i;){const a=r.getUint32(o,!0);o+=4;const l=r.getUint32(o,!0);if(o+=4,l===No.JSON){const h=new Uint8Array(e,Ns+o,a);this.content=s.decode(h)}else if(l===No.BIN){const h=Ns+o;this.body=e.slice(h,h+a)}o+=a}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class If{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=z.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,i=this.dracoLoader,r=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,a={},l={},h={};for(const d in o){const u=Qi[d]||d.toLowerCase();a[u]=o[d]}for(const d in e.attributes){const u=Qi[d]||d.toLowerCase();if(o[d]!==void 0){const c=s.accessors[e.attributes[d]],f=ps[c.componentType];h[u]=f.name,l[u]=c.normalized===!0}}return t.getDependency("bufferView",r).then(function(d){return new Promise(function(u){i.decodeDracoFile(d,function(c){for(const f in c.attributes){const p=c.attributes[f],B=l[f];B!==void 0&&(p.normalized=B)}u(c)},a,h)})})}}class Lf{constructor(){this.name=z.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Pf{constructor(){this.name=z.KHR_MESH_QUANTIZATION}}class Ya extends ic{constructor(e,t,s,i){super(e,t,s,i)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,i=this.valueSize,r=e*i*3+i;for(let o=0;o!==i;o++)t[o]=s[r+o];return t}interpolate_(e,t,s,i){const r=this.resultBuffer,o=this.sampleValues,a=this.valueSize,l=a*2,h=a*3,d=i-t,u=(s-t)/d,c=u*u,f=c*u,p=e*h,B=p-h,A=-2*f+3*c,m=f-c,g=1-A,C=m-c+u;for(let E=0;E!==a;E++){const D=o[B+E+a],b=o[B+E+l]*d,S=o[p+E+a],y=o[p+E]*d;r[E]=g*D+C*b+A*S+m*y}return r}}const Hf=new Ws;class Rf extends Ya{interpolate_(e,t,s,i){const r=super.interpolate_(e,t,s,i);return Hf.fromArray(r).normalize().toArray(r),r}}const He={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},ps={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},_o={9728:Hn,9729:Ft,9984:Kl,9985:kl,9986:Ul,9987:pa},Uo={33071:zl,33648:Jl,10497:Ve},Fi={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Qi={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Ct={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Gf={CUBICSPLINE:void 0,LINEAR:Aa,STEP:nc},xi={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function Of(n){return n.DefaultMaterial===void 0&&(n.DefaultMaterial=new Xs({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Pn})),n.DefaultMaterial}function Gt(n,e,t){for(const s in t.extensions)n[s]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[s]=t.extensions[s])}function Dt(n,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(n.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function Nf(n,e,t){let s=!1,i=!1,r=!1;for(let h=0,d=e.length;h<d;h++){const u=e[h];if(u.POSITION!==void 0&&(s=!0),u.NORMAL!==void 0&&(i=!0),u.COLOR_0!==void 0&&(r=!0),s&&i&&r)break}if(!s&&!i&&!r)return Promise.resolve(n);const o=[],a=[],l=[];for(let h=0,d=e.length;h<d;h++){const u=e[h];if(s){const c=u.POSITION!==void 0?t.getDependency("accessor",u.POSITION):n.attributes.position;o.push(c)}if(i){const c=u.NORMAL!==void 0?t.getDependency("accessor",u.NORMAL):n.attributes.normal;a.push(c)}if(r){const c=u.COLOR_0!==void 0?t.getDependency("accessor",u.COLOR_0):n.attributes.color;l.push(c)}}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(l)]).then(function(h){const d=h[0],u=h[1],c=h[2];return s&&(n.morphAttributes.position=d),i&&(n.morphAttributes.normal=u),r&&(n.morphAttributes.color=c),n.morphTargetsRelative=!0,n})}function _f(n,e){if(n.updateMorphTargets(),e.weights!==void 0)for(let t=0,s=e.weights.length;t<s;t++)n.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(n.morphTargetInfluences.length===t.length){n.morphTargetDictionary={};for(let s=0,i=t.length;s<i;s++)n.morphTargetDictionary[t[s]]=s}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Uf(n){let e;const t=n.extensions&&n.extensions[z.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+Ii(t.attributes):e=n.indices+":"+Ii(n.attributes)+":"+n.mode,n.targets!==void 0)for(let s=0,i=n.targets.length;s<i;s++)e+=":"+Ii(n.targets[s]);return e}function Ii(n){let e="";const t=Object.keys(n).sort();for(let s=0,i=t.length;s<i;s++)e+=t[s]+":"+n[t[s]]+";";return e}function $i(n){switch(n){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function kf(n){return n.search(/\.jpe?g($|\?)/i)>0||n.search(/^data\:image\/jpeg/)===0?"image/jpeg":n.search(/\.webp($|\?)/i)>0||n.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const Kf=new oe;class Jf{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new ff,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,i=!1,r=-1;typeof navigator<"u"&&(s=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)===!0,i=navigator.userAgent.indexOf("Firefox")>-1,r=i?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),typeof createImageBitmap>"u"||s||i&&r<98?this.textureLoader=new Oe(this.options.manager):this.textureLoader=new Nl(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Nn(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,i=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(o){return o._markDefs&&o._markDefs()}),Promise.all(this._invokeAll(function(o){return o.beforeRoot&&o.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(o){const a={scene:o[0][i.scene||0],scenes:o[0],animations:o[1],cameras:o[2],asset:i.asset,parser:s,userData:{}};return Gt(r,a,i),Dt(a,i),Promise.all(s._invokeAll(function(l){return l.afterRoot&&l.afterRoot(a)})).then(function(){e(a)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let i=0,r=t.length;i<r;i++){const o=t[i].joints;for(let a=0,l=o.length;a<l;a++)e[o[a]].isBone=!0}for(let i=0,r=e.length;i<r;i++){const o=e[i];o.mesh!==void 0&&(this._addNodeRef(this.meshCache,o.mesh),o.skin!==void 0&&(s[o.mesh].isSkinnedMesh=!0)),o.camera!==void 0&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const i=s.clone(),r=(o,a)=>{const l=this.associations.get(o);l!=null&&this.associations.set(a,l);for(const[h,d]of o.children.entries())r(d,a.children[h])};return r(s,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const i=e(t[s]);if(i)return i instanceof Promise?i.catch(function(r){return console.warn("THREE.GLTFLoader: Extension error:",r),null}):i}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let i=0;i<t.length;i++){const r=e(t[i]);r&&s.push(r)}return s}getDependency(e,t){const s=e+":"+t;let i=this.cache.get(s);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne(function(r){return r.loadNode&&r.loadNode(t)});break;case"mesh":i=this._invokeOne(function(r){return r.loadMesh&&r.loadMesh(t)});break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne(function(r){return r.loadBufferView&&r.loadBufferView(t)});break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne(function(r){return r.loadMaterial&&r.loadMaterial(t)});break;case"texture":i=this._invokeOne(function(r){return r.loadTexture&&r.loadTexture(t)});break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne(function(r){return r.loadAnimation&&r.loadAnimation(t)});break;case"camera":i=this.loadCamera(t);break;default:if(i=this._invokeOne(function(r){return r!=this&&r.getDependency&&r.getDependency(e,t)}),!i)throw new Error("Unknown type: "+e);break}this.cache.add(s,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,i=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(i.map(function(r,o){return s.getDependency(e,o)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[z.KHR_BINARY_GLTF].body);const i=this.options;return new Promise(function(r,o){s.load(Ui.resolveURL(t.uri,i.path),r,void 0,function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(s){const i=t.byteLength||0,r=t.byteOffset||0;return s.slice(r,r+i)})}loadAccessor(e){const t=this,s=this.json,i=this.json.accessors[e];if(i.bufferView===void 0&&i.sparse===void 0){const o=Fi[i.type],a=ps[i.componentType],l=i.normalized===!0,h=new a(i.count*o);return Promise.resolve(new ie(h,o,l))}const r=[];return i.bufferView!==void 0?r.push(this.getDependency("bufferView",i.bufferView)):r.push(null),i.sparse!==void 0&&(r.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(r).then(function(o){const a=o[0],l=Fi[i.type],h=ps[i.componentType],d=h.BYTES_PER_ELEMENT,u=d*l,c=i.byteOffset||0,f=i.bufferView!==void 0?s.bufferViews[i.bufferView].byteStride:void 0,p=i.normalized===!0;let B,A;if(f&&f!==u){const m=Math.floor(c/f),g="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+m+":"+i.count;let C=t.cache.get(g);C||(B=new h(a,m*f,i.count*f/d),C=new _l(B,f/d),t.cache.add(g,C)),A=new Nt(C,l,c%f/d,p)}else a===null?B=new h(i.count*l):B=new h(a,c,i.count*l),A=new ie(B,l,p);if(i.sparse!==void 0){const m=Fi.SCALAR,g=ps[i.sparse.indices.componentType],C=i.sparse.indices.byteOffset||0,E=i.sparse.values.byteOffset||0,D=new g(o[1],C,i.sparse.count*m),b=new h(o[2],E,i.sparse.count*l);a!==null&&(A=new ie(A.array.slice(),A.itemSize,A.normalized));for(let S=0,y=D.length;S<y;S++){const w=D[S];if(A.setX(w,b[S*l]),l>=2&&A.setY(w,b[S*l+1]),l>=3&&A.setZ(w,b[S*l+2]),l>=4&&A.setW(w,b[S*l+3]),l>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return A})}loadTexture(e){const t=this.json,s=this.options,r=t.textures[e].source,o=t.images[r];let a=this.textureLoader;if(o.uri){const l=s.manager.getHandler(o.uri);l!==null&&(a=l)}return this.loadTextureImage(e,r,a).catch(function(l){return console.warn(`THREE.GLTFLoader: Error loading texture ${e}:`,l),null})}loadTextureImage(e,t,s){const i=this,r=this.json,o=r.textures[e],a=r.images[t],l=(a.uri||a.bufferView)+":"+o.sampler;if(this.textureCache[l])return this.textureCache[l];const h=this.loadImageSource(t,s).then(function(d){if(!d)return console.warn(`THREE.GLTFLoader: Failed to load texture image for texture ${e}`),null;d.flipY=!1,d.name=o.name||a.name||"",d.name===""&&typeof a.uri=="string"&&a.uri.startsWith("data:image/")===!1&&(d.name=a.uri);const c=(r.samplers||{})[o.sampler]||{};return d.magFilter=_o[c.magFilter]||Ft,d.minFilter=_o[c.minFilter]||pa,d.wrapS=Uo[c.wrapS]||Ve,d.wrapT=Uo[c.wrapT]||Ve,i.associations.set(d,{textures:e}),d}).catch(function(d){return console.warn(`THREE.GLTFLoader: Error in loadTextureImage for texture ${e}:`,d),null});return this.textureCache[l]=h,h}loadImageSource(e,t){const s=this,i=this.json,r=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(c=>c.clone());const o=i.images[e],a=self.URL||self.webkitURL;let l=o.uri||"",h=!1,d=null;if(o.bufferView!==void 0)l=s.getDependency("bufferView",o.bufferView).then(function(c){h=!0;const f=o.mimeType||"image/png",p=new Blob([c],{type:f});return d=a.createObjectURL(p),d}).catch(function(c){return console.warn(`THREE.GLTFLoader: Failed to get bufferView for image ${e}:`,c),null});else if(o.uri===void 0)return console.error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView"),Promise.resolve(null);const u=Promise.resolve(l).then(function(c){return c?new Promise(function(f,p){let B=f;t.isImageBitmapLoader===!0&&(B=function(A){const m=new Es(A);m.needsUpdate=!0,f(m)}),t.load(Ui.resolveURL(c,r.path),B,void 0,function(A){console.warn("THREE.GLTFLoader: Failed to load texture image:",c,A),f(null)})}):null}).then(function(c){return h===!0&&d&&setTimeout(()=>{try{a.revokeObjectURL(d)}catch(f){console.warn("THREE.GLTFLoader: Error revoking object URL:",f)}},1e3),c&&(c.userData.mimeType=o.mimeType||kf(o.uri)),c}).catch(function(c){if(h===!0&&d)try{a.revokeObjectURL(d)}catch(f){console.warn("THREE.GLTFLoader: Error revoking object URL on error:",f)}return console.warn("THREE.GLTFLoader: Couldn't load texture",l,c),null});return this.sourceCache[e]=u,u}assignTexture(e,t,s,i){const r=this;return this.getDependency("texture",s.index).then(function(o){if(!o)return console.warn(`THREE.GLTFLoader: Texture for ${t} failed to load, using default material`),null;if(s.texCoord!==void 0&&s.texCoord>0&&(o=o.clone(),o.channel=s.texCoord),r.extensions[z.KHR_TEXTURE_TRANSFORM]){const a=s.extensions!==void 0?s.extensions[z.KHR_TEXTURE_TRANSFORM]:void 0;if(a){const l=r.associations.get(o);o=r.extensions[z.KHR_TEXTURE_TRANSFORM].extendTexture(o,a),r.associations.set(o,l)}}return i!==void 0&&(o.colorSpace=i),e[t]=o,o}).catch(function(o){return console.warn(`THREE.GLTFLoader: Failed to assign texture for ${t}:`,o),null})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const i=t.attributes.tangent===void 0,r=t.attributes.color!==void 0,o=t.attributes.normal===void 0;if(e.isPoints){const a="PointsMaterial:"+s.uuid;let l=this.cache.get(a);l||(l=new Vl,hs.prototype.copy.call(l,s),l.color.copy(s.color),l.map=s.map,l.sizeAttenuation=!1,this.cache.add(a,l)),s=l}else if(e.isLine){const a="LineBasicMaterial:"+s.uuid;let l=this.cache.get(a);l||(l=new jl,hs.prototype.copy.call(l,s),l.color.copy(s.color),l.map=s.map,this.cache.add(a,l)),s=l}if(i||r||o){let a="ClonedMaterial:"+s.uuid+":";i&&(a+="derivative-tangents:"),r&&(a+="vertex-colors:"),o&&(a+="flat-shading:");let l=this.cache.get(a);l||(l=s.clone(),r&&(l.vertexColors=!0),o&&(l.flatShading=!0),i&&(l.normalScale&&(l.normalScale.y*=-1),l.clearcoatNormalScale&&(l.clearcoatNormalScale.y*=-1)),this.cache.add(a,l),this.associations.set(l,this.associations.get(s))),s=l}e.material=s}getMaterialType(){return Xs}loadMaterial(e){const t=this,s=this.json,i=this.extensions,r=s.materials[e];let o;const a={},l=r.extensions||{},h=[];if(l[z.KHR_MATERIALS_UNLIT]){const u=i[z.KHR_MATERIALS_UNLIT];o=u.getMaterialType(),h.push(u.extendParams(a,r,t))}else{const u=r.pbrMetallicRoughness||{};if(a.color=new Z(1,1,1),a.opacity=1,Array.isArray(u.baseColorFactor)){const c=u.baseColorFactor;a.color.setRGB(c[0],c[1],c[2],Je),a.opacity=c[3]}u.baseColorTexture!==void 0&&h.push(t.assignTexture(a,"map",u.baseColorTexture,j)),a.metalness=u.metallicFactor!==void 0?u.metallicFactor:1,a.roughness=u.roughnessFactor!==void 0?u.roughnessFactor:1,u.metallicRoughnessTexture!==void 0&&(h.push(t.assignTexture(a,"metalnessMap",u.metallicRoughnessTexture)),h.push(t.assignTexture(a,"roughnessMap",u.metallicRoughnessTexture))),o=this._invokeOne(function(c){return c.getMaterialType&&c.getMaterialType(e)}),h.push(Promise.all(this._invokeAll(function(c){return c.extendMaterialParams&&c.extendMaterialParams(e,a)})))}r.doubleSided===!0&&(a.side=Me);const d=r.alphaMode||xi.OPAQUE;if(d===xi.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,d===xi.MASK&&(a.alphaTest=r.alphaCutoff!==void 0?r.alphaCutoff:.5)),r.normalTexture!==void 0&&o!==ct&&(h.push(t.assignTexture(a,"normalMap",r.normalTexture)),a.normalScale=new N(1,1),r.normalTexture.scale!==void 0)){const u=r.normalTexture.scale;a.normalScale.set(u,u)}if(r.occlusionTexture!==void 0&&o!==ct&&(h.push(t.assignTexture(a,"aoMap",r.occlusionTexture)),r.occlusionTexture.strength!==void 0&&(a.aoMapIntensity=r.occlusionTexture.strength)),r.emissiveFactor!==void 0&&o!==ct){const u=r.emissiveFactor;a.emissive=new Z().setRGB(u[0],u[1],u[2],Je)}return r.emissiveTexture!==void 0&&o!==ct&&h.push(t.assignTexture(a,"emissiveMap",r.emissiveTexture,j)),Promise.all(h).then(function(){const u=new o(a);return r.name&&(u.name=r.name),Dt(u,r),t.associations.set(u,{materials:e}),r.extensions&&Gt(i,u,r),u})}createUniqueName(e){const t=Wl.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,i=this.primitiveCache;function r(a){return s[z.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,t).then(function(l){return ko(l,a,t)})}const o=[];for(let a=0,l=e.length;a<l;a++){const h=e[a],d=Uf(h),u=i[d];if(u)o.push(u.promise);else{let c;h.extensions&&h.extensions[z.KHR_DRACO_MESH_COMPRESSION]?c=r(h):c=ko(new xt,h,t),i[d]={primitive:h,promise:c},o.push(c)}}return Promise.all(o)}loadMesh(e){const t=this,s=this.json,i=this.extensions,r=s.meshes[e],o=r.primitives,a=[];for(let l=0,h=o.length;l<h;l++){const d=o[l].material===void 0?Of(this.cache):this.getDependency("material",o[l].material);a.push(d)}return a.push(t.loadGeometries(o)),Promise.all(a).then(function(l){const h=l.slice(0,l.length-1),d=l[l.length-1],u=[];for(let f=0,p=d.length;f<p;f++){const B=d[f],A=o[f];let m;const g=h[f];if(A.mode===He.TRIANGLES||A.mode===He.TRIANGLE_STRIP||A.mode===He.TRIANGLE_FAN||A.mode===void 0)m=r.isSkinnedMesh===!0?new Xl(B,g):new K(B,g),m.isSkinnedMesh===!0&&m.normalizeSkinWeights(),A.mode===He.TRIANGLE_STRIP?m.geometry=Oo(m.geometry,ha):A.mode===He.TRIANGLE_FAN&&(m.geometry=Oo(m.geometry,_i));else if(A.mode===He.LINES)m=new Yl(B,g);else if(A.mode===He.LINE_STRIP)m=new ql(B,g);else if(A.mode===He.LINE_LOOP)m=new Zl(B,g);else if(A.mode===He.POINTS)m=new Ql(B,g);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+A.mode);Object.keys(m.geometry.morphAttributes).length>0&&_f(m,r),m.name=t.createUniqueName(r.name||"mesh_"+e),Dt(m,r),A.extensions&&Gt(i,m,A),t.assignFinalMaterial(m),u.push(m)}for(let f=0,p=u.length;f<p;f++)t.associations.set(u[f],{meshes:e,primitives:f});if(u.length===1)return r.extensions&&Gt(i,u[0],r),u[0];const c=new ee;r.extensions&&Gt(i,c,r),t.associations.set(c,{meshes:e});for(let f=0,p=u.length;f<p;f++)c.add(u[f]);return c})}loadCamera(e){let t;const s=this.json.cameras[e],i=s[s.type];if(!i){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return s.type==="perspective"?t=new bs(nr.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):s.type==="orthographic"&&(t=new $l(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),Dt(t,s),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],s=[];for(let i=0,r=t.joints.length;i<r;i++)s.push(this._loadNodeShallow(t.joints[i]));return t.inverseBindMatrices!==void 0?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(i){const r=i.pop(),o=i,a=[],l=[];for(let h=0,d=o.length;h<d;h++){const u=o[h];if(u){a.push(u);const c=new oe;r!==null&&c.fromArray(r.array,h*16),l.push(c)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[h])}return new ec(a,l)})}loadAnimation(e){const t=this.json,s=this,i=t.animations[e],r=i.name?i.name:"animation_"+e,o=[],a=[],l=[],h=[],d=[];for(let u=0,c=i.channels.length;u<c;u++){const f=i.channels[u],p=i.samplers[f.sampler],B=f.target,A=B.node,m=i.parameters!==void 0?i.parameters[p.input]:p.input,g=i.parameters!==void 0?i.parameters[p.output]:p.output;B.node!==void 0&&(o.push(this.getDependency("node",A)),a.push(this.getDependency("accessor",m)),l.push(this.getDependency("accessor",g)),h.push(p),d.push(B))}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(l),Promise.all(h),Promise.all(d)]).then(function(u){const c=u[0],f=u[1],p=u[2],B=u[3],A=u[4],m=[];for(let g=0,C=c.length;g<C;g++){const E=c[g],D=f[g],b=p[g],S=B[g],y=A[g];if(E===void 0)continue;E.updateMatrix&&E.updateMatrix();const w=s._createAnimationTracks(E,D,b,S,y);if(w)for(let F=0;F<w.length;F++)m.push(w[F])}return new tc(r,void 0,m)})}createNodeMesh(e){const t=this.json,s=this,i=t.nodes[e];return i.mesh===void 0?null:s.getDependency("mesh",i.mesh).then(function(r){const o=s._getNodeRef(s.meshCache,i.mesh,r);return i.weights!==void 0&&o.traverse(function(a){if(a.isMesh)for(let l=0,h=i.weights.length;l<h;l++)a.morphTargetInfluences[l]=i.weights[l]}),o})}loadNode(e){const t=this.json,s=this,i=t.nodes[e],r=s._loadNodeShallow(e),o=[],a=i.children||[];for(let h=0,d=a.length;h<d;h++)o.push(s.getDependency("node",a[h]));const l=i.skin===void 0?Promise.resolve(null):s.getDependency("skin",i.skin);return Promise.all([r,Promise.all(o),l]).then(function(h){const d=h[0],u=h[1],c=h[2];c!==null&&d.traverse(function(f){f.isSkinnedMesh&&f.bind(c,Kf)});for(let f=0,p=u.length;f<p;f++)d.add(u[f]);return d})}_loadNodeShallow(e){const t=this.json,s=this.extensions,i=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const r=t.nodes[e],o=r.name?i.createUniqueName(r.name):"",a=[],l=i._invokeOne(function(h){return h.createNodeMesh&&h.createNodeMesh(e)});return l&&a.push(l),r.camera!==void 0&&a.push(i.getDependency("camera",r.camera).then(function(h){return i._getNodeRef(i.cameraCache,r.camera,h)})),i._invokeAll(function(h){return h.createNodeAttachment&&h.createNodeAttachment(e)}).forEach(function(h){a.push(h)}),this.nodeCache[e]=Promise.all(a).then(function(h){let d;if(r.isBone===!0?d=new sc:h.length>1?d=new ee:h.length===1?d=h[0]:d=new Ae,d!==h[0])for(let u=0,c=h.length;u<c;u++)d.add(h[u]);if(r.name&&(d.userData.name=r.name,d.name=o),Dt(d,r),r.extensions&&Gt(s,d,r),r.matrix!==void 0){const u=new oe;u.fromArray(r.matrix),d.applyMatrix4(u)}else r.translation!==void 0&&d.position.fromArray(r.translation),r.rotation!==void 0&&d.quaternion.fromArray(r.rotation),r.scale!==void 0&&d.scale.fromArray(r.scale);return i.associations.has(d)||i.associations.set(d,{}),i.associations.get(d).nodes=e,d}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],i=this,r=new ee;s.name&&(r.name=i.createUniqueName(s.name)),Dt(r,s),s.extensions&&Gt(t,r,s);const o=s.nodes||[],a=[];for(let l=0,h=o.length;l<h;l++)a.push(i.getDependency("node",o[l]));return Promise.all(a).then(function(l){for(let d=0,u=l.length;d<u;d++)r.add(l[d]);const h=d=>{const u=new Map;for(const[c,f]of i.associations)(c instanceof hs||c instanceof Es)&&u.set(c,f);return d.traverse(c=>{const f=i.associations.get(c);f!=null&&u.set(c,f)}),u};return i.associations=h(r),r})}_createAnimationTracks(e,t,s,i,r){const o=[],a=e.name?e.name:e.uuid,l=[];Ct[r.path]===Ct.weights?e.traverse(function(c){c.morphTargetInfluences&&l.push(c.name?c.name:c.uuid)}):l.push(a);let h;switch(Ct[r.path]){case Ct.weights:h=Gr;break;case Ct.rotation:h=Or;break;case Ct.position:case Ct.scale:h=Rr;break;default:switch(s.itemSize){case 1:h=Gr;break;case 2:case 3:default:h=Rr;break}break}const d=i.interpolation!==void 0?Gf[i.interpolation]:Aa,u=this._getArrayFromAccessor(s);for(let c=0,f=l.length;c<f;c++){const p=new h(l[c]+"."+Ct[r.path],t.array,u,d);i.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(p),o.push(p)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const s=$i(t.constructor),i=new Float32Array(t.length);for(let r=0,o=t.length;r<o;r++)i[r]=t[r]*s;t=i}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(s){const i=this instanceof Or?Rf:Ya;return new i(this.times,this.values,this.getValueSize()/3,s)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function zf(n,e,t){const s=e.attributes,i=new ce;if(s.POSITION!==void 0){const a=t.json.accessors[s.POSITION],l=a.min,h=a.max;if(l!==void 0&&h!==void 0){if(i.set(new M(l[0],l[1],l[2]),new M(h[0],h[1],h[2])),a.normalized){const d=$i(ps[a.componentType]);i.min.multiplyScalar(d),i.max.multiplyScalar(d)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const r=e.targets;if(r!==void 0){const a=new M,l=new M;for(let h=0,d=r.length;h<d;h++){const u=r[h];if(u.POSITION!==void 0){const c=t.json.accessors[u.POSITION],f=c.min,p=c.max;if(f!==void 0&&p!==void 0){if(l.setX(Math.max(Math.abs(f[0]),Math.abs(p[0]))),l.setY(Math.max(Math.abs(f[1]),Math.abs(p[1]))),l.setZ(Math.max(Math.abs(f[2]),Math.abs(p[2]))),c.normalized){const B=$i(ps[c.componentType]);l.multiplyScalar(B)}a.max(l)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}i.expandByVector(a)}n.boundingBox=i;const o=new ws;i.getCenter(o.center),o.radius=i.min.distanceTo(i.max)/2,n.boundingSphere=o}function ko(n,e,t){const s=e.attributes,i=[];function r(o,a){return t.getDependency("accessor",o).then(function(l){n.setAttribute(a,l)})}for(const o in s){const a=Qi[o]||o.toLowerCase();a in n.attributes||i.push(r(s[o],a))}if(e.indices!==void 0&&!n.index){const o=t.getDependency("accessor",e.indices).then(function(a){n.setIndex(a)});i.push(o)}return Nr.workingColorSpace!==Je&&"COLOR_0"in s&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${Nr.workingColorSpace}" not supported.`),Dt(n,e),zf(n,e,t),Promise.all(i).then(function(){return e.targets!==void 0?Nf(n,e.targets,t):n})}class Vf{constructor(e){this.parser=e,this.name="BL_decrypt"}beforeRoot(){const e=this.parser.json.asset,t=this.parser.json.accessors;if(e.copyright==="bestWay"&&e.encrypt===1&&t)for(let s=0;s<t.length-1;s++){const i=t[s];if(i.type==="VEC3"){i.count-=1;break}}}}const Li=new WeakMap;class jf extends ua{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,s,i){const r=new Nn(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,o=>{this.parse(o,t,i)},s,i)}parse(e,t,s=()=>{}){this.decodeDracoFile(e,t,null,null,j).catch(s)}decodeDracoFile(e,t,s,i,r=Je,o=()=>{}){const a={attributeIDs:s||this.defaultAttributeIDs,attributeTypes:i||this.defaultAttributeTypes,useUniqueIDs:!!s,vertexColorSpace:r};return this.decodeGeometry(e,a).then(t).catch(o)}decodeGeometry(e,t){const s=JSON.stringify(t);if(Li.has(e)){const l=Li.get(e);if(l.key===s)return l.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let i;const r=this.workerNextTaskID++,o=e.byteLength,a=this._getWorker(r,o).then(l=>(i=l,new Promise((h,d)=>{i._callbacks[r]={resolve:h,reject:d},i.postMessage({type:"decode",id:r,taskConfig:t,buffer:e},[e])}))).then(l=>this._createGeometry(l.geometry));return a.catch(()=>!0).then(()=>{i&&r&&this._releaseTask(i,r)}),Li.set(e,{key:s,promise:a}),a}_createGeometry(e){const t=new xt;e.index&&t.setIndex(new ie(e.index.array,1));for(let s=0;s<e.attributes.length;s++){const i=e.attributes[s],r=i.name,o=i.array,a=i.itemSize,l=new ie(o,a);r==="color"&&(this._assignVertexColorSpace(l,i.vertexColorSpace),l.normalized=!(o instanceof Float32Array)),t.setAttribute(r,l)}return t}_assignVertexColorSpace(e,t){if(t!==j)return;const s=new Z;for(let i=0,r=e.count;i<r;i++)s.fromBufferAttribute(e,i).convertSRGBToLinear(),e.setXYZ(i,s.r,s.g,s.b)}_loadLibrary(e,t){const s=new Nn(this.manager);return s.setPath(this.decoderPath),s.setResponseType(t),s.setWithCredentials(this.withCredentials),new Promise((i,r)=>{s.load(e,i,void 0,r)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(s=>{const i=s[0];e||(this.decoderConfig.wasmBinary=s[1]);const r=Wf.toString(),o=["/* draco decoder */",i,"","/* worker */",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([o]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const i=new Worker(this.workerSourceURL);i._callbacks={},i._taskCosts={},i._taskLoad=0,i.postMessage({type:"init",decoderConfig:this.decoderConfig}),i.onmessage=function(r){const o=r.data;switch(o.type){case"decode":i._callbacks[o.id].resolve(o);break;case"error":i._callbacks[o.id].reject(o);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+o.type+'"')}},this.workerPool.push(i)}else this.workerPool.sort(function(i,r){return i._taskLoad>r._taskLoad?-1:1});const s=this.workerPool[this.workerPool.length-1];return s._taskCosts[e]=t,s._taskLoad+=t,s})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this.workerSourceURL!==""&&URL.revokeObjectURL(this.workerSourceURL),this}}function Wf(){let n,e;onmessage=function(o){const a=o.data;switch(a.type){case"init":n=a.decoderConfig,e=new Promise(function(d){n.onModuleLoaded=function(u){d({draco:u})},DracoDecoderModule(n)});break;case"decode":const l=a.buffer,h=a.taskConfig;e.then(d=>{const u=d.draco,c=new u.Decoder;try{const f=t(u,c,new Int8Array(l),h),p=f.attributes.map(B=>B.array.buffer);f.index&&p.push(f.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:f},p)}catch(f){console.error(f),self.postMessage({type:"error",id:a.id,error:f.message})}finally{u.destroy(c)}});break}};function t(o,a,l,h){const d=h.attributeIDs,u=h.attributeTypes;let c,f;const p=a.GetEncodedGeometryType(l);if(p===o.TRIANGULAR_MESH)c=new o.Mesh,f=a.DecodeArrayToMesh(l,l.byteLength,c);else if(p===o.POINT_CLOUD)c=new o.PointCloud,f=a.DecodeArrayToPointCloud(l,l.byteLength,c);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!f.ok()||c.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+f.error_msg());const B={index:null,attributes:[]};for(const A in d){const m=self[u[A]];let g,C;if(h.useUniqueIDs)C=d[A],g=a.GetAttributeByUniqueId(c,C);else{if(C=a.GetAttributeId(c,o[d[A]]),C===-1)continue;g=a.GetAttribute(c,C)}const E=i(o,a,c,A,m,g);A==="color"&&(E.vertexColorSpace=h.vertexColorSpace),B.attributes.push(E)}return p===o.TRIANGULAR_MESH&&(B.index=s(o,a,c)),o.destroy(c),B}function s(o,a,l){const d=l.num_faces()*3,u=d*4,c=o._malloc(u);a.GetTrianglesUInt32Array(l,u,c);const f=new Uint32Array(o.HEAPF32.buffer,c,d).slice();return o._free(c),{array:f,itemSize:1}}function i(o,a,l,h,d,u){const c=u.num_components(),p=l.num_points()*c,B=p*d.BYTES_PER_ELEMENT,A=r(o,d),m=o._malloc(B);a.GetAttributeDataArrayForAllPoints(l,u,A,B,m);const g=new d(o.HEAPF32.buffer,m,p).slice();return o._free(m),{name:h,array:g,itemSize:c}}function r(o,a){switch(a){case Float32Array:return o.DT_FLOAT32;case Int8Array:return o.DT_INT8;case Int16Array:return o.DT_INT16;case Int32Array:return o.DT_INT32;case Uint8Array:return o.DT_UINT8;case Uint16Array:return o.DT_UINT16;case Uint32Array:return o.DT_UINT32}}}const ge=document.createElement("div");ge.style.position="fixed";ge.style.zIndex="9";ge.style.top="50%";ge.style.left="50%";ge.style.transform="translate(-50%, -50%)";ge.style.display="none";ge.style.textAlign="center";ge.style.flexDirection="column";ge.style.justifyContent="center";ge.style.alignItems="center";ge.style.userSelect="none";document.body.appendChild(ge);const qa=document.createElement("img");qa.src="./loading.webp ";ge.appendChild(qa);const Ko="Loading... ",Ds=document.createElement("span");Ds.style.fontSize="24px";Ds.style.opacity="1";Ds.style.color="#FFFFFF";ge.appendChild(Ds);const In={service(n){ge.style.display="flex",Ds.innerHTML=Ko+n+"%"},close(){ge.style.display="none",Ds.innerHTML=Ko+0+"%"}};(function(){var n="B9h79tEBBBENQ9gEUEU9gEUB9gBB9gVUUUUUEU9gDUUEU9gLUUUUEU9gVUUUUUB9gLUUUUB9gIUUUEU9gD99UE99I8ayDILEVLEVLOOOOORRVBWWBEdddLVE9wEIIVIEBEOWEUEC+g/KEKR/QIhO9tw9t9vv95DBh9f9f939h79t9f9j9h229f9jT9vv7BB8a9tw79o9v9wT9fw9u9j9v9kw9WwvTw949C919m9mwvBE8f9tw79o9v9wT9fw9u9j9v9kw9WwvTw949C919m9mwv9C9v919u9kBDe9tw79o9v9wT9fw9u9j9v9kw9WwvTw949Wwv79p9v9uBIy9tw79o9v9wT9fw9u9j9v9kw69u9kw949C919m9mwvBL8e9tw79o9v9wT9fw9u9j9v9kw69u9kw949C919m9mwv9C9v919u9kBV8a9tw79o9v9wT9fw9u9j9v9kw69u9kw949Wwv79p9v9uBOe9tw79o9v9wT9fw9u9j9v9kw69u9kw949Twg91w9u9jwBRA9tw79o9v9wT9fw9u9j9v9kw69u9kw949Twg91w9u9jw9C9v919u9kBWl9tw79o9v9wT9fw9u9j9v9kws9p2Twv9P9jTBdk9tw79o9v9wT9fw9u9j9v9kws9p2Twv9R919hTBQl9tw79o9v9wT9fw9u9j9v9kws9p2Twvt949wBKe9tw79o9v9wT9f9v9wT9p9t9p96w9WwvTw94j9h9j9owBpA9tw79o9v9wT9f9v9wT9p9t9p96w9WwvTw94j9h9j9ow9TTv9p9wBSA9tw79o9v9wT9f9v9wT9p9t9p96w9WwvTw94swT9j9o9Sw9t9h9wBZL79iv9rBhdWEBCEKDxcQ+1tyDBK/hKEyU8jJJJJBCJO9rGV8kJJJJBCBHODNALCEFAE0MBABCBrB+Q+KJJBC+gEv86BBAVCJDFCBCJDZ+TJJJB8aDNAItMBAVCJDFADALZmJJJB8aKABAEFHRABCEFHWAVALFCBCBCJDAL9rALCfE0eZ+TJJJB8aAVAVCJDFALZmJJJBHdCJ/ABAL9uHEDNDNALtMBAEC/wfBgGECJDAECJD6eHQCBHKINAKAI9PMEAdCJLFCBCJDZ+TJJJB8aAQAIAK9rAKAQFAI6eGXCSFGECL4CIFCD4HMADAKAL2FHpDNDNDNDNDNAEC9wgGStMBCBHZCEHhApHoAWHaXEKDNAXtMBCBHaCEHhApHcINAdAaFrBBHxAcHECBHOINAdCJLFAOFAErBBGqAx9rGxCETAxCkTCk91CR4786BBAEALFHEAqHxAOCEFGOAX9HMBKARAW9rAM6MIAWCBAMZ+TJJJBGEtMIAEAMFHWAcCEFHcAaCEFGaAL6HhAaAL9HMBXVKKARAW9rAM6MOAWCBAMZ+TJJJB8aCEHEINAWGxAMFHWALAEGOsMLDNARAW9rAM6MBAOCEFHEAWCBAMZ+TJJJB8aAxMEKKCBHWAOAL6MOXIKINDNAXtMBAdAZFrBBHxCBHEAoHOINAdCJLFAEFAOrBBGqAx9rGxCETAxCkTCk91CR4786BBAOALFHOAqHxAECEFGEAX9HMBKKARAa9rAM6MEARAaCBAMZ+TJJJBGlAMFGW9rCk6MDCBHkAdCJLFHcINAdCJLFAkFHyCWH8aCZHaCEHqINDNDNAqCE9HMBCUHOAyrBBMECBHODNINAOGECSsMEAECEFHOAcAEFCEFrBBtMBKKCUCBAECS6eHOXEKAqCETC/+fffEgHOCUAqTCU7CfEgHxCBHEINAOAxAcAEFrBB9NFHOAECEFGECZ9HMBKKAOAaAOAa6GEeHaAqA8aAEeH8aAqCETGqCW6MBKDNDNDNDNA8aCUFpDIEBKAlAkCO4FGEAErBBCDCIA8aCLseAkCI4COgTv86BBA8aCW9HMEAWAy8pBB83BBAWCWFAyCWF8pBB83BBAWCZFHWXDKAlAkCO4FGEAErBBCEAkCI4COgTv86BBKDNCWA8a9tGeMBINAWCB86BBAWCEFHWXBKKCUA8aTCU7HqCBH3AcH5INA5HEAeHxCBHOINAErBBGaAqAaAqCfEgGy6eAOCfEgA8aTvHOAECEFHEAxCUFGxMBKAWAO86BBA5AeFH5AWCEFHWA3AeFG3CZ6MBKCBHEINDNAcAEFrBBGOAy6MBAWAO86BBAWCEFHWKAECEFGECZ9HMBKKDNAkCZFGkAS9PMBAcCZFHcARAW9rCl0MEKKAkAS6MEAWtMEAoCEFHoAZCEFGZAL6HhAWHaAZALsMIXBKKCBHWAhCEgtMEXLKCBHWAhCEgMIKAdApAXCUFAL2FALZmJJJB8aAXAKFHKAWMBKCBHOXDKCBHOARAW9rCAALALCA6e6MEDNALC8f0MBAWCBCAAL9rGEZ+TJJJBAEFHWKAWAdCJDFALZmJJJBALFAB9rHOXEKCBHOKAVCJOF8kJJJJBAOK9HEEUAECAAECA0eABCJ/ABAE9uC/wfBgGDCJDADCJD6eGDFCUFAD9uAE2ADCL4CIFCD4ADv2FCEFKMBCBABbD+Q+KJJBK/YSE3U8jJJJJBC/AE9rGL8kJJJJBCBHVDNAICI9uGOChFAE0MBABCBYDn+KJJBGVC/gEv86BBALC/ABFCfECJEZ+TJJJB8aALCuFGR9CU83IBALC8wFGW9CU83IBALCYFGd9CU83IBALCAFGQ9CU83IBALCkFGK9CU83IBALCZFGX9CU83IBAL9CU83IWAL9CU83IBABAEFC9wFHMABCEFGpAOFHEDNAItMBCMCSAVCB9KGSeHZAVCE9IHhCBHoCBHaCBHcCBHxCBHqINDNAEAM9NMBCBHVXIKAqCUFHVADAcCDTFGOYDBHlAOCWFYDBHkAOCLFYDBHyCBH8aDNDNINALC/ABFAVCSgCITFGOYDLHeDNDNDNAOYDBGOAl9HMBAeAysMEKDNAOAy9HMBAeAk9HMBA8aCEFH8aXEKAOAk9HMEAeAl9HMEA8aCDFH8aKA8aC870MDAxCUFHVADA8aCIgCX2GOC+Y1JJBFYDBAcFCDTFYDBHeADAOCn1JJBFYDBAcFCDTFYDBHkADAOC+Q1JJBFYDBAcFCDTFYDBHlCBHODNINDNALAVCSgCDTFYDBAe9HMBAOHyXDKCUHyAVCUFHVAOCEFGOCZ9HMBKKAyCB9KAyAZ9IgGVCU7AeAosGOgH3DNDNDNDNDNAyCBCSAOeAVeGVCS9HMBAhMBAeAeAaAeCEFAasGVeGaCEFsMECMCSAVeHVKApAVA8aCDTC/wEgv86BBAVCS9HMEAeAa9rGVCETAVC8f917HVINAEAVCfB0CRTAVCfBgv86BBAECEFHEAVCJE6HOAVCR4HVAOtMBKAeHaXDKCpHVApA8aCDTCpv86BBAeHaKAVtMBAVAZ9IMEKALAxCDTFAebDBAxCEFCSgHxKAoA3FHoALC/ABFAqCITFGVAkbDLAVAebDBALC/ABFAqCEFCSgGVCITFGOAebDLAOAlbDBAVCEFHOXIKAVCUFHVA8aCLFG8aC/AB9HMBKKDNADCEAkAosCETAyAoseCX2GVC+Q1JJBFYDBAcFCDTFYDBGltADAVCn1JJBFYDBAcFCDTFYDBG8aCEsgADAVC+Y1JJBFYDBAcFCDTFYDBGyCDsgAoCB9HgASgG5CE9HMBAR9CU83IBAW9CU83IBAd9CU83IBAQ9CU83IBAK9CU83IBAX9CU83IBAL9CU83IWAL9CU83IBCBHoKCBHeAxCUFGVHODNINDNALAOCSgCDTFYDBA8a9HMBAeHkXDKCUHkAOCUFHOAeCEFGeCZ9HMBKKCBHODNINDNALAVCSgCDTFYDBAy9HMBAOHeXDKCUHeAVCUFHVAOCEFGOCZ9HMBKKAoAlAosG8eFH3DNDNAkCM0MBAkCEFHkXEKCBCSA8aA3sGVeHkA3AVFH3KDNDNAeCM0MBAeCEFHeXEKCBCSAyA3sGVeHeA3AVFH3KC9+CUA8eeH8fAeAkCLTvHOCBHVDNDNDNINAVCJ1JJBFrBBAOCfEgsMEAVCEFGVCZ9HMBXDKKAlAo9HAVCM0vA5vMBApAVC/wEv86BBXEKApA8f86BBAEAO86BBAECEFHEKDNA8eMBAlAa9rGVCETAVC8f917HVINAEAVCfB0GOCRTAVCfBgv86BBAVCR4HVAECEFHEAOMBKAlHaKDNAkCS9HMBA8aAa9rGVCETAVC8f917HVINAEAVCfB0GOCRTAVCfBgv86BBAVCR4HVAECEFHEAOMBKA8aHaKDNAeCS9HMBAyAa9rGVCETAVC8f917HVINAEAVCfB0GOCRTAVCfBgv86BBAVCR4HVAECEFHEAOMBKAyHaKALAxCDTFAlbDBAxCEFCSgHVDNDNAkpZBEEEEEEEEEEEEEEBEKALAVCDTFA8abDBAxCDFCSgHVKDNDNAepZBEEEEEEEEEEEEEEBEKALAVCDTFAybDBAVCEFCSgHVKALC/ABFAqCITFGOAlbDLAOA8abDBALC/ABFAqCEFCSgCITFGOA8abDLAOAybDBALC/ABFAqCDFCSgCITFGOAybDLAOAlbDBAqCIFHOAVHxA3HoKApCEFHpAOCSgHqAcCIFGcAI6MBKKCBHVAEAM0MBCBHVINAEAVFAVCJ1JJBFrBB86BBAVCEFGVCZ9HMBKAEAB9rAVFHVKALC/AEF8kJJJJBAVKzEEUCBHDDNINADCEFGDC8f0MECEADTAE6MBKKADCRFCfEgCR9uCI2CDFABCI9u2ChFKMBCBABbDn+KJJBK+cDEWU8jJJJJBCZ9rHLCBHVDNAICVFAE0MBCBHOABCBrBn+KJJBC/QEv86BBAL9CB83IWABCEFHRABAEFC98FHWDNAItMBCBHdINDNARAW6MBCBSKADAdCDTFYDBGQALCWFAOAQALCWFAOCDTFYDB9rGEAEC8f91GEFAE7C507GOCDTFGKYDB9rGEC8e91C9+gAECDT7AOvHEINARAECfB0GVCRTAECfBgv86BBAECR4HEARCEFHRAVMBKAKAQbDBAdCEFGdAI9HMBKKCBHVARAW0MBARCBbBBARAB9rCLFHVKAVKbEEUCBHDDNINADCEFGDC8f0MECEADTAE6MBKKADCWFCfEgCR9uAB2CVFK+DVLI99DUI99LUDNAEtMBCUADCETCUFTCU7+yHVDNDNCUAICUFTCU7+yGOjBBBzmGR+LjBBB9P9dtMBAR+oHWXEKCJJJJ94HWKCBHICBHdINALCLFiDBGRjBBBBjBBJzALiDBGQ+LAR+LmALCWFiDBGK+LmGR+VARjBBBB9beGRnHXAQARnHRALCXFiDBHQDNDNAKjBBBB9gtMBAXHKXEKjBBJzAR+L+TGKAK+MAXjBBBB9geHKjBBJzAX+L+TGXAX+MARjBBBB9geHRKDNDNAQjBBJ+/AQjBBJ+/9geGXjBBJzAXjBBJz9feAVnjBBBzjBBB+/AQjBBBB9gemGQ+LjBBB9P9dtMBAQ+oHMXEKCJJJJ94HMKDNDNAKjBBJ+/AKjBBJ+/9geGQjBBJzAQjBBJz9feAOnjBBBzjBBB+/AKjBBBB9gemGQ+LjBBB9P9dtMBAQ+oHpXEKCJJJJ94HpKDNDNARjBBJ+/ARjBBJ+/9geGQjBBJzAQjBBJz9feAOnjBBBzjBBB+/ARjBBBB9gemGR+LjBBB9P9dtMBAR+oHSXEKCJJJJ94HSKDNDNADCL9HMBABAdFGZAS86BBAZCIFAM86BBAZCDFAW86BBAZCEFAp86BBXEKABAIFGZAS87EBAZCOFAM87EBAZCLFAW87EBAZCDFAp87EBKALCZFHLAICWFHIAdCLFHdAECUFGEMBKKK/KLLD99EUD99EUDNAEtMBDNDNCUAICUFTCU7+yGVjBBBzmGO+LjBBB9P9dtMBAO+oHIXEKCJJJJ94HIKAIC/8fIgHRINABCOFCICDALCLFiDB+LALiDB+L9eGIALCWFiDB+LALAICDTFiDB+L9eeGIALCXFiDB+LALAICDTFiDB+L9eeGIARv87EBDNDNALAICEFCIgCDTFiDBj/zL+1znjBBJ+/jBBJzALAICDTFiDBjBBBB9deGOnGWjBBJ+/AWjBBJ+/9geGdjBBJzAdjBBJz9feAVnjBBBzjBBB+/AWjBBBB9gemGW+LjBBB9P9dtMBAW+oHQXEKCJJJJ94HQKABAQ87EBDNDNAOALAICDFCIgCDTFiDBj/zL+1znnGWjBBJ+/AWjBBJ+/9geGdjBBJzAdjBBJz9feAVnjBBBzjBBB+/AWjBBBB9gemGW+LjBBB9P9dtMBAW+oHQXEKCJJJJ94HQKABCDFAQ87EBDNDNAOALAICUFCIgCDTFiDBj/zL+1znnGOjBBJ+/AOjBBJ+/9geGWjBBJzAWjBBJz9feAVnjBBBzjBBB+/AOjBBBB9gemGO+LjBBB9P9dtMBAO+oHIXEKCJJJJ94HIKABCLFAI87EBABCWFHBALCZFHLAECUFGEMBKKK+7DDWUE998jJJJJBCZ9rGV8kJJJJBDNAEtMBADCL6MBCEAI9rHOADCD4GDCEADCE0eHRADCDTHWCBHdINC+cUHDALHIARHQINAIiDBAVCXFZ+XJJJB8aAVYDXGKADADAK9IeHDAICLFHIAQCUFGQMBKAOADFGICkTHKCBHDCBAI9rHXARHIINDNDNALADFiDBGMAXZ+WJJJBjBBBzjBBB+/AMjBBBB9gemGM+LjBBB9P9dtMBAM+oHQXEKCJJJJ94HQKABADFAQCfffRgAKvbDBADCLFHDAICUFGIMBKABAWFHBALAWFHLAdCEFGdAE9HMBKKAVCZF8kJJJJBK/tKDcUI998jJJJJBC+QD9rGV8kJJJJBAVC+oEFCBC/kBZ+TJJJB8aCBHODNADtMBCBHOAItMBDNABAE9HMBAVCUADCDTGOADCffffI0eCBYD1+KJJBhJJJJBBGEbD+oEAVCEbD1DAEABAOZmJJJB8aKAVC+YEFCWFCBbDBAV9CB83I+YEAVC+YEFAEADAIAVC+oEFZ+NJJJBCUAICDTGRAICffffI0eGWCBYD1+KJJBhJJJJBBHOAVC+oEFAVYD1DGdCDTFAObDBAVAdCEFGQbD1DAOAVYD+YEGKARZmJJJBHXAVC+oEFAQCDTFADCI9uGMCBYD1+KJJBhJJJJBBGObDBAVAdCDFGRbD1DAOCBAMZ+TJJJBHpAVC+oEFARCDTFAWCBYD1+KJJBhJJJJBBGSbDBAVAdCIFGQbD1DAXHOASHRINARALiDBALAOYDBGWCWAWCW6eCDTFC/EBFiDBmuDBAOCLFHOARCLFHRAICUFGIMBKAVC+oEFAQCDTFCUAMCDTADCffff970eCBYD1+KJJBhJJJJBBGQbDBAVAdCLFbD1DDNADCI6MBAMCEAMCE0eHIAEHOAQHRINARASAOYDBCDTFiDBASAOCLFYDBCDTFiDBmASAOCWFYDBCDTFiDBmuDBAOCXFHOARCLFHRAICUFGIMBKKAVC/MBFHZAVYD+cEHhAVYD+gEHoAVHOCBHWCBHRCBHaCEHcINAOHxCIHqAEARCI2GlCDTFGOCWFYDBHkAOYDBHDABAaCX2FGICLFAOCLFYDBGdbDBAIADbDBAICWFAkbDBApARFCE86BBAZAkbDWAZAdbDLAZADbDBAQARCDTFCBbDBDNAWtMBCIHqAxHIINDNAIYDBGOADsMBAOAdsMBAOAksMBAZAqCDTFAObDBAqCEFHqKAICLFHIAWCUFGWMBKKAaCEFHaAXADCDTFGOAOYDBCUFbDBAXAdCDTFGOAOYDBCUFbDBAXAkCDTFGOAOYDBCUFbDBCBHWINAoAhAEAWAlFCDTFYDBCDTGIFYDBCDTFGkHOAKAIFGdYDBGDHIDNADtMBDNINAOYDBARsMEAOCLFHOAICUFGItMDXBKKAOADCDTAkFC98FYDBbDBAdAdYDBCUFbDBKAWCEFGWCI9HMBKDNDNDNAqtMBCUHRjBBBBHyCBHOINASAZAOCDTFYDBCDTGIFGWiDBH8aAWALCBAOCEFGdAOCS0eCDTFiDBALAXAIFYDBGOCWAOCW6eCDTFC/EBFiDBmGeuDBDNAKAIFYDBGWtMBAeA8a+THeAoAhAIFYDBCDTFHOAWCDTHIINAQAOYDBGWCDTFGDAeADiDBmG8auDBA8aAyAyA8a9dGDeHyAWARADeHRAOCLFHOAIC98FGIMBKKAdHOAdAq9HMBKARCU9HMEKAcAM9PMEINDNApAcFrBBMBAcHRXDKAMAcCEFGc9HMBXDKKAqCZAqCZ6eHWAZHOAxHZARCU9HMEKKAVYD1DHOKAOCDTAVC+oEFFC98FHRDNINAOtMEARYDBCBYD+E+KJJBh+BJJJBBARC98FHRAOCUFHOXBKKAVC+QDF8kJJJJBK/uLEVUCUAICDTGVAICffffI0eGOCBYD1+KJJBhJJJJBBHRALALYD9gGWCDTFARbDBALAWCEFbD9gABARbDBAOCBYD1+KJJBhJJJJBBHRALALYD9gGOCDTFARbDBALAOCEFbD9gABARbDLCUADCDTADCffffI0eCBYD1+KJJBhJJJJBBHRALALYD9gGOCDTFARbDBALAOCEFbD9gABARbDWABYDBCBAVZ+TJJJB8aADCI9uHWDNADtMBABYDBHOAEHLADHRINAOALYDBCDTFGVAVYDBCEFbDBALCLFHLARCUFGRMBKKDNAItMBABYDBHLABYDLHRCBHVAIHOINARAVbDBARCLFHRALYDBAVFHVALCLFHLAOCUFGOMBKKDNADCI6MBAWCEAWCE0eHdABYDLHRABYDWHVCBHLINAECWFYDBHOAECLFYDBHDARAEYDBCDTFGWAWYDBGWCEFbDBAVAWCDTFALbDBARADCDTFGDADYDBGDCEFbDBAVADCDTFALbDBARAOCDTFGOAOYDBGOCEFbDBAVAOCDTFALbDBAECXFHEAdALCEFGL9HMBKKDNAItMBABYDLHEABYDBHLINAEAEYDBALYDB9rbDBALCLFHLAECLFHEAICUFGIMBKKKqBABAEADAIC+01JJBZ+MJJJBKqBABAEADAIC+c+JJJBZ+MJJJBK9dEEUABCfEAICDTZ+TJJJBHLCBHIDNADtMBINDNALAEYDBCDTFGBYDBCU9HMBABAIbDBAICEFHIKAECLFHEADCUFGDMBKKAIK9TEIUCBCBYD+M+KJJBGEABCIFC98gFGBbD+M+KJJBDNDNABzBCZTGD9NMBCUHIABAD9rCffIFCZ4NBCUsMEKAEHIKAIK/lEEEUDNDNAEABvCIgtMBABHIXEKDNDNADCZ9PMBABHIXEKABHIINAIAEYDBbDBAICLFAECLFYDBbDBAICWFAECWFYDBbDBAICXFAECXFYDBbDBAICZFHIAECZFHEADC9wFGDCS0MBKKADCL6MBINAIAEYDBbDBAECLFHEAICLFHIADC98FGDCI0MBKKDNADtMBINAIAErBB86BBAICEFHIAECEFHEADCUFGDMBKKABK/AEEDUDNDNABCIgtMBABHIXEKAECfEgC+B+C+EW2HLDNDNADCZ9PMBABHIXEKABHIINAIALbDBAICXFALbDBAICWFALbDBAICLFALbDBAICZFHIADC9wFGDCS0MBKKADCL6MBINAIALbDBAICLFHIADC98FGDCI0MBKKDNADtMBINAIAE86BBAICEFHIADCUFGDMBKKABK9TEIUCBCBYD+M+KJJBGEABCIFC98gFGBbD+M+KJJBDNDNABzBCZTGD9NMBCUHIABAD9rCffIFCZ4NBCUsMEKAEHIKAIK9+EIUzBHEDNDNCBYD+M+KJJBGDAECZTGI9NMBCUHEADAI9rCffIFCZ4NBCUsMEKADHEKCBABAE9rCIFC98gCBYD+M+KJJBFGDbD+M+KJJBDNADzBCZTGE9NMBADAE9rCffIFCZ4NB8aKKXBABAEZ+YJJJBK+BEEIUDNAB+8GDCl4GICfEgGLCfEsMBDNALMBDNABjBBBB9cMBAECBbDBABSKABjBBJ9fnAEZ+XJJJBHBAEAEYDBCNFbDBABSKAEAICfEgC+CUFbDBADCfff+D94gCJJJ/4Iv++HBKABK+gEBDNDNAECJE9IMBABjBBBUnHBDNAECfE9PMBAEC+BUFHEXDKABjBBBUnHBAECPDAECPD6eC+C9+FHEXEKAEC+BU9KMBABjBBJXnHBDNAEC+b9+9NMBAEC/mBFHEXEKABjBBJXnHBAEC+299AEC+2990eC/MEFHEKABAEClTCJJJ/8IF++nKK+eDDBCJWK+EDB4+H9W9n94+p+Gw+J9o+YE9pBBBBBBEBBBDBBBEBBBDBBBBBBBDBBBBBBBEBBBBBBB+L29Hz/69+9Kz/n/76z/RG97z/Z/O9Xz8j/b85z/+/U9Yz/B/K9hz+2/z9dz9E+L9Mz59a8kz+R/t3z+a+Zyz79ohz/J4++8++y+d9v8+BBBB9S+49+z8r+Hbz9m9m/m8+l/Z/O8+/8+pg89Q/X+j878r+Hq8++m+b/E87BBBBBBJzBBJzBBJz+e/v/n8++y+dSz9I/h/68+XD/r8+/H0838+/w+nOzBBBB+wv9o8+UF888+9I/h/68+9C9g/l89/N/M9M89/d8kO8+BBBBF+8Tz9M836zs+2azl/Zpzz818ez9E+LXz/u98f8+819e/68+BC+EQKXEBBBDBBBAwBB",e=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]);if(typeof WebAssembly!="object")return{supported:!1};var t,s=WebAssembly.instantiate(i(n),{}).then(function(c){t=c.instance,t.exports.__wasm_call_ctors(),t.exports.meshopt_encodeVertexVersion(0),t.exports.meshopt_encodeIndexVersion(1)});function i(c){for(var f=new Uint8Array(c.length),p=0;p<c.length;++p){var B=c.charCodeAt(p);f[p]=B>96?B-71:B>64?B-65:B>47?B+4:B>46?63:62}for(var A=0,p=0;p<c.length;++p)f[A++]=f[p]<60?e[f[p]]:(f[p]-60)*64+f[++p];return f.buffer.slice(0,A)}function r(c){if(!c)throw new Error("Assertion failed")}function o(c){return new Uint8Array(c.buffer,c.byteOffset,c.byteLength)}function a(c,f,p){var B=t.exports.sbrk,A=B(c.length*4),m=B(f*4),g=new Uint8Array(t.exports.memory.buffer),C=o(c);g.set(C,A),p&&p(A,A,c.length,f);var E=t.exports.meshopt_optimizeVertexFetchRemap(m,A,c.length,f);g=new Uint8Array(t.exports.memory.buffer);var D=new Uint32Array(f);new Uint8Array(D.buffer).set(g.subarray(m,m+f*4)),C.set(g.subarray(A,A+c.length*4)),B(A-B(0));for(var b=0;b<c.length;++b)c[b]=D[c[b]];return[D,E]}function l(c,f,p,B,A){var m=t.exports.sbrk,g=m(f),C=m(B*A),E=new Uint8Array(t.exports.memory.buffer);E.set(o(p),C);var D=c(g,f,C,B,A),b=new Uint8Array(D);return b.set(E.subarray(g,g+D)),m(g-m(0)),b}function h(c){for(var f=0,p=0;p<c.length;++p){var B=c[p];f=f<B?B:f}return f}function d(c,f){if(r(f==2||f==4),f==4)return new Uint32Array(c.buffer,c.byteOffset,c.byteLength/4);var p=new Uint16Array(c.buffer,c.byteOffset,c.byteLength/2);return new Uint32Array(p)}function u(c,f,p,B,A,m){var g=t.exports.sbrk,C=g(p*B),E=g(p*m),D=new Uint8Array(t.exports.memory.buffer);D.set(o(f),E),c(C,p,B,A,E);var b=new Uint8Array(p*B);return b.set(D.subarray(C,C+p*B)),g(C-g(0)),b}return{ready:s,supported:!0,reorderMesh:function(c,f,p){var B=f?p?t.exports.meshopt_optimizeVertexCacheStrip:t.exports.meshopt_optimizeVertexCache:void 0;return a(c,h(c)+1,B)},encodeVertexBuffer:function(c,f,p){r(p>0&&p<=256),r(p%4==0);var B=t.exports.meshopt_encodeVertexBufferBound(f,p);return l(t.exports.meshopt_encodeVertexBuffer,B,c,f,p)},encodeIndexBuffer:function(c,f,p){r(p==2||p==4),r(f%3==0);var B=d(c,p),A=t.exports.meshopt_encodeIndexBufferBound(f,h(B)+1);return l(t.exports.meshopt_encodeIndexBuffer,A,B,f,4)},encodeIndexSequence:function(c,f,p){r(p==2||p==4);var B=d(c,p),A=t.exports.meshopt_encodeIndexSequenceBound(f,h(B)+1);return l(t.exports.meshopt_encodeIndexSequence,A,B,f,4)},encodeGltfBuffer:function(c,f,p,B){var A={ATTRIBUTES:this.encodeVertexBuffer,TRIANGLES:this.encodeIndexBuffer,INDICES:this.encodeIndexSequence};return r(A[B]),A[B](c,f,p)},encodeFilterOct:function(c,f,p,B){return r(p==4||p==8),r(B>=1&&B<=16),u(t.exports.meshopt_encodeFilterOct,c,f,p,B,16)},encodeFilterQuat:function(c,f,p,B){return r(p==8),r(B>=4&&B<=16),u(t.exports.meshopt_encodeFilterQuat,c,f,p,B,16)},encodeFilterExp:function(c,f,p,B){return r(p>0&&p%4==0),r(B>=1&&B<=24),u(t.exports.meshopt_encodeFilterExp,c,f,p,B,p)}}})();var er=function(){var n="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",e="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",t=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),s=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]);if(typeof WebAssembly!="object")return{supported:!1};var i=n;WebAssembly.validate(t)&&(i=e);var r,o=WebAssembly.instantiate(a(i),{}).then(function(u){r=u.instance,r.exports.__wasm_call_ctors()});function a(u){for(var c=new Uint8Array(u.length),f=0;f<u.length;++f){var p=u.charCodeAt(f);c[f]=p>96?p-71:p>64?p-65:p>47?p+4:p>46?63:62}for(var B=0,f=0;f<u.length;++f)c[B++]=c[f]<60?s[c[f]]:(c[f]-60)*64+c[++f];return c.buffer.slice(0,B)}function l(u,c,f,p,B,A){var m=r.exports.sbrk,g=f+3&-4,C=m(g*p),E=m(B.length),D=new Uint8Array(r.exports.memory.buffer);D.set(B,E);var b=u(C,f,p,E,B.length);if(b==0&&A&&A(C,g,p),c.set(D.subarray(C,C+f*p)),m(C-m(0)),b!=0)throw new Error("Malformed buffer data: "+b)}var h={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},d={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:o,supported:!0,decodeVertexBuffer:function(u,c,f,p,B){l(r.exports.meshopt_decodeVertexBuffer,u,c,f,p,r.exports[h[B]])},decodeIndexBuffer:function(u,c,f,p){l(r.exports.meshopt_decodeIndexBuffer,u,c,f,p)},decodeIndexSequence:function(u,c,f,p){l(r.exports.meshopt_decodeIndexSequence,u,c,f,p)},decodeGltfBuffer:function(u,c,f,p,B,A){l(r.exports[d[B]],u,c,f,p,r.exports[h[A]])}}}();(function(){var n="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iDZGK+TjBBBB+XGQALiDLALiDcGX+TGMAMAQ9deGQALiDWALiDkGM+TGpApAQ9deHpDNABtMBADtMBjBBBBjBBJzAp+VApjBBBB9beHQINABAQABiDBAK+TnuDBABCLFGIAQAIiDBAX+TnuDBABCWFGIAQAIiDBAM+TnuDBABCXFHBADCUFGDMBKKApK+qDIDUI99DUCBHI8jJJJJBCA9rGLCZFCWFCBYD11JJBbDBALCB8pDJ1JJB83IZALCWFCBYDn1JJBbDBALCB8pD+M1JJB83IBDNDNAEMBjBBJfHVjBBJfHOjBBJfHRXEKADCD4CDTHWINCBHDINALCZFADFGdABADFiDBGOAdiDBGRARAO9eeuDBALADFGdAOAdiDBGRARAO9deuDBADCLFGDCX9HMBKABAWFHBAICEFGIAE9HMBKALiDWALiDk+THRALiDLALiDc+THOALiDBALiDZ+THVKAVjBBBB+XGVAOAOAV9deGOARARAO9deK9dEEUABCfEAICDTZ1JJJBHLCBHIDNADtMBINDNALAEYDBCDTFGBYDBCU9HMBABAIbDBAICEFHIKAECLFHEADCUFGDMBKKAIK9TEIUCBCBYD/01JJBGEABCIFC98gFGBbD/01JJBDNDNABzBCZTGD9NMBCUHIABAD9rCffIFCZ4NBCUsMEKAEHIKAIK/lEEEUDNDNAEABvCIgtMBABHIXEKDNDNADCZ9PMBABHIXEKABHIINAIAEYDBbDBAICLFAECLFYDBbDBAICWFAECWFYDBbDBAICXFAECXFYDBbDBAICZFHIAECZFHEADC9wFGDCS0MBKKADCL6MBINAIAEYDBbDBAECLFHEAICLFHIADC98FGDCI0MBKKDNADtMBINAIAErBB86BBAICEFHIAECEFHEADCUFGDMBKKABK/AEEDUDNDNABCIgtMBABHIXEKAECfEgC+B+C+EW2HLDNDNADCZ9PMBABHIXEKABHIINAIALbDBAICXFALbDBAICWFALbDBAICLFALbDBAICZFHIADC9wFGDCS0MBKKADCL6MBINAIALbDBAICLFHIADC98FGDCI0MBKKDNADtMBINAIAE86BBAICEFHIADCUFGDMBKKABK9TEIUCBCBYD/01JJBGEABCIFC98gFGBbD/01JJBDNDNABzBCZTGD9NMBCUHIABAD9rCffIFCZ4NBCUsMEKAEHIKAIK9+EIUzBHEDNDNCBYD/01JJBGDAECZTGI9NMBCUHEADAI9rCffIFCZ4NBCUsMEKADHEKCBABAE9rCIFC98gCBYD/01JJBFGDbD/01JJBDNADzBCZTGE9NMBADAE9rCffIFCZ4NB8aKK6EIUCBHIDNADtMBDNINABrBBGLAErBBGV9HMEAECEFHEABCEFHBADCUFGDMBXDKKALAV9rHIKAIKK+CEDBCJWK9pffUUffUUffUUffUfffUfffUfBBBBBBBBEEEBEEBEBBEEEBEBBBBBEBEBBBBBEBBBDBBBBBBBBBBBBBBBEEEEEBEBBBBBEBBBBBEEBBBBBBC/sWKXEBBBDBBBJ9kBB",e=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]);if(typeof WebAssembly!="object")return{supported:!1};var t,s=WebAssembly.instantiate(i(n),{}).then(function(c){t=c.instance,t.exports.__wasm_call_ctors()});function i(c){for(var f=new Uint8Array(c.length),p=0;p<c.length;++p){var B=c.charCodeAt(p);f[p]=B>96?B-71:B>64?B-65:B>47?B+4:B>46?63:62}for(var A=0,p=0;p<c.length;++p)f[A++]=f[p]<60?e[f[p]]:(f[p]-60)*64+f[++p];return f.buffer.slice(0,A)}function r(c){if(!c)throw new Error("Assertion failed")}function o(c){return new Uint8Array(c.buffer,c.byteOffset,c.byteLength)}function a(c,f){var p=t.exports.sbrk,B=p(c.length*4),A=p(f*4),m=new Uint8Array(t.exports.memory.buffer),g=o(c);m.set(g,B);var C=t.exports.meshopt_optimizeVertexFetchRemap(A,B,c.length,f);m=new Uint8Array(t.exports.memory.buffer);var E=new Uint32Array(f);new Uint8Array(E.buffer).set(m.subarray(A,A+f*4)),g.set(m.subarray(B,B+c.length*4)),p(B-p(0));for(var D=0;D<c.length;++D)c[D]=E[c[D]];return[E,C]}function l(c){for(var f=0,p=0;p<c.length;++p){var B=c[p];f=f<B?B:f}return f}function h(c,f,p,B,A,m,g,C,E){var D=t.exports.sbrk,b=D(4),S=D(p*4),y=D(A*m),w=D(p*4),F=new Uint8Array(t.exports.memory.buffer);F.set(o(B),y),F.set(o(f),w);var I=c(S,w,p,y,A,m,g,C,E,b);F=new Uint8Array(t.exports.memory.buffer);var T=new Uint32Array(I);o(T).set(F.subarray(S,S+I*4));var L=new Float32Array(1);return o(L).set(F.subarray(b,b+4)),D(b-D(0)),[T,L[0]]}function d(c,f,p,B){var A=t.exports.sbrk,m=A(p*B),g=new Uint8Array(t.exports.memory.buffer);g.set(o(f),m);var C=c(m,p,B);return A(m-A(0)),C}var u={LockBorder:1};return{ready:s,supported:!0,compactMesh:function(c){r(c instanceof Uint32Array||c instanceof Int32Array||c instanceof Uint16Array||c instanceof Int16Array),r(c.length%3==0);var f=c.BYTES_PER_ELEMENT==4?c:new Uint32Array(c);return a(f,l(c)+1)},simplify:function(c,f,p,B,A,m){r(c instanceof Uint32Array||c instanceof Int32Array||c instanceof Uint16Array||c instanceof Int16Array),r(c.length%3==0),r(f instanceof Float32Array),r(f.length%p==0),r(p>=3),r(B%3==0);for(var g=0,C=0;C<(m?m.length:0);++C)g|=u[m[C]];var E=c.BYTES_PER_ELEMENT==4?c:new Uint32Array(c),D=h(t.exports.meshopt_simplify,E,c.length,f,f.length,p*4,B,A,g);return D[0]=c instanceof Uint32Array?D[0]:new c.constructor(D[0]),D},getScale:function(c,f){return r(c instanceof Float32Array),r(c.length%f==0),d(t.exports.meshopt_simplifyScale,c,c.length,f*4)}}})();const Xf=new rc(function(){In.close(),bd()},function(e,t,s){In.service((100*t/s).toFixed(2))},function(e){console.error("Error loading:",e),In.close()}),Un=new df(Xf),Za=new jf;Za.setDecoderPath("./draco/");Un.setDRACOLoader(Za);async function Yf(){try{console.log("🔄 正在初始化 MeshoptDecoder..."),await er.ready,Un.setMeshoptDecoder(er),console.log("✅ MeshoptDecoder 已成功配置")}catch(n){console.warn("⚠️ MeshoptDecoder 配置失败:",n)}}Yf();class qf{constructor(){this.mixers=new Map,this.materialFlows=new Map,this.clock=new ra,this.isPlaying=!1}addMixer(e,t){this.mixers.set(e,t),this.clock.start()}addMaterialFlow(e,t){this.materialFlows.set(e,{speedX:t,originalOffset:e.userData.originalOffset})}update(){if(this.isPlaying){const e=this.clock.getDelta();this.mixers.forEach(t=>{t.update(e)}),this.materialFlows.forEach((t,s)=>{s.map&&s.map.offset&&(s.map.offset.x+=t.speedX,s.map.offset.x>1&&(s.map.offset.x-=1))})}}play(){this.isPlaying=!0}stop(){this.isPlaying=!1}removeMaterialFlow(e){this.materialFlows.delete(e)}clearMaterialFlows(){this.materialFlows.clear()}}const qs=new qf;function Jo(n,e){if(n.animations&&n.animations.length>0){const t=new oc(e);n.animations.forEach(s=>{const i=t.clipAction(s);i.setLoop(ac),i.clampWhenFinished=!0,i.play()}),qs.addMixer(e,t),qs.play(),console.log(`✅ 模型 ${e.name||"unnamed"} 的 ${n.animations.length} 个动画已自动播放`)}Zf(e)}function Zf(n){n.traverse(t=>{t.isMesh&&t.name&&t.name.includes("move")&&t.material&&(Array.isArray(t.material)?t.material.forEach(s=>{s.map&&(s.userData.originalOffset||(s.userData.originalOffset={x:s.map.offset.x,y:s.map.offset.y}),qs.addMaterialFlow(s,-.0048))}):t.material.map&&(t.material.userData.originalOffset||(t.material.userData.originalOffset={x:t.material.map.offset.x,y:t.material.map.offset.y}),qs.addMaterialFlow(t.material,-.0048)),console.log(`✅ 为包含"move"的mesh "${t.name}" 添加材质流动动画`))})}async function Br(n,e,t){try{await er.ready}catch(i){console.warn("⚠️ MeshoptDecoder 初始化失败，但继续加载模型:",i)}const s=[];if(In.service(0),yd(),Array.isArray(n))n.forEach(i=>{if(i.type!==".glb"&&i.type!==".gltf")return;const r=Un.loadAsync(i.path).then(o=>{Jo(o,o.scene),e(o,i.name)});s.push(r)});else{if(n.type!==".glb"&&n.type!==".gltf")return;const i=Un.loadAsync(n.path).then(r=>{Jo(r,r.scene),e(r,n.name)});s.push(i)}return Promise.all(s).then(()=>{t&&t()})}class Qf extends xt{constructor(e=3e3,t=!1){super(),isNaN(e)?this._initByData(e.pathPointList,e.options,e.usage,t):this._initByMaxVertex(e,t)}_initByMaxVertex(e,t){this.setAttribute("position",new ie(new Float32Array(e*3),3).setUsage(Us)),this.setAttribute("normal",new ie(new Float32Array(e*3),3).setUsage(Us)),this.setAttribute("uv",new ie(new Float32Array(e*2),2).setUsage(Us)),t&&this.setAttribute("uv2",new ie(new Float32Array(e*2),2).setUsage(Us)),this.drawRange.start=0,this.drawRange.count=0,this.setIndex(e>65536?new _r(e*3,1):new Ur(e*3,1))}_initByData(e,t={},s,i){const r=zo(e,t,i);r&&r.count!==0?(this.setAttribute("position",new ie(new Float32Array(r.position),3).setUsage(s||tn)),this.setAttribute("normal",new ie(new Float32Array(r.normal),3).setUsage(s||tn)),this.setAttribute("uv",new ie(new Float32Array(r.uv),2).setUsage(s||tn)),i&&this.setAttribute("uv2",new ie(new Float32Array(r.uv2),2).setUsage(s||tn)),this.setIndex(r.position.length/3>65536?new _r(r.indices,1):new Ur(r.indices,1))):this._initByMaxVertex(2,i)}update(e,t={}){const s=!!this.getAttribute("uv2"),i=zo(e,t,s);i?(this._updateAttributes(i.position,i.normal,i.uv,s?i.uv2:null,i.indices),this.drawRange.count=i.count):this.drawRange.count=0}_resizeAttribute(e,t){let s=this.getAttribute(e);for(;s.array.length<t;){const i=s.array.length,r=new ie(new Float32Array(i*2),s.itemSize,s.normalized);r.name=s.name,r.usage=s.usage,this.setAttribute(e,r),s=r}}_resizeIndex(e){let t=this.getIndex();for(;t.array.length<e;){const s=t.array.length,i=new ie(s*2>65535?new Uint32Array(s*2):new Uint16Array(s*2),1);i.name=t.name,i.usage=t.usage,this.setIndex(i),t=i}}_updateAttributes(e,t,s,i,r){this._resizeAttribute("position",e.length);const o=this.getAttribute("position");o.array.set(e,0),o.updateRange.count=e.length,o.needsUpdate=!0,this._resizeAttribute("normal",t.length);const a=this.getAttribute("normal");a.array.set(t,0),a.updateRange.count=t.length,a.needsUpdate=!0,this._resizeAttribute("uv",s.length);const l=this.getAttribute("uv");if(l.array.set(s,0),l.updateRange.count=s.length,l.needsUpdate=!0,i){this._resizeAttribute("uv2",i.length);const d=this.getAttribute("uv2");d.array.set(i,0),d.updateRange.count=i.length,d.needsUpdate=!0}this._resizeIndex(r.length);const h=this.getIndex();h.set(r,0),h.updateRange.count=r.length,h.needsUpdate=!0}}function zo(n,e,t=!1){const s=e.width||.1,i=e.progress!==void 0?e.progress:1,r=e.arrow!==void 0?e.arrow:!0,o=e.side!==void 0?e.side:"both",a=s/2,l=o!=="both"?s/2:s,h=n.distance(),d=i*h;if(h==0)return null;const u=a/l,c=a/h;let f=0;const p=[],B=[],A=[],m=[],g=[];let C=0;const E=new M,D=new M,b=new M,S=new M,y=new M,w=new M;function F(x){const R=p.length===0,H=x.sharp&&!R,W=x.dist/h,se=x.dist/h,ae=x.dir,k=x.up,Ht=x.right;if(o!=="left"?E.copy(Ht).multiplyScalar(a*x.widthScale):E.set(0,0,0),o!=="right"?D.copy(Ht).multiplyScalar(-a*x.widthScale):D.set(0,0,0),E.add(x.pos),D.add(x.pos),H){b.fromArray(p,p.length-6).sub(D),S.fromArray(p,p.length-3).sub(E);const Fe=b.length(),we=S.length(),At=Fe-we;let Ts,Rt;At>0?(Ts=b,Rt=D):(Ts=S,Rt=E),y.copy(Ts).setLength(Math.abs(At)).add(Rt);let si=w.copy(Rt).sub(y).normalize().dot(ae),ni=w.copy(Rt).sub(y).length(),$s=si*ni*2;w.copy(ae).setLength($s).add(y),At>0?(p.push(y.x,y.y,y.z,E.x,E.y,E.z,D.x,D.y,D.z,E.x,E.y,E.z,w.x,w.y,w.z,E.x,E.y,E.z),C+=6,g.push(C-6,C-8,C-7,C-6,C-7,C-5,C-4,C-6,C-5,C-2,C-4,C-1),f+=12):(p.push(D.x,D.y,D.z,y.x,y.y,y.z,D.x,D.y,D.z,E.x,E.y,E.z,D.x,D.y,D.z,w.x,w.y,w.z),C+=6,g.push(C-6,C-8,C-7,C-6,C-7,C-5,C-6,C-5,C-3,C-2,C-3,C-1),f+=12),B.push(k.x,k.y,k.z,k.x,k.y,k.z,k.x,k.y,k.z,k.x,k.y,k.z,k.x,k.y,k.z,k.x,k.y,k.z),A.push(W-u,0,W-u,1,W,0,W,1,W+u,0,W+u,1),t&&m.push(se-c,0,se-c,1,se,0,se,1,se+c,0,se+c,1)}else p.push(D.x,D.y,D.z,E.x,E.y,E.z),B.push(k.x,k.y,k.z,k.x,k.y,k.z),A.push(W,0,W,1),t&&m.push(se,0,se,1),C+=2,R||(g.push(C-2,C-4,C-3,C-2,C-3,C-1),f+=6)}const I=new M;function T(x){const R=x.dir,H=x.up,W=x.right,se=x.dist/l,ae=x.dist/h;o!=="left"?E.copy(W).multiplyScalar(a*2):E.set(0,0,0),o!=="right"?D.copy(W).multiplyScalar(-a*2):D.set(0,0,0),I.copy(R).setLength(a*3),E.add(x.pos),D.add(x.pos),I.add(x.pos),p.push(D.x,D.y,D.z,E.x,E.y,E.z,I.x,I.y,I.z),B.push(H.x,H.y,H.z,H.x,H.y,H.z,H.x,H.y,H.z),A.push(se,o!=="both"?o!=="right"?-2:0:-.5,se,o!=="both"?o!=="left"?2:0:1.5,se+1.5,o!=="both"?0:.5),t&&m.push(ae,o!=="both"?o!=="right"?-2:0:-.5,ae,o!=="both"?o!=="left"?2:0:1.5,ae+1.5*s/h,o!=="both"?0:.5),C+=3,g.push(C-1,C-3,C-2),f+=3}let L;if(d>0)for(let x=0;x<n.count;x++){const R=n.array[x];if(R.dist>d){const H=n.array[x-1];L=new lc;const W=(d-H.dist)/(R.dist-H.dist);L.lerpPathPoints(H,R,W),F(L);break}else F(R)}else L=n.array[0];return r&&(L=L||n.array[n.count-1],T(L)),{position:p,normal:B,uv:A,uv2:m,indices:g,count:f}}var st,Qa,$a,el,tl;class $f extends K{constructor(t,s={}){super();Y(this,st);this.elapsedTime={value:0};const i={value:s.seg},r={value:s.modelPosition},o={time:this.elapsedTime,seg:i,position:r,uColor:s.uColor};this.geometry=Q(this,st,Qa).call(this,t),this.material=Q(this,st,$a).call(this,o)}update(t){this.elapsedTime.value=t}}st=new WeakSet,Qa=function(t){const s=new M(0,1,0),i=new cc;i.set(t,.5,10,s,!1);const r=new Qf;return r.update(i,{width:3.2,arrow:!1,side:"both"}),r},$a=function(t){return new Be({uniforms:{uElapseTime:t.time,uSeg:t.seg,modelPosition:t.position,edgeColor:{value:new Z("#fffffff")},uColor:{value:t.uColor||new Z("#00DC3B")}},vertexShader:Q(this,st,el).call(this),fragmentShader:Q(this,st,tl).call(this),side:Me,forceSinglePass:!0})},el=function(){return`
      uniform float uElapseTime;
      varying vec2 st;

      #include <common>
      #include <uv_pars_vertex>
      #include <normal_pars_vertex>
      #include <logdepthbuf_pars_vertex>

      void main() {
      	#include <uv_vertex>
      	#include <beginnormal_vertex>
      	#include <defaultnormal_vertex>
      	#include <normal_vertex>
      	#include <begin_vertex>
        st = uv;
      	#include <project_vertex>
      	#include <logdepthbuf_vertex>
      	#include <worldpos_vertex>
      }`},tl=function(){return`
      uniform float uSeg;
      uniform float modelPosition;
      uniform vec3 uColor;
      uniform vec3 edgeColor;
    uniform float uElapseTime;
    varying vec2 st;


      void rotate2d(inout vec2 v, float a) {
       mat2 m = mat2(cos(a), -sin(a), sin(a), cos(a));
       v = m * v;
      }
       float arrow(vec2 av) {
        float line1L = 0.5;
         float line1 = length(av - vec2(clamp(av.x, -line1L, line1L), 0.));
         line1 = smoothstep(0.06, 0.05, line1);

         vec2 rav = av;
         rav.x -= line1L + 0.03;
         rotate2d(rav, 3.1415/1.54);

         float arrowL = 0.39;
         float line2 = length(rav - vec2(clamp(rav.x, 0., arrowL), 0.));
         line2 = smoothstep(0.06, 0.05, line2);

         rotate2d(rav, -3.1415 * 1.3 );
         float line3 = length(rav - vec2(clamp(rav.x, 0., arrowL),0.));
         line3 = smoothstep(0.06, 0.05, line3);

         return clamp(line2 + line3 , 0., 1.);
      }
    #include <common>
    #include <packing>
    #include <color_pars_fragment>
    #include <uv_pars_fragment>
    #include <normal_pars_fragment>
    #include <logdepthbuf_pars_fragment>
    #include <clipping_planes_pars_fragment>

    void main() {
    	#include <logdepthbuf_fragment>
    	#include <normal_fragment_begin>
    	#include <normal_fragment_maps>
     #include <dithering_fragment>

      float p = uSeg; //线段段数
      vec2 nst = (st * 2.0)-1.0;
      vec2 vSt = vec2(fract(nst.x * p- uElapseTime), nst.y);
          vec3 col;
          float a = arrow(vSt) ;
          vec3 cola = uColor;  //底色
          vec3 colb = edgeColor;
          col = mix(cola,colb,a);

          float al = 1.0;
          // float al = a;
          if(abs(0.5 - st.y) >= 0.4){
            float s = smoothstep(0.4, 0.5,abs(0.5 - st.y));
            col = mix(cola,colb,s);
            al = 1.0;
          }
          gl_FragColor = vec4(col,al);
    }
`};class ep{constructor(e,t){this.core=t,this.scene=e,this.cherryArray=[],this.path=[],this.gatherMap=new Map,this.realTimeMap=new Map,this.trackGroup=new ee,this.trackGroup.name="逃生路线",this.scene._add(this.trackGroup)}setCherryArray(e){this.cherryArray=e}cherryPick(){this.trackGroup.traverse(e=>{e instanceof K&&(e.visible=this.cherryArray.includes("escapeRoute"))}),this.cherryArray.includes("escapeRoute")?(this.core.core.postprocessing.setNoSelection(this.path),this.core.core.postprocessing.addOutline(this.path,1)):(this.core.core.postprocessing.clearOutline(this.path,1),this.core.core.postprocessing.clearNoSelection())}init(e){e.forEach(({id:t,data:s,name:i})=>{const r=s.map(l=>{let h=Xn({sceneType:1,originId:"",coordinate:l});return new M(h.x,h.y+.1,h.z)}),o=new hc(r);let a=new $f(r,{seg:Math.floor(o.getLength())/4});a.material.depthTest=!0,a.visible=this.cherryArray.includes("escapeRoute"),this.trackGroup.add(a),this.path.push(a)})}dispose(){[...this.path].forEach(e=>{e.deleteSelf()}),this.path=[],console.log(this.path,this.trackGroup),this.core.core.postprocessing.clearOutline(this.path,1)}update(e){this.path.forEach(t=>{t&&t.update(e.elapsedTime)})}}class kn extends uc{constructor(e){super(e),this.type=sn}parse(e){const o=function(y,w){switch(y){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(w||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(w||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(w||""));default:case 4:throw new Error("THREE.RGBELoader: Memory Error: "+(w||""))}},d=`
`,u=function(y,w,F){w=w||1024;let T=y.pos,L=-1,x=0,R="",H=String.fromCharCode.apply(null,new Uint16Array(y.subarray(T,T+128)));for(;0>(L=H.indexOf(d))&&x<w&&T<y.byteLength;)R+=H,x+=H.length,T+=128,H+=String.fromCharCode.apply(null,new Uint16Array(y.subarray(T,T+128)));return-1<L?(y.pos+=x+L+1,R+H.slice(0,L)):!1},c=function(y){const w=/^#\?(\S+)/,F=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,I=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,T=/^\s*FORMAT=(\S+)\s*$/,L=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,x={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let R,H;for((y.pos>=y.byteLength||!(R=u(y)))&&o(1,"no header found"),(H=R.match(w))||o(3,"bad initial token"),x.valid|=1,x.programtype=H[1],x.string+=R+`
`;R=u(y),R!==!1;){if(x.string+=R+`
`,R.charAt(0)==="#"){x.comments+=R+`
`;continue}if((H=R.match(F))&&(x.gamma=parseFloat(H[1])),(H=R.match(I))&&(x.exposure=parseFloat(H[1])),(H=R.match(T))&&(x.valid|=2,x.format=H[1]),(H=R.match(L))&&(x.valid|=4,x.height=parseInt(H[1],10),x.width=parseInt(H[2],10)),x.valid&2&&x.valid&4)break}return x.valid&2||o(3,"missing format specifier"),x.valid&4||o(3,"missing image size specifier"),x},f=function(y,w,F){const I=w;if(I<8||I>32767||y[0]!==2||y[1]!==2||y[2]&128)return new Uint8Array(y);I!==(y[2]<<8|y[3])&&o(3,"wrong scanline width");const T=new Uint8Array(4*w*F);T.length||o(4,"unable to allocate buffer space");let L=0,x=0;const R=4*I,H=new Uint8Array(4),W=new Uint8Array(R);let se=F;for(;se>0&&x<y.byteLength;){x+4>y.byteLength&&o(1),H[0]=y[x++],H[1]=y[x++],H[2]=y[x++],H[3]=y[x++],(H[0]!=2||H[1]!=2||(H[2]<<8|H[3])!=I)&&o(3,"bad rgbe scanline format");let ae=0,k;for(;ae<R&&x<y.byteLength;){k=y[x++];const Fe=k>128;if(Fe&&(k-=128),(k===0||ae+k>R)&&o(3,"bad scanline data"),Fe){const we=y[x++];for(let At=0;At<k;At++)W[ae++]=we}else W.set(y.subarray(x,x+k),ae),ae+=k,x+=k}const Ht=I;for(let Fe=0;Fe<Ht;Fe++){let we=0;T[L]=W[Fe+we],we+=I,T[L+1]=W[Fe+we],we+=I,T[L+2]=W[Fe+we],we+=I,T[L+3]=W[Fe+we],L+=4}se--}return T},p=function(y,w,F,I){const T=y[w+3],L=Math.pow(2,T-128)/255;F[I+0]=y[w+0]*L,F[I+1]=y[w+1]*L,F[I+2]=y[w+2]*L,F[I+3]=1},B=function(y,w,F,I){const T=y[w+3],L=Math.pow(2,T-128)/255;F[I+0]=nn.toHalfFloat(Math.min(y[w+0]*L,65504)),F[I+1]=nn.toHalfFloat(Math.min(y[w+1]*L,65504)),F[I+2]=nn.toHalfFloat(Math.min(y[w+2]*L,65504)),F[I+3]=nn.toHalfFloat(1)},A=new Uint8Array(e);A.pos=0;const m=c(A),g=m.width,C=m.height,E=f(A.subarray(A.pos),g,C);let D,b,S;switch(this.type){case ds:S=E.length/4;const y=new Float32Array(S*4);for(let F=0;F<S;F++)p(E,F*4,y,F*4);D=y,b=ds;break;case sn:S=E.length/4;const w=new Uint16Array(S*4);for(let F=0;F<S;F++)B(E,F*4,w,F*4);D=w,b=sn;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:g,height:C,data:D,header:m.string,gamma:m.gamma,exposure:m.exposure,type:b}}setDataType(e){return this.type=e,this}load(e,t,s,i){function r(o,a){switch(o.type){case ds:case sn:o.colorSpace=Je,o.minFilter=Ft,o.magFilter=Ft,o.generateMipmaps=!1,o.flipY=!0;break}t&&t(o,a)}return super.load(e,r,s,i)}}class sl extends Vt{constructor(e=null){super();const t=new dc;t.deleteAttribute("uv");const s=new Xs({side:ls}),i=new Xs;let r=5;e!==null&&e._useLegacyLights===!1&&(r=900);const o=new da(16777215,r,28,2);o.position.set(.418,16.199,.3),this.add(o);const a=new K(t,s);a.position.set(-.757,13.219,.717),a.scale.set(31.713,28.305,28.591),this.add(a);const l=new K(t,i);l.position.set(-10.906,2.009,1.846),l.rotation.set(0,-.195,0),l.scale.set(2.328,7.905,4.651),this.add(l);const h=new K(t,i);h.position.set(-5.607,-.754,-.758),h.rotation.set(0,.994,0),h.scale.set(1.97,1.534,3.955),this.add(h);const d=new K(t,i);d.position.set(6.167,.857,7.803),d.rotation.set(0,.561,0),d.scale.set(3.927,6.285,3.687),this.add(d);const u=new K(t,i);u.position.set(-2.017,.018,6.124),u.rotation.set(0,.333,0),u.scale.set(2.002,4.566,2.064),this.add(u);const c=new K(t,i);c.position.set(2.291,-.756,-2.621),c.rotation.set(0,-.286,0),c.scale.set(1.546,1.552,1.496),this.add(c);const f=new K(t,i);f.position.set(-2.193,-.369,-5.547),f.rotation.set(0,.516,0),f.scale.set(3.875,3.487,2.986),this.add(f);const p=new K(t,as(50));p.position.set(-16.116,14.37,8.208),p.scale.set(.1,2.428,2.739),this.add(p);const B=new K(t,as(50));B.position.set(-16.109,18.021,-8.207),B.scale.set(.1,2.425,2.751),this.add(B);const A=new K(t,as(17));A.position.set(14.904,12.198,-1.832),A.scale.set(.15,4.265,6.331),this.add(A);const m=new K(t,as(43));m.position.set(-.462,8.89,14.52),m.scale.set(4.38,5.441,.088),this.add(m);const g=new K(t,as(20));g.position.set(3.235,11.486,-12.541),g.scale.set(2.5,2,.1),this.add(g);const C=new K(t,as(100));C.position.set(0,20,0),C.scale.set(1,.1,1),this.add(C)}dispose(){const e=new Set;this.traverse(t=>{t.isMesh&&(e.add(t.geometry),e.add(t.material))});for(const t of e)t.dispose()}}function as(n){const e=new ct;return e.color.setScalar(n),e}function Kn(n,e=[],t=!1,s=1){if(n instanceof K){const{geometry:i,material:r}=n,o=new fa(i,r,e.length);return o.instanceMatrix.setUsage(Us),!e||e.length===0?(console.error(`${n.name}:创建实例化对象，无位置信息`),new ee):(e.forEach((a,l)=>{const h=new oe;let d=1;if(Array.isArray(s)){const[u,c]=s;d=u+Math.random()*(c-u)}else d=parseFloat(s);if(h.makeScale(d,d,d),h.setPosition(a),t)if(t.length){const u=new oe().makeRotationFromEuler(t[l]);h.multiply(u)}else h.multiply(new oe().makeRotationY(Math.random()*Math.PI*2));o.setMatrixAt(l,h),o.castShadow=!0}),o)}else if(n instanceof ee){const i=new ee;return n.traverse(r=>{r instanceof K&&i.add(Kn(r,e,t,s))}),i}else{const i=new ee;return n.children.forEach(r=>{i.add(Kn(r,e,t,s))}),i}}const Qe=n=>{const e=new ce;e.setFromObject(n);const t=e.getCenter(new M),s=e.max.distanceTo(t);return{center:t,radius:s,min:e.min,max:e.max,boundingBox:e}},tp=(n,e,t,s,i)=>{let r=document.createElement("div"),o=document.createElement("div");o.append(r),o.draggable=!1,o.className="beilu_three_Board_text_person",r.innerText=n;let a=Te(o),l=null;return r.onclick=h=>{l&&(clearTimeout(l),l=null),l=setTimeout(()=>{e&&e(a,h),l=null},250)},r.ondblclick=h=>{l&&(clearTimeout(l),l=null),t&&t(a,h)},s&&(r.onmouseenter=h=>{s(a,h)}),i&&(r.onmouseleave=h=>{i(a,h)}),a},sp=(n,e=!1)=>{let t=document.createElement("div"),s=document.createElement("div");s.append(t),s.draggable=!1,s.className="buildingNum",t.innerText=n;let i=Te(s);return i.visible=e,i},Vo=new N,jo=new N;class np{constructor(e){O(this,"onmousedown",e=>{this.getMouse(e,Vo)});O(this,"onmouseup",e=>{if(this.getMouse(e,jo),!!Vo.equals(jo)){if(e.button===2){this.removeListener(),this.helper.active=!1,le.dispose(this.label,!0),this.label=null,this.addCloseButton(this.hitPoint);return}this.hitPoint&&(this.helper.addPoint(this.hitPoint),this.label&&(this.label.visible=this.helper.count!==0),this.createLabel2(this.hitPoint))}});O(this,"onkeyup",e=>{console.log("触发键盘操作"),e.key==="Escape"&&(this.helper.deletePoint(),this.updateLabel(),this.label.visible=this.helper.count!==0,le.dispose(this.labels.pop(),!0))});O(this,"getMouse",(e,t)=>{const{left:s,top:i,width:r,height:o}=this.core.domElement.getBoundingClientRect();t.x=(e.clientX-s)/r*2-1,t.y=-((e.clientY-i)/o)*2+1});O(this,"raycastOnmousemove",e=>{e.length?(this.hitPoint=e[0].point,this.helper.updateMoveLine(this.hitPoint),!this.label&&this.helper.count>0?this.createLabel():this.label&&this.updateLabel()):this.hitPoint=null});this.core=e.core,this.scene=e.scene,this.subsystem=e,this.active=!1,this.raycastObject=null,this.hitPoint=null,this.helper=new Ar(this.scene),this.core.onresizeQueue.set(Symbol(),this.helper.onresize),this.labels=[]}setRaycastObject(e){this.raycastObject=e}start(){this.active!==!0&&(this.active=!0,this.helper.active=!0,this.mousedownControls=this.core.addEventListener("mousedown"),this.mouseupControls=this.core.addEventListener("mouseup"),this.keyupControls=this.core.addEventListener("keyup"),this.mousedownControls.add(this.onmousedown),this.mouseupControls.add(this.onmouseup),this.keyupControls.add(this.onkeyup),this.raycastControls=this.core.raycast("mousemove",this.raycastObject,this.raycastOnmousemove))}removeListener(){console.log("触发移除监听"),this.helper.active===!0&&(this.helper.active=!1,this.mousedownControls.clear(),this.mouseupControls.clear(),this.keyupControls.clear(),this.raycastControls.clear())}end(){(this.active=!1)||(this.active=!1,this.removeListener(),this.helper.dispose(),le.dispose([this.label,this.labels],!0),this.labels.length=0,this.label=null)}createLabel(){const e=document.createElement("div");e.className="measure-container";const t=tt({innerText:"0m",className:"area-label"});e.appendChild(t),this.label=Te(e),this.scene.add(this.label)}createLabel2(e){const t=document.createElement("div");t.className="measure-container";const s=this.helper.getTotalLength(2),i=tt({innerText:s+"m",className:"area-label"});t.appendChild(i);let r=Te(t);r.position.set(e.x,e.y+10,e.z),this.labels.push(r),this.scene.add(r)}addCloseButton(e){const t=tt({innerText:"X",className:"measure-close"});this.labels[this.labels.length-1].element.appendChild(t),t.onclick=()=>{this.end(),this.start()}}updateLabel(){const e=this.label.element;if(e){const t=this.helper.getTotalLength(2);e.children[0].innerText=t+"m",this.hitPoint&&this.setLabelPosition(this.hitPoint)}}setLabelPosition(e,t=10){this.label.position.set(e.x,e.y+t,e.z)}}const Wo=new N,Xo=new N;class ip{constructor(e){O(this,"onmousedown",e=>{this.getMouse(e,Wo)});O(this,"onmouseup",e=>{this.getMouse(e,Xo),Wo.equals(Xo)&&this.hitPoint&&(this.helper.addPoint(this.hitPoint),this.label&&(this.label.visible=this.helper.count!==0),this.helper.isClosed&&(this.removeListener(),this.setLabelData(this.helper.getArea(2)),this.setLabelPosition(this.helper.getCenter()),this.addCloseButton(this.hitPoint)))});O(this,"onkeyup",e=>{e.key==="Escape"&&(this.helper.deletePoint(),this.label.visible=this.helper.count!==0,this.updateLabel())});O(this,"getMouse",(e,t)=>{const{left:s,top:i,width:r,height:o}=this.core.domElement.getBoundingClientRect();t.x=(e.clientX-s)/r*2-1,t.y=-((e.clientY-i)/o)*2+1});O(this,"raycastOnmousemove",e=>{e.length?(this.hitPoint=e[0].point,this.helper.updateMoveLine(this.hitPoint),!this.label&&this.helper.count>0?this.createLabel():this.label&&this.updateLabel()):this.hitPoint=null});this.core=e.core,this.scene=e.scene,this.subsystem=e,this.active=!1,this.raycastObject=null,this.hitPoint=null,this.helper=new Ar(this.scene),this.helper.needToAdhereToFirstPoint=!0,this.helper.closestDistanceToAdhere=10,this.helper.needCheckLinesCross=!0,this.core.onresizeQueue.set(Symbol(),this.helper.onresize)}setRaycastObject(e){this.raycastObject=e}start(){this.active!==!0&&(this.active=!0,this.helper.active=!0,this.mousedownControls=this.core.addEventListener("mousedown"),this.mouseupControls=this.core.addEventListener("mouseup"),this.keyupControls=this.core.addEventListener("keyup"),this.mousedownControls.add(this.onmousedown),this.mouseupControls.add(this.onmouseup),this.keyupControls.add(this.onkeyup),this.raycastControls=this.core.raycast("mousemove",this.raycastObject,this.raycastOnmousemove))}removeListener(){this.helper.active===!0&&(this.helper.active=!1,this.mousedownControls.clear(),this.mouseupControls.clear(),this.keyupControls.clear(),this.raycastControls.clear())}end(){this.active!==!1&&(this.active=!1,this.removeListener(),this.helper.dispose(),this.label&&this.label.deleteSelf(),this.label=null)}createLabel(){const e=document.createElement("div");e.className="measure-container";const t=tt({innerText:"0m²",className:"area-label"});e.appendChild(t),this.label=Te(e),this.scene.add(this.label)}updateLabel(){this.label.element&&this.setLabelPosition(this.hitPoint)}addCloseButton(e){const t=tt({innerText:"X",className:"measure-close"});this.label.element.appendChild(t),t.onclick=()=>{this.end(),this.start()}}setLabelPosition(e,t=20){this.label.position.set(e.x,e.y+t,e.z)}setLabelData(e){this.label.element&&(this.label.element.children[0].innerText=e+"m²")}}class rp{constructor(e,t){this.core=t,this.scene=e,this.fenceObj={},this.dangerFence=null,this.dangerFenceGroup=new ee,this.dangerFenceGroupName="dangerFence",this.scene._add(this.dangerFenceGroup),this.FenceGroup=new ee,this.FenceGroupName="FenceGroup",this.scene._add(this.FenceGroup),this.buildingFenceGroup=new ee,this.FenceGroupName="buildingFence",this.scene._add(this.buildingFenceGroup),this.textures=this.createTextures()}create(e){const{fenceData:t,id:s,name:i,type:r}=e;if(this.fenceObj[s])return console.log("围栏已存在"),!1;let o=[],a=[];t.map((g,C)=>{o.push([g.position.x,g.position.y,g.position.z]),C<t.length-1&&a.push(g.position)});const l=[],h=10,d=new xt,u=[],c=[],f=o.reduce((g,C,E)=>{let D=0;if(E>0){let b=new M(...o[E-1]),S=new M(...C);D=b.distanceTo(S)}return g+=D,l.push(g),g},0);o.forEach((g,C)=>{if(C==0)return;const E=o[C-1];u.push(...E),c.push(l[C-1]/f,0),u.push(...g),c.push(l[C]/f,0),u.push(E[0],E[1]+h,E[2]),c.push(l[C-1]/f,1),u.push(...g),c.push(l[C]/f,0),u.push(g[0],g[1]+h,g[2]),c.push(l[C]/f,1),u.push(E[0],E[1]+h,E[2]),c.push(l[C-1]/f,1)}),d.setAttribute("position",new ie(new Float32Array(u),3)),d.setAttribute("uv",new ie(new Float32Array(c),2));const p=new ct({map:this.textures[r],transparent:!0,opacity:1,depthWrite:!1,depthTest:!0,side:Me,forceSinglePass:!0}),B=new K(d,p);B.material.onBeforeCompile=g=>{const C=`
      vec3 outgoingLight = reflectedLight.indirectDiffuse;
      outgoingLight.xyz *= 1.8;
      `;g.fragmentShader=g.fragmentShader.replace("vec3 outgoingLight = reflectedLight.indirectDiffuse",C)};let A=this.getCenter(a),m=this.createLabel(i,A,this.boardClick.bind(this));r==="danger"&&(m=this.createDangerLabel(i,A,this.boardClick.bind(this))),m.position.set(A.x,16,A.z),r==="building"?(this.buildingFenceGroup.add(m),this.buildingFenceGroup.add(B),this.cameraMove(i)):r==="area"?(this.fenceObj[s]={mesh:B,label:m},this.FenceGroup.add(m),this.FenceGroup.add(B)):r==="danger"&&(this.dangerFence={mesh:B,label:m},this.dangerFenceGroup.add(m),this.dangerFenceGroup.add(B),this.core.tweenControl.lerpTo(A,50,1e3,new M(-40,40,0)))}getCenter(e,t=new M){const s=t;return e.forEach(i=>{s.addScaledVector(i,1/e.length)}),s}createTextures(){const e={danger:"/textures/areaNice/03.png",building:"/textures/areaNice/02.png",area:"/textures/areaNice/03.png"},t=new Oe,s={};return Reflect.ownKeys(e).forEach(r=>{const o=t.load(e[r]);o.wrapS=Ve,o.wrapT=Ve,o.repeat.set(-1,2),s[r]=o}),s}boardClick(e){this.core.tweenControl.lerpTo(e,50,1e3,new M(0,10,0))}createLabel(e,t,s){let i=document.createElement("img"),r=document.createElement("img");i.className="by_arrow_left",i.src="/textures/arrow_left.png",r.className="by_arrow_right",r.src="/textures/arrow_right.png";const o=tt({innerText:e,className:"by_label_b",children:[i,r]});return typeof s=="function"&&(o.onclick=()=>{s(t)}),Te(o)}createDangerLabel(e,t,s){const i=tt({innerText:e,className:"by_label_b_danger"});return typeof s=="function"&&(i.onclick=()=>{s(t)}),Te(i)}clearDangerFence(){this.dangerFence=null;for(let e=this.dangerFenceGroup.children.length-1;e>=0;e--)this.dangerFenceGroup.children[e].deleteSelf()}clearBuildingFence(){this.dangerFence=null;for(let e=this.buildingFenceGroup.children.length-1;e>=0;e--)this.buildingFenceGroup.children[e].deleteSelf()}clearFence(){this.fenceObj={};for(let e=this.FenceGroup.children.length-1;e>=0;e--)this.FenceGroup.children[e].deleteSelf()}initDangerFence(e){this.clearDangerFence(),this.create(e,!0)}dispose(){this.clearDangerFence(),this.clearFence(),this.clearBuildingFence()}update(){if(!this.textures)return!1;Reflect.ownKeys(this.textures).forEach(e=>{const t=this.textures[e];t.offset.y-=.01})}cameraMove(e){const t={化工分公司:{camera:{x:-337,y:857,z:616},controls:{x:-350,y:3,z:-306}},热电分公司:{camera:{x:-1033,y:666,z:-77},controls:{x:-1033,y:74,z:-543}},水泥有限公司:{camera:{x:-960,y:677,z:272},controls:{x:-960,y:-16,z:-93}}},s=t[e].camera,i=t[e].controls,r=this.core.camera,o=this.core.controls;return new Promise((a,l)=>{this.core.tweenControl.changeTo({start:r.position,end:s,duration:1e3,onComplete:()=>{o.enabled=!0,a()},onStart:()=>{o.enabled=!1}}),this.core.tweenControl.changeTo({start:o.target,end:i,duration:1e3,onUpdate:()=>{r.lookAt(o.target)}})})}}function op(){return new Be({transparent:!0,vertexShader:ap,fragmentShader:lp,side:Me,uniforms:{uTime:fc,uStyle:Yn}})}const ap=`
#include <logdepthbuf_pars_vertex>
#include <common>
${Ba}
varying vec2 st;

void main(){
  st = uv;

  #include <begin_vertex>
  #include <project_vertex>
  #include <logdepthbuf_vertex>
}
`,lp=`

${Ba}
varying vec2 st;
uniform float uTime;
uniform float uStyle;
#define TAU 6.28318530718
#define MAX_ITER 5


#include <logdepthbuf_pars_fragment>
void main() {


  float time = uTime * .5+23.0;

  vec2 q = st * 0.3;
      vec2 p = mod(q*TAU, TAU)-250.0;

   vec2 i = vec2(p);
   float c = 1.0;
   float inten = .005;

   for (int n = 0; n < MAX_ITER; n++)
   {
    float t = time * (1.0 - (3.5 / float(n+1)));
    i = p + vec2(cos(t - i.x) + sin(t + i.y), sin(t - i.y) + cos(t + i.x));
    c += 1.0/length(vec2(p.x / (sin(i.x+t)/inten),p.y / (cos(i.y+t)/inten)));
   }
   c /= float(MAX_ITER);
   c = 1.17-pow(c, 1.4);
   vec3 color = vec3(pow(abs(c), 8.0));
      color = clamp(color + vec3(0.0, 0.35, 0.5), 0.0, 1.0);

   if(uStyle == ${pc}.){
     gl_FragColor = vec4(color, 0.4);
   }else if(uStyle == ${Ac}.){
    gl_FragColor = vec4(color*0.1,0.4);
   }

   ${Bc}
 #include <logdepthbuf_fragment>
}
`;function cp(n,e={value:0},t=new Z(16776960),s){const i={uTime:e,uColor:t,num:s};n.onBeforeCompile=r=>{Pt(r,"gatherFenceEffect",i)}}function hp(n,e=1800,t=3e3){const s={fade:e,land:t};n.onBeforeCompile=i=>{Pt(i,"edgeFadeDis",s)}}function up(n,e=10){const t={strength:e};n.onBeforeCompile=s=>{Pt(s,"brighten",t)}}function dp(n,e=10){const t={strength:e,uStyle:Yn};n.onBeforeCompile=s=>{Pt(s,"brightenNight",t)}}function fp(n,e){const t={uTime:e};n.onBeforeCompile=s=>{Pt(s,"fadeByTime",t)}}function pp(n,e,t=new Z("#3acacc")){const s={uTime:e,uBox:gc,lightIndex:mc,uColor:t};n.onBeforeCompile=i=>{Pt(i,"dynamicFade",s)}}function Ap(n){const e={uStyle:Yn};n.onBeforeCompile=t=>{Pt(t,"glassEffect",e)}}function Yo(n,e=new Z("#59FFD3")){const t={uStyle:Yn,uColor:e};n.onBeforeCompile=s=>{Pt(s,"treeModify",t)}}function Bp(n,e=.5){const t=new Oe().load("./textures/water_normal.jpg");t.wrapS=t.wrapT=Ve,n.normalMap=t,n.normalScale.set(e,e)}function mp(n){const e=n.core,t=e.camera,s=e.controls;let i;function r(){clearTimeout(i),s.autoRotate=!1,s.rotateSpeed=1,i=setTimeout(()=>{s.target.copy(Jn.Default.target),t.position.copy(Jn.Default.position),s.autoRotate=!0,s.rotateSpeed=.01},n.roamDuration*1e3)}function o(){n.core.domElement.addEventListener("mousemove",r)}function a(){n.core.domElement.removeEventListener("mousemove",r),clearTimeout(i)}const l=()=>({begin:o,updateCameraState:r,stop:a});return n.useCameraState=l,l}const gp=op();function Cp(n,e){const t=e.onRenderQueue||e.core.onRenderQueue,s=n.material;if(s.name.includes("镜面水")){n.visible=!1;const i=new ce;i.setFromObject(n);const r=new Cc(i,100,100),o=r.mesh;n.getWorldPosition(o.position),o.rotation.z=n.rotation.y,t.set(Symbol(),r.update.bind(r)),e.add(o)}else s.name.includes("水")&&(n.material=gp);s.name.includes("漆面")&&(s.roughness=.5,s.metalness=.5,Bp(s,.1)),s.name.includes("夜光玻璃")?(s.transparent=!0,Ap(s)):s.name.includes("夜光")?dp(s,20):s.name.includes("发光")&&(up(s,10),n.castShadow=!1,e.bloomLights.push(n)),s.name.includes("边缘虚化")&&(s.transparent=!0,hp(s,1600,2800)),s.needsUpdate=!0}function Ep(n,e,t){n.isMesh&&(Dp(n),Cp(n,t))}function Dp(n,e,t){n.material,(["shu3_2","shu4_2"].includes(n.name)||n.name.includes("_1"))&&Yo(n.material)}class vp{constructor(e,t){this.core=t,this.scene=e,this.fenceObj={},this.FenceGroup=new ee,this.FenceGroupName="FenceGroup",this.scene._add(this.FenceGroup),this.elapsedTime={value:0},this.gatherColor={green:new Z("#00DC3B"),yellow:new Z("#FFBC00")},this.gatherModelColor={green:new Z(0,.2,0),yellow:new Z(.2,.2,0)},this.textures=this.createShaders()}create(e){const{id:t,type:s,areaType:i,areaDataOut:r,areaDataBuilding:o,areaName:a}=e;if(this.fenceObj[t])return console.log("围栏已存在"),!1;let l=s===1?"green":"yellow";if(i===1){let h=[],d=[],u=[];r.map((S,y)=>{let w=Xn({sceneType:1,originId:"",coordinate:S});h.push([w.x,w.y,w.z]),u.push(w.x,w.y,w.z),y<r.length-1&&d.push(w)});const c=[];let f=this.createLine(u,l);const p=10,B=new xt,A=[],m=[],g=h.reduce((S,y,w)=>{let F=0;if(w>0){let I=new M(...h[w-1]),T=new M(...y);F=I.distanceTo(T)}return S+=F,c.push(S),S},0);h.forEach((S,y)=>{if(y==0)return;const w=h[y-1];A.push(...w),m.push(c[y-1]/g,0),A.push(...S),m.push(c[y]/g,0),A.push(w[0],w[1]+p,w[2]),m.push(c[y-1]/g,1),A.push(...S),m.push(c[y]/g,0),A.push(S[0],S[1]+p,S[2]),m.push(c[y]/g,1),A.push(w[0],w[1]+p,w[2]),m.push(c[y-1]/g,1)}),B.setAttribute("position",new ie(new Float32Array(A),3)),B.setAttribute("uv",new ie(new Float32Array(m),2));const C=this.textures[l],E=new K(B,C);E.renderOrder=32;let D=this.getCenter(d),b=this.createLabel(a,D,this.boardClick.bind(this),s);b.position.set(D.x,16,D.z),this.fenceObj[t]={object3d:E,label:b,type:"fence",line:f},this.FenceGroup.add(b),this.FenceGroup.add(E),this.FenceGroup.add(f)}if(i===2){let h=this.core.singleBuildingGroup,d=this.core.buildingMeshObj;if(!h[o]&&!d[o])return console.log("楼栋信息在三维场景中不在");let u=h[o]||d[o],c=this.gatherModel(u,s,a);this.fenceObj[t]={object3d:u,label:c,type:"geometry"},this.FenceGroup.add(c)}console.log(this.FenceGroup,this.core,"FenceGroup")}createLine(e,t){let s=new ti({color:this.gatherColor[t],linewidth:5,dashed:!1,depthTest:!1});s.resolution.set(window.innerWidth,window.innerHeight);const i=new Ys;i.setPositions(e);let r=new Yi(i,s);return r.computeLineDistances(),r.scale.set(1,1,1),r}gatherModel(e,t,s){let i=t===1?"green":"yellow";e.traverse(h=>{if(h instanceof K)if(h.material.length){let d=[];h.material.map(u=>{let c=u.clone();c.transparent=!0,c.opacity=.88,c.emissive=this.gatherModelColor[i],d.push(c)}),h.oldMaterial=h.material,h.material=d}else{let d=h.material.clone();d.transparent=!0,d.opacity=.88,d.emissive=this.gatherModelColor[i],h.oldMaterial=h.material,h.material=d}});const{center:r,max:o}=Qe(e),a=new M(r.x,o.y,r.z);let l=this.createLabel(s,a,this.boardClick.bind(this),t);return l.position.set(a.x,a.y+8,a.z),l}getCenter(e,t=new M){const s=t;return e.forEach(i=>{s.addScaledVector(i,1/e.length)}),s}createShaders(){const e={green:this.gatherColor.green,yellow:this.gatherColor.yellow};let t={};return Object.entries(e).forEach(([s,i])=>{let r=new Xs({side:Me,transparent:!0,depthTest:!0,depthWrite:!1,blending:Ec});cp(r,this.elapsedTime,i,{value:2}),t[s]=r}),t}boardClick(e){this.core.tweenControl.lerpTo(e,50,1e3,new M(0,10,0))}createLabel(e,t,s,i){let r=document.getElementById("statusBoard").cloneNode(!0);return r.innerText=e,i===2&&(r.className="yellowArea"),typeof s=="function"&&(r.onclick=()=>{s(t)}),Te(r)}clearGeometryGather(e){e.traverse(t=>{t instanceof K&&(t.material=t.oldMaterial,delete t.oldMaterial)})}clearFence(){Object.values(this.fenceObj).forEach(e=>{e.type==="fence"&&(e.object3d.deleteSelf(),e.label.deleteSelf(),e.line.deleteSelf()),e.type==="geometry"&&(e.label.deleteSelf(),this.clearGeometryGather(e.object3d)),this.FenceGroup.children.forEach(t=>{t.removeFromParent()}),this.fenceObj={}})}dispose(){this.clearFence()}changeDomVisible(e){Object.values(this.fenceObj).forEach(t=>{t.label.element.style.display=e?"block":"none"})}update(e){Object.values(this.fenceObj).length&&(this.core.core.sceneType===0&&this.changeDomVisible(!1),this.core.core.sceneType===1&&this.changeDomVisible(!0))}}class yp{constructor(e,t){this.core=t,this.scene=e,this.cherryArray=[],this.spriteObject={},this.equipSprite=this.generateLabel("/equip/road.png"),this.equipGroup=new ee,this.scene._add(this.equipGroup)}setCherryArray(e){this.cherryArray=e}cherryPick(){this.equipGroup.traverse(e=>{e instanceof On&&(e.visible=this.cherryArray.includes("meetingPoint"))})}create(e){const{id:t,position:s,name:i}=e;if(this.spriteObject[t])return console.log("集合点已存在"),!1;let r=this.equipSprite.clone();r.name=i;let o=Xn({sceneType:1,originId:"",coordinate:s});r.position.set(o.x,o.y,o.z),r.visible=this.cherryArray.includes("meetingPoint"),this.spriteObject[t]=r,this.equipGroup.add(r)}generateLabel(e,t=.048){const s=new Oe().load(e),i=new ar({map:s,sizeAttenuation:!1,depthTest:!1,depthWrite:!1}),r=new On(i);return r.renderOrder=1,r.scale.set(t,t,t),r.center=new N(.5,0),r}dispose(){this.clearFence()}update(e){}}const bp=["其他模型.glb","内地形.glb","室内模型外壳.glb","树.glb"],qo=["A01B001.glb"],wp=["A01B001"];class Zo{constructor(){this.element=null,this.css2dObject=null,this.isVisible=!1,this.createTooltip()}createTooltip(){const e=document.createElement("div");e.className="building-tooltip-container",e.style.cssText=`
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s ease;
      transform: translate(-50%, -100%);
      margin-top: -8px;
    `;const t=document.createElement("div");t.innerHTML="双击进入室内，单击拉近视角",e.appendChild(t);const s=document.createElement("div");s.style.cssText=`
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 6px solid rgba(0, 0, 0, 0.8);
    `,e.appendChild(s),this.element=e,this.css2dObject=Te(e),this.css2dObject.visible=!1}show(e){!this.isVisible&&this.css2dObject&&this.element&&(this.css2dObject.position.copy(e),this.css2dObject.visible=!0,this.element.style.opacity="1",this.isVisible=!0)}hide(){this.isVisible&&this.css2dObject&&(this.element.style.opacity="0",setTimeout(()=>{this.css2dObject&&(this.css2dObject.visible=!1),this.isVisible=!1},200))}updatePosition(e){this.isVisible&&this.css2dObject&&this.css2dObject.position.copy(e)}destroy(){this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,this.css2dObject=null}}class tr{constructor(){this.element=null,this.isVisible=!1,this.createHint()}createHint(){const e=document.createElement("div");e.className="scene-hint-container",e.style.cssText=`
      position: fixed !important;
      top: 20px !important;
      right: 20px !important;
      background: rgba(0, 0, 0, 0.8) !important;
      color: white !important;
      padding: 12px 16px !important;
      border-radius: 8px !important;
      font-size: 14px !important;
      white-space: nowrap !important;
      pointer-events: none !important;
      z-index: 9999 !important;
      opacity: 0 !important;
      transition: opacity 0.3s ease !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      backdrop-filter: blur(4px) !important;
      font-family: Arial, sans-serif !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
      display: block !important;
      visibility: visible !important;
      height: auto !important;
      width: auto !important;
      overflow: visible !important;
      transform: none !important;
    `;const t=document.createElement("div");t.innerHTML="右键双击恢复默认视角",e.appendChild(t),document.body.appendChild(e),this.element=e,console.log("SceneHint created:",e),setTimeout(()=>{this.element&&(this.element.style.opacity="1",this.isVisible=!0,console.log("SceneHint force shown"))},100)}show(e){this.element&&(this.element.querySelector("div").innerHTML=e,this.element.style.opacity="1",this.isVisible=!0,console.log("SceneHint shown:",e))}hide(){this.element&&this.isVisible&&(this.element.style.opacity="0",this.isVisible=!1,console.log("SceneHint hidden"))}updateMessage(e){this.element&&(this.element.querySelector("div").innerHTML=e,console.log("SceneHint message updated:",e))}destroy(){this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,console.log("SceneHint destroyed")}}class Sp extends ee{constructor(){super(),this.name="BuildingHoverRings",this.visible=!1,this.elapsedTime=0,this.animationSpeed=140,this.waveAmplitude=2,this.ringSpacing=2,this.createRings()}createRings(){this.ring1=this.createSingleRing(12,"#00ff88",.6),this.ring1.position.y=0,this.add(this.ring1),this.ring2=this.createSingleRing(16,"#0088ff",.4),this.ring2.position.y=0,this.add(this.ring2)}createSingleRing(e,t,s){const i=new Dc(e*.8,e,32);i.applyMatrix4(new oe().makeRotationX(-Math.PI/2));const r=new Be({transparent:!0,side:Me,depthWrite:!1,depthTest:!1,uniforms:{uTime:{value:0},uColor:{value:new Z(t)},uOpacity:{value:s},uRadius:{value:e}},vertexShader:`
        uniform float uTime;
        uniform float uRadius;
        varying vec2 vUv;
        varying float vDistance;
        
        void main() {
          vUv = uv;
          
          // 计算顶点到中心的距离
          vec2 center = vec2(0.5, 0.5);
          vDistance = distance(uv, center) * 2.0;
          
          vec3 pos = position;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
        }
      `,fragmentShader:`
        uniform float uTime;
        uniform vec3 uColor;
        uniform float uOpacity;
        varying vec2 vUv;
        varying float vDistance;
        
        void main() {
          // 创建环形效果
          float ring = 1.0 - smoothstep(0.7, 1.0, vDistance);
          ring *= smoothstep(0.3, 0.5, vDistance);
          
          // 添加脉冲效果
          float pulse = sin(uTime * 3.0) * 0.3 + 0.7;
          
          // 添加扫描线效果
          float angle = atan(vUv.y - 0.5, vUv.x - 0.5);
          float scanLine = sin(angle * 8.0 + uTime * 4.0) * 0.2 + 0.8;
          
          float alpha = ring * pulse * scanLine * uOpacity;
          
          gl_FragColor = vec4(uColor, alpha);
        }
      `}),o=new K(i,r);return o.renderOrder=999,o}show(e,t=12){this.position.copy(e),this.position.y+=1;const s=Math.max(.3,Math.min(3,t));this.scale.setScalar(s),this.visible=!0}hide(){this.visible=!1}update(e){if(!this.visible)return;this.elapsedTime+=e,this.ring1&&this.ring1.material&&(this.ring1.material.uniforms.uTime.value=this.elapsedTime),this.ring2&&this.ring2.material&&(this.ring2.material.uniforms.uTime.value=this.elapsedTime);const t=Math.sin(this.elapsedTime*this.animationSpeed)*this.waveAmplitude,s=Math.sin(this.elapsedTime*this.animationSpeed+Math.PI)*this.waveAmplitude;this.ring1&&(this.ring1.position.y=t),this.ring2&&(this.ring2.position.y=s+this.ringSpacing),this.rotation.y+=e*.5}dispose(){this.traverse(e=>{e.isMesh&&(e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose())})}}const Mp=Symbol(),nl=new M,Tp=new ws(nl,2880),Fp=new ws(nl,2880),Pi={maxPolarAngle:Math.PI/2};class xp extends Wa{constructor(t){super(t);O(this,"limitCameraInSphere",()=>{this.controls.enableRotate&&(this.camera.position.clampSphere(Tp),this.controls.target.clampSphere(Fp),this.camera.position.y=this.camera.position.y<this.altitude?this.altitude:this.camera.position.y,this.controls.target.y=this.controls.target.y<this.altitude?this.altitude:this.controls.target.y)});O(this,"boardClick",t=>{const s=new M(2,2,0);this.tweenControl.lerpTo(t.position,20,1e3,s)});this.tweenControl=t.tweenControl,this.onRenderQueue=t.onRenderQueue,this.controls=t.controls,this.baseCamera=t.baseCamera,this.camera=t.camera,this.orientation=t.orientation,this.boxSelect=t.orientation.boxSelect,this.postprocessing=t.postprocessing,this.buildingMeshArr=[],this.buildingMeshObj={},this.buildingNames=wp,this.bloomLights=[],this.buildingNameLabelMap={},this.buildingNum={},this.singleBuildingGroup={},this.labelGroup=new ee,this.labelGroup.name="labelGroupHome",this._add(this.labelGroup),this.groundMesh=null,this.fencePlate=null,this.gatherOrSilentPlate=null,this.eventClear=[],this.pointerArr=[],this.isLoaded=!1,this.searchBuildingId=null,this.roamEnabled=!1,this.roamDuration=10,this.filterBuildingArr=["buildingBoard"],this.boxSelectStatus=!1,this.instancedMesh=[],this.altitude=-20,this.modelList=[],this.modelGroup=new ee,this.scene.add(this.modelGroup),this.loadedModels=new Map,this.tooltip=new Zo,this.labelGroup.add(this.tooltip.css2dObject),this.sceneHint=new tr,this.buildingHoverRings=new Sp,this.scene.add(this.buildingHoverRings),this.init()}async init(){console.log("Ground system initializing...");try{const t=bp.map(s=>({name:s.replace(".glb",""),path:`./models/outDoor/${s}`,type:".glb"}));console.log("Loading models with configs:",t),this.initLight(),await Br(t,(s,i)=>{if(!s||!s.scene){console.error(`❌ 模型加载失败: ${i} - 无效的模型数据`);return}console.log(`✅ 成功加载模型: ${i}`),this.onProgress(s,i)},()=>{console.log("✅ 所有模型加载完成"),this.initComponents(),this.onLoaded()})}catch(t){throw console.error("❌ 加载模型时出错:",t),t.response&&(console.error("响应状态:",t.response.status),console.error("响应头:",t.response.headers)),t}}initComponents(){this.fencePlate=new rp(this.scene,this),this.escapeRoute=new ep(this.scene,this),this.gatherOrSilentPlate=new vp(this.scene,this),this.meetingPoint=new yp(this.scene,this),console.log("Creating Weather instance with this:",this),console.log("Ground scene:",this.scene),this.measureDistance=new np(this),this.measureArea=new ip(this),this.core&&this.core.onRenderQueue&&(this.core.onRenderQueue.set("ground",this.update.bind(this)),this.gatherOrSilentPlate&&this.core.onRenderQueue.set("gatherOrSilentFence",this.gatherOrSilentPlate.update.bind(this.gatherOrSilentPlate)),this.escapeRoute&&this.core.onRenderQueue.set("escapeRoute",this.escapeRoute.update.bind(this.escapeRoute)))}handleControls(){this.controls.addEventListener("change",this.limitCameraInSphere),Reflect.ownKeys(Pi).forEach(t=>{this.controls.data[t]=this.controls[t],this.controls[t]=Pi[t]})}resetControls(){this.controls.removeEventListener("change",this.limitCameraInSphere),Reflect.ownKeys(Pi).forEach(t=>{this.controls[t]=this.controls.data[t]})}setCameraState(t){if(!this.useCameraState)return;const{begin:s,updateCameraState:i,stop:r}=this.useCameraState();i(this.roamDuration),t&&this.core.currentSystem===this?s():r()}addEventListener(){if(this.eventClear.length>0)return;let t=this.core.raycast("dblclick",this.buildingMeshArr,r=>{if(r.length){let a=r[0].object;for(;a.parent&&!this.buildingNames.some(l=>a.name===l);)a=a.parent;!this.boxSelectStatus&&this.buildingNames.some(l=>a.name===l)&&(Fd(a.name.split("_")[0]),this.core.changeSystem("indoorSubsystem",a.name))}});this.addGroundEvent();let s=this.core.rightDblClickListener(()=>{this.resetCamera()});this.eventClear.push(t.clear),this.eventClear.push(s),Object.values(this.buildingNum).forEach(r=>{r.element.onclick=()=>this.buildingNumClick(r.name)});const i=this.core.raycast("dblclick",this.groundMesh,r=>{r.length&&!this.boxSelectStatus&&this.tweenControl.lerpTo(r[0].point,50,1e3,new M(0,10,0))});this.eventClear.push(i.clear)}groundClickEvent(t){let s=t.intersectObjects(this.buildingMeshArr);if(s.length){const i=s[0].object;i.userData.buildingName&&this.commonSearchBuilding(i.userData.buildingName)}}addGroundEvent(){this.core.addClickCustom(this.groundClickEvent.bind(this));let t=this.core.raycast("mousemove",this.buildingMeshArr,i=>{if(!(this.core.elapsedTime*10&1))if(i.length){const r=i[0].object;let o=r;for(;o.parent&&!this.buildingNames.some(l=>o.name===l);)o=o.parent;const a=new M;r.getWorldPosition(a),a.y+=10,this.showBuildingHoverEffect(o.name,a,o)}else this.hideBuildingHoverEffect()}),s=this.core.raycast("mousemove",this.orientation.orientation3D.pointerArr,i=>{i.length?document.body.style.cursor="pointer":document.body.style.cursor="auto"});this.eventClear.push(s.clear),this.eventClear.push(t.clear)}onEnter(){this.handleControls(),V.onLoad(this,this.core),this.boxSelect.onLoad(this),this.filterBuildingNum(),this.tooltip||(this.tooltip=new Zo,this.labelGroup.add(this.tooltip.css2dObject)),this.sceneHint.show("右键双击恢复默认视角"),this.groundMesh&&(this.onLoaded(),this.isLoaded=!0)}initDangerFence(t){this.fencePlate.initDangerFence(t)}hideBuildingLabel(t=this.searchBuildingId){let s=t||this.searchBuildingId;if(!s)return!1;this.buildingNameLabelMap[s].visible=!1,this.buildingNameLabelMap[s].element.style.display="none",this.searchBuildingId=null,this.postprocessing.clearOutlineAll(1)}hideAllBuildingLabel(){Object.values(this.buildingNameLabelMap).map(t=>{t.visible=!1,t.element.style.display="none"}),Object.values(this.buildingNum).forEach(t=>{t.traverse(s=>{s.visible=!1,t.element.style.display="none"})}),this.searchBuildingId=null,this.tooltip&&this.tooltip.hide()}clearDangerFence(){this.fencePlate.clearDangerFence()}clearBuildingFence(){this.fencePlate.clearBuildingFence()}historyTrackCommand(t){t.cmd==="trackInit"&&(this.orientation.orientation3D.hiddenAllPerson=!0,this.orientation.updateModules(),this.removeEventListener(),this.postprocessing.clearOutlineAll()),t.cmd==="trackClear"&&(this.removeEventListener(),this.historyTrack.path||this.addEventListener(),this.orientation.orientation3D.hiddenAllPerson=!1,this.orientation.updateModules()),this.historyTrack.command(t)}startMeasuring(){this.removeEventListener(),this.measureDistance.start()}removeMeasuring(){this.measureDistance.end(),this.addEventListener(),this.resetCamera()}startMeasureArea(){this.removeEventListener(),this.measureArea.start()}removeMeasureArea(){this.measureArea.end(),this.addEventListener(),this.resetCamera()}changeBoxSelect(t){this.boxSelectStatus=t,t?(this.removeEventListener(),this.boxSelect.start()):(this.boxSelect.end(),this.addEventListener(),this.resetCamera())}searchBuilding(t=!0){t&&Td(this.searchBuildingId);let s=this.buildingNameLabelMap[this.searchBuildingId];this.boardClick(s),this.postprocessing.clearOutlineAll(1);let i=this.buildingMeshObj[this.searchBuildingId];this.postprocessing.addOutline(i,1)}createFence(t){this.fencePlate.create(t)}clearFence(){this.fencePlate.dispose()}onProgress(t,s){if(this.core.scene!==this.scene)return;const i=t.scene;if(s==="内地形"){const{min:r}=Qe(i);this.altitude=r.y,i.traverse(d=>{d.isMesh&&(d.receiveShadow=!0)}),this.groundMesh=i;const{radius:o,center:a}=Qe(i);a.y+=o*.24;const l=new M(a.x,a.y+o*.8,a.z+o*2.5),h=a.clone();this.camera.position.copy(l),this.controls.target.copy(h),this.camera.lookAt(h)}s==="text"&&(console.log(i,"model"),i.children.forEach(r=>{this.buildingMeshArr.push(r),this.applyGlowSignEffect(r)})),s==="室内模型外壳"&&i.children.forEach(r=>{r.traverse(o=>{o.isMesh&&(o.castShadow=!0,o.receiveShadow=!0,this.adjustModelMaterials(o),this.buildingMeshArr.push(o),this.buildingMeshObj[o.name]=o,o.userData.buildingName=s)})}),this._add(i)}adjustModelMaterials(t){if(!t.material.name==="bl")return;const s=this.adjustMaterial(t.material);s&&(t.material=s)}applyGlowSignEffect(t){t.traverse(s=>{if(s.isMesh){let i=new Z(16777215);s.material&&(s.material.color?i=s.material.color.clone():s.material.emissive&&(i=s.material.emissive.clone()));const r=new Be({transparent:!0,depthTest:!1,depthWrite:!1,side:Me,uniforms:{uColor:{value:i},uIntensity:{value:1.8},uTexture:{value:s.material.map||null},uHasTexture:{value:s.material.map?1:0}},vertexShader:`
             varying vec2 vUv;
             
             void main() {
               vUv = uv;
               gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
             }
           `,fragmentShader:`
             uniform vec3 uColor;
             uniform float uIntensity;
             uniform sampler2D uTexture;
             uniform float uHasTexture;
             
             varying vec2 vUv;
             
             void main() {
               // 基础颜色
               vec3 baseColor = uColor;
               
               // 如果有原始贴图，混合它
               if (uHasTexture > 0.5) {
                 vec3 textureColor = texture2D(uTexture, vUv).rgb;
                 baseColor = textureColor * baseColor;
               }
               
               // 高亮发光效果
               vec3 finalColor = baseColor * uIntensity;
               
               // 输出颜色
               gl_FragColor = vec4(finalColor, 1.0);
             }
           `});s.material=r,s.renderOrder=1e3,this.glowMaterials||(this.glowMaterials=[]),this.glowMaterials.push(r),console.log(`已为 ${s.name||"未命名模型"} 应用高亮发光效果`)}})}generateTexture(){const t=document.createElement("canvas");t.width=2,t.height=2;const s=t.getContext("2d");return s.fillStyle="white",s.fillRect(0,1,2,1),t}adjustMaterial(t){if(!t)return;const s=new lr(this.generateTexture()),i=new kn().setPath("./").load("royal_esplanade_1k.hdr",function(){i.mapping=fs});if(s.magFilter=Hn,s.wrapT=Ve,s.wrapS=Ve,s.repeat.set(1,3.5),t.name==="bl")return new pt({color:16777215,metalness:.8,roughness:0,ior:4,alphaMap:s,envMap:i,transmission:.4,thickness:1,specularIntensity:12,specularColor:16777215,envMapIntensity:2,opacity:.8,side:Me,transparent:!0,depthTest:!0,depthWrite:!1});t.roughness!==void 0&&t.roughness===0&&(t.roughness=.2,console.log(`调整材质 ${t.name||"unnamed"} 的 roughness: 0 -> 0.2`)),t.metalness!==void 0&&t.metalness===1&&(t.metalness=.68),this.scene.environment&&(t.envMap=this.scene.environment,t.envMapIntensity=.8,t.needsUpdate=!0,console.log(`为材质 ${t.name||"unnamed"} 设置环境贴图，强度: 0.8`))}processPendingEnvMapMaterials(){this.pendingEnvMapMaterials&&this.pendingEnvMapMaterials.length>0&&this.scene.environment&&(console.log(`处理 ${this.pendingEnvMapMaterials.length} 个待设置环境贴图的材质`),this.pendingEnvMapMaterials.forEach(t=>{t.envMap=this.scene.environment,t.envMapIntensity=2,t.needsUpdate=!0}),this.pendingEnvMapMaterials=[])}materialClone(t,s){if(t.isMesh){const i=t.material.name;if(s[i])t.material=s[i];else{const r=t.material.clone();s[i]=r,t.material=r}t.material.originTransparent=t.material.transparent}}setBuildingBoard(t){const{center:s,max:i}=Qe(t),r=new M(s.x,i.y,s.z),o=t.name,a=o.split("_")[1],h=tp({制冷:"能源站",制热:"热水系统",配电室:"配电室地下一层"}[a],u=>{this.cameraMoveToBuildingTitle(o)},u=>{this.core.changeSystem("indoorSubsystem",o)},u=>{const c=u.position.clone();c.y+=5,this.showBuildingHoverEffect(o,c,t)},u=>{this.hideBuildingHoverEffect()});h.visible=!0,h.position.copy(r),this.labelGroup.add(h),this.buildingNameLabelMap[o]=h;const d=sp(0,!1);d.position.copy(r),d.scale.set(.2,.2,.2),d.name=o,this.labelGroup.add(d),this.buildingNum[o]=d}setFilterBuilding(t){this.filterBuildingArr.length=0,this.filterBuildingArr=t}filterBuildingNum(){const t=this.filterBuildingArr.includes("buildingBoard");Object.values(this.buildingNum).forEach(s=>{s.traverse(i=>{i.visible=t,i.visible=parseInt(i.element.innerText)>0?t:!1})})}showBuildingHoverEffect(t,s,i=null){if(this.buildingNames.some(r=>t.includes(r))){if(this.tooltip&&this.tooltip.show(s),this.buildingHoverRings&&i){const r=new ce;r.setFromObject(i);const o=r.getSize(new M);Math.max(o.x,o.z)/2,this.buildingHoverRings.show(s,1.6)}i&&this.postprocessing&&(this.postprocessing.clearOutlineAll(1),this.postprocessing.addOutline(i,1))}}hideBuildingHoverEffect(){if(this.tooltip&&this.tooltip.hide(),this.buildingHoverRings&&this.buildingHoverRings.hide(),this.searchBuildingId&&this.postprocessing){const t=this.buildingMeshObj[this.searchBuildingId];t&&(this.postprocessing.clearOutlineAll(1),this.postprocessing.addOutline(t,1))}else this.postprocessing&&this.postprocessing.clearOutlineAll(1)}cameraMoveToBuildingTitle(t){this.commonSearchBuilding(t)}commonSearchBuilding(t){console.log(t,"id"),this.searchBuildingId=t,this.searchBuilding(),this.removeEventListener(),this.addEventListener()}buildingNumClick(t){Id(t)}changeBuildingNumber(t){t.map(s=>{const{id:i,number:r}=s;if(!buildingMap[i]||!this.buildingNum[i])return!1;this.buildingNum[i].element.innerText=String(r),this.buildingNum[i].visible=r>0&&this.filterBuildingArr.includes("buildingBoard")})}showSingleBuildingBoard(t){Object.entries(this.buildingNameLabelMap).map(([s,i])=>{s===t?i.visible=!0:i.visible=!1})}onLeave(){this.hideAllBuildingLabel(),this.resetControls(),this.setCameraState(!1),this.core.onRenderQueue.delete(Mp),this.core.onRenderQueue.delete("ground"),this.measureArea.end(),this.measureDistance.end(),this.boxSelect.end(),this.removeEventListener(),document.body.style.cursor="auto",this.tooltip&&(this.tooltip.destroy(),this.tooltip=null),this.sceneHint&&this.sceneHint.hide(),this.buildingHoverRings&&this.buildingHoverRings.hide(),this.clearEnvironment(),console.log("离开地面广场系统")}onLoaded(){this.useCameraState||mp(this),this.roamEnabled&&this.setCameraState(!0),this.instancedMesh&&this.instancedMesh.length>0&&this.instancedMesh.forEach(t=>{t&&t instanceof Ae&&this._add(t)}),console.log("All models loaded successfully"),this.addEventListener(),Ra("home"),this.resetCamera(1500,!0).then(()=>{this.core&&this.core.crossSearch&&this.core.crossSearch.changeSceneSearch(),super.updateOrientation()})}removeEventListener(){this.eventClear.forEach(t=>t()),this.eventClear=[]}loadInstancedModel(t,s,i){const r=new ee,o={},a={},l={},h=new M;function d(u){u.getWorldPosition(h);const c=u.name.split("_")[0];a[c]=a[c]||[],a[c].push(h.clone()),l[c]=l[c]||[],l[c].push(u.rotation)}return t.forEach(u=>{u.name.includes("zuobiao")&&u.traverse(c=>{d(c)}),u.name.includes("shili")&&u.children.forEach(c=>{o[c.name]=c,c.name.includes("shu")&&c.traverse(f=>{f instanceof K&&(f.material=new vc({map:f.material.map}),Ep(f,"树",this))})})}),Object.keys(o).forEach(u=>{const c=o[u];let f;u.indexOf("shu")!==-1?f=Kn(c,a[u],!0,i):f=Kn(c,a[u],l[u],i),r.add(f),f instanceof ee?f.traverse(s):s(f)}),r}resetCamera(t=1e3,s=!1){if(!this.groundMesh)return console.warn("地面模型未加载，无法重置相机"),Promise.resolve();const{radius:i,center:r}=Qe(this.groundMesh);r.y+=i*.24;const o=new M(r.x,r.y+28.4,r.z+i*1.8),a=r.clone();return new Promise((l,h)=>{o.distanceTo(this.camera.position)<5&&a.distanceTo(this.controls.target)<5&&l(),this.tweenControl.changeTo({start:this.camera.position,end:o,duration:t,onComplete:()=>{this.controls.enabled=!0,l()},onStart:()=>{this.controls.enabled=!1}}),this.tweenControl.changeTo({start:this.controls.target,end:a,duration:t,onUpdate:()=>{this.camera.lookAt(this.controls.target)}})})}initLight(){this.setEnvironment("room");const t=new rr(16777215,1.45),s=new us(16777215,1.55);s.shadow.camera.near=1,s.shadow.camera.far=3500,s.shadow.camera.right=2500,s.shadow.camera.left=-2500,s.shadow.camera.top=1600,s.shadow.camera.bottom=-1600,s.shadow.mapSize.width=Math.pow(2,11),s.shadow.mapSize.height=Math.pow(2,11),s.shadow.blurSamples=8,s.shadow.radius=1.15,s.shadow.bias=-.0015,s.position.set(15,48,-48),s.castShadow=!0;const i=new Ae;i.position.set(0,0,0),s.target=i,this.ambientLight=t,this._add(this.ambientLight),this.directionalLight=s,this._add(this.directionalLight),this._add(i),new or(s.shadow.camera),new Rn(s,5),new us(13421772,.3).position.set(-150,150,0),new us(16777215,.4).position.set(150,100,0),console.log("地面系统灯光初始化完成，已设置 RoomEnvironment")}showAllBuildingLabel(){Object.values(this.buildingNameLabelMap).forEach(t=>{t.visible=!0,t.element.style.display="block"})}update(){if(this.buildingHoverRings&&this.buildingHoverRings.visible){const t=this.core.clock?this.core.clock.getDelta():.016;this.buildingHoverRings.update(t)}this.glowMaterials&&this.glowMaterials.forEach(t=>{t.uniforms&&t.uniforms.iTime&&(t.uniforms.iTime.value=this.core.clock?this.core.clock.getElapsedTime():0)})}destroy(){this.tooltip&&(this.tooltip.destroy(),this.tooltip=null),this.sceneHint&&(this.sceneHint.destroy(),this.sceneHint=null),this.buildingHoverRings&&(this.buildingHoverRings.dispose(),this.scene.remove(this.buildingHoverRings),this.buildingHoverRings=null),this.glowMaterials&&(this.glowMaterials.forEach(t=>{t.uniforms&&t.uniforms.uTexture&&t.uniforms.uTexture.value&&t.uniforms.uTexture.value.dispose(),t.dispose()}),this.glowMaterials=[]),this.clearEnvironment()}clearEnvironment(){this.scene.environment&&(this.scene.environment.dispose(),this.scene.environment=null),this.scene.background&&this.scene.background!==ks&&(this.scene.background.dispose(),this.scene.background=null)}setEnvironment(t="room",s={}){switch(this.clearEnvironment(),t){case"room":const i=new yc(this.core.renderer);this.scene.environment=i.fromScene(new sl,.24).texture,this.scene.background=ks,console.log("已设置 RoomEnvironment");break;case"hdr":this.setHDRSky();break;case"default":this.scene.background=ks,console.log("已设置默认环境");break;default:console.warn(`未知的环境类型: ${t}`);break}this.updateAllMaterialsEnvironment()}updateAllMaterialsEnvironment(){this.scene.traverse(t=>{t.isMesh&&t.material&&(Array.isArray(t.material)?t.material.forEach(s=>{this.setupMaterialEnvironment(s)}):this.setupMaterialEnvironment(t.material))})}setupMaterialEnvironment(t){t&&(t.isMeshStandardMaterial||t.isMeshPhysicalMaterial)&&this.scene.environment&&(t.envMap=this.scene.environment,t.envMapIntensity=.8,t.needsUpdate=!0)}setHDRSky(){console.log("开始加载 HDR 天空贴图...");const t=new kn;t.setDataType(ds),t.load("./bg.hdr",s=>{console.log("HDR 加载成功:",s),s.mapping=fs,s.colorSpace=j,s.exposure=2,this.scene.background=s;const i=s.clone();i.intensity=2,this.scene.environment=i,console.log("天空贴图设置完成"),this.processPendingEnvMapMaterials()},s=>{s.lengthComputable&&console.log("HDR 加载进度:",s.loaded/s.total*100+"%")},s=>{console.error("HDR 加载失败:",s),console.log("尝试使用备用方案..."),this.setFallbackSky()})}setFallbackSky(){try{new Oe().load("./sunny2.hdr",s=>{console.log("备用方案加载成功"),s.mapping=fs,s.colorSpace=j,s.exposure=.2,this.scene.background=s;const i=s.clone();i.intensity=.02,this.scene.environment=s},void 0,s=>{console.error("备用方案也失败:",s),this.scene.background=new Z(8900331),console.log("使用默认天空蓝色")})}catch(t){console.error("备用方案初始化失败:",t),this.scene.background=new Z(8900331),console.log("使用默认天空蓝色")}}}class Ip{constructor(e){this.core=e,this.elapsedTime={value:0},this.boxModel=[],this.position=null,this.lightIndex=0,this.lastRenderTime=0,this.newInter=null,this.Lines=[],this.time=0,this.images=["./shader/grid3.png"],this.imagesObj=[{data:"https://prs-file.oss-cn-beijing.aliyuncs.com/product/resource/7582/16544/static/ground/icon_20220311102510983_318887.png",t:"https://prs-file.oss-cn-beijing.aliyuncs.com/product/resource/7582/16544/static/ground/systemIcons/光1.png",r:.26,i:1,n:"rgba(54,215,255,1)",o:6.4,s:.5,a:"rgba(18,208,255,1)",l:!1,h:"flow",c:5,u:5},{data:"https://prs-file.oss-cn-beijing.aliyuncs.com/product/resource/7582/16544/static/ground/icon_20211208112842284_782756.png",t:"https://prs-file.oss-cn-beijing.aliyuncs.com/product/resource/7582/16544/static/ground/systemIcons/光1.png",r:.26,i:1,n:"rgba(54,215,255,1)",o:6.4,s:.5,a:"rgba(18,208,255,1)",l:!1,h:"flow",c:5,u:5}]}initModel(e,t){this.position=e,this.boxModel.length&&this.dispose();for(let r=0;r<this.images.length;r++){var s=this._createMaterial(this.images[r],"./shader/光1.png",1,1,"rgba(0.6392, 0.6549, 0.8549,1)",4.8,.5,"rgba(18,208,255,1)",!1,"flow",5,5,188),i=new ir(t*20,t*20);let o=new K(i,s);o.renderOrder=-1,o.rotation.x=-Math.PI/2,o.position.set(this.position.x,this.position.y,this.position.z),this.boxModel.push(o),this.core.scene.add(o)}}_createMaterial(e,t,s,i,r,o,a,l,h,d,u,c,f){var p=new Oe,B=null,A=null;h||((B=p.load(e)).wrapS=B.wrapT=Ve,(A=p.load(t)).wrapS=A.wrapT=Ve);var m={map:{value:B},time:this.elapsedTime,opacity:{value:1},alpha:{value:s},repeatFactor:{value:f},maskMap:{value:A},color:{value:new Z(r)},glowFactor:{value:o},speed:{value:a},flowColor:{value:new Z(l)}},g=`varying vec2 vUv;
                void main() {
                  vUv = uv;
                  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.);
                }`,C=`
            varying vec2 vUv;
            uniform sampler2D map;
            uniform sampler2D maskMap;
            uniform float time;
            uniform float opacity;
            uniform float repeatFactor;
            uniform float alpha;
            uniform vec3 color;
            uniform vec3 flowColor;
            uniform float glowFactor;
            uniform float speed;
            void main() {
            //   float repeatFactor = 48.0;
              vec2 mapUv = vUv * repeatFactor;
              float t = mod(time / 5. * speed, 1.);
              vec2 uv = abs((vUv - vec2(0.5)) * 2.0);
              float dis = length(uv);
              float r = t - dis;
              vec4 col = texture2D(map, mapUv);
              vec3 finalCol;
              vec4 mask = texture2D(maskMap, vec2(0.5, r));

              finalCol = mix(color, flowColor, clamp(0., 1., mask.a * glowFactor));
              gl_FragColor = vec4(finalCol.rgb, (alpha + mask.a * glowFactor) * col.a * (1. - dis) * opacity);
            }
          `;let E=new Be({uniforms:m,vertexShader:g,fragmentShader:C,transparent:!0});return E.roughness=h?.1:1,E}dispose(){this.boxModel.length&&this.boxModel.forEach(e=>{le.dispose(e)})}update(e){e-this.lastRenderTime,this.elapsedTime.value=e}}class Lp{constructor(){this.equipmentTree={},this.loadedBuildings=new Set,this.loadingPromises=new Map}async getEquipmentTree(e){if(console.log(`🔍 请求获取建筑 ${e} 的设备树数据`),this.loadedBuildings.has(e))return console.log(`✅ 建筑 ${e} 的设备树数据已缓存，直接返回`),this.equipmentTree[e]||{};if(this.loadingPromises.has(e))return console.log(`⏳ 建筑 ${e} 的设备树数据正在加载中，等待完成...`),this.loadingPromises.get(e);console.log(`🚀 开始加载建筑 ${e} 的设备树数据...`);const t=this.loadBuildingEquipmentTree(e);this.loadingPromises.set(e,t);try{const s=await t;return this.loadedBuildings.add(e),this.loadingPromises.delete(e),console.log(`✅ 建筑 ${e} 的设备树数据加载完成`),s}catch(s){throw this.loadingPromises.delete(e),console.error(`❌ 建筑 ${e} 的设备树数据加载失败:`,s),s}}async loadBuildingEquipmentTree(e){console.log(`开始加载建筑 ${e} 的设备树数据...`);const t=`${e}.glb`;if(!qo.includes(t))return console.warn(`建筑 ${e} 不在室内模型列表中`),{};try{const s={name:e,path:`./models/inDoor/${t}`,type:".glb"};return await Br([s],(i,r)=>{const o=i.scene.children.find(a=>a.name==="equip");o&&o.children?this.equipmentTree[r]=o.children.map(a=>{const l=a.name.split("_");return{id:l[0],name:l[l.length-1]}}):this.equipmentTree[r]=[],console.log(`建筑 ${e} 设备树数据加载完成:`,this.equipmentTree[r])},()=>{console.log(`✅ 建筑 ${e} 设备树数据加载完成`);const i={};i[e]=this.equipmentTree[e]||[],Pd(i)}),this.equipmentTree[e]||{}}catch(s){throw console.error(`加载建筑 ${e} 设备树数据失败:`,s),s}}async preloadAllEquipmentTrees(){console.log("开始预加载所有建筑的设备树数据...");const e=qo.map(t=>{const s=t.replace(".glb","");return this.getEquipmentTree(s)});try{await Promise.all(e),console.log("✅ 所有建筑设备树数据预加载完成")}catch(t){console.error("预加载设备树数据失败:",t)}}clearBuildingEquipmentTree(e){this.equipmentTree[e]&&(delete this.equipmentTree[e],this.loadedBuildings.delete(e),console.log(`已清除建筑 ${e} 的设备树数据`))}clearAllEquipmentTrees(){this.equipmentTree={},this.loadedBuildings.clear(),this.loadingPromises.clear(),console.log("已清除所有设备树数据")}getLoadedBuildings(){return Array.from(this.loadedBuildings)}isBuildingLoaded(e){return this.loadedBuildings.has(e)}}const Pp=new Lp;let Ot=0;const Hi={maxPolarAngle:Math.PI/2.05};class Hp extends Wa{constructor(e){super(e),this.gatherOrSilentData={},this.gatherOrSilentLabel=null,this.scene.background=ks,this.onRenderQueue=e.onRenderQueue,this.controls=e.controls,this.camera=e.camera,this.tweenControl=e.tweenControl,this.orientation=e.orientation,this.buildingObject={},this.currentFloor=null,this.eventClear=[],this.building=null,this.buildingName=null,this.endChangeFloor=!0,this.floors=[],this.floorsName=[],this.deviceLabelsData={},this.sceneHint=new tr,this.initialCameraPosition=null,this.initialControlsTarget=null}async onEnter(e){this.core.ground&&this.core.ground.hideAllBuildingLabel&&this.core.ground.hideAllBuildingLabel(),this.handleControls(),this.currentPoint=null,V.onLoad(this,this.core),this.sceneHint||(this.sceneHint=new tr),this.sceneHint.show("右键双击返回室外"),this.setIndoorEnvironment("hdr");try{console.log(`开始按需加载建筑 ${e} 的设备树数据...`),await Pp.getEquipmentTree(e),console.log(`建筑 ${e} 设备树数据加载完成`)}catch(s){console.error(`加载建筑 ${e} 设备树数据失败:`,s)}let t={name:e,path:`./models/inDoor/${e}.glb`,type:".glb"};return this.buildingName=e,await Br([t],this.onProgress.bind(this),this.onLoaded.bind(this))}createGround(e,t){let s=null;this.building&&(s=new ce().setFromObject(this.building));const i=new bc(e,t,s);i.receiveShadow=!0,i.castShadow=!1,this.ground=i,this.scene.environment&&i.material&&this.setupIndoorMaterial(i.material),this.scene.add(i)}createBoxModelGround(e,t){this.boxModelGround&&(this.boxModelGround.dispose(),this.boxModelGround=null),this.boxModelGround=new Ip(this.core),this.boxModelGround.initModel(e,t)}recreateGround(){this.ground&&(this.scene.remove(this.ground),this.ground.geometry&&this.ground.geometry.dispose(),this.ground.material&&this.ground.material.dispose(),this.ground=null);const e=Qe(this.building);this.createBoxModelGround(e.center,e.radius),console.log("BoxModel地面已重新创建，新尺寸基于当前模型:",this.building.name)}handleControls(){Reflect.ownKeys(Hi).forEach(e=>{this.controls.data=this.controls.data||{},this.controls.data[e]=this.controls[e],this.controls[e]=Hi[e]})}resetControls(){Reflect.ownKeys(Hi).forEach(e=>{this.controls.data&&this.controls.data[e]!==void 0&&(this.controls[e]=this.controls.data[e])})}async onChangeSystemCustom(e,t,s){e==="outToIn"&&(await this.onEnter(s),this.changeFloor(t)),e==="inToInSingle"&&this.changeFloor(t),e==="inToInOther"&&(this.clearIndoorData(),await this.onEnter(s),this.changeFloor(t))}onProgress(e,t){const s=e.scene;this.building=s,s.children.forEach(i=>{const r={group:i,uTime:{value:1}};i.traverse(o=>{o.isMesh&&(this.modelProcessing(o,r),o.userData.parent=s.name)}),this.floors.push(i),this.floorsName.push(i.name),this.buildingObject[i.name]=r}),this.scene.add(this.building)}modelProcessing(e,t){e.castShadow=!0,e.receiveShadow=!0,e.material.transparent&&(e.renderOrder=3,e.material.depthWrite=!0);const s=e.material;e.material=s.clone(),["map","normalMap","emissiveMap","specularMap","roughnessMap","metalnessMap","alphaMap","envMap","lightMap","aoMap","displacementMap","bumpMap"].forEach(r=>{s[r]&&(e.material[r]=s[r])}),e.material.transparent=!0,e.material.metalness=.2,e.material.roughness=.8,this.setupIndoorMaterial(e.material),!e.name.includes("BDW")&&e.material.name.includes("建筑外壳")?(pp(e.material,t.uTime,new Z("#3acacc")),e.renderOrder=2):fp(e.material,t.uTime)}onLoaded(){this.recreateGround(),this.createAndSetupLights(this.building),this.scene.environment&&this.processIndoorEnvMapMaterials(),this.core&&this.core.onRenderQueue&&this.core.onRenderQueue.set("indoorSubsystem",this.update.bind(this)),console.log("=== 首次进入室内 - onLoaded ==="),console.log("当前相机位置:",this.camera.position),console.log("当前controls.target:",this.controls.target),this.initialCameraPosition=this.camera.position.clone(),this.initialControlsTarget=this.controls.target.clone(),console.log("保存的初始相机位置:",this.initialCameraPosition),console.log("保存的初始controls.target:",this.initialControlsTarget),this.cameraMove(this.building),this.addEventListener()}cameraMove(e,t=null){return new Promise((s,i)=>{let r,o;const{center:a,radius:l}=Qe(e);o=a.clone();const h=l*2;r=new M(a.x,a.y+h*.8,a.z+h*1.2),this.tweenControl.changeTo({start:this.camera.position,end:r,duration:1e3,onComplete:()=>{this.controls.enable=!0,console.log("测试数据=== cameraMove 调试信息 ==="),console.log("测试数据传入的group:",e),console.log("测试数据建筑中心:",a),console.log("测试数据建筑半径:",l),console.log("测试数据相机距离:",h),console.log("测试数据计算出的目标位置:",r),console.log("测试数据目标target:",o),s()},onStart:()=>{this.controls.enable=!1}}),this.tweenControl.changeTo({start:this.controls.target,end:o,duration:1e3,onUpdate:()=>{this.controls.update()}})})}cameraMoveToFloor(e){return new Promise((t,s)=>{const{center:i,radius:r,min:o,max:a}=Qe(e),l=a.y-o.y,h=i.clone(),d=Math.max(l*1.5,r*1),u=new M(i.x,i.y+l+d*1.2,i.z+d*.8);this.tweenControl.changeTo({start:this.camera.position,end:u,duration:1200,onComplete:()=>{this.controls.enable=!0,t()},onStart:()=>{this.controls.enable=!1}}),this.tweenControl.changeTo({start:this.controls.target,end:h,duration:1200,onUpdate:()=>{this.controls.update()}})})}onLeave(){this.core.ground&&this.core.ground.showAllBuildingLabel&&this.core.ground.showAllBuildingLabel(),this.resetControls(),this.sceneHint&&this.sceneHint.hide(),this.core&&this.core.onRenderQueue&&this.core.onRenderQueue.delete("indoorSubsystem"),this.clearIndoorData(),console.log("室内系统 onLeave 完成")}addEventListener(){this.addRayDbClick(),this.addRayMove(),this.addRightDbClickQuit()}addRayDbClick(){let e=this.core.raycast("dblclick",this.floors,t=>{if(t.length){let s=t[0].object;for(;!this.floors.includes(s);)s=s.parent;console.log(s.name,"target"),this.changeFloor(s.name)}});return this.eventClear.push(e.clear),e.clear}disposeGatherOrSilent(){let e=[];for(let t in this.gatherOrSilentData)e.push(t);e.forEach(t=>{delete this.gatherOrSilentData[t]}),this.gatherOrSilentData={},this.disPoseGatherShader()}changeFloor(e){if(!this.buildingObject||!this.buildingObject[e])return console.warn(`楼层 "${e}" 的建筑数据尚未加载完成，请稍后再试`),!1;if(!this.endChangeFloor)return!1;Ot=0,this.resetData(),this.clearDeviceLabels(),this.removeEventListener(),this.currentFloor||(this.endChangeFloor=!1,this.switchFloorAnimate(e).then(t=>{window.configs.floorToName[this.buildingName+"_室内"]&&window.configs.floorToName[this.buildingName+"_室内"][e]&&Ra(window.configs.floorToName[this.buildingName+"_室内"][e]),super.updateOrientation(),this.core.crossSearch.changeSceneSearch(),this.endChangeFloor=!0,this.gatherOrSilentShader(),this.loadAndRenderDeviceLabels(),this.setupFloorRaycastEvents(e),this.sceneHint.updateMessage("右键双击恢复楼栋")}),this.buildingAnimate(e)),this.currentFloor&&this.currentFloor.name===e&&this.endChangeFloor}gatherOrSilentShader(){if(this.disPoseGatherShader(),this.gatherOrSilentData[this.currentFloor.name]){const{id:e,type:t,areaType:s,areaDataOut:i,areaDataBuilding:r,areaName:o}=this.gatherOrSilentData[this.currentFloor.name];this.gatherOrSilentLabel=this.core.ground.gatherOrSilentPlate.gatherModel(this.currentFloor,t,o),this.scene.add(this.gatherOrSilentLabel)}}disPoseGatherShader(){this.gatherOrSilentLabel&&(this.core.ground.gatherOrSilentPlate.clearGeometryGather(this.currentFloor),this.gatherOrSilentLabel.deleteSelf(),this.gatherOrSilentLabel=null)}addIndoorEvent(){let e=this.core.addClickCustom(this.indoorClickEvent.bind(this));this.eventClear.push(e)}indoorClickEvent(e){const s=e.intersectObject(this.orientation.orientation3D.singleGroup).filter(o=>o.object.visible);if(s.length){this.core.clearSearch();const o=s[0].object;this.orientation.setSearchId(o.name),this.orientation.search(),this.orientation.personSearchModule.setPosition();return}const r=e.intersectObject(V.equipGroup).filter(o=>o.object.visible);if(r.length){this.core.clearSearch();let o=r[0].object.typeName,a=r[0].object.name;V.searchEquip(a,o);return}}addRayMove(){let e=this.core.raycast("mousemove",this.floors,t=>{if(t.length){let s=t[0].object;for(;!this.floors.includes(s);)s=s.parent;if(console.log(s.name,"target"),this.currentPoint===s)return;this.currentPoint=s,document.body.style.cursor="pointer",this.core.postprocessing.clearOutlineAll(1),this.core.postprocessing.addOutline(s,1)}else{if(!this.currentPoint)return;this.resetEffect()}});return this.eventClear.push(e.clear),e.clear}setFloorGatherOrSilent(e){this.gatherOrSilentData[e.areaDataFloor]=e}addRightDbClickQuit(){const e=this.rightDblClickListener(()=>{this.core.changeSystem("ground")});this.eventClear.push(e)}rightDblClickListener(e){const t=i=>{if(console.log("右键点击，时间戳测试一下",i.button),i.button!==2)return;const r=new Date().getTime();console.log(`右键点击，时间戳: ${r}, 上次时间戳: ${Ot}`),Ot===0?(Ot=r,console.log("第一次右键点击，记录时间戳")):r-Ot<300?(console.log("检测到右键双击，执行恢复楼栋功能"),e(i),Ot=0):(Ot=r,console.log("双击检测失败，更新为新的时间戳"))};return document.addEventListener("mouseup",t),()=>{document.removeEventListener("mouseup",t)}}switchFloorAnimate(e){if(!this.buildingObject||!this.buildingObject[e]||!this.buildingObject[e].group)return console.error(`楼层 "${e}" 的建筑数据不完整，无法执行楼层切换动画`),Promise.reject(new Error(`楼层 "${e}" 的建筑数据不完整`));const t=this.buildingObject[e].group,{min:s,max:i}=Qe(t);return new Promise((r,o)=>{rn(i.y,s.y),this.currentFloor=t,this.cameraMoveToFloor(t).then(()=>{r({sceneType:0,originId:e})})})}floorSwitchInner(e){if(!this.buildingObject||!this.buildingObject[e]||!this.buildingObject[e].group){console.error(`楼层 "${e}" 的建筑数据不完整，无法执行楼层内部切换`);return}this.endChangeFloor=!1;const t=this.buildingObject[e].group,{min:s,max:i}=Qe(t);wc(),rn(i.y,s.y);let r=this.currentFloor.name;this.buildingObject[r].uTime.value=.2,this.buildingObject[e].group.visible=!0,this.buildingObject[e].uTime.value=1,new ai(this.buildingObject[r].uTime).to({value:0},1e3).start().onComplete(()=>{this.buildingObject[r].group.visible=!1}),this.currentFloor=t,this.cameraMoveToFloor(t).then(()=>{super.updateOrientation(),this.core.crossSearch.changeSceneSearch(),this.endChangeFloor=!0,this.loadAndRenderDeviceLabels()})}resetEffect(){this.currentPoint=null,document.body.style.cursor="auto",this.core.postprocessing.clearOutlineAll(1)}buildingAnimate(e){return new Promise((t,s)=>{Reflect.ownKeys(this.buildingObject).forEach(i=>{i===e||new ai(this.buildingObject[i].uTime).to({value:0},1e3).start().onComplete(()=>{this.buildingObject[i].group.visible=!1,t()})})})}resetBuilding(){rn(),Reflect.ownKeys(this.buildingObject).forEach(e=>{this.buildingObject[e].group.visible=!0,new ai(this.buildingObject[e].uTime).to({value:1},1e3).start().onComplete(()=>{this.currentFloor=null,this.resetData()})}),this.sceneHint&&this.sceneHint.updateMessage("右键双击返回室外")}resetData(){this.orientation.orientation3D.disposeClusterGroup(),V.disposeAll()}removeEventListener(){this.clearFloorRaycastEvents(),this.eventClear.forEach(e=>e()),this.eventClear=[],this.resetEffect()}dispose(){console.log("开始 dispose 室内系统..."),this.currentFloor=null,this.buildingObject&&(Object.values(this.buildingObject).forEach(e=>{e.group&&(e.group.traverse(t=>{t.isMesh&&t.material&&(Array.isArray(t.material)?t.material.forEach(s=>{this.disposeMaterial(s)}):this.disposeMaterial(material),t.material=null),t.geometry&&t.geometry.dispose()}),this.scene.remove(e.group))}),this.buildingObject={}),this.removeEventListener(),this.resetData(),this.scene.dispose(),rn(),this.clearDeviceLabelsAndInstance(),this.boxModelGround&&(this.boxModelGround.dispose(),this.boxModelGround=null),this.sceneHint&&(this.sceneHint.destroy(),this.sceneHint=null),this.removeLightHelpers(),window.gc&&window.gc(),this.core&&this.core.logWebGLResources&&(console.log("dispose后的WebGL资源使用情况:"),this.core.logWebGLResources()),this.core&&this.core.textureManager&&this.core.textureManager.clearAll(),console.log("室内系统 dispose 完成")}addLightHelpers(){this.removeLightHelpers(),this.mainLightHelper=new Rn(this.lights.main,5),this.scene.add(this.mainLightHelper),this.auxiliaryLightHelper=new Rn(this.lights.auxiliary,3),this.scene.add(this.auxiliaryLightHelper),this.shadowCameraHelper=new or(this.lights.main.shadow.camera),this.scene.add(this.shadowCameraHelper)}removeLightHelpers(){this.mainLightHelper&&(this.scene.remove(this.mainLightHelper),this.mainLightHelper.dispose(),this.mainLightHelper=null),this.auxiliaryLightHelper&&(this.scene.remove(this.auxiliaryLightHelper),this.auxiliaryLightHelper.dispose(),this.auxiliaryLightHelper=null),this.shadowCameraHelper&&(this.scene.remove(this.shadowCameraHelper),this.shadowCameraHelper.dispose(),this.shadowCameraHelper=null)}setIndoorEnvironment(e="hdr"){switch(this.clearIndoorHDR(),e){case"room":const t=new sl(this.renderer);this.scene.environment=t.environment,this.scene.background=t.environment,console.log("室内已设置 RoomEnvironment");break;case"hdr":this.setIndoorHDRSky();break;case"default":this.scene.background=ks,console.log("室内已设置默认环境");break;default:console.warn(`未知的室内环境类型: ${e}`);break}this.processIndoorEnvMapMaterials()}setIndoorHDRSky(){const e=new kn;e.setDataType(ds),e.load("./bg.hdr",t=>{t.mapping=fs,t.colorSpace=j,t.exposure=1.5,this.scene.background=t;const s=t.clone();s.intensity=1.2,this.scene.environment=s,this.processIndoorEnvMapMaterials()},t=>{console.error("室内HDR加载失败:",t),this.setFallbackIndoorHDR()})}setFallbackIndoorHDR(){const e=new kn;e.setDataType(ds),e.load("./bg.hdr",t=>{t.mapping=fs,t.colorSpace=j,t.exposure=1.8,this.scene.background=t;const s=t.clone();s.intensity=1,this.scene.environment=s,this.processIndoorEnvMapMaterials()},t=>{console.error("备用HDR也加载失败:",t),this.setDefaultIndoorSky()})}setDefaultIndoorSky(){const e=document.createElement("canvas");e.width=1024,e.height=512;const t=e.getContext("2d"),s=t.createLinearGradient(0,0,0,e.height);s.addColorStop(0,"#FFD700"),s.addColorStop(.3,"#FFA500"),s.addColorStop(.7,"#FF8C00"),s.addColorStop(1,"#FF4500"),t.fillStyle=s,t.fillRect(0,0,e.width,e.height);const i=new lr(e);i.mapping=fs,i.colorSpace=j,this.scene.background=i;const r=i.clone();r.intensity=.8,this.scene.environment=r}processIndoorEnvMapMaterials(){this.scene.traverse(e=>{e.isMesh&&e.material&&(Array.isArray(e.material)?e.material.forEach(t=>{this.setupIndoorMaterial(t)}):this.setupIndoorMaterial(e.material))})}setupIndoorMaterial(e){(e.isMeshStandardMaterial||e.isMeshPhysicalMaterial)&&(this.scene.environment?(e.envMap=this.scene.environment,e.envMapIntensity=3.2):e.envMapIntensity=0,e.needsUpdate=!0)}clearIndoorHDR(){this.scene.background&&(this.scene.background.dispose(),this.scene.background=null),this.scene.environment&&(this.scene.environment.dispose(),this.scene.environment=null),this.scene.traverse(e=>{e.isMesh&&e.material&&(Array.isArray(e.material)?e.material.forEach(t=>{t.envMap&&(t.envMap=null,t.envMapIntensity=0,t.needsUpdate=!0)}):e.material.envMap&&(e.material.envMap=null,e.material.envMapIntensity=0,e.material.needsUpdate=!0))})}update(){this.ground&&this.ground.update&&this.ground.update(this.core),this.boxModelGround&&this.boxModelGround.update(this.core.elapsedTime)}clearIndoorData(){console.log("开始清理室内系统数据..."),this.removeEventListener(),this.resetData(),this.disposeGatherOrSilent(),this.clearDeviceLabelsAndInstance(),this.sceneHint&&this.sceneHint.hide(),this.ground&&(this.scene.remove(this.ground),this.ground.geometry&&this.ground.geometry.dispose(),this.ground.material&&this.ground.material.dispose(),this.ground=null),this.boxModelGround&&(this.boxModelGround.dispose(),this.boxModelGround=null),this.buildingObject&&(Object.values(this.buildingObject).forEach(e=>{e.group&&(e.group.traverse(t=>{t.isMesh&&t.material&&(Array.isArray(t.material)?t.material.forEach(s=>{this.disposeMaterial(s)}):this.disposeMaterial(t.material),t.material=null),t.geometry&&t.geometry.dispose()}),this.scene.remove(e.group))}),this.buildingObject={}),this.building&&this.building.parent&&(this.building.parent.remove(this.building),this.building=null),this.buildingObject={},this.floors=[],this.floorsName=[],this.currentFloor=null,this.endChangeFloor=!0,this.resetControls(),this.clearIndoorHDR(),this.removeIndoorLights(),window.gc&&window.gc(),this.core&&this.core.logWebGLResources&&(console.log("清理后的WebGL资源使用情况:"),this.core.logWebGLResources()),this.core&&this.core.textureManager&&this.core.textureManager.clearAll(),console.log("室内系统数据清理完成")}disposeMaterial(e){if(!e)return;["map","normalMap","emissiveMap","specularMap","roughnessMap","metalnessMap","alphaMap","envMap","lightMap","aoMap","displacementMap","bumpMap"].forEach(s=>{if(e[s]){if(this.core&&this.core.textureManager){const i=`${e.name||"unknown"}_${s}`;this.core.textureManager.removeTexture(i)}else e[s].dispose();e[s]=null}}),e.dispose()}createAndSetupLights(e){if(!e){console.warn("建筑对象未提供，无法创建和设置灯光");return}this.removeIndoorLights();const t=new ce().setFromObject(e),s=t.getCenter(new M),i=t.getSize(new M),r=t.min,o=t.max,a=i.x,l=i.y,h=i.z,d=Math.max(a,l,h),u=new rr(16777215,.8);this.ambientLight=u,this._add(this.ambientLight);const c=new us(16777215,.5),f=o.y+d*.5;c.position.set(s.x,f,s.z);const p=s.clone();p.y=r.y-50,c.target.position.copy(p),c.castShadow=!0,c.shadow.mapSize.width=2048,c.shadow.mapSize.height=2048,c.shadow.camera.near=.1,c.shadow.camera.far=f*2;const B=d*2;c.shadow.camera.left=-B,c.shadow.camera.right=B,c.shadow.camera.top=B,c.shadow.camera.bottom=-B,c.shadow.bias=-1e-4,c.shadow.normalBias=.02,c.shadow.radius=1.5,this.directionLight=c,this._add(this.directionLight),this.lights={ambient:this.ambientLight,main:this.directionLight,auxiliary:null},console.log("室内灯光创建完成")}removeIndoorLights(){this.removeLightHelpers(),this.lights&&(this.lights.ambient&&(this.scene.remove(this.lights.ambient),this.lights.ambient.dispose()),this.lights.main&&(this.lights.main.target&&this.scene.remove(this.lights.main.target),this.scene.remove(this.lights.main),this.lights.main.dispose()),this.lights.auxiliary&&(this.lights.auxiliary.target&&this.scene.remove(this.lights.auxiliary.target),this.scene.remove(this.lights.auxiliary),this.lights.auxiliary.dispose()),this.lights=null),this.ambientLight&&(this.scene.remove(this.ambientLight),this.ambientLight.dispose(),this.ambientLight=null),this.directionLight&&(this.directionLight.target&&this.scene.remove(this.directionLight.target),this.scene.remove(this.directionLight),this.directionLight.dispose(),this.directionLight=null),this.auxiliaryLight&&(this.auxiliaryLight.target&&this.scene.remove(this.auxiliaryLight.target),this.scene.remove(this.auxiliaryLight),this.auxiliaryLight.dispose(),this.auxiliaryLight=null);const e=[];this.scene.traverse(t=>{t.isLight&&e.push(t)}),e.forEach(t=>{console.log("清理场景中的灯光:",t.type,t.name||"unnamed"),this.scene.remove(t),t.dispose&&t.dispose()}),console.log("室内灯光清理完成")}clearFloorRaycastEvents(){this._indoorRaycastClearFns&&(console.log(`清理楼层射线检测事件，共 ${this._indoorRaycastClearFns.length} 个事件`),this._indoorRaycastClearFns.forEach(e=>e()),this._indoorRaycastClearFns=[])}setupFloorRaycastEvents(e){console.log(`开始设置楼层 ${e} 的射线检测事件`),this.clearFloorRaycastEvents();const t=this.buildingObject[e].group.children;if(this._indoorRaycastClearFns=[],!t||t.length===0){console.warn(`楼层 ${e} 没有子对象，无法设置射线检测事件`);return}console.log(`楼层 ${e} 有 ${t.length} 个子对象`),t.forEach(o=>{o.typeName="device",o.traverse(a=>{a instanceof K&&a.material&&(a._originalMaterial||(a._originalMaterial=a.material.clone()))})});const s=this.core.raycast("mousemove",t,o=>{o.length?(this.core.postprocessing.clearOutlineAll(1),this.core.postprocessing.addOutline(o[0].object,1)):this.core.postprocessing.clearOutlineAll(1)});this._indoorRaycastClearFns.push(s.clear);const i=this.core.raycast("click",t,o=>{if(o.length){let a=o[0].object;if(a=this.getDeviceObject(a),!a)return;const l=a.name.split("_")[0];Hd(l),this.cameraMove(a).then(()=>{t.forEach(h=>{h===a?h.traverse(d=>{d instanceof K&&d.material&&(d._originalMaterial&&(d.material=d._originalMaterial),d.material.wireframe=!1,d.material.transparent=!1)}):h.traverse(d=>{if(d instanceof K&&d.material){const u=new ct({color:26367,transparent:!0,opacity:.8,wireframe:!0});d.material=u}})})})}});this._indoorRaycastClearFns.push(i.clear),console.log(`为楼层 ${e} 注册右键双击恢复事件`);const r=this.rightDblClickListener(()=>{console.log(`楼层 ${e} 的右键双击恢复事件被触发`),console.log("=== 右键双击恢复 - 开始 ==="),console.log("当前相机位置:",this.camera.position),console.log("当前controls.target:",this.controls.target),this.core.postprocessing.clearOutlineAll(1),this.core.postprocessing.clearOutlineAll(2),t.forEach(o=>{o.traverse(a=>{a instanceof K&&a.material&&(a._originalMaterial?a.material=a._originalMaterial:(a.material.wireframe=!1,a.material.transparent=!1),a.visible=!0)})}),this.removeEventListener(),this.cameraMove(this.building,this.initialCameraPosition),this.addEventListener(),this.resetBuilding(),this.disPoseGatherShader(),this.addRightDbClickQuit()});this._indoorRaycastClearFns.push(r),console.log(`楼层 ${e} 的射线检测事件设置完成，共 ${this._indoorRaycastClearFns.length} 个事件`)}resetCamera(){console.log("重置室内视角..."),this.core.postprocessing.clearOutlineAll(1),this.core.postprocessing.clearOutlineAll(2),this.currentFloor&&this.buildingObject[this.currentFloor.name]?(this.buildingObject[this.currentFloor.name].group.children.forEach(t=>{t.traverse(s=>{s instanceof K&&s.material&&(s._originalMaterial?s.material=s._originalMaterial:(s.material.wireframe=!1,s.material.transparent=!1),s.visible=!0)})}),this.cameraMoveToFloor(this.buildingObject[this.currentFloor.name].group).then(()=>{console.log("室内视角重置完成")})):this.building&&this.cameraMove(this.building).then(()=>{console.log("室内视角重置完成（默认位置）")})}getDeviceObject(e){return e?e.typeName==="device"?e:this.getDeviceObject(e.parent):null}saveDeviceLabelsToInstance(e){if(!Array.isArray(e)){console.warn("设备数据格式错误，应为数组");return}console.log("保存设备标签数据..."),console.log("要保存的数据:",e),e.forEach(t=>{const{code:s}=t;s?(this.deviceLabelsData[s]=t,console.log(`设备标签数据已保存到实例: ${s}`,t)):console.warn("设备数据缺少code字段:",t)}),console.log("当前所有存储的数据:",this.deviceLabelsData)}loadDeviceLabelsFromInstance(){if(!this.currentFloor||!this.buildingObject[this.currentFloor.name])return console.log("当前楼层或建筑数据不存在"),null;const e=this.buildingObject[this.currentFloor.name].group.children,t=[],s=[];return e.forEach(i=>{const r=i.name.split("_")[0];r&&this.deviceLabelsData[r]&&(t.push(r),s.push(this.deviceLabelsData[r]))}),s.length>0?(console.log(`从实例读取设备标签数据，找到 ${s.length} 个设备:`,t),console.log("设备数据:",s),s):(console.log("当前楼层没有找到对应的设备标签数据"),null)}clearDeviceLabelsFromInstance(e=null){e&&Array.isArray(e)?e.forEach(t=>{this.deviceLabelsData[t]&&(delete this.deviceLabelsData[t],console.log(`已清除设备标签数据: ${t}`))}):(this.deviceLabelsData={},console.log("已清除所有设备标签数据"))}clearAllDeviceLabelsData(){this.deviceLabelsData={},console.log("已清除所有楼层的设备标签数据")}loadAndRenderDeviceLabels(){requestAnimationFrame(()=>{console.log("开始加载设备标签数据..."),console.log("当前楼层:",this.currentFloor?this.currentFloor.name:"null"),console.log("存储的数据:",this.deviceLabelsData);const e=this.loadDeviceLabelsFromInstance();e&&e.length>0?(console.log("自动加载实例中的设备标签数据"),this.updateDeviceLabels(e)):console.log("没有找到当前楼层的设备标签数据")})}updateDeviceLabels(e){if(!Array.isArray(e)){console.warn("设备数据格式错误，应为数组");return}console.log("开始更新设备标签..."),console.log("新数据:",e),this.clearDeviceLabels(),this.clearDeviceLabelsFromInstance(),this.saveDeviceLabelsToInstance(e),e.forEach(t=>{this.createDeviceLabel(t)}),console.log("设备标签更新完成")}clearDeviceLabels(){console.log("开始清除设备牌子..."),console.log("当前设备牌子数量:",this.deviceLabels?this.deviceLabels.length:0),this.deviceLabels&&this.deviceLabels.length>0?(this.deviceLabels.forEach((t,s)=>{console.log(`清除第 ${s+1} 个设备牌子:`,t.code),t.element&&(console.log(`移除DOM元素: ${t.code}`),t.element.remove(),t.element=null),t.css2dObject&&(console.log(`从场景移除CSS2D对象: ${t.code}`),t.css2dObject.parent&&t.css2dObject.parent.remove(t.css2dObject),this.scene.remove(t.css2dObject),t.css2dObject=null),t.deviceObject&&(t.deviceObject=null)}),this.deviceLabels=[],console.log("设备牌子数组已清空")):console.log("没有设备牌子需要清除"),this.scene.traverse(t=>{t.name&&t.name.startsWith("device-label-")&&(console.log(`发现残留的CSS2D对象: ${t.name}，正在移除...`),this.scene.remove(t))});const e=document.getElementById("css2dRenderer");if(e){const t=e.querySelectorAll(".device-label-container");console.log(`在CSS2D渲染器中发现 ${t.length} 个残留的设备标签DOM元素`),t.forEach((s,i)=>{console.log(`移除残留的DOM元素 ${i+1}:`,s),s.remove()})}console.log("设备牌子清除完成")}clearDeviceLabelsAndInstance(e=null){this.clearDeviceLabels(),this.clearDeviceLabelsFromInstance(e)}createDeviceLabel(e){const{name:t,visible:s=!0,code:i,configs:r=[]}=e,o=this.findDeviceByCode(i);if(!o){console.warn(`未找到设备编号为 ${i} 的设备`);return}const a=document.createElement("div");a.className="device-label-container";const l=document.createElement("div");l.className="device-label-main";const h=document.createElement("div");if(h.className="device-label-name",h.textContent=t,l.appendChild(h),r&&r.length>0){const A=document.createElement("div");A.className="device-label-configs",r.forEach(m=>{const g=document.createElement("div");g.className="device-label-config-item";const C=document.createElement("span");C.className="device-label-config-key",C.textContent=m.key+": ";const E=document.createElement("span");E.className="device-label-config-value",E.textContent=m.value,g.appendChild(C),g.appendChild(E),A.appendChild(g)}),l.appendChild(A)}const d=document.createElement("div");d.className="device-label-top";const u=document.createElement("div");u.className="device-label-bottom";const c=document.createElement("div");c.className="device-label-bottom-down",a.appendChild(l),a.appendChild(d),a.appendChild(u),a.appendChild(c);const f=Te(a,`device-label-${i}`),p=new ce().setFromObject(o),B=new M;p.getCenter(B),B.y=p.max.y,console.log(`设备 ${i} 包围盒信息:`,{min:p.min.toArray(),max:p.max.toArray(),center:B.toArray(),deviceName:o.name}),f.position.copy(B),f.visible=s,this.scene.add(f),this.deviceLabels||(this.deviceLabels=[]),this.deviceLabels.push({code:i,element:a,css2dObject:f,deviceObject:o})}findDeviceByCode(e){if(!this.currentFloor||!this.buildingObject[this.currentFloor.name])return null;const t=this.buildingObject[this.currentFloor.name].group.children;for(const s of t)if(s.name.split("_")[0]===e)return s;return null}}const Ri=new M;class Rp{constructor(e){this.camera=e.camera,this.controls=e.controls}lerpTo(e,t=100,s=1e3,i=new M){const r=this.camera.position.distanceTo(e),o=(r-t)/r;Ri.lerpVectors(this.camera.position,e,o),Ri.add(i),this.changeTo({start:this.camera.position,end:Ri,duration:s,onStart:()=>this.controls.enabled=!1,onComplete:()=>this.controls.enabled=!0}),this.changeTo({start:this.controls.target,end:e,duration:s,onUpdate:()=>{this.camera.lookAt(this.controls.target)}})}changeTo(e){const{start:t,end:s,duration:i,onUpdate:r,onComplete:o,onStart:a}=e;if(!(!i||!s||!t))return new kr.Tween(t).to(s,i).onStart(a).onUpdate(r).onComplete(o).start()}removeAll(){kr.removeAll()}}class Gp{constructor(e){this.core=e,this.crossSearchBuilding=!1,this.crossSearchInspection=!1,this.crossSearchDangerPerson=!1,this.crossSearchPerson=!1,this.crossFollowPerson=!1,this.setCrossSearchId=null,this.setCrossFollowId=null,this.crossGatherWarning=null}setCrossGatherWarning(e){this.crossGatherWarning=e}setCrossSearchBuildingStatus(e){this.crossSearchBuilding=e}setCrossFollowStatus(e){this.crossFollowPerson=e}setCrossSearchPersonStatus(e){this.crossSearchPerson=e}setCrossSearchInspectionStatus(e){this.crossSearchInspection=e}setCrossSearchDangerPersonStatus(e){this.crossSearchDangerPerson=e}changeSceneSearch(){this.crossSearchBuilding&&this.core.sceneType===1&&(this.core.ground.searchBuilding(),this.crossSearchBuilding=!1),this.crossSearchInspection&&(this.core.currentSystem.searchInspection(),this.crossSearchInspection=!1),this.crossGatherWarning&&(this.core.gatherWarning.gatherDangerFun(this.crossGatherWarning),this.crossGatherWarning=null),this.crossSearchPerson&&(this.core.orientation.setSearchId(this.setCrossSearchId),this.core.orientation.search(),this.core.orientation.personSearchModule.setPosition(),this.crossSearchPerson=!1,this.setCrossSearchId=null),this.crossFollowPerson&&(this.core.currentSystem.startFollowPerson(this.setCrossFollowId),this.crossFollowPerson=!1,this.setCrossFollowId=null),this.crossSearchDangerPerson&&(this.core.currentSystem.searchAlarmPerson(),this.crossSearchDangerPerson=!1)}}class Op{constructor(e){this.core=e,this.circles=[],this.eventClear=[],this.gatherMap=new Map,this.realTimeMap=new Map,this.memoryManager=new le}addEvents(){let e=this.core.raycast("click",this.circles,s=>{s.length?(console.log(s[0].point,"位置坐标"),this.showLabel(s[0].object.typeId)):this.showLabel(null)});this.eventClear.push(e.clear);let t=this.core.raycast("mousemove",this.circles,s=>{s.length?document.body.style.cursor="pointer":document.body.style.cursor="block"});this.eventClear.push(t.clear)}showLabel(e){this.realTimeMap.forEach((t,s)=>{t.board.visible=s===e})}removeEventListener(){this.eventClear.forEach(e=>{e()}),this.eventClear=[]}gatherDanger(e){const t=e.sceneChangeType;e.isDanger=!0,t==="noChange"?this.gatherDangerFun(e):(this.core.changeSystemCustom(t,e.originId,e.sceneType),this.core.crossSearch.setCrossGatherWarning(e))}async realTimeGather(e){this.removeEventListener(),this.circles=[],(!e||e.length===0)&&this.disposeRealTimeGather();let t={add:[],update:[],remove:[]},s=new Map;e.forEach(i=>{i.isDanger=!1,s.set(i.id,i),this.realTimeMap.get(i.id)&&t.update.push(i),this.realTimeMap.get(i.id)||t.add.push(i)}),this.realTimeMap.forEach((i,r)=>{s.get(r)||t.remove.push(r)}),t.add.forEach(({position:i,radius:r,level:o,users:a,id:l,name:h},d)=>{this.gatherDangerFun({position:i,radius:r,level:o,users:a,id:l,isDanger:!1,name:h},"add")}),t.update.forEach(({position:i,radius:r,level:o,users:a,id:l,name:h},d)=>{this.gatherDangerFun({position:i,radius:r,level:o,users:a,id:l,isDanger:!1,name:h},"update")}),t.remove.forEach(i=>{this.deleteRealTimeById(i)}),this.addEvents()}deleteRealTimeById(e){let t=this.realTimeMap.get(e).obj;for(let s=t.length-1;s>=0;s--)le.dispose(t[s]);le.dispose(this.realTimeMap.get(e).board),le.dispose(this.realTimeMap.get(e).object3d),this.realTimeMap.delete(e)}getCenterPosition(e){let t=0,s=0,i=0,r=e.length;e.forEach(h=>{t+=h.x,s+=h.y,i+=h.z});let o=t/r,a=s/r,l=i/r;return new M(o,a,l)}gatherDangerFun({position:e,radius:t,level:s,users:i,id:r,isDanger:o=!1,name:a},l){let h=null,d=null;if(l==="add"&&(d=new Ae,h=this.setPersonBoard({name:`${i.split(",").length}人`,id:r,areaName:`${a}`},!0,s,i,o,r),h.center.set(.5,1),d.add(h),d.position.set(0,0,0),this.core.scene.add(d),o||(h.visible=!1)),l==="update"){h=this.realTimeMap.get(r).board,d=this.realTimeMap.get(r).object3d;let c=this.realTimeMap.get(r).obj;for(let f=c.length-1;f>=0;f--)le.dispose(this.realTimeMap.get(r).obj[f]);this.realTimeMap.get(r).obj=null}h.position.copy(this.getCenterPosition(e));let u=[];e.forEach(c=>{t||(t=500);let f=t/100,p=new Sc(new M,f,s);d.add(p),u.push(p),p.typeId=r,this.circles.push(p),p.position.copy(c)}),o?(this.disposeGather(),this.gatherMap.set(r,{obj:u,board:h,object3d:d})):(l==="add"&&this.realTimeMap.set(r,{obj:u,board:h,object3d:d}),l==="update"&&(this.realTimeMap.get(r).obj=u,this.realTimeMap.get(r).object3d=d))}setPersonBoard(e,t=!1,s,i,r,o){let a={3:"#FFDE33",2:"#FF9441",1:"#FF4747"},l={3:"yellow",2:"orange",1:"red"},h=document.createElement("div");h.style="margin-bottom:12px";let d=document.createElement("span");d.style.color=a[s],d.innerText=e.name;let u=document.createElement("span");u.style.color=a[s],u.innerText=e.areaName;let c=document.createElement("div"),f=document.createElement("div"),p=document.createElement("div"),B=document.createElement("div");B.className="beilu_three_Board_text_gather_span",B.style.background=`${a[s]}`;let A=document.createElement("div");A.className="beilu_three_Board_text_gather_span",A.style.background=`${a[s]}`,p.append(h),p.append(c),p.append(f),p.draggable=!1,p.className="beilu_three_Board_text_gather",p.style.border=`1px solid ${a[s]}`,f.className=`beilu_three_Board_text_gather_down_${l[s]}`,h.innerText="聚集人数：",h.append(d),h.append(B),c.innerText="报警位置：",c.append(A),c.append(u),h.onclick=()=>{Ld({users:i,isDanger:r,alarmId:o})};let m=Te(p,"board"+e.id);return m.visible=t,m}disposeGather(){this.gatherMap.forEach(e=>{let t=e.obj;for(let s=t.length-1;s>=0;s--)le.dispose(t[s]);le.dispose(e.board),le.dispose(e.object3d)}),this.gatherMap.clear(),this.circles=[],this.removeEventListener()}disposeRealTimeGather(){this.realTimeMap.forEach(e=>{for(let t=e.obj.length-1;t>=0;t--)le.dispose(e.obj[t]);le.dispose(e.board),le.dispose(e.object3d)}),this.realTimeMap.clear(),this.circles=[],this.removeEventListener()}}let Qo=0;const $o=new N,Gi=new N,js=class js extends Ed{constructor(t){super(t);O(this,"getMouse",(t,s)=>{const{left:i,top:r,width:o,height:a}=this.domElement.getBoundingClientRect();s.x=(t.clientX-i)/o*2-1,s.y=-((t.clientY-r)/a)*2+1});this.time=new Date().getTime(),this.cache=!0,this.currentSystem=null,this.firstLoad=!0,this.sceneType=1,this.dwObj={},this.ray=new Gn,this.inDoorModel=!1;const s=js.Default.position.clone().applyAxisAngle(new M(0,1,0),45).multiplyScalar(.25);this.camera.position.copy(s),this.controls.target.copy(js.Default.target),this.controls.minDistance=0}setIndoorModel(t){this.inDoorModel=t}isIndoorModel(){return this.inDoorModel}init(){this.initCSS2DRenderer(),this.initCSS3DRenderer(),this.initComposer(),this._beginRender(),this.controlEvent()}_beginRender(){this.renderEnabled||(this.firstLoad?(this.setClass(),this.firstLoad=!1):this.currentSystem.onEnter(),this.beginRender())}_stopRender(){this.stopRender(),this.currentSystem.onLeave()}setClass(){this.tweenControl=new Rp(this),this.orientation=new $e(this),this.ground=new xp(this),this.indoorSubsystem=new Hp(this),this.crossSearch=new Gp(this),this.gatherWarning=new Op(this),this.changeSystem("ground"),this.onRenderQueue.set("elapsedTimeUpdate",t=>Mc(t.elapsedTime)),this.onRenderQueue.set("globalAnimationUpdate",()=>qs.update())}hideInspectionSystemIcon(t){this.currentSystem.hideInspectionSystemIcon(t)}isSearching(){return!!this.orientation.searchId}isFollowing(){return!!this.orientation.followId}cherryPick(t){this.currentSystem.cherryPick(t)}createFence(t){this.currentSystem.createFence&&this.currentSystem.createFence(t)}async changeSystem(t,s=null){this.clearFence(),this.changeSystemCommon(t),this.orientation.clearSearch(),await this[t].onEnter(s)}async changeIndoor(t){const s=window.floorToName[t];if(!s){console.warn(`未找到建筑 "${t}" 的配置信息`);return}const{path:i,floor:r}=s,o=i.replace("inDoor/","").replace("_室内","");this.currentSystem===this.indoorSubsystem&&(console.log("当前已在室内系统，执行清理操作"),this.indoorSubsystem.clearIndoorData(),this.camera.position.set(0,10,20),this.controls.target.set(0,0,0),this.controls.update()),await this.changeSystem("indoorSubsystem",o),new Promise(h=>{const d=()=>{this.indoorSubsystem&&this.indoorSubsystem.building&&this.indoorSubsystem.buildingObject&&this.indoorSubsystem.buildingObject[r]?h():setTimeout(d,100)};d()}).then(()=>{this.changeFloor(r)})}clearFence(){this.currentSystem&&this.currentSystem.clearFence&&this.currentSystem.clearFence()}clearEquipType(t){this.currentSystem.clearEquipType(t)}changeSystemCommon(t){const s=this[t],i=this.currentSystem;if(!s){console.warn(`${t}子系统未初始化`);return}if(i)if(s===i)if(t==="indoorSubsystem")console.log("室内系统重新初始化 - 执行完整清理"),i.onLeave(),this.onRenderQueue&&this.onRenderQueue.delete("indoorSubsystem"),this.indoorSubsystem.sceneHint&&this.indoorSubsystem.sceneHint.hide(),this.indoorSubsystem.resetControls();else return;else i.onLeave();this.orientation.orientation3D.disposeClusterGroup(),this.orientation.orientation3D.disposeAlarm(),this.changeScene(s.scene),this.currentSystem=s,this.sceneType=t==="ground"?$e.SCENE_TYPE.OUTDOOR:$e.SCENE_TYPE.INDOOR}async changeSystemCustom(t,s,i){const r=i===$e.SCENE_TYPE.INDOOR?"indoorSubsystem":"ground";this.changeSystemCommon(r);const o=this[r];t==="inToOut"?await o.onEnter():await o.onChangeSystemCustom(t,s,s.slice(0,-3))}controlEvent(){this.controls.addEventListener("start",()=>{this.setRaycasterState("mousemove",!1)}),this.controls.addEventListener("end",()=>{this.setRaycasterState("mousemove",!0)})}getCurrentOriginId(){return{sceneType:this.sceneType,originId:this.indoorSubsystem.currentFloor?this.indoorSubsystem.currentFloor.name:""}}setHeatmap(t){this.orientation.setHeatmap(t)}changeScene(t){this.scene=t}changeWeather(t){this.currentSystem.changeWeather(t)}switchWeather(t){this.ground.switchWeather(t)}changeFloor(t){this.indoorSubsystem&&this.indoorSubsystem.changeFloor(t)}startMeasuring(){this.changeView(new M(0,1,0),1200),this.enableControlsRotate(!1),this.currentSystem.startMeasuring(),this.setCameraState(!1)}removeMeasuring(){this.enableControlsRotate(!0),this.currentSystem.removeMeasuring(),this.setCameraState(this.ground.roamEnabled)}startMeasureArea(){this.changeView(new M(0,1,0),1200),this.enableControlsRotate(!1),this.currentSystem.startMeasureArea(),this.setCameraState(!1)}removeMeasureArea(){this.currentSystem.removeMeasureArea(),this.enableControlsRotate(!0),this.setCameraState(this.ground.roamEnabled)}changeBoxSelect(t){console.log("test"),this.changeView(new M(0,1,0),1200),this.enableControlsRotate(!t),this.ground.changeBoxSelect(t),t?this.setCameraState(!1):this.setCameraState(this.ground.roamEnabled)}reSelect(){this.ground.boxSelect.end(),this.ground.boxSelect.start(),this.changeView(new M(0,1,0),1200),this.enableControlsRotate(!1),this.setCameraState(!1)}changeView(t=new M(0,1,0),s=100){const i=new M().addScaledVector(t,s);this.camera.position.copy(i),this.controls.target.set(0,0,0)}resetCameraUp(){this.camera.up.set(0,1,0)}enableControlsRotate(t){this.controls.enableRotate=t}historyTrackCommand(t){this.currentSystem.historyTrackCommand(t)}clearSearch(){}async searchPerson(t){const{originId:s,sceneType:i,sceneChangeType:r,id:o}=t;r!=="noChange"?(await this.changeSystemCustom(r,s,i),this.crossSearch.setCrossSearchId=o,this.crossSearch.setCrossSearchStatus(!0)):(this.orientation.setSearchId(o),this.orientation.search(),this.orientation.personSearchModule.setPosition())}followCheck(t,s){let i=t.data.param.update.length&&t.data.param.update.filter(h=>{if(h.id===s)return h});if(!i||i.length===0)return!1;let{id:r,sceneType:o,originId:a}=i[0];o===0&&!a.includes("F")&&(o=1);let l=Tc({sceneType:o,originId:a});l!=="noChange"&&(this.orientation.cancelFollow(),this.followChangeScene({originId:a,sceneType:o,sceneChangeType:l,id:r}))}async followChangeScene({originId:t,sceneType:s,sceneChangeType:i,id:r}){await this.changeSystemCustom(i,t,s),this.crossSearch.setCrossFollowId=r,this.crossSearch.setCrossFollowStatus(!0)}async startFollow(t){this.postprocessing.clearOutlineAll(1);const{sceneChangeType:s,id:i}=t;s!=="noChange"&&await this.followChangeScene(t),s==="noChange"&&this.currentSystem.startFollowPerson(i)}cancelFollow(){this.currentSystem.cancelFollowPerson(),this.sceneType===0&&(this.indoorSubsystem.removeEventListener(),this.indoorSubsystem.addPointerLister(),this.indoorSubsystem.addIndoorEvent(),this.indoorSubsystem.addRightDbClickReset())}changeMouseEventSwitch(t){t?this.currentSystem.addEventListener():(this.currentSystem.removeEventListener(),this.postprocessing.clearOutlineAll(1),this.postprocessing.clearOutlineAll(2))}bindGroundEvent(){this.sceneType===1&&(this.ground.removeEventListener(),this.ground.addEventListener())}bindSearchEvent(){this.sceneType===1&&(this.ground.removeEventListener(),this.ground.addGroundEvent())}clearSelected(t){this.currentSystem.clearSelected(t)}clearAllPerson(){this.currentSystem.clearPerson()}dangerFenceInit(t){this.ground.initDangerFence(t)}hideBuildingDialog(t){this.ground.hideBuildingLabel(t)}hideCameraDialog(t){this.currentSystem.clearCameraVideo(t)}clearDanger(){this.orientation.orientation3D.personDangerData&&this.currentSystem.clearDangerPerson(),this.ground.clearDangerFence()}async personAlarmInit(t){const{originId:s,sceneType:i,sceneChangeType:r,id:o}=t;this.currentSystem.setDangerPerson(t),r!=="noChange"&&(await this.changeSystemCustom(r,s,i),this.crossSearch.setCrossSearchDangerPersonStatus(!0)),r==="noChange"&&this.currentSystem.searchAlarmPerson()}changeBuildingNum(t){this.ground.changeBuildingNumber(t)}hideCameraById(t){this.currentSystem.hideCameraById(t)}switchGatherStatus(t){this.orientation.clusterModule.setActive(t)}setGatherLevel(t){this.orientation.clusterModule.setLevel(t)}roamEnabled(t){this.ground.roamEnabled=t,this.ground.setCameraState(t)}roamDuration(t){this.ground.roamDuration=t}setAutoRotate(t){console.log(`设置自转功能: ${t?"开启":"关闭"}`),t?(this.controls.autoRotate=!0,this.controls.autoRotateSpeed=2,console.log("自转功能已开启")):(this.controls.autoRotate=!1,console.log("自转功能已关闭"))}searchBuilding(t,s){this.ground.searchBuildingId=t,this.sceneType===0?(this.changeSystem("ground"),this.crossSearch.setCrossSearchBuildingStatus(!0)):this.ground.searchBuilding(s)}async searchCamera(t){const{originId:s,sceneType:i,sceneChangeType:r,id:o}=t;r!=="noChange"&&(await this.changeSystemCustom(r,s,i),this.currentSystem.setSearchCameraId(o)),r==="noChange"&&this.currentSystem.searchCamera(o)}async searchInspectionSystem(t){const{originId:s,sceneType:i,sceneChangeType:r,id:o}=t;r!=="noChange"&&(await this.changeSystemCustom(r,s,i),this.currentSystem.setSearchInspectionSystemId(o)),r==="noChange"&&this.currentSystem.searchInspectionSystem(o)}async search(t){if(this.clearSearch(),!t)return;const{type:s,sceneType:i,originId:r,id:o,filter:a,sceneChangeType:l,inDoorModel:h}=t;if(!h)return this.searchBuilding(r,!1),this.setIndoorModel(!0),!1;if(s==="person")return await this.searchPerson(t);if(s==="building")return this.searchBuilding(o);if(s==="equip")return await this.searchCamera(t);if(s==="inspection")return await this.searchInspection(t);if(s==="personDanger")return await this.personAlarmInit(t);if(s==="inspectionSystem")return await this.searchInspectionSystem(t)}async searchInspection(t){const{originId:s,sceneType:i,sceneChangeType:r,id:o,name:a,position:l}=t;this.currentSystem.setSearchInspection({id:o,name:a,position:l}),r!=="noChange"&&(await this.changeSystemCustom(r,s,i),this.crossSearch.setCrossSearchInspectionStatus(!0)),r==="noChange"&&this.currentSystem.searchInspection()}processingEquipment(t,s){this.currentSystem.processingEquipData(t,s)}changeLighting(t){this.currentSystem.updateLightingPattern(t)}setCameraState(t){this.currentSystem.setCameraState(t)}beginWander(){this.currentSystem.beginWander()}resetCamera(){this.currentSystem.resetCamera()}endWander(){this.currentSystem.endWander()}rightDblClickListener(t){return this.addEventListener("mouseup").add(r=>{if(r.button!==2)return;let o=new Date().getTime();o-Qo<250&&(o=0,t(r)),Qo=o})}addClickCustom(t){let s=null;const r=this.addEventListener("mousedown").add(d=>{d.button!==2&&this.getMouse(d,$o)}),o=this.addEventListener("mouseup");let a;const l=o.add(d=>{d.button!==2&&(this.getMouse(d,Gi),$o.equals(Gi)&&(s?(clearTimeout(s),s=null):s=setTimeout(()=>{a=new Gn,a.setFromCamera(Gi,this.camera),t(a),clearTimeout(s),s=null},250)))});return()=>{r(),l(),a=null}}};O(js,"Default",{position:new M(154,265,612),target:new M(-446,10,-389)});let Jn=js;export{Jn as Store3D};
