var hl=Object.defineProperty;var Er=i=>{throw TypeError(i)};var ul=(i,e,t)=>e in i?hl(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var N=(i,e,t)=>ul(i,typeof e!="symbol"?e+"":e,t),Qi=(i,e,t)=>e.has(i)||Er("Cannot "+t);var I=(i,e,t)=>(Qi(i,e,"read from private field"),t?t.call(i):e.get(i)),Y=(i,e,t)=>e.has(i)?Er("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),X=(i,e,t,s)=>(Qi(i,e,"write to private field"),s?s.call(i,t):e.set(i,t),t),$=(i,e,t)=>(Qi(i,e,"access private method"),t);import{E as Ui,V as _,M as qt,T as Wt,S as Ar,Q as Vs,a as k,R as Ko,P as Zn,b as Qn,U as ct,c as q,D as dl,d as fl,e as pl,f as ml,W as ze,L as Mt,C as Z,g as Ci,h as Pn,N as Xo,B as Gt,i as U,j as jt,k as ms,l as Yo,m as me,n as Os,o as je,p as Me,F as Pi,q as gl,r as Rn,s as ut,t as Mr,u as ws,v as He,w as $o,x as Zo,y as os,z as gs,A as _t,G as se,H as yl,I as vl,J as bl,K as wl,O as xl,X as Ct,Y as pe,Z as Ve,_ as Qo,$ as Ot,a0 as oe,a1 as Jo,a2 as Sl,a3 as Tl,a4 as El,a5 as Jn,a6 as as,a7 as er,a8 as Ri,a9 as ea,aa as ta,ab as Al,ac as sa,ad as Li,ae as Qe,af as Fs,ag as xs,ah as he,ai as Ml,aj as J,ak as tr,al as Di,am as _l,an as _r,ao as Ln,ap as Ft,aq as Cl,ar as xi,as as ia,at as Si,au as na,av as zi,aw as Pl,ax as Dn,ay as ra,az as oa,aA as In,aB as Ii,aC as Rt,aD as Rl,aE as Ll,aF as aa,aG as Dl,aH as Il,aI as Bl,aJ as la,aK as Ol,aL as Fl,aM as Nl,aN as kl,aO as Ul,aP as zl,aQ as Hl,aR as sr,aS as Gl,aT as jl,aU as Vl,aV as ql,aW as Wl,aX as Kl,aY as Xl,aZ as Yl,a_ as $l,a$ as Zl,b0 as Ql,b1 as ca,b2 as Cr,b3 as Pr,b4 as Rr,b5 as Lr,b6 as Jl,b7 as ec,b8 as tc,b9 as sc,ba as Ns,bb as Dr,bc as Ir,bd as Zs,be as ic,bf as nc,bg as rc,bh as oc,bi as Qs,bj as ls,bk as Js,bl as Hi,bm as ac,bn as ha,bo as lc,bp as cc,bq as hc,br as Lt,bs as uc,bt as dc,bu as fc,bv as pc,bw as ua,bx as mc,by as ks,bz as gc,bA as ei,bB as yc,bC as Ji,bD as Br,bE as vc,bF as bc}from"./weather-CCT19MCv.js";import{s as ti}from"./main-BZ7YG8Tt.js";import{sceneChange as wc}from"./dataProgress-DSo5v9rz.js";var Us=function(){var i=0,e=document.createElement("div");e.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",e.addEventListener("click",function(d){d.preventDefault(),s(++i%e.children.length)},!1);function t(d){return e.appendChild(d.dom),d}function s(d){for(var h=0;h<e.children.length;h++)e.children[h].style.display=h===d?"block":"none";i=d}var n=(performance||Date).now(),r=n,o=0,a=t(new Us.Panel("FPS","#0ff","#002")),l=t(new Us.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var c=t(new Us.Panel("MB","#f08","#201"));return s(0),{REVISION:16,dom:e,addPanel:t,showPanel:s,begin:function(){n=(performance||Date).now()},end:function(){o++;var d=(performance||Date).now();if(l.update(d-n,200),d>=r+1e3&&(a.update(o*1e3/(d-r),100),r=d,o=0,c)){var h=performance.memory;c.update(h.usedJSHeapSize/1048576,h.jsHeapSizeLimit/1048576)}return d},update:function(){n=this.end()},domElement:e,setMode:s}};Us.Panel=function(i,e,t){var s=1/0,n=0,r=Math.round,o=r(window.devicePixelRatio||1),a=80*o,l=48*o,c=3*o,d=2*o,h=3*o,u=15*o,f=74*o,m=30*o,y=document.createElement("canvas");y.width=a,y.height=l,y.style.cssText="width:80px;height:48px";var p=y.getContext("2d");return p.font="bold "+9*o+"px Helvetica,Arial,sans-serif",p.textBaseline="top",p.fillStyle=t,p.fillRect(0,0,a,l),p.fillStyle=e,p.fillText(i,c,d),p.fillRect(h,u,f,m),p.fillStyle=t,p.globalAlpha=.9,p.fillRect(h,u,f,m),{dom:y,update:function(g,v){s=Math.min(s,g),n=Math.max(n,g),p.fillStyle=t,p.globalAlpha=1,p.fillRect(0,0,a,u),p.fillStyle=e,p.fillText(r(g)+" "+i+" ("+r(s)+"-"+r(n)+")",c,d),p.drawImage(y,h+o,u,f-o,m,h,u,f-o,m),p.fillRect(h+f-o,u,o,m),p.fillStyle=t,p.globalAlpha=.9,p.fillRect(h+f-o,u,o,r((1-g/v)*m))}}};const Or={type:"change"},en={type:"start"},Fr={type:"end"},si=new Ko,Nr=new Zn,xc=Math.cos(70*Qn.DEG2RAD);class Sc extends Ui{constructor(e,t){super(),this.object=e,this.domElement=t,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new _,this.cursor=new _,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableDolly=!0,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:qt.ROTATE,MIDDLE:qt.DOLLY,RIGHT:qt.PAN},this.touches={ONE:Wt.ROTATE,TWO:Wt.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return a.phi},this.getAzimuthalAngle=function(){return a.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(S){S.addEventListener("keydown",Zi),this._domElementKeyEvents=S},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",Zi),this._domElementKeyEvents=null},this.saveState=function(){s.target0.copy(s.target),s.position0.copy(s.object.position),s.zoom0=s.object.zoom},this.reset=function(){s.target.copy(s.target0),s.object.position.copy(s.position0),s.object.zoom=s.zoom0,s.object.updateProjectionMatrix(),s.dispatchEvent(Or),s.update(),r=n.NONE},this.update=function(){const S=new _,F=new Vs().setFromUnitVectors(e.up,new _(0,1,0)),G=F.clone().invert(),Q=new _,be=new Vs,ft=new _,De=2*Math.PI;return function(cl=null){const Sr=s.object.position;S.copy(Sr).sub(s.target),S.applyQuaternion(F),a.setFromVector3(S),s.autoRotate&&r===n.NONE&&C(P(cl)),s.enableDamping?(a.theta+=l.theta*s.dampingFactor,a.phi+=l.phi*s.dampingFactor):(a.theta+=l.theta,a.phi+=l.phi);let tt=s.minAzimuthAngle,st=s.maxAzimuthAngle;isFinite(tt)&&isFinite(st)&&(tt<-Math.PI?tt+=De:tt>Math.PI&&(tt-=De),st<-Math.PI?st+=De:st>Math.PI&&(st-=De),tt<=st?a.theta=Math.max(tt,Math.min(st,a.theta)):a.theta=a.theta>(tt+st)/2?Math.max(tt,a.theta):Math.min(st,a.theta)),a.phi=Math.max(s.minPolarAngle,Math.min(s.maxPolarAngle,a.phi)),a.makeSafe(),s.enableDamping===!0?s.target.addScaledVector(d,s.dampingFactor):s.target.add(d),s.target.sub(s.cursor),s.target.clampLength(s.minTargetRadius,s.maxTargetRadius),s.target.add(s.cursor);let Ms=!1;if(s.zoomToCursor&&M||s.object.isOrthographicCamera)a.radius=H(a.radius);else{const it=a.radius;a.radius=H(a.radius*c),Ms=it!=a.radius}if(S.setFromSpherical(a),S.applyQuaternion(G),Sr.copy(s.target).add(S),s.object.lookAt(s.target),s.enableDamping===!0?(l.theta*=1-s.dampingFactor,l.phi*=1-s.dampingFactor,d.multiplyScalar(1-s.dampingFactor)):(l.set(0,0,0),d.set(0,0,0)),s.zoomToCursor&&M){let it=null;if(s.object.isPerspectiveCamera){const _s=S.length();it=H(_s*c);const $s=_s-it;s.object.position.addScaledVector(b,$s),s.object.updateMatrixWorld(),Ms=!!$s}else if(s.object.isOrthographicCamera){const _s=new _(x.x,x.y,0);_s.unproject(s.object);const $s=s.object.zoom;s.object.zoom=Math.max(s.minZoom,Math.min(s.maxZoom,s.object.zoom/c)),s.object.updateProjectionMatrix(),Ms=$s!==s.object.zoom;const Tr=new _(x.x,x.y,0);Tr.unproject(s.object),s.object.position.sub(Tr).add(_s),s.object.updateMatrixWorld(),it=S.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),s.zoomToCursor=!1;it!==null&&(this.screenSpacePanning?s.target.set(0,0,-1).transformDirection(s.object.matrix).multiplyScalar(it).add(s.object.position):(si.origin.copy(s.object.position),si.direction.set(0,0,-1).transformDirection(s.object.matrix),Math.abs(s.object.up.dot(si.direction))<xc?e.lookAt(s.target):(Nr.setFromNormalAndCoplanarPoint(s.object.up,s.target),si.intersectPlane(Nr,s.target))))}else if(s.object.isOrthographicCamera){const it=s.object.zoom;s.object.zoom=Math.max(s.minZoom,Math.min(s.maxZoom,s.object.zoom/c)),it!==s.object.zoom&&(s.object.updateProjectionMatrix(),Ms=!0)}return c=1,M=!1,Ms||Q.distanceToSquared(s.object.position)>o||8*(1-be.dot(s.object.quaternion))>o||ft.distanceToSquared(s.target)>o?(s.dispatchEvent(Or),Q.copy(s.object.position),be.copy(s.object.quaternion),ft.copy(s.target),!0):!1}}(),this.dispose=function(){s.domElement.removeEventListener("contextmenu",wr),s.domElement.removeEventListener("pointerdown",mr),s.domElement.removeEventListener("pointercancel",As),s.domElement.removeEventListener("wheel",gr),s.domElement.removeEventListener("pointermove",$i),s.domElement.removeEventListener("pointerup",As),s.domElement.getRootNode().removeEventListener("keydown",yr,{capture:!0}),s._domElementKeyEvents!==null&&(s._domElementKeyEvents.removeEventListener("keydown",Zi),s._domElementKeyEvents=null)};const s=this,n={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let r=n.NONE;const o=1e-6,a=new Ar,l=new Ar;let c=1;const d=new _,h=new k,u=new k,f=new k,m=new k,y=new k,p=new k,g=new k,v=new k,w=new k,b=new _,x=new k;let M=!1;const A=[],T={};let E=!1;function P(S){return S!==null?2*Math.PI/60*s.autoRotateSpeed*S:2*Math.PI/60/60*s.autoRotateSpeed}function L(S){const F=Math.abs(S*.01);return Math.pow(.95,s.zoomSpeed*F)}function C(S){l.theta-=S}function D(S){l.phi-=S}const R=function(){const S=new _;return function(G,Q){S.setFromMatrixColumn(Q,0),S.multiplyScalar(-G),d.add(S)}}(),O=function(){const S=new _;return function(G,Q){s.screenSpacePanning===!0?S.setFromMatrixColumn(Q,1):(S.setFromMatrixColumn(Q,0),S.crossVectors(s.object.up,S)),S.multiplyScalar(G),d.add(S)}}(),B=function(){const S=new _;return function(G,Q){const be=s.domElement;if(s.object.isPerspectiveCamera){const ft=s.object.position;S.copy(ft).sub(s.target);let De=S.length();De*=Math.tan(s.object.fov/2*Math.PI/180),R(2*G*De/be.clientHeight,s.object.matrix),O(2*Q*De/be.clientHeight,s.object.matrix)}else s.object.isOrthographicCamera?(R(G*(s.object.right-s.object.left)/s.object.zoom/be.clientWidth,s.object.matrix),O(Q*(s.object.top-s.object.bottom)/s.object.zoom/be.clientHeight,s.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),s.enablePan=!1)}}();function W(S){s.object.isPerspectiveCamera||s.object.isOrthographicCamera?c/=S:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),s.enableZoom=!1)}function te(S){s.object.isPerspectiveCamera||s.object.isOrthographicCamera?c*=S:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),s.enableZoom=!1)}function ne(S,F){if(!s.zoomToCursor)return;M=!0;const G=s.domElement.getBoundingClientRect(),Q=S-G.left,be=F-G.top,ft=G.width,De=G.height;x.x=Q/ft*2-1,x.y=-(be/De)*2+1,b.set(x.x,x.y,1).unproject(s.object).sub(s.object.position).normalize()}function H(S){return Math.max(s.minDistance,Math.min(s.maxDistance,S))}function Dt(S){h.set(S.clientX,S.clientY)}function _e(S){ne(S.clientX,S.clientX),g.set(S.clientX,S.clientY)}function Ee(S){m.set(S.clientX,S.clientY)}function dt(S){u.set(S.clientX,S.clientY),f.subVectors(u,h).multiplyScalar(s.rotateSpeed);const F=s.domElement;C(2*Math.PI*f.x/F.clientHeight),D(2*Math.PI*f.y/F.clientHeight),h.copy(u),s.update()}function Es(S){v.set(S.clientX,S.clientY),w.subVectors(v,g),w.y>0?W(L(w.y)):w.y<0&&te(L(w.y)),g.copy(v),s.update()}function It(S){y.set(S.clientX,S.clientY),p.subVectors(y,m).multiplyScalar(s.panSpeed),B(p.x,p.y),m.copy(y),s.update()}function Xi(S){ne(S.clientX,S.clientY),S.deltaY<0?te(L(S.deltaY)):S.deltaY>0&&W(L(S.deltaY)),s.update()}function Yi(S){let F=!1;switch(S.code){case s.keys.UP:S.ctrlKey||S.metaKey||S.shiftKey?D(2*Math.PI*s.rotateSpeed/s.domElement.clientHeight):B(0,s.keyPanSpeed),F=!0;break;case s.keys.BOTTOM:S.ctrlKey||S.metaKey||S.shiftKey?D(-2*Math.PI*s.rotateSpeed/s.domElement.clientHeight):B(0,-s.keyPanSpeed),F=!0;break;case s.keys.LEFT:S.ctrlKey||S.metaKey||S.shiftKey?C(2*Math.PI*s.rotateSpeed/s.domElement.clientHeight):B(s.keyPanSpeed,0),F=!0;break;case s.keys.RIGHT:S.ctrlKey||S.metaKey||S.shiftKey?C(-2*Math.PI*s.rotateSpeed/s.domElement.clientHeight):B(-s.keyPanSpeed,0),F=!0;break}F&&(S.preventDefault(),s.update())}function Ys(S){if(A.length===1)h.set(S.pageX,S.pageY);else{const F=Vt(S),G=.5*(S.pageX+F.x),Q=.5*(S.pageY+F.y);h.set(G,Q)}}function hr(S){if(A.length===1)m.set(S.pageX,S.pageY);else{const F=Vt(S),G=.5*(S.pageX+F.x),Q=.5*(S.pageY+F.y);m.set(G,Q)}}function ur(S){const F=Vt(S),G=S.pageX-F.x,Q=S.pageY-F.y,be=Math.sqrt(G*G+Q*Q);g.set(0,be)}function Qa(S){s.enableZoom&&ur(S),s.enablePan&&hr(S)}function Ja(S){s.enableZoom&&ur(S),s.enableRotate&&Ys(S)}function dr(S){if(A.length==1)u.set(S.pageX,S.pageY);else{const G=Vt(S),Q=.5*(S.pageX+G.x),be=.5*(S.pageY+G.y);u.set(Q,be)}f.subVectors(u,h).multiplyScalar(s.rotateSpeed);const F=s.domElement;C(2*Math.PI*f.x/F.clientHeight),D(2*Math.PI*f.y/F.clientHeight),h.copy(u)}function fr(S){if(A.length===1)y.set(S.pageX,S.pageY);else{const F=Vt(S),G=.5*(S.pageX+F.x),Q=.5*(S.pageY+F.y);y.set(G,Q)}p.subVectors(y,m).multiplyScalar(s.panSpeed),B(p.x,p.y),m.copy(y)}function pr(S){const F=Vt(S),G=S.pageX-F.x,Q=S.pageY-F.y,be=Math.sqrt(G*G+Q*Q);v.set(0,be),w.set(0,Math.pow(v.y/g.y,s.zoomSpeed)),W(w.y),g.copy(v);const ft=(S.pageX+F.x)*.5,De=(S.pageY+F.y)*.5;ne(ft,De)}function el(S){s.enableZoom&&pr(S),s.enablePan&&fr(S)}function tl(S){s.enableZoom&&pr(S),s.enableRotate&&dr(S)}function mr(S){s.enabled!==!1&&(A.length===0&&(s.domElement.setPointerCapture(S.pointerId),s.domElement.addEventListener("pointermove",$i),s.domElement.addEventListener("pointerup",As)),!ll(S)&&(ol(S),S.pointerType==="touch"?br(S):sl(S)))}function $i(S){s.enabled!==!1&&(S.pointerType==="touch"?rl(S):il(S))}function As(S){switch(al(S),A.length){case 0:s.domElement.releasePointerCapture(S.pointerId),s.domElement.removeEventListener("pointermove",$i),s.domElement.removeEventListener("pointerup",As),s.dispatchEvent(Fr),r=n.NONE;break;case 1:const F=A[0],G=T[F];br({pointerId:F,pageX:G.x,pageY:G.y});break}}function sl(S){let F;switch(S.button){case 0:F=s.mouseButtons.LEFT;break;case 1:F=s.mouseButtons.MIDDLE;break;case 2:F=s.mouseButtons.RIGHT;break;default:F=-1}switch(F){case qt.DOLLY:if(s.enableZoom===!1)return;_e(S),r=n.DOLLY;break;case qt.ROTATE:if(S.ctrlKey||S.metaKey||S.shiftKey){if(s.enablePan===!1)return;Ee(S),r=n.PAN}else{if(s.enableRotate===!1)return;Dt(S),r=n.ROTATE}break;case qt.PAN:if(S.ctrlKey||S.metaKey||S.shiftKey){if(s.enableRotate===!1)return;Dt(S),r=n.ROTATE}else{if(s.enablePan===!1)return;Ee(S),r=n.PAN}break;default:r=n.NONE}r!==n.NONE&&s.dispatchEvent(en)}function il(S){switch(r){case n.ROTATE:if(s.enableRotate===!1)return;dt(S);break;case n.DOLLY:if(s.enableDolly===!1)return;Es(S);break;case n.PAN:if(s.enablePan===!1)return;It(S);break}}function gr(S){s.enabled===!1||s.enableZoom===!1||r!==n.NONE||(S.preventDefault(),s.dispatchEvent(en),Xi(nl(S)),s.dispatchEvent(Fr))}function nl(S){const F=S.deltaMode,G={clientX:S.clientX,clientY:S.clientY,deltaY:S.deltaY};switch(F){case 1:G.deltaY*=16;break;case 2:G.deltaY*=100;break}return S.ctrlKey&&!E&&(G.deltaY*=10),G}function yr(S){S.key==="Control"&&(E=!0,s.domElement.getRootNode().addEventListener("keyup",vr,{passive:!0,capture:!0}))}function vr(S){S.key==="Control"&&(E=!1,s.domElement.getRootNode().removeEventListener("keyup",vr,{passive:!0,capture:!0}))}function Zi(S){s.enabled===!1||s.enablePan===!1||Yi(S)}function br(S){switch(xr(S),A.length){case 1:switch(s.touches.ONE){case Wt.ROTATE:if(s.enableRotate===!1)return;Ys(S),r=n.TOUCH_ROTATE;break;case Wt.PAN:if(s.enablePan===!1)return;hr(S),r=n.TOUCH_PAN;break;default:r=n.NONE}break;case 2:switch(s.touches.TWO){case Wt.DOLLY_PAN:if(s.enableZoom===!1&&s.enablePan===!1)return;Qa(S),r=n.TOUCH_DOLLY_PAN;break;case Wt.DOLLY_ROTATE:if(s.enableZoom===!1&&s.enableRotate===!1)return;Ja(S),r=n.TOUCH_DOLLY_ROTATE;break;default:r=n.NONE}break;default:r=n.NONE}r!==n.NONE&&s.dispatchEvent(en)}function rl(S){switch(xr(S),r){case n.TOUCH_ROTATE:if(s.enableRotate===!1)return;dr(S),s.update();break;case n.TOUCH_PAN:if(s.enablePan===!1)return;fr(S),s.update();break;case n.TOUCH_DOLLY_PAN:if(s.enableZoom===!1&&s.enablePan===!1)return;el(S),s.update();break;case n.TOUCH_DOLLY_ROTATE:if(s.enableZoom===!1&&s.enableRotate===!1)return;tl(S),s.update();break;default:r=n.NONE}}function wr(S){s.enabled!==!1&&S.preventDefault()}function ol(S){A.push(S.pointerId)}function al(S){delete T[S.pointerId];for(let F=0;F<A.length;F++)if(A[F]==S.pointerId){A.splice(F,1);return}}function ll(S){for(let F=0;F<A.length;F++)if(A[F]==S.pointerId)return!0;return!1}function xr(S){let F=T[S.pointerId];F===void 0&&(F=new k,T[S.pointerId]=F),F.set(S.pageX,S.pageY)}function Vt(S){const F=S.pointerId===A[0]?A[1]:A[0];return T[F]}s.domElement.addEventListener("contextmenu",wr),s.domElement.addEventListener("pointerdown",mr),s.domElement.addEventListener("pointercancel",As),s.domElement.addEventListener("wheel",gr,{passive:!1}),s.domElement.getRootNode().addEventListener("keydown",yr,{passive:!0,capture:!0}),this.update()}}/**
 * postprocessing v6.37.2 build Fri Mar 28 2025
 * https://github.com/pmndrs/postprocessing
 * Copyright 2015-2025 Raoul van Rüschen
 * @license Zlib
 */var tn=1/1e3,Tc=1e3,Ec=class{constructor(){this.startTime=performance.now(),this.previousTime=0,this.currentTime=0,this._delta=0,this._elapsed=0,this._fixedDelta=1e3/60,this.timescale=1,this.useFixedDelta=!1,this._autoReset=!1}get autoReset(){return this._autoReset}set autoReset(i){typeof document<"u"&&document.hidden!==void 0&&(i?document.addEventListener("visibilitychange",this):document.removeEventListener("visibilitychange",this),this._autoReset=i)}get delta(){return this._delta*tn}get fixedDelta(){return this._fixedDelta*tn}set fixedDelta(i){this._fixedDelta=i*Tc}get elapsed(){return this._elapsed*tn}update(i){this.useFixedDelta?this._delta=this.fixedDelta:(this.previousTime=this.currentTime,this.currentTime=(i!==void 0?i:performance.now())-this.startTime,this._delta=this.currentTime-this.previousTime),this._delta*=this.timescale,this._elapsed+=this._delta}reset(){this._delta=0,this._elapsed=0,this.currentTime=performance.now()-this.startTime}getDelta(){return this.delta}getElapsed(){return this.elapsed}handleEvent(i){document.hidden||(this.currentTime=performance.now()-this.startTime)}dispose(){this.autoReset=!1}},Ac=(()=>{const i=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),e=new Float32Array([0,0,2,0,0,2]),t=new _t;return t.setAttribute("position",new se(i,3)),t.setAttribute("uv",new se(e,2)),t})(),Le=class Bn{static get fullscreenGeometry(){return Ac}constructor(e="Pass",t=new ms,s=new Yo){this.name=e,this.renderer=null,this.scene=t,this.camera=s,this.screen=null,this.rtt=!0,this.needsSwap=!0,this.needsDepthTexture=!1,this.enabled=!0}get renderToScreen(){return!this.rtt}set renderToScreen(e){if(this.rtt===e){const t=this.fullscreenMaterial;t!==null&&(t.needsUpdate=!0),this.rtt=!e}}set mainScene(e){}set mainCamera(e){}setRenderer(e){this.renderer=e}isEnabled(){return this.enabled}setEnabled(e){this.enabled=e}get fullscreenMaterial(){return this.screen!==null?this.screen.material:null}set fullscreenMaterial(e){let t=this.screen;t!==null?t.material=e:(t=new me(Bn.fullscreenGeometry,e),t.frustumCulled=!1,this.scene===null&&(this.scene=new ms),this.scene.add(t),this.screen=t)}getFullscreenMaterial(){return this.fullscreenMaterial}setFullscreenMaterial(e){this.fullscreenMaterial=e}getDepthTexture(){return null}setDepthTexture(e,t=Gt){}render(e,t,s,n,r){throw new Error("Render method not implemented!")}setSize(e,t){}initialize(e,t,s){}dispose(){for(const e of Object.keys(this)){const t=this[e];(t instanceof ze||t instanceof os||t instanceof gs||t instanceof Bn)&&this[e].dispose()}this.fullscreenMaterial!==null&&this.fullscreenMaterial.dispose()}},Mc=class extends Le{constructor(){super("ClearMaskPass",null,null),this.needsSwap=!1}render(i,e,t,s,n){const r=i.state.buffers.stencil;r.setLocked(!1),r.setTest(!1)}},_c=`#include <common>
#include <dithering_pars_fragment>
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
uniform float opacity;varying vec2 vUv;void main(){vec4 texel=texture2D(inputBuffer,vUv);gl_FragColor=opacity*texel;
#include <colorspace_fragment>
#include <dithering_fragment>
}`,ir="varying vec2 vUv;void main(){vUv=position.xy*0.5+0.5;gl_Position=vec4(position.xy,1.0,1.0);}",da=class extends Me{constructor(){super({name:"CopyMaterial",uniforms:{inputBuffer:new U(null),opacity:new U(1)},blending:ut,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:_c,vertexShader:ir})}set inputBuffer(i){this.uniforms.inputBuffer.value=i}setInputBuffer(i){this.uniforms.inputBuffer.value=i}getOpacity(i){return this.uniforms.opacity.value}setOpacity(i){this.uniforms.opacity.value=i}},Cc=class extends Le{constructor(i,e=!0){super("CopyPass"),this.fullscreenMaterial=new da,this.needsSwap=!1,this.renderTarget=i,i===void 0&&(this.renderTarget=new ze(1,1,{minFilter:Mt,magFilter:Mt,stencilBuffer:!1,depthBuffer:!1}),this.renderTarget.texture.name="CopyPass.Target"),this.autoResize=e}get resize(){return this.autoResize}set resize(i){this.autoResize=i}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}setAutoResizeEnabled(i){this.autoResize=i}render(i,e,t,s,n){this.fullscreenMaterial.inputBuffer=e.texture,i.setRenderTarget(this.renderToScreen?null:this.renderTarget),i.render(this.scene,this.camera)}setSize(i,e){this.autoResize&&this.renderTarget.setSize(i,e)}initialize(i,e,t){t!==void 0&&(this.renderTarget.texture.type=t,t!==ct?this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1":i!==null&&i.outputColorSpace===q&&(this.renderTarget.texture.colorSpace=q))}},kr=new Z,Gi=class extends Le{constructor(i=!0,e=!0,t=!1){super("ClearPass",null,null),this.needsSwap=!1,this.color=i,this.depth=e,this.stencil=t,this.overrideClearColor=null,this.overrideClearAlpha=-1}setClearFlags(i,e,t){this.color=i,this.depth=e,this.stencil=t}getOverrideClearColor(){return this.overrideClearColor}setOverrideClearColor(i){this.overrideClearColor=i}getOverrideClearAlpha(){return this.overrideClearAlpha}setOverrideClearAlpha(i){this.overrideClearAlpha=i}render(i,e,t,s,n){const r=this.overrideClearColor,o=this.overrideClearAlpha,a=i.getClearAlpha(),l=r!==null,c=o>=0;l?(i.getClearColor(kr),i.setClearColor(r,c?o:a)):c&&i.setClearAlpha(o),i.setRenderTarget(this.renderToScreen?null:e),i.clear(this.color,this.depth,this.stencil),l?i.setClearColor(kr,a):c&&i.setClearAlpha(a)}},Pc=class extends Le{constructor(i,e){super("MaskPass",i,e),this.needsSwap=!1,this.clearPass=new Gi(!1,!1,!0),this.inverse=!1}set mainScene(i){this.scene=i}set mainCamera(i){this.camera=i}get inverted(){return this.inverse}set inverted(i){this.inverse=i}get clear(){return this.clearPass.enabled}set clear(i){this.clearPass.enabled=i}getClearPass(){return this.clearPass}isInverted(){return this.inverted}setInverted(i){this.inverted=i}render(i,e,t,s,n){const r=i.getContext(),o=i.state.buffers,a=this.scene,l=this.camera,c=this.clearPass,d=this.inverted?0:1,h=1-d;o.color.setMask(!1),o.depth.setMask(!1),o.color.setLocked(!0),o.depth.setLocked(!0),o.stencil.setTest(!0),o.stencil.setOp(r.REPLACE,r.REPLACE,r.REPLACE),o.stencil.setFunc(r.ALWAYS,d,4294967295),o.stencil.setClear(h),o.stencil.setLocked(!0),this.clearPass.enabled&&(this.renderToScreen?c.render(i,null):(c.render(i,e),c.render(i,t))),this.renderToScreen?(i.setRenderTarget(null),i.render(a,l)):(i.setRenderTarget(e),i.render(a,l),i.setRenderTarget(t),i.render(a,l)),o.color.setLocked(!1),o.depth.setLocked(!1),o.stencil.setLocked(!1),o.stencil.setFunc(r.EQUAL,1,4294967295),o.stencil.setOp(r.KEEP,r.KEEP,r.KEEP),o.stencil.setLocked(!0)}},Rc=class{constructor(i=null,{depthBuffer:e=!0,stencilBuffer:t=!1,multisampling:s=0,frameBufferType:n}={}){this.renderer=null,this.inputBuffer=this.createBuffer(e,t,n,s),this.outputBuffer=this.inputBuffer.clone(),this.copyPass=new Cc,this.depthTexture=null,this.passes=[],this.timer=new Ec,this.autoRenderToScreen=!0,this.setRenderer(i)}get multisampling(){return this.inputBuffer.samples||0}set multisampling(i){const e=this.inputBuffer,t=this.multisampling;t>0&&i>0?(this.inputBuffer.samples=i,this.outputBuffer.samples=i,this.inputBuffer.dispose(),this.outputBuffer.dispose()):t!==i&&(this.inputBuffer.dispose(),this.outputBuffer.dispose(),this.inputBuffer=this.createBuffer(e.depthBuffer,e.stencilBuffer,e.texture.type,i),this.inputBuffer.depthTexture=this.depthTexture,this.outputBuffer=this.inputBuffer.clone())}getTimer(){return this.timer}getRenderer(){return this.renderer}setRenderer(i){if(this.renderer=i,i!==null){const e=i.getSize(new k),t=i.getContext().getContextAttributes().alpha,s=this.inputBuffer.texture.type;s===ct&&i.outputColorSpace===q&&(this.inputBuffer.texture.colorSpace=q,this.outputBuffer.texture.colorSpace=q,this.inputBuffer.dispose(),this.outputBuffer.dispose()),i.autoClear=!1,this.setSize(e.width,e.height);for(const n of this.passes)n.initialize(i,t,s)}}replaceRenderer(i,e=!0){const t=this.renderer,s=t.domElement.parentNode;return this.setRenderer(i),e&&s!==null&&(s.removeChild(t.domElement),s.appendChild(i.domElement)),t}createDepthTexture(){const i=this.depthTexture=new dl;return this.inputBuffer.depthTexture=i,this.inputBuffer.dispose(),this.inputBuffer.stencilBuffer?(i.format=fl,i.type=pl):i.type=ml,i}deleteDepthTexture(){if(this.depthTexture!==null){this.depthTexture.dispose(),this.depthTexture=null,this.inputBuffer.depthTexture=null,this.inputBuffer.dispose();for(const i of this.passes)i.setDepthTexture(null)}}createBuffer(i,e,t,s){const n=this.renderer,r=n===null?new k:n.getDrawingBufferSize(new k),o={minFilter:Mt,magFilter:Mt,stencilBuffer:e,depthBuffer:i,type:t},a=new ze(r.width,r.height,o);return s>0&&(a.ignoreDepthForMultisampleCopy=!1,a.samples=s),t===ct&&n!==null&&n.outputColorSpace===q&&(a.texture.colorSpace=q),a.texture.name="EffectComposer.Buffer",a.texture.generateMipmaps=!1,a}setMainScene(i){for(const e of this.passes)e.mainScene=i}setMainCamera(i){for(const e of this.passes)e.mainCamera=i}addPass(i,e){const t=this.passes,s=this.renderer,n=s.getDrawingBufferSize(new k),r=s.getContext().getContextAttributes().alpha,o=this.inputBuffer.texture.type;if(i.setRenderer(s),i.setSize(n.width,n.height),i.initialize(s,r,o),this.autoRenderToScreen&&(t.length>0&&(t[t.length-1].renderToScreen=!1),i.renderToScreen&&(this.autoRenderToScreen=!1)),e!==void 0?t.splice(e,0,i):t.push(i),this.autoRenderToScreen&&(t[t.length-1].renderToScreen=!0),i.needsDepthTexture||this.depthTexture!==null)if(this.depthTexture===null){const a=this.createDepthTexture();for(i of t)i.setDepthTexture(a)}else i.setDepthTexture(this.depthTexture)}removePass(i){const e=this.passes,t=e.indexOf(i);if(t!==-1&&e.splice(t,1).length>0){if(this.depthTexture!==null){const r=(a,l)=>a||l.needsDepthTexture;e.reduce(r,!1)||(i.getDepthTexture()===this.depthTexture&&i.setDepthTexture(null),this.deleteDepthTexture())}this.autoRenderToScreen&&t===e.length&&(i.renderToScreen=!1,e.length>0&&(e[e.length-1].renderToScreen=!0))}}removeAllPasses(){const i=this.passes;this.deleteDepthTexture(),i.length>0&&(this.autoRenderToScreen&&(i[i.length-1].renderToScreen=!1),this.passes=[])}render(i){const e=this.renderer,t=this.copyPass;let s=this.inputBuffer,n=this.outputBuffer,r=!1,o,a,l;i===void 0&&(this.timer.update(),i=this.timer.getDelta());for(const c of this.passes)c.enabled&&(c.render(e,s,n,i,r),c.needsSwap&&(r&&(t.renderToScreen=c.renderToScreen,o=e.getContext(),a=e.state.buffers.stencil,a.setFunc(o.NOTEQUAL,1,4294967295),t.render(e,s,n,i,r),a.setFunc(o.EQUAL,1,4294967295)),l=s,s=n,n=l),c instanceof Pc?r=!0:c instanceof Mc&&(r=!1))}setSize(i,e,t){const s=this.renderer,n=s.getSize(new k);(i===void 0||e===void 0)&&(i=n.width,e=n.height),(n.width!==i||n.height!==e)&&s.setSize(i,e,t);const r=s.getDrawingBufferSize(new k);this.inputBuffer.setSize(r.width,r.height),this.outputBuffer.setSize(r.width,r.height);for(const o of this.passes)o.setSize(r.width,r.height)}reset(){this.dispose(),this.autoRenderToScreen=!0}dispose(){for(const i of this.passes)i.dispose();this.passes=[],this.inputBuffer!==null&&this.inputBuffer.dispose(),this.outputBuffer!==null&&this.outputBuffer.dispose(),this.deleteDepthTexture(),this.copyPass.dispose(),this.timer.dispose(),Le.fullscreenGeometry.dispose()}},At={NONE:0,DEPTH:1,CONVOLUTION:2},K={FRAGMENT_HEAD:"FRAGMENT_HEAD",FRAGMENT_MAIN_UV:"FRAGMENT_MAIN_UV",FRAGMENT_MAIN_IMAGE:"FRAGMENT_MAIN_IMAGE",VERTEX_HEAD:"VERTEX_HEAD",VERTEX_MAIN_SUPPORT:"VERTEX_MAIN_SUPPORT"},Lc=class{constructor(){this.shaderParts=new Map([[K.FRAGMENT_HEAD,null],[K.FRAGMENT_MAIN_UV,null],[K.FRAGMENT_MAIN_IMAGE,null],[K.VERTEX_HEAD,null],[K.VERTEX_MAIN_SUPPORT,null]]),this.defines=new Map,this.uniforms=new Map,this.blendModes=new Map,this.extensions=new Set,this.attributes=At.NONE,this.varyings=new Set,this.uvTransformation=!1,this.readDepth=!1,this.colorSpace=He}},sn=!1,Ur=class{constructor(i=null){this.originalMaterials=new Map,this.material=null,this.materials=null,this.materialsBackSide=null,this.materialsDoubleSide=null,this.materialsFlatShaded=null,this.materialsFlatShadedBackSide=null,this.materialsFlatShadedDoubleSide=null,this.setMaterial(i),this.meshCount=0,this.replaceMaterial=e=>{if(e.isMesh){let t;if(e.material.flatShading)switch(e.material.side){case je:t=this.materialsFlatShadedDoubleSide;break;case Os:t=this.materialsFlatShadedBackSide;break;default:t=this.materialsFlatShaded;break}else switch(e.material.side){case je:t=this.materialsDoubleSide;break;case Os:t=this.materialsBackSide;break;default:t=this.materials;break}this.originalMaterials.set(e,e.material),e.isSkinnedMesh?e.material=t[2]:e.isInstancedMesh?e.material=t[1]:e.material=t[0],++this.meshCount}}}cloneMaterial(i){if(!(i instanceof Me))return i.clone();const e=i.uniforms,t=new Map;for(const n in e){const r=e[n].value;r.isRenderTargetTexture&&(e[n].value=null,t.set(n,r))}const s=i.clone();for(const n of t)e[n[0]].value=n[1],s.uniforms[n[0]].value=n[1];return s}setMaterial(i){if(this.disposeMaterials(),this.material=i,i!==null){const e=this.materials=[this.cloneMaterial(i),this.cloneMaterial(i),this.cloneMaterial(i)];for(const t of e)t.uniforms=Object.assign({},i.uniforms),t.side=Pi;e[2].skinning=!0,this.materialsBackSide=e.map(t=>{const s=this.cloneMaterial(t);return s.uniforms=Object.assign({},i.uniforms),s.side=Os,s}),this.materialsDoubleSide=e.map(t=>{const s=this.cloneMaterial(t);return s.uniforms=Object.assign({},i.uniforms),s.side=je,s}),this.materialsFlatShaded=e.map(t=>{const s=this.cloneMaterial(t);return s.uniforms=Object.assign({},i.uniforms),s.flatShading=!0,s}),this.materialsFlatShadedBackSide=e.map(t=>{const s=this.cloneMaterial(t);return s.uniforms=Object.assign({},i.uniforms),s.flatShading=!0,s.side=Os,s}),this.materialsFlatShadedDoubleSide=e.map(t=>{const s=this.cloneMaterial(t);return s.uniforms=Object.assign({},i.uniforms),s.flatShading=!0,s.side=je,s})}}render(i,e,t){const s=i.shadowMap.enabled;if(i.shadowMap.enabled=!1,sn){const n=this.originalMaterials;this.meshCount=0,e.traverse(this.replaceMaterial),i.render(e,t);for(const r of n)r[0].material=r[1];this.meshCount!==n.size&&n.clear()}else{const n=e.overrideMaterial;e.overrideMaterial=this.material,i.render(e,t),e.overrideMaterial=n}i.shadowMap.enabled=s}disposeMaterials(){if(this.material!==null){const i=this.materials.concat(this.materialsBackSide).concat(this.materialsDoubleSide).concat(this.materialsFlatShaded).concat(this.materialsFlatShadedBackSide).concat(this.materialsFlatShadedDoubleSide);for(const e of i)e.dispose()}}dispose(){this.originalMaterials.clear(),this.disposeMaterials()}static get workaroundEnabled(){return sn}static set workaroundEnabled(i){sn=i}},pt=-1,Se=class extends Ui{constructor(i,e=pt,t=pt,s=1){super(),this.resizable=i,this.baseSize=new k(1,1),this.preferredSize=new k(e,t),this.target=this.preferredSize,this.s=s,this.effectiveSize=new k,this.addEventListener("change",()=>this.updateEffectiveSize()),this.updateEffectiveSize()}updateEffectiveSize(){const i=this.baseSize,e=this.preferredSize,t=this.effectiveSize,s=this.scale;e.width!==pt?t.width=e.width:e.height!==pt?t.width=Math.round(e.height*(i.width/Math.max(i.height,1))):t.width=Math.round(i.width*s),e.height!==pt?t.height=e.height:e.width!==pt?t.height=Math.round(e.width/Math.max(i.width/Math.max(i.height,1),1)):t.height=Math.round(i.height*s)}get width(){return this.effectiveSize.width}set width(i){this.preferredWidth=i}get height(){return this.effectiveSize.height}set height(i){this.preferredHeight=i}getWidth(){return this.width}getHeight(){return this.height}get scale(){return this.s}set scale(i){this.s!==i&&(this.s=i,this.preferredSize.setScalar(pt),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getScale(){return this.scale}setScale(i){this.scale=i}get baseWidth(){return this.baseSize.width}set baseWidth(i){this.baseSize.width!==i&&(this.baseSize.width=i,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getBaseWidth(){return this.baseWidth}setBaseWidth(i){this.baseWidth=i}get baseHeight(){return this.baseSize.height}set baseHeight(i){this.baseSize.height!==i&&(this.baseSize.height=i,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getBaseHeight(){return this.baseHeight}setBaseHeight(i){this.baseHeight=i}setBaseSize(i,e){(this.baseSize.width!==i||this.baseSize.height!==e)&&(this.baseSize.set(i,e),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}get preferredWidth(){return this.preferredSize.width}set preferredWidth(i){this.preferredSize.width!==i&&(this.preferredSize.width=i,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getPreferredWidth(){return this.preferredWidth}setPreferredWidth(i){this.preferredWidth=i}get preferredHeight(){return this.preferredSize.height}set preferredHeight(i){this.preferredSize.height!==i&&(this.preferredSize.height=i,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getPreferredHeight(){return this.preferredHeight}setPreferredHeight(i){this.preferredHeight=i}setPreferredSize(i,e){(this.preferredSize.width!==i||this.preferredSize.height!==e)&&(this.preferredSize.set(i,e),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}copy(i){this.s=i.scale,this.baseSize.set(i.baseWidth,i.baseHeight),this.preferredSize.set(i.preferredWidth,i.preferredHeight),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height)}static get AUTO_SIZE(){return pt}},Dc=class{constructor(i=0){this.nextId=i}getNextId(){return this.nextId++}reset(i=0){return this.nextId=i,this}},nn=new Dc(2),fa=class extends Set{constructor(i,e=nn.getNextId()){super(),this.exclusive=!1,this._layer=e,(this._layer<1||this._layer>31)&&(console.warn("Layer out of range, resetting to 2"),nn.reset(2),this._layer=nn.getNextId()),i!==void 0&&this.set(i)}get layer(){return this._layer}set layer(i){const e=this._layer;for(const t of this)t.layers.disable(e),t.layers.enable(i);this._layer=i}getLayer(){return this.layer}setLayer(i){this.layer=i}isExclusive(){return this.exclusive}setExclusive(i){this.exclusive=i}clear(){const i=this.layer;for(const e of this)e.layers.disable(i);return super.clear()}set(i){this.clear();for(const e of i)this.add(e);return this}indexOf(i){return this.has(i)?0:-1}add(i){return this.exclusive?i.layers.set(this.layer):i.layers.enable(this.layer),super.add(i)}delete(i){return this.has(i)&&i.layers.disable(this.layer),super.delete(i)}toggle(i){let e;return this.has(i)?(this.delete(i),e=!1):(this.add(i),e=!0),e}setVisible(i){for(const e of this)i?e.layers.enable(0):e.layers.disable(0);return this}},z={ADD:0,ALPHA:1,AVERAGE:2,COLOR:3,COLOR_BURN:4,COLOR_DODGE:5,DARKEN:6,DIFFERENCE:7,DIVIDE:8,DST:9,EXCLUSION:10,HARD_LIGHT:11,HARD_MIX:12,HUE:13,INVERT:14,INVERT_RGB:15,LIGHTEN:16,LINEAR_BURN:17,LINEAR_DODGE:18,LINEAR_LIGHT:19,LUMINOSITY:20,MULTIPLY:21,NEGATION:22,NORMAL:23,OVERLAY:24,PIN_LIGHT:25,REFLECT:26,SATURATION:27,SCREEN:28,SOFT_LIGHT:29,SRC:30,SUBTRACT:31,VIVID_LIGHT:32},Ic="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,x+y,opacity);}",Bc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,y,min(y.a,opacity));}",Oc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,(x+y)*0.5,opacity);}",Fc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(yHSL.rg,xHSL.b));return vec4(mix(x.rgb,z,opacity),y.a);}",Nc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=mix(step(0.0,y)*(1.0-min(vec4(1.0),(1.0-x)/y)),vec4(1.0),step(1.0,x));return mix(x,z,opacity);}",kc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=step(0.0,x)*mix(min(vec4(1.0),x/max(1.0-y,1e-9)),vec4(1.0),step(1.0,y));return mix(x,z,opacity);}",Uc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,min(x,y),opacity);}",zc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,abs(x-y),opacity);}",Hc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,x/max(y,1e-12),opacity);}",Gc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,(x+y-2.0*x*y),opacity);}",jc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 a=min(x,1.0),b=min(y,1.0);vec4 z=mix(2.0*a*b,1.0-2.0*(1.0-a)*(1.0-b),step(0.5,y));return mix(x,z,opacity);}",Vc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,step(1.0,x+y),opacity);}",qc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(yHSL.r,xHSL.gb));return vec4(mix(x.rgb,z,opacity),y.a);}",Wc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,1.0-y,opacity);}",Kc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,y*(1.0-x),opacity);}",Xc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,max(x,y),opacity);}",Yc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,clamp(y+x-1.0,0.0,1.0),opacity);}",$c="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,min(x+y,1.0),opacity);}",Zc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,clamp(2.0*y+x-1.0,0.0,1.0),opacity);}",Qc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(xHSL.rg,yHSL.b));return vec4(mix(x.rgb,z,opacity),y.a);}",Jc="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,x*y,opacity);}",eh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,1.0-abs(1.0-x-y),opacity);}",th="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,y,opacity);}",sh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=mix(2.0*y*x,1.0-2.0*(1.0-y)*(1.0-x),step(0.5,x));return mix(x,z,opacity);}",ih="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 y2=2.0*y;vec4 z=mix(mix(y2,x,step(0.5*x,y)),max(vec4(0.0),y2-1.0),step(x,(y2-1.0)));return mix(x,z,opacity);}",nh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=mix(min(x*x/max(1.0-y,1e-12),1.0),y,step(1.0,y));return mix(x,z,opacity);}",rh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec3 xHSL=RGBToHSL(x.rgb);vec3 yHSL=RGBToHSL(y.rgb);vec3 z=HSLToRGB(vec3(xHSL.r,yHSL.g,xHSL.b));return vec4(mix(x.rgb,z,opacity),y.a);}",oh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,x+y-min(x*y,1.0),opacity);}",ah="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 y2=2.0*y;vec4 w=step(0.5,y);vec4 z=mix(x-(1.0-y2)*x*(1.0-x),mix(x+(y2-1.0)*(sqrt(x)-x),x+(y2-1.0)*x*((16.0*x-12.0)*x+3.0),w*(1.0-step(0.25,x))),w);return mix(x,z,opacity);}",lh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return y;}",ch="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){return mix(x,max(x+y-1.0,0.0),opacity);}",hh="vec4 blend(const in vec4 x,const in vec4 y,const in float opacity){vec4 z=mix(max(1.0-min((1.0-x)/(2.0*y),1.0),0.0),min(x/(2.0*(1.0-y)),1.0),step(0.5,y));return mix(x,z,opacity);}",uh=new Map([[z.ADD,Ic],[z.ALPHA,Bc],[z.AVERAGE,Oc],[z.COLOR,Fc],[z.COLOR_BURN,Nc],[z.COLOR_DODGE,kc],[z.DARKEN,Uc],[z.DIFFERENCE,zc],[z.DIVIDE,Hc],[z.DST,null],[z.EXCLUSION,Gc],[z.HARD_LIGHT,jc],[z.HARD_MIX,Vc],[z.HUE,qc],[z.INVERT,Wc],[z.INVERT_RGB,Kc],[z.LIGHTEN,Xc],[z.LINEAR_BURN,Yc],[z.LINEAR_DODGE,$c],[z.LINEAR_LIGHT,Zc],[z.LUMINOSITY,Qc],[z.MULTIPLY,Jc],[z.NEGATION,eh],[z.NORMAL,th],[z.OVERLAY,sh],[z.PIN_LIGHT,ih],[z.REFLECT,nh],[z.SATURATION,rh],[z.SCREEN,oh],[z.SOFT_LIGHT,ah],[z.SRC,lh],[z.SUBTRACT,ch],[z.VIVID_LIGHT,hh]]),dh=class extends Ui{constructor(i,e=1){super(),this._blendFunction=i,this.opacity=new U(e)}getOpacity(){return this.opacity.value}setOpacity(i){this.opacity.value=i}get blendFunction(){return this._blendFunction}set blendFunction(i){this._blendFunction=i,this.dispatchEvent({type:"change"})}getBlendFunction(){return this.blendFunction}setBlendFunction(i){this.blendFunction=i}getShaderCode(){return uh.get(this.blendFunction)}},ji=class extends Ui{constructor(i,e,{attributes:t=At.NONE,blendFunction:s=z.NORMAL,defines:n=new Map,uniforms:r=new Map,extensions:o=null,vertexShader:a=null}={}){super(),this.name=i,this.renderer=null,this.attributes=t,this.fragmentShader=e,this.vertexShader=a,this.defines=n,this.uniforms=r,this.extensions=o,this.blendMode=new dh(s),this.blendMode.addEventListener("change",l=>this.setChanged()),this._inputColorSpace=He,this._outputColorSpace=$o}get inputColorSpace(){return this._inputColorSpace}set inputColorSpace(i){this._inputColorSpace=i,this.setChanged()}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(i){this._outputColorSpace=i,this.setChanged()}set mainScene(i){}set mainCamera(i){}getName(){return this.name}setRenderer(i){this.renderer=i}getDefines(){return this.defines}getUniforms(){return this.uniforms}getExtensions(){return this.extensions}getBlendMode(){return this.blendMode}getAttributes(){return this.attributes}setAttributes(i){this.attributes=i,this.setChanged()}getFragmentShader(){return this.fragmentShader}setFragmentShader(i){this.fragmentShader=i,this.setChanged()}getVertexShader(){return this.vertexShader}setVertexShader(i){this.vertexShader=i,this.setChanged()}setChanged(){this.dispatchEvent({type:"change"})}setDepthTexture(i,e=Gt){}update(i,e,t){}setSize(i,e){}initialize(i,e,t){}dispose(){for(const i of Object.keys(this)){const e=this[i];(e instanceof ze||e instanceof os||e instanceof gs||e instanceof Le)&&this[i].dispose()}}},Vi={VERY_SMALL:0,MEDIUM:2,LARGE:3},fh=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec4 sum=texture2D(inputBuffer,vUv0);sum+=texture2D(inputBuffer,vUv1);sum+=texture2D(inputBuffer,vUv2);sum+=texture2D(inputBuffer,vUv3);gl_FragColor=sum*0.25;
#include <colorspace_fragment>
}`,ph="uniform vec4 texelSize;uniform float kernel;uniform float scale;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vec2 dUv=(texelSize.xy*vec2(kernel)+texelSize.zw)*scale;vUv0=vec2(uv.x-dUv.x,uv.y+dUv.y);vUv1=vec2(uv.x+dUv.x,uv.y+dUv.y);vUv2=vec2(uv.x+dUv.x,uv.y-dUv.y);vUv3=vec2(uv.x-dUv.x,uv.y-dUv.y);gl_Position=vec4(position.xy,1.0,1.0);}",mh=[new Float32Array([0,0]),new Float32Array([0,1,1]),new Float32Array([0,1,1,2]),new Float32Array([0,1,2,2,3]),new Float32Array([0,1,2,3,4,4,5]),new Float32Array([0,1,2,3,4,5,7,8,9,10])],gh=class extends Me{constructor(i=new Ct){super({name:"KawaseBlurMaterial",uniforms:{inputBuffer:new U(null),texelSize:new U(new Ct),scale:new U(1),kernel:new U(0)},blending:ut,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:fh,vertexShader:ph}),this.setTexelSize(i.x,i.y),this.kernelSize=Vi.MEDIUM}set inputBuffer(i){this.uniforms.inputBuffer.value=i}setInputBuffer(i){this.inputBuffer=i}get kernelSequence(){return mh[this.kernelSize]}get scale(){return this.uniforms.scale.value}set scale(i){this.uniforms.scale.value=i}getScale(){return this.uniforms.scale.value}setScale(i){this.uniforms.scale.value=i}getKernel(){return null}get kernel(){return this.uniforms.kernel.value}set kernel(i){this.uniforms.kernel.value=i}setKernel(i){this.kernel=i}setTexelSize(i,e){this.uniforms.texelSize.value.set(i,e,i*.5,e*.5)}setSize(i,e){const t=1/i,s=1/e;this.uniforms.texelSize.value.set(t,s,t*.5,s*.5)}},pa=class extends Le{constructor({kernelSize:i=Vi.MEDIUM,resolutionScale:e=.5,width:t=Se.AUTO_SIZE,height:s=Se.AUTO_SIZE,resolutionX:n=t,resolutionY:r=s}={}){super("KawaseBlurPass"),this.renderTargetA=new ze(1,1,{depthBuffer:!1}),this.renderTargetA.texture.name="Blur.Target.A",this.renderTargetB=this.renderTargetA.clone(),this.renderTargetB.texture.name="Blur.Target.B";const o=this.resolution=new Se(this,n,r,e);o.addEventListener("change",a=>this.setSize(o.baseWidth,o.baseHeight)),this._blurMaterial=new gh,this._blurMaterial.kernelSize=i,this.copyMaterial=new da}getResolution(){return this.resolution}get blurMaterial(){return this._blurMaterial}set blurMaterial(i){this._blurMaterial=i}get dithering(){return this.copyMaterial.dithering}set dithering(i){this.copyMaterial.dithering=i}get kernelSize(){return this.blurMaterial.kernelSize}set kernelSize(i){this.blurMaterial.kernelSize=i}get width(){return this.resolution.width}set width(i){this.resolution.preferredWidth=i}get height(){return this.resolution.height}set height(i){this.resolution.preferredHeight=i}get scale(){return this.blurMaterial.scale}set scale(i){this.blurMaterial.scale=i}getScale(){return this.blurMaterial.scale}setScale(i){this.blurMaterial.scale=i}getKernelSize(){return this.kernelSize}setKernelSize(i){this.kernelSize=i}getResolutionScale(){return this.resolution.scale}setResolutionScale(i){this.resolution.scale=i}render(i,e,t,s,n){const r=this.scene,o=this.camera,a=this.renderTargetA,l=this.renderTargetB,c=this.blurMaterial,d=c.kernelSequence;let h=e;this.fullscreenMaterial=c;for(let u=0,f=d.length;u<f;++u){const m=u&1?l:a;c.kernel=d[u],c.inputBuffer=h.texture,i.setRenderTarget(m),i.render(r,o),h=m}this.fullscreenMaterial=this.copyMaterial,this.copyMaterial.inputBuffer=h.texture,i.setRenderTarget(this.renderToScreen?null:t),i.render(r,o)}setSize(i,e){const t=this.resolution;t.setBaseSize(i,e);const s=t.width,n=t.height;this.renderTargetA.setSize(s,n),this.renderTargetB.setSize(s,n),this.blurMaterial.setSize(i,e)}initialize(i,e,t){t!==void 0&&(this.renderTargetA.texture.type=t,this.renderTargetB.texture.type=t,t!==ct?(this.blurMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1",this.copyMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1"):i!==null&&i.outputColorSpace===q&&(this.renderTargetA.texture.colorSpace=q,this.renderTargetB.texture.colorSpace=q))}static get AUTO_SIZE(){return Se.AUTO_SIZE}},yh=`#include <common>
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#ifdef RANGE
uniform vec2 range;
#elif defined(THRESHOLD)
uniform float threshold;uniform float smoothing;
#endif
varying vec2 vUv;void main(){vec4 texel=texture2D(inputBuffer,vUv);float l=luminance(texel.rgb);
#ifdef RANGE
float low=step(range.x,l);float high=step(l,range.y);l*=low*high;
#elif defined(THRESHOLD)
l=smoothstep(threshold,threshold+smoothing,l)*l;
#endif
#ifdef COLOR
gl_FragColor=vec4(texel.rgb*clamp(l,0.0,1.0),l);
#else
gl_FragColor=vec4(l);
#endif
}`,vh=class extends Me{constructor(i=!1,e=null){super({name:"LuminanceMaterial",defines:{THREE_REVISION:Zo.replace(/\D+/g,"")},uniforms:{inputBuffer:new U(null),threshold:new U(0),smoothing:new U(1),range:new U(null)},blending:ut,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:yh,vertexShader:ir}),this.colorOutput=i,this.luminanceRange=e}set inputBuffer(i){this.uniforms.inputBuffer.value=i}setInputBuffer(i){this.uniforms.inputBuffer.value=i}get threshold(){return this.uniforms.threshold.value}set threshold(i){this.smoothing>0||i>0?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.uniforms.threshold.value=i}getThreshold(){return this.threshold}setThreshold(i){this.threshold=i}get smoothing(){return this.uniforms.smoothing.value}set smoothing(i){this.threshold>0||i>0?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.uniforms.smoothing.value=i}getSmoothingFactor(){return this.smoothing}setSmoothingFactor(i){this.smoothing=i}get useThreshold(){return this.threshold>0||this.smoothing>0}set useThreshold(i){}get colorOutput(){return this.defines.COLOR!==void 0}set colorOutput(i){i?this.defines.COLOR="1":delete this.defines.COLOR,this.needsUpdate=!0}isColorOutputEnabled(i){return this.colorOutput}setColorOutputEnabled(i){this.colorOutput=i}get useRange(){return this.luminanceRange!==null}set useRange(i){this.luminanceRange=null}get luminanceRange(){return this.uniforms.range.value}set luminanceRange(i){i!==null?this.defines.RANGE="1":delete this.defines.RANGE,this.uniforms.range.value=i,this.needsUpdate=!0}getLuminanceRange(){return this.luminanceRange}setLuminanceRange(i){this.luminanceRange=i}},bh=class extends Le{constructor({renderTarget:i,luminanceRange:e,colorOutput:t,resolutionScale:s=1,width:n=Se.AUTO_SIZE,height:r=Se.AUTO_SIZE,resolutionX:o=n,resolutionY:a=r}={}){super("LuminancePass"),this.fullscreenMaterial=new vh(t,e),this.needsSwap=!1,this.renderTarget=i,this.renderTarget===void 0&&(this.renderTarget=new ze(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="LuminancePass.Target");const l=this.resolution=new Se(this,o,a,s);l.addEventListener("change",c=>this.setSize(l.baseWidth,l.baseHeight))}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}render(i,e,t,s,n){const r=this.fullscreenMaterial;r.inputBuffer=e.texture,i.setRenderTarget(this.renderToScreen?null:this.renderTarget),i.render(this.scene,this.camera)}setSize(i,e){const t=this.resolution;t.setBaseSize(i,e),this.renderTarget.setSize(t.width,t.height)}initialize(i,e,t){t!==void 0&&t!==ct&&(this.renderTarget.texture.type=t,this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}},wh=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#define WEIGHT_INNER 0.125
#define WEIGHT_OUTER 0.0555555
varying vec2 vUv;varying vec2 vUv00;varying vec2 vUv01;varying vec2 vUv02;varying vec2 vUv03;varying vec2 vUv04;varying vec2 vUv05;varying vec2 vUv06;varying vec2 vUv07;varying vec2 vUv08;varying vec2 vUv09;varying vec2 vUv10;varying vec2 vUv11;float clampToBorder(const in vec2 uv){return float(uv.s>=0.0&&uv.s<=1.0&&uv.t>=0.0&&uv.t<=1.0);}void main(){vec4 c=vec4(0.0);vec4 w=WEIGHT_INNER*vec4(clampToBorder(vUv00),clampToBorder(vUv01),clampToBorder(vUv02),clampToBorder(vUv03));c+=w.x*texture2D(inputBuffer,vUv00);c+=w.y*texture2D(inputBuffer,vUv01);c+=w.z*texture2D(inputBuffer,vUv02);c+=w.w*texture2D(inputBuffer,vUv03);w=WEIGHT_OUTER*vec4(clampToBorder(vUv04),clampToBorder(vUv05),clampToBorder(vUv06),clampToBorder(vUv07));c+=w.x*texture2D(inputBuffer,vUv04);c+=w.y*texture2D(inputBuffer,vUv05);c+=w.z*texture2D(inputBuffer,vUv06);c+=w.w*texture2D(inputBuffer,vUv07);w=WEIGHT_OUTER*vec4(clampToBorder(vUv08),clampToBorder(vUv09),clampToBorder(vUv10),clampToBorder(vUv11));c+=w.x*texture2D(inputBuffer,vUv08);c+=w.y*texture2D(inputBuffer,vUv09);c+=w.z*texture2D(inputBuffer,vUv10);c+=w.w*texture2D(inputBuffer,vUv11);c+=WEIGHT_OUTER*texture2D(inputBuffer,vUv);gl_FragColor=c;
#include <colorspace_fragment>
}`,xh="uniform vec2 texelSize;varying vec2 vUv;varying vec2 vUv00;varying vec2 vUv01;varying vec2 vUv02;varying vec2 vUv03;varying vec2 vUv04;varying vec2 vUv05;varying vec2 vUv06;varying vec2 vUv07;varying vec2 vUv08;varying vec2 vUv09;varying vec2 vUv10;varying vec2 vUv11;void main(){vUv=position.xy*0.5+0.5;vUv00=vUv+texelSize*vec2(-1.0,1.0);vUv01=vUv+texelSize*vec2(1.0,1.0);vUv02=vUv+texelSize*vec2(-1.0,-1.0);vUv03=vUv+texelSize*vec2(1.0,-1.0);vUv04=vUv+texelSize*vec2(-2.0,2.0);vUv05=vUv+texelSize*vec2(0.0,2.0);vUv06=vUv+texelSize*vec2(2.0,2.0);vUv07=vUv+texelSize*vec2(-2.0,0.0);vUv08=vUv+texelSize*vec2(2.0,0.0);vUv09=vUv+texelSize*vec2(-2.0,-2.0);vUv10=vUv+texelSize*vec2(0.0,-2.0);vUv11=vUv+texelSize*vec2(2.0,-2.0);gl_Position=vec4(position.xy,1.0,1.0);}",Sh=class extends Me{constructor(){super({name:"DownsamplingMaterial",uniforms:{inputBuffer:new U(null),texelSize:new U(new k)},blending:ut,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:wh,vertexShader:xh})}set inputBuffer(i){this.uniforms.inputBuffer.value=i}setSize(i,e){this.uniforms.texelSize.value.set(1/i,1/e)}},Th=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;uniform mediump sampler2D supportBuffer;
#else
uniform lowp sampler2D inputBuffer;uniform lowp sampler2D supportBuffer;
#endif
uniform float radius;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;varying vec2 vUv6;varying vec2 vUv7;void main(){vec4 c=vec4(0.0);c+=texture2D(inputBuffer,vUv0)*0.0625;c+=texture2D(inputBuffer,vUv1)*0.125;c+=texture2D(inputBuffer,vUv2)*0.0625;c+=texture2D(inputBuffer,vUv3)*0.125;c+=texture2D(inputBuffer,vUv)*0.25;c+=texture2D(inputBuffer,vUv4)*0.125;c+=texture2D(inputBuffer,vUv5)*0.0625;c+=texture2D(inputBuffer,vUv6)*0.125;c+=texture2D(inputBuffer,vUv7)*0.0625;vec4 baseColor=texture2D(supportBuffer,vUv);gl_FragColor=mix(baseColor,c,radius);
#include <colorspace_fragment>
}`,Eh="uniform vec2 texelSize;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;varying vec2 vUv6;varying vec2 vUv7;void main(){vUv=position.xy*0.5+0.5;vUv0=vUv+texelSize*vec2(-1.0,1.0);vUv1=vUv+texelSize*vec2(0.0,1.0);vUv2=vUv+texelSize*vec2(1.0,1.0);vUv3=vUv+texelSize*vec2(-1.0,0.0);vUv4=vUv+texelSize*vec2(1.0,0.0);vUv5=vUv+texelSize*vec2(-1.0,-1.0);vUv6=vUv+texelSize*vec2(0.0,-1.0);vUv7=vUv+texelSize*vec2(1.0,-1.0);gl_Position=vec4(position.xy,1.0,1.0);}",Ah=class extends Me{constructor(){super({name:"UpsamplingMaterial",uniforms:{inputBuffer:new U(null),supportBuffer:new U(null),texelSize:new U(new k),radius:new U(.85)},blending:ut,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:Th,vertexShader:Eh})}set inputBuffer(i){this.uniforms.inputBuffer.value=i}set supportBuffer(i){this.uniforms.supportBuffer.value=i}get radius(){return this.uniforms.radius.value}set radius(i){this.uniforms.radius.value=i}setSize(i,e){this.uniforms.texelSize.value.set(1/i,1/e)}},Mh=class extends Le{constructor(){super("MipmapBlurPass"),this.needsSwap=!1,this.renderTarget=new ze(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="Upsampling.Mipmap0",this.downsamplingMipmaps=[],this.upsamplingMipmaps=[],this.downsamplingMaterial=new Sh,this.upsamplingMaterial=new Ah,this.resolution=new k}get texture(){return this.renderTarget.texture}get levels(){return this.downsamplingMipmaps.length}set levels(i){if(this.levels!==i){const e=this.renderTarget;this.dispose(),this.downsamplingMipmaps=[],this.upsamplingMipmaps=[];for(let t=0;t<i;++t){const s=e.clone();s.texture.name="Downsampling.Mipmap"+t,this.downsamplingMipmaps.push(s)}this.upsamplingMipmaps.push(e);for(let t=1,s=i-1;t<s;++t){const n=e.clone();n.texture.name="Upsampling.Mipmap"+t,this.upsamplingMipmaps.push(n)}this.setSize(this.resolution.x,this.resolution.y)}}get radius(){return this.upsamplingMaterial.radius}set radius(i){this.upsamplingMaterial.radius=i}render(i,e,t,s,n){const{scene:r,camera:o}=this,{downsamplingMaterial:a,upsamplingMaterial:l}=this,{downsamplingMipmaps:c,upsamplingMipmaps:d}=this;let h=e;this.fullscreenMaterial=a;for(let u=0,f=c.length;u<f;++u){const m=c[u];a.setSize(h.width,h.height),a.inputBuffer=h.texture,i.setRenderTarget(m),i.render(r,o),h=m}this.fullscreenMaterial=l;for(let u=d.length-1;u>=0;--u){const f=d[u];l.setSize(h.width,h.height),l.inputBuffer=h.texture,l.supportBuffer=c[u].texture,i.setRenderTarget(f),i.render(r,o),h=f}}setSize(i,e){const t=this.resolution;t.set(i,e);let s=t.width,n=t.height;for(let r=0,o=this.downsamplingMipmaps.length;r<o;++r)s=Math.round(s*.5),n=Math.round(n*.5),this.downsamplingMipmaps[r].setSize(s,n),r<this.upsamplingMipmaps.length&&this.upsamplingMipmaps[r].setSize(s,n)}initialize(i,e,t){if(t!==void 0){const s=this.downsamplingMipmaps.concat(this.upsamplingMipmaps);for(const n of s)n.texture.type=t;if(t!==ct)this.downsamplingMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1",this.upsamplingMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1";else if(i!==null&&i.outputColorSpace===q)for(const n of s)n.texture.colorSpace=q}}dispose(){super.dispose();for(const i of this.downsamplingMipmaps.concat(this.upsamplingMipmaps))i.dispose()}},_h=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D map;
#else
uniform lowp sampler2D map;
#endif
uniform float intensity;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec4 texel=texture2D(map,uv);outputColor=vec4(texel.rgb*intensity,texel.a);}`,Ch=class extends ji{constructor({blendFunction:i=z.SCREEN,luminanceThreshold:e=.9,luminanceSmoothing:t=.025,mipmapBlur:s=!1,intensity:n=1,radius:r=.85,levels:o=8,kernelSize:a=Vi.LARGE,resolutionScale:l=.5,width:c=Se.AUTO_SIZE,height:d=Se.AUTO_SIZE,resolutionX:h=c,resolutionY:u=d}={}){super("BloomEffect",_h,{blendFunction:i,uniforms:new Map([["map",new U(null)],["intensity",new U(n)]])}),this.renderTarget=new ze(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="Bloom.Target",this.blurPass=new pa({kernelSize:a}),this.luminancePass=new bh({colorOutput:!0}),this.luminanceMaterial.threshold=e,this.luminanceMaterial.smoothing=t,this.mipmapBlurPass=new Mh,this.mipmapBlurPass.enabled=s,this.mipmapBlurPass.radius=r,this.mipmapBlurPass.levels=o,this.uniforms.get("map").value=s?this.mipmapBlurPass.texture:this.renderTarget.texture;const f=this.resolution=new Se(this,h,u,l);f.addEventListener("change",m=>this.setSize(f.baseWidth,f.baseHeight))}get texture(){return this.mipmapBlurPass.enabled?this.mipmapBlurPass.texture:this.renderTarget.texture}getTexture(){return this.texture}getResolution(){return this.resolution}getBlurPass(){return this.blurPass}getLuminancePass(){return this.luminancePass}get luminanceMaterial(){return this.luminancePass.fullscreenMaterial}getLuminanceMaterial(){return this.luminancePass.fullscreenMaterial}get width(){return this.resolution.width}set width(i){this.resolution.preferredWidth=i}get height(){return this.resolution.height}set height(i){this.resolution.preferredHeight=i}get dithering(){return this.blurPass.dithering}set dithering(i){this.blurPass.dithering=i}get kernelSize(){return this.blurPass.kernelSize}set kernelSize(i){this.blurPass.kernelSize=i}get distinction(){return console.warn(this.name,"distinction was removed"),1}set distinction(i){console.warn(this.name,"distinction was removed")}get intensity(){return this.uniforms.get("intensity").value}set intensity(i){this.uniforms.get("intensity").value=i}getIntensity(){return this.intensity}setIntensity(i){this.intensity=i}getResolutionScale(){return this.resolution.scale}setResolutionScale(i){this.resolution.scale=i}update(i,e,t){const s=this.renderTarget,n=this.luminancePass;n.enabled?(n.render(i,e),this.mipmapBlurPass.enabled?this.mipmapBlurPass.render(i,n.renderTarget):this.blurPass.render(i,n.renderTarget,s)):this.mipmapBlurPass.enabled?this.mipmapBlurPass.render(i,e):this.blurPass.render(i,e,s)}setSize(i,e){const t=this.resolution;t.setBaseSize(i,e),this.renderTarget.setSize(t.width,t.height),this.blurPass.resolution.copy(t),this.luminancePass.setSize(i,e),this.mipmapBlurPass.setSize(i,e)}initialize(i,e,t){this.blurPass.initialize(i,e,t),this.luminancePass.initialize(i,e,t),this.mipmapBlurPass.initialize(i,e,t),t!==void 0&&(this.renderTarget.texture.type=t,i!==null&&i.outputColorSpace===q&&(this.renderTarget.texture.colorSpace=q))}},Ph="uniform float brightness;uniform float contrast;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec3 color=inputColor.rgb+vec3(brightness-0.5);if(contrast>0.0){color/=vec3(1.0-contrast);}else{color*=vec3(1.0+contrast);}outputColor=vec4(color+vec3(0.5),inputColor.a);}",Rh=class extends ji{constructor({blendFunction:i=z.SRC,brightness:e=0,contrast:t=0}={}){super("BrightnessContrastEffect",Ph,{blendFunction:i,uniforms:new Map([["brightness",new U(e)],["contrast",new U(t)]])}),this.inputColorSpace=q}get brightness(){return this.uniforms.get("brightness").value}set brightness(i){this.uniforms.get("brightness").value=i}getBrightness(){return this.brightness}setBrightness(i){this.brightness=i}get contrast(){return this.uniforms.get("contrast").value}set contrast(i){this.uniforms.get("contrast").value=i}getContrast(){return this.contrast}setContrast(i){this.contrast=i}},ma=class extends Le{constructor(i,e="inputBuffer"){super("ShaderPass"),this.fullscreenMaterial=i,this.input=e}setInput(i){this.input=i}render(i,e,t,s,n){const r=this.fullscreenMaterial.uniforms;e!==null&&r!==void 0&&r[this.input]!==void 0&&(r[this.input].value=e.texture),i.setRenderTarget(this.renderToScreen?null:t),i.render(this.scene,this.camera)}initialize(i,e,t){t!==void 0&&t!==ct&&(this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}},zs={KEEP_MAX_DEPTH:1,DISCARD_MAX_DEPTH:2},Lh=`#include <common>
#include <packing>
#ifdef GL_FRAGMENT_PRECISION_HIGH
uniform highp sampler2D depthBuffer0;uniform highp sampler2D depthBuffer1;
#else
uniform mediump sampler2D depthBuffer0;uniform mediump sampler2D depthBuffer1;
#endif
uniform sampler2D inputBuffer;uniform vec2 cameraNearFar;float getViewZ(const in float depth){
#ifdef PERSPECTIVE_CAMERA
return perspectiveDepthToViewZ(depth,cameraNearFar.x,cameraNearFar.y);
#else
return orthographicDepthToViewZ(depth,cameraNearFar.x,cameraNearFar.y);
#endif
}varying vec2 vUv;void main(){vec2 depth;
#if DEPTH_PACKING_0 == 3201
depth.x=unpackRGBAToDepth(texture2D(depthBuffer0,vUv));
#else
depth.x=texture2D(depthBuffer0,vUv).r;
#ifdef LOG_DEPTH
float d=pow(2.0,depth.x*log2(cameraNearFar.y+1.0))-1.0;float a=cameraNearFar.y/(cameraNearFar.y-cameraNearFar.x);float b=cameraNearFar.y*cameraNearFar.x/(cameraNearFar.x-cameraNearFar.y);depth.x=a+b/d;
#endif
#endif
#if DEPTH_PACKING_1 == 3201
depth.y=unpackRGBAToDepth(texture2D(depthBuffer1,vUv));
#else
depth.y=texture2D(depthBuffer1,vUv).r;
#ifdef LOG_DEPTH
float d=pow(2.0,depth.y*log2(cameraNearFar.y+1.0))-1.0;float a=cameraNearFar.y/(cameraNearFar.y-cameraNearFar.x);float b=cameraNearFar.y*cameraNearFar.x/(cameraNearFar.x-cameraNearFar.y);depth.y=a+b/d;
#endif
#endif
bool isMaxDepth=(depth.x==1.0);
#ifdef PERSPECTIVE_CAMERA
depth.x=viewZToOrthographicDepth(getViewZ(depth.x),cameraNearFar.x,cameraNearFar.y);depth.y=viewZToOrthographicDepth(getViewZ(depth.y),cameraNearFar.x,cameraNearFar.y);
#endif
#if DEPTH_TEST_STRATEGY == 0
bool keep=depthTest(depth.x,depth.y);
#elif DEPTH_TEST_STRATEGY == 1
bool keep=isMaxDepth||depthTest(depth.x,depth.y);
#else
bool keep=!isMaxDepth&&depthTest(depth.x,depth.y);
#endif
if(keep){gl_FragColor=texture2D(inputBuffer,vUv);}else{discard;}}`,Dh=class extends Me{constructor(){super({name:"DepthMaskMaterial",defines:{DEPTH_EPSILON:"0.0001",DEPTH_PACKING_0:"0",DEPTH_PACKING_1:"0",DEPTH_TEST_STRATEGY:zs.KEEP_MAX_DEPTH},uniforms:{inputBuffer:new U(null),depthBuffer0:new U(null),depthBuffer1:new U(null),cameraNearFar:new U(new k(1,1))},blending:ut,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:Lh,vertexShader:ir}),this.depthMode=Mr}set depthBuffer0(i){this.uniforms.depthBuffer0.value=i}set depthPacking0(i){this.defines.DEPTH_PACKING_0=i.toFixed(0),this.needsUpdate=!0}setDepthBuffer0(i,e=Gt){this.depthBuffer0=i,this.depthPacking0=e}set depthBuffer1(i){this.uniforms.depthBuffer1.value=i}set depthPacking1(i){this.defines.DEPTH_PACKING_1=i.toFixed(0),this.needsUpdate=!0}setDepthBuffer1(i,e=Gt){this.depthBuffer1=i,this.depthPacking1=e}get maxDepthStrategy(){return Number(this.defines.DEPTH_TEST_STRATEGY)}set maxDepthStrategy(i){this.defines.DEPTH_TEST_STRATEGY=i.toFixed(0),this.needsUpdate=!0}get keepFar(){return this.maxDepthStrategy}set keepFar(i){this.maxDepthStrategy=i?zs.KEEP_MAX_DEPTH:zs.DISCARD_MAX_DEPTH}getMaxDepthStrategy(){return this.maxDepthStrategy}setMaxDepthStrategy(i){this.maxDepthStrategy=i}get epsilon(){return Number(this.defines.DEPTH_EPSILON)}set epsilon(i){this.defines.DEPTH_EPSILON=i.toFixed(16),this.needsUpdate=!0}getEpsilon(){return this.epsilon}setEpsilon(i){this.epsilon=i}get depthMode(){return Number(this.defines.DEPTH_MODE)}set depthMode(i){let e;switch(i){case xl:e="false";break;case wl:e="true";break;case Pn:e="abs(d1 - d0) <= DEPTH_EPSILON";break;case Xo:e="abs(d1 - d0) > DEPTH_EPSILON";break;case Mr:e="d0 > d1";break;case bl:e="d0 >= d1";break;case vl:e="d0 <= d1";break;case yl:default:e="d0 < d1";break}this.defines.DEPTH_MODE=i.toFixed(0),this.defines["depthTest(d0, d1)"]=e,this.needsUpdate=!0}getDepthMode(){return this.depthMode}setDepthMode(i){this.depthMode=i}adoptCameraSettings(i){this.copyCameraSettings(i)}copyCameraSettings(i){i&&(this.uniforms.cameraNearFar.value.set(i.near,i.far),i instanceof ws?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}},nr=class extends Le{constructor(i,e,t=null){super("RenderPass",i,e),this.needsSwap=!1,this.clearPass=new Gi,this.overrideMaterialManager=t===null?null:new Ur(t),this.ignoreBackground=!1,this.skipShadowMapUpdate=!1,this.selection=null}set mainScene(i){this.scene=i}set mainCamera(i){this.camera=i}get renderToScreen(){return super.renderToScreen}set renderToScreen(i){super.renderToScreen=i,this.clearPass.renderToScreen=i}get overrideMaterial(){const i=this.overrideMaterialManager;return i!==null?i.material:null}set overrideMaterial(i){const e=this.overrideMaterialManager;i!==null?e!==null?e.setMaterial(i):this.overrideMaterialManager=new Ur(i):e!==null&&(e.dispose(),this.overrideMaterialManager=null)}getOverrideMaterial(){return this.overrideMaterial}setOverrideMaterial(i){this.overrideMaterial=i}get clear(){return this.clearPass.enabled}set clear(i){this.clearPass.enabled=i}getSelection(){return this.selection}setSelection(i){this.selection=i}isBackgroundDisabled(){return this.ignoreBackground}setBackgroundDisabled(i){this.ignoreBackground=i}isShadowMapDisabled(){return this.skipShadowMapUpdate}setShadowMapDisabled(i){this.skipShadowMapUpdate=i}getClearPass(){return this.clearPass}render(i,e,t,s,n){const r=this.scene,o=this.camera,a=this.selection,l=o.layers.mask,c=r.background,d=i.shadowMap.autoUpdate,h=this.renderToScreen?null:e;a!==null&&o.layers.set(a.getLayer()),this.skipShadowMapUpdate&&(i.shadowMap.autoUpdate=!1),(this.ignoreBackground||this.clearPass.overrideClearColor!==null)&&(r.background=null),this.clearPass.enabled&&this.clearPass.render(i,e),i.setRenderTarget(h),this.overrideMaterialManager!==null?this.overrideMaterialManager.render(i,r,o):i.render(r,o),o.layers.mask=l,r.background=c,i.shadowMap.autoUpdate=d}},Ih="uniform vec3 hue;uniform float saturation;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec3 color=vec3(dot(inputColor.rgb,hue.xyz),dot(inputColor.rgb,hue.zxy),dot(inputColor.rgb,hue.yzx));float average=(color.r+color.g+color.b)/3.0;vec3 diff=average-color;if(saturation>0.0){color+=diff*(1.0-1.0/(1.001-saturation));}else{color+=diff*-saturation;}outputColor=vec4(min(color,1.0),inputColor.a);}",Bh=class extends ji{constructor({blendFunction:i=z.SRC,hue:e=0,saturation:t=0}={}){super("HueSaturationEffect",Ih,{blendFunction:i,uniforms:new Map([["hue",new U(new _)],["saturation",new U(t)]])}),this.hue=e}get saturation(){return this.uniforms.get("saturation").value}set saturation(i){this.uniforms.get("saturation").value=i}getSaturation(){return this.saturation}setSaturation(i){this.saturation=i}get hue(){const i=this.uniforms.get("hue").value;return Math.acos((i.x*3-1)/2)}set hue(i){const e=Math.sin(i),t=Math.cos(i);this.uniforms.get("hue").value.set((2*t+1)/3,(-Math.sqrt(3)*e-t+1)/3,(Math.sqrt(3)*e-t+1)/3)}getHue(){return this.hue}setHue(i){this.hue=i}},Oh=`#include <packing>
#include <clipping_planes_pars_fragment>
#ifdef GL_FRAGMENT_PRECISION_HIGH
uniform highp sampler2D depthBuffer;
#else
uniform mediump sampler2D depthBuffer;
#endif
uniform float cameraNear;uniform float cameraFar;centroid varying float vViewZ;centroid varying vec4 vProjTexCoord;void main(){
#include <clipping_planes_fragment>
vec2 projTexCoord=(vProjTexCoord.xy/vProjTexCoord.w)*0.5+0.5;projTexCoord=clamp(projTexCoord,0.002,0.998);
#if DEPTH_PACKING == 3201
float fragCoordZ=unpackRGBAToDepth(texture2D(depthBuffer,projTexCoord));
#else
float fragCoordZ=texture2D(depthBuffer,projTexCoord).r;
#endif
#ifdef PERSPECTIVE_CAMERA
float viewZ=perspectiveDepthToViewZ(fragCoordZ,cameraNear,cameraFar);
#else
float viewZ=orthographicDepthToViewZ(fragCoordZ,cameraNear,cameraFar);
#endif
float depthTest=(-vViewZ>-viewZ)?1.0:0.0;gl_FragColor.rg=vec2(0.0,depthTest);}`,Fh=`#include <common>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <clipping_planes_pars_vertex>
varying float vViewZ;varying vec4 vProjTexCoord;void main(){
#include <skinbase_vertex>
#include <begin_vertex>
#include <morphtarget_vertex>
#include <skinning_vertex>
#include <project_vertex>
vViewZ=mvPosition.z;vProjTexCoord=gl_Position;
#include <clipping_planes_vertex>
}`,Nh=class extends Me{constructor(i=null,e){super({name:"DepthComparisonMaterial",defines:{DEPTH_PACKING:"0"},uniforms:{depthBuffer:new U(null),cameraNear:new U(.3),cameraFar:new U(1e3)},blending:ut,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:Oh,vertexShader:Fh}),this.depthBuffer=i,this.depthPacking=Ci,this.copyCameraSettings(e)}set depthBuffer(i){this.uniforms.depthBuffer.value=i}set depthPacking(i){this.defines.DEPTH_PACKING=i.toFixed(0),this.needsUpdate=!0}setDepthBuffer(i,e=Ci){this.depthBuffer=i,this.depthPacking=e}adoptCameraSettings(i){this.copyCameraSettings(i)}copyCameraSettings(i){i&&(this.uniforms.cameraNear.value=i.near,this.uniforms.cameraFar.value=i.far,i instanceof ws?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}},kh="uniform lowp sampler2D inputBuffer;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 c0=texture2D(inputBuffer,vUv0).rg;vec2 c1=texture2D(inputBuffer,vUv1).rg;vec2 c2=texture2D(inputBuffer,vUv2).rg;vec2 c3=texture2D(inputBuffer,vUv3).rg;float d0=(c0.x-c1.x)*0.5;float d1=(c2.x-c3.x)*0.5;float d=length(vec2(d0,d1));float a0=min(c0.y,c1.y);float a1=min(c2.y,c3.y);float visibilityFactor=min(a0,a1);gl_FragColor.rg=(1.0-visibilityFactor>0.001)?vec2(d,0.0):vec2(0.0,d);}",Uh="uniform vec2 texelSize;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vUv0=vec2(uv.x+texelSize.x,uv.y);vUv1=vec2(uv.x-texelSize.x,uv.y);vUv2=vec2(uv.x,uv.y+texelSize.y);vUv3=vec2(uv.x,uv.y-texelSize.y);gl_Position=vec4(position.xy,1.0,1.0);}",zh=class extends Me{constructor(i=new k){super({name:"OutlineMaterial",uniforms:{inputBuffer:new U(null),texelSize:new U(new k)},blending:ut,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:kh,vertexShader:Uh}),this.uniforms.texelSize.value.set(i.x,i.y),this.uniforms.maskTexture=this.uniforms.inputBuffer}set inputBuffer(i){this.uniforms.inputBuffer.value=i}setInputBuffer(i){this.uniforms.inputBuffer.value=i}setTexelSize(i,e){this.uniforms.texelSize.value.set(i,e)}setSize(i,e){this.uniforms.texelSize.value.set(1/i,1/e)}},ga=class extends Le{constructor(i,e,{renderTarget:t,resolutionScale:s=1,width:n=Se.AUTO_SIZE,height:r=Se.AUTO_SIZE,resolutionX:o=n,resolutionY:a=r}={}){super("DepthPass"),this.needsSwap=!1,this.renderPass=new nr(i,e,new gl({depthPacking:Ci}));const l=this.renderPass;l.skipShadowMapUpdate=!0,l.ignoreBackground=!0;const c=l.clearPass;c.overrideClearColor=new Z(16777215),c.overrideClearAlpha=1,this.renderTarget=t,this.renderTarget===void 0&&(this.renderTarget=new ze(1,1,{minFilter:Rn,magFilter:Rn}),this.renderTarget.texture.name="DepthPass.Target");const d=this.resolution=new Se(this,o,a,s);d.addEventListener("change",h=>this.setSize(d.baseWidth,d.baseHeight))}set mainScene(i){this.renderPass.mainScene=i}set mainCamera(i){this.renderPass.mainCamera=i}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}getResolutionScale(){return this.resolution.scale}setResolutionScale(i){this.resolution.scale=i}render(i,e,t,s,n){const r=this.renderToScreen?null:this.renderTarget;this.renderPass.render(i,r)}setSize(i,e){const t=this.resolution;t.setBaseSize(i,e),this.renderTarget.setSize(t.width,t.height)}},Hh=`uniform lowp sampler2D edgeTexture;uniform lowp sampler2D maskTexture;uniform vec3 visibleEdgeColor;uniform vec3 hiddenEdgeColor;uniform float pulse;uniform float edgeStrength;
#ifdef USE_PATTERN
uniform lowp sampler2D patternTexture;varying vec2 vUvPattern;
#endif
void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){vec2 edge=texture2D(edgeTexture,uv).rg;vec2 mask=texture2D(maskTexture,uv).rg;
#ifndef X_RAY
edge.y=0.0;
#endif
edge*=(edgeStrength*mask.x*pulse);vec3 color=edge.x*visibleEdgeColor+edge.y*hiddenEdgeColor;float visibilityFactor=0.0;
#ifdef USE_PATTERN
vec4 patternColor=texture2D(patternTexture,vUvPattern);
#ifdef X_RAY
float hiddenFactor=0.5;
#else
float hiddenFactor=0.0;
#endif
visibilityFactor=(1.0-mask.y>0.0)?1.0:hiddenFactor;visibilityFactor*=(1.0-mask.x)*patternColor.a;color+=visibilityFactor*patternColor.rgb;
#endif
float alpha=max(max(edge.x,edge.y),visibilityFactor);
#ifdef ALPHA
outputColor=vec4(color,alpha);
#else
outputColor=vec4(color,max(alpha,inputColor.a));
#endif
}`,Gh="uniform float patternScale;varying vec2 vUvPattern;void mainSupport(const in vec2 uv){vUvPattern=uv*vec2(aspect,1.0)*patternScale;}",zr=class extends ji{constructor(i,e,{blendFunction:t=z.SCREEN,patternTexture:s=null,patternScale:n=1,edgeStrength:r=1,pulseSpeed:o=0,visibleEdgeColor:a=16777215,hiddenEdgeColor:l=2230538,kernelSize:c=Vi.VERY_SMALL,blur:d=!1,xRay:h=!0,multisampling:u=0,resolutionScale:f=.5,width:m=Se.AUTO_SIZE,height:y=Se.AUTO_SIZE,resolutionX:p=m,resolutionY:g=y}={}){super("OutlineEffect",Hh,{uniforms:new Map([["maskTexture",new U(null)],["edgeTexture",new U(null)],["edgeStrength",new U(r)],["visibleEdgeColor",new U(new Z(a))],["hiddenEdgeColor",new U(new Z(l))],["pulse",new U(1)],["patternScale",new U(n)],["patternTexture",new U(null)]])}),this.blendMode.addEventListener("change",x=>{this.blendMode.blendFunction===z.ALPHA?this.defines.set("ALPHA","1"):this.defines.delete("ALPHA"),this.setChanged()}),this.blendMode.blendFunction=t,this.patternTexture=s,this.xRay=h,this.scene=i,this.camera=e,this.renderTargetMask=new ze(1,1),this.renderTargetMask.samples=u,this.renderTargetMask.texture.name="Outline.Mask",this.uniforms.get("maskTexture").value=this.renderTargetMask.texture,this.renderTargetOutline=new ze(1,1,{depthBuffer:!1}),this.renderTargetOutline.texture.name="Outline.Edges",this.uniforms.get("edgeTexture").value=this.renderTargetOutline.texture,this.clearPass=new Gi,this.clearPass.overrideClearColor=new Z(0),this.clearPass.overrideClearAlpha=1,this.depthPass=new ga(i,e),this.maskPass=new nr(i,e,new Nh(this.depthPass.texture,e));const v=this.maskPass.clearPass;v.overrideClearColor=new Z(16777215),v.overrideClearAlpha=1,this.blurPass=new pa({resolutionScale:f,resolutionX:p,resolutionY:g,kernelSize:c}),this.blurPass.enabled=d;const w=this.blurPass.resolution;w.addEventListener("change",x=>this.setSize(w.baseWidth,w.baseHeight)),this.outlinePass=new ma(new zh);const b=this.outlinePass.fullscreenMaterial;b.inputBuffer=this.renderTargetMask.texture,this.time=0,this.forceUpdate=!0,this.selection=new fa,this.pulseSpeed=o}set mainScene(i){this.scene=i,this.depthPass.mainScene=i,this.maskPass.mainScene=i}set mainCamera(i){this.camera=i,this.depthPass.mainCamera=i,this.maskPass.mainCamera=i,this.maskPass.overrideMaterial.copyCameraSettings(i)}get resolution(){return this.blurPass.resolution}getResolution(){return this.blurPass.getResolution()}get multisampling(){return this.renderTargetMask.samples}set multisampling(i){this.renderTargetMask.samples=i,this.renderTargetMask.dispose()}get patternScale(){return this.uniforms.get("patternScale").value}set patternScale(i){this.uniforms.get("patternScale").value=i}get edgeStrength(){return this.uniforms.get("edgeStrength").value}set edgeStrength(i){this.uniforms.get("edgeStrength").value=i}get visibleEdgeColor(){return this.uniforms.get("visibleEdgeColor").value}set visibleEdgeColor(i){this.uniforms.get("visibleEdgeColor").value=i}get hiddenEdgeColor(){return this.uniforms.get("hiddenEdgeColor").value}set hiddenEdgeColor(i){this.uniforms.get("hiddenEdgeColor").value=i}getBlurPass(){return this.blurPass}getSelection(){return this.selection}getPulseSpeed(){return this.pulseSpeed}setPulseSpeed(i){this.pulseSpeed=i}get width(){return this.resolution.width}set width(i){this.resolution.preferredWidth=i}get height(){return this.resolution.height}set height(i){this.resolution.preferredHeight=i}get selectionLayer(){return this.selection.layer}set selectionLayer(i){this.selection.layer=i}get dithering(){return this.blurPass.dithering}set dithering(i){this.blurPass.dithering=i}get kernelSize(){return this.blurPass.kernelSize}set kernelSize(i){this.blurPass.kernelSize=i}get blur(){return this.blurPass.enabled}set blur(i){this.blurPass.enabled=i}get xRay(){return this.defines.has("X_RAY")}set xRay(i){this.xRay!==i&&(i?this.defines.set("X_RAY","1"):this.defines.delete("X_RAY"),this.setChanged())}isXRayEnabled(){return this.xRay}setXRayEnabled(i){this.xRay=i}get patternTexture(){return this.uniforms.get("patternTexture").value}set patternTexture(i){i!==null?(i.wrapS=i.wrapT=jt,this.defines.set("USE_PATTERN","1"),this.setVertexShader(Gh)):(this.defines.delete("USE_PATTERN"),this.setVertexShader(null)),this.uniforms.get("patternTexture").value=i,this.setChanged()}setPatternTexture(i){this.patternTexture=i}getResolutionScale(){return this.resolution.scale}setResolutionScale(i){this.resolution.scale=i}setSelection(i){return this.selection.set(i),this}clearSelection(){return this.selection.clear(),this}selectObject(i){return this.selection.add(i),this}deselectObject(i){return this.selection.delete(i),this}update(i,e,t){const s=this.scene,n=this.camera,r=this.selection,a=this.uniforms.get("pulse"),l=s.background,c=n.layers.mask;(this.forceUpdate||r.size>0)&&(s.background=null,a.value=1,this.pulseSpeed>0&&(a.value=Math.cos(this.time*this.pulseSpeed*10)*.375+.625),this.time+=t,r.setVisible(!1),this.depthPass.render(i),r.setVisible(!0),n.layers.set(r.layer),this.maskPass.render(i,this.renderTargetMask),n.layers.mask=c,s.background=l,this.outlinePass.render(i,null,this.renderTargetOutline),this.blurPass.enabled&&this.blurPass.render(i,this.renderTargetOutline,this.renderTargetOutline)),this.forceUpdate=r.size>0}setSize(i,e){this.blurPass.setSize(i,e),this.renderTargetMask.setSize(i,e);const t=this.resolution;t.setBaseSize(i,e);const s=t.width,n=t.height;this.depthPass.setSize(s,n),this.renderTargetOutline.setSize(s,n),this.outlinePass.fullscreenMaterial.setSize(s,n)}initialize(i,e,t){this.blurPass.initialize(i,e,ct),t!==void 0&&(this.depthPass.initialize(i,e,t),this.maskPass.initialize(i,e,t),this.outlinePass.initialize(i,e,t))}},jh=class extends Ch{constructor(i,e,t){super(t),this.setAttributes(this.getAttributes()|At.DEPTH),this.camera=e,this.depthPass=new ga(i,e),this.clearPass=new Gi(!0,!1,!1),this.clearPass.overrideClearColor=new Z(0),this.depthMaskPass=new ma(new Dh);const s=this.depthMaskMaterial;s.copyCameraSettings(e),s.depthBuffer1=this.depthPass.texture,s.depthPacking1=Ci,s.depthMode=Pn,this.renderTargetMasked=new ze(1,1,{depthBuffer:!1}),this.renderTargetMasked.texture.name="Bloom.Masked",this.selection=new fa,this._inverted=!1,this._ignoreBackground=!1}set mainScene(i){this.depthPass.mainScene=i}set mainCamera(i){this.camera=i,this.depthPass.mainCamera=i,this.depthMaskMaterial.copyCameraSettings(i)}getSelection(){return this.selection}get depthMaskMaterial(){return this.depthMaskPass.fullscreenMaterial}get inverted(){return this._inverted}set inverted(i){this._inverted=i,this.depthMaskMaterial.depthMode=i?Xo:Pn}isInverted(){return this.inverted}setInverted(i){this.inverted=i}get ignoreBackground(){return this._ignoreBackground}set ignoreBackground(i){this._ignoreBackground=i,this.depthMaskMaterial.maxDepthStrategy=i?zs.DISCARD_MAX_DEPTH:zs.KEEP_MAX_DEPTH}isBackgroundDisabled(){return this.ignoreBackground}setBackgroundDisabled(i){this.ignoreBackground=i}setDepthTexture(i,e=Gt){this.depthMaskMaterial.depthBuffer0=i,this.depthMaskMaterial.depthPacking0=e}update(i,e,t){const s=this.camera,n=this.selection,r=this.inverted;let o=e;if(this.ignoreBackground||!r||n.size>0){const a=s.layers.mask;s.layers.set(n.layer),this.depthPass.render(i),s.layers.mask=a,o=this.renderTargetMasked,this.clearPass.render(i,o),this.depthMaskPass.render(i,e,o)}super.update(i,o,t)}setSize(i,e){super.setSize(i,e),this.renderTargetMasked.setSize(i,e),this.depthPass.setSize(i,e)}initialize(i,e,t){super.initialize(i,e,t),this.clearPass.initialize(i,e,t),this.depthPass.initialize(i,e,t),this.depthMaskPass.initialize(i,e,t),i!==null&&i.capabilities.logarithmicDepthBuffer&&(this.depthMaskPass.fullscreenMaterial.defines.LOG_DEPTH="1"),t!==void 0&&(this.renderTargetMasked.texture.type=t,i!==null&&i.outputColorSpace===q&&(this.renderTargetMasked.texture.colorSpace=q))}},Vh=`#include <common>
#include <packing>
#include <dithering_pars_fragment>
#define packFloatToRGBA(v) packDepthToRGBA(v)
#define unpackRGBAToFloat(v) unpackRGBAToDepth(v)
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#if DEPTH_PACKING == 3201
uniform lowp sampler2D depthBuffer;
#elif defined(GL_FRAGMENT_PRECISION_HIGH)
uniform highp sampler2D depthBuffer;
#else
uniform mediump sampler2D depthBuffer;
#endif
uniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;vec4 sRGBToLinear(const in vec4 value){return vec4(mix(pow(value.rgb*0.9478672986+vec3(0.0521327014),vec3(2.4)),value.rgb*0.0773993808,vec3(lessThanEqual(value.rgb,vec3(0.04045)))),value.a);}float readDepth(const in vec2 uv){
#if DEPTH_PACKING == 3201
return unpackRGBAToDepth(texture2D(depthBuffer,uv));
#else
return texture2D(depthBuffer,uv).r;
#endif
}float getViewZ(const in float depth){
#ifdef PERSPECTIVE_CAMERA
return perspectiveDepthToViewZ(depth,cameraNear,cameraFar);
#else
return orthographicDepthToViewZ(depth,cameraNear,cameraFar);
#endif
}vec3 RGBToHCV(const in vec3 RGB){vec4 P=mix(vec4(RGB.bg,-1.0,2.0/3.0),vec4(RGB.gb,0.0,-1.0/3.0),step(RGB.b,RGB.g));vec4 Q=mix(vec4(P.xyw,RGB.r),vec4(RGB.r,P.yzx),step(P.x,RGB.r));float C=Q.x-min(Q.w,Q.y);float H=abs((Q.w-Q.y)/(6.0*C+EPSILON)+Q.z);return vec3(H,C,Q.x);}vec3 RGBToHSL(const in vec3 RGB){vec3 HCV=RGBToHCV(RGB);float L=HCV.z-HCV.y*0.5;float S=HCV.y/(1.0-abs(L*2.0-1.0)+EPSILON);return vec3(HCV.x,S,L);}vec3 HueToRGB(const in float H){float R=abs(H*6.0-3.0)-1.0;float G=2.0-abs(H*6.0-2.0);float B=2.0-abs(H*6.0-4.0);return clamp(vec3(R,G,B),0.0,1.0);}vec3 HSLToRGB(const in vec3 HSL){vec3 RGB=HueToRGB(HSL.x);float C=(1.0-abs(2.0*HSL.z-1.0))*HSL.y;return(RGB-0.5)*C+HSL.z;}FRAGMENT_HEAD void main(){FRAGMENT_MAIN_UV vec4 color0=texture2D(inputBuffer,UV);vec4 color1=vec4(0.0);FRAGMENT_MAIN_IMAGE color0.a=clamp(color0.a,0.0,1.0);gl_FragColor=color0;
#ifdef ENCODE_OUTPUT
#include <colorspace_fragment>
#endif
#include <dithering_fragment>
}`,qh="uniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;VERTEX_HEAD void main(){vUv=position.xy*0.5+0.5;VERTEX_MAIN_SUPPORT gl_Position=vec4(position.xy,1.0,1.0);}",Wh=class extends Me{constructor(i,e,t,s,n=!1){super({name:"EffectMaterial",defines:{THREE_REVISION:Zo.replace(/\D+/g,""),DEPTH_PACKING:"0",ENCODE_OUTPUT:"1"},uniforms:{inputBuffer:new U(null),depthBuffer:new U(null),resolution:new U(new k),texelSize:new U(new k),cameraNear:new U(.3),cameraFar:new U(1e3),aspect:new U(1),time:new U(0)},blending:ut,toneMapped:!1,depthWrite:!1,depthTest:!1,dithering:n}),i&&this.setShaderParts(i),e&&this.setDefines(e),t&&this.setUniforms(t),this.copyCameraSettings(s)}set inputBuffer(i){this.uniforms.inputBuffer.value=i}setInputBuffer(i){this.uniforms.inputBuffer.value=i}get depthBuffer(){return this.uniforms.depthBuffer.value}set depthBuffer(i){this.uniforms.depthBuffer.value=i}get depthPacking(){return Number(this.defines.DEPTH_PACKING)}set depthPacking(i){this.defines.DEPTH_PACKING=i.toFixed(0),this.needsUpdate=!0}setDepthBuffer(i,e=Gt){this.depthBuffer=i,this.depthPacking=e}setShaderData(i){this.setShaderParts(i.shaderParts),this.setDefines(i.defines),this.setUniforms(i.uniforms),this.setExtensions(i.extensions)}setShaderParts(i){return this.fragmentShader=Vh.replace(K.FRAGMENT_HEAD,i.get(K.FRAGMENT_HEAD)||"").replace(K.FRAGMENT_MAIN_UV,i.get(K.FRAGMENT_MAIN_UV)||"").replace(K.FRAGMENT_MAIN_IMAGE,i.get(K.FRAGMENT_MAIN_IMAGE)||""),this.vertexShader=qh.replace(K.VERTEX_HEAD,i.get(K.VERTEX_HEAD)||"").replace(K.VERTEX_MAIN_SUPPORT,i.get(K.VERTEX_MAIN_SUPPORT)||""),this.needsUpdate=!0,this}setDefines(i){for(const e of i.entries())this.defines[e[0]]=e[1];return this.needsUpdate=!0,this}setUniforms(i){for(const e of i.entries())this.uniforms[e[0]]=e[1];return this}setExtensions(i){this.extensions={};for(const e of i)this.extensions[e]=!0;return this}get encodeOutput(){return this.defines.ENCODE_OUTPUT!==void 0}set encodeOutput(i){this.encodeOutput!==i&&(i?this.defines.ENCODE_OUTPUT="1":delete this.defines.ENCODE_OUTPUT,this.needsUpdate=!0)}isOutputEncodingEnabled(i){return this.encodeOutput}setOutputEncodingEnabled(i){this.encodeOutput=i}get time(){return this.uniforms.time.value}set time(i){this.uniforms.time.value=i}setDeltaTime(i){this.uniforms.time.value+=i}adoptCameraSettings(i){this.copyCameraSettings(i)}copyCameraSettings(i){i&&(this.uniforms.cameraNear.value=i.near,this.uniforms.cameraFar.value=i.far,i instanceof ws?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}setSize(i,e){const t=this.uniforms;t.resolution.value.set(i,e),t.texelSize.value.set(1/i,1/e),t.aspect.value=i/e}static get Section(){return K}};function Hr(i,e,t){for(const s of e){const n="$1"+i+s.charAt(0).toUpperCase()+s.slice(1),r=new RegExp("([^\\.])(\\b"+s+"\\b)","g");for(const o of t.entries())o[1]!==null&&t.set(o[0],o[1].replace(r,n))}}function Kh(i,e,t){let s=e.getFragmentShader(),n=e.getVertexShader();const r=s!==void 0&&/mainImage/.test(s),o=s!==void 0&&/mainUv/.test(s);if(t.attributes|=e.getAttributes(),s===void 0)throw new Error(`Missing fragment shader (${e.name})`);if(o&&t.attributes&At.CONVOLUTION)throw new Error(`Effects that transform UVs are incompatible with convolution effects (${e.name})`);if(!r&&!o)throw new Error(`Could not find mainImage or mainUv function (${e.name})`);{const a=/\w+\s+(\w+)\([\w\s,]*\)\s*{/g,l=t.shaderParts;let c=l.get(K.FRAGMENT_HEAD)||"",d=l.get(K.FRAGMENT_MAIN_UV)||"",h=l.get(K.FRAGMENT_MAIN_IMAGE)||"",u=l.get(K.VERTEX_HEAD)||"",f=l.get(K.VERTEX_MAIN_SUPPORT)||"";const m=new Set,y=new Set;if(o&&(d+=`	${i}MainUv(UV);
`,t.uvTransformation=!0),n!==null&&/mainSupport/.test(n)){const v=/mainSupport *\([\w\s]*?uv\s*?\)/.test(n);f+=`	${i}MainSupport(`,f+=v?`vUv);
`:`);
`;for(const w of n.matchAll(/(?:varying\s+\w+\s+([\S\s]*?);)/g))for(const b of w[1].split(/\s*,\s*/))t.varyings.add(b),m.add(b),y.add(b);for(const w of n.matchAll(a))y.add(w[1])}for(const v of s.matchAll(a))y.add(v[1]);for(const v of e.defines.keys())y.add(v.replace(/\([\w\s,]*\)/g,""));for(const v of e.uniforms.keys())y.add(v);y.delete("while"),y.delete("for"),y.delete("if"),e.uniforms.forEach((v,w)=>t.uniforms.set(i+w.charAt(0).toUpperCase()+w.slice(1),v)),e.defines.forEach((v,w)=>t.defines.set(i+w.charAt(0).toUpperCase()+w.slice(1),v));const p=new Map([["fragment",s],["vertex",n]]);Hr(i,y,t.defines),Hr(i,y,p),s=p.get("fragment"),n=p.get("vertex");const g=e.blendMode;if(t.blendModes.set(g.blendFunction,g),r){e.inputColorSpace!==null&&e.inputColorSpace!==t.colorSpace&&(h+=e.inputColorSpace===q?`color0 = sRGBTransferOETF(color0);
	`:`color0 = sRGBToLinear(color0);
	`),e.outputColorSpace!==$o?t.colorSpace=e.outputColorSpace:e.inputColorSpace!==null&&(t.colorSpace=e.inputColorSpace);const v=/MainImage *\([\w\s,]*?depth[\w\s,]*?\)/;h+=`${i}MainImage(color0, UV, `,t.attributes&At.DEPTH&&v.test(s)&&(h+="depth, ",t.readDepth=!0),h+=`color1);
	`;const w=i+"BlendOpacity";t.uniforms.set(w,g.opacity),h+=`color0 = blend${g.blendFunction}(color0, color1, ${w});

	`,c+=`uniform float ${w};

`}if(c+=s+`
`,n!==null&&(u+=n+`
`),l.set(K.FRAGMENT_HEAD,c),l.set(K.FRAGMENT_MAIN_UV,d),l.set(K.FRAGMENT_MAIN_IMAGE,h),l.set(K.VERTEX_HEAD,u),l.set(K.VERTEX_MAIN_SUPPORT,f),e.extensions!==null)for(const v of e.extensions)t.extensions.add(v)}}var Xh=class extends Le{constructor(i,...e){super("EffectPass"),this.fullscreenMaterial=new Wh(null,null,null,i),this.listener=t=>this.handleEvent(t),this.effects=[],this.setEffects(e),this.skipRendering=!1,this.minTime=1,this.maxTime=Number.POSITIVE_INFINITY,this.timeScale=1}set mainScene(i){for(const e of this.effects)e.mainScene=i}set mainCamera(i){this.fullscreenMaterial.copyCameraSettings(i);for(const e of this.effects)e.mainCamera=i}get encodeOutput(){return this.fullscreenMaterial.encodeOutput}set encodeOutput(i){this.fullscreenMaterial.encodeOutput=i}get dithering(){return this.fullscreenMaterial.dithering}set dithering(i){const e=this.fullscreenMaterial;e.dithering=i,e.needsUpdate=!0}setEffects(i){for(const e of this.effects)e.removeEventListener("change",this.listener);this.effects=i.sort((e,t)=>t.attributes-e.attributes);for(const e of this.effects)e.addEventListener("change",this.listener)}updateMaterial(){const i=new Lc;let e=0;for(const o of this.effects)if(o.blendMode.blendFunction===z.DST)i.attributes|=o.getAttributes()&At.DEPTH;else{if(i.attributes&o.getAttributes()&At.CONVOLUTION)throw new Error(`Convolution effects cannot be merged (${o.name})`);Kh("e"+e++,o,i)}let t=i.shaderParts.get(K.FRAGMENT_HEAD),s=i.shaderParts.get(K.FRAGMENT_MAIN_IMAGE),n=i.shaderParts.get(K.FRAGMENT_MAIN_UV);const r=/\bblend\b/g;for(const o of i.blendModes.values())t+=o.getShaderCode().replace(r,`blend${o.blendFunction}`)+`
`;i.attributes&At.DEPTH?(i.readDepth&&(s=`float depth = readDepth(UV);

	`+s),this.needsDepthTexture=this.getDepthTexture()===null):this.needsDepthTexture=!1,i.colorSpace===q&&(s+=`color0 = sRGBToLinear(color0);
	`),i.uvTransformation?(n=`vec2 transformedUv = vUv;
`+n,i.defines.set("UV","transformedUv")):i.defines.set("UV","vUv"),i.shaderParts.set(K.FRAGMENT_HEAD,t),i.shaderParts.set(K.FRAGMENT_MAIN_IMAGE,s),i.shaderParts.set(K.FRAGMENT_MAIN_UV,n);for(const[o,a]of i.shaderParts)a!==null&&i.shaderParts.set(o,a.trim().replace(/^#/,`
#`));this.skipRendering=e===0,this.needsSwap=!this.skipRendering,this.fullscreenMaterial.setShaderData(i)}recompile(){this.updateMaterial()}getDepthTexture(){return this.fullscreenMaterial.depthBuffer}setDepthTexture(i,e=Gt){this.fullscreenMaterial.depthBuffer=i,this.fullscreenMaterial.depthPacking=e;for(const t of this.effects)t.setDepthTexture(i,e)}render(i,e,t,s,n){for(const r of this.effects)r.update(i,e,s);if(!this.skipRendering||this.renderToScreen){const r=this.fullscreenMaterial;r.inputBuffer=e.texture,r.time+=s*this.timeScale,i.setRenderTarget(this.renderToScreen?null:t),i.render(this.scene,this.camera)}}setSize(i,e){this.fullscreenMaterial.setSize(i,e);for(const t of this.effects)t.setSize(i,e)}initialize(i,e,t){this.renderer=i;for(const s of this.effects)s.initialize(i,e,t);this.updateMaterial(),t!==void 0&&t!==ct&&(this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}dispose(){super.dispose();for(const i of this.effects)i.removeEventListener("change",this.listener),i.dispose()}handleEvent(i){switch(i.type){case"change":this.recompile();break}}},hs,bt,ot,ve,ya,va,ba,wa,xa,Sa,Ta;class Yh{constructor(e,t,s){Y(this,ve);Y(this,hs);Y(this,bt);Y(this,ot);N(this,"resize",(e,t)=>{this.composer.setSize(e,t,!0)});N(this,"addBloom",e=>{const t=this.bloomEffect.selection;e instanceof pe?t.add(e):Array.isArray(e)&&e.forEach(this.addBloom)});N(this,"clearBloom",e=>{const t=this.bloomEffect.selection;e instanceof pe?t.delete(e):Array.isArray(e)&&e.forEach(this.clearBloom)});N(this,"addOutline",(e,t=1)=>{let s=t===1?this.outlineEffect1:this.outlineEffect2;e instanceof pe?e.traverse(n=>{n.isMesh&&s.selection.add(n)}):Array.isArray(e)&&e.forEach(n=>this.addOutline(n,t))});N(this,"clearOutline",(e,t=1)=>{let s=t===1?this.outlineEffect1:this.outlineEffect2;e instanceof pe?e.traverse(n=>{n.isMesh&&s.selection.delete(n)}):Array.isArray(e)&&e.forEach(n=>this.clearOutline(n,t))});N(this,"setNoSelection",e=>{this.noSelection.push(e)});N(this,"clearNoSelection",()=>{this.noSelection=[]});X(this,hs,e),X(this,bt,t),X(this,ot,s),this.noSelection=[],$(this,ve,ya).call(this)}clearOutlineAll(e){(e===1?this.outlineEffect1:this.outlineEffect2).selection.set([]),this.noSelection.forEach(s=>{this.addOutline(s)})}}hs=new WeakMap,bt=new WeakMap,ot=new WeakMap,ve=new WeakSet,ya=function(){$(this,ve,va).call(this),$(this,ve,ba).call(this),$(this,ve,wa).call(this),$(this,ve,xa).call(this),$(this,ve,Sa).call(this),$(this,ve,Ta).call(this)},va=function(){const e=I(this,hs).capabilities.maxSamples;this.composer=new Rc(I(this,hs),{multisampling:e})},ba=function(){this.renderPass=new nr(I(this,bt),I(this,ot)),this.composer.addPass(this.renderPass)},wa=function(){this.bloomEffect=new jh(I(this,bt),I(this,ot),{blendFunction:z.ADD,luminanceThreshold:.01,luminanceSmoothing:.6,intensity:.9}),this.bloomEffect.inverted=!1,this.bloomEffect.ignoreBackground=!0,this.bloomEffect.selection.set([])},xa=function(){this.outlineEffect1=new zr(I(this,bt),I(this,ot),{blendFunction:z.ADD,edgeStrength:3,pulseSpeed:0,visibleEdgeColor:52945,hiddenEdgeColor:52945,blur:!1,xRay:!0,usePatternTexture:!1})},Sa=function(){this.outlineEffect2=new zr(I(this,bt),I(this,ot),{blendFunction:z.ADD,edgeStrength:3,patternScale:5,visibleEdgeColor:52945,hiddenEdgeColor:52945,blur:!1,xRay:!0,usePatternTexture:!1})},Ta=function(){this.hueSaturationEffect=new Bh({saturation:.08}),this.brightnessContrastEffect=new Rh({contrast:.2});const e=new Xh(I(this,ot),this.bloomEffect,this.outlineEffect1,this.outlineEffect2);this.composer.addPass(e)};const Gs=class Gs{constructor(){N(this,"resources");N(this,"track",e=>{if(!e)return e;if(Array.isArray(e))return e.forEach(this.track),e;if((Zh(e,"dispose")||e instanceof pe)&&this.resources.add(e),e instanceof pe)e.traverse(t=>{this.resources.add(t),t.material&&this.track(t.material),t.geometry&&this.track(t.geometry),t.skeleton&&this.track(t.skeleton)});else if(e instanceof os){for(const t of Object.values(e))t instanceof gs&&this.track(t);if("uniforms"in e){for(const t of Object.values(e.uniforms))if(t){const s=t.value;s instanceof gs&&this.track(s)}}}return e});this.resources=new Set}untrack(e){this.resources.delete(e)}dispose(e=!0){for(const t of this.resources)t instanceof pe&&e&&t.parent&&t.parent.remove(t),"dispose"in t&&t.dispose();this.clear()}clear(){this.resources.clear()}static dispose(e,t=!0){const s=Gs.memory;return s.track(e),s.dispose(t),s.clear(),!0}};N(Gs,"memory",new Gs);let ae=Gs;function $h(i,e){return Reflect.has(i,e)}function Zh(i,e){return $h(i,e)&&typeof i[e]=="function"}const Gr=new oe;var us;class Qh{constructor(e){Y(this,us);N(this,"resize",(e,t)=>{const s=this.radius;this.upViewport.set(e*.65,t*.94-s,s,s),this.saveViewport.set(0,0,e,t)});this.renderer=e.renderer;const t=new Ve().load("./textures/compass.png");t.colorSpace=q;const s=new Qo(10,10),n=new Ot({transparent:!0,side:je,map:t}),r=new me(s,n);r.rotateX(-Math.PI/2),X(this,us,r);const o=new ws(45,1,1,20);o.updateProjectionMatrix(),this.camera=o;const a=new ms;a.add(r),this.scene=a;const l=this.radius=120,c=window.innerWidth,d=window.innerHeight;this.upViewport=new Ct(c*.65,d*.94-l,l,l),this.saveViewport=new Ct(0,0,c,d)}get theta(){return I(this,us).rotation.z}set theta(e){I(this,us).rotation.z=-e/180*Math.PI}update(e){const t=e.renderer,s=e.camera,n=this.camera,{upViewport:r,saveViewport:o}=this;n.position.set(0,0,12),Gr.extractRotation(s.matrix),n.position.applyMatrix4(Gr),n.lookAt(0,0,0),n.updateProjectionMatrix(),t.setViewport(r),t.setScissor(r),t.render(this.scene,n),t.setViewport(o),t.setScissor(o)}}us=new WeakMap;const jr=new ae;pe.prototype.deleteSelf=function(i){jr.track(this),jr.dispose(i)};const rn=new _;_.prototype.clampSphere=function(i){this.distanceTo(i.center)>i.radius&&(rn.subVectors(this,i.center).normalize(),rn.setLength(i.radius),this.addVectors(i.center,rn))};const{innerWidth:Vr,innerHeight:qr,devicePixelRatio:Jh}=window;var xe,re,Ae,Ks,Ye,Nt,Be,wt,kt,Ut,ds,xt,St,zt,fs,Ni,Ea;class eu{constructor(e){Y(this,Ni);Y(this,xe);Y(this,re);Y(this,Ae);Y(this,Ks);Y(this,Ye);Y(this,Nt);Y(this,Be);N(this,"clock");Y(this,wt);Y(this,kt);Y(this,Ut);Y(this,ds);Y(this,xt);Y(this,St);Y(this,zt);Y(this,fs);X(this,fs,null),this.clock=new Jo,this.delta=0,this.elapsedTime=0,X(this,xt,new Map),X(this,St,new Map),X(this,Nt,e),X(this,wt,!1),X(this,xe,new ms),this.baseScene=I(this,xe),X(this,Ae,new ws(50,Vr/qr,.01,2e4)),X(this,Ks,I(this,Ae)),I(this,Ae).position.set(0,100,100),I(this,Ae).lookAt(0,0,0),X(this,zt,new Qh(this)),I(this,zt).theta=27.6,I(this,xt).set("compass",I(this,zt).resize);const t={logarithmicDepthBuffer:!0,powerPreference:"high-performance"};if(e instanceof HTMLCanvasElement)t.canvas=e;else if(e instanceof HTMLElement){const s=document.createElement("canvas");t.canvas=s,e.appendChild(this.renderer.domElement)}else{const s=document.createElement("canvas");t.canvas=s,document.body.appendChild(s),console.log("create canvas")}X(this,Nt,t.canvas),I(this,Nt).oncontextmenu=s=>!1,X(this,re,new Sl(t)),I(this,re).setSize(Vr,qr),I(this,re).outputColorSpace=q,I(this,re).toneMapping=Tl,I(this,re).shadowMap.enabled=!0,I(this,re).shadowMap.type=El,I(this,re).setPixelRatio(Jh),I(this,re).domElement.removeAttribute("data-engine"),I(this,re).info.autoReset=!1,X(this,Ye,new Sc(I(this,Ae),I(this,re).domElement)),I(this,Ye).target.set(0,0,0),I(this,Ye).enableDamping=!0,I(this,Ye).enableDolly=!1,I(this,Ye).dampingFactor=.2,I(this,Ye).data={},I(this,St).set(Symbol(),s=>s.controls.update()),$(this,Ni,Ea).call(this),document.oncontextmenu=()=>!1,window.addEventListener("resize",()=>{const{innerWidth:s,innerHeight:n}=window;I(this,Ae).aspect=s/n,I(this,Ae).updateProjectionMatrix(),I(this,re).setSize(s,n),I(this,re).setPixelRatio(window.devicePixelRatio),I(this,xt).forEach(r=>r(s,n))})}get onresizeQueue(){return I(this,xt)}get onRenderQueue(){return I(this,St)}get scene(){return I(this,xe)}set scene(e){e instanceof ms&&(I(this,xe).dispose&&I(this,xe).dispose(),X(this,xe,e),I(this,Be)&&I(this,Be).composer.setMainScene(e))}get camera(){return I(this,Ae)}get baseCamera(){return I(this,Ks)}set camera(e){e instanceof Yo&&(X(this,Ae,e),I(this,Be)&&I(this,Be).composer.setMainCamera(e))}get renderer(){return I(this,re)}get controls(){return I(this,Ye)}get domElement(){return I(this,Nt)}get ambientLight(){return I(this,kt)}get directionLight(){return I(this,Ut)}get postprocessing(){return I(this,Be)}set cache(e){Al.enabled=e}get renderEnabled(){return I(this,wt)}setDefaultLight(e){e._add(I(this,kt).clone(),I(this,Ut).clone())}initComposer(){X(this,Be,new Yh(I(this,re),I(this,xe),I(this,Ae))),this.postprocessing.hueSaturationEffect.saturation=.25,this.postprocessing.brightnessContrastEffect.contrast=.25,I(this,xt).set(Symbol(),I(this,Be).resize)}initStats(){X(this,ds,new Us),document.body.appendChild(I(this,ds).dom),I(this,St).set(Symbol(),e=>I(e,ds).update())}initGridHelper(){const e=new ea(100);I(this,xe).add(e)}initAxesHelper(){const e=new ta(100);I(this,xe).add(e)}animate(){X(this,fs,requestAnimationFrame(this.animate.bind(this))),this.delta=this.clock.getDelta(),this.elapsedTime=this.clock.getElapsedTime(),I(this,St).forEach(e=>e(this)),I(this,re).info.reset(),this.render()}logMemory(){console.log(I(this,re).info.memory.geometries,I(this,re).info.memory.textures)}render(){I(this,Be)?I(this,Be).composer.render():(I(this,re).autoClear=!0,I(this,re).render(I(this,xe),I(this,Ae))),I(this,zt).update(this)}stopRender(){cancelAnimationFrame(I(this,fs)),X(this,wt,!1),this.controls.enabled=!1}beginRender(){I(this,wt)||(this.animate(),this.controls.enabled=!0,X(this,wt,!0))}}xe=new WeakMap,re=new WeakMap,Ae=new WeakMap,Ks=new WeakMap,Ye=new WeakMap,Nt=new WeakMap,Be=new WeakMap,wt=new WeakMap,kt=new WeakMap,Ut=new WeakMap,ds=new WeakMap,xt=new WeakMap,St=new WeakMap,zt=new WeakMap,fs=new WeakMap,Ni=new WeakSet,Ea=function(){const e=new Jn(16777215,.55),t=new as(16777215,3);t.shadow.camera.near=1,t.shadow.camera.far=1500,t.shadow.camera.right=500,t.shadow.camera.left=-500,t.shadow.camera.top=500,t.shadow.camera.bottom=-500,t.shadow.mapSize.width=Math.pow(2,13),t.shadow.mapSize.height=Math.pow(2,13),t.shadow.blurSamples=16,t.shadow.bias=-25e-5,t.position.set(30,385,585),t.castShadow=!0,X(this,kt,e),I(this,xe).add(I(this,kt)),new er(t.shadow.camera),new Ri(t),X(this,Ut,t),I(this,xe).add(I(this,Ut))};var Tt;class tu extends eu{constructor(t){super(t);Y(this,Tt);X(this,Tt,new Map)}addEventListener(t){const s=I(this,Tt).get(t)||[],n=a=>{sa().length>0||s.forEach(l=>l(a,this))},r=()=>{window.removeEventListener(t,n),s.length=0,I(this,Tt).delete(t)},o=a=>s.indexOf(a)!==-1?()=>{const c=s.indexOf(a);s.splice(c,1)}:(s.push(a),()=>{const c=s.indexOf(a);s.splice(c,1),s.length===0&&r()});return I(this,Tt).has(t)||(I(this,Tt).set(t,s),window.addEventListener(t,n)),{add:o,clear:r}}}Tt=new WeakMap;class rr extends pe{constructor(e=document.createElement("div")){super(),this.isCSS2DObject=!0,this.element=e,this.element.style.position="absolute",this.element.style.userSelect="none",this.element.setAttribute("draggable",!1),this.center=new k(.5,.5),this.addEventListener("removed",function(){this.traverse(function(t){t.element instanceof Element&&t.element.parentNode!==null&&t.element.parentNode.removeChild(t.element)})})}copy(e,t){return super.copy(e,t),this.element=e.element.cloneNode(!0),this.center=e.center,this}}const Kt=new _,Wr=new oe,Kr=new oe,Xr=new _,Yr=new _;class su{constructor(e={}){const t=this;let s,n,r,o;const a={objects:new WeakMap},l=e.element!==void 0?e.element:document.createElement("div");l.style.overflow="hidden",this.domElement=l,this.getSize=function(){return{width:s,height:n}},this.render=function(f,m){f.matrixWorldAutoUpdate===!0&&f.updateMatrixWorld(),m.parent===null&&m.matrixWorldAutoUpdate===!0&&m.updateMatrixWorld(),Wr.copy(m.matrixWorldInverse),Kr.multiplyMatrices(m.projectionMatrix,Wr),c(f,f,m),u(f)},this.setSize=function(f,m){s=f,n=m,r=s/2,o=n/2,l.style.width=f+"px",l.style.height=m+"px"};function c(f,m,y){if(f.isCSS2DObject){Kt.setFromMatrixPosition(f.matrixWorld),Kt.applyMatrix4(Kr);const p=f.visible===!0&&Kt.z>=-1&&Kt.z<=1&&f.layers.test(y.layers)===!0;if(f.element.style.display=p===!0?"":"none",p===!0){f.onBeforeRender(t,m,y);const v=f.element;v.style.transform="translate("+-100*f.center.x+"%,"+-100*f.center.y+"%)translate("+(Kt.x*r+r)+"px,"+(-Kt.y*o+o)+"px)",v.parentNode!==l&&l.appendChild(v),f.onAfterRender(t,m,y)}const g={distanceToCameraSquared:d(y,f)};a.objects.set(f,g)}for(let p=0,g=f.children.length;p<g;p++)c(f.children[p],m,y)}function d(f,m){return Xr.setFromMatrixPosition(f.matrixWorld),Yr.setFromMatrixPosition(m.matrixWorld),Xr.distanceToSquared(Yr)}function h(f){const m=[];return f.traverse(function(y){y.isCSS2DObject&&m.push(y)}),m}function u(f){const m=h(f).sort(function(p,g){if(p.renderOrder!==g.renderOrder)return g.renderOrder-p.renderOrder;const v=a.objects.get(p).distanceToCameraSquared,w=a.objects.get(g).distanceToCameraSquared;return v-w}),y=m.length;for(let p=0,g=m.length;p<g;p++)m[p].element.style.zIndex=y-p}}}const $r=new _,iu=new Vs,Zr=new _,We=new oe,nu=new oe;class ru{constructor(e={}){const t=this;let s,n,r,o;const a={camera:{style:""},objects:new WeakMap},l=e.element!==void 0?e.element:document.createElement("div");l.style.overflow="hidden",this.domElement=l;const c=document.createElement("div");c.style.transformOrigin="0 0",c.style.pointerEvents="none",l.appendChild(c);const d=document.createElement("div");d.style.transformStyle="preserve-3d",c.appendChild(d),this.getSize=function(){return{width:s,height:n}},this.render=function(y,p){const g=p.projectionMatrix.elements[5]*o;p.view&&p.view.enabled?(c.style.transform=`translate( ${-p.view.offsetX*(s/p.view.width)}px, ${-p.view.offsetY*(n/p.view.height)}px )`,c.style.transform+=`scale( ${p.view.fullWidth/p.view.width}, ${p.view.fullHeight/p.view.height} )`):c.style.transform="",y.matrixWorldAutoUpdate===!0&&y.updateMatrixWorld(),p.parent===null&&p.matrixWorldAutoUpdate===!0&&p.updateMatrixWorld();let v,w;p.isOrthographicCamera&&(v=-(p.right+p.left)/2,w=(p.top+p.bottom)/2);const b=p.view&&p.view.enabled?p.view.height/p.view.fullHeight:1,x=p.isOrthographicCamera?`scale( ${b} )scale(`+g+")translate("+h(v)+"px,"+h(w)+"px)"+u(p.matrixWorldInverse):`scale( ${b} )translateZ(`+g+"px)"+u(p.matrixWorldInverse),A=(p.isPerspectiveCamera?"perspective("+g+"px) ":"")+x+"translate("+r+"px,"+o+"px)";a.camera.style!==A&&(d.style.transform=A,a.camera.style=A),m(y,y,p)},this.setSize=function(y,p){s=y,n=p,r=s/2,o=n/2,l.style.width=y+"px",l.style.height=p+"px",c.style.width=y+"px",c.style.height=p+"px",d.style.width=y+"px",d.style.height=p+"px"};function h(y){return Math.abs(y)<1e-10?0:y}function u(y){const p=y.elements;return"matrix3d("+h(p[0])+","+h(-p[1])+","+h(p[2])+","+h(p[3])+","+h(p[4])+","+h(-p[5])+","+h(p[6])+","+h(p[7])+","+h(p[8])+","+h(-p[9])+","+h(p[10])+","+h(p[11])+","+h(p[12])+","+h(-p[13])+","+h(p[14])+","+h(p[15])+")"}function f(y){const p=y.elements;return"translate(-50%,-50%)"+("matrix3d("+h(p[0])+","+h(p[1])+","+h(p[2])+","+h(p[3])+","+h(-p[4])+","+h(-p[5])+","+h(-p[6])+","+h(-p[7])+","+h(p[8])+","+h(p[9])+","+h(p[10])+","+h(p[11])+","+h(p[12])+","+h(p[13])+","+h(p[14])+","+h(p[15])+")")}function m(y,p,g,v){if(y.isCSS3DObject){const w=y.visible===!0&&y.layers.test(g.layers)===!0;if(y.element.style.display=w===!0?"":"none",w===!0){y.onBeforeRender(t,p,g);let b;y.isCSS3DSprite?(We.copy(g.matrixWorldInverse),We.transpose(),y.rotation2D!==0&&We.multiply(nu.makeRotationZ(y.rotation2D)),y.matrixWorld.decompose($r,iu,Zr),We.setPosition($r),We.scale(Zr),We.elements[3]=0,We.elements[7]=0,We.elements[11]=0,We.elements[15]=1,b=f(We)):b=f(y.matrixWorld);const x=y.element,M=a.objects.get(y);if(M===void 0||M.style!==b){x.style.transform=b;const A={style:b};a.objects.set(y,A)}x.parentNode!==d&&d.appendChild(x),y.onAfterRender(t,p,g)}}for(let w=0,b=y.children.length;w<b;w++)m(y.children[w],p,g)}}}class ou{constructor(e,t){N(this,"raycaster");N(this,"camera");N(this,"element");N(this,"mouse");N(this,"intersects");N(this,"callbackMap");N(this,"getIntersects",(e,t,s)=>{if(sa().length>0||!this.getState(s))return;this.intersects.length=0;const{left:n,top:r,width:o,height:a}=this.element.getBoundingClientRect();this.mouse.x=(e.clientX-n)/o*2-1,this.mouse.y=-((e.clientY-r)/a)*2+1,this.raycaster.setFromCamera(this.mouse,this.camera),Array.isArray(t)?this.raycaster.intersectObjects(t,!0,this.intersects):this.raycaster.intersectObject(t,!0,this.intersects);const l=this.intersects.filter(c=>c.object.visible);this.callbackMap.get(t)[s].forEach(c=>c(l,e))});this.raycaster=new Li,this.mouse=new k,this.camera=e,this.element=t,this.intersects=[],this.callbackMap=new Map,this._eventListeners=new Map,this.stateMap=new Map}set(e,t){this.camera=e,this.element=t}raycast(e,t,s){if(s){if(this.exist(t,e)){const n=this.callbackMap.get(t)[e];n.indexOf(s)===-1&&n.push(s)}else if(this.handleEvent(t,e,s),this.callbackMap.has(t)){const n=this.callbackMap.get(t);n[e]=n[e]||[],n[e].push(s)}else this.callbackMap.set(t,{[e]:[s]});return{clear:()=>this.clear(t,e,s),intersects:this.intersects}}}exist(e,t){return!!(this.callbackMap.has(e)&&this.callbackMap.get(e)[t])}handleEvent(e,t){const s=r=>this.getIntersects(r,e,t),n=()=>{this.element.removeEventListener(t,s)};if(this._eventListeners.has(e)){const r=this._eventListeners.get(e);r[t]=n}else this._eventListeners.set(e,{[t]:n});this.element.addEventListener(t,s)}clear(e,t,s){if(this.callbackMap.has(e)){const r=this.callbackMap.get(e),o=r[t],a=o.indexOf(s);if(a===-1)return;o.splice(a,1),o.length===0&&delete r[t],Reflect.ownKeys(r).length===0&&this.callbackMap.delete(e),this.intersects.length=0}const n=this._eventListeners.get(e);this.exist(e,t)||(n[t](),delete n[t]),Reflect.ownKeys(n).length===0&&this._eventListeners.delete(e)}setState(e,t){this.stateMap.set(e,t)}getState(e){return this.stateMap.has(e)?this.stateMap.get(e):!0}}const Aa=0,au=1,lu=2,Qr=2,on=1.25,Jr=1,Ti=6*4+4+4,qi=65535,cu=Math.pow(2,-24),an=Symbol("SKIP_GENERATION");function hu(i){return i.index?i.index.count:i.attributes.position.count}function Ss(i){return hu(i)/3}function uu(i,e=ArrayBuffer){return i>65535?new Uint32Array(new e(4*i)):new Uint16Array(new e(2*i))}function du(i,e){if(!i.index){const t=i.attributes.position.count,s=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,n=uu(t,s);i.setIndex(new se(n,1));for(let r=0;r<t;r++)n[r]=r}}function Ma(i){const e=Ss(i),t=i.drawRange,s=t.start/3,n=(t.start+t.count)/3,r=Math.max(0,s),o=Math.min(e,n)-r;return[{offset:Math.floor(r),count:Math.floor(o)}]}function _a(i){if(!i.groups||!i.groups.length)return Ma(i);const e=[],t=new Set,s=i.drawRange,n=s.start/3,r=(s.start+s.count)/3;for(const a of i.groups){const l=a.start/3,c=(a.start+a.count)/3;t.add(Math.max(n,l)),t.add(Math.min(r,c))}const o=Array.from(t.values()).sort((a,l)=>a-l);for(let a=0;a<o.length-1;a++){const l=o[a],c=o[a+1];e.push({offset:Math.floor(l),count:Math.floor(c-l)})}return e}function fu(i){if(i.groups.length===0)return!1;const e=Ss(i),t=_a(i).sort((r,o)=>r.offset-o.offset),s=t[t.length-1];s.count=Math.min(e-s.offset,s.count);let n=0;return t.forEach(({count:r})=>n+=r),e!==n}function ie(i,e,t){return t.min.x=e[i],t.min.y=e[i+1],t.min.z=e[i+2],t.max.x=e[i+3],t.max.y=e[i+4],t.max.z=e[i+5],t}function pu(i){i[0]=i[1]=i[2]=1/0,i[3]=i[4]=i[5]=-1/0}function eo(i){let e=-1,t=-1/0;for(let s=0;s<3;s++){const n=i[s+3]-i[s];n>t&&(t=n,e=s)}return e}function to(i,e){e.set(i)}function so(i,e,t){let s,n;for(let r=0;r<3;r++){const o=r+3;s=i[r],n=e[r],t[r]=s<n?s:n,s=i[o],n=e[o],t[o]=s>n?s:n}}function ii(i,e,t){for(let s=0;s<3;s++){const n=e[i+2*s],r=e[i+2*s+1],o=n-r,a=n+r;o<t[s]&&(t[s]=o),a>t[s+3]&&(t[s+3]=a)}}function Cs(i){const e=i[3]-i[0],t=i[4]-i[1],s=i[5]-i[2];return 2*(e*t+t*s+s*e)}function ln(i,e,t,s,n=null){let r=1/0,o=1/0,a=1/0,l=-1/0,c=-1/0,d=-1/0,h=1/0,u=1/0,f=1/0,m=-1/0,y=-1/0,p=-1/0;const g=n!==null;for(let v=e*6,w=(e+t)*6;v<w;v+=6){const b=i[v+0],x=i[v+1],M=b-x,A=b+x;M<r&&(r=M),A>l&&(l=A),g&&b<h&&(h=b),g&&b>m&&(m=b);const T=i[v+2],E=i[v+3],P=T-E,L=T+E;P<o&&(o=P),L>c&&(c=L),g&&T<u&&(u=T),g&&T>y&&(y=T);const C=i[v+4],D=i[v+5],R=C-D,O=C+D;R<a&&(a=R),O>d&&(d=O),g&&C<f&&(f=C),g&&C>p&&(p=C)}s[0]=r,s[1]=o,s[2]=a,s[3]=l,s[4]=c,s[5]=d,g&&(n[0]=h,n[1]=u,n[2]=f,n[3]=m,n[4]=y,n[5]=p)}function mu(i,e,t,s){let n=1/0,r=1/0,o=1/0,a=-1/0,l=-1/0,c=-1/0;for(let d=e*6,h=(e+t)*6;d<h;d+=6){const u=i[d+0];u<n&&(n=u),u>a&&(a=u);const f=i[d+2];f<r&&(r=f),f>l&&(l=f);const m=i[d+4];m<o&&(o=m),m>c&&(c=m)}s[0]=n,s[1]=r,s[2]=o,s[3]=a,s[4]=l,s[5]=c}function gu(i,e){pu(e);const t=i.attributes.position,s=i.index?i.index.array:null,n=Ss(i),r=new Float32Array(n*6),o=t.normalized,a=t.array,l=t.offset||0;let c=3;t.isInterleavedBufferAttribute&&(c=t.data.stride);const d=["getX","getY","getZ"];for(let h=0;h<n;h++){const u=h*3,f=h*6;let m=u+0,y=u+1,p=u+2;s&&(m=s[m],y=s[y],p=s[p]),o||(m=m*c+l,y=y*c+l,p=p*c+l);for(let g=0;g<3;g++){let v,w,b;o?(v=t[d[g]](m),w=t[d[g]](y),b=t[d[g]](p)):(v=a[m+g],w=a[y+g],b=a[p+g]);let x=v;w<x&&(x=w),b<x&&(x=b);let M=v;w>M&&(M=w),b>M&&(M=b);const A=(M-x)/2,T=g*2;r[f+T+0]=x+A,r[f+T+1]=A+(Math.abs(x)+A)*cu,x<e[g]&&(e[g]=x),M>e[g+3]&&(e[g+3]=M)}}return r}const nt=32,yu=(i,e)=>i.candidate-e.candidate,mt=new Array(nt).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),ni=new Float32Array(6);function vu(i,e,t,s,n,r){let o=-1,a=0;if(r===Aa)o=eo(e),o!==-1&&(a=(e[o]+e[o+3])/2);else if(r===au)o=eo(i),o!==-1&&(a=bu(t,s,n,o));else if(r===lu){const l=Cs(i);let c=on*n;const d=s*6,h=(s+n)*6;for(let u=0;u<3;u++){const f=e[u],p=(e[u+3]-f)/nt;if(n<nt/4){const g=[...mt];g.length=n;let v=0;for(let b=d;b<h;b+=6,v++){const x=g[v];x.candidate=t[b+2*u],x.count=0;const{bounds:M,leftCacheBounds:A,rightCacheBounds:T}=x;for(let E=0;E<3;E++)T[E]=1/0,T[E+3]=-1/0,A[E]=1/0,A[E+3]=-1/0,M[E]=1/0,M[E+3]=-1/0;ii(b,t,M)}g.sort(yu);let w=n;for(let b=0;b<w;b++){const x=g[b];for(;b+1<w&&g[b+1].candidate===x.candidate;)g.splice(b+1,1),w--}for(let b=d;b<h;b+=6){const x=t[b+2*u];for(let M=0;M<w;M++){const A=g[M];x>=A.candidate?ii(b,t,A.rightCacheBounds):(ii(b,t,A.leftCacheBounds),A.count++)}}for(let b=0;b<w;b++){const x=g[b],M=x.count,A=n-x.count,T=x.leftCacheBounds,E=x.rightCacheBounds;let P=0;M!==0&&(P=Cs(T)/l);let L=0;A!==0&&(L=Cs(E)/l);const C=Jr+on*(P*M+L*A);C<c&&(o=u,c=C,a=x.candidate)}}else{for(let w=0;w<nt;w++){const b=mt[w];b.count=0,b.candidate=f+p+w*p;const x=b.bounds;for(let M=0;M<3;M++)x[M]=1/0,x[M+3]=-1/0}for(let w=d;w<h;w+=6){let M=~~((t[w+2*u]-f)/p);M>=nt&&(M=nt-1);const A=mt[M];A.count++,ii(w,t,A.bounds)}const g=mt[nt-1];to(g.bounds,g.rightCacheBounds);for(let w=nt-2;w>=0;w--){const b=mt[w],x=mt[w+1];so(b.bounds,x.rightCacheBounds,b.rightCacheBounds)}let v=0;for(let w=0;w<nt-1;w++){const b=mt[w],x=b.count,M=b.bounds,T=mt[w+1].rightCacheBounds;x!==0&&(v===0?to(M,ni):so(M,ni,ni)),v+=x;let E=0,P=0;v!==0&&(E=Cs(ni)/l);const L=n-v;L!==0&&(P=Cs(T)/l);const C=Jr+on*(E*v+P*L);C<c&&(o=u,c=C,a=b.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${r} used.`);return{axis:o,pos:a}}function bu(i,e,t,s){let n=0;for(let r=e,o=e+t;r<o;r++)n+=i[r*6+s*2];return n/t}class ri{constructor(){}}function wu(i,e,t,s,n,r){let o=s,a=s+n-1;const l=r.pos,c=r.axis*2;for(;;){for(;o<=a&&t[o*6+c]<l;)o++;for(;o<=a&&t[a*6+c]>=l;)a--;if(o<a){for(let d=0;d<3;d++){let h=e[o*3+d];e[o*3+d]=e[a*3+d],e[a*3+d]=h}for(let d=0;d<6;d++){let h=t[o*6+d];t[o*6+d]=t[a*6+d],t[a*6+d]=h}o++,a--}else return o}}function xu(i,e,t,s,n,r){let o=s,a=s+n-1;const l=r.pos,c=r.axis*2;for(;;){for(;o<=a&&t[o*6+c]<l;)o++;for(;o<=a&&t[a*6+c]>=l;)a--;if(o<a){let d=i[o];i[o]=i[a],i[a]=d;for(let h=0;h<6;h++){let u=t[o*6+h];t[o*6+h]=t[a*6+h],t[a*6+h]=u}o++,a--}else return o}}function Su(i,e){const t=(i.index?i.index.count:i.attributes.position.count)/3,s=t>2**16,n=s?4:2,r=e?new SharedArrayBuffer(t*n):new ArrayBuffer(t*n),o=s?new Uint32Array(r):new Uint16Array(r);for(let a=0,l=o.length;a<l;a++)o[a]=a;return o}function Tu(i,e){const t=i.geometry,s=t.index?t.index.array:null,n=e.maxDepth,r=e.verbose,o=e.maxLeafTris,a=e.strategy,l=e.onProgress,c=Ss(t),d=i._indirectBuffer;let h=!1;const u=new Float32Array(6),f=new Float32Array(6),m=gu(t,u),y=e.indirect?xu:wu,p=[],g=e.indirect?Ma(t):_a(t);if(g.length===1){const b=g[0],x=new ri;x.boundingData=u,mu(m,b.offset,b.count,f),w(x,b.offset,b.count,f),p.push(x)}else for(let b of g){const x=new ri;x.boundingData=new Float32Array(6),ln(m,b.offset,b.count,x.boundingData,f),w(x,b.offset,b.count,f),p.push(x)}return p;function v(b){l&&l(b/c)}function w(b,x,M,A=null,T=0){if(!h&&T>=n&&(h=!0,r&&(console.warn(`MeshBVH: Max depth of ${n} reached when generating BVH. Consider increasing maxDepth.`),console.warn(t))),M<=o||T>=n)return v(x+M),b.offset=x,b.count=M,b;const E=vu(b.boundingData,A,m,x,M,a);if(E.axis===-1)return v(x+M),b.offset=x,b.count=M,b;const P=y(d,s,m,x,M,E);if(P===x||P===x+M)v(x+M),b.offset=x,b.count=M;else{b.splitAxis=E.axis;const L=new ri,C=x,D=P-x;b.left=L,L.boundingData=new Float32Array(6),ln(m,C,D,L.boundingData,f),w(L,C,D,f,T+1);const R=new ri,O=P,B=M-D;b.right=R,R.boundingData=new Float32Array(6),ln(m,O,B,R.boundingData,f),w(R,O,B,f,T+1)}return b}}function Eu(i,e){const t=i.geometry;e.indirect&&(i._indirectBuffer=Su(t,e.useSharedArrayBuffer),fu(t)&&!e.verbose&&console.warn('MeshBVH: Provided geometry contains groups that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),i._indirectBuffer||du(t,e);const s=Tu(i,e);let n,r,o;const a=[],l=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;for(let h=0;h<s.length;h++){const u=s[h];let f=c(u);const m=new l(Ti*f);n=new Float32Array(m),r=new Uint32Array(m),o=new Uint16Array(m),d(0,u),a.push(m)}i._roots=a;return;function c(h){return h.count?1:1+c(h.left)+c(h.right)}function d(h,u){const f=h/4,m=h/2,y=!!u.count,p=u.boundingData;for(let g=0;g<6;g++)n[f+g]=p[g];if(y){const g=u.offset,v=u.count;return r[f+6]=g,o[m+14]=v,o[m+15]=qi,h+Ti}else{const g=u.left,v=u.right,w=u.splitAxis;let b;if(b=d(h+Ti,g),b/4>Math.pow(2,32))throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return r[f+6]=b/4,b=d(b,v),r[f+7]=w,b}}}class ht{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,t){let s=1/0,n=-1/0;for(let r=0,o=e.length;r<o;r++){const l=e[r][t];s=l<s?l:s,n=l>n?l:n}this.min=s,this.max=n}setFromPoints(e,t){let s=1/0,n=-1/0;for(let r=0,o=t.length;r<o;r++){const a=t[r],l=e.dot(a);s=l<s?l:s,n=l>n?l:n}this.min=s,this.max=n}isSeparated(e){return this.min>e.max||e.min>this.max}}ht.prototype.setFromBox=function(){const i=new _;return function(t,s){const n=s.min,r=s.max;let o=1/0,a=-1/0;for(let l=0;l<=1;l++)for(let c=0;c<=1;c++)for(let d=0;d<=1;d++){i.x=n.x*l+r.x*(1-l),i.y=n.y*c+r.y*(1-c),i.z=n.z*d+r.z*(1-d);const h=t.dot(i);o=Math.min(h,o),a=Math.max(h,a)}this.min=o,this.max=a}}();const Au=function(){const i=new _,e=new _,t=new _;return function(n,r,o){const a=n.start,l=i,c=r.start,d=e;t.subVectors(a,c),i.subVectors(n.end,n.start),e.subVectors(r.end,r.start);const h=t.dot(d),u=d.dot(l),f=d.dot(d),m=t.dot(l),p=l.dot(l)*f-u*u;let g,v;p!==0?g=(h*u-m*f)/p:g=0,v=(h+g*u)/f,o.x=g,o.y=v}}(),or=function(){const i=new k,e=new _,t=new _;return function(n,r,o,a){Au(n,r,i);let l=i.x,c=i.y;if(l>=0&&l<=1&&c>=0&&c<=1){n.at(l,o),r.at(c,a);return}else if(l>=0&&l<=1){c<0?r.at(0,a):r.at(1,a),n.closestPointToPoint(a,!0,o);return}else if(c>=0&&c<=1){l<0?n.at(0,o):n.at(1,o),r.closestPointToPoint(o,!0,a);return}else{let d;l<0?d=n.start:d=n.end;let h;c<0?h=r.start:h=r.end;const u=e,f=t;if(n.closestPointToPoint(h,!0,e),r.closestPointToPoint(d,!0,t),u.distanceToSquared(h)<=f.distanceToSquared(d)){o.copy(u),a.copy(h);return}else{o.copy(d),a.copy(f);return}}}}(),Mu=function(){const i=new _,e=new _,t=new Zn,s=new Qe;return function(r,o){const{radius:a,center:l}=r,{a:c,b:d,c:h}=o;if(s.start=c,s.end=d,s.closestPointToPoint(l,!0,i).distanceTo(l)<=a||(s.start=c,s.end=h,s.closestPointToPoint(l,!0,i).distanceTo(l)<=a)||(s.start=d,s.end=h,s.closestPointToPoint(l,!0,i).distanceTo(l)<=a))return!0;const y=o.getPlane(t);if(Math.abs(y.distanceToPoint(l))<=a){const g=y.projectPoint(l,e);if(o.containsPoint(g))return!0}return!1}}(),_u=1e-15;function cn(i){return Math.abs(i)<_u}class qe extends Fs{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new _),this.satBounds=new Array(4).fill().map(()=>new ht),this.points=[this.a,this.b,this.c],this.sphere=new xs,this.plane=new Zn,this.needsUpdate=!0}intersectsSphere(e){return Mu(e,this)}update(){const e=this.a,t=this.b,s=this.c,n=this.points,r=this.satAxes,o=this.satBounds,a=r[0],l=o[0];this.getNormal(a),l.setFromPoints(a,n);const c=r[1],d=o[1];c.subVectors(e,t),d.setFromPoints(c,n);const h=r[2],u=o[2];h.subVectors(t,s),u.setFromPoints(h,n);const f=r[3],m=o[3];f.subVectors(s,e),m.setFromPoints(f,n),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(a,e),this.needsUpdate=!1}}qe.prototype.closestPointToSegment=function(){const i=new _,e=new _,t=new Qe;return function(n,r=null,o=null){const{start:a,end:l}=n,c=this.points;let d,h=1/0;for(let u=0;u<3;u++){const f=(u+1)%3;t.start.copy(c[u]),t.end.copy(c[f]),or(t,n,i,e),d=i.distanceToSquared(e),d<h&&(h=d,r&&r.copy(i),o&&o.copy(e))}return this.closestPointToPoint(a,i),d=a.distanceToSquared(i),d<h&&(h=d,r&&r.copy(i),o&&o.copy(a)),this.closestPointToPoint(l,i),d=l.distanceToSquared(i),d<h&&(h=d,r&&r.copy(i),o&&o.copy(l)),Math.sqrt(h)}}();qe.prototype.intersectsTriangle=function(){const i=new qe,e=new Array(3),t=new Array(3),s=new ht,n=new ht,r=new _,o=new _,a=new _,l=new _,c=new _,d=new Qe,h=new Qe,u=new Qe,f=new _;function m(y,p,g){const v=y.points;let w=0,b=-1;for(let x=0;x<3;x++){const{start:M,end:A}=d;M.copy(v[x]),A.copy(v[(x+1)%3]),d.delta(o);const T=cn(p.distanceToPoint(M));if(cn(p.normal.dot(o))&&T){g.copy(d),w=2;break}const E=p.intersectLine(d,f);if(!E&&T&&f.copy(M),(E||T)&&!cn(f.distanceTo(A))){if(w<=1)(w===1?g.start:g.end).copy(f),T&&(b=w);else if(w>=2){(b===1?g.start:g.end).copy(f),w=2;break}if(w++,w===2&&b===-1)break}}return w}return function(p,g=null,v=!1){this.needsUpdate&&this.update(),p.isExtendedTriangle?p.needsUpdate&&p.update():(i.copy(p),i.update(),p=i);const w=this.plane,b=p.plane;if(Math.abs(w.normal.dot(b.normal))>1-1e-10){const x=this.satBounds,M=this.satAxes;t[0]=p.a,t[1]=p.b,t[2]=p.c;for(let E=0;E<4;E++){const P=x[E],L=M[E];if(s.setFromPoints(L,t),P.isSeparated(s))return!1}const A=p.satBounds,T=p.satAxes;e[0]=this.a,e[1]=this.b,e[2]=this.c;for(let E=0;E<4;E++){const P=A[E],L=T[E];if(s.setFromPoints(L,e),P.isSeparated(s))return!1}for(let E=0;E<4;E++){const P=M[E];for(let L=0;L<4;L++){const C=T[L];if(r.crossVectors(P,C),s.setFromPoints(r,e),n.setFromPoints(r,t),s.isSeparated(n))return!1}}return g&&(v||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),g.start.set(0,0,0),g.end.set(0,0,0)),!0}else{const x=m(this,b,h);if(x===1&&p.containsPoint(h.end))return g&&(g.start.copy(h.end),g.end.copy(h.end)),!0;if(x!==2)return!1;const M=m(p,w,u);if(M===1&&this.containsPoint(u.end))return g&&(g.start.copy(u.end),g.end.copy(u.end)),!0;if(M!==2)return!1;if(h.delta(a),u.delta(l),a.dot(l)<0){let D=u.start;u.start=u.end,u.end=D}const A=h.start.dot(a),T=h.end.dot(a),E=u.start.dot(a),P=u.end.dot(a),L=T<E,C=A<P;return A!==P&&E!==T&&L===C?!1:(g&&(c.subVectors(h.start,u.start),c.dot(a)>0?g.start.copy(h.start):g.start.copy(u.start),c.subVectors(h.end,u.end),c.dot(a)<0?g.end.copy(h.end):g.end.copy(u.end)),!0)}}}();qe.prototype.distanceToPoint=function(){const i=new _;return function(t){return this.closestPointToPoint(t,i),t.distanceTo(i)}}();qe.prototype.distanceToTriangle=function(){const i=new _,e=new _,t=["a","b","c"],s=new Qe,n=new Qe;return function(o,a=null,l=null){const c=a||l?s:null;if(this.intersectsTriangle(o,c))return(a||l)&&(a&&c.getCenter(a),l&&c.getCenter(l)),0;let d=1/0;for(let h=0;h<3;h++){let u;const f=t[h],m=o[f];this.closestPointToPoint(m,i),u=m.distanceToSquared(i),u<d&&(d=u,a&&a.copy(i),l&&l.copy(m));const y=this[f];o.closestPointToPoint(y,i),u=y.distanceToSquared(i),u<d&&(d=u,a&&a.copy(y),l&&l.copy(i))}for(let h=0;h<3;h++){const u=t[h],f=t[(h+1)%3];s.set(this[u],this[f]);for(let m=0;m<3;m++){const y=t[m],p=t[(m+1)%3];n.set(o[y],o[p]),or(s,n,i,e);const g=i.distanceToSquared(e);g<d&&(d=g,a&&a.copy(i),l&&l.copy(e))}}return Math.sqrt(d)}}();class Te{constructor(e,t,s){this.isOrientedBox=!0,this.min=new _,this.max=new _,this.matrix=new oe,this.invMatrix=new oe,this.points=new Array(8).fill().map(()=>new _),this.satAxes=new Array(3).fill().map(()=>new _),this.satBounds=new Array(3).fill().map(()=>new ht),this.alignedSatBounds=new Array(3).fill().map(()=>new ht),this.needsUpdate=!1,e&&this.min.copy(e),t&&this.max.copy(t),s&&this.matrix.copy(s)}set(e,t,s){this.min.copy(e),this.max.copy(t),this.matrix.copy(s),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}}Te.prototype.update=function(){return function(){const e=this.matrix,t=this.min,s=this.max,n=this.points;for(let c=0;c<=1;c++)for(let d=0;d<=1;d++)for(let h=0;h<=1;h++){const u=1*c|2*d|4*h,f=n[u];f.x=c?s.x:t.x,f.y=d?s.y:t.y,f.z=h?s.z:t.z,f.applyMatrix4(e)}const r=this.satBounds,o=this.satAxes,a=n[0];for(let c=0;c<3;c++){const d=o[c],h=r[c],u=1<<c,f=n[u];d.subVectors(a,f),h.setFromPoints(d,n)}const l=this.alignedSatBounds;l[0].setFromPointsField(n,"x"),l[1].setFromPointsField(n,"y"),l[2].setFromPointsField(n,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}}();Te.prototype.intersectsBox=function(){const i=new ht;return function(t){this.needsUpdate&&this.update();const s=t.min,n=t.max,r=this.satBounds,o=this.satAxes,a=this.alignedSatBounds;if(i.min=s.x,i.max=n.x,a[0].isSeparated(i)||(i.min=s.y,i.max=n.y,a[1].isSeparated(i))||(i.min=s.z,i.max=n.z,a[2].isSeparated(i)))return!1;for(let l=0;l<3;l++){const c=o[l],d=r[l];if(i.setFromBox(c,t),d.isSeparated(i))return!1}return!0}}();Te.prototype.intersectsTriangle=function(){const i=new qe,e=new Array(3),t=new ht,s=new ht,n=new _;return function(o){this.needsUpdate&&this.update(),o.isExtendedTriangle?o.needsUpdate&&o.update():(i.copy(o),i.update(),o=i);const a=this.satBounds,l=this.satAxes;e[0]=o.a,e[1]=o.b,e[2]=o.c;for(let u=0;u<3;u++){const f=a[u],m=l[u];if(t.setFromPoints(m,e),f.isSeparated(t))return!1}const c=o.satBounds,d=o.satAxes,h=this.points;for(let u=0;u<3;u++){const f=c[u],m=d[u];if(t.setFromPoints(m,h),f.isSeparated(t))return!1}for(let u=0;u<3;u++){const f=l[u];for(let m=0;m<4;m++){const y=d[m];if(n.crossVectors(f,y),t.setFromPoints(n,e),s.setFromPoints(n,h),t.isSeparated(s))return!1}}return!0}}();Te.prototype.closestPointToPoint=function(){return function(e,t){return this.needsUpdate&&this.update(),t.copy(e).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),t}}();Te.prototype.distanceToPoint=function(){const i=new _;return function(t){return this.closestPointToPoint(t,i),t.distanceTo(i)}}();Te.prototype.distanceToBox=function(){const i=["x","y","z"],e=new Array(12).fill().map(()=>new Qe),t=new Array(12).fill().map(()=>new Qe),s=new _,n=new _;return function(o,a=0,l=null,c=null){if(this.needsUpdate&&this.update(),this.intersectsBox(o))return(l||c)&&(o.getCenter(n),this.closestPointToPoint(n,s),o.closestPointToPoint(s,n),l&&l.copy(s),c&&c.copy(n)),0;const d=a*a,h=o.min,u=o.max,f=this.points;let m=1/0;for(let p=0;p<8;p++){const g=f[p];n.copy(g).clamp(h,u);const v=g.distanceToSquared(n);if(v<m&&(m=v,l&&l.copy(g),c&&c.copy(n),v<d))return Math.sqrt(v)}let y=0;for(let p=0;p<3;p++)for(let g=0;g<=1;g++)for(let v=0;v<=1;v++){const w=(p+1)%3,b=(p+2)%3,x=g<<w|v<<b,M=1<<p|g<<w|v<<b,A=f[x],T=f[M];e[y].set(A,T);const P=i[p],L=i[w],C=i[b],D=t[y],R=D.start,O=D.end;R[P]=h[P],R[L]=g?h[L]:u[L],R[C]=v?h[C]:u[L],O[P]=u[P],O[L]=g?h[L]:u[L],O[C]=v?h[C]:u[L],y++}for(let p=0;p<=1;p++)for(let g=0;g<=1;g++)for(let v=0;v<=1;v++){n.x=p?u.x:h.x,n.y=g?u.y:h.y,n.z=v?u.z:h.z,this.closestPointToPoint(n,s);const w=n.distanceToSquared(s);if(w<m&&(m=w,l&&l.copy(s),c&&c.copy(n),w<d))return Math.sqrt(w)}for(let p=0;p<12;p++){const g=e[p];for(let v=0;v<12;v++){const w=t[v];or(g,w,s,n);const b=s.distanceToSquared(n);if(b<m&&(m=b,l&&l.copy(s),c&&c.copy(n),b<d))return Math.sqrt(b)}}return Math.sqrt(m)}}();class ar{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){const e=this._primitives;return e.length===0?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}class Cu extends ar{constructor(){super(()=>new qe)}}const Fe=new Cu;function Ce(i,e){return e[i+15]===65535}function Pe(i,e){return e[i+6]}function Ne(i,e){return e[i+14]}function ke(i){return i+8}function Ue(i,e){return e[i+6]}function Ca(i,e){return e[i+7]}class Pu{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const e=[];let t=null;this.setBuffer=s=>{t&&e.push(t),t=s,this.float32Array=new Float32Array(s),this.uint16Array=new Uint16Array(s),this.uint32Array=new Uint32Array(s)},this.clearBuffer=()=>{t=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,e.length!==0&&this.setBuffer(e.pop())}}}const ee=new Pu;let Et,rs;const Xt=[],oi=new ar(()=>new he);function Ru(i,e,t,s,n,r){Et=oi.getPrimitive(),rs=oi.getPrimitive(),Xt.push(Et,rs),ee.setBuffer(i._roots[e]);const o=On(0,i.geometry,t,s,n,r);ee.clearBuffer(),oi.releasePrimitive(Et),oi.releasePrimitive(rs),Xt.pop(),Xt.pop();const a=Xt.length;return a>0&&(rs=Xt[a-1],Et=Xt[a-2]),o}function On(i,e,t,s,n=null,r=0,o=0){const{float32Array:a,uint16Array:l,uint32Array:c}=ee;let d=i*2;if(Ce(d,l)){const u=Pe(i,c),f=Ne(d,l);return ie(i,a,Et),s(u,f,!1,o,r+i,Et)}else{let P=function(C){const{uint16Array:D,uint32Array:R}=ee;let O=C*2;for(;!Ce(O,D);)C=ke(C),O=C*2;return Pe(C,R)},L=function(C){const{uint16Array:D,uint32Array:R}=ee;let O=C*2;for(;!Ce(O,D);)C=Ue(C,R),O=C*2;return Pe(C,R)+Ne(O,D)};const u=ke(i),f=Ue(i,c);let m=u,y=f,p,g,v,w;if(n&&(v=Et,w=rs,ie(m,a,v),ie(y,a,w),p=n(v),g=n(w),g<p)){m=f,y=u;const C=p;p=g,g=C,v=w}v||(v=Et,ie(m,a,v));const b=Ce(m*2,l),x=t(v,b,p,o+1,r+m);let M;if(x===Qr){const C=P(m),R=L(m)-C;M=s(C,R,!0,o+1,r+m,v)}else M=x&&On(m,e,t,s,n,r,o+1);if(M)return!0;w=rs,ie(y,a,w);const A=Ce(y*2,l),T=t(w,A,g,o+1,r+y);let E;if(T===Qr){const C=P(y),R=L(y)-C;E=s(C,R,!0,o+1,r+y,w)}else E=T&&On(y,e,t,s,n,r,o+1);return!!E}}const Ps=new _,hn=new _;function Lu(i,e,t={},s=0,n=1/0){const r=s*s,o=n*n;let a=1/0,l=null;if(i.shapecast({boundsTraverseOrder:d=>(Ps.copy(e).clamp(d.min,d.max),Ps.distanceToSquared(e)),intersectsBounds:(d,h,u)=>u<a&&u<o,intersectsTriangle:(d,h)=>{d.closestPointToPoint(e,Ps);const u=e.distanceToSquared(Ps);return u<a&&(hn.copy(Ps),a=u,l=h),u<r}}),a===1/0)return null;const c=Math.sqrt(a);return t.point?t.point.copy(hn):t.point=hn.clone(),t.distance=c,t.faceIndex=l,t}const Yt=new _,$t=new _,Zt=new _,ai=new k,li=new k,ci=new k,io=new _,no=new _,ro=new _,hi=new _;function Du(i,e,t,s,n,r){let o;return r===Os?o=i.intersectTriangle(s,t,e,!0,n):o=i.intersectTriangle(e,t,s,r!==je,n),o===null?null:{distance:i.origin.distanceTo(n),point:n.clone()}}function Iu(i,e,t,s,n,r,o,a,l){Yt.fromBufferAttribute(e,r),$t.fromBufferAttribute(e,o),Zt.fromBufferAttribute(e,a);const c=Du(i,Yt,$t,Zt,hi,l);if(c){s&&(ai.fromBufferAttribute(s,r),li.fromBufferAttribute(s,o),ci.fromBufferAttribute(s,a),c.uv=Fs.getInterpolation(hi,Yt,$t,Zt,ai,li,ci,new k)),n&&(ai.fromBufferAttribute(n,r),li.fromBufferAttribute(n,o),ci.fromBufferAttribute(n,a),c.uv1=Fs.getInterpolation(hi,Yt,$t,Zt,ai,li,ci,new k)),t&&(io.fromBufferAttribute(t,r),no.fromBufferAttribute(t,o),ro.fromBufferAttribute(t,a),c.normal=Fs.getInterpolation(hi,Yt,$t,Zt,io,no,ro,new _),c.normal.dot(i.direction)>0&&c.normal.multiplyScalar(-1));const d={a:r,b:o,c:a,normal:new _,materialIndex:0};Fs.getNormal(Yt,$t,Zt,d.normal),c.face=d,c.faceIndex=r}return c}function Wi(i,e,t,s,n){const r=s*3;let o=r+0,a=r+1,l=r+2;const c=i.index;i.index&&(o=c.getX(o),a=c.getX(a),l=c.getX(l));const{position:d,normal:h,uv:u,uv1:f}=i.attributes,m=Iu(t,d,h,u,f,o,a,l,e);return m?(m.faceIndex=s,n&&n.push(m),m):null}function le(i,e,t,s){const n=i.a,r=i.b,o=i.c;let a=e,l=e+1,c=e+2;t&&(a=t.getX(a),l=t.getX(l),c=t.getX(c)),n.x=s.getX(a),n.y=s.getY(a),n.z=s.getZ(a),r.x=s.getX(l),r.y=s.getY(l),r.z=s.getZ(l),o.x=s.getX(c),o.y=s.getY(c),o.z=s.getZ(c)}function Bu(i,e,t,s,n,r){const{geometry:o,_indirectBuffer:a}=i;for(let l=s,c=s+n;l<c;l++)Wi(o,e,t,l,r)}function Ou(i,e,t,s,n){const{geometry:r,_indirectBuffer:o}=i;let a=1/0,l=null;for(let c=s,d=s+n;c<d;c++){let h;h=Wi(r,e,t,c),h&&h.distance<a&&(l=h,a=h.distance)}return l}function Fu(i,e,t,s,n,r,o){const{geometry:a}=t,{index:l}=a,c=a.attributes.position;for(let d=i,h=e+i;d<h;d++){let u;if(u=d,le(o,u*3,l,c),o.needsUpdate=!0,s(o,u,n,r))return!0}return!1}function Nu(i,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=i.geometry,s=t.index?t.index.array:null,n=t.attributes.position;let r,o,a,l,c=0;const d=i._roots;for(let u=0,f=d.length;u<f;u++)r=d[u],o=new Uint32Array(r),a=new Uint16Array(r),l=new Float32Array(r),h(0,c),c+=r.byteLength;function h(u,f,m=!1){const y=u*2;if(a[y+15]===qi){const g=o[u+6],v=a[y+14];let w=1/0,b=1/0,x=1/0,M=-1/0,A=-1/0,T=-1/0;for(let E=3*g,P=3*(g+v);E<P;E++){let L=s[E];const C=n.getX(L),D=n.getY(L),R=n.getZ(L);C<w&&(w=C),C>M&&(M=C),D<b&&(b=D),D>A&&(A=D),R<x&&(x=R),R>T&&(T=R)}return l[u+0]!==w||l[u+1]!==b||l[u+2]!==x||l[u+3]!==M||l[u+4]!==A||l[u+5]!==T?(l[u+0]=w,l[u+1]=b,l[u+2]=x,l[u+3]=M,l[u+4]=A,l[u+5]=T,!0):!1}else{const g=u+8,v=o[u+6],w=g+f,b=v+f;let x=m,M=!1,A=!1;e?x||(M=e.has(w),A=e.has(b),x=!M&&!A):(M=!0,A=!0);const T=x||M,E=x||A;let P=!1;T&&(P=h(g,f,x));let L=!1;E&&(L=h(v,f,x));const C=P||L;if(C)for(let D=0;D<3;D++){const R=g+D,O=v+D,B=l[R],W=l[R+3],te=l[O],ne=l[O+3];l[u+D]=B<te?B:te,l[u+D+3]=W>ne?W:ne}return C}}}const oo=new he;function Pt(i,e,t,s){return ie(i,e,oo),t.intersectBox(oo,s)}function ku(i,e,t,s,n,r){const{geometry:o,_indirectBuffer:a}=i;for(let l=s,c=s+n;l<c;l++){let d=a?a[l]:l;Wi(o,e,t,d,r)}}function Uu(i,e,t,s,n){const{geometry:r,_indirectBuffer:o}=i;let a=1/0,l=null;for(let c=s,d=s+n;c<d;c++){let h;h=Wi(r,e,t,o?o[c]:c),h&&h.distance<a&&(l=h,a=h.distance)}return l}function zu(i,e,t,s,n,r,o){const{geometry:a}=t,{index:l}=a,c=a.attributes.position;for(let d=i,h=e+i;d<h;d++){let u;if(u=t.resolveTriangleIndex(d),le(o,u*3,l,c),o.needsUpdate=!0,s(o,u,n,r))return!0}return!1}const ao=new _;function Hu(i,e,t,s,n){ee.setBuffer(i._roots[e]),Fn(0,i,t,s,n),ee.clearBuffer()}function Fn(i,e,t,s,n){const{float32Array:r,uint16Array:o,uint32Array:a}=ee,l=i*2;if(Ce(l,o)){const d=Pe(i,a),h=Ne(l,o);Bu(e,t,s,d,h,n)}else{const d=ke(i);Pt(d,r,s,ao)&&Fn(d,e,t,s,n);const h=Ue(i,a);Pt(h,r,s,ao)&&Fn(h,e,t,s,n)}}const lo=new _,Gu=["x","y","z"];function ju(i,e,t,s){ee.setBuffer(i._roots[e]);const n=Nn(0,i,t,s);return ee.clearBuffer(),n}function Nn(i,e,t,s){const{float32Array:n,uint16Array:r,uint32Array:o}=ee;let a=i*2;if(Ce(a,r)){const c=Pe(i,o),d=Ne(a,r);return Ou(e,t,s,c,d)}else{const c=Ca(i,o),d=Gu[c],u=s.direction[d]>=0;let f,m;u?(f=ke(i),m=Ue(i,o)):(f=Ue(i,o),m=ke(i));const p=Pt(f,n,s,lo)?Nn(f,e,t,s):null;if(p){const w=p.point[d];if(u?w<=n[m+c]:w>=n[m+c+3])return p}const v=Pt(m,n,s,lo)?Nn(m,e,t,s):null;return p&&v?p.distance<=v.distance?p:v:p||v||null}}const ui=new he,Qt=new qe,Jt=new qe,Rs=new oe,co=new Te,di=new Te;function Vu(i,e,t,s){ee.setBuffer(i._roots[e]);const n=kn(0,i,t,s);return ee.clearBuffer(),n}function kn(i,e,t,s,n=null){const{float32Array:r,uint16Array:o,uint32Array:a}=ee;let l=i*2;if(n===null&&(t.boundingBox||t.computeBoundingBox(),co.set(t.boundingBox.min,t.boundingBox.max,s),n=co),Ce(l,o)){const d=e.geometry,h=d.index,u=d.attributes.position,f=t.index,m=t.attributes.position,y=Pe(i,a),p=Ne(l,o);if(Rs.copy(s).invert(),t.boundsTree)return ie(i,r,di),di.matrix.copy(Rs),di.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:v=>di.intersectsBox(v),intersectsTriangle:v=>{v.a.applyMatrix4(s),v.b.applyMatrix4(s),v.c.applyMatrix4(s),v.needsUpdate=!0;for(let w=y*3,b=(p+y)*3;w<b;w+=3)if(le(Jt,w,h,u),Jt.needsUpdate=!0,v.intersectsTriangle(Jt))return!0;return!1}});for(let g=y*3,v=(p+y)*3;g<v;g+=3){le(Qt,g,h,u),Qt.a.applyMatrix4(Rs),Qt.b.applyMatrix4(Rs),Qt.c.applyMatrix4(Rs),Qt.needsUpdate=!0;for(let w=0,b=f.count;w<b;w+=3)if(le(Jt,w,f,m),Jt.needsUpdate=!0,Qt.intersectsTriangle(Jt))return!0}}else{const d=i+8,h=a[i+6];return ie(d,r,ui),!!(n.intersectsBox(ui)&&kn(d,e,t,s,n)||(ie(h,r,ui),n.intersectsBox(ui)&&kn(h,e,t,s,n)))}}const fi=new oe,un=new Te,Ls=new Te,qu=new _,Wu=new _,Ku=new _,Xu=new _;function Yu(i,e,t,s={},n={},r=0,o=1/0){e.boundingBox||e.computeBoundingBox(),un.set(e.boundingBox.min,e.boundingBox.max,t),un.needsUpdate=!0;const a=i.geometry,l=a.attributes.position,c=a.index,d=e.attributes.position,h=e.index,u=Fe.getPrimitive(),f=Fe.getPrimitive();let m=qu,y=Wu,p=null,g=null;n&&(p=Ku,g=Xu);let v=1/0,w=null,b=null;return fi.copy(t).invert(),Ls.matrix.copy(fi),i.shapecast({boundsTraverseOrder:x=>un.distanceToBox(x),intersectsBounds:(x,M,A)=>A<v&&A<o?(M&&(Ls.min.copy(x.min),Ls.max.copy(x.max),Ls.needsUpdate=!0),!0):!1,intersectsRange:(x,M)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:T=>Ls.distanceToBox(T),intersectsBounds:(T,E,P)=>P<v&&P<o,intersectsRange:(T,E)=>{for(let P=T,L=T+E;P<L;P++){le(f,3*P,h,d),f.a.applyMatrix4(t),f.b.applyMatrix4(t),f.c.applyMatrix4(t),f.needsUpdate=!0;for(let C=x,D=x+M;C<D;C++){le(u,3*C,c,l),u.needsUpdate=!0;const R=u.distanceToTriangle(f,m,p);if(R<v&&(y.copy(m),g&&g.copy(p),v=R,w=C,b=P),R<r)return!0}}}});{const A=Ss(e);for(let T=0,E=A;T<E;T++){le(f,3*T,h,d),f.a.applyMatrix4(t),f.b.applyMatrix4(t),f.c.applyMatrix4(t),f.needsUpdate=!0;for(let P=x,L=x+M;P<L;P++){le(u,3*P,c,l),u.needsUpdate=!0;const C=u.distanceToTriangle(f,m,p);if(C<v&&(y.copy(m),g&&g.copy(p),v=C,w=P,b=T),C<r)return!0}}}}}),Fe.releasePrimitive(u),Fe.releasePrimitive(f),v===1/0?null:(s.point?s.point.copy(y):s.point=y.clone(),s.distance=v,s.faceIndex=w,n&&(n.point?n.point.copy(g):n.point=g.clone(),n.point.applyMatrix4(fi),y.applyMatrix4(fi),n.distance=y.sub(n.point).length(),n.faceIndex=b),s)}function $u(i,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=i.geometry,s=t.index?t.index.array:null,n=t.attributes.position;let r,o,a,l,c=0;const d=i._roots;for(let u=0,f=d.length;u<f;u++)r=d[u],o=new Uint32Array(r),a=new Uint16Array(r),l=new Float32Array(r),h(0,c),c+=r.byteLength;function h(u,f,m=!1){const y=u*2;if(a[y+15]===qi){const g=o[u+6],v=a[y+14];let w=1/0,b=1/0,x=1/0,M=-1/0,A=-1/0,T=-1/0;for(let E=g,P=g+v;E<P;E++){const L=3*i.resolveTriangleIndex(E);for(let C=0;C<3;C++){let D=L+C;D=s?s[D]:D;const R=n.getX(D),O=n.getY(D),B=n.getZ(D);R<w&&(w=R),R>M&&(M=R),O<b&&(b=O),O>A&&(A=O),B<x&&(x=B),B>T&&(T=B)}}return l[u+0]!==w||l[u+1]!==b||l[u+2]!==x||l[u+3]!==M||l[u+4]!==A||l[u+5]!==T?(l[u+0]=w,l[u+1]=b,l[u+2]=x,l[u+3]=M,l[u+4]=A,l[u+5]=T,!0):!1}else{const g=u+8,v=o[u+6],w=g+f,b=v+f;let x=m,M=!1,A=!1;e?x||(M=e.has(w),A=e.has(b),x=!M&&!A):(M=!0,A=!0);const T=x||M,E=x||A;let P=!1;T&&(P=h(g,f,x));let L=!1;E&&(L=h(v,f,x));const C=P||L;if(C)for(let D=0;D<3;D++){const R=g+D,O=v+D,B=l[R],W=l[R+3],te=l[O],ne=l[O+3];l[u+D]=B<te?B:te,l[u+D+3]=W>ne?W:ne}return C}}}const ho=new _;function Zu(i,e,t,s,n){ee.setBuffer(i._roots[e]),Un(0,i,t,s,n),ee.clearBuffer()}function Un(i,e,t,s,n){const{float32Array:r,uint16Array:o,uint32Array:a}=ee,l=i*2;if(Ce(l,o)){const d=Pe(i,a),h=Ne(l,o);ku(e,t,s,d,h,n)}else{const d=ke(i);Pt(d,r,s,ho)&&Un(d,e,t,s,n);const h=Ue(i,a);Pt(h,r,s,ho)&&Un(h,e,t,s,n)}}const uo=new _,Qu=["x","y","z"];function Ju(i,e,t,s){ee.setBuffer(i._roots[e]);const n=zn(0,i,t,s);return ee.clearBuffer(),n}function zn(i,e,t,s){const{float32Array:n,uint16Array:r,uint32Array:o}=ee;let a=i*2;if(Ce(a,r)){const c=Pe(i,o),d=Ne(a,r);return Uu(e,t,s,c,d)}else{const c=Ca(i,o),d=Qu[c],u=s.direction[d]>=0;let f,m;u?(f=ke(i),m=Ue(i,o)):(f=Ue(i,o),m=ke(i));const p=Pt(f,n,s,uo)?zn(f,e,t,s):null;if(p){const w=p.point[d];if(u?w<=n[m+c]:w>=n[m+c+3])return p}const v=Pt(m,n,s,uo)?zn(m,e,t,s):null;return p&&v?p.distance<=v.distance?p:v:p||v||null}}const pi=new he,es=new qe,ts=new qe,Ds=new oe,fo=new Te,mi=new Te;function ed(i,e,t,s){ee.setBuffer(i._roots[e]);const n=Hn(0,i,t,s);return ee.clearBuffer(),n}function Hn(i,e,t,s,n=null){const{float32Array:r,uint16Array:o,uint32Array:a}=ee;let l=i*2;if(n===null&&(t.boundingBox||t.computeBoundingBox(),fo.set(t.boundingBox.min,t.boundingBox.max,s),n=fo),Ce(l,o)){const d=e.geometry,h=d.index,u=d.attributes.position,f=t.index,m=t.attributes.position,y=Pe(i,a),p=Ne(l,o);if(Ds.copy(s).invert(),t.boundsTree)return ie(i,r,mi),mi.matrix.copy(Ds),mi.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:v=>mi.intersectsBox(v),intersectsTriangle:v=>{v.a.applyMatrix4(s),v.b.applyMatrix4(s),v.c.applyMatrix4(s),v.needsUpdate=!0;for(let w=y,b=p+y;w<b;w++)if(le(ts,3*e.resolveTriangleIndex(w),h,u),ts.needsUpdate=!0,v.intersectsTriangle(ts))return!0;return!1}});for(let g=y,v=p+y;g<v;g++){const w=e.resolveTriangleIndex(g);le(es,3*w,h,u),es.a.applyMatrix4(Ds),es.b.applyMatrix4(Ds),es.c.applyMatrix4(Ds),es.needsUpdate=!0;for(let b=0,x=f.count;b<x;b+=3)if(le(ts,b,f,m),ts.needsUpdate=!0,es.intersectsTriangle(ts))return!0}}else{const d=i+8,h=a[i+6];return ie(d,r,pi),!!(n.intersectsBox(pi)&&Hn(d,e,t,s,n)||(ie(h,r,pi),n.intersectsBox(pi)&&Hn(h,e,t,s,n)))}}const gi=new oe,dn=new Te,Is=new Te,td=new _,sd=new _,id=new _,nd=new _;function rd(i,e,t,s={},n={},r=0,o=1/0){e.boundingBox||e.computeBoundingBox(),dn.set(e.boundingBox.min,e.boundingBox.max,t),dn.needsUpdate=!0;const a=i.geometry,l=a.attributes.position,c=a.index,d=e.attributes.position,h=e.index,u=Fe.getPrimitive(),f=Fe.getPrimitive();let m=td,y=sd,p=null,g=null;n&&(p=id,g=nd);let v=1/0,w=null,b=null;return gi.copy(t).invert(),Is.matrix.copy(gi),i.shapecast({boundsTraverseOrder:x=>dn.distanceToBox(x),intersectsBounds:(x,M,A)=>A<v&&A<o?(M&&(Is.min.copy(x.min),Is.max.copy(x.max),Is.needsUpdate=!0),!0):!1,intersectsRange:(x,M)=>{if(e.boundsTree){const A=e.boundsTree;return A.shapecast({boundsTraverseOrder:T=>Is.distanceToBox(T),intersectsBounds:(T,E,P)=>P<v&&P<o,intersectsRange:(T,E)=>{for(let P=T,L=T+E;P<L;P++){const C=A.resolveTriangleIndex(P);le(f,3*C,h,d),f.a.applyMatrix4(t),f.b.applyMatrix4(t),f.c.applyMatrix4(t),f.needsUpdate=!0;for(let D=x,R=x+M;D<R;D++){const O=i.resolveTriangleIndex(D);le(u,3*O,c,l),u.needsUpdate=!0;const B=u.distanceToTriangle(f,m,p);if(B<v&&(y.copy(m),g&&g.copy(p),v=B,w=D,b=P),B<r)return!0}}}})}else{const A=Ss(e);for(let T=0,E=A;T<E;T++){le(f,3*T,h,d),f.a.applyMatrix4(t),f.b.applyMatrix4(t),f.c.applyMatrix4(t),f.needsUpdate=!0;for(let P=x,L=x+M;P<L;P++){const C=i.resolveTriangleIndex(P);le(u,3*C,c,l),u.needsUpdate=!0;const D=u.distanceToTriangle(f,m,p);if(D<v&&(y.copy(m),g&&g.copy(p),v=D,w=P,b=T),D<r)return!0}}}}}),Fe.releasePrimitive(u),Fe.releasePrimitive(f),v===1/0?null:(s.point?s.point.copy(y):s.point=y.clone(),s.distance=v,s.faceIndex=w,n&&(n.point?n.point.copy(g):n.point=g.clone(),n.point.applyMatrix4(gi),y.applyMatrix4(gi),n.distance=y.sub(n.point).length(),n.faceIndex=b),s)}function od(){return typeof SharedArrayBuffer<"u"}const Hs=new ee.constructor,Bi=new ee.constructor,yt=new ar(()=>new he),ss=new he,is=new he,fn=new he,pn=new he;let mn=!1;function ad(i,e,t,s){if(mn)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");mn=!0;const n=i._roots,r=e._roots;let o,a=0,l=0;const c=new oe().copy(t).invert();for(let d=0,h=n.length;d<h;d++){Hs.setBuffer(n[d]),l=0;const u=yt.getPrimitive();ie(0,Hs.float32Array,u),u.applyMatrix4(c);for(let f=0,m=r.length;f<m&&(Bi.setBuffer(r[d]),o=Ge(0,0,t,c,s,a,l,0,0,u),Bi.clearBuffer(),l+=r[f].length,!o);f++);if(yt.releasePrimitive(u),Hs.clearBuffer(),a+=n[d].length,o)break}return mn=!1,o}function Ge(i,e,t,s,n,r=0,o=0,a=0,l=0,c=null,d=!1){let h,u;d?(h=Bi,u=Hs):(h=Hs,u=Bi);const f=h.float32Array,m=h.uint32Array,y=h.uint16Array,p=u.float32Array,g=u.uint32Array,v=u.uint16Array,w=i*2,b=e*2,x=Ce(w,y),M=Ce(b,v);let A=!1;if(M&&x)d?A=n(Pe(e,g),Ne(e*2,v),Pe(i,m),Ne(i*2,y),l,o+e,a,r+i):A=n(Pe(i,m),Ne(i*2,y),Pe(e,g),Ne(e*2,v),a,r+i,l,o+e);else if(M){const T=yt.getPrimitive();ie(e,p,T),T.applyMatrix4(t);const E=ke(i),P=Ue(i,m);ie(E,f,ss),ie(P,f,is);const L=T.intersectsBox(ss),C=T.intersectsBox(is);A=L&&Ge(e,E,s,t,n,o,r,l,a+1,T,!d)||C&&Ge(e,P,s,t,n,o,r,l,a+1,T,!d),yt.releasePrimitive(T)}else{const T=ke(e),E=Ue(e,g);ie(T,p,fn),ie(E,p,pn);const P=c.intersectsBox(fn),L=c.intersectsBox(pn);if(P&&L)A=Ge(i,T,t,s,n,r,o,a,l+1,c,d)||Ge(i,E,t,s,n,r,o,a,l+1,c,d);else if(P)if(x)A=Ge(i,T,t,s,n,r,o,a,l+1,c,d);else{const C=yt.getPrimitive();C.copy(fn).applyMatrix4(t);const D=ke(i),R=Ue(i,m);ie(D,f,ss),ie(R,f,is);const O=C.intersectsBox(ss),B=C.intersectsBox(is);A=O&&Ge(T,D,s,t,n,o,r,l,a+1,C,!d)||B&&Ge(T,R,s,t,n,o,r,l,a+1,C,!d),yt.releasePrimitive(C)}else if(L)if(x)A=Ge(i,E,t,s,n,r,o,a,l+1,c,d);else{const C=yt.getPrimitive();C.copy(pn).applyMatrix4(t);const D=ke(i),R=Ue(i,m);ie(D,f,ss),ie(R,f,is);const O=C.intersectsBox(ss),B=C.intersectsBox(is);A=O&&Ge(E,D,s,t,n,o,r,l,a+1,C,!d)||B&&Ge(E,R,s,t,n,o,r,l,a+1,C,!d),yt.releasePrimitive(C)}}return A}const yi=new Te,po=new he;class lr{static serialize(e,t={}){t={cloneBuffers:!0,...t};const s=e.geometry,n=e._roots,r=e._indirectBuffer,o=s.getIndex();let a;return t.cloneBuffers?a={roots:n.map(l=>l.slice()),index:o.array.slice(),indirectBuffer:r?r.slice():null}:a={roots:n,index:o.array,indirectBuffer:r},a}static deserialize(e,t,s={}){s={setIndex:!0,indirect:!!e.indirectBuffer,...s};const{index:n,roots:r,indirectBuffer:o}=e,a=new lr(t,{...s,[an]:!0});if(a._roots=r,a._indirectBuffer=o||null,s.setIndex){const l=t.getIndex();if(l===null){const c=new se(e.index,1,!1);t.setIndex(c)}else l.array!==n&&(l.array.set(n),l.needsUpdate=!0)}return a}get indirect(){return!!this._indirectBuffer}constructor(e,t={}){if(e.isBufferGeometry){if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("MeshBVH: Only BufferGeometries are supported.");if(t=Object.assign({strategy:Aa,maxDepth:40,maxLeafTris:10,verbose:!0,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,[an]:!1},t),t.useSharedArrayBuffer&&!od())throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=e,this._roots=null,this._indirectBuffer=null,t[an]||(Eu(this,t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new he)));const{_indirectBuffer:s}=this;this.resolveTriangleIndex=t.indirect?n=>s[n]:n=>n}refit(e=null){return(this.indirect?$u:Nu)(this,e)}traverse(e,t=0){const s=this._roots[t],n=new Uint32Array(s),r=new Uint16Array(s);o(0);function o(a,l=0){const c=a*2,d=r[c+15]===qi;if(d){const h=n[a+6],u=r[c+14];e(l,d,new Float32Array(s,a*4,6),h,u)}else{const h=a+Ti/4,u=n[a+6],f=n[a+7];e(l,d,new Float32Array(s,a*4,6),f)||(o(h,l+1),o(u,l+1))}}}raycast(e,t=Pi){const s=this._roots,n=this.geometry,r=[],o=t.isMaterial,a=Array.isArray(t),l=n.groups,c=o?t.side:t,d=this.indirect?Zu:Hu;for(let h=0,u=s.length;h<u;h++){const f=a?t[l[h].materialIndex].side:c,m=r.length;if(d(this,h,f,e,r),a){const y=l[h].materialIndex;for(let p=m,g=r.length;p<g;p++)r[p].face.materialIndex=y}}return r}raycastFirst(e,t=Pi){const s=this._roots,n=this.geometry,r=t.isMaterial,o=Array.isArray(t);let a=null;const l=n.groups,c=r?t.side:t,d=this.indirect?Ju:ju;for(let h=0,u=s.length;h<u;h++){const f=o?t[l[h].materialIndex].side:c,m=d(this,h,f,e);m!=null&&(a==null||m.distance<a.distance)&&(a=m,o&&(m.face.materialIndex=l[h].materialIndex))}return a}intersectsGeometry(e,t){let s=!1;const n=this._roots,r=this.indirect?ed:Vu;for(let o=0,a=n.length;o<a&&(s=r(this,o,e,t),!s);o++);return s}shapecast(e){const t=Fe.getPrimitive(),s=this.indirect?zu:Fu;let{boundsTraverseOrder:n,intersectsBounds:r,intersectsRange:o,intersectsTriangle:a}=e;if(o&&a){const h=o;o=(u,f,m,y,p)=>h(u,f,m,y,p)?!0:s(u,f,this,a,m,y,t)}else o||(a?o=(h,u,f,m)=>s(h,u,this,a,f,m,t):o=(h,u,f)=>f);let l=!1,c=0;const d=this._roots;for(let h=0,u=d.length;h<u;h++){const f=d[h];if(l=Ru(this,h,r,o,n,c),l)break;c+=f.byteLength}return Fe.releasePrimitive(t),l}bvhcast(e,t,s){let{intersectsRanges:n,intersectsTriangles:r}=s;const o=Fe.getPrimitive(),a=this.geometry.index,l=this.geometry.attributes.position,c=this.indirect?m=>{const y=this.resolveTriangleIndex(m);le(o,y*3,a,l)}:m=>{le(o,m*3,a,l)},d=Fe.getPrimitive(),h=e.geometry.index,u=e.geometry.attributes.position,f=e.indirect?m=>{const y=e.resolveTriangleIndex(m);le(d,y*3,h,u)}:m=>{le(d,m*3,h,u)};if(r){const m=(y,p,g,v,w,b,x,M)=>{for(let A=g,T=g+v;A<T;A++){f(A),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let E=y,P=y+p;E<P;E++)if(c(E),o.needsUpdate=!0,r(o,d,E,A,w,b,x,M))return!0}return!1};if(n){const y=n;n=function(p,g,v,w,b,x,M,A){return y(p,g,v,w,b,x,M,A)?!0:m(p,g,v,w,b,x,M,A)}}else n=m}return ad(this,e,t,n)}intersectsBox(e,t){return yi.set(e.min,e.max,t),yi.needsUpdate=!0,this.shapecast({intersectsBounds:s=>yi.intersectsBox(s),intersectsTriangle:s=>yi.intersectsTriangle(s)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,s={},n={},r=0,o=1/0){return(this.indirect?rd:Yu)(this,e,t,s,n,r,o)}closestPointToPoint(e,t={},s=0,n=1/0){return Lu(this,e,t,s,n)}getBoundingBox(e){return e.makeEmpty(),this._roots.forEach(s=>{ie(0,new Float32Array(s),po),e.union(po)}),e}}function mo(i,e,t){return i===null||(i.point.applyMatrix4(e.matrixWorld),i.distance=i.point.distanceTo(t.ray.origin),i.object=e,i.distance<t.near||i.distance>t.far)?null:i}const gn=new Ko,go=new oe,ld=me.prototype.raycast;function cd(i,e){if(this.geometry.boundsTree){if(this.material===void 0)return;go.copy(this.matrixWorld).invert(),gn.copy(i.ray).applyMatrix4(go);const t=this.geometry.boundsTree;if(i.firstHitOnly===!0){const s=mo(t.raycastFirst(gn,this.material),this,i);s&&e.push(s)}else{const s=t.raycast(gn,this.material);for(let n=0,r=s.length;n<r;n++){const o=mo(s[n],this,i);o&&e.push(o)}}}else ld.call(this,i,e)}function hd(i){return this.boundsTree=new lr(this,i),this.boundsTree}function ud(){this.boundsTree=null}class dd extends tu{constructor(t){super(t);N(this,"raycaster");this.initMeshBVH(),this.initTWEEN()}use(t){return t.register(this),t}memoryTrack(t){return t}initCSS2DRenderer(){const t=Symbol(),s=new su;s.setSize(window.innerWidth,window.innerHeight),s.domElement.id="css2dRenderer",this.onRenderQueue.set(t,()=>s.render(this.scene,this.camera)),this.onresizeQueue.set(t,s.setSize),document.body.appendChild(s.domElement),this.initCSS2DRenderer=()=>{}}initCSS3DRenderer(){const t=Symbol(),s=new ru;s.setSize(window.innerWidth,window.innerHeight),s.domElement.id="css3dRenderer",this.onRenderQueue.set(t,()=>s.render(this.scene,this.camera)),this.onresizeQueue.set(t,s.setSize),document.body.appendChild(s.domElement),this.initCSS3DRenderer=()=>{}}initTWEEN(){this.onRenderQueue.set(Symbol(),()=>Ml())}initMeshBVH(){_t.prototype.computeBoundsTree=hd,_t.prototype.disposeBoundsTree=ud,me.prototype.raycast=cd,Li.prototype.firstHitOnly=!0}initRaycaster(){this.raycaster=new ou(this.camera,this.domElement),this.initRaycaster=()=>{}}raycast(t,s,n){return this.raycaster||this.initRaycaster(),this.raycaster.raycast(t,s,n)}setRaycasterState(t,s){this.raycaster||this.initRaycaster(),this.raycaster.setState(t,s)}}class fd extends ms{constructor(){super();const e=new J;e.name="extra",this._add(e),this.extra=e}_add(e){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this._add(arguments[t]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(e.parent!==null&&e.parent.remove(e),e.parent=this,this.children.push(e)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}add(e){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(e.parent!==null&&e.parent.remove(e),e.parent=this.extra,this.extra.children.push(e)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}dispose(){for(;this.extra.children.length;)this.extra.children.pop().deleteSelf()}}class pd{constructor(e){this.core=e,this.scene=new fd}init(){}onEnter(){}onLeave(){}onLoaded(){}update(){}updateOrientation(){this.core.orientation.updateModules()}addEventListener(){}removeEventListener(){}changeWeather(){console.log("当前子系统未调用天气模块")}changeLighting(){console.log("当前子系统未调用天气模块")}setCameraState(){console.log("当前子系统没有相机漫游功能")}beginWander(){console.log("当前子系统没有第一人称漫游功能")}endWander(){console.log("当前子系统没有第一人称漫游功能")}initGridHelper(e=100){const t=new ea(e);this.scene.add(t)}initAxesHelper(e=100){const t=new ta(e);this.scene.add(t)}add(){this.scene.add(...arguments)}_add(){this.scene._add(...arguments)}dispose(){this.scene.dispose()}}function Je(i={},e,t){const{innerText:s,className:n,id:r,children:o=[]}=i,a=document.createElement("div");return s&&(a.innerText=s),n&&(a.className=n),r&&(a.id=r),a.title=s||"",o.forEach(l=>{a.appendChild(l)}),a.oncontextmenu=()=>!1,a}function Re(i,e){const t=new rr(i);return t.name=e,t}const md=()=>{window.parent.postMessage({cmd:"onLoading"},"*")},gd=()=>{window.parent.postMessage({cmd:"onLoaded"},"*")},yd=i=>{window.parent.postMessage({cmd:"inspectionId",param:i},"*")},vd=i=>{window.parent.postMessage({cmd:"personDetail",param:i},"*")},Pa=()=>{window.parent.postMessage({cmd:"closeDomDialog"},"*")},bd=i=>{window.parent.postMessage({cmd:"gatherCallBack",param:i},"*")},Ra=i=>{window.parent.postMessage({cmd:"web3dChangeIndoor",param:i},"*")},wd=i=>{window.parent.postMessage({cmd:"buildingDetail",param:{id:i}},"*")},xd=i=>{window.parent.postMessage({cmd:"dbClickBuilding",param:i},"*")},Sd=i=>{window.parent.postMessage({cmd:"cameraVideoId",param:i},"*")},Td=i=>{window.parent.postMessage({cmd:"switchByBuildingId",param:i},"*")},Ed=i=>{window.parent.postMessage({cmd:"clickUnion",param:i},"*")},Ad=i=>{window.parent.postMessage({cmd:"web3dModelsGroup",param:i},"*")};class Md{constructor(){this.scene=null,this.core=null,this.main=null,this.camera=null,this.controls=null,this.searchCameraId=null,this.cameraEquipSprite=null,this.inspectionEquipSprite=null,this.beaconEquipSprite=null,this.inspectionSystemEquipSprite=null,this.searchInspection=null,this.searchCameraIdNeed=null,this.searchInspectionSystemNeed=null,this.cherryArray=[]}onLoad(e,t){this.controls=e.controls,this.camera=e.camera,this.core=e,this.main=t,this.scene=e.scene,this.tweenControl=e.tweenControl,this.equipGroup=new J,this.equipGroup.name="equip",this.scene.add(this.equipGroup),this.equip={camera:{},inspection:{},beacon:{},inspectionSystem:{}},this.cameraEquipSprite=this.generateLabel("/equip/camera.png"),this.inspectionEquipSprite=this.generateLabel("/equip/inspection.png"),this.beaconEquipSprite=this.generateLabel("/equip/beacon.png",.018),this.inspectionSystemEquipSprite=this.generateLabel("/equip/xunjianListOff.png",.04),this.chooseEquip={camera:this.cameraEquipSprite,inspection:this.inspectionEquipSprite,beacon:this.beaconEquipSprite,inspectionSystem:this.inspectionSystemEquipSprite}}has(e,t){return this.equip[t][e]}get(e,t){return this.equip[t][e]}del(e,t){this.get(e,t).deleteSelf(),delete this.equip[t][e]}searchEquip(e,t){if(!this.has(e,t))return!1;let s=this.has(e,t).position;if(this.core.tweenControl.lerpTo(s,50,1e3,new _(0,10,0)),t==="camera"&&(Sd(e),this.searchCameraId=e),t==="inspectionSystem"){let n=new Ve().load("/equip/xunjianListOff.png"),r=new Ve().load("/equip/xunjianListOn.png");Object.entries(this.equip[t]).forEach(([o,a])=>{o==e?(a.children[0].material.map=r,a.children[0].visible=!0):a.children[0].material.map=n}),yd(e)}t!=="inspectionSystem"&&this.boardVisibleSingle(e,!0,t)}hideInspectionSystemIcon(e){const{visible:t,id:s}=e;if(this.has(s,"inspectionSystem")){let n=new Ve().load("/equip/xunjianListOff.png");this.get(s,"inspectionSystem").children[0].material.map=n,this.get(s,"inspectionSystem").children[0].visible=t,this.core.core.resetCamera()}}setSearchInspection(e){const{id:t,name:s,position:n}=e;this.searchInspection={id:t,name:s,position:n}}boardVisibleSingle(e,t,s){Object.entries(this.equip[s]).forEach(([n,r])=>{n==e?(r.children[0].visible=t,r.children[1].visible=t):r.children[1].visible=!t})}closeCameraDialog(e){this.equip.camera[e].children[1].visible=!1,this.searchCameraId=null}setCherryArray(e){this.cherryArray=e}cherryPick(){Object.values(this.equip.camera).map(e=>{this.cherryArray.includes("camera")?e.children[0].visible=!0:(e.children[0].visible=!1,e.children[1].visible=!1)}),Object.values(this.equip.beacon).map(e=>{this.cherryArray.includes("beacon")?e.children[0].visible=!0:(e.children[0].visible=!1,e.children[1].visible=!1)}),Object.values(this.equip.inspectionSystem).map(e=>{this.cherryArray.includes("inspectionSystem")?e.children[0].visible=!0:(e.children[0].visible=!1,e.children[1].visible=!1)})}clearEquipType(e){e.forEach(t=>{this.dispose(t)})}dataProcess(e,t){return new Promise(s=>{this.dispose(t),e.map((n,r)=>{const{position:o,id:a,name:l,originId:c,sceneType:d}=n;let h=new pe,u=this.chooseEquip[t].clone();t==="inspectionSystem"&&(u=this.generateLabel("/equip/xunjianListOff.png")),u.typeName=t,u.name=a;let f=this.setPersonBoard({name:l,id:a},!1,this.boardClick());h.add(u),h.add(f),h.position.set(o.x,o.y,o.z),this.equipGroup.add(h),this.core.orientation.orientation3D.pointerArr.push(h),this.equip[t][a]=h,r===e.length-1&&(this.cherryPick(),s(n))})})}setPersonBoard(e,t=!1,s){let n=document.createElement("div"),r=document.createElement("div"),o=document.createElement("div"),a=document.createElement("div"),l=document.createElement("div");l.append(n),l.append(r),l.append(o),l.append(a),l.draggable=!1,r.className="beilu_three_Board_text_person_top",o.className="beilu_three_Board_text_person_bottom",l.className="beilu_three_Board_text_person",a.className="beilu_three_Board_text_person_bottom_down",n.append(e.name),s&&(n.onclick=()=>{s()});let c=Re(l,"board"+e.id);return c.visible=t,c}boardClick(){}generateLabel(e,t=.028){const s=new Ve().load(e),n=new tr({map:s,sizeAttenuation:!1,depthTest:!1,depthWrite:!1}),r=new Di(n);return r.renderOrder=4,r.scale.set(t,t,t),r.center=new k(.5,0),r}hideCameraById(e){this.equip.camera[e].children[0].visible=!1,this.equip.camera[e].children[1].visible=!1}dispose(e){e==="camera"&&(this.searchCameraId=null);const t=Object.keys(this.equip[e]);for(let s=t.length-1;s>=0;s--)this.equip[e][t[s]].deleteSelf();this.equip[e]={}}disposeAll(){Object.values(this.equip.camera).forEach(e=>{e.deleteSelf()}),this.equip.camera={},Object.values(this.equip.inspection).forEach(e=>{e.deleteSelf()}),this.equip.inspection={},Object.values(this.equip.beacon).forEach(e=>{e.deleteSelf()}),this.equip.beacon={},Object.values(this.equip.inspectionSystem).forEach(e=>{e.deleteSelf()}),this.equip.inspectionSystem={}}}const V=new Md;function _d(i){let e=i.length,t=0;for(let s=0;s<e;s++)t+=i[s].cross(i[(s+1)%e]);return Math.abs(t/2)}function Cd(i,e,t,s){const n=e.clone().sub(i),r=t.clone().sub(i),o=s.clone().sub(i),a=s.clone().sub(t),l=i.clone().sub(t),c=e.clone().sub(t),d=n.cross(r),h=n.cross(o),u=a.cross(l),f=a.cross(c),m=d*h,y=u*f;return m<0&&y<0?!0:d===0&&h===0&&u===0&&f===0?!(t.x>=i.x&&t.x>=e.x&&s.x>=i.x&&s.y>=e.x||t.x<=i.x&&t.x<=e.x&&s.x<=i.x&&s.y<=e.x):!1}function Pd(i,e){let t=i.length;if(t===0)return!1;if(t===1)return i[0].equals(e);for(let s=0;s<t-1;s++)if(Cd(i[s],i[s+1],i[t-1],e))return!0;return!1}function Rd(i){const e=[];for(let t=0;t<i.length;t++)e.push(i[t].x,i[t].y,i[t].z);return e}function Ei(i,e="x",t="y"){if(Array.isArray(i)){const s=[];return i.forEach(n=>s.push(Ei(n,e,t))),s}else{const s=new k;return s.x=i[e],s.y=i[t],s}}function yo(i){let e=0;for(let t=1;t<i.length;t++)e+=i[t].distanceTo(i[t-1]);return e}function Ld(i){let e=null;const t=new Proxy(i,{construct(s,n,r){return e||(e=Reflect.construct(s,n,r)),e}});return i.prototype.constructor=t,t}function yn(i,e=new _(1,1,1),t=new k(.5,.5)){const s=new Ve().load(i),n=new tr({map:s,sizeAttenuation:!1}),r=new Di(n);return r.scale.copy(e),r.center.copy(t),r}class Dd extends rr{constructor(){let e=document.createElement("div"),t=document.createElement("div"),s=document.createElement("div"),n=document.createElement("div"),r=document.createElement("div");r.append(e),r.append(t),r.append(s),r.append(n),r.draggable=!1,t.className="beilu_three_Board_text_person_top",s.className="beilu_three_Board_text_person_bottom",r.className="red_three_Board_text_person",n.className="beilu_three_Board_text_person_bottom_down",super(r)}setInnerText(e){this.element.innerText=e}}class Id extends rr{constructor(e,t){let s=document.createElement("div");s.className="ellipse-container",s.style.cursor="pointer",s.style.background="#3F35F2",s.draggable=!1,s.innerText=e.name,t&&(s.onclick=()=>{t(e.cluster)}),super(s),this.name="board"+e.id}}const Bd=Ld(Dd);class Ts{constructor(){N(this,"order",2)}update(){console.log("构造函数缺少 update 方法")}}class Od{constructor(e){this.person=null,this.object3d=new pe,this.object3d.name="personDanger",this.label=e.clone(),this.board=new Bd,this.dangerPersonInfo=null,this.object3d.add(this.label,this.board)}setAlarm(e){this.person=e,this.board.setInnerText(e.name);const t=e.position;this.object3d.position.copy(t),this.object3d.add(this.label,this.board)}clearAlarm(){this.object3d.removeFromParent(),this.board.element.parentNode.removeChild(this.board.element)}}const vn=new _(.03,.03,.03),vo={externalPerson:yn("/person/externalPerson.png",vn),insidePerson:yn("/person/insidePerson.png",vn),laborPerson:yn("/person/laborPerson.png",vn)};class Fd extends Ts{constructor(t){super();N(this,"gatherClick",t=>{this.core.ground.boxSelectStatus!==!0&&bd(t.map(s=>s.id)),this.clusterModule.disperseClusterOnEvent(t),this.update(this.orientation)});N(this,"disposeClusterGroup",()=>{ae.dispose(this.clusterGroup.children),[...this.singleGroup.children].forEach(t=>{t.removeFromParent(),t.traverse(s=>{s.element&&s.element.parentNode&&s.element.parentNode.removeChild(s.element)})})});this.order=10,this.orientation=t,this.core=t.core,this.camera=t.core.camera,this.controls=t.core.controls,this.orientationLabels=new J,this.orientationLabels.name="PersonLabel",this.labelSprite=null,this.warningPerson=null,this.personGroup={[Ze.SCENE_TYPE.INDOOR]:{},[Ze.SCENE_TYPE.OUTDOOR]:new J},this.clusterModule=t.clusterModule,this.clusterGroup=new J,this.clusterGroup.name="clusterGroup",this.singleGroup=new J,this.singleGroup.name="singleGroup",this.pointerArr=[],this.personAlarm=new Od(vo.insidePerson),this.orientation.addUpdatable(this),this.personDangerData=null,this.hiddenAllPerson=!1}add(t){const s=this.personGroup[t.sceneType];if(t.sceneType===Ze.SCENE_TYPE.INDOOR){const n=t.originId.slice(0,-3);s[n]||(s[n]={}),s[n][t.originId]||(s[n][t.originId]=new J),s[n][t.originId].add(t.object3d)}else s.add(t.object3d)}create(t,s){const n=new pe;n.name=t.id;const r=vo[t.typeName].clone();r.center.set(.5,0),r.name=t.id,r.renderOrder=10,n.add(r);const o=Je({innerText:t.name,className:`person-sprite-${t.typeName}`}),a=Je({className:"person-sprite-container",children:[o]}),l=Re(a);return l.classTypeName=`person-sprite-${t.typeName}`,l.position.y=0,l.center.set(.5,.2),n.add(l),t.id===this.orientation.followId?(s?n.position.copy(t.position):n.position.copy(this.orientation.followModule.from),this.orientation.followModule.to.copy(t.position),l.position.y=1.8):n.position.copy(t.position),n}delete(t){const s=this.orientation.get(t.id);ae.dispose(s.object3d,!0)}updateData(t){if(this.orientation.followId!==t.id)return t.object3d.position.copy(t.position);t.object3d.position.equals(t.position)||this.orientation.followModule.createPath(t)}update(t){const s=t.clusterModule.clusterMap,n=t.clusterModule.singleData;if([...this.clusterGroup.children].forEach(o=>ae.dispose(o,!0)),[...this.singleGroup.children].forEach(o=>{o.removeFromParent()}),this.pointerArr.length=0,n.map(o=>{this.singleGroup.add(o.object3d)}),s.forEach((o,a)=>{if(o.length===1&&this.singleGroup.add(o[0].object3d),o.length>1){const l=new Id({name:o.length,id:a,cluster:o},this.gatherClick);l.position.copy(o.position),this.clusterGroup.add(l),this.pointerArr.push(l)}}),this.singleGroup.traverse(o=>{o.isPass||(o.visible=!0,o.element&&(o.element.style.display="block"))}),this.orientation.searchId){let o=this.orientation.get(this.orientation.searchId);const{originId:a,sceneType:l}=o,{sceneType:c,originId:d}=this.core.getCurrentOriginId();if(l!==c||l===0&&a!==d){if(this.orientation.followId)return this.orientation.search();this.orientation.clearSearch(),Pa()}else this.orientation.search()}this.setPointerArr(),this.hiddenAllPerson===!0&&this.setAllPersonVisible(!1),this.core.scene.add(this.singleGroup),this.core.scene.add(this.clusterGroup)}setPointerArr(){this.singleGroup&&this.singleGroup.children.forEach(t=>{this.pointerArr.push(t)}),V.equipGroup&&V.equipGroup.children.forEach(t=>{this.pointerArr.push(t)}),this.core.sceneType===1&&this.core.ground.pointerArr.forEach(t=>{this.pointerArr.push(t)})}setAllPersonVisible(t){this.singleGroup.traverse(s=>{s.visible=t}),this.clusterGroup.traverse(s=>{s.visible=t})}disposeAlarm(){ae.dispose(this.personAlarm.object3d)}onCameraChange(){this.clusterModule.onCameraChange()}getCurrentPersonGroup(t,s=""){if(t===Ze.SCENE_TYPE.OUTDOOR)return this.personGroup[t];{const n=s.slice(0,-3),r=this.personGroup[t][n];return r&&r[s]||null}}openDialog(t){}setDialogVisible(t){}closeDialog(){}setAlarmPerson(t){this.personDangerData=t}searchAlarmPerson(){this.personAlarm.setAlarm(this.personDangerData),this.core.scene._add(this.personAlarm.object3d),this.core.tweenControl.lerpTo(this.personAlarm.person.position,50,1e3,new _(0,10,0))}clearAlarmPerson(){this.personAlarm.clearAlarm(),this.personDangerData=null}}let bo=3;const Nd={S:80,M:160,L:240,XL:320,XXL:400};var ps,vs,La,Da;class kd extends Ts{constructor(t){super();Y(this,vs);Y(this,ps,!1);N(this,"pullFromCluster",t=>{t.isSingle=!0;const s=t.clusterId;if(!this.clusterMap.has(s))return;const n=this.clusterMap.get(s);for(let r=0;r<n.length;r++)if(n[r].id===t.id){n.splice(r,1);break}return this.singleData.push(t),t});N(this,"pushToCluster",t=>{t.isSingle=!1;const s=$(this,vs,Da).call(this,t.position,Nd[this.level]/Math.sqrt(bo));let n=[];this.clusterMap.has(s)?n=this.clusterMap.get(s):this.clusterMap.set(s,n),n.push(t),t.clusterId=s;for(let r=0;r<this.singleData.length;r++)if(this.singleData[r]===t){this.singleData.splice(r,1);break}return t.object3d.traverse(r=>{r.element&&(r.element.style.display="none")}),t});this.order=1,this.level="X",this.nearestDistance=100,this.orientation=t,this.orientation.addUpdatable(this),this.core=t.core,this.clusterMap=new Map,this.singleData=[],this.core.controls.addEventListener("change",s=>{this.onCameraChange(this.core.camera),this.update(this.orientation),this.orientation.orientation3D.update(this.orientation)})}get isActive(){return I(this,ps)}setActive(t){X(this,ps,t),this.orientation.updateModules()}setLevel(t){bo=t,this.orientation.updateModules()}update(t){this.clear();const{sceneType:s,originId:n}=this.core.getCurrentOriginId(),r=t.getCurrentSceneData(s,n);if(I(this,ps)){let o=[];r.forEach(a=>{a.isSingle?this.singleData.push(a):o.push(a)}),$(this,vs,La).call(this,o)}else this.singleData=r;this.onCameraChange(this.core.camera)}onCameraChange(t){const s=t.position,n=s.y;let r;n<30?r="S":n<60?r="M":n<120?r="L":n<240?r="XL":r="XXL",this.level=r,this.clusterMap.forEach(a=>{s.distanceTo(a.position)<this.nearestDistance&&this.disperseClusterOnEvent(a)})}disperseClusterOnEvent(t){this.singleData.push(...t),t.length=0,t.position.set(0,0,0)}clear(){this.clusterMap.forEach(t=>{t.forEach(s=>s.clusterId=void 0)}),this.clusterMap.clear(),this.singleData=[]}}ps=new WeakMap,vs=new WeakSet,La=function(t){t.forEach(this.pushToCluster),this.clusterMap.forEach(s=>{const n=new _;s.position=n,s.forEach(r=>n.add(r.position)),n.divideScalar(s.length)})},Da=function(t,s){const n=o(t.x),r=o(t.z);function o(a){let l=parseInt(a/s),c=a%s;return c<0&&(c=-1),c>0&&(c=1),l+=c,l}return`${n}_${r}`};const lt=11102230246251565e-32,ye=134217729,Ud=(3+8*lt)*lt;function bn(i,e,t,s,n){let r,o,a,l,c=e[0],d=s[0],h=0,u=0;d>c==d>-c?(r=c,c=e[++h]):(r=d,d=s[++u]);let f=0;if(h<i&&u<t)for(d>c==d>-c?(o=c+r,a=r-(o-c),c=e[++h]):(o=d+r,a=r-(o-d),d=s[++u]),r=o,a!==0&&(n[f++]=a);h<i&&u<t;)d>c==d>-c?(o=r+c,l=o-r,a=r-(o-l)+(c-l),c=e[++h]):(o=r+d,l=o-r,a=r-(o-l)+(d-l),d=s[++u]),r=o,a!==0&&(n[f++]=a);for(;h<i;)o=r+c,l=o-r,a=r-(o-l)+(c-l),c=e[++h],r=o,a!==0&&(n[f++]=a);for(;u<t;)o=r+d,l=o-r,a=r-(o-l)+(d-l),d=s[++u],r=o,a!==0&&(n[f++]=a);return(r!==0||f===0)&&(n[f++]=r),f}function zd(i,e){let t=e[0];for(let s=1;s<i;s++)t+=e[s];return t}function Xs(i){return new Float64Array(i)}const Hd=(3+16*lt)*lt,Gd=(2+12*lt)*lt,jd=(9+64*lt)*lt*lt,ns=Xs(4),wo=Xs(8),xo=Xs(12),So=Xs(16),we=Xs(4);function Vd(i,e,t,s,n,r,o){let a,l,c,d,h,u,f,m,y,p,g,v,w,b,x,M,A,T;const E=i-n,P=t-n,L=e-r,C=s-r;b=E*C,u=ye*E,f=u-(u-E),m=E-f,u=ye*C,y=u-(u-C),p=C-y,x=m*p-(b-f*y-m*y-f*p),M=L*P,u=ye*L,f=u-(u-L),m=L-f,u=ye*P,y=u-(u-P),p=P-y,A=m*p-(M-f*y-m*y-f*p),g=x-A,h=x-g,ns[0]=x-(g+h)+(h-A),v=b+g,h=v-b,w=b-(v-h)+(g-h),g=w-M,h=w-g,ns[1]=w-(g+h)+(h-M),T=v+g,h=T-v,ns[2]=v-(T-h)+(g-h),ns[3]=T;let D=zd(4,ns),R=Gd*o;if(D>=R||-D>=R||(h=i-E,a=i-(E+h)+(h-n),h=t-P,c=t-(P+h)+(h-n),h=e-L,l=e-(L+h)+(h-r),h=s-C,d=s-(C+h)+(h-r),a===0&&l===0&&c===0&&d===0)||(R=jd*o+Ud*Math.abs(D),D+=E*d+C*a-(L*c+P*l),D>=R||-D>=R))return D;b=a*C,u=ye*a,f=u-(u-a),m=a-f,u=ye*C,y=u-(u-C),p=C-y,x=m*p-(b-f*y-m*y-f*p),M=l*P,u=ye*l,f=u-(u-l),m=l-f,u=ye*P,y=u-(u-P),p=P-y,A=m*p-(M-f*y-m*y-f*p),g=x-A,h=x-g,we[0]=x-(g+h)+(h-A),v=b+g,h=v-b,w=b-(v-h)+(g-h),g=w-M,h=w-g,we[1]=w-(g+h)+(h-M),T=v+g,h=T-v,we[2]=v-(T-h)+(g-h),we[3]=T;const O=bn(4,ns,4,we,wo);b=E*d,u=ye*E,f=u-(u-E),m=E-f,u=ye*d,y=u-(u-d),p=d-y,x=m*p-(b-f*y-m*y-f*p),M=L*c,u=ye*L,f=u-(u-L),m=L-f,u=ye*c,y=u-(u-c),p=c-y,A=m*p-(M-f*y-m*y-f*p),g=x-A,h=x-g,we[0]=x-(g+h)+(h-A),v=b+g,h=v-b,w=b-(v-h)+(g-h),g=w-M,h=w-g,we[1]=w-(g+h)+(h-M),T=v+g,h=T-v,we[2]=v-(T-h)+(g-h),we[3]=T;const B=bn(O,wo,4,we,xo);b=a*d,u=ye*a,f=u-(u-a),m=a-f,u=ye*d,y=u-(u-d),p=d-y,x=m*p-(b-f*y-m*y-f*p),M=l*c,u=ye*l,f=u-(u-l),m=l-f,u=ye*c,y=u-(u-c),p=c-y,A=m*p-(M-f*y-m*y-f*p),g=x-A,h=x-g,we[0]=x-(g+h)+(h-A),v=b+g,h=v-b,w=b-(v-h)+(g-h),g=w-M,h=w-g,we[1]=w-(g+h)+(h-M),T=v+g,h=T-v,we[2]=v-(T-h)+(g-h),we[3]=T;const W=bn(B,xo,4,we,So);return So[W-1]}function qd(i,e,t,s,n,r){const o=(e-r)*(t-n),a=(i-n)*(s-r),l=o-a,c=Math.abs(o+a);return Math.abs(l)>=Hd*c?l:-Vd(i,e,t,s,n,r,c)}function Wd(i,e){var t,s,n=0,r,o,a,l,c,d,h,u=i[0],f=i[1],m=e.length;for(t=0;t<m;t++){s=0;var y=e[t],p=y.length-1;if(d=y[0],d[0]!==y[p][0]&&d[1]!==y[p][1])throw new Error("First and last coordinates in a ring must be the same");for(o=d[0]-u,a=d[1]-f,s;s<p;s++){if(h=y[s+1],l=h[0]-u,c=h[1]-f,a===0&&c===0){if(l<=0&&o>=0||o<=0&&l>=0)return 0}else if(c>=0&&a<=0||c<=0&&a>=0){if(r=qd(o,l,a,c,0,0),r===0)return 0;(r>0&&c>0&&a<=0||r<0&&c<=0&&a>0)&&n++}d=h,a=c,o=l}}return n%2!==0}const To=new he,vi=new _;class Ia extends _l{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";const e=[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],t=[-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],s=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(s),this.setAttribute("position",new _r(e,3)),this.setAttribute("uv",new _r(t,2))}applyMatrix4(e){const t=this.attributes.instanceStart,s=this.attributes.instanceEnd;return t!==void 0&&(t.applyMatrix4(e),s.applyMatrix4(e),t.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}setPositions(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const s=new Ln(t,6,1);return this.setAttribute("instanceStart",new Ft(s,3,0)),this.setAttribute("instanceEnd",new Ft(s,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const s=new Ln(t,6,1);return this.setAttribute("instanceColorStart",new Ft(s,3,0)),this.setAttribute("instanceColorEnd",new Ft(s,3,3)),this}fromWireframeGeometry(e){return this.setPositions(e.attributes.position.array),this}fromEdgesGeometry(e){return this.setPositions(e.attributes.position.array),this}fromMesh(e){return this.fromWireframeGeometry(new Cl(e.geometry)),this}fromLineSegments(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new he);const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;e!==void 0&&t!==void 0&&(this.boundingBox.setFromBufferAttribute(e),To.setFromBufferAttribute(t),this.boundingBox.union(To))}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new xs),this.boundingBox===null&&this.computeBoundingBox();const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;if(e!==void 0&&t!==void 0){const s=this.boundingSphere.center;this.boundingBox.getCenter(s);let n=0;for(let r=0,o=e.count;r<o;r++)vi.fromBufferAttribute(e,r),n=Math.max(n,s.distanceToSquared(vi)),vi.fromBufferAttribute(t,r),n=Math.max(n,s.distanceToSquared(vi));this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}applyMatrix(e){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(e)}}Si.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new k(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}};xi.line={uniforms:ia.merge([Si.common,Si.fog,Si.line]),vertexShader:`
		#include <common>
		#include <color_pars_vertex>
		#include <fog_pars_vertex>
		#include <logdepthbuf_pars_vertex>
		#include <clipping_planes_pars_vertex>

		uniform float linewidth;
		uniform vec2 resolution;

		attribute vec3 instanceStart;
		attribute vec3 instanceEnd;

		attribute vec3 instanceColorStart;
		attribute vec3 instanceColorEnd;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#ifdef USE_DASH

			uniform float dashScale;
			attribute float instanceDistanceStart;
			attribute float instanceDistanceEnd;
			varying float vLineDistance;

		#endif

		void trimSegment( const in vec4 start, inout vec4 end ) {

			// trim end segment so it terminates between the camera plane and the near plane

			// conservative estimate of the near plane
			float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
			float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
			float nearEstimate = - 0.5 * b / a;

			float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

			end.xyz = mix( start.xyz, end.xyz, alpha );

		}

		void main() {

			#ifdef USE_COLOR

				vColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

			#endif

			#ifdef USE_DASH

				vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
				vUv = uv;

			#endif

			float aspect = resolution.x / resolution.y;

			// camera space
			vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
			vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

			#ifdef WORLD_UNITS

				worldStart = start.xyz;
				worldEnd = end.xyz;

			#else

				vUv = uv;

			#endif

			// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
			// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
			// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
			// perhaps there is a more elegant solution -- WestLangley

			bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

			if ( perspective ) {

				if ( start.z < 0.0 && end.z >= 0.0 ) {

					trimSegment( start, end );

				} else if ( end.z < 0.0 && start.z >= 0.0 ) {

					trimSegment( end, start );

				}

			}

			// clip space
			vec4 clipStart = projectionMatrix * start;
			vec4 clipEnd = projectionMatrix * end;

			// ndc space
			vec3 ndcStart = clipStart.xyz / clipStart.w;
			vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

			// direction
			vec2 dir = ndcEnd.xy - ndcStart.xy;

			// account for clip-space aspect ratio
			dir.x *= aspect;
			dir = normalize( dir );

			#ifdef WORLD_UNITS

				vec3 worldDir = normalize( end.xyz - start.xyz );
				vec3 tmpFwd = normalize( mix( start.xyz, end.xyz, 0.5 ) );
				vec3 worldUp = normalize( cross( worldDir, tmpFwd ) );
				vec3 worldFwd = cross( worldDir, worldUp );
				worldPos = position.y < 0.5 ? start: end;

				// height offset
				float hw = linewidth * 0.5;
				worldPos.xyz += position.x < 0.0 ? hw * worldUp : - hw * worldUp;

				// don't extend the line if we're rendering dashes because we
				// won't be rendering the endcaps
				#ifndef USE_DASH

					// cap extension
					worldPos.xyz += position.y < 0.5 ? - hw * worldDir : hw * worldDir;

					// add width to the box
					worldPos.xyz += worldFwd * hw;

					// endcaps
					if ( position.y > 1.0 || position.y < 0.0 ) {

						worldPos.xyz -= worldFwd * 2.0 * hw;

					}

				#endif

				// project the worldpos
				vec4 clip = projectionMatrix * worldPos;

				// shift the depth of the projected points so the line
				// segments overlap neatly
				vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
				clip.z = clipPose.z * clip.w;

			#else

				vec2 offset = vec2( dir.y, - dir.x );
				// undo aspect ratio adjustment
				dir.x /= aspect;
				offset.x /= aspect;

				// sign flip
				if ( position.x < 0.0 ) offset *= - 1.0;

				// endcaps
				if ( position.y < 0.0 ) {

					offset += - dir;

				} else if ( position.y > 1.0 ) {

					offset += dir;

				}

				// adjust for linewidth
				offset *= linewidth;

				// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
				offset /= resolution.y;

				// select end
				vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

				// back to clip space
				offset *= clip.w;

				clip.xy += offset;

			#endif

			gl_Position = clip;

			vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

			#include <logdepthbuf_vertex>
			#include <clipping_planes_vertex>
			#include <fog_vertex>

		}
		`,fragmentShader:`
		uniform vec3 diffuse;
		uniform float opacity;
		uniform float linewidth;

		#ifdef USE_DASH

			uniform float dashOffset;
			uniform float dashSize;
			uniform float gapSize;

		#endif

		varying float vLineDistance;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#include <common>
		#include <color_pars_fragment>
		#include <fog_pars_fragment>
		#include <logdepthbuf_pars_fragment>
		#include <clipping_planes_pars_fragment>

		vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

			float mua;
			float mub;

			vec3 p13 = p1 - p3;
			vec3 p43 = p4 - p3;

			vec3 p21 = p2 - p1;

			float d1343 = dot( p13, p43 );
			float d4321 = dot( p43, p21 );
			float d1321 = dot( p13, p21 );
			float d4343 = dot( p43, p43 );
			float d2121 = dot( p21, p21 );

			float denom = d2121 * d4343 - d4321 * d4321;

			float numer = d1343 * d4321 - d1321 * d4343;

			mua = numer / denom;
			mua = clamp( mua, 0.0, 1.0 );
			mub = ( d1343 + d4321 * ( mua ) ) / d4343;
			mub = clamp( mub, 0.0, 1.0 );

			return vec2( mua, mub );

		}

		void main() {

			#include <clipping_planes_fragment>

			#ifdef USE_DASH

				if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

				if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

			#endif

			float alpha = opacity;

			#ifdef WORLD_UNITS

				// Find the closest points on the view ray and the line segment
				vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
				vec3 lineDir = worldEnd - worldStart;
				vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

				vec3 p1 = worldStart + lineDir * params.x;
				vec3 p2 = rayEnd * params.y;
				vec3 delta = p1 - p2;
				float len = length( delta );
				float norm = len / linewidth;

				#ifndef USE_DASH

					#ifdef USE_ALPHA_TO_COVERAGE

						float dnorm = fwidth( norm );
						alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

					#else

						if ( norm > 0.5 ) {

							discard;

						}

					#endif

				#endif

			#else

				#ifdef USE_ALPHA_TO_COVERAGE

					// artifacts appear on some hardware if a derivative is taken within a conditional
					float a = vUv.x;
					float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
					float len2 = a * a + b * b;
					float dlen = fwidth( len2 );

					if ( abs( vUv.y ) > 1.0 ) {

						alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

					}

				#else

					if ( abs( vUv.y ) > 1.0 ) {

						float a = vUv.x;
						float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
						float len2 = a * a + b * b;

						if ( len2 > 1.0 ) discard;

					}

				#endif

			#endif

			vec4 diffuseColor = vec4( diffuse, alpha );

			#include <logdepthbuf_fragment>
			#include <color_fragment>

			gl_FragColor = vec4( diffuseColor.rgb, alpha );

			#include <tonemapping_fragment>
			#include <colorspace_fragment>
			#include <fog_fragment>
			#include <premultiplied_alpha_fragment>

		}
		`};class Ki extends Me{constructor(e){super({type:"LineMaterial",uniforms:ia.clone(xi.line.uniforms),vertexShader:xi.line.vertexShader,fragmentShader:xi.line.fragmentShader,clipping:!0}),this.isLineMaterial=!0,this.setValues(e)}get color(){return this.uniforms.diffuse.value}set color(e){this.uniforms.diffuse.value=e}get worldUnits(){return"WORLD_UNITS"in this.defines}set worldUnits(e){e===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}get linewidth(){return this.uniforms.linewidth.value}set linewidth(e){this.uniforms.linewidth&&(this.uniforms.linewidth.value=e)}get dashed(){return"USE_DASH"in this.defines}set dashed(e){e===!0!==this.dashed&&(this.needsUpdate=!0),e===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}get dashScale(){return this.uniforms.dashScale.value}set dashScale(e){this.uniforms.dashScale.value=e}get dashSize(){return this.uniforms.dashSize.value}set dashSize(e){this.uniforms.dashSize.value=e}get dashOffset(){return this.uniforms.dashOffset.value}set dashOffset(e){this.uniforms.dashOffset.value=e}get gapSize(){return this.uniforms.gapSize.value}set gapSize(e){this.uniforms.gapSize.value=e}get opacity(){return this.uniforms.opacity.value}set opacity(e){this.uniforms&&(this.uniforms.opacity.value=e)}get resolution(){return this.uniforms.resolution.value}set resolution(e){this.uniforms.resolution.value.copy(e)}get alphaToCoverage(){return"USE_ALPHA_TO_COVERAGE"in this.defines}set alphaToCoverage(e){this.defines&&(e===!0!==this.alphaToCoverage&&(this.needsUpdate=!0),e===!0?this.defines.USE_ALPHA_TO_COVERAGE="":delete this.defines.USE_ALPHA_TO_COVERAGE)}}const Eo=new _,Ao=new _,ue=new Ct,de=new Ct,Ke=new Ct,wn=new _,xn=new oe,fe=new Qe,Mo=new _,bi=new he,wi=new xs,Xe=new Ct;let $e,Ht;function _o(i,e,t){return Xe.set(0,0,-e,1).applyMatrix4(i.projectionMatrix),Xe.multiplyScalar(1/Xe.w),Xe.x=Ht/t.width,Xe.y=Ht/t.height,Xe.applyMatrix4(i.projectionMatrixInverse),Xe.multiplyScalar(1/Xe.w),Math.abs(Math.max(Xe.x,Xe.y))}function Kd(i,e){const t=i.matrixWorld,s=i.geometry,n=s.attributes.instanceStart,r=s.attributes.instanceEnd,o=Math.min(s.instanceCount,n.count);for(let a=0,l=o;a<l;a++){fe.start.fromBufferAttribute(n,a),fe.end.fromBufferAttribute(r,a),fe.applyMatrix4(t);const c=new _,d=new _;$e.distanceSqToSegment(fe.start,fe.end,d,c),d.distanceTo(c)<Ht*.5&&e.push({point:d,pointOnLine:c,distance:$e.origin.distanceTo(d),object:i,face:null,faceIndex:a,uv:null,uv1:null})}}function Xd(i,e,t){const s=e.projectionMatrix,r=i.material.resolution,o=i.matrixWorld,a=i.geometry,l=a.attributes.instanceStart,c=a.attributes.instanceEnd,d=Math.min(a.instanceCount,l.count),h=-e.near;$e.at(1,Ke),Ke.w=1,Ke.applyMatrix4(e.matrixWorldInverse),Ke.applyMatrix4(s),Ke.multiplyScalar(1/Ke.w),Ke.x*=r.x/2,Ke.y*=r.y/2,Ke.z=0,wn.copy(Ke),xn.multiplyMatrices(e.matrixWorldInverse,o);for(let u=0,f=d;u<f;u++){if(ue.fromBufferAttribute(l,u),de.fromBufferAttribute(c,u),ue.w=1,de.w=1,ue.applyMatrix4(xn),de.applyMatrix4(xn),ue.z>h&&de.z>h)continue;if(ue.z>h){const w=ue.z-de.z,b=(ue.z-h)/w;ue.lerp(de,b)}else if(de.z>h){const w=de.z-ue.z,b=(de.z-h)/w;de.lerp(ue,b)}ue.applyMatrix4(s),de.applyMatrix4(s),ue.multiplyScalar(1/ue.w),de.multiplyScalar(1/de.w),ue.x*=r.x/2,ue.y*=r.y/2,de.x*=r.x/2,de.y*=r.y/2,fe.start.copy(ue),fe.start.z=0,fe.end.copy(de),fe.end.z=0;const y=fe.closestPointToPointParameter(wn,!0);fe.at(y,Mo);const p=Qn.lerp(ue.z,de.z,y),g=p>=-1&&p<=1,v=wn.distanceTo(Mo)<Ht*.5;if(g&&v){fe.start.fromBufferAttribute(l,u),fe.end.fromBufferAttribute(c,u),fe.start.applyMatrix4(o),fe.end.applyMatrix4(o);const w=new _,b=new _;$e.distanceSqToSegment(fe.start,fe.end,b,w),t.push({point:b,pointOnLine:w,distance:$e.origin.distanceTo(b),object:i,face:null,faceIndex:u,uv:null,uv1:null})}}}class Yd extends me{constructor(e=new Ia,t=new Ki({color:Math.random()*16777215})){super(e,t),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const e=this.geometry,t=e.attributes.instanceStart,s=e.attributes.instanceEnd,n=new Float32Array(2*t.count);for(let o=0,a=0,l=t.count;o<l;o++,a+=2)Eo.fromBufferAttribute(t,o),Ao.fromBufferAttribute(s,o),n[a]=a===0?0:n[a-1],n[a+1]=n[a]+Eo.distanceTo(Ao);const r=new Ln(n,2,1);return e.setAttribute("instanceDistanceStart",new Ft(r,1,0)),e.setAttribute("instanceDistanceEnd",new Ft(r,1,1)),this}raycast(e,t){const s=this.material.worldUnits,n=e.camera;n===null&&!s&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const r=e.params.Line2!==void 0&&e.params.Line2.threshold||0;$e=e.ray;const o=this.matrixWorld,a=this.geometry,l=this.material;Ht=l.linewidth+r,a.boundingSphere===null&&a.computeBoundingSphere(),wi.copy(a.boundingSphere).applyMatrix4(o);let c;if(s)c=Ht*.5;else{const h=Math.max(n.near,wi.distanceToPoint($e.origin));c=_o(n,h,l.resolution)}if(wi.radius+=c,$e.intersectsSphere(wi)===!1)return;a.boundingBox===null&&a.computeBoundingBox(),bi.copy(a.boundingBox).applyMatrix4(o);let d;if(s)d=Ht*.5;else{const h=Math.max(n.near,bi.distanceToPoint($e.origin));d=_o(n,h,l.resolution)}bi.expandByScalar(d),$e.intersectsBox(bi)!==!1&&(s?Kd(this,t):Xd(this,n,t))}}class qs extends Ia{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}setPositions(e){const t=e.length-3,s=new Float32Array(2*t);for(let n=0;n<t;n+=3)s[2*n]=e[n],s[2*n+1]=e[n+1],s[2*n+2]=e[n+2],s[2*n+3]=e[n+3],s[2*n+4]=e[n+4],s[2*n+5]=e[n+5];return super.setPositions(s),this}setColors(e){const t=e.length-3,s=new Float32Array(2*t);for(let n=0;n<t;n+=3)s[2*n]=e[n],s[2*n+1]=e[n+1],s[2*n+2]=e[n+2],s[2*n+3]=e[n+3],s[2*n+4]=e[n+4],s[2*n+5]=e[n+5];return super.setColors(s),this}fromLine(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}}class Gn extends Yd{constructor(e=new qs,t=new Ki({color:Math.random()*16777215})){super(e,t),this.isLine2=!0,this.type="Line2"}}const $d=new qs,Ai=new Ki({color:16711935,linewidth:4,depthTest:!1,transparent:!0});Ai.resolution.set(window.innerWidth,window.innerHeight);var Oe;class cr{constructor(e){Y(this,Oe);N(this,"points");N(this,"line");N(this,"moveLine");N(this,"count");N(this,"needToAdhereToFirstPoint");N(this,"closestDistanceToAdhere");N(this,"needCheckLinesCross");N(this,"isClosed");N(this,"movePoint");this.scene=e,this.needToAdhereToFirstPoint=!0,this.needCheckLinesCross=!1,this.closestDistanceToAdhere=0,this.points=[],this.count=0,this.isClosed=!1,X(this,Oe,!1),this.movePoint=new _,this._create(),this.moveLine.visible=!1,this.group=new J,this.group.name="绘制组",this.group.add(this.line,this.moveLine),this.scene._add(this.group)}set active(e){I(this,Oe)!==e&&(X(this,Oe,e),e?this._create():this.end())}get active(){return I(this,Oe)}addPoint(e){if(I(this,Oe)){if(this.needCheckLinesCross&&Pd(Ei(this.points,"x","z"),Ei(e,"x","z"))){setTimeout(()=>{alert("相交了,操作无效")},0),console.log("相交了,操作无效");return}this.needToAdhereToFirstPoint&&this.count>1&&e.equals(this.points[0])&&(this.isClosed=!0),this.points.push(e),this.count++,this.updateLine(),this.updateMoveLine(e),this.line.parent||this.group.add(this.line,this.moveLine)}}end(){this.moveLine&&(this.moveLine.deleteSelf(),this.moveLine=null)}deletePoint(){I(this,Oe)&&this.points.length&&(this.points.pop(),this.count--,this.updateLine(),this.updateMoveLine())}_create(){this.line=new Gn(void 0,Ai),this.moveLine=new Gn(new qs().setPositions([0,0,0,0,0,0]),Ai)}getLength(e=2){return parseFloat(yo(this.points).toFixed(e))}getTotalLength(e=2){return parseFloat(yo([...this.points,this.movePoint]).toFixed(e))}getArea(e=2){return this.isClosed?parseFloat(_d(Ei(this.points,"x","z")).toFixed(e)):0}getCenter(e=new _){const t=e;return this.points.forEach(s=>{t.addScaledVector(s,1/this.points.length)}),t}onresize(e,t){Ai.resolution.set(e,t)}updateMoveLine(e){if(I(this,Oe))if(this.count){const{x:t,y:s,z:n}=this.points[this.count-1];if(e===void 0){const r=this.moveLine.geometry.attributes.instanceStart.data.array;this.moveLine.geometry.setPositions([t,s,n,r[3],r[4],r[5]])}else{if(this.movePoint.copy(e),this.needToAdhereToFirstPoint){const r=this.points[0];e.distanceTo(r)<this.closestDistanceToAdhere&&e.copy(r)}this.moveLine.geometry.setPositions([t,s,n,e.x,e.y,e.z]),this.moveLine.visible=!0}}else this.moveLine.visible=!1}updateLine(){if(I(this,Oe))if(this.line.geometry.dispose(),this.count>=2){const e=new qs().setPositions(Rd(this.points));this.line.geometry=e}else this.line.geometry=$d}dispose(){this.line&&this.line.deleteSelf(),this.moveLine&&this.moveLine.deleteSelf(),this.line=null,this.moveLine=null,this.count=0,this.points.length=0,this.isClosed=!1,X(this,Oe,!1)}}Oe=new WeakMap;const Co=new k,Po=new k;class Zd extends Ts{constructor(t){super();N(this,"onmousedown",t=>{this.getMouse(t,Co)});N(this,"onmouseup",t=>{if(this.getMouse(t,Po),!!Co.equals(Po)&&this.hitPoint&&(this.helper.addPoint(this.hitPoint),this.label&&(this.label.visible=this.helper.count!==0),this.helper.isClosed)){this.removeListener(),this.createLabel(),this.setLabelPosition(this.helper.getCenter()),this.core.enableControlsRotate(!0);let s=[];this.helper.points.forEach(n=>{s.push([n.x,n.z])}),this.polygon=[s],this.selectInsideObj(),this.orientation.updateModules()}});N(this,"hasObj",t=>Wd(t,this.polygon));N(this,"selectInsideObj",()=>{let t={person:[],camera:[],buildings:[]},s=V.equip.camera,n=[];this.orientation.getCurrentSceneData().forEach(o=>{o.object3d.visible&&n.push(o)});let r=this.subsystem.buildingNameLabelMap;Object.entries(s).forEach(([o,a])=>{let l=[a.position.x,a.position.z];this.hasObj(l)&&(t.camera.includes(o)||t.camera.push(o))}),n.forEach(o=>{let a=[o.position.x,o.position.z];this.hasObj(a)&&(t.person.includes(o.id)||(t.person.push(o.id),this.orientation.clusterModule.pullFromCluster(o)))}),Object.entries(r).forEach(([o,a])=>{let l=[a.position.x,a.position.z];this.hasObj(l)&&(t.buildings.includes(o)||t.buildings.push(o))}),window.parent.postMessage({cmd:"selectBack",param:t},"*")});N(this,"onkeyup",t=>{t.key==="Escape"&&(this.helper.deletePoint(),this.label.visible=this.helper.count!==0,this.updateLabel())});N(this,"getMouse",(t,s)=>{const{left:n,top:r,width:o,height:a}=this.core.domElement.getBoundingClientRect();s.x=(t.clientX-n)/o*2-1,s.y=-((t.clientY-r)/a)*2+1});N(this,"raycastOnmousemove",t=>{t.length?(this.hitPoint=t[0].point,this.helper.updateMoveLine(this.hitPoint)):this.hitPoint=null});this.core=null,this.scene=null,this.subsystem=null,this.order=2,this.raycastObject=null,this.hitPoint=null,this.orientation=t,this.orientation.addUpdatable(this)}onLoad(t){this.core=t.core,this.scene=t.scene,this.subsystem=t,this.helper=new cr(this.scene),this.helper.needToAdhereToFirstPoint=!0,this.helper.closestDistanceToAdhere=10,this.helper.needCheckLinesCross=!0}setRaycastObject(t){this.raycastObject=t}start(){this.helper.active=!0,this.mousedownControls=this.core.addEventListener("mousedown"),this.mouseupControls=this.core.addEventListener("mouseup"),this.keyupControls=this.core.addEventListener("keyup"),this.mousedownControls.add(this.onmousedown),this.mouseupControls.add(this.onmouseup),this.keyupControls.add(this.onkeyup),this.raycastControls=this.core.raycast("mousemove",this.raycastObject,this.raycastOnmousemove)}removeListener(){this.helper.active===!0&&(this.helper.active=!1,this.mousedownControls.clear(),this.mouseupControls.clear(),this.keyupControls.clear(),this.raycastControls.clear())}end(){this.removeListener(),this.helper.dispose(),this.label&&this.label.deleteSelf(),this.label=null}createLabel(){const t=Je({innerText:"精确监控",className:"beiLuBoxSelect"});this.label=Re(t)}updateLabel(){this.label.element&&this.setLabelPosition(this.hitPoint)}setLabelPosition(t,s=10){this.label.position.set(t.x,t.y+s,t.z)}update(t){this.helper.isClosed&&this.selectInsideObj()}}class Qd extends Ts{constructor(t){super();N(this,"updateVisible",t=>{const s=this.rules;if(!s)return;const n=s[t.typeName];t.object3d.traverse(r=>{r.visible=n,r.isPass=!n}),t.id!==this.orientation.searchId&&t.id!==this.orientation.followId&&(t.isSingle=!n),t.isPass=!n});this.order=0,this.orientation=t,this.rules=null,t.addUpdatable(this)}filter(t){this.rules=t}update(){if(!this.rules)return;this.orientation.map.forEach(this.updateVisible)}}var ki,Ba;class Jd extends me{constructor(t,s){super();Y(this,ki);const n=this.createHeatmap(t,s);this.geometry=n.geometry,this.material=n.material}createHeatmap(t,s){const{width:n,height:r}=$(this,ki,Ba).call(this,t,s.radius);this.initData(t,n,r);const o=s.container;o.style.width=`${n*2}px`,o.style.height=`${r*2}px`,document.body.appendChild(o);var a=h337.create(s);a.setData({max:2,data:t});const l=new na(a._config.container.children[0]);l.needUpdate=!0;const c=new Qo(n*2,r*2,500,500);c.applyMatrix4(new oe().makeRotationX(-Math.PI/2));const d=new Me({transparent:!0,depthTest:!1,uniforms:{heatmap:{value:l}},vertexShader:`
      uniform sampler2D heatmap;
      varying vec2 vUv;
      varying vec4 heatTexture;

      void main() {
          vUv = uv;
          heatTexture = texture2D(heatmap,vUv);
          vec3 pos = position;
          pos.y = heatTexture.r * 10.0;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(pos,1.0);
      }
      `,fragmentShader:`
      uniform sampler2D heatmap;
      varying vec2 vUv;
      varying vec4 heatTexture;
      void main() {
          vec4 color = heatTexture;
          gl_FragColor = color;
      }
      `});return document.body.removeChild(o),new me(c,d)}createHeightMap(t){}initData(t,s,n){for(let r=0;r<t.length;r++)t[r].x=t[r].x+s,t[r].y=t[r].y+n}}ki=new WeakSet,Ba=function(t,s){let n=-1/0,r=-1/0;for(let o=0;o<t.length;o++){const{x:a,y:l}=t[o];n=Math.max(n,Math.abs(a)),r=Math.max(r,Math.abs(l))}return{width:n+s,height:r+s}};var bs,Oa,Fa;class ef extends Ts{constructor(t){super();Y(this,bs);this.orientation=t}update(t){const s=t.getCurrentSceneData();this.dispose(),s.length!==0&&($(this,bs,Oa).call(this,s),t.core.scene.add(this.heatmap))}openHeatmap(){this.orientation.addUpdatable(this),this.update(this.orientation)}clearHeatmap(){this.dispose(),this.orientation.removeUpdatable(this)}dispose(){this.heatmap&&this.heatmap.deleteSelf()}}bs=new WeakSet,Oa=function(t){this.heatmap=new Jd($(this,bs,Fa).call(this,t),{container:document.createElement("div"),maxOpacity:1,radius:5,blur:1,backgroundColor:"rgba(0, 255, 255, 1)"}),this.heatmap.name="heatmap"},Fa=function(t){const s=[];for(let n=0;n<t.length;n++){const r=t[n].position;s.push({x:Math.floor(r.x),y:Math.floor(r.z),value:1})}return s};class tf extends Ts{constructor(e){super(),this.id=null,this.orientation=e,this.core=e.core,e.addUpdatable(this)}search(){const e=this.orientation;if(!e.has(this.id))return;const t=e.get(this.id);t.isSingle=!0,e.clusterModule.pullFromCluster(t),t.object3d.traverse(s=>{s.visible=!0}),this.core.controls.enablePan=!1,this.update(e),this.setSearchIcon("big",t)}setSearchIcon(e,t){if(!e)return!1;let s=.03,n="translate(0, -200%) scale(0.75)";e==="big"&&(s=.05,n="translate(0, -320%) scale(1.2)"),t.object3d.traverse(r=>{if(r.isSprite&&r.scale.set(s,s,s),r.isCSS2DObject&&r.classTypeName){let a=r.element.childNodes[0];a.style.transform=n}})}setPosition(){const e=this.id,s=this.orientation.get(e).position;this.core.tweenControl.lerpTo(s,50,1e3)}clearSearch(){const e=this.id;if(!e)return;const t=this.orientation;if(!t.has(e))return;const s=t.get(e);s.isSingle=!1,this.core.controls.enablePan=!0,this.id=null,t.updateModules(),this.setSearchIcon("small",s)}update(e){if(this.id&&!this.orientation.followId){let t=this.orientation.get(this.id);const{originId:s,sceneType:n}=t,{sceneType:r,originId:o}=this.core.getCurrentOriginId();if(n!==r||n===0&&s!==o)return!1}}}const Mi={0:"externalPerson",1:"insidePerson",2:"laborPerson",externalPerson:0,insidePerson:1,laborPerson:2};var ce,Na,ka,jn,Ua,za,Vn,Ha;const rt=class rt{constructor(e){Y(this,ce);this.core=e,this.map=new Map,this.updateMap=new Map,this.updatable=[],this.sceneData={[rt.SCENE_TYPE.INDOOR]:{},[rt.SCENE_TYPE.OUTDOOR]:[]},this.clusterModule=new kd(this),this.boxSelect=new Zd(this),this.personSearchModule=new tf(this),this.personFilter=new Qd(this),this.orientation3D=new Fd(this),this.heatmapModule=new ef(this)}get searchId(){return this.personSearchModule.id}set searchId(e){this.has(e)&&(this.personSearchModule.id=e)}init(e){const{add:t,remove:s,update:n}=e;t.forEach(r=>$(this,ce,jn).call(this,r)),s.forEach(r=>$(this,ce,za).call(this,r)),n.forEach(r=>$(this,ce,Ua).call(this,r)),this.getBuildingDataCount(),this.updateModules()}getBuildingDataCount(){const e=this.sceneData[rt.SCENE_TYPE.INDOOR];Reflect.ownKeys(e).forEach(s=>{let n=0;const r=e[s];Reflect.ownKeys(r).forEach(a=>{const l=r[a];n+=l.length})})}has(e){return this.map.has(e)}get(e){return this.map.get(e)}filterByRule(e){this.personFilter.filter(e),this.clearSearch(),this.updateModules()}getCurrentSceneData(e,t=""){if(!e&&!t){const s=this.core.getCurrentOriginId();e=s.sceneType,t=s.originId}if(e===rt.SCENE_TYPE.OUTDOOR)return this.sceneData[e];{let s;t.indexOf("F")!==-1?s=t.slice(0,-3):s=t;const n=this.sceneData[e][s];return n?n[t]||[]:[]}}setSearchId(e){this.searchId=e,vd(e)}setFollowId(e){this.followId=e}search(){this.personSearchModule.search()}clearSearch(){this.personSearchModule.clearSearch()}setHeatmap(e){e?this.heatmapModule.openHeatmap():this.heatmapModule.clearHeatmap()}addUpdatable(e){this.updatable.indexOf(e)===-1&&this.updatable.push(e)}removeUpdatable(e){const t=this.updatable.indexOf(e);t!==-1&&this.updatable.splice(t,1)}updateModules(){this.updatable.sort((e,t)=>e.order-t.order),this.updatable.forEach(e=>e.update(this))}};ce=new WeakSet,Na=function(e,t){this.map.set(e,t)},ka=function(e){this.map.delete(e)},jn=function(e,t){if($(this,ce,Ha).call(this,e,t),$(this,ce,Na).call(this,e.id,e),e.sceneType===rt.SCENE_TYPE.INDOOR){const s=this.sceneData[rt.SCENE_TYPE.INDOOR];let n;e.originId.indexOf("F")!==-1?n=e.originId.slice(0,-3):n=e.originId,s[n]||(s[n]={}),s[n][e.originId]||(s[n][e.originId]=[]),s[n][e.originId].push(e)}else this.sceneData[e.sceneType].push(e);e.id===this.followId&&(e.isSingle=!0),e.id===this.searchId&&(e.isSingle=!0),this.orientation3D.add(e)},Ua=function(e){const t=this.get(e.id);if(!t)return;const s=t.originId!=e.originId;$(this,ce,Vn).call(this,t),$(this,ce,jn).call(this,e,s),this.orientation3D.updateData(e)},za=function(e){if(!this.has(e.id))return;let t=e.id;this.searchId===t&&(this.clearSearch(t),Pa()),this.followId===t&&this.cancelFollow(t),$(this,ce,Vn).call(this,e)},Vn=function(e){this.orientation3D.delete(e),$(this,ce,ka).call(this,e.id);const{sceneType:t,originId:s}=e;let n=this.getCurrentSceneData(t,s);for(let r=0;r<n.length;r++)if(e.id===n[r].id){n.splice(r,1);break}},Ha=function(e,t){const{coordinate:s,sceneType:n,type:r,originId:o}=e;e.position=zi({coordinate:s,originId:o,sceneType:n}),e.buildingId=o.slice(0,-3),e.typeName=Mi[r],e.object3d=this.orientation3D.create(e,t)},N(rt,"SCENE_TYPE",{INDOOR:0,OUTDOOR:1});let Ze=rt;class Ga extends pd{constructor(e){super(e),this.orientation=e.orientation,this.core=e}clearPerson(){this.orientation.orientation3D.disposeClusterGroup()}startFollowPerson(e){this.orientation.setFollowId(e),this.orientation.startFollow()}processingEquipData(e,t){V.dataProcess(e,t).then(s=>{t==="camera"&&V.searchCameraIdNeed&&(V.searchEquip(V.searchCameraIdNeed,"camera"),V.searchCameraIdNeed=null),t==="inspectionSystem"&&V.searchInspectionSystemNeed&&(V.searchEquip(V.searchInspectionSystemNeed,"inspectionSystem"),V.searchInspectionSystemNeed=null)})}hideInspectionSystemIcon(e){V.hideInspectionSystemIcon(e)}searchPerson(e){this.orientation.search(e)}cancelFollowPerson(){this.orientation.cancelFollow()}clearSelected(){this.orientation.followId&&this.orientation.cancelFollow(),this.orientation.searchId&&this.orientation.clearSearch()}clearCameraVideo(e){V.closeCameraDialog(e),V.cherryPick()}cherryPick(e){const t={[Mi[0]]:!1,[Mi[1]]:!1,[Mi[2]]:!1};e.forEach(s=>{t[s]=!0}),V.setCherryArray(e),this.orientation.filterByRule(t),V.cherryPick(e),ti.ground.meetingPoint.setCherryArray(e),ti.ground.meetingPoint.cherryPick(),ti.ground.escapeRoute.setCherryArray(e),ti.ground.escapeRoute.cherryPick(),this.core.ground.setFilterBuilding(e),this.core.ground.filterBuildingNum()}setSearchInspection(e){V.setSearchInspection(e)}setFollowPersonIdNeed(e){}searchCamera(e){V.searchEquip(e,"camera")}searchInspectionSystem(e){V.searchEquip(e,"inspectionSystem")}searchInspection(){const e=V.searchInspection;V.dataProcess([e],"inspection"),V.searchEquip(e.id,"inspection"),V.searchInspection=null}getSearchPersonId(){return this.orientation.searchPersonId}getSearchEquipId(){return V.searchCameraId}setSearchCameraId(e){V.searchCameraIdNeed=e}setSearchInspectionSystemId(e){V.searchInspectionSystemNeed=e}setDangerPerson(e){this.orientation.orientation3D.setAlarmPerson(e)}searchAlarmPerson(){this.orientation.orientation3D.searchAlarmPerson()}clearDangerPerson(){this.orientation.orientation3D.clearAlarmPerson()}clearEquipType(e){V.clearEquipType(e)}hideCameraById(e){V.hideCameraById(e)}}function Ro(i,e){if(e===Pl)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),i;if(e===Dn||e===ra){let t=i.getIndex();if(t===null){const o=[],a=i.getAttribute("position");if(a!==void 0){for(let l=0;l<a.count;l++)o.push(l);i.setIndex(o),t=i.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),i}const s=t.count-2,n=[];if(e===Dn)for(let o=1;o<=s;o++)n.push(t.getX(0)),n.push(t.getX(o)),n.push(t.getX(o+1));else for(let o=0;o<s;o++)o%2===0?(n.push(t.getX(o)),n.push(t.getX(o+1)),n.push(t.getX(o+2))):(n.push(t.getX(o+2)),n.push(t.getX(o+1)),n.push(t.getX(o)));n.length/3!==s&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const r=i.clone();return r.setIndex(n),r.clearGroups(),r}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),i}class sf extends oa{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new Ff(t)}),this.register(function(t){return new lf(t)}),this.register(function(t){return new gf(t)}),this.register(function(t){return new yf(t)}),this.register(function(t){return new vf(t)}),this.register(function(t){return new hf(t)}),this.register(function(t){return new uf(t)}),this.register(function(t){return new df(t)}),this.register(function(t){return new ff(t)}),this.register(function(t){return new af(t)}),this.register(function(t){return new pf(t)}),this.register(function(t){return new cf(t)}),this.register(function(t){return new mf(t)}),this.register(function(t){return new rf(t)}),this.register(function(t){return new bf(t)}),this.register(function(t){return new wf(t)})}load(e,t,s,n){const r=this;let o;this.resourcePath!==""?o=this.resourcePath:this.path!==""?o=this.path:o=In.extractUrlBase(e),this.manager.itemStart(e);const a=function(c){n?n(c):console.error(c),r.manager.itemError(e),r.manager.itemEnd(e)},l=new Ii(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,function(c){try{r.parse(c,o,function(d){t(d),r.manager.itemEnd(e)},a)}catch(d){a(d)}},s,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,n){let r;const o={},a={},l=new TextDecoder;if(typeof e=="string")r=JSON.parse(e);else if(e instanceof ArrayBuffer)if(l.decode(new Uint8Array(e,0,4))===ja){try{o[j.KHR_BINARY_GLTF]=new xf(e)}catch(h){n&&n(h);return}r=JSON.parse(o[j.KHR_BINARY_GLTF].content)}else r=JSON.parse(l.decode(e));else r=e;if(r.asset===void 0||r.asset.version[0]<2){n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const c=new Bf(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let d=0;d<this.pluginCallbacks.length;d++){const h=this.pluginCallbacks[d](c);h.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[h.name]=h,o[h.name]=!0}if(r.extensionsUsed)for(let d=0;d<r.extensionsUsed.length;++d){const h=r.extensionsUsed[d],u=r.extensionsRequired||[];switch(h){case j.KHR_MATERIALS_UNLIT:o[h]=new of;break;case j.KHR_DRACO_MESH_COMPRESSION:o[h]=new Sf(r,this.dracoLoader);break;case j.KHR_TEXTURE_TRANSFORM:o[h]=new Tf;break;case j.KHR_MESH_QUANTIZATION:o[h]=new Ef;break;default:u.indexOf(h)>=0&&a[h]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+h+'".')}}c.setExtensions(o),c.setPlugins(a),c.parse(s,n)}parseAsync(e,t){const s=this;return new Promise(function(n,r){s.parse(e,t,n,r)})}}function nf(){let i={};return{get:function(e){return i[e]},add:function(e,t){i[e]=t},remove:function(e){delete i[e]},removeAll:function(){i={}}}}const j={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class rf{constructor(e){this.parser=e,this.name=j.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,n=t.length;s<n;s++){const r=t[s];r.extensions&&r.extensions[this.name]&&r.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let n=t.cache.get(s);if(n)return n;const r=t.json,l=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let c;const d=new Z(16777215);l.color!==void 0&&d.setRGB(l.color[0],l.color[1],l.color[2],He);const h=l.range!==void 0?l.range:0;switch(l.type){case"directional":c=new as(d),c.target.position.set(0,0,-1),c.add(c.target);break;case"point":c=new Ll(d),c.distance=h;break;case"spot":c=new Rl(d),c.distance=h,l.spot=l.spot||{},l.spot.innerConeAngle=l.spot.innerConeAngle!==void 0?l.spot.innerConeAngle:0,l.spot.outerConeAngle=l.spot.outerConeAngle!==void 0?l.spot.outerConeAngle:Math.PI/4,c.angle=l.spot.outerConeAngle,c.penumbra=1-l.spot.innerConeAngle/l.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+l.type)}return c.position.set(0,0,0),c.decay=2,vt(c,l),l.intensity!==void 0&&(c.intensity=l.intensity),c.name=t.createUniqueName(l.name||"light_"+e),n=Promise.resolve(c),t.cache.add(s,n),n}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,r=s.json.nodes[e],a=(r.extensions&&r.extensions[this.name]||{}).light;return a===void 0?null:this._loadLight(a).then(function(l){return s._getNodeRef(t.cache,a,l)})}}class of{constructor(){this.name=j.KHR_MATERIALS_UNLIT}getMaterialType(){return Ot}extendParams(e,t,s){const n=[];e.color=new Z(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const o=r.baseColorFactor;e.color.setRGB(o[0],o[1],o[2],He),e.opacity=o[3]}r.baseColorTexture!==void 0&&n.push(s.assignTexture(e,"map",r.baseColorTexture,q))}return Promise.all(n)}}class af{constructor(e){this.parser=e,this.name=j.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name].emissiveStrength;return r!==void 0&&(t.emissiveIntensity=r),Promise.resolve()}}class lf{constructor(e){this.parser=e,this.name=j.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Rt}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];if(o.clearcoatFactor!==void 0&&(t.clearcoat=o.clearcoatFactor),o.clearcoatTexture!==void 0&&r.push(s.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),o.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),o.clearcoatRoughnessTexture!==void 0&&r.push(s.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),o.clearcoatNormalTexture!==void 0&&(r.push(s.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),o.clearcoatNormalTexture.scale!==void 0)){const a=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new k(a,a)}return Promise.all(r)}}class cf{constructor(e){this.parser=e,this.name=j.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Rt}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return o.iridescenceFactor!==void 0&&(t.iridescence=o.iridescenceFactor),o.iridescenceTexture!==void 0&&r.push(s.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),o.iridescenceIor!==void 0&&(t.iridescenceIOR=o.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),o.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),o.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),o.iridescenceThicknessTexture!==void 0&&r.push(s.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(r)}}class hf{constructor(e){this.parser=e,this.name=j.KHR_MATERIALS_SHEEN}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Rt}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[];t.sheenColor=new Z(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=n.extensions[this.name];if(o.sheenColorFactor!==void 0){const a=o.sheenColorFactor;t.sheenColor.setRGB(a[0],a[1],a[2],He)}return o.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=o.sheenRoughnessFactor),o.sheenColorTexture!==void 0&&r.push(s.assignTexture(t,"sheenColorMap",o.sheenColorTexture,q)),o.sheenRoughnessTexture!==void 0&&r.push(s.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(r)}}class uf{constructor(e){this.parser=e,this.name=j.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Rt}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return o.transmissionFactor!==void 0&&(t.transmission=o.transmissionFactor),o.transmissionTexture!==void 0&&r.push(s.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(r)}}class df{constructor(e){this.parser=e,this.name=j.KHR_MATERIALS_VOLUME}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Rt}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];t.thickness=o.thicknessFactor!==void 0?o.thicknessFactor:0,o.thicknessTexture!==void 0&&r.push(s.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const a=o.attenuationColor||[1,1,1];return t.attenuationColor=new Z().setRGB(a[0],a[1],a[2],He),Promise.all(r)}}class ff{constructor(e){this.parser=e,this.name=j.KHR_MATERIALS_IOR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Rt}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name];return t.ior=r.ior!==void 0?r.ior:1.5,Promise.resolve()}}class pf{constructor(e){this.parser=e,this.name=j.KHR_MATERIALS_SPECULAR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Rt}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];t.specularIntensity=o.specularFactor!==void 0?o.specularFactor:1,o.specularTexture!==void 0&&r.push(s.assignTexture(t,"specularIntensityMap",o.specularTexture));const a=o.specularColorFactor||[1,1,1];return t.specularColor=new Z().setRGB(a[0],a[1],a[2],He),o.specularColorTexture!==void 0&&r.push(s.assignTexture(t,"specularColorMap",o.specularColorTexture,q)),Promise.all(r)}}class mf{constructor(e){this.parser=e,this.name=j.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Rt}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return o.anisotropyStrength!==void 0&&(t.anisotropy=o.anisotropyStrength),o.anisotropyRotation!==void 0&&(t.anisotropyRotation=o.anisotropyRotation),o.anisotropyTexture!==void 0&&r.push(s.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(r)}}class gf{constructor(e){this.parser=e,this.name=j.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,n=s.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const r=n.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r.source,o)}}class yf{constructor(e){this.parser=e,this.name=j.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;const o=r.extensions[t],a=n.images[o.source];let l=s.textureLoader;if(a.uri){const c=s.options.manager.getHandler(a.uri);c!==null&&(l=c)}return this.detectSupport().then(function(c){if(c)return s.loadTextureImage(e,o.source,l);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class vf{constructor(e){this.parser=e,this.name=j.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;const o=r.extensions[t],a=n.images[o.source];let l=s.textureLoader;if(a.uri){const c=s.options.manager.getHandler(a.uri);c!==null&&(l=c)}return this.detectSupport().then(function(c){if(c)return s.loadTextureImage(e,o.source,l);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class bf{constructor(e){this.name=j.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const n=s.extensions[this.name],r=this.parser.getDependency("buffer",n.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return r.then(function(a){const l=n.byteOffset||0,c=n.byteLength||0,d=n.count,h=n.byteStride,u=new Uint8Array(a,l,c);return o.decodeGltfBufferAsync?o.decodeGltfBufferAsync(d,h,u,n.mode,n.filter).then(function(f){return f.buffer}):o.ready.then(function(){const f=new ArrayBuffer(d*h);return o.decodeGltfBuffer(new Uint8Array(f),d,h,u,n.mode,n.filter),f})})}else return null}}class wf{constructor(e){this.name=j.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||s.mesh===void 0)return null;const n=t.meshes[s.mesh];for(const c of n.primitives)if(c.mode!==Ie.TRIANGLES&&c.mode!==Ie.TRIANGLE_STRIP&&c.mode!==Ie.TRIANGLE_FAN&&c.mode!==void 0)return null;const o=s.extensions[this.name].attributes,a=[],l={};for(const c in o)a.push(this.parser.getDependency("accessor",o[c]).then(d=>(l[c]=d,l[c])));return a.length<1?null:(a.push(this.parser.createNodeMesh(e)),Promise.all(a).then(c=>{const d=c.pop(),h=d.isGroup?d.children:[d],u=c[0].count,f=[];for(const m of h){const y=new oe,p=new _,g=new Vs,v=new _(1,1,1),w=new aa(m.geometry,m.material,u);for(let b=0;b<u;b++)l.TRANSLATION&&p.fromBufferAttribute(l.TRANSLATION,b),l.ROTATION&&g.fromBufferAttribute(l.ROTATION,b),l.SCALE&&v.fromBufferAttribute(l.SCALE,b),w.setMatrixAt(b,y.compose(p,g,v));for(const b in l)if(b==="_COLOR_0"){const x=l[b];w.instanceColor=new Dl(x.array,x.itemSize,x.normalized)}else b!=="TRANSLATION"&&b!=="ROTATION"&&b!=="SCALE"&&m.geometry.setAttribute(b,l[b]);pe.prototype.copy.call(w,m),this.parser.assignFinalMaterial(w),f.push(w)}return d.isGroup?(d.clear(),d.add(...f),d):f[0]}))}}const ja="glTF",Bs=12,Lo={JSON:1313821514,BIN:5130562};class xf{constructor(e){this.name=j.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,Bs),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==ja)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-Bs,r=new DataView(e,Bs);let o=0;for(;o<n;){const a=r.getUint32(o,!0);o+=4;const l=r.getUint32(o,!0);if(o+=4,l===Lo.JSON){const c=new Uint8Array(e,Bs+o,a);this.content=s.decode(c)}else if(l===Lo.BIN){const c=Bs+o;this.body=e.slice(c,c+a)}o+=a}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Sf{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=j.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,n=this.dracoLoader,r=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,a={},l={},c={};for(const d in o){const h=qn[d]||d.toLowerCase();a[h]=o[d]}for(const d in e.attributes){const h=qn[d]||d.toLowerCase();if(o[d]!==void 0){const u=s.accessors[e.attributes[d]],f=cs[u.componentType];c[h]=f.name,l[h]=u.normalized===!0}}return t.getDependency("bufferView",r).then(function(d){return new Promise(function(h){n.decodeDracoFile(d,function(u){for(const f in u.attributes){const m=u.attributes[f],y=l[f];y!==void 0&&(m.normalized=y)}h(u)},a,c)})})}}class Tf{constructor(){this.name=j.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Ef{constructor(){this.name=j.KHR_MESH_QUANTIZATION}}class Va extends Jl{constructor(e,t,s,n){super(e,t,s,n)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,r=e*n*3+n;for(let o=0;o!==n;o++)t[o]=s[r+o];return t}interpolate_(e,t,s,n){const r=this.resultBuffer,o=this.sampleValues,a=this.valueSize,l=a*2,c=a*3,d=n-t,h=(s-t)/d,u=h*h,f=u*h,m=e*c,y=m-c,p=-2*f+3*u,g=f-u,v=1-p,w=g-u+h;for(let b=0;b!==a;b++){const x=o[y+b+a],M=o[y+b+l]*d,A=o[m+b+a],T=o[m+b]*d;r[b]=v*x+w*M+p*A+g*T}return r}}const Af=new Vs;class Mf extends Va{interpolate_(e,t,s,n){const r=super.interpolate_(e,t,s,n);return Af.fromArray(r).normalize().toArray(r),r}}const Ie={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},cs={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Do={9728:Rn,9729:Mt,9984:Nl,9985:Fl,9986:Ol,9987:la},Io={33071:Ul,33648:kl,10497:jt},Sn={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},qn={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},gt={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},_f={CUBICSPLINE:void 0,LINEAR:ca,STEP:Ql},Tn={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function Cf(i){return i.DefaultMaterial===void 0&&(i.DefaultMaterial=new sr({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Pi})),i.DefaultMaterial}function Bt(i,e,t){for(const s in t.extensions)i[s]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[s]=t.extensions[s])}function vt(i,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(i.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function Pf(i,e,t){let s=!1,n=!1,r=!1;for(let c=0,d=e.length;c<d;c++){const h=e[c];if(h.POSITION!==void 0&&(s=!0),h.NORMAL!==void 0&&(n=!0),h.COLOR_0!==void 0&&(r=!0),s&&n&&r)break}if(!s&&!n&&!r)return Promise.resolve(i);const o=[],a=[],l=[];for(let c=0,d=e.length;c<d;c++){const h=e[c];if(s){const u=h.POSITION!==void 0?t.getDependency("accessor",h.POSITION):i.attributes.position;o.push(u)}if(n){const u=h.NORMAL!==void 0?t.getDependency("accessor",h.NORMAL):i.attributes.normal;a.push(u)}if(r){const u=h.COLOR_0!==void 0?t.getDependency("accessor",h.COLOR_0):i.attributes.color;l.push(u)}}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(l)]).then(function(c){const d=c[0],h=c[1],u=c[2];return s&&(i.morphAttributes.position=d),n&&(i.morphAttributes.normal=h),r&&(i.morphAttributes.color=u),i.morphTargetsRelative=!0,i})}function Rf(i,e){if(i.updateMorphTargets(),e.weights!==void 0)for(let t=0,s=e.weights.length;t<s;t++)i.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(i.morphTargetInfluences.length===t.length){i.morphTargetDictionary={};for(let s=0,n=t.length;s<n;s++)i.morphTargetDictionary[t[s]]=s}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Lf(i){let e;const t=i.extensions&&i.extensions[j.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+En(t.attributes):e=i.indices+":"+En(i.attributes)+":"+i.mode,i.targets!==void 0)for(let s=0,n=i.targets.length;s<n;s++)e+=":"+En(i.targets[s]);return e}function En(i){let e="";const t=Object.keys(i).sort();for(let s=0,n=t.length;s<n;s++)e+=t[s]+":"+i[t[s]]+";";return e}function Wn(i){switch(i){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function Df(i){return i.search(/\.jpe?g($|\?)/i)>0||i.search(/^data\:image\/jpeg/)===0?"image/jpeg":i.search(/\.webp($|\?)/i)>0||i.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const If=new oe;class Bf{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new nf,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,n=!1,r=-1;typeof navigator<"u"&&(s=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)===!0,n=navigator.userAgent.indexOf("Firefox")>-1,r=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),typeof createImageBitmap>"u"||s||n&&r<98?this.textureLoader=new Ve(this.options.manager):this.textureLoader=new Il(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Ii(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,n=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(o){return o._markDefs&&o._markDefs()}),Promise.all(this._invokeAll(function(o){return o.beforeRoot&&o.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(o){const a={scene:o[0][n.scene||0],scenes:o[0],animations:o[1],cameras:o[2],asset:n.asset,parser:s,userData:{}};return Bt(r,a,n),vt(a,n),Promise.all(s._invokeAll(function(l){return l.afterRoot&&l.afterRoot(a)})).then(function(){e(a)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let n=0,r=t.length;n<r;n++){const o=t[n].joints;for(let a=0,l=o.length;a<l;a++)e[o[a]].isBone=!0}for(let n=0,r=e.length;n<r;n++){const o=e[n];o.mesh!==void 0&&(this._addNodeRef(this.meshCache,o.mesh),o.skin!==void 0&&(s[o.mesh].isSkinnedMesh=!0)),o.camera!==void 0&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const n=s.clone(),r=(o,a)=>{const l=this.associations.get(o);l!=null&&this.associations.set(a,l);for(const[c,d]of o.children.entries())r(d,a.children[c])};return r(s,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n instanceof Promise?n.catch(function(r){return console.warn("THREE.GLTFLoader: Extension error:",r),null}):n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let n=0;n<t.length;n++){const r=e(t[n]);r&&s.push(r)}return s}getDependency(e,t){const s=e+":"+t;let n=this.cache.get(s);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne(function(r){return r.loadNode&&r.loadNode(t)});break;case"mesh":n=this._invokeOne(function(r){return r.loadMesh&&r.loadMesh(t)});break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne(function(r){return r.loadBufferView&&r.loadBufferView(t)});break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne(function(r){return r.loadMaterial&&r.loadMaterial(t)});break;case"texture":n=this._invokeOne(function(r){return r.loadTexture&&r.loadTexture(t)});break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne(function(r){return r.loadAnimation&&r.loadAnimation(t)});break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne(function(r){return r!=this&&r.getDependency&&r.getDependency(e,t)}),!n)throw new Error("Unknown type: "+e);break}this.cache.add(s,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,n=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(n.map(function(r,o){return s.getDependency(e,o)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[j.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(r,o){s.load(In.resolveURL(t.uri,n.path),r,void 0,function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(s){const n=t.byteLength||0,r=t.byteOffset||0;return s.slice(r,r+n)})}loadAccessor(e){const t=this,s=this.json,n=this.json.accessors[e];if(n.bufferView===void 0&&n.sparse===void 0){const o=Sn[n.type],a=cs[n.componentType],l=n.normalized===!0,c=new a(n.count*o);return Promise.resolve(new se(c,o,l))}const r=[];return n.bufferView!==void 0?r.push(this.getDependency("bufferView",n.bufferView)):r.push(null),n.sparse!==void 0&&(r.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(r).then(function(o){const a=o[0],l=Sn[n.type],c=cs[n.componentType],d=c.BYTES_PER_ELEMENT,h=d*l,u=n.byteOffset||0,f=n.bufferView!==void 0?s.bufferViews[n.bufferView].byteStride:void 0,m=n.normalized===!0;let y,p;if(f&&f!==h){const g=Math.floor(u/f),v="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+g+":"+n.count;let w=t.cache.get(v);w||(y=new c(a,g*f,n.count*f/d),w=new Bl(y,f/d),t.cache.add(v,w)),p=new Ft(w,l,u%f/d,m)}else a===null?y=new c(n.count*l):y=new c(a,u,n.count*l),p=new se(y,l,m);if(n.sparse!==void 0){const g=Sn.SCALAR,v=cs[n.sparse.indices.componentType],w=n.sparse.indices.byteOffset||0,b=n.sparse.values.byteOffset||0,x=new v(o[1],w,n.sparse.count*g),M=new c(o[2],b,n.sparse.count*l);a!==null&&(p=new se(p.array.slice(),p.itemSize,p.normalized));for(let A=0,T=x.length;A<T;A++){const E=x[A];if(p.setX(E,M[A*l]),l>=2&&p.setY(E,M[A*l+1]),l>=3&&p.setZ(E,M[A*l+2]),l>=4&&p.setW(E,M[A*l+3]),l>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return p})}loadTexture(e){const t=this.json,s=this.options,r=t.textures[e].source,o=t.images[r];let a=this.textureLoader;if(o.uri){const l=s.manager.getHandler(o.uri);l!==null&&(a=l)}return this.loadTextureImage(e,r,a).catch(function(l){return console.warn(`THREE.GLTFLoader: Error loading texture ${e}:`,l),null})}loadTextureImage(e,t,s){const n=this,r=this.json,o=r.textures[e],a=r.images[t],l=(a.uri||a.bufferView)+":"+o.sampler;if(this.textureCache[l])return this.textureCache[l];const c=this.loadImageSource(t,s).then(function(d){if(!d)return console.warn(`THREE.GLTFLoader: Failed to load texture image for texture ${e}`),null;d.flipY=!1,d.name=o.name||a.name||"",d.name===""&&typeof a.uri=="string"&&a.uri.startsWith("data:image/")===!1&&(d.name=a.uri);const u=(r.samplers||{})[o.sampler]||{};return d.magFilter=Do[u.magFilter]||Mt,d.minFilter=Do[u.minFilter]||la,d.wrapS=Io[u.wrapS]||jt,d.wrapT=Io[u.wrapT]||jt,n.associations.set(d,{textures:e}),d}).catch(function(d){return console.warn(`THREE.GLTFLoader: Error in loadTextureImage for texture ${e}:`,d),null});return this.textureCache[l]=c,c}loadImageSource(e,t){const s=this,n=this.json,r=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(u=>u.clone());const o=n.images[e],a=self.URL||self.webkitURL;let l=o.uri||"",c=!1,d=null;if(o.bufferView!==void 0)l=s.getDependency("bufferView",o.bufferView).then(function(u){c=!0;const f=o.mimeType||"image/png",m=new Blob([u],{type:f});return d=a.createObjectURL(m),d}).catch(function(u){return console.warn(`THREE.GLTFLoader: Failed to get bufferView for image ${e}:`,u),null});else if(o.uri===void 0)return console.error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView"),Promise.resolve(null);const h=Promise.resolve(l).then(function(u){return u?new Promise(function(f,m){let y=f;t.isImageBitmapLoader===!0&&(y=function(p){const g=new gs(p);g.needsUpdate=!0,f(g)}),t.load(In.resolveURL(u,r.path),y,void 0,function(p){console.warn("THREE.GLTFLoader: Failed to load texture image:",u,p),f(null)})}):null}).then(function(u){return c===!0&&d&&setTimeout(()=>{try{a.revokeObjectURL(d)}catch(f){console.warn("THREE.GLTFLoader: Error revoking object URL:",f)}},1e3),u&&(u.userData.mimeType=o.mimeType||Df(o.uri)),u}).catch(function(u){if(c===!0&&d)try{a.revokeObjectURL(d)}catch(f){console.warn("THREE.GLTFLoader: Error revoking object URL on error:",f)}return console.warn("THREE.GLTFLoader: Couldn't load texture",l,u),null});return this.sourceCache[e]=h,h}assignTexture(e,t,s,n){const r=this;return this.getDependency("texture",s.index).then(function(o){if(!o)return console.warn(`THREE.GLTFLoader: Texture for ${t} failed to load, using default material`),null;if(s.texCoord!==void 0&&s.texCoord>0&&(o=o.clone(),o.channel=s.texCoord),r.extensions[j.KHR_TEXTURE_TRANSFORM]){const a=s.extensions!==void 0?s.extensions[j.KHR_TEXTURE_TRANSFORM]:void 0;if(a){const l=r.associations.get(o);o=r.extensions[j.KHR_TEXTURE_TRANSFORM].extendTexture(o,a),r.associations.set(o,l)}}return n!==void 0&&(o.colorSpace=n),e[t]=o,o}).catch(function(o){return console.warn(`THREE.GLTFLoader: Failed to assign texture for ${t}:`,o),null})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const n=t.attributes.tangent===void 0,r=t.attributes.color!==void 0,o=t.attributes.normal===void 0;if(e.isPoints){const a="PointsMaterial:"+s.uuid;let l=this.cache.get(a);l||(l=new zl,os.prototype.copy.call(l,s),l.color.copy(s.color),l.map=s.map,l.sizeAttenuation=!1,this.cache.add(a,l)),s=l}else if(e.isLine){const a="LineBasicMaterial:"+s.uuid;let l=this.cache.get(a);l||(l=new Hl,os.prototype.copy.call(l,s),l.color.copy(s.color),l.map=s.map,this.cache.add(a,l)),s=l}if(n||r||o){let a="ClonedMaterial:"+s.uuid+":";n&&(a+="derivative-tangents:"),r&&(a+="vertex-colors:"),o&&(a+="flat-shading:");let l=this.cache.get(a);l||(l=s.clone(),r&&(l.vertexColors=!0),o&&(l.flatShading=!0),n&&(l.normalScale&&(l.normalScale.y*=-1),l.clearcoatNormalScale&&(l.clearcoatNormalScale.y*=-1)),this.cache.add(a,l),this.associations.set(l,this.associations.get(s))),s=l}e.material=s}getMaterialType(){return sr}loadMaterial(e){const t=this,s=this.json,n=this.extensions,r=s.materials[e];let o;const a={},l=r.extensions||{},c=[];if(l[j.KHR_MATERIALS_UNLIT]){const h=n[j.KHR_MATERIALS_UNLIT];o=h.getMaterialType(),c.push(h.extendParams(a,r,t))}else{const h=r.pbrMetallicRoughness||{};if(a.color=new Z(1,1,1),a.opacity=1,Array.isArray(h.baseColorFactor)){const u=h.baseColorFactor;a.color.setRGB(u[0],u[1],u[2],He),a.opacity=u[3]}h.baseColorTexture!==void 0&&c.push(t.assignTexture(a,"map",h.baseColorTexture,q)),a.metalness=h.metallicFactor!==void 0?h.metallicFactor:1,a.roughness=h.roughnessFactor!==void 0?h.roughnessFactor:1,h.metallicRoughnessTexture!==void 0&&(c.push(t.assignTexture(a,"metalnessMap",h.metallicRoughnessTexture)),c.push(t.assignTexture(a,"roughnessMap",h.metallicRoughnessTexture))),o=this._invokeOne(function(u){return u.getMaterialType&&u.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(u){return u.extendMaterialParams&&u.extendMaterialParams(e,a)})))}r.doubleSided===!0&&(a.side=je);const d=r.alphaMode||Tn.OPAQUE;if(d===Tn.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,d===Tn.MASK&&(a.alphaTest=r.alphaCutoff!==void 0?r.alphaCutoff:.5)),r.normalTexture!==void 0&&o!==Ot&&(c.push(t.assignTexture(a,"normalMap",r.normalTexture)),a.normalScale=new k(1,1),r.normalTexture.scale!==void 0)){const h=r.normalTexture.scale;a.normalScale.set(h,h)}if(r.occlusionTexture!==void 0&&o!==Ot&&(c.push(t.assignTexture(a,"aoMap",r.occlusionTexture)),r.occlusionTexture.strength!==void 0&&(a.aoMapIntensity=r.occlusionTexture.strength)),r.emissiveFactor!==void 0&&o!==Ot){const h=r.emissiveFactor;a.emissive=new Z().setRGB(h[0],h[1],h[2],He)}return r.emissiveTexture!==void 0&&o!==Ot&&c.push(t.assignTexture(a,"emissiveMap",r.emissiveTexture,q)),Promise.all(c).then(function(){const h=new o(a);return r.name&&(h.name=r.name),vt(h,r),t.associations.set(h,{materials:e}),r.extensions&&Bt(n,h,r),h})}createUniqueName(e){const t=Gl.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,n=this.primitiveCache;function r(a){return s[j.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,t).then(function(l){return Bo(l,a,t)})}const o=[];for(let a=0,l=e.length;a<l;a++){const c=e[a],d=Lf(c),h=n[d];if(h)o.push(h.promise);else{let u;c.extensions&&c.extensions[j.KHR_DRACO_MESH_COMPRESSION]?u=r(c):u=Bo(new _t,c,t),n[d]={primitive:c,promise:u},o.push(u)}}return Promise.all(o)}loadMesh(e){const t=this,s=this.json,n=this.extensions,r=s.meshes[e],o=r.primitives,a=[];for(let l=0,c=o.length;l<c;l++){const d=o[l].material===void 0?Cf(this.cache):this.getDependency("material",o[l].material);a.push(d)}return a.push(t.loadGeometries(o)),Promise.all(a).then(function(l){const c=l.slice(0,l.length-1),d=l[l.length-1],h=[];for(let f=0,m=d.length;f<m;f++){const y=d[f],p=o[f];let g;const v=c[f];if(p.mode===Ie.TRIANGLES||p.mode===Ie.TRIANGLE_STRIP||p.mode===Ie.TRIANGLE_FAN||p.mode===void 0)g=r.isSkinnedMesh===!0?new jl(y,v):new me(y,v),g.isSkinnedMesh===!0&&g.normalizeSkinWeights(),p.mode===Ie.TRIANGLE_STRIP?g.geometry=Ro(g.geometry,ra):p.mode===Ie.TRIANGLE_FAN&&(g.geometry=Ro(g.geometry,Dn));else if(p.mode===Ie.LINES)g=new Vl(y,v);else if(p.mode===Ie.LINE_STRIP)g=new ql(y,v);else if(p.mode===Ie.LINE_LOOP)g=new Wl(y,v);else if(p.mode===Ie.POINTS)g=new Kl(y,v);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+p.mode);Object.keys(g.geometry.morphAttributes).length>0&&Rf(g,r),g.name=t.createUniqueName(r.name||"mesh_"+e),vt(g,r),p.extensions&&Bt(n,g,p),t.assignFinalMaterial(g),h.push(g)}for(let f=0,m=h.length;f<m;f++)t.associations.set(h[f],{meshes:e,primitives:f});if(h.length===1)return r.extensions&&Bt(n,h[0],r),h[0];const u=new J;r.extensions&&Bt(n,u,r),t.associations.set(u,{meshes:e});for(let f=0,m=h.length;f<m;f++)u.add(h[f]);return u})}loadCamera(e){let t;const s=this.json.cameras[e],n=s[s.type];if(!n){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return s.type==="perspective"?t=new ws(Qn.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):s.type==="orthographic"&&(t=new Xl(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),vt(t,s),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],s=[];for(let n=0,r=t.joints.length;n<r;n++)s.push(this._loadNodeShallow(t.joints[n]));return t.inverseBindMatrices!==void 0?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(n){const r=n.pop(),o=n,a=[],l=[];for(let c=0,d=o.length;c<d;c++){const h=o[c];if(h){a.push(h);const u=new oe;r!==null&&u.fromArray(r.array,c*16),l.push(u)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[c])}return new Yl(a,l)})}loadAnimation(e){const t=this.json,s=this,n=t.animations[e],r=n.name?n.name:"animation_"+e,o=[],a=[],l=[],c=[],d=[];for(let h=0,u=n.channels.length;h<u;h++){const f=n.channels[h],m=n.samplers[f.sampler],y=f.target,p=y.node,g=n.parameters!==void 0?n.parameters[m.input]:m.input,v=n.parameters!==void 0?n.parameters[m.output]:m.output;y.node!==void 0&&(o.push(this.getDependency("node",p)),a.push(this.getDependency("accessor",g)),l.push(this.getDependency("accessor",v)),c.push(m),d.push(y))}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(l),Promise.all(c),Promise.all(d)]).then(function(h){const u=h[0],f=h[1],m=h[2],y=h[3],p=h[4],g=[];for(let v=0,w=u.length;v<w;v++){const b=u[v],x=f[v],M=m[v],A=y[v],T=p[v];if(b===void 0)continue;b.updateMatrix&&b.updateMatrix();const E=s._createAnimationTracks(b,x,M,A,T);if(E)for(let P=0;P<E.length;P++)g.push(E[P])}return new $l(r,void 0,g)})}createNodeMesh(e){const t=this.json,s=this,n=t.nodes[e];return n.mesh===void 0?null:s.getDependency("mesh",n.mesh).then(function(r){const o=s._getNodeRef(s.meshCache,n.mesh,r);return n.weights!==void 0&&o.traverse(function(a){if(a.isMesh)for(let l=0,c=n.weights.length;l<c;l++)a.morphTargetInfluences[l]=n.weights[l]}),o})}loadNode(e){const t=this.json,s=this,n=t.nodes[e],r=s._loadNodeShallow(e),o=[],a=n.children||[];for(let c=0,d=a.length;c<d;c++)o.push(s.getDependency("node",a[c]));const l=n.skin===void 0?Promise.resolve(null):s.getDependency("skin",n.skin);return Promise.all([r,Promise.all(o),l]).then(function(c){const d=c[0],h=c[1],u=c[2];u!==null&&d.traverse(function(f){f.isSkinnedMesh&&f.bind(u,If)});for(let f=0,m=h.length;f<m;f++)d.add(h[f]);return d})}_loadNodeShallow(e){const t=this.json,s=this.extensions,n=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const r=t.nodes[e],o=r.name?n.createUniqueName(r.name):"",a=[],l=n._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(e)});return l&&a.push(l),r.camera!==void 0&&a.push(n.getDependency("camera",r.camera).then(function(c){return n._getNodeRef(n.cameraCache,r.camera,c)})),n._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(e)}).forEach(function(c){a.push(c)}),this.nodeCache[e]=Promise.all(a).then(function(c){let d;if(r.isBone===!0?d=new Zl:c.length>1?d=new J:c.length===1?d=c[0]:d=new pe,d!==c[0])for(let h=0,u=c.length;h<u;h++)d.add(c[h]);if(r.name&&(d.userData.name=r.name,d.name=o),vt(d,r),r.extensions&&Bt(s,d,r),r.matrix!==void 0){const h=new oe;h.fromArray(r.matrix),d.applyMatrix4(h)}else r.translation!==void 0&&d.position.fromArray(r.translation),r.rotation!==void 0&&d.quaternion.fromArray(r.rotation),r.scale!==void 0&&d.scale.fromArray(r.scale);return n.associations.has(d)||n.associations.set(d,{}),n.associations.get(d).nodes=e,d}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],n=this,r=new J;s.name&&(r.name=n.createUniqueName(s.name)),vt(r,s),s.extensions&&Bt(t,r,s);const o=s.nodes||[],a=[];for(let l=0,c=o.length;l<c;l++)a.push(n.getDependency("node",o[l]));return Promise.all(a).then(function(l){for(let d=0,h=l.length;d<h;d++)r.add(l[d]);const c=d=>{const h=new Map;for(const[u,f]of n.associations)(u instanceof os||u instanceof gs)&&h.set(u,f);return d.traverse(u=>{const f=n.associations.get(u);f!=null&&h.set(u,f)}),h};return n.associations=c(r),r})}_createAnimationTracks(e,t,s,n,r){const o=[],a=e.name?e.name:e.uuid,l=[];gt[r.path]===gt.weights?e.traverse(function(u){u.morphTargetInfluences&&l.push(u.name?u.name:u.uuid)}):l.push(a);let c;switch(gt[r.path]){case gt.weights:c=Pr;break;case gt.rotation:c=Rr;break;case gt.position:case gt.scale:c=Cr;break;default:switch(s.itemSize){case 1:c=Pr;break;case 2:case 3:default:c=Cr;break}break}const d=n.interpolation!==void 0?_f[n.interpolation]:ca,h=this._getArrayFromAccessor(s);for(let u=0,f=l.length;u<f;u++){const m=new c(l[u]+"."+gt[r.path],t.array,h,d);n.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(m),o.push(m)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const s=Wn(t.constructor),n=new Float32Array(t.length);for(let r=0,o=t.length;r<o;r++)n[r]=t[r]*s;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(s){const n=this instanceof Rr?Mf:Va;return new n(this.times,this.values,this.getValueSize()/3,s)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Of(i,e,t){const s=e.attributes,n=new he;if(s.POSITION!==void 0){const a=t.json.accessors[s.POSITION],l=a.min,c=a.max;if(l!==void 0&&c!==void 0){if(n.set(new _(l[0],l[1],l[2]),new _(c[0],c[1],c[2])),a.normalized){const d=Wn(cs[a.componentType]);n.min.multiplyScalar(d),n.max.multiplyScalar(d)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const r=e.targets;if(r!==void 0){const a=new _,l=new _;for(let c=0,d=r.length;c<d;c++){const h=r[c];if(h.POSITION!==void 0){const u=t.json.accessors[h.POSITION],f=u.min,m=u.max;if(f!==void 0&&m!==void 0){if(l.setX(Math.max(Math.abs(f[0]),Math.abs(m[0]))),l.setY(Math.max(Math.abs(f[1]),Math.abs(m[1]))),l.setZ(Math.max(Math.abs(f[2]),Math.abs(m[2]))),u.normalized){const y=Wn(cs[u.componentType]);l.multiplyScalar(y)}a.max(l)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(a)}i.boundingBox=n;const o=new xs;n.getCenter(o.center),o.radius=n.min.distanceTo(n.max)/2,i.boundingSphere=o}function Bo(i,e,t){const s=e.attributes,n=[];function r(o,a){return t.getDependency("accessor",o).then(function(l){i.setAttribute(a,l)})}for(const o in s){const a=qn[o]||o.toLowerCase();a in i.attributes||n.push(r(s[o],a))}if(e.indices!==void 0&&!i.index){const o=t.getDependency("accessor",e.indices).then(function(a){i.setIndex(a)});n.push(o)}return Lr.workingColorSpace!==He&&"COLOR_0"in s&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${Lr.workingColorSpace}" not supported.`),vt(i,e),Of(i,e,t),Promise.all(n).then(function(){return e.targets!==void 0?Pf(i,e.targets,t):i})}class Ff{constructor(e){this.parser=e,this.name="BL_decrypt"}beforeRoot(){const e=this.parser.json.asset,t=this.parser.json.accessors;if(e.copyright==="bestWay"&&e.encrypt===1&&t)for(let s=0;s<t.length-1;s++){const n=t[s];if(n.type==="VEC3"){n.count-=1;break}}}}const An=new WeakMap;class Nf extends oa{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,s,n){const r=new Ii(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,o=>{this.parse(o,t,n)},s,n)}parse(e,t,s=()=>{}){this.decodeDracoFile(e,t,null,null,q).catch(s)}decodeDracoFile(e,t,s,n,r=He,o=()=>{}){const a={attributeIDs:s||this.defaultAttributeIDs,attributeTypes:n||this.defaultAttributeTypes,useUniqueIDs:!!s,vertexColorSpace:r};return this.decodeGeometry(e,a).then(t).catch(o)}decodeGeometry(e,t){const s=JSON.stringify(t);if(An.has(e)){const l=An.get(e);if(l.key===s)return l.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let n;const r=this.workerNextTaskID++,o=e.byteLength,a=this._getWorker(r,o).then(l=>(n=l,new Promise((c,d)=>{n._callbacks[r]={resolve:c,reject:d},n.postMessage({type:"decode",id:r,taskConfig:t,buffer:e},[e])}))).then(l=>this._createGeometry(l.geometry));return a.catch(()=>!0).then(()=>{n&&r&&this._releaseTask(n,r)}),An.set(e,{key:s,promise:a}),a}_createGeometry(e){const t=new _t;e.index&&t.setIndex(new se(e.index.array,1));for(let s=0;s<e.attributes.length;s++){const n=e.attributes[s],r=n.name,o=n.array,a=n.itemSize,l=new se(o,a);r==="color"&&(this._assignVertexColorSpace(l,n.vertexColorSpace),l.normalized=!(o instanceof Float32Array)),t.setAttribute(r,l)}return t}_assignVertexColorSpace(e,t){if(t!==q)return;const s=new Z;for(let n=0,r=e.count;n<r;n++)s.fromBufferAttribute(e,n).convertSRGBToLinear(),e.setXYZ(n,s.r,s.g,s.b)}_loadLibrary(e,t){const s=new Ii(this.manager);return s.setPath(this.decoderPath),s.setResponseType(t),s.setWithCredentials(this.withCredentials),new Promise((n,r)=>{s.load(e,n,void 0,r)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(s=>{const n=s[0];e||(this.decoderConfig.wasmBinary=s[1]);const r=kf.toString(),o=["/* draco decoder */",n,"","/* worker */",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([o]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const n=new Worker(this.workerSourceURL);n._callbacks={},n._taskCosts={},n._taskLoad=0,n.postMessage({type:"init",decoderConfig:this.decoderConfig}),n.onmessage=function(r){const o=r.data;switch(o.type){case"decode":n._callbacks[o.id].resolve(o);break;case"error":n._callbacks[o.id].reject(o);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+o.type+'"')}},this.workerPool.push(n)}else this.workerPool.sort(function(n,r){return n._taskLoad>r._taskLoad?-1:1});const s=this.workerPool[this.workerPool.length-1];return s._taskCosts[e]=t,s._taskLoad+=t,s})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this.workerSourceURL!==""&&URL.revokeObjectURL(this.workerSourceURL),this}}function kf(){let i,e;onmessage=function(o){const a=o.data;switch(a.type){case"init":i=a.decoderConfig,e=new Promise(function(d){i.onModuleLoaded=function(h){d({draco:h})},DracoDecoderModule(i)});break;case"decode":const l=a.buffer,c=a.taskConfig;e.then(d=>{const h=d.draco,u=new h.Decoder;try{const f=t(h,u,new Int8Array(l),c),m=f.attributes.map(y=>y.array.buffer);f.index&&m.push(f.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:f},m)}catch(f){console.error(f),self.postMessage({type:"error",id:a.id,error:f.message})}finally{h.destroy(u)}});break}};function t(o,a,l,c){const d=c.attributeIDs,h=c.attributeTypes;let u,f;const m=a.GetEncodedGeometryType(l);if(m===o.TRIANGULAR_MESH)u=new o.Mesh,f=a.DecodeArrayToMesh(l,l.byteLength,u);else if(m===o.POINT_CLOUD)u=new o.PointCloud,f=a.DecodeArrayToPointCloud(l,l.byteLength,u);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!f.ok()||u.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+f.error_msg());const y={index:null,attributes:[]};for(const p in d){const g=self[h[p]];let v,w;if(c.useUniqueIDs)w=d[p],v=a.GetAttributeByUniqueId(u,w);else{if(w=a.GetAttributeId(u,o[d[p]]),w===-1)continue;v=a.GetAttribute(u,w)}const b=n(o,a,u,p,g,v);p==="color"&&(b.vertexColorSpace=c.vertexColorSpace),y.attributes.push(b)}return m===o.TRIANGULAR_MESH&&(y.index=s(o,a,u)),o.destroy(u),y}function s(o,a,l){const d=l.num_faces()*3,h=d*4,u=o._malloc(h);a.GetTrianglesUInt32Array(l,h,u);const f=new Uint32Array(o.HEAPF32.buffer,u,d).slice();return o._free(u),{array:f,itemSize:1}}function n(o,a,l,c,d,h){const u=h.num_components(),m=l.num_points()*u,y=m*d.BYTES_PER_ELEMENT,p=r(o,d),g=o._malloc(y);a.GetAttributeDataArrayForAllPoints(l,h,p,y,g);const v=new d(o.HEAPF32.buffer,g,m).slice();return o._free(g),{name:c,array:v,itemSize:u}}function r(o,a){switch(a){case Float32Array:return o.DT_FLOAT32;case Int8Array:return o.DT_INT8;case Int16Array:return o.DT_INT16;case Int32Array:return o.DT_INT32;case Uint8Array:return o.DT_UINT8;case Uint16Array:return o.DT_UINT16;case Uint32Array:return o.DT_UINT32}}}const ge=document.createElement("div");ge.style.position="fixed";ge.style.zIndex="9";ge.style.top="0px";ge.style.left="0px";ge.style.width="100%";ge.style.height="100%";ge.style.display="none";ge.style.textAlign="center";ge.style.flexDirection="column";ge.style.justifyContent="center";ge.style.alignItems="center";ge.style.userSelect="none";document.body.appendChild(ge);const qa=document.createElement("img");qa.src="./loading.webp ";ge.appendChild(qa);const Oo="Loading... ",ys=document.createElement("span");ys.style.fontSize="24px";ys.style.opacity="1";ys.style.color="#FFFFFF";ge.appendChild(ys);const _i={service(i){ge.style.display="flex",ys.innerHTML=Oo+i+"%"},close(){ge.style.display="none",ys.innerHTML=Oo+0+"%"}},Uf=new ec(function(){_i.close(),gd()},function(e,t,s){_i.service((100*t/s).toFixed(2))},function(e){console.error("Error loading:",e),_i.close()}),Kn=new sf(Uf),Wa=new Nf;Wa.setDecoderPath("https://www.gstatic.com/draco/versioned/decoders/1.5.6/");Kn.setDRACOLoader(Wa);class zf{constructor(){this.mixers=new Map,this.materialFlows=new Map,this.clock=new Jo,this.isPlaying=!1}addMixer(e,t){this.mixers.set(e,t),this.clock.start()}addMaterialFlow(e,t){this.materialFlows.set(e,{speedX:t,originalOffset:e.userData.originalOffset})}update(){if(this.isPlaying){const e=this.clock.getDelta();this.mixers.forEach(t=>{t.update(e)}),this.materialFlows.forEach((t,s)=>{s.map&&s.map.offset&&(s.map.offset.x+=t.speedX,s.map.offset.x>1&&(s.map.offset.x-=1))})}}play(){this.isPlaying=!0}stop(){this.isPlaying=!1}removeMaterialFlow(e){this.materialFlows.delete(e)}clearMaterialFlows(){this.materialFlows.clear()}}const Ws=new zf;function Fo(i,e){if(i.animations&&i.animations.length>0){const t=new tc(e);i.animations.forEach(s=>{const n=t.clipAction(s);n.setLoop(sc),n.clampWhenFinished=!0,n.play()}),Ws.addMixer(e,t),Ws.play(),console.log(`✅ 模型 ${e.name||"unnamed"} 的 ${i.animations.length} 个动画已自动播放`)}Hf(e)}function Hf(i){i.traverse(t=>{t.isMesh&&t.name&&t.name.includes("move")&&t.material&&(Array.isArray(t.material)?t.material.forEach(s=>{s.map&&(s.userData.originalOffset||(s.userData.originalOffset={x:s.map.offset.x,y:s.map.offset.y}),Ws.addMaterialFlow(s,-.0048))}):t.material.map&&(t.material.userData.originalOffset||(t.material.userData.originalOffset={x:t.material.map.offset.x,y:t.material.map.offset.y}),Ws.addMaterialFlow(t.material,-.0048)),console.log(`✅ 为包含"move"的mesh "${t.name}" 添加材质流动动画`))})}function Xn(i,e,t){const s=[];if(_i.service(0),md(),Array.isArray(i))i.forEach(n=>{if(n.type!==".glb"&&n.type!==".gltf")return;const r=Kn.loadAsync(n.path).then(o=>{Fo(o,o.scene),e(o,n.name)});s.push(r)});else{if(i.type!==".glb"&&i.type!==".gltf")return;const n=Kn.loadAsync(i.path).then(r=>{Fo(r,r.scene),e(r,i.name)});s.push(n)}return Promise.all(s).then(()=>{t&&t()})}class Gf extends _t{constructor(e=3e3,t=!1){super(),isNaN(e)?this._initByData(e.pathPointList,e.options,e.usage,t):this._initByMaxVertex(e,t)}_initByMaxVertex(e,t){this.setAttribute("position",new se(new Float32Array(e*3),3).setUsage(Ns)),this.setAttribute("normal",new se(new Float32Array(e*3),3).setUsage(Ns)),this.setAttribute("uv",new se(new Float32Array(e*2),2).setUsage(Ns)),t&&this.setAttribute("uv2",new se(new Float32Array(e*2),2).setUsage(Ns)),this.drawRange.start=0,this.drawRange.count=0,this.setIndex(e>65536?new Dr(e*3,1):new Ir(e*3,1))}_initByData(e,t={},s,n){const r=No(e,t,n);r&&r.count!==0?(this.setAttribute("position",new se(new Float32Array(r.position),3).setUsage(s||Zs)),this.setAttribute("normal",new se(new Float32Array(r.normal),3).setUsage(s||Zs)),this.setAttribute("uv",new se(new Float32Array(r.uv),2).setUsage(s||Zs)),n&&this.setAttribute("uv2",new se(new Float32Array(r.uv2),2).setUsage(s||Zs)),this.setIndex(r.position.length/3>65536?new Dr(r.indices,1):new Ir(r.indices,1))):this._initByMaxVertex(2,n)}update(e,t={}){const s=!!this.getAttribute("uv2"),n=No(e,t,s);n?(this._updateAttributes(n.position,n.normal,n.uv,s?n.uv2:null,n.indices),this.drawRange.count=n.count):this.drawRange.count=0}_resizeAttribute(e,t){let s=this.getAttribute(e);for(;s.array.length<t;){const n=s.array.length,r=new se(new Float32Array(n*2),s.itemSize,s.normalized);r.name=s.name,r.usage=s.usage,this.setAttribute(e,r),s=r}}_resizeIndex(e){let t=this.getIndex();for(;t.array.length<e;){const s=t.array.length,n=new se(s*2>65535?new Uint32Array(s*2):new Uint16Array(s*2),1);n.name=t.name,n.usage=t.usage,this.setIndex(n),t=n}}_updateAttributes(e,t,s,n,r){this._resizeAttribute("position",e.length);const o=this.getAttribute("position");o.array.set(e,0),o.updateRange.count=e.length,o.needsUpdate=!0,this._resizeAttribute("normal",t.length);const a=this.getAttribute("normal");a.array.set(t,0),a.updateRange.count=t.length,a.needsUpdate=!0,this._resizeAttribute("uv",s.length);const l=this.getAttribute("uv");if(l.array.set(s,0),l.updateRange.count=s.length,l.needsUpdate=!0,n){this._resizeAttribute("uv2",n.length);const d=this.getAttribute("uv2");d.array.set(n,0),d.updateRange.count=n.length,d.needsUpdate=!0}this._resizeIndex(r.length);const c=this.getIndex();c.set(r,0),c.updateRange.count=r.length,c.needsUpdate=!0}}function No(i,e,t=!1){const s=e.width||.1,n=e.progress!==void 0?e.progress:1,r=e.arrow!==void 0?e.arrow:!0,o=e.side!==void 0?e.side:"both",a=s/2,l=o!=="both"?s/2:s,c=i.distance(),d=n*c;if(c==0)return null;const h=a/l,u=a/c;let f=0;const m=[],y=[],p=[],g=[],v=[];let w=0;const b=new _,x=new _,M=new _,A=new _,T=new _,E=new _;function P(R){const O=m.length===0,B=R.sharp&&!O,W=R.dist/c,te=R.dist/c,ne=R.dir,H=R.up,Dt=R.right;if(o!=="left"?b.copy(Dt).multiplyScalar(a*R.widthScale):b.set(0,0,0),o!=="right"?x.copy(Dt).multiplyScalar(-a*R.widthScale):x.set(0,0,0),b.add(R.pos),x.add(R.pos),B){M.fromArray(m,m.length-6).sub(x),A.fromArray(m,m.length-3).sub(b);const _e=M.length(),Ee=A.length(),dt=_e-Ee;let Es,It;dt>0?(Es=M,It=x):(Es=A,It=b),T.copy(Es).setLength(Math.abs(dt)).add(It);let Xi=E.copy(It).sub(T).normalize().dot(ne),Yi=E.copy(It).sub(T).length(),Ys=Xi*Yi*2;E.copy(ne).setLength(Ys).add(T),dt>0?(m.push(T.x,T.y,T.z,b.x,b.y,b.z,x.x,x.y,x.z,b.x,b.y,b.z,E.x,E.y,E.z,b.x,b.y,b.z),w+=6,v.push(w-6,w-8,w-7,w-6,w-7,w-5,w-4,w-6,w-5,w-2,w-4,w-1),f+=12):(m.push(x.x,x.y,x.z,T.x,T.y,T.z,x.x,x.y,x.z,b.x,b.y,b.z,x.x,x.y,x.z,E.x,E.y,E.z),w+=6,v.push(w-6,w-8,w-7,w-6,w-7,w-5,w-6,w-5,w-3,w-2,w-3,w-1),f+=12),y.push(H.x,H.y,H.z,H.x,H.y,H.z,H.x,H.y,H.z,H.x,H.y,H.z,H.x,H.y,H.z,H.x,H.y,H.z),p.push(W-h,0,W-h,1,W,0,W,1,W+h,0,W+h,1),t&&g.push(te-u,0,te-u,1,te,0,te,1,te+u,0,te+u,1)}else m.push(x.x,x.y,x.z,b.x,b.y,b.z),y.push(H.x,H.y,H.z,H.x,H.y,H.z),p.push(W,0,W,1),t&&g.push(te,0,te,1),w+=2,O||(v.push(w-2,w-4,w-3,w-2,w-3,w-1),f+=6)}const L=new _;function C(R){const O=R.dir,B=R.up,W=R.right,te=R.dist/l,ne=R.dist/c;o!=="left"?b.copy(W).multiplyScalar(a*2):b.set(0,0,0),o!=="right"?x.copy(W).multiplyScalar(-a*2):x.set(0,0,0),L.copy(O).setLength(a*3),b.add(R.pos),x.add(R.pos),L.add(R.pos),m.push(x.x,x.y,x.z,b.x,b.y,b.z,L.x,L.y,L.z),y.push(B.x,B.y,B.z,B.x,B.y,B.z,B.x,B.y,B.z),p.push(te,o!=="both"?o!=="right"?-2:0:-.5,te,o!=="both"?o!=="left"?2:0:1.5,te+1.5,o!=="both"?0:.5),t&&g.push(ne,o!=="both"?o!=="right"?-2:0:-.5,ne,o!=="both"?o!=="left"?2:0:1.5,ne+1.5*s/c,o!=="both"?0:.5),w+=3,v.push(w-1,w-3,w-2),f+=3}let D;if(d>0)for(let R=0;R<i.count;R++){const O=i.array[R];if(O.dist>d){const B=i.array[R-1];D=new ic;const W=(d-B.dist)/(O.dist-B.dist);D.lerpPathPoints(B,O,W),P(D);break}else P(O)}else D=i.array[0];return r&&(D=D||i.array[i.count-1],C(D)),{position:m,normal:y,uv:p,uv2:g,indices:v,count:f}}var et,Ka,Xa,Ya,$a;class jf extends me{constructor(t,s={}){super();Y(this,et);this.elapsedTime={value:0};const n={value:s.seg},r={value:s.modelPosition},o={time:this.elapsedTime,seg:n,position:r,uColor:s.uColor};this.geometry=$(this,et,Ka).call(this,t),this.material=$(this,et,Xa).call(this,o)}update(t){this.elapsedTime.value=t}}et=new WeakSet,Ka=function(t){const s=new _(0,1,0),n=new nc;n.set(t,.5,10,s,!1);const r=new Gf;return r.update(n,{width:3.2,arrow:!1,side:"both"}),r},Xa=function(t){return new Me({uniforms:{uElapseTime:t.time,uSeg:t.seg,modelPosition:t.position,edgeColor:{value:new Z("#fffffff")},uColor:{value:t.uColor||new Z("#00DC3B")}},vertexShader:$(this,et,Ya).call(this),fragmentShader:$(this,et,$a).call(this),side:je,forceSinglePass:!0})},Ya=function(){return`
      uniform float uElapseTime;
      varying vec2 st;

      #include <common>
      #include <uv_pars_vertex>
      #include <normal_pars_vertex>
      #include <logdepthbuf_pars_vertex>

      void main() {
      	#include <uv_vertex>
      	#include <beginnormal_vertex>
      	#include <defaultnormal_vertex>
      	#include <normal_vertex>
      	#include <begin_vertex>
        st = uv;
      	#include <project_vertex>
      	#include <logdepthbuf_vertex>
      	#include <worldpos_vertex>
      }`},$a=function(){return`
      uniform float uSeg;
      uniform float modelPosition;
      uniform vec3 uColor;
      uniform vec3 edgeColor;
    uniform float uElapseTime;
    varying vec2 st;


      void rotate2d(inout vec2 v, float a) {
       mat2 m = mat2(cos(a), -sin(a), sin(a), cos(a));
       v = m * v;
      }
       float arrow(vec2 av) {
        float line1L = 0.5;
         float line1 = length(av - vec2(clamp(av.x, -line1L, line1L), 0.));
         line1 = smoothstep(0.06, 0.05, line1);

         vec2 rav = av;
         rav.x -= line1L + 0.03;
         rotate2d(rav, 3.1415/1.54);

         float arrowL = 0.39;
         float line2 = length(rav - vec2(clamp(rav.x, 0., arrowL), 0.));
         line2 = smoothstep(0.06, 0.05, line2);

         rotate2d(rav, -3.1415 * 1.3 );
         float line3 = length(rav - vec2(clamp(rav.x, 0., arrowL),0.));
         line3 = smoothstep(0.06, 0.05, line3);

         return clamp(line2 + line3 , 0., 1.);
      }
    #include <common>
    #include <packing>
    #include <color_pars_fragment>
    #include <uv_pars_fragment>
    #include <normal_pars_fragment>
    #include <logdepthbuf_pars_fragment>
    #include <clipping_planes_pars_fragment>

    void main() {
    	#include <logdepthbuf_fragment>
    	#include <normal_fragment_begin>
    	#include <normal_fragment_maps>
     #include <dithering_fragment>

      float p = uSeg; //线段段数
      vec2 nst = (st * 2.0)-1.0;
      vec2 vSt = vec2(fract(nst.x * p- uElapseTime), nst.y);
          vec3 col;
          float a = arrow(vSt) ;
          vec3 cola = uColor;  //底色
          vec3 colb = edgeColor;
          col = mix(cola,colb,a);

          float al = 1.0;
          // float al = a;
          if(abs(0.5 - st.y) >= 0.4){
            float s = smoothstep(0.4, 0.5,abs(0.5 - st.y));
            col = mix(cola,colb,s);
            al = 1.0;
          }
          gl_FragColor = vec4(col,al);
    }
`};class Vf{constructor(e,t){this.core=t,this.scene=e,this.cherryArray=[],this.path=[],this.gatherMap=new Map,this.realTimeMap=new Map,this.trackGroup=new J,this.trackGroup.name="逃生路线",this.scene._add(this.trackGroup)}setCherryArray(e){this.cherryArray=e}cherryPick(){this.trackGroup.traverse(e=>{e instanceof me&&(e.visible=this.cherryArray.includes("escapeRoute"))}),this.cherryArray.includes("escapeRoute")?(this.core.core.postprocessing.setNoSelection(this.path),this.core.core.postprocessing.addOutline(this.path,1)):(this.core.core.postprocessing.clearOutline(this.path,1),this.core.core.postprocessing.clearNoSelection())}init(e){e.forEach(({id:t,data:s,name:n})=>{const r=s.map(l=>{let c=zi({sceneType:1,originId:"",coordinate:l});return new _(c.x,c.y+.1,c.z)}),o=new rc(r);let a=new jf(r,{seg:Math.floor(o.getLength())/4});a.material.depthTest=!0,a.visible=this.cherryArray.includes("escapeRoute"),this.trackGroup.add(a),this.path.push(a)})}dispose(){[...this.path].forEach(e=>{e.deleteSelf()}),this.path=[],console.log(this.path,this.trackGroup),this.core.core.postprocessing.clearOutline(this.path,1)}update(e){this.path.forEach(t=>{t&&t.update(e.elapsedTime)})}}class Yn extends oc{constructor(e){super(e),this.type=Qs}parse(e){const o=function(T,E){switch(T){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(E||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(E||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(E||""));default:case 4:throw new Error("THREE.RGBELoader: Memory Error: "+(E||""))}},d=`
`,h=function(T,E,P){E=E||1024;let C=T.pos,D=-1,R=0,O="",B=String.fromCharCode.apply(null,new Uint16Array(T.subarray(C,C+128)));for(;0>(D=B.indexOf(d))&&R<E&&C<T.byteLength;)O+=B,R+=B.length,C+=128,B+=String.fromCharCode.apply(null,new Uint16Array(T.subarray(C,C+128)));return-1<D?(T.pos+=R+D+1,O+B.slice(0,D)):!1},u=function(T){const E=/^#\?(\S+)/,P=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,L=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,C=/^\s*FORMAT=(\S+)\s*$/,D=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,R={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let O,B;for((T.pos>=T.byteLength||!(O=h(T)))&&o(1,"no header found"),(B=O.match(E))||o(3,"bad initial token"),R.valid|=1,R.programtype=B[1],R.string+=O+`
`;O=h(T),O!==!1;){if(R.string+=O+`
`,O.charAt(0)==="#"){R.comments+=O+`
`;continue}if((B=O.match(P))&&(R.gamma=parseFloat(B[1])),(B=O.match(L))&&(R.exposure=parseFloat(B[1])),(B=O.match(C))&&(R.valid|=2,R.format=B[1]),(B=O.match(D))&&(R.valid|=4,R.height=parseInt(B[1],10),R.width=parseInt(B[2],10)),R.valid&2&&R.valid&4)break}return R.valid&2||o(3,"missing format specifier"),R.valid&4||o(3,"missing image size specifier"),R},f=function(T,E,P){const L=E;if(L<8||L>32767||T[0]!==2||T[1]!==2||T[2]&128)return new Uint8Array(T);L!==(T[2]<<8|T[3])&&o(3,"wrong scanline width");const C=new Uint8Array(4*E*P);C.length||o(4,"unable to allocate buffer space");let D=0,R=0;const O=4*L,B=new Uint8Array(4),W=new Uint8Array(O);let te=P;for(;te>0&&R<T.byteLength;){R+4>T.byteLength&&o(1),B[0]=T[R++],B[1]=T[R++],B[2]=T[R++],B[3]=T[R++],(B[0]!=2||B[1]!=2||(B[2]<<8|B[3])!=L)&&o(3,"bad rgbe scanline format");let ne=0,H;for(;ne<O&&R<T.byteLength;){H=T[R++];const _e=H>128;if(_e&&(H-=128),(H===0||ne+H>O)&&o(3,"bad scanline data"),_e){const Ee=T[R++];for(let dt=0;dt<H;dt++)W[ne++]=Ee}else W.set(T.subarray(R,R+H),ne),ne+=H,R+=H}const Dt=L;for(let _e=0;_e<Dt;_e++){let Ee=0;C[D]=W[_e+Ee],Ee+=L,C[D+1]=W[_e+Ee],Ee+=L,C[D+2]=W[_e+Ee],Ee+=L,C[D+3]=W[_e+Ee],D+=4}te--}return C},m=function(T,E,P,L){const C=T[E+3],D=Math.pow(2,C-128)/255;P[L+0]=T[E+0]*D,P[L+1]=T[E+1]*D,P[L+2]=T[E+2]*D,P[L+3]=1},y=function(T,E,P,L){const C=T[E+3],D=Math.pow(2,C-128)/255;P[L+0]=Js.toHalfFloat(Math.min(T[E+0]*D,65504)),P[L+1]=Js.toHalfFloat(Math.min(T[E+1]*D,65504)),P[L+2]=Js.toHalfFloat(Math.min(T[E+2]*D,65504)),P[L+3]=Js.toHalfFloat(1)},p=new Uint8Array(e);p.pos=0;const g=u(p),v=g.width,w=g.height,b=f(p.subarray(p.pos),v,w);let x,M,A;switch(this.type){case ls:A=b.length/4;const T=new Float32Array(A*4);for(let P=0;P<A;P++)m(b,P*4,T,P*4);x=T,M=ls;break;case Qs:A=b.length/4;const E=new Uint16Array(A*4);for(let P=0;P<A;P++)y(b,P*4,E,P*4);x=E,M=Qs;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:v,height:w,data:x,header:g.string,gamma:g.gamma,exposure:g.exposure,type:M}}setDataType(e){return this.type=e,this}load(e,t,s,n){function r(o,a){switch(o.type){case ls:case Qs:o.colorSpace=He,o.minFilter=Mt,o.magFilter=Mt,o.generateMipmaps=!1,o.flipY=!0;break}t&&t(o,a)}return super.load(e,r,s,n)}}function Oi(i,e=[],t=!1,s=1){if(i instanceof me){const{geometry:n,material:r}=i,o=new aa(n,r,e.length);return o.instanceMatrix.setUsage(Ns),!e||e.length===0?(console.error(`${i.name}:创建实例化对象，无位置信息`),new J):(e.forEach((a,l)=>{const c=new oe;let d=1;if(Array.isArray(s)){const[h,u]=s;d=h+Math.random()*(u-h)}else d=parseFloat(s);if(c.makeScale(d,d,d),c.setPosition(a),t)if(t.length){const h=new oe().makeRotationFromEuler(t[l]);c.multiply(h)}else c.multiply(new oe().makeRotationY(Math.random()*Math.PI*2));o.setMatrixAt(l,c),o.castShadow=!0}),o)}else if(i instanceof J){const n=new J;return i.traverse(r=>{r instanceof me&&n.add(Oi(r,e,t,s))}),n}else{const n=new J;return i.children.forEach(r=>{n.add(Oi(r,e,t,s))}),n}}const at=i=>{const e=new he;e.setFromObject(i);const t=e.getCenter(new _),s=e.max.distanceTo(t);return{center:t,radius:s,min:e.min,max:e.max,boundingBox:e}},qf=(i,e,t,s,n)=>{let r=document.createElement("div"),o=document.createElement("div");o.append(r),o.draggable=!1,o.className="beilu_three_Board_text_person",r.innerText=i;let a=Re(o),l=null;return r.onclick=c=>{l&&(clearTimeout(l),l=null),l=setTimeout(()=>{e&&e(a,c),l=null},250)},r.ondblclick=c=>{l&&(clearTimeout(l),l=null),t&&t(a,c)},s&&(r.onmouseenter=c=>{s(a,c)}),n&&(r.onmouseleave=c=>{n(a,c)}),a},Wf=(i,e=!1)=>{let t=document.createElement("div"),s=document.createElement("div");s.append(t),s.draggable=!1,s.className="buildingNum",t.innerText=i;let n=Re(s);return n.visible=e,n},ko=new k,Uo=new k;class Kf{constructor(e){N(this,"onmousedown",e=>{this.getMouse(e,ko)});N(this,"onmouseup",e=>{if(this.getMouse(e,Uo),!!ko.equals(Uo)){if(e.button===2){this.removeListener(),this.helper.active=!1,ae.dispose(this.label,!0),this.label=null,this.addCloseButton(this.hitPoint);return}this.hitPoint&&(this.helper.addPoint(this.hitPoint),this.label&&(this.label.visible=this.helper.count!==0),this.createLabel2(this.hitPoint))}});N(this,"onkeyup",e=>{console.log("触发键盘操作"),e.key==="Escape"&&(this.helper.deletePoint(),this.updateLabel(),this.label.visible=this.helper.count!==0,ae.dispose(this.labels.pop(),!0))});N(this,"getMouse",(e,t)=>{const{left:s,top:n,width:r,height:o}=this.core.domElement.getBoundingClientRect();t.x=(e.clientX-s)/r*2-1,t.y=-((e.clientY-n)/o)*2+1});N(this,"raycastOnmousemove",e=>{e.length?(this.hitPoint=e[0].point,this.helper.updateMoveLine(this.hitPoint),!this.label&&this.helper.count>0?this.createLabel():this.label&&this.updateLabel()):this.hitPoint=null});this.core=e.core,this.scene=e.scene,this.subsystem=e,this.active=!1,this.raycastObject=null,this.hitPoint=null,this.helper=new cr(this.scene),this.core.onresizeQueue.set(Symbol(),this.helper.onresize),this.labels=[]}setRaycastObject(e){this.raycastObject=e}start(){this.active!==!0&&(this.active=!0,this.helper.active=!0,this.mousedownControls=this.core.addEventListener("mousedown"),this.mouseupControls=this.core.addEventListener("mouseup"),this.keyupControls=this.core.addEventListener("keyup"),this.mousedownControls.add(this.onmousedown),this.mouseupControls.add(this.onmouseup),this.keyupControls.add(this.onkeyup),this.raycastControls=this.core.raycast("mousemove",this.raycastObject,this.raycastOnmousemove))}removeListener(){console.log("触发移除监听"),this.helper.active===!0&&(this.helper.active=!1,this.mousedownControls.clear(),this.mouseupControls.clear(),this.keyupControls.clear(),this.raycastControls.clear())}end(){(this.active=!1)||(this.active=!1,this.removeListener(),this.helper.dispose(),ae.dispose([this.label,this.labels],!0),this.labels.length=0,this.label=null)}createLabel(){const e=document.createElement("div");e.className="measure-container";const t=Je({innerText:"0m",className:"area-label"});e.appendChild(t),this.label=Re(e),this.scene.add(this.label)}createLabel2(e){const t=document.createElement("div");t.className="measure-container";const s=this.helper.getTotalLength(2),n=Je({innerText:s+"m",className:"area-label"});t.appendChild(n);let r=Re(t);r.position.set(e.x,e.y+10,e.z),this.labels.push(r),this.scene.add(r)}addCloseButton(e){const t=Je({innerText:"X",className:"measure-close"});this.labels[this.labels.length-1].element.appendChild(t),t.onclick=()=>{this.end(),this.start()}}updateLabel(){const e=this.label.element;if(e){const t=this.helper.getTotalLength(2);e.children[0].innerText=t+"m",this.hitPoint&&this.setLabelPosition(this.hitPoint)}}setLabelPosition(e,t=10){this.label.position.set(e.x,e.y+t,e.z)}}const zo=new k,Ho=new k;class Xf{constructor(e){N(this,"onmousedown",e=>{this.getMouse(e,zo)});N(this,"onmouseup",e=>{this.getMouse(e,Ho),zo.equals(Ho)&&this.hitPoint&&(this.helper.addPoint(this.hitPoint),this.label&&(this.label.visible=this.helper.count!==0),this.helper.isClosed&&(this.removeListener(),this.setLabelData(this.helper.getArea(2)),this.setLabelPosition(this.helper.getCenter()),this.addCloseButton(this.hitPoint)))});N(this,"onkeyup",e=>{e.key==="Escape"&&(this.helper.deletePoint(),this.label.visible=this.helper.count!==0,this.updateLabel())});N(this,"getMouse",(e,t)=>{const{left:s,top:n,width:r,height:o}=this.core.domElement.getBoundingClientRect();t.x=(e.clientX-s)/r*2-1,t.y=-((e.clientY-n)/o)*2+1});N(this,"raycastOnmousemove",e=>{e.length?(this.hitPoint=e[0].point,this.helper.updateMoveLine(this.hitPoint),!this.label&&this.helper.count>0?this.createLabel():this.label&&this.updateLabel()):this.hitPoint=null});this.core=e.core,this.scene=e.scene,this.subsystem=e,this.active=!1,this.raycastObject=null,this.hitPoint=null,this.helper=new cr(this.scene),this.helper.needToAdhereToFirstPoint=!0,this.helper.closestDistanceToAdhere=10,this.helper.needCheckLinesCross=!0,this.core.onresizeQueue.set(Symbol(),this.helper.onresize)}setRaycastObject(e){this.raycastObject=e}start(){this.active!==!0&&(this.active=!0,this.helper.active=!0,this.mousedownControls=this.core.addEventListener("mousedown"),this.mouseupControls=this.core.addEventListener("mouseup"),this.keyupControls=this.core.addEventListener("keyup"),this.mousedownControls.add(this.onmousedown),this.mouseupControls.add(this.onmouseup),this.keyupControls.add(this.onkeyup),this.raycastControls=this.core.raycast("mousemove",this.raycastObject,this.raycastOnmousemove))}removeListener(){this.helper.active===!0&&(this.helper.active=!1,this.mousedownControls.clear(),this.mouseupControls.clear(),this.keyupControls.clear(),this.raycastControls.clear())}end(){this.active!==!1&&(this.active=!1,this.removeListener(),this.helper.dispose(),this.label&&this.label.deleteSelf(),this.label=null)}createLabel(){const e=document.createElement("div");e.className="measure-container";const t=Je({innerText:"0m²",className:"area-label"});e.appendChild(t),this.label=Re(e),this.scene.add(this.label)}updateLabel(){this.label.element&&this.setLabelPosition(this.hitPoint)}addCloseButton(e){const t=Je({innerText:"X",className:"measure-close"});this.label.element.appendChild(t),t.onclick=()=>{this.end(),this.start()}}setLabelPosition(e,t=20){this.label.position.set(e.x,e.y+t,e.z)}setLabelData(e){this.label.element&&(this.label.element.children[0].innerText=e+"m²")}}class Yf{constructor(e,t){this.core=t,this.scene=e,this.fenceObj={},this.dangerFence=null,this.dangerFenceGroup=new J,this.dangerFenceGroupName="dangerFence",this.scene._add(this.dangerFenceGroup),this.FenceGroup=new J,this.FenceGroupName="FenceGroup",this.scene._add(this.FenceGroup),this.buildingFenceGroup=new J,this.FenceGroupName="buildingFence",this.scene._add(this.buildingFenceGroup),this.textures=this.createTextures()}create(e){const{fenceData:t,id:s,name:n,type:r}=e;if(this.fenceObj[s])return console.log("围栏已存在"),!1;let o=[],a=[];t.map((v,w)=>{o.push([v.position.x,v.position.y,v.position.z]),w<t.length-1&&a.push(v.position)});const l=[],c=10,d=new _t,h=[],u=[],f=o.reduce((v,w,b)=>{let x=0;if(b>0){let M=new _(...o[b-1]),A=new _(...w);x=M.distanceTo(A)}return v+=x,l.push(v),v},0);o.forEach((v,w)=>{if(w==0)return;const b=o[w-1];h.push(...b),u.push(l[w-1]/f,0),h.push(...v),u.push(l[w]/f,0),h.push(b[0],b[1]+c,b[2]),u.push(l[w-1]/f,1),h.push(...v),u.push(l[w]/f,0),h.push(v[0],v[1]+c,v[2]),u.push(l[w]/f,1),h.push(b[0],b[1]+c,b[2]),u.push(l[w-1]/f,1)}),d.setAttribute("position",new se(new Float32Array(h),3)),d.setAttribute("uv",new se(new Float32Array(u),2));const m=new Ot({map:this.textures[r],transparent:!0,opacity:1,depthWrite:!1,depthTest:!0,side:je,forceSinglePass:!0}),y=new me(d,m);y.material.onBeforeCompile=v=>{const w=`
      vec3 outgoingLight = reflectedLight.indirectDiffuse;
      outgoingLight.xyz *= 1.8;
      `;v.fragmentShader=v.fragmentShader.replace("vec3 outgoingLight = reflectedLight.indirectDiffuse",w)};let p=this.getCenter(a),g=this.createLabel(n,p,this.boardClick.bind(this));r==="danger"&&(g=this.createDangerLabel(n,p,this.boardClick.bind(this))),g.position.set(p.x,16,p.z),r==="building"?(this.buildingFenceGroup.add(g),this.buildingFenceGroup.add(y),this.cameraMove(n)):r==="area"?(this.fenceObj[s]={mesh:y,label:g},this.FenceGroup.add(g),this.FenceGroup.add(y)):r==="danger"&&(this.dangerFence={mesh:y,label:g},this.dangerFenceGroup.add(g),this.dangerFenceGroup.add(y),this.core.tweenControl.lerpTo(p,50,1e3,new _(-40,40,0)))}getCenter(e,t=new _){const s=t;return e.forEach(n=>{s.addScaledVector(n,1/e.length)}),s}createTextures(){const e={danger:"/textures/areaNice/03.png",building:"/textures/areaNice/02.png",area:"/textures/areaNice/03.png"},t=new Ve,s={};return Reflect.ownKeys(e).forEach(r=>{const o=t.load(e[r]);o.wrapS=jt,o.wrapT=jt,o.repeat.set(-1,2),s[r]=o}),s}boardClick(e){this.core.tweenControl.lerpTo(e,50,1e3,new _(0,10,0))}createLabel(e,t,s){let n=document.createElement("img"),r=document.createElement("img");n.className="by_arrow_left",n.src="/textures/arrow_left.png",r.className="by_arrow_right",r.src="/textures/arrow_right.png";const o=Je({innerText:e,className:"by_label_b",children:[n,r]});return typeof s=="function"&&(o.onclick=()=>{s(t)}),Re(o)}createDangerLabel(e,t,s){const n=Je({innerText:e,className:"by_label_b_danger"});return typeof s=="function"&&(n.onclick=()=>{s(t)}),Re(n)}clearDangerFence(){this.dangerFence=null;for(let e=this.dangerFenceGroup.children.length-1;e>=0;e--)this.dangerFenceGroup.children[e].deleteSelf()}clearBuildingFence(){this.dangerFence=null;for(let e=this.buildingFenceGroup.children.length-1;e>=0;e--)this.buildingFenceGroup.children[e].deleteSelf()}clearFence(){this.fenceObj={};for(let e=this.FenceGroup.children.length-1;e>=0;e--)this.FenceGroup.children[e].deleteSelf()}initDangerFence(e){this.clearDangerFence(),this.create(e,!0)}dispose(){this.clearDangerFence(),this.clearFence(),this.clearBuildingFence()}update(){if(!this.textures)return!1;Reflect.ownKeys(this.textures).forEach(e=>{const t=this.textures[e];t.offset.y-=.01})}cameraMove(e){const t={化工分公司:{camera:{x:-337,y:857,z:616},controls:{x:-350,y:3,z:-306}},热电分公司:{camera:{x:-1033,y:666,z:-77},controls:{x:-1033,y:74,z:-543}},水泥有限公司:{camera:{x:-960,y:677,z:272},controls:{x:-960,y:-16,z:-93}}},s=t[e].camera,n=t[e].controls,r=this.core.camera,o=this.core.controls;return new Promise((a,l)=>{this.core.tweenControl.changeTo({start:r.position,end:s,duration:1e3,onComplete:()=>{o.enabled=!0,a()},onStart:()=>{o.enabled=!1}}),this.core.tweenControl.changeTo({start:o.target,end:n,duration:1e3,onUpdate:()=>{r.lookAt(o.target)}})})}}function $f(){return new Me({transparent:!0,vertexShader:Zf,fragmentShader:Qf,side:je,uniforms:{uTime:ac,uStyle:Hi}})}const Zf=`
#include <logdepthbuf_pars_vertex>
#include <common>
${ha}
varying vec2 st;

void main(){
  st = uv;

  #include <begin_vertex>
  #include <project_vertex>
  #include <logdepthbuf_vertex>
}
`,Qf=`

${ha}
varying vec2 st;
uniform float uTime;
uniform float uStyle;
#define TAU 6.28318530718
#define MAX_ITER 5


#include <logdepthbuf_pars_fragment>
void main() {


  float time = uTime * .5+23.0;

  vec2 q = st * 0.3;
      vec2 p = mod(q*TAU, TAU)-250.0;

   vec2 i = vec2(p);
   float c = 1.0;
   float inten = .005;

   for (int n = 0; n < MAX_ITER; n++)
   {
    float t = time * (1.0 - (3.5 / float(n+1)));
    i = p + vec2(cos(t - i.x) + sin(t + i.y), sin(t - i.y) + cos(t + i.x));
    c += 1.0/length(vec2(p.x / (sin(i.x+t)/inten),p.y / (cos(i.y+t)/inten)));
   }
   c /= float(MAX_ITER);
   c = 1.17-pow(c, 1.4);
   vec3 color = vec3(pow(abs(c), 8.0));
      color = clamp(color + vec3(0.0, 0.35, 0.5), 0.0, 1.0);

   if(uStyle == ${lc}.){
     gl_FragColor = vec4(color, 0.4);
   }else if(uStyle == ${cc}.){
    gl_FragColor = vec4(color*0.1,0.4);
   }

   ${hc}
 #include <logdepthbuf_fragment>
}
`;function Jf(i,e={value:0},t=new Z(16776960),s){const n={uTime:e,uColor:t,num:s};i.onBeforeCompile=r=>{Lt(r,"gatherFenceEffect",n)}}function ep(i,e=1800,t=3e3){const s={fade:e,land:t};i.onBeforeCompile=n=>{Lt(n,"edgeFadeDis",s)}}function tp(i,e=10){const t={strength:e};i.onBeforeCompile=s=>{Lt(s,"brighten",t)}}function sp(i,e=10){const t={strength:e,uStyle:Hi};i.onBeforeCompile=s=>{Lt(s,"brightenNight",t)}}function ip(i,e){const t={uTime:e};i.onBeforeCompile=s=>{Lt(s,"fadeByTime",t)}}function np(i,e,t=new Z("#3acacc")){const s={uTime:e,uBox:dc,lightIndex:uc,uColor:t};i.onBeforeCompile=n=>{Lt(n,"dynamicFade",s)}}function rp(i){const e={uStyle:Hi};i.onBeforeCompile=t=>{Lt(t,"glassEffect",e)}}function Go(i,e=new Z("#59FFD3")){const t={uStyle:Hi,uColor:e};i.onBeforeCompile=s=>{Lt(s,"treeModify",t)}}function op(i,e=.5){const t=new Ve().load("./textures/water_normal.jpg");t.wrapS=t.wrapT=jt,i.normalMap=t,i.normalScale.set(e,e)}function ap(i){const e=i.core,t=e.camera,s=e.controls;let n;function r(){clearTimeout(n),s.autoRotate=!1,s.rotateSpeed=1,n=setTimeout(()=>{s.target.copy(Fi.Default.target),t.position.copy(Fi.Default.position),s.autoRotate=!0,s.rotateSpeed=.01},i.roamDuration*1e3)}function o(){i.core.domElement.addEventListener("mousemove",r)}function a(){i.core.domElement.removeEventListener("mousemove",r),clearTimeout(n)}const l=()=>({begin:o,updateCameraState:r,stop:a});return i.useCameraState=l,l}const lp=$f();function cp(i,e){const t=e.onRenderQueue||e.core.onRenderQueue,s=i.material;if(s.name.includes("镜面水")){i.visible=!1;const n=new he;n.setFromObject(i);const r=new fc(n,100,100),o=r.mesh;i.getWorldPosition(o.position),o.rotation.z=i.rotation.y,t.set(Symbol(),r.update.bind(r)),e.add(o)}else s.name.includes("水")&&(i.material=lp);s.name.includes("漆面")&&(s.roughness=.5,s.metalness=.5,op(s,.1)),s.name.includes("夜光玻璃")?(s.transparent=!0,rp(s)):s.name.includes("夜光")?sp(s,20):s.name.includes("发光")&&(tp(s,10),i.castShadow=!1,e.bloomLights.push(i)),s.name.includes("边缘虚化")&&(s.transparent=!0,ep(s,1600,2800)),s.needsUpdate=!0}function hp(i,e,t){i.isMesh&&(up(i),cp(i,t))}function up(i,e,t){i.material,(["shu3_2","shu4_2"].includes(i.name)||i.name.includes("_1"))&&Go(i.material)}class dp{constructor(e,t){this.core=t,this.scene=e,this.fenceObj={},this.FenceGroup=new J,this.FenceGroupName="FenceGroup",this.scene._add(this.FenceGroup),this.elapsedTime={value:0},this.gatherColor={green:new Z("#00DC3B"),yellow:new Z("#FFBC00")},this.gatherModelColor={green:new Z(0,.2,0),yellow:new Z(.2,.2,0)},this.textures=this.createShaders()}create(e){const{id:t,type:s,areaType:n,areaDataOut:r,areaDataBuilding:o,areaName:a}=e;if(this.fenceObj[t])return console.log("围栏已存在"),!1;let l=s===1?"green":"yellow";if(n===1){let c=[],d=[],h=[];r.map((A,T)=>{let E=zi({sceneType:1,originId:"",coordinate:A});c.push([E.x,E.y,E.z]),h.push(E.x,E.y,E.z),T<r.length-1&&d.push(E)});const u=[];let f=this.createLine(h,l);const m=10,y=new _t,p=[],g=[],v=c.reduce((A,T,E)=>{let P=0;if(E>0){let L=new _(...c[E-1]),C=new _(...T);P=L.distanceTo(C)}return A+=P,u.push(A),A},0);c.forEach((A,T)=>{if(T==0)return;const E=c[T-1];p.push(...E),g.push(u[T-1]/v,0),p.push(...A),g.push(u[T]/v,0),p.push(E[0],E[1]+m,E[2]),g.push(u[T-1]/v,1),p.push(...A),g.push(u[T]/v,0),p.push(A[0],A[1]+m,A[2]),g.push(u[T]/v,1),p.push(E[0],E[1]+m,E[2]),g.push(u[T-1]/v,1)}),y.setAttribute("position",new se(new Float32Array(p),3)),y.setAttribute("uv",new se(new Float32Array(g),2));const w=this.textures[l],b=new me(y,w);b.renderOrder=32;let x=this.getCenter(d),M=this.createLabel(a,x,this.boardClick.bind(this),s);M.position.set(x.x,16,x.z),this.fenceObj[t]={object3d:b,label:M,type:"fence",line:f},this.FenceGroup.add(M),this.FenceGroup.add(b),this.FenceGroup.add(f)}if(n===2){let c=this.core.singleBuildingGroup,d=this.core.buildingMeshObj;if(!c[o]&&!d[o])return console.log("楼栋信息在三维场景中不在");let h=c[o]||d[o],u=this.gatherModel(h,s,a);this.fenceObj[t]={object3d:h,label:u,type:"geometry"},this.FenceGroup.add(u)}console.log(this.FenceGroup,this.core,"FenceGroup")}createLine(e,t){let s=new Ki({color:this.gatherColor[t],linewidth:5,dashed:!1,depthTest:!1});s.resolution.set(window.innerWidth,window.innerHeight);const n=new qs;n.setPositions(e);let r=new Gn(n,s);return r.computeLineDistances(),r.scale.set(1,1,1),r}gatherModel(e,t,s){let n=t===1?"green":"yellow";e.traverse(c=>{if(c instanceof me)if(c.material.length){let d=[];c.material.map(h=>{let u=h.clone();u.transparent=!0,u.opacity=.88,u.emissive=this.gatherModelColor[n],d.push(u)}),c.oldMaterial=c.material,c.material=d}else{let d=c.material.clone();d.transparent=!0,d.opacity=.88,d.emissive=this.gatherModelColor[n],c.oldMaterial=c.material,c.material=d}});const{center:r,max:o}=at(e),a=new _(r.x,o.y,r.z);let l=this.createLabel(s,a,this.boardClick.bind(this),t);return l.position.set(a.x,a.y+8,a.z),l}getCenter(e,t=new _){const s=t;return e.forEach(n=>{s.addScaledVector(n,1/e.length)}),s}createShaders(){const e={green:this.gatherColor.green,yellow:this.gatherColor.yellow};let t={};return Object.entries(e).forEach(([s,n])=>{let r=new sr({side:je,transparent:!0,depthTest:!0,depthWrite:!1,blending:pc});Jf(r,this.elapsedTime,n,{value:2}),t[s]=r}),t}boardClick(e){this.core.tweenControl.lerpTo(e,50,1e3,new _(0,10,0))}createLabel(e,t,s,n){let r=document.getElementById("statusBoard").cloneNode(!0);return r.innerText=e,n===2&&(r.className="yellowArea"),typeof s=="function"&&(r.onclick=()=>{s(t)}),Re(r)}clearGeometryGather(e){e.traverse(t=>{t instanceof me&&(t.material=t.oldMaterial,delete t.oldMaterial)})}clearFence(){Object.values(this.fenceObj).forEach(e=>{e.type==="fence"&&(e.object3d.deleteSelf(),e.label.deleteSelf(),e.line.deleteSelf()),e.type==="geometry"&&(e.label.deleteSelf(),this.clearGeometryGather(e.object3d)),this.FenceGroup.children.forEach(t=>{t.removeFromParent()}),this.fenceObj={}})}dispose(){this.clearFence()}changeDomVisible(e){Object.values(this.fenceObj).forEach(t=>{t.label.element.style.display=e?"block":"none"})}update(e){Object.values(this.fenceObj).length&&(this.core.core.sceneType===0&&this.changeDomVisible(!1),this.core.core.sceneType===1&&this.changeDomVisible(!0))}}class fp{constructor(e,t){this.core=t,this.scene=e,this.cherryArray=[],this.spriteObject={},this.equipSprite=this.generateLabel("/equip/road.png"),this.equipGroup=new J,this.scene._add(this.equipGroup)}setCherryArray(e){this.cherryArray=e}cherryPick(){this.equipGroup.traverse(e=>{e instanceof Di&&(e.visible=this.cherryArray.includes("meetingPoint"))})}create(e){const{id:t,position:s,name:n}=e;if(this.spriteObject[t])return console.log("集合点已存在"),!1;let r=this.equipSprite.clone();r.name=n;let o=zi({sceneType:1,originId:"",coordinate:s});r.position.set(o.x,o.y,o.z),r.visible=this.cherryArray.includes("meetingPoint"),this.spriteObject[t]=r,this.equipGroup.add(r)}generateLabel(e,t=.048){const s=new Ve().load(e),n=new tr({map:s,sizeAttenuation:!1,depthTest:!1,depthWrite:!1}),r=new Di(n);return r.renderOrder=1,r.scale.set(t,t,t),r.center=new k(.5,0),r}dispose(){this.clearFence()}update(e){}}const pp=["其他模型.glb","内地形.glb","外地形.glb","室内模型外壳.glb"],mp=["AFS9512042_制冷.glb","AFS9512043_制热.glb","AFS9512044_配电室.glb"],gp=["AFS9512042","AFS9512043","AFS9512044"];class jo{constructor(){this.element=null,this.css2dObject=null,this.isVisible=!1,this.createTooltip()}createTooltip(){const e=document.createElement("div");e.className="building-tooltip-container",e.style.cssText=`
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s ease;
      transform: translate(-50%, -100%);
      margin-top: -8px;
    `;const t=document.createElement("div");t.innerHTML="双击进入室内，单击拉近视角",e.appendChild(t);const s=document.createElement("div");s.style.cssText=`
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 6px solid rgba(0, 0, 0, 0.8);
    `,e.appendChild(s),this.element=e,this.css2dObject=Re(e),this.css2dObject.visible=!1}show(e){!this.isVisible&&this.css2dObject&&this.element&&(this.css2dObject.position.copy(e),this.css2dObject.visible=!0,this.element.style.opacity="1",this.isVisible=!0)}hide(){this.isVisible&&this.css2dObject&&(this.element.style.opacity="0",setTimeout(()=>{this.css2dObject&&(this.css2dObject.visible=!1),this.isVisible=!1},200))}updatePosition(e){this.isVisible&&this.css2dObject&&this.css2dObject.position.copy(e)}destroy(){this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,this.css2dObject=null}}class $n{constructor(){this.element=null,this.isVisible=!1,this.createHint()}createHint(){const e=document.createElement("div");e.className="scene-hint-container",e.style.cssText=`
      position: fixed !important;
      top: 20px !important;
      right: 20px !important;
      background: rgba(0, 0, 0, 0.8) !important;
      color: white !important;
      padding: 12px 16px !important;
      border-radius: 8px !important;
      font-size: 14px !important;
      white-space: nowrap !important;
      pointer-events: none !important;
      z-index: 9999 !important;
      opacity: 0 !important;
      transition: opacity 0.3s ease !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      backdrop-filter: blur(4px) !important;
      font-family: Arial, sans-serif !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
      display: block !important;
      visibility: visible !important;
      height: auto !important;
      width: auto !important;
      overflow: visible !important;
      transform: none !important;
    `;const t=document.createElement("div");t.innerHTML="右键双击恢复默认视角",e.appendChild(t),document.body.appendChild(e),this.element=e,console.log("SceneHint created:",e),setTimeout(()=>{this.element&&(this.element.style.opacity="1",this.isVisible=!0,console.log("SceneHint force shown"))},100)}show(e){this.element&&(this.element.querySelector("div").innerHTML=e,this.element.style.opacity="1",this.isVisible=!0,console.log("SceneHint shown:",e))}hide(){this.element&&this.isVisible&&(this.element.style.opacity="0",this.isVisible=!1,console.log("SceneHint hidden"))}updateMessage(e){this.element&&(this.element.querySelector("div").innerHTML=e,console.log("SceneHint message updated:",e))}destroy(){this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,console.log("SceneHint destroyed")}}const yp=Symbol(),vp=Symbol(),Za=new _,bp=new xs(Za,2880),wp=new xs(Za,2880),Mn={maxPolarAngle:Math.PI/2};class xp extends Ga{constructor(t){super(t);N(this,"limitCameraInSphere",()=>{this.controls.enableRotate&&(this.camera.position.clampSphere(bp),this.controls.target.clampSphere(wp),this.camera.position.y=this.camera.position.y<this.altitude?this.altitude:this.camera.position.y,this.controls.target.y=this.controls.target.y<this.altitude?this.altitude:this.controls.target.y)});N(this,"boardClick",t=>{const s=new _(2,2,0);this.tweenControl.lerpTo(t.position,20,1e3,s)});this.tweenControl=t.tweenControl,this.scene.background=ua,this.setHDRSky(),this.onRenderQueue=t.onRenderQueue,this.controls=t.controls,this.baseCamera=t.baseCamera,this.camera=t.camera,this.orientation=t.orientation,this.boxSelect=t.orientation.boxSelect,this.postprocessing=t.postprocessing,this.buildingMeshArr=[],this.buildingMeshObj={},this.buildingNames=gp,this.bloomLights=[],this.buildingNameLabelMap={},this.buildingNum={},this.singleBuildingGroup={},this.labelGroup=new J,this.labelGroup.name="labelGroupHome",this._add(this.labelGroup),this.groundMesh=null,this.fencePlate=null,this.gatherOrSilentPlate=null,this.eventClear=[],this.pointerArr=[],this.isLoaded=!1,this.searchBuildingId=null,this.roamEnabled=!1,this.roamDuration=10,this.filterBuildingArr=["buildingBoard"],this.boxSelectStatus=!1,this.instancedMesh=[],this.altitude=-20,this.modelList=[],this.modelGroup=new J,this.scene.add(this.modelGroup),this.loadedModels=new Map,this.tooltip=new jo,this.labelGroup.add(this.tooltip.css2dObject),this.sceneHint=new $n,this.init()}async init(){console.log("Ground system initializing...");try{const t=pp.map(s=>({name:s.replace(".glb",""),path:`./models/outDoor/${s}`,type:".glb"}));console.log("Loading models with configs:",t),this.initLight(),await Xn(t,(s,n)=>{if(!s||!s.scene){console.error(`❌ 模型加载失败: ${n} - 无效的模型数据`);return}console.log(`✅ 成功加载模型: ${n}`),this.onProgress(s,n)},()=>{console.log("✅ 所有模型加载完成"),this.handleIndoorEquipTree(),this.initComponents(),this.onLoaded()})}catch(t){throw console.error("❌ 加载模型时出错:",t),t.response&&(console.error("响应状态:",t.response.status),console.error("响应头:",t.response.headers)),t}}initComponents(){this.fencePlate=new Yf(this.scene,this),this.escapeRoute=new Vf(this.scene,this),this.gatherOrSilentPlate=new dp(this.scene,this),this.meetingPoint=new fp(this.scene,this),console.log("Creating Weather instance with this:",this),console.log("Ground scene:",this.scene),this.measureDistance=new Kf(this),this.measureArea=new Xf(this),this.core&&this.core.onRenderQueue&&(this.core.onRenderQueue.set(yp,this.update.bind(this)),this.gatherOrSilentPlate&&this.core.onRenderQueue.set("gatherOrSilentFence",this.gatherOrSilentPlate.update.bind(this.gatherOrSilentPlate)),this.escapeRoute&&this.core.onRenderQueue.set("escapeRoute",this.escapeRoute.update.bind(this.escapeRoute)))}handleControls(){this.controls.addEventListener("change",this.limitCameraInSphere),Reflect.ownKeys(Mn).forEach(t=>{this.controls.data[t]=this.controls[t],this.controls[t]=Mn[t]})}resetControls(){this.controls.removeEventListener("change",this.limitCameraInSphere),Reflect.ownKeys(Mn).forEach(t=>{this.controls[t]=this.controls.data[t]})}setCameraState(t){if(!this.useCameraState)return;const{begin:s,updateCameraState:n,stop:r}=this.useCameraState();n(this.roamDuration),t&&this.core.currentSystem===this?s():r()}addEventListener(){if(this.eventClear.length>0)return;let t=this.core.raycast("dblclick",this.buildingMeshArr,r=>{if(r.length){let a=r[0].object;for(;a.parent&&!this.buildingNames.some(l=>a.name.includes(l));)a=a.parent;!this.boxSelectStatus&&this.buildingNames.some(l=>a.name.includes(l))&&(xd(a.name.split("_")[0]),this.core.changeSystem("indoorSubsystem",a.name))}});this.addGroundEvent();let s=this.core.rightDblClickListener(()=>{this.resetCamera()});this.eventClear.push(t.clear),this.eventClear.push(s),Object.values(this.buildingNum).forEach(r=>{r.element.onclick=()=>this.buildingNumClick(r.name)});const n=this.core.raycast("dblclick",this.groundMesh,r=>{r.length&&!this.boxSelectStatus&&this.tweenControl.lerpTo(r[0].point,50,1e3,new _(0,10,0))});this.eventClear.push(n.clear)}groundClickEvent(t){let s=t.intersectObjects(this.buildingMeshArr);if(s.length){const n=s[0].object;n.userData.buildingName&&this.commonSearchBuilding(n.userData.buildingName)}}addGroundEvent(){this.core.addClickCustom(this.groundClickEvent.bind(this));let t=this.core.raycast("mousemove",this.buildingMeshArr,n=>{if(!(this.core.elapsedTime*10&1))if(n.length){const r=n[0].object;if(r.userData.buildingName){this.postprocessing.clearOutlineAll(1);const o=this.buildingMeshObj[this.searchBuildingId],a=this.buildingMeshArr.filter(c=>c.userData.buildingName===r.userData.buildingName);a.length>0&&this.postprocessing.addOutline([...a,o],1);const l=r.userData.buildingName;if(this.buildingNames.some(c=>l.includes(c))&&this.tooltip){const c=new _;r.getWorldPosition(c),c.y+=10,this.tooltip.show(c)}}}else{if(this.postprocessing.clearOutlineAll(1),this.searchBuildingId){let r=this.buildingMeshObj[this.searchBuildingId];this.postprocessing.addOutline(r,1)}this.tooltip&&this.tooltip.hide()}}),s=this.core.raycast("mousemove",this.orientation.orientation3D.pointerArr,n=>{n.length?document.body.style.cursor="pointer":document.body.style.cursor="auto"});this.eventClear.push(s.clear),this.eventClear.push(t.clear)}onEnter(){this.handleControls(),V.onLoad(this,this.core),this.boxSelect.onLoad(this),this.filterBuildingNum(),this.tooltip||(this.tooltip=new jo,this.labelGroup.add(this.tooltip.css2dObject)),this.sceneHint.show("右键双击恢复默认视角"),this.groundMesh&&(this.onLoaded(),this.isLoaded=!0)}initDangerFence(t){this.fencePlate.initDangerFence(t)}hideBuildingLabel(t=this.searchBuildingId){let s=t||this.searchBuildingId;if(!s)return!1;this.buildingNameLabelMap[s].visible=!1,this.buildingNameLabelMap[s].element.style.display="none",this.searchBuildingId=null,this.postprocessing.clearOutlineAll(1)}hideAllBuildingLabel(){Object.values(this.buildingNameLabelMap).map(t=>{t.visible=!1,t.element.style.display="none"}),Object.values(this.buildingNum).forEach(t=>{t.traverse(s=>{s.visible=!1,t.element.style.display="none"})}),this.searchBuildingId=null,this.tooltip&&this.tooltip.hide()}clearDangerFence(){this.fencePlate.clearDangerFence()}clearBuildingFence(){this.fencePlate.clearBuildingFence()}historyTrackCommand(t){t.cmd==="trackInit"&&(this.orientation.orientation3D.hiddenAllPerson=!0,this.orientation.updateModules(),this.removeEventListener(),this.postprocessing.clearOutlineAll()),t.cmd==="trackClear"&&(this.removeEventListener(),this.historyTrack.path||this.addEventListener(),this.orientation.orientation3D.hiddenAllPerson=!1,this.orientation.updateModules()),this.historyTrack.command(t)}startMeasuring(){this.removeEventListener(),this.measureDistance.start()}removeMeasuring(){this.measureDistance.end(),this.addEventListener(),this.resetCamera()}startMeasureArea(){this.removeEventListener(),this.measureArea.start()}removeMeasureArea(){this.measureArea.end(),this.addEventListener(),this.resetCamera()}changeBoxSelect(t){this.boxSelectStatus=t,t?(this.removeEventListener(),this.boxSelect.start()):(this.boxSelect.end(),this.addEventListener(),this.resetCamera())}searchBuilding(t=!0){t&&wd(this.searchBuildingId);let s=this.buildingNameLabelMap[this.searchBuildingId];this.boardClick(s),this.postprocessing.clearOutlineAll(1);let n=this.buildingMeshObj[this.searchBuildingId];this.postprocessing.addOutline(n,1)}createFence(t){this.fencePlate.create(t)}clearFence(){this.fencePlate.dispose()}onProgress(t,s){if(this.core.scene!==this.scene)return;const n=t.scene;if(this.adjustModelMaterials(n),s==="内地形"){const{min:r}=at(n);this.altitude=r.y,n.traverse(o=>{o.isMesh&&(o.receiveShadow=!0)}),this.groundMesh=n}s==="室内模型外壳"&&n.children.forEach(r=>{r.traverse(o=>{o.isMesh&&(o.castShadow=!0,o.receiveShadow=!0,this.buildingMeshArr.push(o),this.buildingMeshObj[o.name]=o,o.userData.buildingName=s)}),this.setBuildingBoard(r)}),this._add(n)}adjustModelMaterials(t){t.traverse(s=>{s.isMesh&&s.material&&(Array.isArray(s.material)?s.material.forEach(n=>this.adjustMaterial(n)):this.adjustMaterial(s.material))})}adjustMaterial(t){t&&(t.roughness!==void 0&&t.roughness===0&&(t.roughness=.2,console.log(`调整材质 ${t.name||"unnamed"} 的 roughness: 0 -> 0.2`)),t.metalness!==void 0&&t.metalness===1&&(t.metalness=.68))}processPendingEnvMapMaterials(){this.pendingEnvMapMaterials&&this.pendingEnvMapMaterials.length>0&&this.scene.environment&&(console.log(`处理 ${this.pendingEnvMapMaterials.length} 个待设置环境贴图的材质`),this.pendingEnvMapMaterials.forEach(t=>{t.envMap=this.scene.environment,t.envMapIntensity=2,t.needsUpdate=!0}),this.pendingEnvMapMaterials=[])}materialClone(t,s){if(t.isMesh){const n=t.material.name;if(s[n])t.material=s[n];else{const r=t.material.clone();s[n]=r,t.material=r}t.material.originTransparent=t.material.transparent}}setBuildingBoard(t){const{center:s,max:n}=at(t),r=new _(s.x,n.y,s.z),o=t.name,a=o.split("_")[1],l=qf(a,d=>{this.cameraMoveToBuildingTitle(o)},d=>{this.core.changeSystem("indoorSubsystem",o)},d=>{if(this.buildingNames.some(h=>o.includes(h))&&this.tooltip){const h=d.position.clone();h.y+=5,this.tooltip.show(h)}},d=>{this.tooltip&&this.tooltip.hide()});l.visible=!0,l.position.copy(r),this.labelGroup.add(l),this.buildingNameLabelMap[o]=l;const c=Wf(0,!1);c.position.copy(r),c.scale.set(.2,.2,.2),c.name=o,this.labelGroup.add(c),this.buildingNum[o]=c}setFilterBuilding(t){this.filterBuildingArr.length=0,this.filterBuildingArr=t}filterBuildingNum(){const t=this.filterBuildingArr.includes("buildingBoard");Object.values(this.buildingNum).forEach(s=>{s.traverse(n=>{n.visible=t,n.visible=parseInt(n.element.innerText)>0?t:!1})})}cameraMoveToBuildingTitle(t){this.commonSearchBuilding(t)}commonSearchBuilding(t){console.log(t,"id"),this.searchBuildingId=t,this.searchBuilding(),this.removeEventListener(),this.addEventListener()}buildingNumClick(t){Td(t)}changeBuildingNumber(t){t.map(s=>{const{id:n,number:r}=s;if(!buildingMap[n]||!this.buildingNum[n])return!1;this.buildingNum[n].element.innerText=String(r),this.buildingNum[n].visible=r>0&&this.filterBuildingArr.includes("buildingBoard")})}showSingleBuildingBoard(t){Object.entries(this.buildingNameLabelMap).map(([s,n])=>{s===t?n.visible=!0:n.visible=!1})}onLeave(){this.hideAllBuildingLabel(),this.resetControls(),this.setCameraState(!1),this.core.onRenderQueue.delete(vp),this.measureArea.end(),this.measureDistance.end(),this.boxSelect.end(),this.removeEventListener(),document.body.style.cursor="auto",this.tooltip&&(this.tooltip.destroy(),this.tooltip=null),this.sceneHint&&this.sceneHint.hide(),console.log("离开地面广场系统")}onLoaded(){this.useCameraState||ap(this),this.roamEnabled&&this.setCameraState(!0),this.instancedMesh&&this.instancedMesh.length>0&&this.instancedMesh.forEach(t=>{t&&t instanceof pe&&this._add(t)}),console.log("All models loaded successfully"),this.addEventListener(),Ra("home"),this.resetCamera(1500).then(()=>{this.core&&this.core.crossSearch&&this.core.crossSearch.changeSceneSearch(),super.updateOrientation()})}handleIndoorEquipTree(){const t=mp.map(n=>({name:n.split(".")[0],path:`./models/inDoor/${n}`,type:".glb"}));let s={};Xn(t,(n,r)=>{const o=n.scene.children.find(a=>a.name==="equip");o&&o.children&&(s[`${r}`]=o.children.map(a=>{const l=a.name.split("_");return{id:l[0],name:l[l.length-1]}}))},()=>{console.log("✅ 所有室内模型加载完成，推送设备树数据到前端"),Ad(s)})}removeEventListener(){this.eventClear.forEach(t=>t()),this.eventClear=[]}loadInstancedModel(t,s,n){const r=new J,o={},a={},l={},c=new _;function d(h){h.getWorldPosition(c);const u=h.name.split("_")[0];a[u]=a[u]||[],a[u].push(c.clone()),l[u]=l[u]||[],l[u].push(h.rotation)}return t.forEach(h=>{h.name.includes("zuobiao")&&h.traverse(u=>{d(u)}),h.name.includes("shili")&&h.children.forEach(u=>{o[u.name]=u,u.name.includes("shu")&&u.traverse(f=>{f instanceof me&&(f.material=new mc({map:f.material.map}),hp(f,"树",this))})})}),Object.keys(o).forEach(h=>{const u=o[h];let f;h.indexOf("shu")!==-1?f=Oi(u,a[h],!0,n):f=Oi(u,a[h],l[h],n),r.add(f),f instanceof J?f.traverse(s):s(f)}),r}resetCamera(t=1e3){if(!this.groundMesh)return console.warn("地面模型未加载，无法重置相机"),Promise.resolve();const{radius:s,center:n}=at(this.groundMesh);n.y+=s*.24;const r=new _(n.x,n.y+.4,n.z+s*1.2),o=n.clone();return new Promise((a,l)=>{r.distanceTo(this.camera.position)<5&&o.distanceTo(this.controls.target)<5&&a(),this.tweenControl.changeTo({start:this.camera.position,end:r,duration:t,onComplete:()=>{this.controls.enabled=!0,a()},onStart:()=>{this.controls.enabled=!1}}),this.tweenControl.changeTo({start:this.controls.target,end:o,duration:t,onUpdate:()=>{this.camera.lookAt(this.controls.target)}})})}initLight(){const t=new Jn(16777215,1.45),s=new as(16777215,1.55);s.shadow.camera.near=1,s.shadow.camera.far=3500,s.shadow.camera.right=2500,s.shadow.camera.left=-2500,s.shadow.camera.top=1600,s.shadow.camera.bottom=-1600,s.shadow.mapSize.width=Math.pow(2,11),s.shadow.mapSize.height=Math.pow(2,11),s.shadow.blurSamples=8,s.shadow.radius=1.15,s.shadow.bias=-.0015,s.position.set(15,48,-48),s.castShadow=!0;const n=new pe;n.position.set(0,0,0),s.target=n,this.ambientLight=t,this._add(this.ambientLight),this.directionalLight=s,this._add(this.directionalLight),this._add(n),new er(s.shadow.camera),new Ri(s,5),new as(13421772,.3).position.set(-150,150,0),new as(16777215,.4).position.set(150,100,0),console.log("地面系统灯光初始化完成")}showAllBuildingLabel(){Object.values(this.buildingNameLabelMap).forEach(t=>{t.visible=!0,t.element.style.display="block"})}destroy(){this.tooltip&&(this.tooltip.destroy(),this.tooltip=null),this.sceneHint&&(this.sceneHint.destroy(),this.sceneHint=null)}setHDRSky(){console.log("开始加载 HDR 天空贴图...");const t=new Yn;t.setDataType(ls),t.load("./bg.hdr",s=>{console.log("HDR 加载成功:",s),s.mapping=ks,s.colorSpace=q,s.exposure=2,this.scene.background=s;const n=s.clone();n.intensity=2,this.scene.environment=n,console.log("天空贴图设置完成"),this.processPendingEnvMapMaterials()},s=>{s.lengthComputable&&console.log("HDR 加载进度:",s.loaded/s.total*100+"%")},s=>{console.error("HDR 加载失败:",s),console.log("尝试使用备用方案..."),this.setFallbackSky()})}setFallbackSky(){try{new Ve().load("./sunny2.hdr",s=>{console.log("备用方案加载成功"),s.mapping=ks,s.colorSpace=q,s.exposure=.2,this.scene.background=s;const n=s.clone();n.intensity=.02,this.scene.environment=s},void 0,s=>{console.error("备用方案也失败:",s),this.scene.background=new Z(8900331),console.log("使用默认天空蓝色")})}catch(t){console.error("备用方案初始化失败:",t),this.scene.background=new Z(8900331),console.log("使用默认天空蓝色")}}}let Vo=0;const Sp={maxPolarAngle:Math.PI/2.05};class Tp extends Ga{constructor(e){super(e),this.gatherOrSilentData={},this.gatherOrSilentLabel=null,this.scene.background=ua,this.onRenderQueue=e.onRenderQueue,this.controls=e.controls,this.camera=e.camera,this.tweenControl=e.tweenControl,this.orientation=e.orientation,this.buildingObject={},this.currentFloor=null,this.eventClear=[],this.building=null,this.buildingName=null,this.endChangeFloor=!0,this.floors=[],this.sceneHint=new $n,console.log("this.sceneHint",this)}onEnter(e){this.core.ground&&this.core.ground.hideAllBuildingLabel&&this.core.ground.hideAllBuildingLabel(),this.currentPoint=null,V.onLoad(this,this.core),this.sceneHint||(this.sceneHint=new $n),this.sceneHint.show("右键双击返回室外"),this.setIndoorHDRSky();let t={name:e,path:`./models/inDoor/${e}.glb`,type:".glb"};return this.buildingName=e,Xn([t],this.onProgress.bind(this),this.onLoaded.bind(this))}createGround(e,t){const s=new gc(e,t);s.receiveShadow=!0,s.castShadow=!1,this.scene.environment&&s.material&&this.setupIndoorMaterial(s.material),this.scene.add(s)}resetControls(){Reflect.ownKeys(Sp).forEach(e=>{this.controls[e]=this.controls.data[e]})}onChangeSystemCustom(e,t,s){e==="outToIn"&&this.onEnter(s).then(()=>{this.changeFloor(t)}),e==="inToInSingle"&&this.changeFloor(t),e==="inToInOther"&&(this.clearIndoorData(),this.onEnter(s).then(()=>{this.changeFloor(t)}))}onProgress(e,t){const s=e.scene;let n=s.children.find(o=>o.name==="equip");this.building=n;const r={group:n,uTime:{value:1}};n.traverse(o=>{o.isMesh&&(this.modelProcessing(o,r),o.userData.parent=n.name)}),n.name.indexOf("BDW")===-1&&this.floors.push(n),this.buildingObject[n.name]=r,this.scene.add(s)}modelProcessing(e,t){e.castShadow=!0,e.receiveShadow=!0,e.material.transparent&&(e.renderOrder=3,e.material.depthWrite=!0),e.material=e.material.clone(),e.material.transparent=!0,e.material.metalness=.2,e.material.roughness=.8,this.setupIndoorMaterial(e.material),!e.name.includes("BDW")&&e.material.name.includes("建筑外壳")?(np(e.material,t.uTime,new Z("#3acacc")),e.renderOrder=2):ip(e.material,t.uTime)}onLoaded(){const e=at(this.building);this.createGround(e.center,e.min),this.createAndSetupLights(this.building),this.scene.environment&&this.processIndoorEnvMapMaterials(),this.cameraMove(this.building),this.addEventListener(),this.changeFloor("equip")}cameraMove(e){return new Promise((t,s)=>{let n,r;const{center:o,radius:a}=at(e);r=o,n=new _;const l=this.camera.position.distanceTo(o),c=(l-Math.sqrt(a)*12)/l;n.lerpVectors(this.camera.position,o,c),this.tweenControl.changeTo({start:this.camera.position,end:n,duration:1e3,onComplete:()=>{this.controls.enable=!0,t()},onStart:()=>{this.controls.enable=!1}}),this.tweenControl.changeTo({start:this.controls.target,end:r,duration:1e3,onUpdate:()=>{this.controls.update()}})})}cameraMoveToFloor(e){return new Promise((t,s)=>{const{center:n,radius:r,min:o,max:a}=at(e),l=a.y-o.y,c=n.clone(),d=Math.max(l*1.5,r*2),h=new _(n.x,n.y+l+d*.8,n.z+d*.6);this.tweenControl.changeTo({start:this.camera.position,end:h,duration:1200,onComplete:()=>{this.controls.enable=!0,t()},onStart:()=>{this.controls.enable=!1}}),this.tweenControl.changeTo({start:this.controls.target,end:c,duration:1200,onUpdate:()=>{this.controls.update()}})})}onLeave(){this.core.ground&&this.core.ground.showAllBuildingLabel&&this.core.ground.showAllBuildingLabel(),this.resetControls(),this.sceneHint&&this.sceneHint.hide(),this.clearIndoorHDR(),this.removeIndoorLights(),this.dispose()}addEventListener(){this.addRayDbClick(),this.addRayMove(),this.addRightDbClickQuit()}addRayDbClick(){let e=this.core.raycast("dblclick",this.floors,t=>{if(t.length){let s=t[0].object.userData.parent;this.changeFloor(s)}});return this.eventClear.push(e.clear),e.clear}disposeGatherOrSilent(){let e=[];for(let t in this.gatherOrSilentData)e.push(t);e.forEach(t=>{delete this.gatherOrSilentData[t]}),this.gatherOrSilentData={},this.disPoseGatherShader()}changeFloor(e){if(!this.buildingObject||!this.buildingObject[e])return console.warn(`楼层 "${e}" 的建筑数据尚未加载完成，请稍后再试`),!1;if(!this.endChangeFloor)return!1;if(this.resetData(),this.currentFloor||(this.endChangeFloor=!1,this.removeEventListener(),this.addPointerLister(),this.addIndoorEvent(),this.core.isFollowing()||this.addRightDbClickQuit(),this.switchFloorAnimate(e).then(o=>{window.configs.floorToName[this.buildingName+"_室内"]&&window.configs.floorToName[this.buildingName+"_室内"][e]&&Ra(window.configs.floorToName[this.buildingName+"_室内"][e]),super.updateOrientation(),this.core.crossSearch.changeSceneSearch(),this.endChangeFloor=!0,this.gatherOrSilentShader()}),this.buildingAnimate(e)),this.currentFloor&&this.currentFloor.name===e)return;this.floorSwitchInner(e),this._indoorRaycastClearFns&&this._indoorRaycastClearFns.forEach(o=>o());const t=this.buildingObject[e].group.children;this._indoorRaycastClearFns=[];const s=this.core.raycast("mousemove",t,o=>{o.length?(this.core.postprocessing.clearOutlineAll(1),this.core.postprocessing.addOutline(o[0].object,1)):this.core.postprocessing.clearOutlineAll(1)});this._indoorRaycastClearFns.push(s.clear);const n=this.core.raycast("click",t,o=>{if(o.length){const a=o[0].object;this.cameraMove(a).then(()=>{t.forEach(l=>{l===a?this.core.postprocessing.addOutline(l,1):this.core.postprocessing.addOutline(l,2)})})}});this._indoorRaycastClearFns.push(n.clear);const r=this.rightDblClickListener(()=>{this._indoorRaycastClearFns.forEach(o=>o()),this._indoorRaycastClearFns=[],this.core.postprocessing.clearOutlineAll(1),this.core.postprocessing.clearOutlineAll(2),t.forEach(o=>o.visible=!0),this.cameraMove(this.buildingObject[e].group)});this._indoorRaycastClearFns.push(r)}gatherOrSilentShader(){if(this.disPoseGatherShader(),this.gatherOrSilentData[this.currentFloor.name]){const{id:e,type:t,areaType:s,areaDataOut:n,areaDataBuilding:r,areaName:o}=this.gatherOrSilentData[this.currentFloor.name];this.gatherOrSilentLabel=this.core.ground.gatherOrSilentPlate.gatherModel(this.currentFloor,t,o),this.scene.add(this.gatherOrSilentLabel)}}disPoseGatherShader(){this.gatherOrSilentLabel&&(this.core.ground.gatherOrSilentPlate.clearGeometryGather(this.currentFloor),this.gatherOrSilentLabel.deleteSelf(),this.gatherOrSilentLabel=null)}addIndoorEvent(){let e=this.core.addClickCustom(this.indoorClickEvent.bind(this));this.eventClear.push(e)}indoorClickEvent(e){const s=e.intersectObject(this.orientation.orientation3D.singleGroup).filter(o=>o.object.visible);if(s.length){this.core.clearSearch();const o=s[0].object;this.orientation.setSearchId(o.name),this.orientation.search(),this.orientation.personSearchModule.setPosition();return}const r=e.intersectObject(V.equipGroup).filter(o=>o.object.visible);if(r.length){this.core.clearSearch();let o=r[0].object.typeName,a=r[0].object.name;V.searchEquip(a,o);return}}addPointerLister(){let e=this.core.raycast("mousemove",this.orientation.orientation3D.pointerArr,t=>{t.length?document.body.style.cursor="pointer":document.body.style.cursor="auto"});this.eventClear.push(e.clear)}addRayMove(){let e=this.core.raycast("mousemove",this.floors,t=>{if(t.length){let s=t[0].object.userData.parent;if(this.currentPoint===s)return;this.currentPoint=s,document.body.style.cursor="pointer",this.core.postprocessing.clearOutlineAll(1),this.core.postprocessing.addOutline(this.buildingObject[s].group,1)}else{if(!this.currentPoint)return;this.resetEffect()}});return this.eventClear.push(e.clear),e.clear}addRightDbClickReset(){const e=this.rightDblClickListener(()=>{this.removeEventListener(),this.cameraMove(this.building),this.addEventListener(),this.resetBuilding(),this.disPoseGatherShader()});this.eventClear.push(e)}setFloorGatherOrSilent(e){this.gatherOrSilentData[e.areaDataFloor]=e}addRightDbClickQuit(){const e=this.rightDblClickListener(()=>{this.core.changeSystem("ground")});this.eventClear.push(e)}rightDblClickListener(e){return this.core.addEventListener("mouseup").add(n=>{if(n.button!==2)return;let r=new Date().getTime();r-Vo<250&&(e(n),r=0),Vo=r})}switchFloorAnimate(e){if(!this.buildingObject||!this.buildingObject[e]||!this.buildingObject[e].group)return console.error(`楼层 "${e}" 的建筑数据不完整，无法执行楼层切换动画`),Promise.reject(new Error(`楼层 "${e}" 的建筑数据不完整`));const t=this.buildingObject[e].group,{min:s,max:n}=at(t);return new Promise((r,o)=>{ei(n.y,s.y),this.currentFloor=t,this.cameraMoveToFloor(t).then(()=>{r({sceneType:0,originId:e})})})}floorSwitchInner(e){if(!this.buildingObject||!this.buildingObject[e]||!this.buildingObject[e].group){console.error(`楼层 "${e}" 的建筑数据不完整，无法执行楼层内部切换`);return}this.endChangeFloor=!1;const t=this.buildingObject[e].group,{min:s,max:n}=at(t);yc(),ei(n.y,s.y);let r=this.currentFloor.name;this.buildingObject[r].uTime.value=.2,this.buildingObject[e].group.visible=!0,this.buildingObject[e].uTime.value=1,new Ji(this.buildingObject[r].uTime).to({value:0},1e3).start().onComplete(()=>{this.buildingObject[r].group.visible=!1}),this.currentFloor=t,this.cameraMoveToFloor(t).then(()=>{super.updateOrientation(),this.core.crossSearch.changeSceneSearch(),this.endChangeFloor=!0})}resetEffect(){this.currentPoint=null,document.body.style.cursor="auto",this.core.postprocessing.clearOutlineAll(1)}buildingAnimate(e){return new Promise((t,s)=>{Reflect.ownKeys(this.buildingObject).forEach(n=>{n===e||new Ji(this.buildingObject[n].uTime).to({value:0},1e3).start().onComplete(()=>{this.buildingObject[n].group.visible=!1,t()})})})}resetBuilding(){ei(),Reflect.ownKeys(this.buildingObject).forEach(e=>{this.buildingObject[e].group.visible=!0,new Ji(this.buildingObject[e].uTime).to({value:1},1e3).start().onComplete(()=>{this.currentFloor=null,this.resetData()})}),this.sceneHint&&this.sceneHint.updateMessage("右键双击返回室外")}resetData(){this.orientation.orientation3D.disposeClusterGroup(),V.disposeAll()}removeEventListener(){this._indoorRaycastClearFns&&(this._indoorRaycastClearFns.forEach(e=>e()),this._indoorRaycastClearFns=[]),this.eventClear.forEach(e=>e()),this.eventClear=[],this.resetEffect()}dispose(){this.currentFloor=null,this.buildingObject={},this.removeEventListener(),this.resetData(),this.scene.dispose(),ei(),this.sceneHint&&(this.sceneHint.destroy(),this.sceneHint=null),this.removeLightHelpers()}addLightHelpers(){this.removeLightHelpers(),this.mainLightHelper=new Ri(this.lights.main,5),this.scene.add(this.mainLightHelper),this.auxiliaryLightHelper=new Ri(this.lights.auxiliary,3),this.scene.add(this.auxiliaryLightHelper),this.shadowCameraHelper=new er(this.lights.main.shadow.camera),this.scene.add(this.shadowCameraHelper)}removeLightHelpers(){this.mainLightHelper&&(this.scene.remove(this.mainLightHelper),this.mainLightHelper.dispose(),this.mainLightHelper=null),this.auxiliaryLightHelper&&(this.scene.remove(this.auxiliaryLightHelper),this.auxiliaryLightHelper.dispose(),this.auxiliaryLightHelper=null),this.shadowCameraHelper&&(this.scene.remove(this.shadowCameraHelper),this.shadowCameraHelper.dispose(),this.shadowCameraHelper=null)}setIndoorHDRSky(){const e=new Yn;e.setDataType(ls),e.load("./bg.hdr",t=>{t.mapping=ks,t.colorSpace=q,t.exposure=1.5,this.scene.background=t;const s=t.clone();s.intensity=1.2,this.scene.environment=s,this.processIndoorEnvMapMaterials()},t=>{console.error("室内HDR加载失败:",t),this.setFallbackIndoorHDR()})}setFallbackIndoorHDR(){const e=new Yn;e.setDataType(ls),e.load("./bg.hdr",t=>{t.mapping=ks,t.colorSpace=q,t.exposure=1.8,this.scene.background=t;const s=t.clone();s.intensity=1,this.scene.environment=s,this.processIndoorEnvMapMaterials()},t=>{console.error("备用HDR也加载失败:",t),this.setDefaultIndoorSky()})}setDefaultIndoorSky(){const e=document.createElement("canvas");e.width=1024,e.height=512;const t=e.getContext("2d"),s=t.createLinearGradient(0,0,0,e.height);s.addColorStop(0,"#FFD700"),s.addColorStop(.3,"#FFA500"),s.addColorStop(.7,"#FF8C00"),s.addColorStop(1,"#FF4500"),t.fillStyle=s,t.fillRect(0,0,e.width,e.height);const n=new na(e);n.mapping=ks,n.colorSpace=q,this.scene.background=n;const r=n.clone();r.intensity=.8,this.scene.environment=r}processIndoorEnvMapMaterials(){this.scene.traverse(e=>{e.isMesh&&e.material&&(Array.isArray(e.material)?e.material.forEach(t=>{this.setupIndoorMaterial(t)}):this.setupIndoorMaterial(e.material))})}setupIndoorMaterial(e){(e.isMeshStandardMaterial||e.isMeshPhysicalMaterial)&&(this.scene.environment?(e.envMap=this.scene.environment,e.envMapIntensity=3.2):e.envMapIntensity=0,e.needsUpdate=!0)}clearIndoorHDR(){this.scene.background&&(this.scene.background.dispose(),this.scene.background=null),this.scene.environment&&(this.scene.environment.dispose(),this.scene.environment=null),this.scene.traverse(e=>{e.isMesh&&e.material&&(Array.isArray(e.material)?e.material.forEach(t=>{t.envMap&&(t.envMap=null,t.envMapIntensity=0,t.needsUpdate=!0)}):e.material.envMap&&(e.material.envMap=null,e.material.envMapIntensity=0,e.material.needsUpdate=!0))})}clearIndoorData(){this.removeEventListener(),this.resetData(),this.disposeGatherOrSilent(),this.sceneHint&&this.sceneHint.hide(),this.building&&this.building.parent&&(this.building.parent.remove(this.building),this.building=null),this.buildingObject={},this.floors=[],this.currentFloor=null,this.endChangeFloor=!0,this.resetControls(),this.clearIndoorHDR(),this.removeIndoorLights()}createAndSetupLights(e){if(!e){console.warn("建筑对象未提供，无法创建和设置灯光");return}const t=new he().setFromObject(e),s=t.getCenter(new _),n=t.getSize(new _),r=t.min,o=t.max,a=n.x,l=n.y,c=n.z,d=Math.max(a,l,c),h=new Jn(16777215,1);this.ambientLight=h,this._add(this.ambientLight);const u=new as(16777215,.5),f=o.y+d*.5;u.position.set(s.x,f,s.z);const m=s.clone();m.y=r.y-50,u.target.position.copy(m),this._add(u.target),u.castShadow=!0,u.shadow.mapSize.width=2048,u.shadow.mapSize.height=2048,u.shadow.camera.near=.1,u.shadow.camera.far=f*2;const y=d*2;u.shadow.camera.left=-y,u.shadow.camera.right=y,u.shadow.camera.top=y,u.shadow.camera.bottom=-y,u.shadow.bias=-1e-4,u.shadow.normalBias=.02,u.shadow.radius=1.5,this.directionLight=u,this._add(this.directionLight)}removeIndoorLights(){this.removeLightHelpers(),this.lights&&(this.lights.ambient&&(this.scene.remove(this.lights.ambient),this.lights.ambient.dispose()),this.lights.main&&(this.lights.main.target&&this.scene.remove(this.lights.main.target),this.scene.remove(this.lights.main),this.lights.main.dispose()),this.lights.auxiliary&&(this.lights.auxiliary.target&&this.scene.remove(this.lights.auxiliary.target),this.scene.remove(this.lights.auxiliary),this.lights.auxiliary.dispose()),this.lights=null),this.ambientLight=null,this.directionLight=null,this.auxiliaryLight=null}}const _n=new _;class Ep{constructor(e){this.camera=e.camera,this.controls=e.controls}lerpTo(e,t=100,s=1e3,n=new _){const r=this.camera.position.distanceTo(e),o=(r-t)/r;_n.lerpVectors(this.camera.position,e,o),_n.add(n),this.changeTo({start:this.camera.position,end:_n,duration:s,onStart:()=>this.controls.enabled=!1,onComplete:()=>this.controls.enabled=!0}),this.changeTo({start:this.controls.target,end:e,duration:s,onUpdate:()=>{this.camera.lookAt(this.controls.target)}})}changeTo(e){const{start:t,end:s,duration:n,onUpdate:r,onComplete:o,onStart:a}=e;if(!(!n||!s||!t))return new Br.Tween(t).to(s,n).onStart(a).onUpdate(r).onComplete(o).start()}removeAll(){Br.removeAll()}}class Ap{constructor(e){this.core=e,this.crossSearchBuilding=!1,this.crossSearchInspection=!1,this.crossSearchDangerPerson=!1,this.crossSearchPerson=!1,this.crossFollowPerson=!1,this.setCrossSearchId=null,this.setCrossFollowId=null,this.crossGatherWarning=null}setCrossGatherWarning(e){this.crossGatherWarning=e}setCrossSearchBuildingStatus(e){this.crossSearchBuilding=e}setCrossFollowStatus(e){this.crossFollowPerson=e}setCrossSearchPersonStatus(e){this.crossSearchPerson=e}setCrossSearchInspectionStatus(e){this.crossSearchInspection=e}setCrossSearchDangerPersonStatus(e){this.crossSearchDangerPerson=e}changeSceneSearch(){this.crossSearchBuilding&&this.core.sceneType===1&&(this.core.ground.searchBuilding(),this.crossSearchBuilding=!1),this.crossSearchInspection&&(this.core.currentSystem.searchInspection(),this.crossSearchInspection=!1),this.crossGatherWarning&&(this.core.gatherWarning.gatherDangerFun(this.crossGatherWarning),this.crossGatherWarning=null),this.crossSearchPerson&&(this.core.orientation.setSearchId(this.setCrossSearchId),this.core.orientation.search(),this.core.orientation.personSearchModule.setPosition(),this.crossSearchPerson=!1,this.setCrossSearchId=null),this.crossFollowPerson&&(this.core.currentSystem.startFollowPerson(this.setCrossFollowId),this.crossFollowPerson=!1,this.setCrossFollowId=null),this.crossSearchDangerPerson&&(this.core.currentSystem.searchAlarmPerson(),this.crossSearchDangerPerson=!1)}}class Mp{constructor(e){this.core=e,this.circles=[],this.eventClear=[],this.gatherMap=new Map,this.realTimeMap=new Map,this.memoryManager=new ae}addEvents(){let e=this.core.raycast("click",this.circles,s=>{s.length?(console.log(s[0].point,"位置坐标"),this.showLabel(s[0].object.typeId)):this.showLabel(null)});this.eventClear.push(e.clear);let t=this.core.raycast("mousemove",this.circles,s=>{s.length?document.body.style.cursor="pointer":document.body.style.cursor="block"});this.eventClear.push(t.clear)}showLabel(e){this.realTimeMap.forEach((t,s)=>{t.board.visible=s===e})}removeEventListener(){this.eventClear.forEach(e=>{e()}),this.eventClear=[]}gatherDanger(e){const t=e.sceneChangeType;e.isDanger=!0,t==="noChange"?this.gatherDangerFun(e):(this.core.changeSystemCustom(t,e.originId,e.sceneType),this.core.crossSearch.setCrossGatherWarning(e))}async realTimeGather(e){this.removeEventListener(),this.circles=[],(!e||e.length===0)&&this.disposeRealTimeGather();let t={add:[],update:[],remove:[]},s=new Map;e.forEach(n=>{n.isDanger=!1,s.set(n.id,n),this.realTimeMap.get(n.id)&&t.update.push(n),this.realTimeMap.get(n.id)||t.add.push(n)}),this.realTimeMap.forEach((n,r)=>{s.get(r)||t.remove.push(r)}),t.add.forEach(({position:n,radius:r,level:o,users:a,id:l,name:c},d)=>{this.gatherDangerFun({position:n,radius:r,level:o,users:a,id:l,isDanger:!1,name:c},"add")}),t.update.forEach(({position:n,radius:r,level:o,users:a,id:l,name:c},d)=>{this.gatherDangerFun({position:n,radius:r,level:o,users:a,id:l,isDanger:!1,name:c},"update")}),t.remove.forEach(n=>{this.deleteRealTimeById(n)}),this.addEvents()}deleteRealTimeById(e){let t=this.realTimeMap.get(e).obj;for(let s=t.length-1;s>=0;s--)ae.dispose(t[s]);ae.dispose(this.realTimeMap.get(e).board),ae.dispose(this.realTimeMap.get(e).object3d),this.realTimeMap.delete(e)}getCenterPosition(e){let t=0,s=0,n=0,r=e.length;e.forEach(c=>{t+=c.x,s+=c.y,n+=c.z});let o=t/r,a=s/r,l=n/r;return new _(o,a,l)}gatherDangerFun({position:e,radius:t,level:s,users:n,id:r,isDanger:o=!1,name:a},l){let c=null,d=null;if(l==="add"&&(d=new pe,c=this.setPersonBoard({name:`${n.split(",").length}人`,id:r,areaName:`${a}`},!0,s,n,o,r),c.center.set(.5,1),d.add(c),d.position.set(0,0,0),this.core.scene.add(d),o||(c.visible=!1)),l==="update"){c=this.realTimeMap.get(r).board,d=this.realTimeMap.get(r).object3d;let u=this.realTimeMap.get(r).obj;for(let f=u.length-1;f>=0;f--)ae.dispose(this.realTimeMap.get(r).obj[f]);this.realTimeMap.get(r).obj=null}c.position.copy(this.getCenterPosition(e));let h=[];e.forEach(u=>{t||(t=500);let f=t/100,m=new vc(new _,f,s);d.add(m),h.push(m),m.typeId=r,this.circles.push(m),m.position.copy(u)}),o?(this.disposeGather(),this.gatherMap.set(r,{obj:h,board:c,object3d:d})):(l==="add"&&this.realTimeMap.set(r,{obj:h,board:c,object3d:d}),l==="update"&&(this.realTimeMap.get(r).obj=h,this.realTimeMap.get(r).object3d=d))}setPersonBoard(e,t=!1,s,n,r,o){let a={3:"#FFDE33",2:"#FF9441",1:"#FF4747"},l={3:"yellow",2:"orange",1:"red"},c=document.createElement("div");c.style="margin-bottom:12px";let d=document.createElement("span");d.style.color=a[s],d.innerText=e.name;let h=document.createElement("span");h.style.color=a[s],h.innerText=e.areaName;let u=document.createElement("div"),f=document.createElement("div"),m=document.createElement("div"),y=document.createElement("div");y.className="beilu_three_Board_text_gather_span",y.style.background=`${a[s]}`;let p=document.createElement("div");p.className="beilu_three_Board_text_gather_span",p.style.background=`${a[s]}`,m.append(c),m.append(u),m.append(f),m.draggable=!1,m.className="beilu_three_Board_text_gather",m.style.border=`1px solid ${a[s]}`,f.className=`beilu_three_Board_text_gather_down_${l[s]}`,c.innerText="聚集人数：",c.append(d),c.append(y),u.innerText="报警位置：",u.append(p),u.append(h),c.onclick=()=>{Ed({users:n,isDanger:r,alarmId:o})};let g=Re(m,"board"+e.id);return g.visible=t,g}disposeGather(){this.gatherMap.forEach(e=>{let t=e.obj;for(let s=t.length-1;s>=0;s--)ae.dispose(t[s]);ae.dispose(e.board),ae.dispose(e.object3d)}),this.gatherMap.clear(),this.circles=[],this.removeEventListener()}disposeRealTimeGather(){this.realTimeMap.forEach(e=>{for(let t=e.obj.length-1;t>=0;t--)ae.dispose(e.obj[t]);ae.dispose(e.board),ae.dispose(e.object3d)}),this.realTimeMap.clear(),this.circles=[],this.removeEventListener()}}let qo=0;const Wo=new k,Cn=new k,js=class js extends dd{constructor(t){super(t);N(this,"getMouse",(t,s)=>{const{left:n,top:r,width:o,height:a}=this.domElement.getBoundingClientRect();s.x=(t.clientX-n)/o*2-1,s.y=-((t.clientY-r)/a)*2+1});this.time=new Date().getTime(),this.cache=!0,this.currentSystem=null,this.firstLoad=!0,this.sceneType=1,this.dwObj={},this.ray=new Li,this.inDoorModel=!1;const s=js.Default.position.clone().applyAxisAngle(new _(0,1,0),45).multiplyScalar(.25);this.camera.position.copy(s),this.controls.target.copy(js.Default.target),this.controls.minDistance=10}setIndoorModel(t){this.inDoorModel=t}isIndoorModel(){return this.inDoorModel}init(){this.initCSS2DRenderer(),this.initCSS3DRenderer(),this.initComposer(),this._beginRender(),this.controlEvent()}_beginRender(){this.renderEnabled||(this.firstLoad?(this.setClass(),this.firstLoad=!1):this.currentSystem.onEnter(),this.beginRender())}_stopRender(){this.stopRender(),this.currentSystem.onLeave()}setClass(){this.tweenControl=new Ep(this),this.orientation=new Ze(this),this.ground=new xp(this),this.indoorSubsystem=new Tp(this),this.crossSearch=new Ap(this),this.gatherWarning=new Mp(this),this.changeSystem("ground"),this.onRenderQueue.set("elapsedTimeUpdate",t=>bc(t.elapsedTime)),this.onRenderQueue.set("globalAnimationUpdate",()=>Ws.update())}hideInspectionSystemIcon(t){this.currentSystem.hideInspectionSystemIcon(t)}isSearching(){return!!this.orientation.searchId}isFollowing(){return!!this.orientation.followId}cherryPick(t){this.currentSystem.cherryPick(t)}createFence(t){this.currentSystem.createFence&&this.currentSystem.createFence(t)}changeSystem(t,s=null){this.clearFence(),this.changeSystemCommon(t),this.orientation.clearSearch(),this[t].onEnter(s)}changeIndoor(t){const s=window.floorToName[t];if(!s){console.warn(`未找到建筑 "${t}" 的配置信息`);return}const{path:n,floor:r}=s,o=n.replace("inDoor/","").replace("_室内","");this.currentSystem===this.indoorSubsystem&&(console.log("当前已在室内系统，执行清理操作"),this.indoorSubsystem.clearIndoorData()),this.changeSystem("indoorSubsystem",o),new Promise(c=>{const d=()=>{this.indoorSubsystem&&this.indoorSubsystem.building&&this.indoorSubsystem.buildingObject&&this.indoorSubsystem.buildingObject[r]?c():setTimeout(d,100)};d()}).then(()=>{this.changeFloor(r)})}clearFence(){this.currentSystem&&this.currentSystem.clearFence&&this.currentSystem.clearFence()}clearEquipType(t){this.currentSystem.clearEquipType(t)}changeSystemCommon(t){const s=this[t],n=this.currentSystem;if(!s){console.warn(`${t}子系统未初始化`);return}if(n)if(s===n)if(t==="indoorSubsystem")console.log("室内系统重新初始化");else return;else n.onLeave();this.orientation.orientation3D.disposeClusterGroup(),this.orientation.orientation3D.disposeAlarm(),this.changeScene(s.scene),this.currentSystem=s,this.sceneType=t==="ground"?Ze.SCENE_TYPE.OUTDOOR:Ze.SCENE_TYPE.INDOOR}changeSystemCustom(t,s,n){const r=n===Ze.SCENE_TYPE.INDOOR?"indoorSubsystem":"ground";this.changeSystemCommon(r);const o=this[r];t==="inToOut"?o.onEnter():o.onChangeSystemCustom(t,s,s.slice(0,-3))}controlEvent(){this.controls.addEventListener("start",()=>{this.setRaycasterState("mousemove",!1)}),this.controls.addEventListener("end",()=>{this.setRaycasterState("mousemove",!0)})}getCurrentOriginId(){return{sceneType:this.sceneType,originId:this.indoorSubsystem.currentFloor?this.indoorSubsystem.currentFloor.name:""}}setHeatmap(t){this.orientation.setHeatmap(t)}changeScene(t){this.scene=t}changeWeather(t){this.currentSystem.changeWeather(t)}switchWeather(t){this.ground.switchWeather(t)}changeFloor(t){this.indoorSubsystem&&this.indoorSubsystem.changeFloor(t)}startMeasuring(){this.changeView(new _(0,1,0),1200),this.enableControlsRotate(!1),this.currentSystem.startMeasuring(),this.setCameraState(!1)}removeMeasuring(){this.enableControlsRotate(!0),this.currentSystem.removeMeasuring(),this.setCameraState(this.ground.roamEnabled)}startMeasureArea(){this.changeView(new _(0,1,0),1200),this.enableControlsRotate(!1),this.currentSystem.startMeasureArea(),this.setCameraState(!1)}removeMeasureArea(){this.currentSystem.removeMeasureArea(),this.enableControlsRotate(!0),this.setCameraState(this.ground.roamEnabled)}changeBoxSelect(t){console.log("test"),this.changeView(new _(0,1,0),1200),this.enableControlsRotate(!t),this.ground.changeBoxSelect(t),t?this.setCameraState(!1):this.setCameraState(this.ground.roamEnabled)}reSelect(){this.ground.boxSelect.end(),this.ground.boxSelect.start(),this.changeView(new _(0,1,0),1200),this.enableControlsRotate(!1),this.setCameraState(!1)}changeView(t=new _(0,1,0),s=100){const n=new _().addScaledVector(t,s);this.camera.position.copy(n),this.controls.target.set(0,0,0)}resetCameraUp(){this.camera.up.set(0,1,0)}enableControlsRotate(t){this.controls.enableRotate=t}historyTrackCommand(t){this.currentSystem.historyTrackCommand(t)}clearSearch(){}searchPerson(t){const{originId:s,sceneType:n,sceneChangeType:r,id:o}=t;r!=="noChange"?(this.changeSystemCustom(r,s,n),this.crossSearch.setCrossSearchId=o,this.crossSearch.setCrossSearchPersonStatus(!0)):(this.orientation.setSearchId(o),this.orientation.search(),this.orientation.personSearchModule.setPosition())}followCheck(t,s){let n=t.data.param.update.length&&t.data.param.update.filter(c=>{if(c.id===s)return c});if(!n||n.length===0)return!1;let{id:r,sceneType:o,originId:a}=n[0];o===0&&!a.includes("F")&&(o=1);let l=wc({sceneType:o,originId:a});l!=="noChange"&&(this.orientation.cancelFollow(),this.followChangeScene({originId:a,sceneType:o,sceneChangeType:l,id:r}))}followChangeScene({originId:t,sceneType:s,sceneChangeType:n,id:r}){this.changeSystemCustom(n,t,s),this.crossSearch.setCrossFollowId=r,this.crossSearch.setCrossFollowStatus(!0)}startFollow(t){this.postprocessing.clearOutlineAll(1);const{sceneChangeType:s,id:n}=t;s!=="noChange"&&this.followChangeScene(t),s==="noChange"&&this.currentSystem.startFollowPerson(n)}cancelFollow(){this.currentSystem.cancelFollowPerson(),this.sceneType===0&&(this.indoorSubsystem.removeEventListener(),this.indoorSubsystem.addPointerLister(),this.indoorSubsystem.addIndoorEvent(),this.indoorSubsystem.addRightDbClickReset())}changeMouseEventSwitch(t){t?this.currentSystem.addEventListener():(this.currentSystem.removeEventListener(),this.postprocessing.clearOutlineAll(1),this.postprocessing.clearOutlineAll(2))}bindGroundEvent(){this.sceneType===1&&(this.ground.removeEventListener(),this.ground.addEventListener())}bindSearchEvent(){this.sceneType===1&&(this.ground.removeEventListener(),this.ground.addGroundEvent())}clearSelected(t){this.currentSystem.clearSelected(t)}clearAllPerson(){this.currentSystem.clearPerson()}dangerFenceInit(t){this.ground.initDangerFence(t)}hideBuildingDialog(t){this.ground.hideBuildingLabel(t)}hideCameraDialog(t){this.currentSystem.clearCameraVideo(t)}clearDanger(){this.orientation.orientation3D.personDangerData&&this.currentSystem.clearDangerPerson(),this.ground.clearDangerFence()}personAlarmInit(t){const{originId:s,sceneType:n,sceneChangeType:r,id:o}=t;this.currentSystem.setDangerPerson(t),r!=="noChange"&&(this.changeSystemCustom(r,s,n),this.crossSearch.setCrossSearchDangerPersonStatus(!0)),r==="noChange"&&this.currentSystem.searchAlarmPerson()}changeBuildingNum(t){this.ground.changeBuildingNumber(t)}hideCameraById(t){this.currentSystem.hideCameraById(t)}switchGatherStatus(t){this.orientation.clusterModule.setActive(t)}setGatherLevel(t){this.orientation.clusterModule.setLevel(t)}roamEnabled(t){this.ground.roamEnabled=t,this.ground.setCameraState(t)}roamDuration(t){this.ground.roamDuration=t}searchBuilding(t,s){this.ground.searchBuildingId=t,this.sceneType===0?(this.changeSystem("ground"),this.crossSearch.setCrossSearchBuildingStatus(!0)):this.ground.searchBuilding(s)}searchCamera(t){const{originId:s,sceneType:n,sceneChangeType:r,id:o}=t;r!=="noChange"&&(this.changeSystemCustom(r,s,n),this.currentSystem.setSearchCameraId(o)),r==="noChange"&&this.currentSystem.searchCamera(o)}searchInspectionSystem(t){const{originId:s,sceneType:n,sceneChangeType:r,id:o}=t;r!=="noChange"&&(this.changeSystemCustom(r,s,n),this.currentSystem.setSearchInspectionSystemId(o)),r==="noChange"&&this.currentSystem.searchInspectionSystem(o)}search(t){if(this.clearSearch(),!t)return;const{type:s,sceneType:n,originId:r,id:o,filter:a,sceneChangeType:l,inDoorModel:c}=t;if(!c)return this.searchBuilding(r,!1),this.setIndoorModel(!0),!1;if(s==="person")return this.searchPerson(t);if(s==="building")return this.searchBuilding(o);if(s==="equip")return this.searchCamera(t);if(s==="inspection")return this.searchInspection(t);if(s==="personDanger")return this.personAlarmInit(t);if(s==="inspectionSystem")return this.searchInspectionSystem(t)}searchInspection(t){const{originId:s,sceneType:n,sceneChangeType:r,id:o,name:a,position:l}=t;this.currentSystem.setSearchInspection({id:o,name:a,position:l}),r!=="noChange"&&(this.changeSystemCustom(r,s,n),this.crossSearch.setCrossSearchInspectionStatus(!0)),r==="noChange"&&this.currentSystem.searchInspection()}processingEquipment(t,s){this.currentSystem.processingEquipData(t,s)}changeLighting(t){this.currentSystem.updateLightingPattern(t)}setCameraState(t){this.currentSystem.setCameraState(t)}beginWander(){this.currentSystem.beginWander()}resetCamera(){this.currentSystem.resetCamera()}endWander(){this.currentSystem.endWander()}rightDblClickListener(t){return this.addEventListener("mouseup").add(r=>{if(r.button!==2)return;let o=new Date().getTime();o-qo<250&&(o=0,t(r)),qo=o})}addClickCustom(t){let s=null;const r=this.addEventListener("mousedown").add(d=>{d.button!==2&&this.getMouse(d,Wo)}),o=this.addEventListener("mouseup");let a;const l=o.add(d=>{d.button!==2&&(this.getMouse(d,Cn),Wo.equals(Cn)&&(s?(clearTimeout(s),s=null):s=setTimeout(()=>{a=new Li,a.setFromCamera(Cn,this.camera),t(a),clearTimeout(s),s=null},250)))});return()=>{r(),l(),a=null}}};N(js,"Default",{position:new _(154,265,612),target:new _(-446,10,-389)});let Fi=js;export{Fi as Store3D};
