<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>灯光修复测试</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f0f0f0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .info {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background: #0056b3;
    }

    #three-container {
      width: 100%;
      height: 600px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: #000;
    }

    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>灯光修复测试</h1>

    <div class="info">
      <h3>问题描述</h3>
      <p>场景中插入了灯光，但是场景没有光。已修复以下问题：</p>
      <ul>
        <li>✅ 启用了 HDR 环境贴图设置</li>
        <li>✅ 修复了材质环境贴图设置逻辑</li>
        <li>✅ 确保灯光正确添加并设置目标点</li>
        <li>✅ 修复了灯光移除逻辑</li>
        <li>✅ 添加了调试日志</li>
      </ul>
    </div>

    <div class="controls">
      <h3>控制面板</h3>
      <button onclick="testIndoorLights()">测试室内灯光</button>
      <button onclick="testGroundLights()">测试地面灯光</button>
      <button onclick="clearLights()">清除灯光</button>
      <button onclick="addTestCube()">添加测试立方体</button>
      <button onclick="toggleHelpers()">切换辅助器</button>
    </div>

    <div id="three-container"></div>

    <div class="log">
      <div id="logContent">控制台日志将显示在这里...</div>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
    import { RGBELoader } from 'three/examples/jsm/loaders/RGBELoader.js';

    // 全局变量
    let scene, camera, renderer, controls;
    let lights = {};
    let helpers = [];
    let showHelpers = false;

    // 日志函数
    function log (message) {
      const logContent = document.getElementById('logContent');
      const timestamp = new Date().toLocaleTimeString();
      logContent.innerHTML += `[${timestamp}] ${message}<br>`;
      logContent.scrollTop = logContent.scrollHeight;
      console.log(message);
    }

    // 初始化Three.js场景
    function initScene () {
      // 创建场景
      scene = new THREE.Scene();

      // 创建相机
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(10, 10, 10);

      // 创建渲染器
      const container = document.getElementById('three-container');
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(container.clientWidth, container.clientHeight);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      container.appendChild(renderer.domElement);

      // 创建控制器
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      // 添加网格辅助器
      const gridHelper = new THREE.GridHelper(20, 20);
      scene.add(gridHelper);

      // 添加坐标轴辅助器
      const axesHelper = new THREE.AxesHelper(5);
      scene.add(axesHelper);

      log("场景初始化完成");
    }

    // 测试室内灯光系统
    window.testIndoorLights = function () {
      log("测试室内灯光系统...");

      // 清除现有灯光
      clearLights();

      // 创建环境光
      const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
      lights.ambient = ambientLight;
      scene.add(ambientLight);

      // 创建主方向光
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1.4);
      directionalLight.shadow.camera.near = 1;
      directionalLight.shadow.camera.far = 1000;
      directionalLight.shadow.camera.right = 1000;
      directionalLight.shadow.camera.left = -1000;
      directionalLight.shadow.camera.top = 600;
      directionalLight.shadow.camera.bottom = -600;
      directionalLight.shadow.mapSize.width = Math.pow(2, 11);
      directionalLight.shadow.mapSize.height = Math.pow(2, 11);
      directionalLight.shadow.blurSamples = 8;
      directionalLight.shadow.radius = 1.15;
      directionalLight.shadow.bias = -0.0015;
      directionalLight.castShadow = true;

      // 创建主方向光的目标点
      const mainLightTarget = new THREE.Object3D();
      mainLightTarget.position.set(0, 0, 0);
      directionalLight.target = mainLightTarget;
      scene.add(mainLightTarget);

      lights.main = directionalLight;
      scene.add(directionalLight);

      // 创建辅助方向光
      const auxiliaryLight = new THREE.DirectionalLight(0xffffff, 0.4);

      // 创建辅助方向光的目标点
      const auxiliaryLightTarget = new THREE.Object3D();
      auxiliaryLightTarget.position.set(0, 0, 0);
      auxiliaryLight.target = auxiliaryLightTarget;
      scene.add(auxiliaryLightTarget);

      lights.auxiliary = auxiliaryLight;
      scene.add(auxiliaryLight);

      // 设置灯光位置
      lights.main.position.set(-5, 8, 5);
      lights.auxiliary.position.set(5, 6, -5);

      // 强制更新矩阵世界
      lights.main.target.updateMatrixWorld();
      lights.auxiliary.target.updateMatrixWorld();

      log("室内灯光系统创建完成");
      log(`环境光强度: ${lights.ambient.intensity}`);
      log(`主方向光强度: ${lights.main.intensity}`);
      log(`辅助方向光强度: ${lights.auxiliary.intensity}`);
      log(`场景中的灯光数量: ${scene.children.filter(child => child.isLight).length}`);

      if (showHelpers) {
        addLightHelpers();
      }
    };

    // 测试地面灯光系统
    window.testGroundLights = function () {
      log("测试地面灯光系统...");

      // 清除现有灯光
      clearLights();

      // 创建环境光
      const ambientLight = new THREE.AmbientLight(0xffffff, 1.25);
      lights.ambient = ambientLight;
      scene.add(ambientLight);

      // 创建主方向光
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1.55);
      directionalLight.shadow.camera.near = 1;
      directionalLight.shadow.camera.far = 3500;
      directionalLight.shadow.camera.right = 2500;
      directionalLight.shadow.camera.left = -2500;
      directionalLight.shadow.camera.top = 1600;
      directionalLight.shadow.camera.bottom = -1600;
      directionalLight.shadow.mapSize.width = Math.pow(2, 11);
      directionalLight.shadow.mapSize.height = Math.pow(2, 11);
      directionalLight.shadow.blurSamples = 8;
      directionalLight.shadow.radius = 1.15;
      directionalLight.shadow.bias = -0.0015;
      directionalLight.position.set(-8, 13, 10);
      directionalLight.castShadow = true;

      // 设置方向光的目标点
      const lightTarget = new THREE.Object3D();
      lightTarget.position.set(0, 0, 0);
      directionalLight.target = lightTarget;
      scene.add(lightTarget);

      lights.main = directionalLight;
      scene.add(directionalLight);

      log("地面灯光系统创建完成");
      log(`环境光强度: ${lights.ambient.intensity}`);
      log(`主方向光强度: ${lights.main.intensity}`);
      log(`场景中的灯光数量: ${scene.children.filter(child => child.isLight).length}`);

      if (showHelpers) {
        addLightHelpers();
      }
    };

    // 清除灯光
    window.clearLights = function () {
      log("清除灯光...");

      // 移除灯光辅助器
      helpers.forEach(helper => {
        scene.remove(helper);
        if (helper.dispose) helper.dispose();
      });
      helpers = [];

      // 移除灯光
      Object.values(lights).forEach(light => {
        if (light) {
          if (light.target) {
            scene.remove(light.target);
          }
          scene.remove(light);
          light.dispose();
        }
      });

      lights = {};
      log("灯光已清除");
      log(`场景中的灯光数量: ${scene.children.filter(child => child.isLight).length}`);
    };

    // 添加测试立方体
    window.addTestCube = function () {
      log("添加测试立方体...");

      const geometry = new THREE.BoxGeometry(2, 2, 2);
      const material = new THREE.MeshStandardMaterial({
        color: 0x00ff00,
        metalness: 0.2,
        roughness: 0.8
      });
      const cube = new THREE.Mesh(geometry, material);
      cube.castShadow = true;
      cube.receiveShadow = true;
      cube.position.set(0, 1, 0);
      scene.add(cube);

      log("测试立方体已添加");
    };

    // 切换辅助器
    window.toggleHelpers = function () {
      showHelpers = !showHelpers;
      if (showHelpers) {
        addLightHelpers();
        log("灯光辅助器已显示");
      } else {
        removeLightHelpers();
        log("灯光辅助器已隐藏");
      }
    };

    // 添加灯光辅助器
    function addLightHelpers () {
      removeLightHelpers();

      if (lights.main) {
        const mainHelper = new THREE.DirectionalLightHelper(lights.main, 2);
        scene.add(mainHelper);
        helpers.push(mainHelper);

        const shadowHelper = new THREE.CameraHelper(lights.main.shadow.camera);
        scene.add(shadowHelper);
        helpers.push(shadowHelper);
      }

      if (lights.auxiliary) {
        const auxiliaryHelper = new THREE.DirectionalLightHelper(lights.auxiliary, 1);
        scene.add(auxiliaryHelper);
        helpers.push(auxiliaryHelper);
      }
    }

    // 移除灯光辅助器
    function removeLightHelpers () {
      helpers.forEach(helper => {
        scene.remove(helper);
        if (helper.dispose) helper.dispose();
      });
      helpers = [];
    }

    // 动画循环
    function animate () {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    // 初始化
    initScene();
    animate();

    // 窗口大小调整
    window.addEventListener('resize', () => {
      const container = document.getElementById('three-container');
      camera.aspect = container.clientWidth / container.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(container.clientWidth, container.clientHeight);
    });

    log("测试页面加载完成，请点击按钮测试灯光系统");
  </script>
</body>

</html>