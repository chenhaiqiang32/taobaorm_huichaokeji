<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è®¾å¤‡æ ‡ç­¾æ¸…é™¤æµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .test-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    .test-button:hover {
      background: #0056b3;
    }

    .test-button.danger {
      background: #dc3545;
    }

    .test-button.danger:hover {
      background: #c82333;
    }

    .info-box {
      background: #e7f3ff;
      border: 1px solid #b3d9ff;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }

    .warning-box {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }

    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }

    .step {
      background: #f8f9fa;
      border-left: 4px solid #007bff;
      padding: 10px;
      margin: 10px 0;
    }

    h2 {
      color: #333;
      border-bottom: 2px solid #007bff;
      padding-bottom: 5px;
    }

    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-weight: bold;
    }

    .status.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .status.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .status.info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>è®¾å¤‡æ ‡ç­¾æ¸…é™¤æµ‹è¯•</h1>
    <p>æµ‹è¯•è®¾å¤‡æ ‡ç­¾çš„æ¸…é™¤åŠŸèƒ½ï¼Œç¡®ä¿CSS2Då¯¹è±¡å’ŒDOMå…ƒç´ éƒ½è¢«æ­£ç¡®ç§»é™¤</p>

    <div class="info-box">
      <h3>ğŸ¯ æ¸…é™¤é€»è¾‘</h3>
      <p>æ¸…é™¤è¿‡ç¨‹åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š</p>
      <ol>
        <li>ç§»é™¤æ‰€æœ‰DOMå…ƒç´ ï¼ˆlabel.element.remove()ï¼‰</li>
        <li>ä»çˆ¶å¯¹è±¡ä¸­ç§»é™¤CSS2Då¯¹è±¡ï¼ˆlabel.css2dObject.parent.remove()ï¼‰</li>
        <li>ä»åœºæ™¯ä¸­ç§»é™¤CSS2Då¯¹è±¡ï¼ˆthis.scene.remove()ï¼‰</li>
        <li>æ¸…ç†æ‰€æœ‰å¼•ç”¨ï¼ˆè®¾ç½®ä¸ºnullï¼‰</li>
        <li>æ¸…ç©ºè®¾å¤‡æ ‡ç­¾æ•°ç»„</li>
        <li>å¼ºåˆ¶æ¸…ç†åœºæ™¯ä¸­æ®‹ç•™çš„CSS2Då¯¹è±¡</li>
        <li>æ¸…ç†CSS2Dæ¸²æŸ“å™¨DOMä¸­çš„æ®‹ç•™å…ƒç´ </li>
      </ol>
    </div>

    <div class="test-section">
      <h2>1. åŸºç¡€æ¸…é™¤æµ‹è¯•</h2>
      <p>æµ‹è¯•åŸºæœ¬çš„åˆ›å»ºå’Œæ¸…é™¤åŠŸèƒ½</p>

      <button class="test-button" onclick="testBasicClear()">åŸºç¡€æ¸…é™¤æµ‹è¯•</button>
      <button class="test-button" onclick="testMultipleClear()">å¤šæ¬¡æ¸…é™¤æµ‹è¯•</button>

      <div class="step">
        <strong>æµ‹è¯•æ­¥éª¤ï¼š</strong>
        <ol>
          <li>åˆ›å»ºä¸€äº›è®¾å¤‡æ ‡ç­¾</li>
          <li>æ‰§è¡Œæ¸…é™¤æ“ä½œ</li>
          <li>æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ï¼ŒéªŒè¯æ¸…é™¤è¿‡ç¨‹</li>
          <li>æ£€æŸ¥DOMä¸­æ˜¯å¦è¿˜æœ‰æ®‹ç•™å…ƒç´ </li>
        </ol>
      </div>
    </div>

    <div class="test-section">
      <h2>2. å¼ºåˆ¶æ¸…é™¤æµ‹è¯•</h2>
      <p>æµ‹è¯•å¼ºåˆ¶æ¸…ç†æ®‹ç•™å…ƒç´ çš„åŠŸèƒ½</p>

      <button class="test-button" onclick="testForceClear()">å¼ºåˆ¶æ¸…é™¤æµ‹è¯•</button>
      <button class="test-button" onclick="checkResidualElements()">æ£€æŸ¥æ®‹ç•™å…ƒç´ </button>

      <div class="step">
        <strong>æµ‹è¯•æ­¥éª¤ï¼š</strong>
        <ol>
          <li>åˆ›å»ºè®¾å¤‡æ ‡ç­¾</li>
          <li>æ¨¡æ‹Ÿæ¸…é™¤å¤±è´¥çš„æƒ…å†µ</li>
          <li>æ‰§è¡Œå¼ºåˆ¶æ¸…é™¤</li>
          <li>éªŒè¯æ‰€æœ‰å…ƒç´ éƒ½è¢«æ¸…ç†</li>
        </ol>
      </div>
    </div>

    <div class="test-section">
      <h2>3. æ›´æ–°é€»è¾‘æµ‹è¯•</h2>
      <p>æµ‹è¯•webUpdateModelçš„æ¸…é™¤å’Œé‡æ–°ç”Ÿæˆé€»è¾‘</p>

      <button class="test-button" onclick="testUpdateClear()">æ›´æ–°æ¸…é™¤æµ‹è¯•</button>
      <button class="test-button" onclick="testReplaceClear()">æ›¿æ¢æ¸…é™¤æµ‹è¯•</button>

      <div class="step">
        <strong>æµ‹è¯•æ­¥éª¤ï¼š</strong>
        <ol>
          <li>æ¨é€ç¬¬ä¸€ç»„æ•°æ®</li>
          <li>æ¨é€ç¬¬äºŒç»„æ•°æ®ï¼ˆåº”è¯¥æ¸…é™¤ç¬¬ä¸€ç»„ï¼‰</li>
          <li>æ¨é€ç©ºæ•°ç»„ï¼ˆåº”è¯¥æ¸…é™¤æ‰€æœ‰ï¼‰</li>
          <li>éªŒè¯æ¯æ¬¡æ›´æ–°éƒ½æ­£ç¡®æ¸…é™¤æ—§æ•°æ®</li>
        </ol>
      </div>
    </div>

    <div class="test-section">
      <h2>4. DOMæ£€æŸ¥å·¥å…·</h2>
      <p>æ£€æŸ¥é¡µé¢ä¸­çš„è®¾å¤‡æ ‡ç­¾DOMå…ƒç´ </p>

      <button class="test-button" onclick="checkAllDeviceLabels()">æ£€æŸ¥æ‰€æœ‰è®¾å¤‡æ ‡ç­¾</button>
      <button class="test-button" onclick="checkCSS2DRenderer()">æ£€æŸ¥CSS2Dæ¸²æŸ“å™¨</button>
      <button class="test-button" onclick="clearAllLabels()">æ¸…é™¤æ‰€æœ‰æ ‡ç­¾</button>

      <div id="domStatus" class="status info">
        ç‚¹å‡»æŒ‰é’®æ£€æŸ¥DOMä¸­çš„è®¾å¤‡æ ‡ç­¾å…ƒç´ 
      </div>
    </div>

    <div class="test-section">
      <h2>æ§åˆ¶å°æ—¥å¿—</h2>
      <div id="log" class="log"></div>
      <button class="test-button" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
    </div>
  </div>

  <script>
    // é‡å†™ console.log æ¥æ•è·æ—¥å¿—
    const originalLog = console.log;
    const originalWarn = console.warn;
    const originalError = console.error;
    const logElement = document.getElementById('log');
    const domStatusElement = document.getElementById('domStatus');

    function addToLog (message) {
      logElement.textContent += message + '\n';
      logElement.scrollTop = logElement.scrollHeight;
    }

    function updateStatus (message, type = 'info') {
      domStatusElement.textContent = message;
      domStatusElement.className = `status ${type}`;
    }

    console.log = function (...args) {
      originalLog.apply(console, args);
      addToLog('[LOG] ' + args.join(' '));
    };

    console.warn = function (...args) {
      originalWarn.apply(console, args);
      addToLog('[WARN] ' + args.join(' '));
    };

    console.error = function (...args) {
      originalError.apply(console, args);
      addToLog('[ERROR] ' + args.join(' '));
    };

    // æ¨¡æ‹Ÿ postMessage å‘é€
    function sendMessage (cmd, param) {
      const message = {
        cmd: cmd,
        param: param
      };

      // å‘é€åˆ°çˆ¶çª—å£ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if (window.parent && window.parent !== window) {
        window.parent.postMessage(message, '*');
      }

      // ä¹Ÿå‘é€åˆ°å½“å‰çª—å£ï¼ˆç”¨äºæµ‹è¯•ï¼‰
      window.postMessage(message, '*');

      console.log('å‘é€æ¶ˆæ¯:', message);
      addToLog(`[SEND] ${cmd}: ${JSON.stringify(param, null, 2)}`);
    }

    function testBasicClear () {
      addToLog('=== åŸºç¡€æ¸…é™¤æµ‹è¯• ===');

      // åˆ›å»ºæµ‹è¯•æ•°æ®
      const data = [
        {
          name: 'æµ‹è¯•è®¾å¤‡1',
          visible: true,
          code: '001',
          configs: [{ key: 'æµ‹è¯•', value: 'åŸºç¡€æ¸…é™¤' }]
        },
        {
          name: 'æµ‹è¯•è®¾å¤‡2',
          visible: true,
          code: '002',
          configs: [{ key: 'æµ‹è¯•', value: 'åŸºç¡€æ¸…é™¤' }]
        }
      ];

      sendMessage('webUpdateModel', data);

      // 3ç§’åæ¸…é™¤
      setTimeout(() => {
        addToLog('=== æ‰§è¡Œæ¸…é™¤æ“ä½œ ===');
        sendMessage('webUpdateModel', []);
      }, 3000);
    }

    function testMultipleClear () {
      addToLog('=== å¤šæ¬¡æ¸…é™¤æµ‹è¯• ===');

      const testData = [
        {
          name: 'å¤šæ¬¡æ¸…é™¤æµ‹è¯•è®¾å¤‡',
          visible: true,
          code: '001',
          configs: [{ key: 'æµ‹è¯•', value: 'å¤šæ¬¡æ¸…é™¤' }]
        }
      ];

      // å¤šæ¬¡åˆ›å»ºå’Œæ¸…é™¤
      for (let i = 1; i <= 3; i++) {
        setTimeout(() => {
          addToLog(`=== ç¬¬ ${i} æ¬¡åˆ›å»º ===`);
          sendMessage('webUpdateModel', testData);
        }, i * 2000);

        setTimeout(() => {
          addToLog(`=== ç¬¬ ${i} æ¬¡æ¸…é™¤ ===`);
          sendMessage('webUpdateModel', []);
        }, i * 2000 + 1000);
      }
    }

    function testForceClear () {
      addToLog('=== å¼ºåˆ¶æ¸…é™¤æµ‹è¯• ===');

      // åˆ›å»ºæ•°æ®
      const data = [
        {
          name: 'å¼ºåˆ¶æ¸…é™¤æµ‹è¯•è®¾å¤‡',
          visible: true,
          code: '001',
          configs: [{ key: 'æµ‹è¯•', value: 'å¼ºåˆ¶æ¸…é™¤' }]
        }
      ];

      sendMessage('webUpdateModel', data);

      // å»¶è¿Ÿåæ£€æŸ¥å¹¶å¼ºåˆ¶æ¸…é™¤
      setTimeout(() => {
        addToLog('=== æ£€æŸ¥æ®‹ç•™å…ƒç´  ===');
        checkResidualElements();

        setTimeout(() => {
          addToLog('=== æ‰§è¡Œå¼ºåˆ¶æ¸…é™¤ ===');
          sendMessage('webUpdateModel', []);
        }, 1000);
      }, 2000);
    }

    function testUpdateClear () {
      addToLog('=== æ›´æ–°æ¸…é™¤æµ‹è¯• ===');

      const firstData = [
        {
          name: 'ç¬¬ä¸€ç»„è®¾å¤‡',
          visible: true,
          code: '001',
          configs: [{ key: 'ç»„åˆ«', value: 'ç¬¬ä¸€ç»„' }]
        }
      ];

      const secondData = [
        {
          name: 'ç¬¬äºŒç»„è®¾å¤‡',
          visible: true,
          code: '002',
          configs: [{ key: 'ç»„åˆ«', value: 'ç¬¬äºŒç»„' }]
        }
      ];

      // æ¨é€ç¬¬ä¸€ç»„æ•°æ®
      sendMessage('webUpdateModel', firstData);

      // 2ç§’åæ¨é€ç¬¬äºŒç»„æ•°æ®ï¼ˆåº”è¯¥æ¸…é™¤ç¬¬ä¸€ç»„ï¼‰
      setTimeout(() => {
        addToLog('=== æ¨é€ç¬¬äºŒç»„æ•°æ®ï¼ˆåº”è¯¥æ¸…é™¤ç¬¬ä¸€ç»„ï¼‰===');
        sendMessage('webUpdateModel', secondData);
      }, 2000);

      // 4ç§’åæ¨é€ç©ºæ•°ç»„ï¼ˆåº”è¯¥æ¸…é™¤æ‰€æœ‰ï¼‰
      setTimeout(() => {
        addToLog('=== æ¨é€ç©ºæ•°ç»„ï¼ˆåº”è¯¥æ¸…é™¤æ‰€æœ‰ï¼‰===');
        sendMessage('webUpdateModel', []);
      }, 4000);
    }

    function testReplaceClear () {
      addToLog('=== æ›¿æ¢æ¸…é™¤æµ‹è¯• ===');

      // åˆ›å»ºå¤šç»„ä¸åŒçš„æ•°æ®
      const dataSets = [
        [
          { name: 'è®¾å¤‡A', visible: true, code: '001', configs: [{ key: 'ç»„', value: 'A' }] },
          { name: 'è®¾å¤‡B', visible: true, code: '002', configs: [{ key: 'ç»„', value: 'A' }] }
        ],
        [
          { name: 'è®¾å¤‡X', visible: true, code: '003', configs: [{ key: 'ç»„', value: 'X' }] },
          { name: 'è®¾å¤‡Y', visible: true, code: '004', configs: [{ key: 'ç»„', value: 'X' }] },
          { name: 'è®¾å¤‡Z', visible: true, code: '005', configs: [{ key: 'ç»„', value: 'X' }] }
        ],
        [
          { name: 'è®¾å¤‡1', visible: true, code: '006', configs: [{ key: 'ç»„', value: '1' }] }
        ]
      ];

      dataSets.forEach((data, index) => {
        setTimeout(() => {
          addToLog(`=== æ›¿æ¢ä¸ºç¬¬ ${index + 1} ç»„æ•°æ® ===`);
          sendMessage('webUpdateModel', data);
        }, index * 2000);
      });
    }

    function checkAllDeviceLabels () {
      addToLog('=== æ£€æŸ¥æ‰€æœ‰è®¾å¤‡æ ‡ç­¾ ===');

      // æ£€æŸ¥æ•´ä¸ªæ–‡æ¡£ä¸­çš„è®¾å¤‡æ ‡ç­¾
      const allLabels = document.querySelectorAll('.device-label-container');
      addToLog(`åœ¨æ–‡æ¡£ä¸­å‘ç° ${allLabels.length} ä¸ªè®¾å¤‡æ ‡ç­¾å…ƒç´ `);

      allLabels.forEach((label, index) => {
        addToLog(`æ ‡ç­¾ ${index + 1}: ${label.textContent.trim()}`);
      });

      updateStatus(`å‘ç° ${allLabels.length} ä¸ªè®¾å¤‡æ ‡ç­¾å…ƒç´ `, allLabels.length > 0 ? 'error' : 'success');
    }

    function checkCSS2DRenderer () {
      addToLog('=== æ£€æŸ¥CSS2Dæ¸²æŸ“å™¨ ===');

      const css2dRenderer = document.getElementById('css2dRenderer');
      if (css2dRenderer) {
        const deviceLabels = css2dRenderer.querySelectorAll('.device-label-container');
        addToLog(`åœ¨CSS2Dæ¸²æŸ“å™¨ä¸­å‘ç° ${deviceLabels.length} ä¸ªè®¾å¤‡æ ‡ç­¾å…ƒç´ `);

        deviceLabels.forEach((label, index) => {
          addToLog(`CSS2Dæ ‡ç­¾ ${index + 1}: ${label.textContent.trim()}`);
        });

        updateStatus(`CSS2Dæ¸²æŸ“å™¨ä¸­æœ‰ ${deviceLabels.length} ä¸ªè®¾å¤‡æ ‡ç­¾`, deviceLabels.length > 0 ? 'error' : 'success');
      } else {
        addToLog('æœªæ‰¾åˆ°CSS2Dæ¸²æŸ“å™¨å…ƒç´ ');
        updateStatus('æœªæ‰¾åˆ°CSS2Dæ¸²æŸ“å™¨', 'error');
      }
    }

    function checkResidualElements () {
      addToLog('=== æ£€æŸ¥æ®‹ç•™å…ƒç´  ===');

      // æ£€æŸ¥å„ç§å¯èƒ½çš„ä½ç½®
      const locations = [
        { name: 'æ•´ä¸ªæ–‡æ¡£', selector: '.device-label-container' },
        { name: 'CSS2Dæ¸²æŸ“å™¨', selector: '#css2dRenderer .device-label-container' },
        { name: 'body', selector: 'body .device-label-container' }
      ];

      locations.forEach(location => {
        const elements = document.querySelectorAll(location.selector);
        addToLog(`${location.name}: å‘ç° ${elements.length} ä¸ªè®¾å¤‡æ ‡ç­¾å…ƒç´ `);
      });
    }

    function clearAllLabels () {
      addToLog('=== æ¸…é™¤æ‰€æœ‰æ ‡ç­¾ ===');
      sendMessage('webUpdateModel', []);
      updateStatus('å·²å‘é€æ¸…é™¤æ‰€æœ‰æ ‡ç­¾çš„æŒ‡ä»¤', 'info');
    }

    function clearLog () {
      logElement.textContent = '';
    }
  </script>
</body>

</html>