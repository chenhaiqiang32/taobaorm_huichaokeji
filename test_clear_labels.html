<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>设备标签清除测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .test-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    .test-button:hover {
      background: #0056b3;
    }

    .test-button.danger {
      background: #dc3545;
    }

    .test-button.danger:hover {
      background: #c82333;
    }

    .info-box {
      background: #e7f3ff;
      border: 1px solid #b3d9ff;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }

    .warning-box {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }

    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }

    .step {
      background: #f8f9fa;
      border-left: 4px solid #007bff;
      padding: 10px;
      margin: 10px 0;
    }

    h2 {
      color: #333;
      border-bottom: 2px solid #007bff;
      padding-bottom: 5px;
    }

    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-weight: bold;
    }

    .status.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .status.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .status.info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>设备标签清除测试</h1>
    <p>测试设备标签的清除功能，确保CSS2D对象和DOM元素都被正确移除</p>

    <div class="info-box">
      <h3>🎯 清除逻辑</h3>
      <p>清除过程包括以下步骤：</p>
      <ol>
        <li>移除所有DOM元素（label.element.remove()）</li>
        <li>从父对象中移除CSS2D对象（label.css2dObject.parent.remove()）</li>
        <li>从场景中移除CSS2D对象（this.scene.remove()）</li>
        <li>清理所有引用（设置为null）</li>
        <li>清空设备标签数组</li>
        <li>强制清理场景中残留的CSS2D对象</li>
        <li>清理CSS2D渲染器DOM中的残留元素</li>
      </ol>
    </div>

    <div class="test-section">
      <h2>1. 基础清除测试</h2>
      <p>测试基本的创建和清除功能</p>

      <button class="test-button" onclick="testBasicClear()">基础清除测试</button>
      <button class="test-button" onclick="testMultipleClear()">多次清除测试</button>

      <div class="step">
        <strong>测试步骤：</strong>
        <ol>
          <li>创建一些设备标签</li>
          <li>执行清除操作</li>
          <li>检查控制台日志，验证清除过程</li>
          <li>检查DOM中是否还有残留元素</li>
        </ol>
      </div>
    </div>

    <div class="test-section">
      <h2>2. 强制清除测试</h2>
      <p>测试强制清理残留元素的功能</p>

      <button class="test-button" onclick="testForceClear()">强制清除测试</button>
      <button class="test-button" onclick="checkResidualElements()">检查残留元素</button>

      <div class="step">
        <strong>测试步骤：</strong>
        <ol>
          <li>创建设备标签</li>
          <li>模拟清除失败的情况</li>
          <li>执行强制清除</li>
          <li>验证所有元素都被清理</li>
        </ol>
      </div>
    </div>

    <div class="test-section">
      <h2>3. 更新逻辑测试</h2>
      <p>测试webUpdateModel的清除和重新生成逻辑</p>

      <button class="test-button" onclick="testUpdateClear()">更新清除测试</button>
      <button class="test-button" onclick="testReplaceClear()">替换清除测试</button>

      <div class="step">
        <strong>测试步骤：</strong>
        <ol>
          <li>推送第一组数据</li>
          <li>推送第二组数据（应该清除第一组）</li>
          <li>推送空数组（应该清除所有）</li>
          <li>验证每次更新都正确清除旧数据</li>
        </ol>
      </div>
    </div>

    <div class="test-section">
      <h2>4. DOM检查工具</h2>
      <p>检查页面中的设备标签DOM元素</p>

      <button class="test-button" onclick="checkAllDeviceLabels()">检查所有设备标签</button>
      <button class="test-button" onclick="checkCSS2DRenderer()">检查CSS2D渲染器</button>
      <button class="test-button" onclick="clearAllLabels()">清除所有标签</button>

      <div id="domStatus" class="status info">
        点击按钮检查DOM中的设备标签元素
      </div>
    </div>

    <div class="test-section">
      <h2>控制台日志</h2>
      <div id="log" class="log"></div>
      <button class="test-button" onclick="clearLog()">清除日志</button>
    </div>
  </div>

  <script>
    // 重写 console.log 来捕获日志
    const originalLog = console.log;
    const originalWarn = console.warn;
    const originalError = console.error;
    const logElement = document.getElementById('log');
    const domStatusElement = document.getElementById('domStatus');

    function addToLog (message) {
      logElement.textContent += message + '\n';
      logElement.scrollTop = logElement.scrollHeight;
    }

    function updateStatus (message, type = 'info') {
      domStatusElement.textContent = message;
      domStatusElement.className = `status ${type}`;
    }

    console.log = function (...args) {
      originalLog.apply(console, args);
      addToLog('[LOG] ' + args.join(' '));
    };

    console.warn = function (...args) {
      originalWarn.apply(console, args);
      addToLog('[WARN] ' + args.join(' '));
    };

    console.error = function (...args) {
      originalError.apply(console, args);
      addToLog('[ERROR] ' + args.join(' '));
    };

    // 模拟 postMessage 发送
    function sendMessage (cmd, param) {
      const message = {
        cmd: cmd,
        param: param
      };

      // 发送到父窗口（如果存在）
      if (window.parent && window.parent !== window) {
        window.parent.postMessage(message, '*');
      }

      // 也发送到当前窗口（用于测试）
      window.postMessage(message, '*');

      console.log('发送消息:', message);
      addToLog(`[SEND] ${cmd}: ${JSON.stringify(param, null, 2)}`);
    }

    function testBasicClear () {
      addToLog('=== 基础清除测试 ===');

      // 创建测试数据
      const data = [
        {
          name: '测试设备1',
          visible: true,
          code: '001',
          configs: [{ key: '测试', value: '基础清除' }]
        },
        {
          name: '测试设备2',
          visible: true,
          code: '002',
          configs: [{ key: '测试', value: '基础清除' }]
        }
      ];

      sendMessage('webUpdateModel', data);

      // 3秒后清除
      setTimeout(() => {
        addToLog('=== 执行清除操作 ===');
        sendMessage('webUpdateModel', []);
      }, 3000);
    }

    function testMultipleClear () {
      addToLog('=== 多次清除测试 ===');

      const testData = [
        {
          name: '多次清除测试设备',
          visible: true,
          code: '001',
          configs: [{ key: '测试', value: '多次清除' }]
        }
      ];

      // 多次创建和清除
      for (let i = 1; i <= 3; i++) {
        setTimeout(() => {
          addToLog(`=== 第 ${i} 次创建 ===`);
          sendMessage('webUpdateModel', testData);
        }, i * 2000);

        setTimeout(() => {
          addToLog(`=== 第 ${i} 次清除 ===`);
          sendMessage('webUpdateModel', []);
        }, i * 2000 + 1000);
      }
    }

    function testForceClear () {
      addToLog('=== 强制清除测试 ===');

      // 创建数据
      const data = [
        {
          name: '强制清除测试设备',
          visible: true,
          code: '001',
          configs: [{ key: '测试', value: '强制清除' }]
        }
      ];

      sendMessage('webUpdateModel', data);

      // 延迟后检查并强制清除
      setTimeout(() => {
        addToLog('=== 检查残留元素 ===');
        checkResidualElements();

        setTimeout(() => {
          addToLog('=== 执行强制清除 ===');
          sendMessage('webUpdateModel', []);
        }, 1000);
      }, 2000);
    }

    function testUpdateClear () {
      addToLog('=== 更新清除测试 ===');

      const firstData = [
        {
          name: '第一组设备',
          visible: true,
          code: '001',
          configs: [{ key: '组别', value: '第一组' }]
        }
      ];

      const secondData = [
        {
          name: '第二组设备',
          visible: true,
          code: '002',
          configs: [{ key: '组别', value: '第二组' }]
        }
      ];

      // 推送第一组数据
      sendMessage('webUpdateModel', firstData);

      // 2秒后推送第二组数据（应该清除第一组）
      setTimeout(() => {
        addToLog('=== 推送第二组数据（应该清除第一组）===');
        sendMessage('webUpdateModel', secondData);
      }, 2000);

      // 4秒后推送空数组（应该清除所有）
      setTimeout(() => {
        addToLog('=== 推送空数组（应该清除所有）===');
        sendMessage('webUpdateModel', []);
      }, 4000);
    }

    function testReplaceClear () {
      addToLog('=== 替换清除测试 ===');

      // 创建多组不同的数据
      const dataSets = [
        [
          { name: '设备A', visible: true, code: '001', configs: [{ key: '组', value: 'A' }] },
          { name: '设备B', visible: true, code: '002', configs: [{ key: '组', value: 'A' }] }
        ],
        [
          { name: '设备X', visible: true, code: '003', configs: [{ key: '组', value: 'X' }] },
          { name: '设备Y', visible: true, code: '004', configs: [{ key: '组', value: 'X' }] },
          { name: '设备Z', visible: true, code: '005', configs: [{ key: '组', value: 'X' }] }
        ],
        [
          { name: '设备1', visible: true, code: '006', configs: [{ key: '组', value: '1' }] }
        ]
      ];

      dataSets.forEach((data, index) => {
        setTimeout(() => {
          addToLog(`=== 替换为第 ${index + 1} 组数据 ===`);
          sendMessage('webUpdateModel', data);
        }, index * 2000);
      });
    }

    function checkAllDeviceLabels () {
      addToLog('=== 检查所有设备标签 ===');

      // 检查整个文档中的设备标签
      const allLabels = document.querySelectorAll('.device-label-container');
      addToLog(`在文档中发现 ${allLabels.length} 个设备标签元素`);

      allLabels.forEach((label, index) => {
        addToLog(`标签 ${index + 1}: ${label.textContent.trim()}`);
      });

      updateStatus(`发现 ${allLabels.length} 个设备标签元素`, allLabels.length > 0 ? 'error' : 'success');
    }

    function checkCSS2DRenderer () {
      addToLog('=== 检查CSS2D渲染器 ===');

      const css2dRenderer = document.getElementById('css2dRenderer');
      if (css2dRenderer) {
        const deviceLabels = css2dRenderer.querySelectorAll('.device-label-container');
        addToLog(`在CSS2D渲染器中发现 ${deviceLabels.length} 个设备标签元素`);

        deviceLabels.forEach((label, index) => {
          addToLog(`CSS2D标签 ${index + 1}: ${label.textContent.trim()}`);
        });

        updateStatus(`CSS2D渲染器中有 ${deviceLabels.length} 个设备标签`, deviceLabels.length > 0 ? 'error' : 'success');
      } else {
        addToLog('未找到CSS2D渲染器元素');
        updateStatus('未找到CSS2D渲染器', 'error');
      }
    }

    function checkResidualElements () {
      addToLog('=== 检查残留元素 ===');

      // 检查各种可能的位置
      const locations = [
        { name: '整个文档', selector: '.device-label-container' },
        { name: 'CSS2D渲染器', selector: '#css2dRenderer .device-label-container' },
        { name: 'body', selector: 'body .device-label-container' }
      ];

      locations.forEach(location => {
        const elements = document.querySelectorAll(location.selector);
        addToLog(`${location.name}: 发现 ${elements.length} 个设备标签元素`);
      });
    }

    function clearAllLabels () {
      addToLog('=== 清除所有标签 ===');
      sendMessage('webUpdateModel', []);
      updateStatus('已发送清除所有标签的指令', 'info');
    }

    function clearLog () {
      logElement.textContent = '';
    }
  </script>
</body>

</html>