<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>webUpdateModel æ›´æ–°é€»è¾‘æµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .test-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    .test-button:hover {
      background: #0056b3;
    }

    .test-button.danger {
      background: #dc3545;
    }

    .test-button.danger:hover {
      background: #c82333;
    }

    .info-box {
      background: #e7f3ff;
      border: 1px solid #b3d9ff;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }

    .warning-box {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }

    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    .step {
      background: #f8f9fa;
      border-left: 4px solid #007bff;
      padding: 10px;
      margin: 10px 0;
    }

    h2 {
      color: #333;
      border-bottom: 2px solid #007bff;
      padding-bottom: 5px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>webUpdateModel æ›´æ–°é€»è¾‘æµ‹è¯•</h1>
    <p>æµ‹è¯•æ¯æ¬¡æ¨é€æ•°æ®æ—¶æ¸…é™¤æ—§æ•°æ®å¹¶é‡æ–°ç”Ÿæˆæ‰€æœ‰ç‰Œå­çš„é€»è¾‘</p>

    <div class="info-box">
      <h3>ğŸ¯ æ–°çš„æ›´æ–°é€»è¾‘</h3>
      <p><strong>ä¹‹å‰</strong>ï¼šåˆ†åˆ«è°ƒç”¨ä¿å­˜å’Œæ›´æ–°æ–¹æ³•</p>
      <p><strong>ç°åœ¨</strong>ï¼šæ¯æ¬¡æ¨é€æ•°æ®æ—¶ï¼š</p>
      <ol>
        <li>æ¸…é™¤æ‰€æœ‰ç°æœ‰çš„è®¾å¤‡ç‰Œå­å’ŒCSS2D DOMå…ƒç´ </li>
        <li>æ¸…é™¤å®ä¾‹ä¸­çš„æ‰€æœ‰è®¾å¤‡æ ‡ç­¾æ•°æ®</li>
        <li>ä¿å­˜æ–°çš„æ•°æ®åˆ°å®ä¾‹</li>
        <li>åŸºäºæ–°æ•°ç»„é‡æ–°ç”Ÿæˆæ‰€æœ‰ç‰Œå­</li>
      </ol>
    </div>

    <div class="test-section">
      <h2>1. åŸºç¡€æµ‹è¯•</h2>
      <p>æµ‹è¯•åŸºæœ¬çš„æ¸…é™¤å’Œé‡æ–°ç”Ÿæˆé€»è¾‘</p>

      <button class="test-button" onclick="testBasicUpdate()">åŸºç¡€æ›´æ–°æµ‹è¯•</button>
      <button class="test-button" onclick="testEmptyArray()">ç©ºæ•°ç»„æµ‹è¯•</button>

      <div class="step">
        <strong>æµ‹è¯•æ­¥éª¤ï¼š</strong>
        <ol>
          <li>ç‚¹å‡»"åŸºç¡€æ›´æ–°æµ‹è¯•"åˆ›å»ºåˆå§‹è®¾å¤‡</li>
          <li>ç‚¹å‡»"ç©ºæ•°ç»„æµ‹è¯•"æ¸…é™¤æ‰€æœ‰è®¾å¤‡</li>
          <li>è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—ï¼ŒéªŒè¯æ¸…é™¤å’Œé‡æ–°ç”Ÿæˆè¿‡ç¨‹</li>
        </ol>
      </div>
    </div>

    <div class="test-section">
      <h2>2. æ•°æ®æ›¿æ¢æµ‹è¯•</h2>
      <p>æµ‹è¯•æ¨é€å®Œå…¨ä¸åŒçš„è®¾å¤‡æ•°ç»„</p>

      <button class="test-button" onclick="testDataReplacement()">æ•°æ®æ›¿æ¢æµ‹è¯•</button>
      <button class="test-button" onclick="testProgressiveUpdate()">æ¸è¿›æ›´æ–°æµ‹è¯•</button>

      <div class="step">
        <strong>æµ‹è¯•æ­¥éª¤ï¼š</strong>
        <ol>
          <li>ç‚¹å‡»"æ•°æ®æ›¿æ¢æµ‹è¯•"æ¨é€ç¬¬ä¸€ç»„æ•°æ®</li>
          <li>2ç§’åè‡ªåŠ¨æ¨é€å®Œå…¨ä¸åŒçš„ç¬¬äºŒç»„æ•°æ®</li>
          <li>è§‚å¯Ÿæ˜¯å¦å®Œå…¨æ›¿æ¢äº†ä¹‹å‰çš„è®¾å¤‡</li>
        </ol>
      </div>
    </div>

    <div class="test-section">
      <h2>3. å®ä¾‹å­˜å‚¨æµ‹è¯•</h2>
      <p>æµ‹è¯•å®ä¾‹å­˜å‚¨çš„æ¸…é™¤å’Œé‡æ–°ä¿å­˜</p>

      <button class="test-button" onclick="testInstanceStorage()">å®ä¾‹å­˜å‚¨æµ‹è¯•</button>
      <button class="test-button" onclick="checkStorageStatus()">æ£€æŸ¥å­˜å‚¨çŠ¶æ€</button>

      <div class="step">
        <strong>æµ‹è¯•æ­¥éª¤ï¼š</strong>
        <ol>
          <li>æ¨é€æ•°æ®å¹¶æ£€æŸ¥å­˜å‚¨çŠ¶æ€</li>
          <li>æ¨é€æ–°æ•°æ®ï¼ŒéªŒè¯æ—§æ•°æ®è¢«æ¸…é™¤</li>
          <li>æ£€æŸ¥å­˜å‚¨çŠ¶æ€ç¡®è®¤æ•°æ®æ›´æ–°</li>
        </ol>
      </div>
    </div>

    <div class="test-section">
      <h2>4. æ€§èƒ½æµ‹è¯•</h2>
      <p>æµ‹è¯•å¤§é‡æ•°æ®çš„æ¸…é™¤å’Œé‡æ–°ç”Ÿæˆæ€§èƒ½</p>

      <button class="test-button" onclick="testPerformance()">æ€§èƒ½æµ‹è¯•</button>
      <button class="test-button danger" onclick="clearAll()">æ¸…é™¤æ‰€æœ‰</button>

      <div class="warning-box">
        <strong>âš ï¸ æ³¨æ„ï¼š</strong>
        <p>æ€§èƒ½æµ‹è¯•ä¼šåˆ›å»ºå¤§é‡è®¾å¤‡ï¼Œå¯èƒ½å½±å“é¡µé¢æ€§èƒ½ã€‚æµ‹è¯•å®Œæˆåè¯·ç‚¹å‡»"æ¸…é™¤æ‰€æœ‰"ã€‚</p>
      </div>
    </div>

    <div class="test-section">
      <h2>æ§åˆ¶å°æ—¥å¿—</h2>
      <div id="log" class="log"></div>
      <button class="test-button" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
    </div>
  </div>

  <script>
    // é‡å†™ console.log æ¥æ•è·æ—¥å¿—
    const originalLog = console.log;
    const originalWarn = console.warn;
    const logElement = document.getElementById('log');

    function addToLog (message) {
      logElement.textContent += message + '\n';
      logElement.scrollTop = logElement.scrollHeight;
    }

    console.log = function (...args) {
      originalLog.apply(console, args);
      addToLog('[LOG] ' + args.join(' '));
    };

    console.warn = function (...args) {
      originalWarn.apply(console, args);
      addToLog('[WARN] ' + args.join(' '));
    };

    // æ¨¡æ‹Ÿ postMessage å‘é€
    function sendMessage (cmd, param) {
      const message = {
        cmd: cmd,
        param: param
      };

      // å‘é€åˆ°çˆ¶çª—å£ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if (window.parent && window.parent !== window) {
        window.parent.postMessage(message, '*');
      }

      // ä¹Ÿå‘é€åˆ°å½“å‰çª—å£ï¼ˆç”¨äºæµ‹è¯•ï¼‰
      window.postMessage(message, '*');

      console.log('å‘é€æ¶ˆæ¯:', message);
      addToLog(`[SEND] ${cmd}: ${JSON.stringify(param, null, 2)}`);
    }

    function testBasicUpdate () {
      addToLog('=== åŸºç¡€æ›´æ–°æµ‹è¯• ===');

      const data = [
        {
          name: 'åŸºç¡€æµ‹è¯•è®¾å¤‡1',
          visible: true,
          code: '001',
          configs: [
            { key: 'æµ‹è¯•ç±»å‹', value: 'åŸºç¡€æ›´æ–°' },
            { key: 'æ—¶é—´', value: new Date().toLocaleTimeString() }
          ]
        },
        {
          name: 'åŸºç¡€æµ‹è¯•è®¾å¤‡2',
          visible: true,
          code: '002',
          configs: [
            { key: 'æµ‹è¯•ç±»å‹', value: 'åŸºç¡€æ›´æ–°' },
            { key: 'æ—¶é—´', value: new Date().toLocaleTimeString() }
          ]
        }
      ];

      sendMessage('webUpdateModel', data);
    }

    function testEmptyArray () {
      addToLog('=== ç©ºæ•°ç»„æµ‹è¯• ===');
      sendMessage('webUpdateModel', []);
    }

    function testDataReplacement () {
      addToLog('=== æ•°æ®æ›¿æ¢æµ‹è¯• ===');

      // ç¬¬ä¸€ç»„æ•°æ®
      const firstData = [
        {
          name: 'ç¬¬ä¸€ç»„è®¾å¤‡A',
          visible: true,
          code: '001',
          configs: [
            { key: 'ç»„åˆ«', value: 'ç¬¬ä¸€ç»„' },
            { key: 'çŠ¶æ€', value: 'è¿è¡Œä¸­' }
          ]
        },
        {
          name: 'ç¬¬ä¸€ç»„è®¾å¤‡B',
          visible: true,
          code: '002',
          configs: [
            { key: 'ç»„åˆ«', value: 'ç¬¬ä¸€ç»„' },
            { key: 'çŠ¶æ€', value: 'å¾…æœº' }
          ]
        }
      ];

      sendMessage('webUpdateModel', firstData);

      // 2ç§’åæ¨é€å®Œå…¨ä¸åŒçš„æ•°æ®
      setTimeout(() => {
        addToLog('=== æ¨é€ç¬¬äºŒç»„æ•°æ® ===');
        const secondData = [
          {
            name: 'ç¬¬äºŒç»„è®¾å¤‡X',
            visible: true,
            code: '003',
            configs: [
              { key: 'ç»„åˆ«', value: 'ç¬¬äºŒç»„' },
              { key: 'çŠ¶æ€', value: 'æ­£å¸¸' }
            ]
          },
          {
            name: 'ç¬¬äºŒç»„è®¾å¤‡Y',
            visible: true,
            code: '004',
            configs: [
              { key: 'ç»„åˆ«', value: 'ç¬¬äºŒç»„' },
              { key: 'çŠ¶æ€', value: 'ç»´æŠ¤ä¸­' }
            ]
          }
        ];

        sendMessage('webUpdateModel', secondData);
      }, 2000);
    }

    function testProgressiveUpdate () {
      addToLog('=== æ¸è¿›æ›´æ–°æµ‹è¯• ===');

      // é€æ­¥å¢åŠ è®¾å¤‡æ•°é‡
      const steps = [
        [{ name: 'è®¾å¤‡1', visible: true, code: '001', configs: [{ key: 'æ­¥éª¤', value: '1ä¸ªè®¾å¤‡' }] }],
        [
          { name: 'è®¾å¤‡1', visible: true, code: '001', configs: [{ key: 'æ­¥éª¤', value: '2ä¸ªè®¾å¤‡' }] },
          { name: 'è®¾å¤‡2', visible: true, code: '002', configs: [{ key: 'æ­¥éª¤', value: '2ä¸ªè®¾å¤‡' }] }
        ],
        [
          { name: 'è®¾å¤‡1', visible: true, code: '001', configs: [{ key: 'æ­¥éª¤', value: '3ä¸ªè®¾å¤‡' }] },
          { name: 'è®¾å¤‡2', visible: true, code: '002', configs: [{ key: 'æ­¥éª¤', value: '3ä¸ªè®¾å¤‡' }] },
          { name: 'è®¾å¤‡3', visible: true, code: '003', configs: [{ key: 'æ­¥éª¤', value: '3ä¸ªè®¾å¤‡' }] }
        ]
      ];

      steps.forEach((data, index) => {
        setTimeout(() => {
          addToLog(`=== æ­¥éª¤ ${index + 1}: ${data.length} ä¸ªè®¾å¤‡ ===`);
          sendMessage('webUpdateModel', data);
        }, index * 1500);
      });
    }

    function testInstanceStorage () {
      addToLog('=== å®ä¾‹å­˜å‚¨æµ‹è¯• ===');

      const data = [
        {
          name: 'å®ä¾‹å­˜å‚¨æµ‹è¯•è®¾å¤‡',
          visible: true,
          code: '001',
          configs: [
            { key: 'å­˜å‚¨æµ‹è¯•', value: 'å·²ä¿å­˜åˆ°å®ä¾‹' },
            { key: 'æ—¶é—´', value: new Date().toLocaleTimeString() }
          ]
        }
      ];

      sendMessage('webUpdateModel', data);

      // æ£€æŸ¥å­˜å‚¨çŠ¶æ€
      setTimeout(() => {
        sendMessage('checkStorageStatus', {});
      }, 1000);
    }

    function checkStorageStatus () {
      addToLog('=== æ£€æŸ¥å­˜å‚¨çŠ¶æ€ ===');
      sendMessage('checkStorageStatus', {});
    }

    function testPerformance () {
      addToLog('=== æ€§èƒ½æµ‹è¯• ===');

      // åˆ›å»ºå¤§é‡è®¾å¤‡æ•°æ®
      const devices = [];
      for (let i = 1; i <= 20; i++) {
        devices.push({
          name: `æ€§èƒ½æµ‹è¯•è®¾å¤‡${i}`,
          visible: true,
          code: `${i.toString().padStart(3, '0')}`,
          configs: [
            { key: 'è®¾å¤‡ç¼–å·', value: `${i}` },
            { key: 'æµ‹è¯•ç±»å‹', value: 'æ€§èƒ½æµ‹è¯•' },
            { key: 'æ—¶é—´', value: new Date().toLocaleTimeString() }
          ]
        });
      }

      sendMessage('webUpdateModel', devices);
    }

    function clearAll () {
      addToLog('=== æ¸…é™¤æ‰€æœ‰æ•°æ® ===');
      sendMessage('webUpdateModel', []);
    }

    function clearLog () {
      logElement.textContent = '';
    }
  </script>
</body>

</html>