<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ ‡ç­¾ä½ç½®è®¡ç®—æµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .test-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    .test-button:hover {
      background: #0056b3;
    }

    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    .info-box {
      background: #e7f3ff;
      border: 1px solid #b3d9ff;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>æ ‡ç­¾ä½ç½®è®¡ç®—æµ‹è¯•</h1>
    <p>æ¨¡æ‹Ÿè®¾å¤‡åŒ…å›´ç›’è®¡ç®—å’Œæ ‡ç­¾ä½ç½®ç¡®å®š</p>

    <div class="info-box">
      <h3>ğŸ¯ æµ‹è¯•ç›®æ ‡</h3>
      <p>éªŒè¯è®¾å¤‡æ ‡ç­¾ä½ç½®è®¡ç®—é€»è¾‘ï¼š</p>
      <ul>
        <li>è®¡ç®—è®¾å¤‡åŒ…å›´ç›’</li>
        <li>è·å–åŒ…å›´ç›’ä¸­å¿ƒç‚¹</li>
        <li>å°†Yåæ ‡è®¾ç½®ä¸ºæœ€é«˜ç‚¹</li>
        <li>æ·»åŠ é€‚å½“åç§»</li>
      </ul>
    </div>

    <div>
      <h3>æµ‹è¯•æŒ‰é’®</h3>
      <button class="test-button" onclick="testBoundingBoxCalculation()">æµ‹è¯•åŒ…å›´ç›’è®¡ç®—</button>
      <button class="test-button" onclick="testDifferentDevices()">æµ‹è¯•ä¸åŒè®¾å¤‡</button>
      <button class="test-button" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
    </div>

    <div>
      <h3>æ§åˆ¶å°æ—¥å¿—</h3>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script>
    // æ¨¡æ‹Ÿ THREE.js çš„ Box3 å’Œ Vector3
    class MockVector3 {
      constructor(x = 0, y = 0, z = 0) {
        this.x = x;
        this.y = y;
        this.z = z;
      }

      toArray () {
        return [this.x, this.y, this.z];
      }

      clone () {
        return new MockVector3(this.x, this.y, this.z);
      }
    }

    class MockBox3 {
      constructor() {
        this.min = new MockVector3(Infinity, Infinity, Infinity);
        this.max = new MockVector3(-Infinity, -Infinity, -Infinity);
      }

      setFromObject (object) {
        // æ¨¡æ‹Ÿä»å¯¹è±¡è®¡ç®—åŒ…å›´ç›’
        if (object.boundingBox) {
          this.min = object.boundingBox.min.clone();
          this.max = object.boundingBox.max.clone();
        } else {
          // ä½¿ç”¨å¯¹è±¡çš„positionå’Œsizeæ¥æ¨¡æ‹ŸåŒ…å›´ç›’
          const size = object.size || new MockVector3(1, 1, 1);
          const pos = object.position || new MockVector3(0, 0, 0);

          this.min.x = pos.x - size.x / 2;
          this.min.y = pos.y - size.y / 2;
          this.min.z = pos.z - size.z / 2;

          this.max.x = pos.x + size.x / 2;
          this.max.y = pos.y + size.y / 2;
          this.max.z = pos.z + size.z / 2;
        }
        return this;
      }

      getCenter (target) {
        target.x = (this.min.x + this.max.x) / 2;
        target.y = (this.min.y + this.max.y) / 2;
        target.z = (this.min.z + this.max.z) / 2;
        return target;
      }
    }

    // æ¨¡æ‹Ÿè®¾å¤‡å¯¹è±¡
    function createMockDevice (name, position, size) {
      return {
        name: name,
        position: new MockVector3(position.x, position.y, position.z),
        size: new MockVector3(size.x, size.y, size.z)
      };
    }

    // è®¡ç®—æ ‡ç­¾ä½ç½®
    function calculateLabelPosition (deviceObject) {
      const boundingBox = new MockBox3().setFromObject(deviceObject);
      const devicePosition = new MockVector3();

      // è·å–åŒ…å›´ç›’çš„ä¸­å¿ƒç‚¹
      boundingBox.getCenter(devicePosition);

      // å°†Yåæ ‡è®¾ç½®ä¸ºåŒ…å›´ç›’çš„æœ€é«˜ç‚¹
      devicePosition.y = boundingBox.max.y;

      // åœ¨æœ€é«˜ç‚¹ä¸Šæ–¹æ·»åŠ ä¸€ç‚¹åç§»ï¼Œé¿å…æ ‡ç­¾ä¸è®¾å¤‡é‡å 
      devicePosition.y += 0.5;

      return {
        boundingBox: boundingBox,
        labelPosition: devicePosition
      };
    }

    // é‡å†™ console.log æ¥æ•è·æ—¥å¿—
    const originalLog = console.log;
    const logElement = document.getElementById('log');

    function addToLog (message) {
      logElement.textContent += message + '\n';
      logElement.scrollTop = logElement.scrollHeight;
    }

    console.log = function (...args) {
      originalLog.apply(console, args);
      addToLog('[LOG] ' + args.join(' '));
    };

    function testBoundingBoxCalculation () {
      addToLog('=== æµ‹è¯•åŒ…å›´ç›’è®¡ç®— ===');

      // åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿè®¾å¤‡
      const device = createMockDevice(
        'test_device_001',
        { x: 10, y: 2, z: 5 },
        { x: 2, y: 3, z: 1.5 }
      );

      addToLog(`è®¾å¤‡ä¿¡æ¯: ${device.name}`);
      addToLog(`è®¾å¤‡ä½ç½®: [${device.position.toArray().join(', ')}]`);
      addToLog(`è®¾å¤‡å°ºå¯¸: [${device.size.toArray().join(', ')}]`);

      // è®¡ç®—æ ‡ç­¾ä½ç½®
      const result = calculateLabelPosition(device);

      addToLog(`åŒ…å›´ç›’æœ€å°å€¼: [${result.boundingBox.min.toArray().join(', ')}]`);
      addToLog(`åŒ…å›´ç›’æœ€å¤§å€¼: [${result.boundingBox.max.toArray().join(', ')}]`);
      addToLog(`æ ‡ç­¾ä½ç½®: [${result.labelPosition.toArray().join(', ')}]`);

      // éªŒè¯ç»“æœ
      const expectedY = device.position.y + device.size.y / 2 + 0.5;
      addToLog(`é¢„æœŸYåæ ‡: ${expectedY}`);
      addToLog(`å®é™…Yåæ ‡: ${result.labelPosition.y}`);
      addToLog(`è®¡ç®—æ­£ç¡®: ${Math.abs(result.labelPosition.y - expectedY) < 0.01 ? 'âœ…' : 'âŒ'}`);
    }

    function testDifferentDevices () {
      addToLog('=== æµ‹è¯•ä¸åŒé«˜åº¦çš„è®¾å¤‡ ===');

      const devices = [
        {
          name: 'ä½çŸ®è®¾å¤‡',
          position: { x: 0, y: 0.5, z: 0 },
          size: { x: 1, y: 1, z: 1 }
        },
        {
          name: 'ä¸­ç­‰è®¾å¤‡',
          position: { x: 5, y: 1.5, z: 0 },
          size: { x: 1.5, y: 3, z: 1.5 }
        },
        {
          name: 'é«˜è€¸è®¾å¤‡',
          position: { x: 10, y: 2, z: 0 },
          size: { x: 2, y: 5, z: 2 }
        }
      ];

      devices.forEach(deviceInfo => {
        const device = createMockDevice(
          deviceInfo.name,
          deviceInfo.position,
          deviceInfo.size
        );

        const result = calculateLabelPosition(device);

        addToLog(`\n${device.name}:`);
        addToLog(`  è®¾å¤‡é«˜åº¦: ${device.size.y}`);
        addToLog(`  è®¾å¤‡åº•éƒ¨Y: ${device.position.y - device.size.y / 2}`);
        addToLog(`  è®¾å¤‡é¡¶éƒ¨Y: ${device.position.y + device.size.y / 2}`);
        addToLog(`  æ ‡ç­¾Yåæ ‡: ${result.labelPosition.y}`);
        addToLog(`  åç§»é‡: ${result.labelPosition.y - (device.position.y + device.size.y / 2)}`);
      });
    }

    function clearLog () {
      logElement.textContent = '';
    }
  </script>
</body>

</html>