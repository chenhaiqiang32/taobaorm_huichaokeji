<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>标签位置计算测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .test-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    .test-button:hover {
      background: #0056b3;
    }

    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    .info-box {
      background: #e7f3ff;
      border: 1px solid #b3d9ff;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>标签位置计算测试</h1>
    <p>模拟设备包围盒计算和标签位置确定</p>

    <div class="info-box">
      <h3>🎯 测试目标</h3>
      <p>验证设备标签位置计算逻辑：</p>
      <ul>
        <li>计算设备包围盒</li>
        <li>获取包围盒中心点</li>
        <li>将Y坐标设置为最高点</li>
        <li>添加适当偏移</li>
      </ul>
    </div>

    <div>
      <h3>测试按钮</h3>
      <button class="test-button" onclick="testBoundingBoxCalculation()">测试包围盒计算</button>
      <button class="test-button" onclick="testDifferentDevices()">测试不同设备</button>
      <button class="test-button" onclick="clearLog()">清除日志</button>
    </div>

    <div>
      <h3>控制台日志</h3>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script>
    // 模拟 THREE.js 的 Box3 和 Vector3
    class MockVector3 {
      constructor(x = 0, y = 0, z = 0) {
        this.x = x;
        this.y = y;
        this.z = z;
      }

      toArray () {
        return [this.x, this.y, this.z];
      }

      clone () {
        return new MockVector3(this.x, this.y, this.z);
      }
    }

    class MockBox3 {
      constructor() {
        this.min = new MockVector3(Infinity, Infinity, Infinity);
        this.max = new MockVector3(-Infinity, -Infinity, -Infinity);
      }

      setFromObject (object) {
        // 模拟从对象计算包围盒
        if (object.boundingBox) {
          this.min = object.boundingBox.min.clone();
          this.max = object.boundingBox.max.clone();
        } else {
          // 使用对象的position和size来模拟包围盒
          const size = object.size || new MockVector3(1, 1, 1);
          const pos = object.position || new MockVector3(0, 0, 0);

          this.min.x = pos.x - size.x / 2;
          this.min.y = pos.y - size.y / 2;
          this.min.z = pos.z - size.z / 2;

          this.max.x = pos.x + size.x / 2;
          this.max.y = pos.y + size.y / 2;
          this.max.z = pos.z + size.z / 2;
        }
        return this;
      }

      getCenter (target) {
        target.x = (this.min.x + this.max.x) / 2;
        target.y = (this.min.y + this.max.y) / 2;
        target.z = (this.min.z + this.max.z) / 2;
        return target;
      }
    }

    // 模拟设备对象
    function createMockDevice (name, position, size) {
      return {
        name: name,
        position: new MockVector3(position.x, position.y, position.z),
        size: new MockVector3(size.x, size.y, size.z)
      };
    }

    // 计算标签位置
    function calculateLabelPosition (deviceObject) {
      const boundingBox = new MockBox3().setFromObject(deviceObject);
      const devicePosition = new MockVector3();

      // 获取包围盒的中心点
      boundingBox.getCenter(devicePosition);

      // 将Y坐标设置为包围盒的最高点
      devicePosition.y = boundingBox.max.y;

      // 在最高点上方添加一点偏移，避免标签与设备重叠
      devicePosition.y += 0.5;

      return {
        boundingBox: boundingBox,
        labelPosition: devicePosition
      };
    }

    // 重写 console.log 来捕获日志
    const originalLog = console.log;
    const logElement = document.getElementById('log');

    function addToLog (message) {
      logElement.textContent += message + '\n';
      logElement.scrollTop = logElement.scrollHeight;
    }

    console.log = function (...args) {
      originalLog.apply(console, args);
      addToLog('[LOG] ' + args.join(' '));
    };

    function testBoundingBoxCalculation () {
      addToLog('=== 测试包围盒计算 ===');

      // 创建一个模拟设备
      const device = createMockDevice(
        'test_device_001',
        { x: 10, y: 2, z: 5 },
        { x: 2, y: 3, z: 1.5 }
      );

      addToLog(`设备信息: ${device.name}`);
      addToLog(`设备位置: [${device.position.toArray().join(', ')}]`);
      addToLog(`设备尺寸: [${device.size.toArray().join(', ')}]`);

      // 计算标签位置
      const result = calculateLabelPosition(device);

      addToLog(`包围盒最小值: [${result.boundingBox.min.toArray().join(', ')}]`);
      addToLog(`包围盒最大值: [${result.boundingBox.max.toArray().join(', ')}]`);
      addToLog(`标签位置: [${result.labelPosition.toArray().join(', ')}]`);

      // 验证结果
      const expectedY = device.position.y + device.size.y / 2 + 0.5;
      addToLog(`预期Y坐标: ${expectedY}`);
      addToLog(`实际Y坐标: ${result.labelPosition.y}`);
      addToLog(`计算正确: ${Math.abs(result.labelPosition.y - expectedY) < 0.01 ? '✅' : '❌'}`);
    }

    function testDifferentDevices () {
      addToLog('=== 测试不同高度的设备 ===');

      const devices = [
        {
          name: '低矮设备',
          position: { x: 0, y: 0.5, z: 0 },
          size: { x: 1, y: 1, z: 1 }
        },
        {
          name: '中等设备',
          position: { x: 5, y: 1.5, z: 0 },
          size: { x: 1.5, y: 3, z: 1.5 }
        },
        {
          name: '高耸设备',
          position: { x: 10, y: 2, z: 0 },
          size: { x: 2, y: 5, z: 2 }
        }
      ];

      devices.forEach(deviceInfo => {
        const device = createMockDevice(
          deviceInfo.name,
          deviceInfo.position,
          deviceInfo.size
        );

        const result = calculateLabelPosition(device);

        addToLog(`\n${device.name}:`);
        addToLog(`  设备高度: ${device.size.y}`);
        addToLog(`  设备底部Y: ${device.position.y - device.size.y / 2}`);
        addToLog(`  设备顶部Y: ${device.position.y + device.size.y / 2}`);
        addToLog(`  标签Y坐标: ${result.labelPosition.y}`);
        addToLog(`  偏移量: ${result.labelPosition.y - (device.position.y + device.size.y / 2)}`);
      });
    }

    function clearLog () {
      logElement.textContent = '';
    }
  </script>
</body>

</html>