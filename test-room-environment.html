<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RoomEnvironment 测试</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
    }

    canvas {
      display: block;
    }

    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-family: Arial, sans-serif;
    }

    button {
      margin: 5px;
      padding: 5px 10px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    button:hover {
      background: #45a049;
    }
  </style>
</head>

<body>
  <div class="controls">
    <h3>环境效果控制</h3>
    <button onclick="setEnvironment('room')">RoomEnvironment</button>
    <button onclick="setEnvironment('hdr')">HDR 环境</button>
    <button onclick="setEnvironment('default')">默认环境</button>
    <p id="status">当前环境: RoomEnvironment</p>
  </div>

  <script type="module">
        import * as T    m 'three';
        import { RoomEnvironment } from 'three/examples/jsm/environments/Ro    nment.js';
        import { OrbitControls } from 'three/examples/jsm/controls/O    rols.js'       // 场景设置
        const scene = n    .Scene()      const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000)      const renderer = new THREE.We    rer({ ant    true });
        renderer.setSize(window.innerWidth, window.inn    );
        renderer.shadowMap.enabled = true;
        ren    adowMap.type = THREE.PCFSoftShadowMap;
        re    oneMapping = THREE.ACESFilmicToneMapping;
        re    utputColorSpace = THREE.SRGBColorS          document.body.appendChild(renderer.domElemen         // 控制器
        const controls = new OrbitCon    mera, renderer.domElem          controls.enableDamping = true;
        controls.dampi     = 0.05;

        // 相机位置
        camera.positi,            controls.update();

        // 创建一些测试几何      function createTestObjects() {
            // 创建一个球体（金属材质）
            cone     = new THREE.SphereGeometry(1, 3                const sphereMateriaT    hStandardMaterial({
            color: 0x888888,
             etalness:                  roughness: 0.2
            });
              sphere = new THREE.Mesh(sphereGeometry, sphereMate             sphere.po      2, 0, 0);
            .castShadow = true;
        s    ceiveShadow = true;
            scene.add(sphere);
         // 创建一个立方体（塑料材质          co    Geometry = new THREE.BoxGeometry(1, 1, 1);
            const    erial = new THREE.MeshStan    rial({
                color: 0x00ff00,
                metalness:                  roughness: 0.8
                        const cube = new THRE    ubeGeomet    Material);
            cube.position.set(0, 0, 0);
            cu    hadow = true;
            cube.    hadow = true;
            scene.    );

        // 创建一个圆柱体（玻璃材质） 
          t cylinderGeometry = new THREE.Ct       2, 32);       const cylinderMaterial = n      hPhysicalMaterial({
       o      
                me      ,
                roughness: 0.0           ransmissio                    thickness: 0.5
                      const cylinder = new THREE.Mesh(cylinderGeometry, c      ial);
            cylinder.positi       0);
            cylinder.castShadow = true;
                .rece    w = true;
    ne.add(cylinder);

            // 创建地面
            const groundGeometry = new THREE.PlaneGeometry(10, 10);
            const groundMaterial = new THREE.MeshStandardMaterial({
                color: 0x808080,
                metalness: 0.0,
                roughness: 0.8
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -2;
            ground.receiveShadow = true;
            scene.add(ground);
        }

        // 设置环境效果
        function setEnvironment(type) {
            // 清理现有环境
            if (scene.environment) {
                scene.environment.dispose();
                scene.environment = null;
            }
            if (scene.background && scene.background !== SunnyTexture) {
                scene.background.dispose();
                scene.background = null;
            }

            switch (type) {
                case 'room':
                    const roomEnvironment = new RoomEnvironment(renderer);
                    scene.environment = roomEnvironment.environment;
                    scene.background = roomEnvironment.environment;
                    updateStatus('RoomEnvironment');
                    break;

                case 'hdr':
                    // 模拟 HDR 环境
                    const hdrTexture = new THREE.CubeTextureLoader().load([
                        'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                        'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                        'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                        'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                        'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                        'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                    ]);
                    scene.environment = hdrTexture;
                    scene.background = new THREE.Color(0x87ceeb);
                    updateStatus('HDR 环境');
                    break;

                case 'default':
                    scene.background = new THREE.Color(0x87ceeb);
                    updateStatus('默认环境');
                    break;

                default:
                    console.warn(`未知的环境类型: ${type}`);
                    break;
            }

            // 更新所有材质的环境贴图
            scene.traverse((object) => {
                if (object.isMesh && object.material) {
                    if (Array.isArray(object.material)) {
                        object.material.forEach((material) => {
                            setupMaterialEnvironment(material);
                        });
                    } else {
                        setupMaterialEnvironment(object.material);
                    }
                }
            });
        }

        // 设置单个材质的环境贴图
        function setupMaterialEnvironment(material) {
            if (material && (material.isMeshStandardMaterial || material.isMeshPhysicalMaterial)) {
                if (scene.environment) {
                    material.envMap = scene.environment;
                    material.envMapIntensity = 0.8;
                    material.needsUpdate = true;
                }
            }
        }

        // 更新状态显示
        function updateStatus(text) {
            document.getElementById('status').textContent = `当前环境: ${text}`;
        }

        // 添加灯光
        function addLights() {
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 5, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
        }

        // 初始化
        createTestObjects();
        addLights();
        setEnvironment('room'); // 默认使用 RoomEnvironment

        // 动画循环
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // 窗口大小调整
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // 全局函数供按钮调用
        window.setEnvironment = setEnvironment;
  </script>
</body>

</html>