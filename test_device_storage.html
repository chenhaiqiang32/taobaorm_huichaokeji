<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>设备存储逻辑测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .test-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    .test-button:hover {
      background: #0056b3;
    }

    .test-button.danger {
      background: #dc3545;
    }

    .test-button.danger:hover {
      background: #c82333;
    }

    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    h2 {
      color: #333;
      border-bottom: 2px solid #007bff;
      padding-bottom: 5px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>设备存储逻辑测试</h1>
    <p>测试按设备编号存储的新逻辑</p>

    <div class="test-section">
      <h2>1. 测试数据存储</h2>
      <button class="test-button" onclick="testSaveData()">保存测试数据</button>
      <p>保存多个设备的标签数据到实例中</p>
    </div>

    <div class="test-section">
      <h2>2. 测试数据加载</h2>
      <button class="test-button" onclick="testLoadData()">模拟加载数据</button>
      <p>模拟楼层切换时的数据加载过程</p>
    </div>

    <div class="test-section">
      <h2>3. 测试清除功能</h2>
      <button class="test-button" onclick="testClearAll()">清除所有数据</button>
      <button class="test-button danger" onclick="testClearSpecific()">清除指定设备</button>
      <p>测试清除所有数据和清除指定设备的功能</p>
    </div>

    <div class="test-section">
      <h2>4. 检查存储状态</h2>
      <button class="test-button" onclick="checkStatus()">检查状态</button>
      <p>查看当前实例中的存储数据</p>
    </div>

    <div class="test-section">
      <h2>控制台日志</h2>
      <div id="log" class="log"></div>
      <button class="test-button" onclick="clearLog()">清除日志</button>
    </div>
  </div>

  <script>
    // 模拟 IndoorSubsystem 的存储逻辑
    class MockIndoorSubsystem {
      constructor() {
        this.deviceLabelsData = {};
        this.currentFloor = null;
        this.buildingObject = {
          'floor1': {
            group: {
              children: [
                { name: '001_device1' },
                { name: '002_device2' },
                { name: '003_device3' }
              ]
            }
          },
          'floor2': {
            group: {
              children: [
                { name: '004_device4' },
                { name: '005_device5' }
              ]
            }
          }
        };
      }

      saveDeviceLabelsToInstance (deviceData) {
        if (!Array.isArray(deviceData)) {
          console.warn("设备数据格式错误，应为数组");
          return;
        }

        console.log("保存设备标签数据...");
        console.log("要保存的数据:", deviceData);

        // 按设备编号存储数据
        deviceData.forEach((device) => {
          const { code } = device;
          if (code) {
            this.deviceLabelsData[code] = device;
            console.log(`设备标签数据已保存到实例: ${code}`, device);
          } else {
            console.warn("设备数据缺少code字段:", device);
          }
        });

        console.log("当前所有存储的数据:", this.deviceLabelsData);
      }

      loadDeviceLabelsFromInstance () {
        if (!this.currentFloor || !this.buildingObject[this.currentFloor.name]) {
          console.log("当前楼层或建筑数据不存在");
          return null;
        }

        const children = this.buildingObject[this.currentFloor.name].group.children;
        const availableDevices = [];
        const deviceData = [];

        // 遍历当前楼层的所有设备
        children.forEach((child) => {
          const deviceCode = child.name.split('_')[0];
          if (deviceCode && this.deviceLabelsData[deviceCode]) {
            availableDevices.push(deviceCode);
            deviceData.push(this.deviceLabelsData[deviceCode]);
          }
        });

        if (deviceData.length > 0) {
          console.log(`从实例读取设备标签数据，找到 ${deviceData.length} 个设备:`, availableDevices);
          console.log("设备数据:", deviceData);
          return deviceData;
        }

        console.log("当前楼层没有找到对应的设备标签数据");
        return null;
      }

      clearDeviceLabelsFromInstance (deviceCodes = null) {
        if (deviceCodes && Array.isArray(deviceCodes)) {
          // 清除指定的设备数据
          deviceCodes.forEach((code) => {
            if (this.deviceLabelsData[code]) {
              delete this.deviceLabelsData[code];
              console.log(`已清除设备标签数据: ${code}`);
            }
          });
        } else {
          // 清除所有数据
          this.deviceLabelsData = {};
          console.log("已清除所有设备标签数据");
        }
      }

      switchFloor (floorName) {
        this.currentFloor = { name: floorName };
        console.log(`切换到楼层: ${floorName}`);
        return this.loadDeviceLabelsFromInstance();
      }
    }

    // 创建模拟实例
    const mockSubsystem = new MockIndoorSubsystem();

    // 重写 console.log 来捕获日志
    const originalLog = console.log;
    const originalWarn = console.warn;
    const logElement = document.getElementById('log');

    function addToLog (message) {
      logElement.textContent += message + '\n';
      logElement.scrollTop = logElement.scrollHeight;
    }

    console.log = function (...args) {
      originalLog.apply(console, args);
      addToLog('[LOG] ' + args.join(' '));
    };

    console.warn = function (...args) {
      originalWarn.apply(console, args);
      addToLog('[WARN] ' + args.join(' '));
    };

    function testSaveData () {
      addToLog('=== 测试保存数据 ===');

      // 保存第一组数据（模拟在楼层1时保存）
      const data1 = [
        {
          name: '设备1',
          visible: true,
          code: '001',
          configs: [{ key: '状态', value: '正常' }]
        },
        {
          name: '设备2',
          visible: true,
          code: '002',
          configs: [{ key: '状态', value: '异常' }]
        }
      ];

      mockSubsystem.saveDeviceLabelsToInstance(data1);

      // 保存第二组数据（模拟在楼层2时保存）
      const data2 = [
        {
          name: '设备4',
          visible: true,
          code: '004',
          configs: [{ key: '状态', value: '维护中' }]
        }
      ];

      mockSubsystem.saveDeviceLabelsToInstance(data2);
    }

    function testLoadData () {
      addToLog('=== 测试加载数据 ===');

      // 切换到楼层1
      addToLog('切换到楼层1...');
      const result1 = mockSubsystem.switchFloor('floor1');

      // 切换到楼层2
      addToLog('切换到楼层2...');
      const result2 = mockSubsystem.switchFloor('floor2');

      // 切换回楼层1
      addToLog('切换回楼层1...');
      const result3 = mockSubsystem.switchFloor('floor1');
    }

    function testClearAll () {
      addToLog('=== 测试清除所有数据 ===');
      mockSubsystem.clearDeviceLabelsFromInstance();
    }

    function testClearSpecific () {
      addToLog('=== 测试清除指定设备 ===');
      mockSubsystem.clearDeviceLabelsFromInstance(['001', '004']);
    }

    function checkStatus () {
      addToLog('=== 检查存储状态 ===');
      addToLog('当前存储的数据: ' + JSON.stringify(mockSubsystem.deviceLabelsData, null, 2));
    }

    function clearLog () {
      logElement.textContent = '';
    }
  </script>
</body>

</html>