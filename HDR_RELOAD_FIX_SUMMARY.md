# HDR 天空重新加载修复总结

## 问题描述

在室内子系统中，HDR 天空环境贴图在 `onLeave` 时被清理，但后续通过 `onEnter` 方法进入场景时没有重新设置天空，导致场景背景丢失。

## 问题分析

1. **构造函数中的设置**: 在 `IndoorSubsystem` 构造函数中调用了 `setIndoorHDRSky()`
2. **离开时的清理**: 在 `onLeave()` 方法中调用了 `clearIndoorHDR()` 清理 HDR 环境贴图
3. **进入时缺少重新设置**: `onEnter()` 方法中没有重新设置 HDR 天空

## 修复方案

### 1. 修改构造函数

- 移除构造函数中的 `setIndoorHDRSky()` 调用
- 避免在初始化时就设置 HDR 天空

```javascript
// 修改前
this.initLight();
this.setIndoorHDRSky(); // 设置室内金色HDR天空

// 修改后
this.initLight();
// 不在构造函数中设置HDR天空，而是在onEnter时设置
// this.setIndoorHDRSky(); // 设置室内金色HDR天空
```

### 2. 修改 onEnter 方法

- 在每次进入室内时都重新设置 HDR 天空
- 确保场景背景和环境贴图正确加载

```javascript
onEnter(buildingName) {
    // ... 其他代码 ...

    // 每次进入室内都重新设置HDR天空
    console.log("设置室内HDR天空...");
    this.setIndoorHDRSky();

    // ... 其他代码 ...
}
```

### 3. 增强 onLoaded 方法

- 在模型加载完成后确保环境贴图材质已正确设置
- 处理 HDR 天空可能在模型加载完成后才设置完成的情况

```javascript
onLoaded() {
    // ... 其他代码 ...

    // 确保环境贴图材质已设置（HDR天空可能在模型加载完成后才设置完成）
    if (this.scene.environment) {
        this.processIndoorEnvMapMaterials();
    }

    // ... 其他代码 ...
}
```

## 修复效果

### 修复前的问题

- ✅ 首次进入室内：HDR 天空正常显示
- ❌ 离开室内后再次进入：HDR 天空丢失
- ❌ 场景背景变为黑色或默认背景

### 修复后的效果

- ✅ 首次进入室内：HDR 天空正常显示
- ✅ 离开室内后再次进入：HDR 天空重新加载
- ✅ 场景背景和环境贴图正确恢复
- ✅ 材质环境反射效果正常

## 测试验证

### 测试页面

创建了 `test_hdr_reload.html` 测试页面，包含以下功能：

1. **状态监控**

   - HDR 背景状态
   - 环境贴图状态
   - 材质环境贴图状态

2. **控制功能**

   - 模拟进入室内
   - 模拟离开室内
   - 清理 HDR
   - 重新加载 HDR
   - 检查状态

3. **测试对象**
   - 高反射球体（测试环境反射）
   - 立方体（测试 PBR 材质）
   - 地面平面（测试环境贴图）

### 测试步骤

1. 打开测试页面
2. 点击"模拟进入室内" - 验证 HDR 天空加载
3. 点击"模拟离开室内" - 验证 HDR 清理
4. 再次点击"模拟进入室内" - 验证 HDR 重新加载
5. 使用"检查状态"按钮监控各组件状态

## 技术细节

### HDR 加载流程

1. **RGBELoader 加载**: 使用 `RGBELoader` 加载 `.hdr` 文件
2. **纹理设置**: 设置映射类型、颜色空间、曝光度
3. **场景应用**: 设置为场景背景和环境贴图
4. **材质处理**: 为所有 PBR 材质设置环境贴图

### 清理流程

1. **纹理清理**: 释放背景和环境贴图纹理
2. **材质清理**: 清除材质中的环境贴图引用
3. **状态重置**: 重置相关状态标志

### 重新加载流程

1. **状态检查**: 检查当前 HDR 状态
2. **重新加载**: 重新加载 HDR 文件
3. **材质更新**: 更新所有材质的环境贴图

## 兼容性

- ✅ 与现有室内子系统完全兼容
- ✅ 与灯光调整系统兼容
- ✅ 与材质处理系统兼容
- ✅ 与场景切换系统兼容

## 性能考虑

- **内存管理**: 正确清理纹理资源，避免内存泄漏
- **加载优化**: 使用异步加载，不阻塞主线程
- **材质更新**: 只在必要时更新材质，避免不必要的计算

## 总结

通过将 HDR 天空的设置从构造函数移到 `onEnter` 方法，确保了每次进入室内场景时都能正确加载和显示 HDR 天空环境贴图。这个修复解决了场景切换时 HDR 天空丢失的问题，同时保持了良好的资源管理和性能表现。

修复后的系统能够：

- 正确处理室内场景的进入和离开
- 在每次进入时重新加载 HDR 天空
- 正确清理和释放资源
- 为所有 PBR 材质提供正确的环境反射效果
