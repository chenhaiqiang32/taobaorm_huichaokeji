# Web Update Model 功能实现总结

## 功能概述

实现了 `webUpdateModel` 指令，用于动态更新室内场景中的设备牌子（CSS2D 标签）。该功能允许通过 postMessage 指令动态创建、更新和移除设备牌子，并支持实例存储功能，数据存储在类实例中，页面刷新时自动清除。

## 实现文件

### 1. 消息处理 (`src/message/onMessage.js`)

- 添加了 `webUpdateModel` 指令处理
- 当接收到指令时，自动保存数据到类实例并更新设备牌子
- 添加了 `clearDeviceLabels` 指令处理，用于清除设备标签和实例数据

### 2. 室内子系统 (`src/three/subsystem/indoorSubsystem/index.js`)

- 添加了设备牌子管理功能
- 实现了以下方法：
  - `updateDeviceLabels(deviceData)` - 更新设备标签
  - `clearDeviceLabels()` - 清除所有设备牌子
  - `createDeviceLabel(device)` - 创建单个设备牌子
  - `findDeviceByCode(code)` - 根据设备编号查找设备对象
  - `saveDeviceLabelsToInstance(deviceData)` - 保存设备标签数据到实例变量
  - `loadDeviceLabelsFromInstance()` - 从实例变量读取设备标签数据
  - `loadAndRenderDeviceLabels()` - 加载并渲染实例中的设备标签
  - `clearDeviceLabelsFromInstance()` - 清除实例中的设备标签数据

### 3. 样式文件 (`src/style.css`)

- 添加了设备牌子的 CSS 样式
- 包括容器、名称、配置信息等样式定义

## 数据格式

```javascript
[
  {
    name: "设备名称", // 设备显示名称
    visible: true, // 是否显示牌子（默认true）
    code: "设备编号", // 设备编号，用于匹配模型中的设备
    configs: [
      // 配置信息数组
      {
        key: "属性名", // 属性名称
        value: "属性值", // 属性值
      },
    ],
  },
];
```

## 功能特性

### 1. 设备匹配

- 根据 `code` 字段匹配模型中的设备
- 设备编号通过 `设备对象.name.split('_')[0]` 获取
- 支持动态查找和匹配
- 每次推送数据时完全重新生成所有牌子

### 2. 牌子样式

- 美观的渐变背景和边框
- 设备名称高亮显示（蓝色）
- 配置信息以键值对形式展示
- 包含装饰性顶部和底部元素
- 支持模糊背景效果

### 3. 位置管理

- 牌子自动定位在设备包围盒的最高点中间位置
- 计算设备的包围盒，将标签放置在最高点的中心
- 在最高点上方添加 0.5 个单位的偏移，避免标签与设备重叠
- 使用 CSS2D 渲染器确保始终面向相机
- 支持动态位置更新

### 4. 生命周期管理

- 每次推送数据时自动清除所有旧的设备牌子和数据
- 基于新数组完全重新生成所有牌子
- 在场景切换时清理资源
- 在系统销毁时清理所有牌子

### 5. 实例存储功能

- 自动保存设备标签数据到类实例变量
- 按设备编号（code）分别存储在 `deviceLabelsData` 对象中
- 楼层切换时自动查找当前楼层设备的标签数据
- 页面刷新时自动清除所有数据
- 支持手动清除指定设备或所有数据

## 使用方法

### 1. 发送指令

```javascript
// 创建设备牌子
window.postMessage(
  {
    cmd: "webUpdateModel",
    param: [
      {
        name: "智能空调",
        visible: true,
        code: "001",
        configs: [
          { key: "温度", value: "25°C" },
          { key: "湿度", value: "60%" },
        ],
      },
    ],
  },
  "*"
);

// 清除所有设备牌子
window.postMessage(
  {
    cmd: "webUpdateModel",
    param: [],
  },
  "*"
);

// 清除所有设备标签和实例数据
window.postMessage(
  {
    cmd: "clearDeviceLabels",
    param: {},
  },
  "*"
);

// 清除指定设备的标签和实例数据
window.postMessage(
  {
    cmd: "clearDeviceLabels",
    param: {
      deviceCodes: ["001", "002"],
    },
  },
  "*"
);
```

### 2. 测试页面

- 创建了 `test_web_update_model.html` 测试页面
- 包含多个测试用例
- 支持实时测试和状态显示

## 样式特点

### 1. 视觉设计

- 深色半透明背景
- 蓝色渐变边框
- 设备名称使用青色高亮
- 配置信息使用不同颜色区分键值

### 2. 交互效果

- 鼠标悬停效果
- 文字阴影增强可读性
- 圆角边框提升现代感

### 3. 响应式布局

- 自适应内容宽度
- 支持多行配置信息
- 保持良好的视觉层次

## 注意事项

1. **设备编号匹配**：确保 `code` 字段与模型中的设备名称前缀匹配
2. **场景限制**：该功能仅在室内场景中有效
3. **性能考虑**：大量设备牌子可能影响性能，建议合理控制数量
4. **清理机制**：系统会自动清理资源，但建议在不需要时主动清除
5. **实例存储**：数据按设备编号分别存储在类实例中，切换楼层时会自动查找当前楼层设备的标签数据
6. **数据持久性**：页面刷新时数据会自动清除，确保每次都是干净的状态
7. **内存管理**：数据存储在内存中，系统销毁时会自动清理
8. **设备匹配**：通过设备编号精确匹配，不受楼层切换时机影响

## 扩展性

该实现具有良好的扩展性：

- 可以轻松添加新的样式主题
- 支持动态配置信息更新
- 可以扩展为支持更多设备类型
- 支持自定义交互事件

## 测试验证

使用提供的测试页面可以验证：

- 基础设备牌子创建
- 带配置信息的牌子
- 隐藏/显示功能
- 动态更新功能
- 清理功能
- 实例存储保存和加载功能
- 楼层切换时的自动加载功能

所有功能都已通过测试验证，确保稳定可靠。
